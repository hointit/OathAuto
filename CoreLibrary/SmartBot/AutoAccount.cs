// Decompiled with JetBrains decompiler
// Type: SmartBot.AutoAccount
// Assembly: GAuto_Auto_None, Version=2.4.3.8, Culture=neutral, PublicKeyToken=null
// MVID: 76F663E8-D92E-4496-B4AA-6E6B9F025406
// Assembly location: E:\LMTK\Auto Game\GAUTOFREE\Release\GAuto_Auto_None.exe

using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Media;
using System.Security;
using System.Threading;
using System.Windows.Forms;

#nullable disable
namespace SmartBot;

public class AutoAccount : AllEnums
{
  public Thread BGThread;
  public bool firstGame = true;
  public TargetProcess Target;
  public object UpdateLocker = new object();
  public LoginProfileClass AutoProfile;
  private bool _isAIEnabled;
  public ListViewItem lvItem = new ListViewItem();
  public AutoSettings Settings = new AutoSettings();
  public Thread AIThread;
  public MyFlagClass MyFlag;
  public MainPlayerClass Myself = new MainPlayerClass();
  public GScriptEngine ScriptEngine = new GScriptEngine();
  public GScriptEngine ScriptEngine2;
  public PetClass MyPet = new PetClass();
  public InventoryClass MyInventory = new InventoryClass();
  public List<TNNPCShopItem> TNNPCShopInstance = new List<TNNPCShopItem>(12);
  public BocClass MyBoc = new BocClass();
  public PartyClass MyParty = new PartyClass();
  public ArmyClass MyArmy = new ArmyClass();
  public PlayerInfo MyPlayers = new PlayerInfo();
  public RingQuaiBuffer RingQuai;
  public RingNguoiBuffer RingNguoi;
  public RingBocBuffer RingBoc;
  public RingMsgBuffer RingMsg;
  public RingHKBuffer RingHK;
  public SkillsClass MySkills = new SkillsClass();
  public ActiveBocItems ActiveBocItemsInstance = new ActiveBocItems();
  public QuaiClass MyQuai = new QuaiClass();
  public List<AutoAccount.NPCNhiemVuClass> NPCNhiemVu = new List<AutoAccount.NPCNhiemVuClass>();
  private Stopwatch GCTimeStamp = new Stopwatch();
  private List<int> CityList = new List<int>()
  {
    0,
    1,
    2,
    77
  };
  private long PetFeedStamp;
  private long eatMPStamp;
  private long eatHPStamp;
  private bool IsMainScript = true;
  private int tempBocShowID;
  private int thocbocFlag;

  private void ProcessPartyGrouping()
  {
    if ((this.Myself.MinorStatus2 != AllEnums.CharStatuses.TRIEUTAP || this.IsNhatBoc()) && this.Myself.MinorStatus2 != AllEnums.CharStatuses.TRIEUTAPNOW || this.Myself.IsPartyFollowed != (byte) 0 || this.Myself.PartyGroupingStamp.ElapsedMilliseconds < 3000L)
      return;
    this.Myself.PartyGroupingStamp.Reset();
    this.Myself.PartyGroupingStamp.Start();
    if (this.MyParty.PartyNumbers <= 0)
      return;
    PartyMember allMember = this.MyParty.AllMembers[0];
    AutoAccount autoAccount = (AutoAccount) null;
    if (allMember.DatabaseID != 0)
    {
      try
      {
        for (int index = frmLogin.GAuto.AllAutoAccounts.Count - 1; index >= 0; --index)
        {
          AutoAccount allAutoAccount = frmLogin.GAuto.AllAutoAccounts[index];
          if (allAutoAccount.Myself.DatabaseID == allMember.DatabaseID)
          {
            autoAccount = allAutoAccount;
            break;
          }
        }
      }
      catch (Exception ex)
      {
      }
    }
    if (autoAccount == null || autoAccount.Myself == null || (double) this.Myself.TargetX == (double) autoAccount.Myself.PosX && (double) this.Myself.TargetY == (double) autoAccount.Myself.PosY && this.Myself.MapID == autoAccount.Myself.MapID)
      return;
    if (this.Myself.Status == AllEnums.CharStatuses.VETHANH)
      this.Myself.Status = AllEnums.CharStatuses.IDLE;
    if (this.Myself.MapID == autoAccount.Myself.MapID)
    {
      double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) autoAccount.Myself.PosX, (double) autoAccount.Myself.PosY);
      if (distance <= 5.0)
        return;
      int num1 = 0;
      if (distance > 35.0)
        this.CallLenNgua();
      if (num1 == 0)
      {
        this.CallMoveFlashPos((int) this.Myself.PosX, (int) this.Myself.PosY);
        int num2 = num1 + 1;
      }
      this.CallInMapMove((int) autoAccount.Myself.PosX, (int) autoAccount.Myself.PosY, true);
    }
    else
    {
      this.Myself.LongMoveMapID = autoAccount.Myself.MapID;
      if ((double) autoAccount.Myself.PosX != 0.0)
      {
        this.Myself.LongMoveX = (int) autoAccount.Myself.PosX;
        this.Myself.LongMoveY = (int) autoAccount.Myself.PosY;
        this.Myself.TargetX = (float) (int) autoAccount.Myself.PosX;
        this.Myself.TargetY = (float) (int) autoAccount.Myself.PosY;
      }
      this.Myself.TargetMapID = autoAccount.Myself.MapID;
      int mapId1 = this.Settings.MapID;
      int mapId2 = autoAccount.Myself.MapID;
      if (this.Target.VersionNum == 3 || this.Target.VersionNum == 4)
      {
        this.Myself.MoveLongTrigger = false;
        this.Myself.IsLongMove = true;
      }
      else
        this.Myself.MoveLongTrigger = true;
    }
  }

  public void GetMyExitXY(int mapIDTrong)
  {
    if (mapIDTrong <= 0 || frmLogin.GAuto.PhuBanPathDB.Count <= 0)
      return;
    foreach (PhuBanPath phuBanPath in frmLogin.GAuto.PhuBanPathDB)
    {
      if (phuBanPath.MapIDTrong == mapIDTrong)
      {
        int exitX = phuBanPath.ExitX;
        int exitY = phuBanPath.ExitY;
      }
    }
  }

  private bool IsNhatBoc()
  {
    return this.Myself.Status == AllEnums.CharStatuses.NHATBOC || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.NhatBocStatusStamp < 1000L;
  }

  public bool TrongTrot(ref bool needVeThuHoach)
  {
    if (this.Myself.IsTrongTrot && this.Myself.TrongTrotStamp.ElapsedMilliseconds >= 3000L)
    {
      this.Myself.TrongTrotStamp.Reset();
      this.Myself.TrongTrotStamp.Start();
      bool thuHoach1_1 = false;
      bool thuHoach1_2 = false;
      bool flag1 = false;
      bool flag2 = false;
      if (this.Myself.TrongTrotNPC1)
        this.CheckThuHoach(ref thuHoach1_1, 1);
      if (this.Myself.TrongTrotNPC2)
        this.CheckThuHoach(ref thuHoach1_2, 2);
      if (thuHoach1_1 && this.Myself.TrongTrotNPC1)
        flag1 = this.ThuHoachAction(1);
      else if (thuHoach1_2 && this.Myself.TrongTrotNPC2)
        flag2 = this.ThuHoachAction(2);
      needVeThuHoach = this.Settings.TrongTrotMapID != this.Myself.MapID && (thuHoach1_1 || thuHoach1_2) && !flag1 && !flag2;
      if (!this.Myself.TrongTrotNPC1 && !this.Myself.TrongTrotNPC2 || !this.Myself.TrongTrotNPC1 && flag2)
        return this.TrongTrotAction(1);
      if (!this.Myself.TrongTrotNPC2 && !this.Myself.TrongTrotNPC1 || !this.Myself.TrongTrotNPC2 && flag1)
        return this.TrongTrotAction(2);
    }
    return true;
  }

  public bool ThuHoachAction(int npc)
  {
    if (npc != 1)
    {
      int txtTtnpC2Id = this.Settings.txtTTNPC2_ID;
    }
    else
    {
      int txtTtnpC1Id = this.Settings.txtTTNPC1_ID;
    }
    int num1 = npc == 1 ? this.Settings.txtTTNPC1_X : this.Settings.txtTTNPC2_X;
    int num2 = npc == 1 ? this.Settings.txtTTNPC1_Y : this.Settings.txtTTNPC2_Y;
    if (!this.Settings.cboTTThuHoach)
      return true;
    double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num1, (double) num2);
    if (distance > 1.5)
    {
      if (this.Myself.MapID == this.Settings.TrongTrotMapID)
      {
        this.Myself.TargetX = (float) num1;
        this.Myself.TargetY = (float) num2;
        this.CallMoveFlashPos(num1, num2);
      }
      return false;
    }
    if (distance <= 1.5)
    {
      if (this.Myself.HorseType != -1)
        this.CallXuongNgua();
      int num3 = 0;
      try
      {
        for (int index = this.MyBoc.AllBocs.Count - 1; index >= 0; --index)
        {
          NewBoc allBoc = this.MyBoc.AllBocs[index];
          if (allBoc.BocID != 0 && (double) allBoc.PosX != 0.0 && (double) allBoc.PosY != 0.0 && GA.CalculateDistance((double) num1, (double) num2, (double) allBoc.PosX, (double) allBoc.PosY) <= 3.0)
          {
            this.CallThocBocFunc(allBoc.BocID);
            Thread.Sleep(6500);
            this.CallPickAllItems();
            Thread.Sleep(1000);
            ++num3;
          }
          if (num3 >= 4)
            break;
        }
      }
      catch (Exception ex)
      {
      }
      switch (npc)
      {
        case 1:
          this.Myself.TrongTrotNPC1 = false;
          this.Myself.TrongTrotBoc1.Clear();
          break;
        case 2:
          this.Myself.TrongTrotNPC2 = false;
          this.Myself.TrongTrotBoc2.Clear();
          break;
      }
    }
    return true;
  }

  public bool TrongTrotAction(int npc)
  {
    int menuTypeID = 714093;
    if (this.Settings.TrongTrotMapID == 0)
      menuTypeID = 714021;
    if (this.Settings.TrongTrotMapID == 186)
      menuTypeID = 714201;
    if (this.Settings.TrongTrotMapID == 420)
      menuTypeID = 714129;
    else if (this.Settings.TrongTrotMapID == 2)
      menuTypeID = 714057;
    int menuIndex1 = 0;
    int menuIndex2 = this.Settings.TTLoaiThuHoach == 1 ? 254 : (int) byte.MaxValue;
    int NPCID = npc == 1 ? this.Settings.txtTTNPC1_ID : this.Settings.txtTTNPC2_ID;
    int ToX = npc == 1 ? this.Settings.txtTTNPC1_X : this.Settings.txtTTNPC2_X;
    int ToY = npc == 1 ? this.Settings.txtTTNPC1_Y : this.Settings.txtTTNPC2_Y;
    if ((NPCID == -1 || ToX == 0 || ToY == 0 || string.IsNullOrEmpty(this.Settings.TTCaySeTrong) || this.Settings.TTLoaiThuHoach != 1) && this.Settings.TTLoaiThuHoach != 2)
      return false;
    if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) ToX, (double) ToY) > 4.0)
    {
      this.Myself.TargetX = (float) ToX;
      this.Myself.TargetY = (float) ToY;
      this.CallMoveFlashPos((int) this.Myself.TargetX, (int) this.Myself.TargetY);
      return false;
    }
    TrongTrotDBElement trongTrotDbElement1 = (TrongTrotDBElement) null;
    foreach (TrongTrotDBElement trongTrotDbElement2 in frmLogin.GAuto.TrongTrotDB)
    {
      if (trongTrotDbElement2.DisplayName == this.Settings.TTCaySeTrong)
      {
        trongTrotDbElement1 = trongTrotDbElement2;
        break;
      }
    }
    if (trongTrotDbElement1 != null)
      menuIndex1 = this.Settings.TTLoaiThuHoach == 1 ? trongTrotDbElement1.SomIndex : trongTrotDbElement1.MuonIndex;
    if (this.Myself.HorseType != -1)
      this.CallXuongNgua();
    this.CallTalkNPC(0, 0, NPCID);
    this.CallTalkNPC(menuTypeID, menuIndex2, NPCID);
    this.CallTalkNPC(menuTypeID, menuIndex1, NPCID);
    Thread.Sleep(1000);
    if (npc == 1)
    {
      this.Myself.TrongTrotNPC1 = true;
      this.Myself.TrongTrotNPC2 = false;
      this.Myself.TrongTrotBoc2.Clear();
      this.Settings.TrongTrotNPCTime1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
    }
    else
    {
      this.Myself.TrongTrotNPC2 = true;
      this.Myself.TrongTrotNPC1 = false;
      this.Myself.TrongTrotBoc1.Clear();
      this.Settings.TrongTrotNPCTime2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
    }
    DateTime dateTime = DateTime.Now.AddMinutes(5.0);
    if (this.Settings.TTLoaiThuHoach == 2)
      dateTime = dateTime.AddMinutes(65.0);
    this.Settings.TrongTrotTime = dateTime.ToShortTimeString();
    ++this.Myself.trongtrotCounter;
    GA.WriteUserLog("Đã trồng trọt {0} lần", this, (object) this.Myself.trongtrotCounter);
    return true;
  }

  private void CheckThuHoach(ref bool thuHoach1, int NPC)
  {
    long num1 = this.Settings.TrongTrotNPCTime1;
    bool flag = this.Myself.TrongTrotNPC1;
    if (NPC == 2)
    {
      num1 = this.Settings.TrongTrotNPCTime2;
      flag = this.Myself.TrongTrotNPC2;
    }
    int num2 = this.Settings.TTLoaiThuHoach == 1 ? 305000 : 4205000;
    if (num1 == 0L || !flag || frmLogin.GlobalTimer.ElapsedMilliseconds - num1 <= (long) num2 || !flag)
      return;
    if (frmLogin.GlobalTimer.ElapsedMilliseconds - num1 < (long) (num2 + 300000))
      thuHoach1 = true;
    else if (NPC == 1)
    {
      this.Myself.TrongTrotNPC1 = false;
      this.Myself.TrongTrotBoc1.Clear();
    }
    else
    {
      if (NPC != 2)
        return;
      this.Myself.TrongTrotNPC2 = false;
      this.Myself.TrongTrotBoc2.Clear();
    }
  }

  public void NhiemVuAcTac()
  {
  }

  private void CallPhuOrGoHome(int x = 321, int y = 263, int mapid = 1)
  {
    int itemIndex = -1;
    if (this.Settings.cboxXayDungPhu && this.Myself.IsXayDung || this.Settings.cboxTADungPhu && this.Myself.IsTrungAc || this.Settings.cboxBTDPhuVe && this.Myself.isDaoBTD)
    {
      itemIndex = this.SearchDVP(1);
      if (itemIndex == -1)
        itemIndex = this.SearchDVP(0);
      if (itemIndex == -1)
        itemIndex = this.SearchDVP(2);
    }
    if (itemIndex >= 0 && !this.IsInCity())
    {
      this.CallXuongNgua();
      this.CallTangHinh();
      Thread.Sleep(700);
      this.CallUseItem(itemIndex, this.Myself.ID);
      long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
      long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
      while (this.IsAIEnabled && !this.IsInCity() && this.Myself.isSceneTrans != 1)
      {
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 >= 6000L && this.Myself.ActionStatus != (byte) 5)
        {
          this.CallTangHinh();
          Thread.Sleep(700);
          this.CallUseItem(itemIndex, this.Myself.ID);
          elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        }
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 >= 60000L && this.Myself.ActionStatus != (byte) 5)
          break;
        Thread.Sleep(500);
      }
    }
    else
    {
      int num = 0;
      if ((GA.isVipMember() || frmLogin.GAuto.Settings.Account.Username == "ntmyanh1993" || frmLogin.GAuto.Settings.Account.Username == "ntmyanh0402") && !this.IsInCity() && this.Myself.MapID != 39 && this.Target.VersionNum != 4 && num == 999)
      {
        MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CALLHVD, (IntPtr) 0, (IntPtr) 0);
        long elapsedMilliseconds3 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        long elapsedMilliseconds4 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        while (this.IsAIEnabled && !this.IsInCity() && this.Myself.MapID != 39 && this.Myself.isSceneTrans != 1)
        {
          if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds4 >= 6000L && this.Myself.ActionStatus != (byte) 5)
          {
            MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CALLHVD, (IntPtr) 0, (IntPtr) 0);
            elapsedMilliseconds4 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          }
          if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds3 >= 60000L && this.Myself.ActionStatus != (byte) 5)
            break;
          Thread.Sleep(500);
        }
      }
      else
      {
        if (this.Myself.HorseType == -1)
        {
          this.CallTangHinh();
          Thread.Sleep(700);
          this.CallLenNgua();
        }
        if (this.Myself.IsTrungAc)
        {
          x = 224 /*0xE0*/;
          y = 226;
          if (GA.ClientVersion(this) == 10)
          {
            x = (int) sbyte.MaxValue;
            y = 133;
          }
        }
        this.CallOutMapMove(x, y, mapid);
      }
    }
  }

  private void VeThanhMuaDo(bool vethanh = true)
  {
    int itemIndex = -1;
    bool flag = false;
    for (int index = 0; index < 30; ++index)
    {
      InventoryItem allItem = this.MyInventory.AllItems[index];
      if (allItem.ItemID == 30501001 || allItem.ItemID == 30501002)
        itemIndex = index;
      if (allItem.ItemID >= 30501017 && allItem.ItemID <= 30501042 && allItem.ItemID != 30501035 && allItem.ItemID != 30501036)
      {
        if (allItem.ItemMapID == this.Settings.HealMapID)
        {
          if (allItem.ItemMapID != 0)
          {
            itemIndex = index;
            break;
          }
          if (allItem.DinhViPhuTime > (byte) 0)
          {
            itemIndex = index;
            break;
          }
        }
        else if (allItem.ItemMapID == 0)
        {
          if (allItem.DinhViPhuTime > (byte) 0)
            itemIndex = index;
        }
        else if (allItem.ItemMapID > 0)
          itemIndex = index;
        if (index == 0)
          itemIndex = index;
      }
    }
    if (itemIndex >= 0 && !this.IsInCity() && !this.IsInPhaiMap())
    {
      this.CallXuongNgua();
      this.CallTangHinh();
      Thread.Sleep(700);
      this.CallUseItem(itemIndex, this.Myself.ID);
      long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
      long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
      while (this.IsAIEnabled)
      {
        if (this.IsInCity() || this.IsInPhaiMap())
        {
          flag = true;
          break;
        }
        if (this.Myself.isSceneTrans == 1)
        {
          flag = true;
          break;
        }
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 >= 6000L && this.Myself.ActionStatus != (byte) 5)
        {
          this.CallTangHinh();
          Thread.Sleep(700);
          this.CallUseItem(itemIndex, this.Myself.ID);
          elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        }
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 < 60000L || this.Myself.ActionStatus == (byte) 5)
          Thread.Sleep(500);
        else
          break;
      }
    }
    else if (this.MySkills.PhuDaiLyDelay <= 0)
    {
      this.CallXuongNgua();
      this.CallTangHinh();
      Thread.Sleep(700);
      this.CallAttackTarget(0, 22, 0, 0);
      long elapsedMilliseconds3 = frmLogin.GlobalTimer.ElapsedMilliseconds;
      long elapsedMilliseconds4 = frmLogin.GlobalTimer.ElapsedMilliseconds;
      while (this.IsAIEnabled)
      {
        if (this.IsInCity() || this.IsInPhaiMap())
        {
          flag = true;
          break;
        }
        if (this.Myself.isSceneTrans == 1)
        {
          flag = true;
          break;
        }
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds4 >= 20000L && this.Myself.ActionStatus != (byte) 5)
        {
          this.CallTangHinh();
          Thread.Sleep(700);
          this.CallAttackTarget(0, 22, 0, 0);
          elapsedMilliseconds4 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        }
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds3 < 90000L || this.Myself.ActionStatus == (byte) 5)
          Thread.Sleep(500);
        else
          break;
      }
    }
    if (!this.IsInCity())
    {
      while (this.IsAIEnabled)
      {
        if (this.Myself.HorseType == -1)
        {
          this.CallTangHinh();
          Thread.Sleep(700);
          this.CallLenNgua();
        }
        if (this.IsInCity())
        {
          flag = true;
          break;
        }
        int tempX;
        int tempY;
        int mapID;
        if (this.Settings.HealMapID == 480)
        {
          tempX = 155;
          tempY = 117;
          mapID = 480;
        }
        else
        {
          tempX = 235;
          tempY = 322;
          mapID = 0;
        }
        this.CallOutMapMove(tempX, tempY, mapID);
        Thread.Sleep(500);
      }
    }
    if (!flag || !vethanh)
      return;
    this.Myself.Status = AllEnums.CharStatuses.VETHANH;
    this.Myself.SavedStatus = AllEnums.CharStatuses.VETHANH;
  }

  private bool DungPhuWithMap(int mapID)
  {
    bool flag;
    if (!this.IsInCity() && !this.IsInPhaiMap() && !GA.IsBangMapID(this.Myself.MapID))
    {
      int itemIndex = -1;
      if (itemIndex == -1)
        itemIndex = this.SearchDVP(mapID);
      if (itemIndex >= 0)
      {
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DungPhuStamp >= 20000L)
          this.Myself.DungPhuStamp = 0L;
        if (this.Myself.DungPhuStamp == 0L)
        {
          this.CallXuongNgua();
          this.CallTangHinh();
          Thread.Sleep(700);
          this.CallUseItem(itemIndex, this.Myself.ID);
          long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          while (this.IsAIEnabled && !this.IsInCity())
          {
            if (this.Myself.isSceneTrans == 1)
            {
              Thread.Sleep(2000);
              break;
            }
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 >= 9000L && this.Myself.ActionStatus != (byte) 5)
            {
              this.CallTangHinh();
              Thread.Sleep(700);
              this.CallUseItem(itemIndex, this.Myself.ID);
              elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
            }
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 < 60000L || this.Myself.ActionStatus == (byte) 5)
              Thread.Sleep(500);
            else
              break;
          }
          this.Myself.DungPhuStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
        }
        flag = true;
      }
      else
        flag = false;
    }
    else
      flag = false;
    return flag;
  }

  private void CheckXayDungQ(ref int tempX, ref int tempY)
  {
    int num = this.Myself.XayDungCheckQ ? 1 : 0;
    this.CallResetNhiemVuData();
    bool flag1 = false;
    bool flag2 = false;
    long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
    while (!flag1 && !flag2)
    {
      if (this.Myself.QuestInfo == string.Empty)
      {
        this.CallToggleMission();
        Thread.Sleep(1000);
        this.CallToggleMission();
      }
      if (this.Myself.QuestInfo != "")
      {
        if (!this.Myself.QuestInfo.Contains("BHRW_"))
        {
          if (!this.Myself.QuestInfo.ToLower().Contains("ng cho ngh"))
          {
            this.Myself.XayDungCheckQ = true;
            goto label_49;
          }
        }
        try
        {
          string[] strArray = GA.GetMidString(this.Myself.QuestInfo, "{_INFOAIM", "}").Split(',');
          if (strArray.Length >= 3)
          {
            int result1 = 0;
            int result2 = 0;
            int result3 = -1;
            int result4 = 0;
            int.TryParse(strArray[0], out result1);
            int.TryParse(strArray[1], out result2);
            int.TryParse(strArray[2], out result3);
            int.TryParse(strArray[3], out result4);
            this.CallSetUpNhiemVuData(result1, result2, result3);
            flag1 = true;
            this.Myself.XayDungNhanQ = true;
            this.Myself.XayDungFinished = false;
            this.Myself.XayDungDichChuyen = false;
            if (result4 == -1)
              this.Myself.XayDungDanhQuai = true;
          }
        }
        catch (Exception ex)
        {
          GA.WriteUserLog(frmMain.langErrorGetPosBuilding + ex.Message, this);
        }
        if (this.Myself.NhiemVuMapID == 2)
        {
          if (this.Myself.NhiemVuPosX == 166 && this.Myself.NhiemVuPosY == 124)
            this.CallSetUpNhiemVuData(nvPosY: 137);
          if (this.Myself.NhiemVuPosX == 154 && this.Myself.NhiemVuPosY == 130)
            this.CallSetUpNhiemVuData(nvPosY: 125);
          if (this.Myself.NhiemVuPosX == 166 && this.Myself.NhiemVuPosY == 131)
            this.CallSetUpNhiemVuData(nvPosY: (int) sbyte.MaxValue);
          if (this.Myself.NhiemVuPosX == 166 && this.Myself.NhiemVuPosY == 128 /*0x80*/)
            this.CallSetUpNhiemVuData(nvPosY: 124);
          if (this.Myself.NhiemVuPosX == 166 && this.Myself.NhiemVuPosY == 138)
            this.CallSetUpNhiemVuData(nvPosY: 134);
          if (this.Myself.NhiemVuPosX == 166 && this.Myself.NhiemVuPosY == 135)
            this.CallSetUpNhiemVuData(nvPosY: 131);
        }
        if (this.Myself.NhiemVuMapID == 8 && this.Myself.NhiemVuPosX == 64 /*0x40*/ && this.Myself.NhiemVuPosY == 63 /*0x3F*/)
          this.CallSetUpNhiemVuData(54);
        if (this.Myself.NhiemVuMapID == 6)
        {
          if (this.Myself.NhiemVuPosX == 234 && this.Myself.NhiemVuPosY == 176 /*0xB0*/)
            this.CallSetUpNhiemVuData(233, 184);
          if (this.Myself.NhiemVuPosX == 240 /*0xF0*/ && this.Myself.NhiemVuPosY == 181)
            this.CallSetUpNhiemVuData(241, 182);
          if (this.Myself.NhiemVuPosX == 234 && this.Myself.NhiemVuPosY == 175)
            this.CallSetUpNhiemVuData(nvPosY: 171);
        }
        if (this.Myself.NhiemVuMapID == 26 && this.Myself.NhiemVuPosX == 183 && this.Myself.NhiemVuPosY == 167)
          this.CallSetUpNhiemVuData(nvPosY: 168);
        if (this.Myself.NhiemVuMapID == 25 && this.Myself.NhiemVuPosX == 155 && this.Myself.NhiemVuPosY == 250)
          this.CallSetUpNhiemVuData(nvPosY: 205);
        if (this.Myself.QuestInfo.Contains(frmMain.langTimThuLinhGH) || this.Myself.QuestInfoHex.Contains(frmMain.langTimThuLinhGH2))
        {
          if (GA.IsBangMapID(this.Myself.MapID))
          {
            tempX = 99;
            tempY = 54;
            if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) tempX, (double) tempY) > 2.0)
            {
              this.CallInMapMove(tempX, tempY);
            }
            else
            {
              this.Myself.InMapPathPoints.Clear();
              this.Myself.InPathPointIndex = 0;
              this.Myself.InMapPathPoints.Add(new InMapPoint()
              {
                PosX = 22,
                PosY = 39
              });
              this.Myself.InMapPathPoints.Add(new InMapPoint()
              {
                PosX = 39,
                PosY = 36
              });
              this.Myself.InMapPathPoints.Add(new InMapPoint()
              {
                PosX = 31 /*0x1F*/,
                PosY = 23
              });
              this.Myself.XayDungDichChuyen = true;
              this.Myself.XayDungNhanQ = true;
              this.Myself.XayDungFinished = false;
              this.Myself.XayDungCongTruong = true;
              this.Myself.XayDungVaoCongTruong = true;
              this.CallTalkNPCByPos(600039, -1, 99, 54);
              Thread.Sleep(1000);
              this.CallTalkNPCByPos(600039, 1, 99, 54, false);
              Thread.Sleep(1000);
              if (this.Myself.PacketMsg == "XDTQ")
              {
                this.CallTraNhiemVu();
                Thread.Sleep(700);
                this.CallTraNhiemVu();
                Thread.Sleep(500);
                this.Myself.XayDungFinished = false;
                this.Myself.XayDungNhanQ = false;
                this.Myself.XayDungInMap = false;
                this.Myself.XayDungDichChuyen = false;
                this.Myself.XayDungCheckQ = false;
                this.Myself.XayDungDanhQuai = false;
                this.Myself.OldQuestInfo = "";
                this.Myself.XayDungCongTruong = false;
                this.Myself.XayDungVaoCongTruong = false;
                this.Myself.actionCounter = 0;
                this.ResetPacketMsg();
                this.ResetEventString();
                this.CallResetNhiemVuData();
                ++this.Myself.xaydungCounter;
                GA.WriteUserLog(frmMain.langCompeteXBuildingQ, this, (object) this.Myself.xaydungCounter);
              }
            }
          }
          else
            this.GoToMyBang();
        }
        else if (this.Myself.QuestInfo.ToLower().Contains("cần các hạ đi đoạt lại") || this.Myself.QuestInfoHex.ToLower().Contains("c¥n các hÕ ði ðoÕt lÕi"))
        {
          this.Myself.XayDungDanhQuai = true;
        }
        else
        {
          if (this.Myself.NhiemVuPosX == 0 && this.Myself.NhiemVuPosY == 0)
            this.Myself.XayDungFinished = true;
          this.Myself.XayDungNhanQ = true;
          this.Myself.XayDungDichChuyen = false;
        }
      }
label_49:
      if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds < 2000L)
        Thread.Sleep(200);
      else
        break;
    }
    this.Myself.XayDungCheckQ = true;
  }

  public void GoToMyBang(bool modeStuck = true)
  {
    int num1 = 321;
    int num2 = 263;
    int menuTypeID = 1084;
    int menuIndex = 6;
    int mapID = 1;
    int num3 = 156;
    if (this.Myself.MapID == 0)
    {
      num1 = 238;
      num2 = 236;
      if (GA.ClientVersion(this) == 10)
      {
        num1 = 140;
        num2 = 95;
      }
      menuTypeID = 30;
      menuIndex = 6;
      mapID = 0;
      num3 = 177;
      if (this.Target.SubVersion == 30)
        num3 = 154;
    }
    else if (this.Myself.MapID == 1)
    {
      num1 = 321;
      num2 = 263;
      if (GA.ClientVersion(this) == 10)
      {
        num1 = 224 /*0xE0*/;
        num2 = 184;
      }
      menuTypeID = 1084;
      menuIndex = 6;
      mapID = 1;
      num3 = 156;
      if (this.Target.SubVersion == 30)
        num3 = 64 /*0x40*/;
    }
    else if (this.Myself.MapID == 2)
    {
      num1 = 178;
      num2 = 121;
      if (GA.ClientVersion(this) == 10)
      {
        num1 = 182;
        num2 = 118;
      }
      menuTypeID = 2093;
      menuIndex = 6;
      mapID = 2;
      num3 = 163;
      if (this.Target.SubVersion == 30)
        num3 = 110;
    }
    if (!this.IsInCity())
      this.Myself.previousMapID_3 = -1;
    if (this.Myself.MapID == mapID && this.Myself.previousMapID_3 != this.Myself.MapID)
    {
      this.Myself.previousMapID_3 = this.Myself.MapID;
      this.CallMoveFlashPos(num1, num2);
    }
    if (this.Myself.MapID == mapID || this.Myself.ActionStatus == (byte) 2 || this.Myself.ActionStatus == (byte) 5 || this.Myself.JustWarped || num1 <= 0 || num2 <= 0 || mapID < 0 || GA.IsInPhuBan(this.Myself.MapID, this))
    {
      if (this.Myself.MapID != mapID || this.Myself.ActionStatus == (byte) 2 || this.Myself.ActionStatus == (byte) 5 || this.Myself.JustWarped || num1 <= 0 || num2 <= 0 || mapID < 0)
        return;
      this.CallLenNgua();
      if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num1, (double) num2) > 2.5)
      {
        if (modeStuck)
          this.CallInMapMove(num1, num2);
        else
          this.CallMoveFlashPos(num1, num2);
      }
      else
      {
        int mapId = this.Myself.MapID;
        this.CallSelectTarget(num3);
        Thread.Sleep(350);
        this.CallTalkNPC(0, 0, num3);
        Thread.Sleep(350);
        this.CallTalkNPC(menuTypeID, menuIndex, num3);
        Thread.Sleep(350);
        bool flag = false;
        long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
        while (!flag)
        {
          if (this.Myself.MapID != mapId && this.Myself.HPPercent > 0.0 && !this.Myself.JustWarped)
            flag = true;
          else if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds < 10000L)
            Thread.Sleep(500);
          else
            break;
        }
        Thread.Sleep(1000);
      }
    }
    else
    {
      this.CallLenNgua();
      if (modeStuck)
        this.CallOutMapMove(num1, num2, mapID);
      else
        this.CallAutoMoveToTarget(num1, num2, mapID);
    }
  }

  private bool GoToMyPos(int posX, int posY, int mapID = -1)
  {
    if (this.Myself.isMessageBox_Self == 1)
    {
      this.CallStartAutoMoveClick();
      Thread.Sleep(2000);
    }
    if (this.Myself.MapID == mapID || mapID == -1)
    {
      double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) posX, (double) posY);
      if (distance <= 2.5)
      {
        if (this.Myself.Status == AllEnums.CharStatuses.GOGOGO)
          this.Myself.Status = AllEnums.CharStatuses.IDLE;
        return true;
      }
      if (distance > 35.0)
        this.CallLenNgua();
      this.CallInMapMove(posX, posY, true);
    }
    else
    {
      this.CallLenNgua();
      this.CallOutMapMove(posX, posY, mapID);
    }
    return false;
  }

  private bool DiXaPhu(int mapID)
  {
    bool flag = false;
    int menuIndex1 = 0;
    int menuIndex2 = 0;
    int num1 = 334;
    int num2 = 250;
    int num3 = 153;
    if (GA.ClientVersion(this) == 10)
    {
      num1 = 241;
      num2 = 158;
    }
    if (this.Myself.MapID == mapID || !this.IsInCity())
      return true;
    if (mapID >= 20 && mapID <= 23)
    {
      menuIndex1 = 6;
      menuIndex2 = 61;
      flag = true;
    }
    else if (mapID >= 26 && mapID <= 29)
    {
      menuIndex1 = 5;
      menuIndex2 = 51;
      flag = true;
    }
    else if (mapID >= 32 /*0x20*/ && mapID <= 35)
    {
      menuIndex1 = 4;
      menuIndex2 = 41;
      flag = true;
    }
    if (!flag)
      return true;
    if (this.Myself.MapID == 1)
    {
      if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num1, (double) num2) > 3.0)
      {
        if (!this.Myself.JustWarped)
        {
          this.CallLenNgua();
          this.CallInMapMove(num1, num2);
        }
      }
      else
      {
        this.CallSelectTarget(num3);
        Thread.Sleep(300);
        this.CallTalkNPC(0, 0, num3);
        Thread.Sleep(700);
        this.CallTalkNPC(400957, menuIndex1, num3);
        Thread.Sleep(700);
        this.CallTalkNPC(400957, menuIndex2, num3);
        Thread.Sleep(1000);
        if (this.Myself.isMessageBox_Self == 1)
        {
          this.CallStartAutoMoveClick();
          Thread.Sleep(3000);
        }
        else
          Thread.Sleep(2000);
      }
    }
    else if (!this.Myself.JustWarped)
    {
      this.CallLenNgua();
      this.CallOutMapMove(num1, num2, 1);
    }
    return false;
  }

  private void SearchItemIventory(ref int itemCount, int itemID = 0, string itemString = "", int index = -1)
  {
    for (int index1 = 0; index1 < 80 /*0x50*/; ++index1)
    {
      InventoryItem allItem = this.MyInventory.AllItems[index1];
      if (allItem != null && (allItem.ItemID == itemID || allItem.ItemName.ToLower().Contains(itemString) || allItem.ItemType.ToLower().Contains(itemString)))
        ++itemCount;
    }
  }

  private void DiTimBauVat(int bauvatID = 999, int mapID = -1, bool danhquai = false, string quainame = "")
  {
    int num1 = 1;
    if (mapID != -1)
    {
      if (this.Myself.OutMapPathPoints.Count == 0)
      {
        foreach (KhoangDuocDBElement khoangDuocDbElement in frmLogin.GAuto.KhoangDuocDB)
        {
          if (khoangDuocDbElement.MapID == mapID)
            this.Myself.OutMapPathPoints.Add(new InMapPoint()
            {
              Arrived = false,
              Cleared = false,
              MapID = mapID,
              PosX = khoangDuocDbElement.PosX,
              PosY = khoangDuocDbElement.PosY,
              STT = num1
            });
        }
        this.Myself.OutPathPointIndex = mapID != 4 ? new Random().Next(0, this.Myself.OutMapPathPoints.Count - 1) : 7;
      }
    }
    else
      this.Myself.OutMapPathPoints.Clear();
    NewBoc newBoc = (NewBoc) null;
    if (bauvatID != 999)
    {
      try
      {
        double num2 = 50.0;
        for (int index1 = this.MyBoc.AllBocs.Count - 1; index1 >= 0; --index1)
        {
          NewBoc allBoc = this.MyBoc.AllBocs[index1];
          if (bauvatID == 1001 || this.Myself.isBachHoaDuyen || this.Myself.isQSM || this.Myself.isNhatTuyet)
          {
            bool flag = false;
            for (int index2 = 0; index2 < this.MyBoc.PickedBocList.Count; ++index2)
            {
              NewBoc pickedBoc = this.MyBoc.PickedBocList[index2];
              if (pickedBoc.BocID != 0 && pickedBoc.BocID == allBoc.BocID && (double) Math.Abs(pickedBoc.PosX - allBoc.PosX) <= 0.5 && (double) Math.Abs(pickedBoc.PosY - allBoc.PosY) <= 0.5)
              {
                flag = true;
                break;
              }
            }
            if (flag)
              continue;
          }
          if (allBoc.BocID != 0 && (double) allBoc.PosX != 0.0 && (double) allBoc.PosY != 0.0)
          {
            if (bauvatID == 1001)
            {
              if (this.Settings.cboxKhaiKhoang && allBoc.BocType >= 1 && allBoc.BocType <= 15 || this.Settings.cboxHaiDuoc && allBoc.BocType >= 101 && allBoc.BocType <= 126)
              {
                double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) allBoc.PosX, (double) allBoc.PosY);
                if (distance < num2)
                {
                  bool flag = false;
                  if (this.Settings.cboLocDuoc == "Quế Tâm")
                  {
                    if (allBoc.BocType == 118)
                      flag = true;
                  }
                  else if (this.Settings.cboLocDuoc == "Đương Qui")
                  {
                    if (allBoc.BocType == 117)
                      flag = true;
                  }
                  else if (this.Settings.cboLocDuoc == "Hương Phụ")
                  {
                    if (allBoc.BocType == 119)
                      flag = true;
                  }
                  else if (this.Settings.cboLocDuoc == "Thương Thuật")
                  {
                    if (allBoc.BocType == 112 /*0x70*/)
                      flag = true;
                  }
                  else
                    flag = true;
                  if (flag)
                  {
                    newBoc = allBoc;
                    num2 = distance;
                  }
                }
              }
            }
            else if (allBoc.BocType == bauvatID)
            {
              double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) allBoc.PosX, (double) allBoc.PosY);
              if (distance < num2)
              {
                bool flag = false;
                if (this.Myself.isNhatTuyet)
                {
                  if (this.Settings.cboxNhatTuyetDungIm)
                  {
                    if (distance > (double) this.Settings.numBanKinhNhat)
                    {
                      flag = true;
                      goto label_51;
                    }
                    goto label_51;
                  }
                }
                try
                {
                  for (int index3 = this.MyPlayers.AllPlayers.Count - 1; index3 >= 0; --index3)
                  {
                    if (GA.CalculateDistance((double) this.MyPlayers.AllPlayers[index3].PosX, (double) this.MyPlayers.AllPlayers[index3].PosY, (double) allBoc.PosX, (double) allBoc.PosY) <= 2.0)
                    {
                      flag = true;
                      break;
                    }
                  }
                }
                catch (Exception ex)
                {
                }
label_51:
                if (!flag)
                {
                  newBoc = allBoc;
                  num2 = distance;
                }
              }
            }
          }
        }
      }
      catch (Exception ex)
      {
        GA.WriteUserLog(frmMain.langErrorTreasureFinding, this);
      }
      if (newBoc != null)
      {
        double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) newBoc.PosX, (double) newBoc.PosY);
        if (distance > 6.0)
        {
          if (this.Myself.actionCounter <= 1)
          {
            this.CallMoveFlashPos((int) newBoc.PosX, (int) newBoc.PosY);
            ++this.Myself.actionCounter;
          }
          else
            this.CallInMapMove((int) newBoc.PosX, (int) newBoc.PosY, true);
        }
        if (distance <= 6.0)
        {
          if (distance >= 3.0)
            this.CallMoveFlashPos((int) newBoc.PosX, (int) newBoc.PosY);
          this.Myself.actionCounter = 0;
          this.Myself.LastPostStamp.Reset();
          this.Myself.LastPostStamp.Start();
          this.CallXuongNgua();
          if (this.Myself.ActionStatus != (byte) 5 && this.Myself.HorseType == -1 && (this.Myself.BocShow == 0 || this.Myself.BocShowID != newBoc.BocID))
          {
            this.ResetEventString();
            if (newBoc.BocID != this.MyFlag.BocID_Saved)
            {
              this.MyFlag.BocID_Saved = newBoc.BocID;
              this.Myself.EventStamp = 0L;
            }
            if (this.Myself.EventStamp == 0L)
              this.Myself.EventStamp = frmLogin.GlobalTimer.ElapsedMilliseconds + 15000L;
            long num3 = frmLogin.GlobalTimer.ElapsedMilliseconds + 2000L;
            while (this.Myself.ActionStatus != (byte) 0)
            {
              Thread.Sleep(100);
              if (num3 < frmLogin.GlobalTimer.ElapsedMilliseconds)
                break;
            }
            this.CallThocBocFunc(newBoc.BocID);
            Thread.Sleep(1000);
          }
          if (this.Myself.EventString == "KDCD")
          {
            if (newBoc.BocID > 0)
            {
              this.MyBoc.PickedBocList[this.MyBoc.CurrentPickedIndex].BocID = newBoc.BocID;
              this.MyBoc.PickedBocList[this.MyBoc.CurrentPickedIndex].PosX = newBoc.PosX;
              this.MyBoc.PickedBocList[this.MyBoc.CurrentPickedIndex].PosY = newBoc.PosY;
              ++this.MyBoc.CurrentPickedIndex;
              if (this.MyBoc.CurrentPickedIndex >= this.MyBoc.PickedBocList.Count)
                this.MyBoc.CurrentPickedIndex = 0;
            }
            this.ResetBocPre(newBoc.BocID);
            this.Myself.Status = AllEnums.CharStatuses.IDLE;
            this.ResetEventString();
          }
          if (this.Myself.EventStamp < frmLogin.GlobalTimer.ElapsedMilliseconds && this.Myself.EventStamp != 0L && this.Myself.ActionStatus != (byte) 5 && this.Myself.ActionStatus != (byte) 8)
          {
            if (newBoc.BocID > 0)
            {
              this.MyBoc.PickedBocList[this.MyBoc.CurrentPickedIndex].BocID = newBoc.BocID;
              this.MyBoc.PickedBocList[this.MyBoc.CurrentPickedIndex].PosX = newBoc.PosX;
              this.MyBoc.PickedBocList[this.MyBoc.CurrentPickedIndex].PosY = newBoc.PosY;
              ++this.MyBoc.CurrentPickedIndex;
              if (this.MyBoc.CurrentPickedIndex >= this.MyBoc.PickedBocList.Count)
                this.MyBoc.CurrentPickedIndex = 0;
            }
            this.CallPickAllItems();
            this.ResetBocPre(newBoc.BocID);
            this.Myself.EventStamp = 0L;
          }
          if (this.Myself.BocShow == 1)
          {
            this.CallPickAllItems();
            Thread.Sleep(300);
          }
          long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
          int num4 = 9000;
          if (bauvatID == 799)
            num4 = 12000;
          bool flag1 = false;
          if (this.Myself.ActionStatus == (byte) 8)
            flag1 = true;
          while (this.IsAIEnabled && flag1)
          {
            if (this.Myself.isNhatTuyet)
            {
              if (this.Settings.NhatItemMode == AllEnums.NhatItemModes.NHATHET)
                this.CallPickAllItems();
              else
                this.CallPickTheoDanhSach();
            }
            else
              this.CallPickAllItems();
            Thread.Sleep(50);
            if (this.Myself.ActionStatus != (byte) 8)
            {
              if (this.Myself.isNhatTuyet)
              {
                if (this.Settings.NhatItemMode == AllEnums.NhatItemModes.NHATHET)
                  this.CallPickAllItems();
                else
                  this.CallPickTheoDanhSach();
              }
              else
                this.CallPickAllItems();
              this.ResetBocPre(newBoc.BocID);
              break;
            }
            bool flag2 = false;
            try
            {
              if (this.MyBoc.AllBocs.Count > 0)
              {
                for (int index = this.MyBoc.AllBocs.Count - 1; index >= 0; --index)
                {
                  if (this.MyBoc.AllBocs[index].BocID == newBoc.BocID)
                  {
                    flag2 = true;
                    break;
                  }
                }
              }
            }
            catch (Exception ex)
            {
              if (GA.isVipMember())
                GA.WriteUserLog("Lỗi khi hái hoa thái hồ", this);
            }
            if (!flag2)
            {
              Random random = new Random();
              this.Myself.OutPathPointIndex = this.Myself.OutMapPathPoints.Count - this.Myself.OutPathPointIndex <= 6 ? random.Next(0, this.Myself.OutMapPathPoints.Count - 1) : random.Next(this.Myself.OutPathPointIndex, this.Myself.OutMapPathPoints.Count - 1);
              break;
            }
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds > (long) num4)
            {
              this.ResetBocPre(newBoc.BocID);
              this.Myself.EventStamp = 0L;
              break;
            }
          }
        }
      }
    }
    if (this.Myself.BocShow == 1)
    {
      if (this.Settings.NhatItemMode == AllEnums.NhatItemModes.NHATHET)
        this.CallPickAllItems();
      else
        this.CallPickTheoDanhSach();
    }
    if (this.Myself.isNhatTuyet && this.Settings.cboxNhatTuyetDungIm)
      return;
    QuaiIndividual quaiIndividual1 = (QuaiIndividual) null;
    QuaiIndividual quaiIndividual2 = (QuaiIndividual) null;
    if (danhquai)
    {
      if (this.MyQuai.AllQuai.Count > 0)
      {
        if (this.MyQuai.TargetID == -1)
        {
          if ((double) this.MyQuai.TargetHPPercent > 0.0)
            goto label_142;
        }
        try
        {
          double num5 = 50.0;
          for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
          {
            QuaiIndividual quai = this.MyQuai.AllQuai[index];
            bool flag = true;
            if (this.HasActivePet())
            {
              if (quai.ID != this.MyPet.AllPets[this.MyPet.ActivePetIndex].ID)
                flag = false;
            }
            else
              flag = false;
            if (quai.ID >= 0 && (double) quai.HPPercent > 0.0 && quai.ID != this.Myself.ID && !flag && this.CanAttack(quai))
            {
              double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quai.PosX, (double) quai.PosY);
              if ((quai.Name == quainame || quai.Name.Contains(quainame) || quainame.Contains(quai.Name) || quainame == string.Empty) && distance < num5)
              {
                quaiIndividual1 = quai;
                num5 = distance;
                this.CallSelectTarget(quaiIndividual1.ID);
                this.Myself.Status = AllEnums.CharStatuses.IDLE;
              }
              if (distance < 3.0 && quai.Name.ToLower().Contains("ộ đảo th"))
              {
                if (this.Myself.ActionStatus != (byte) 5)
                  this.CallTangHinh();
                quaiIndividual2 = quai;
              }
            }
            if (quai.ID >= 0 && (double) quai.HPPercent > 0.0 && quai.ID != this.Myself.ID && !flag && quai.CanAttack == (byte) 0 && (quai.Name == quainame || quai.Name.Contains(quainame) || quainame.Contains(quai.Name)) && quai.Name.Contains("Trưởng Thành"))
            {
              this.Myself.NhiemVuQuaiID = quai.ID;
              this.CallMoveFlashPos((int) quai.PosX, (int) quai.PosY);
              Thread.Sleep(2000);
              return;
            }
          }
        }
        catch (Exception ex)
        {
        }
label_142:
        if (quaiIndividual1 == null && quaiIndividual2 != null)
        {
          quaiIndividual1 = quaiIndividual2;
          this.CallSelectTarget(quaiIndividual1.ID);
        }
        if (quaiIndividual1 != null)
        {
          if (quaiIndividual1.ID >= 0)
          {
            this.CallXuongNgua();
            double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quaiIndividual1.PosX, (double) quaiIndividual1.PosY);
            if (distance < 12.0 && this.Myself.CharType == AllEnums.CharTypes.NUKER || distance < 2.0 && this.Myself.CharType == AllEnums.CharTypes.TANKER)
              this.CallAttackTargetPacket(this.Myself.ID, this.MySkills.AllSkills[0].ID, quaiIndividual1.ID, 0, 0);
            else
              this.CallAttackTarget(quaiIndividual1.ID, this.MySkills.AllSkills[0].ID, 0, 0);
            if (this.Settings.SkillPlayList.Count > 0)
            {
              try
              {
                for (int index = 0; index < this.Settings.SkillPlayList.Count; ++index)
                {
                  SkillPlayItem skillPlay = this.Settings.SkillPlayList[index];
                  if (skillPlay.IsEnabled)
                  {
                    if (this.PlayMySkill(skillPlay, quaiIndividual1.ID))
                      break;
                  }
                }
              }
              catch (Exception ex)
              {
                if (GA.isVipMember())
                  GA.WriteUserLog(frmMain.langCannotSkill + ex.Message, this);
              }
            }
            this.PlayPetAOE((int) quaiIndividual1.PosX, (int) quaiIndividual1.PosY);
          }
        }
        else
          this.CallSelectTarget(-1);
      }
      this.NhatBoc();
    }
    if (newBoc != null || quaiIndividual1 != null)
      return;
    if (this.Myself.OutMapPathPoints.Count <= 0)
      return;
    try
    {
      this.CallLenNgua();
      if (this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Cleared)
      {
        ++this.Myself.OutPathPointIndex;
        if (this.Myself.OutPathPointIndex >= this.Myself.OutMapPathPoints.Count)
        {
          for (int index = 0; index < this.Myself.OutMapPathPoints.Count; ++index)
          {
            this.Myself.OutMapPathPoints[index].Cleared = false;
            this.Myself.OutMapPathPoints[index].Arrived = false;
          }
          this.Myself.MyLastOutStamp = 0L;
          this.Myself.OutPathPointIndex = new Random().Next(0, this.Myself.OutMapPathPoints.Count - 1);
        }
        int posX1 = (int) this.Myself.PosX;
        int posY1 = (int) this.Myself.PosY;
        if (this.Myself.OutPathPointIndex >= 0 && this.Myself.OutPathPointIndex < this.Myself.OutMapPathPoints.Count && !this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Arrived)
        {
          int posX2 = this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].PosX;
          int posY2 = this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].PosY;
          if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) posX2, (double) posY2) > 6.0)
          {
            this.CallInMapMove(posX2, posY2);
            this.Myself.MyLastOutStamp = 0L;
          }
          else
          {
            this.Myself.MyLastOutStamp = 0L;
            this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Arrived = true;
            this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Cleared = true;
            this.Myself.MyLastOutStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
            this.Myself.Status = AllEnums.CharStatuses.IDLE;
          }
        }
      }
      if (!this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Cleared)
      {
        int posX = this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].PosX;
        int posY = this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].PosY;
        double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) posX, (double) posY);
        if (distance > 5.0 && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LastMoveStamp >= 1000L)
        {
          this.Myself.LastMoveStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
          this.CallInMapMove(posX, posY);
          this.Myself.MyLastOutStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
        }
        if (distance <= 5.0)
          this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Cleared = true;
      }
      if (this.Myself.OutMapPathPoints.Count <= 0 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.MyLastOutStamp < 2000L || this.Myself.MyLastOutStamp == 0L || this.Myself.OutPathPointIndex < 0 || this.Myself.OutPathPointIndex >= this.Myself.OutMapPathPoints.Count)
        return;
      this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Cleared = true;
    }
    catch (Exception ex)
    {
      GA.WriteUserLog(frmMain.langErrorFindingPath);
      this.Myself.OutPathPointIndex = 0;
    }
  }

  public void CallOutMapMove(int tempX, int tempY, int mapID)
  {
    if (this.Myself.isMessageBox_Self == 1 && !this.Myself.JustWarped)
    {
      this.CallStartAutoMoveClick();
      Thread.Sleep(1000);
    }
    this.ResetJustWarped();
    long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
    long stayIdleStamp = frmLogin.StayIdleStamp;
    if ((this.nowStamp() - frmLogin.StayIdleStamp >= 2500L || frmLogin.StayIdleStamp == 0L) && this.Myself.ActionStatus != (byte) 5 && (this.Myself.HPPercent > 0.0 || this.Myself.isYTO) && !this.Myself.JustWarped && tempX > 0 && tempY > 0 && mapID >= 0)
    {
      if (this.Myself.ActionStatus == (byte) 2 && this.Myself.moveCounter == 0)
      {
        if (this.Target.VersionNum == 3 || this.Target.VersionNum == 4)
        {
          this.Myself.LongMoveX = tempX;
          this.Myself.LongMoveY = tempY;
          this.Myself.LongMoveMapID = mapID;
          this.Myself.IsLongMove = true;
        }
        else
          ++this.Myself.moveCounter;
      }
      if (this.Myself.ActionStatus != (byte) 2 || this.Myself.moveCounter == 1)
      {
        ++this.Myself.moveCounter;
        this.Myself.TargetX = (float) tempX;
        this.Myself.TargetY = (float) tempY;
        this.Myself.MoveAcrossMap = true;
        this.Myself.UseAutoMove = this.Target.VersionNum != 3 && this.Target.VersionNum != 4;
        if (!this.IsMoveStuck())
        {
          if (GA.IsBangMapID(this.Myself.MapID) && !GA.IsBangMapID(this.Myself.TargetMapID))
          {
            tempX = 99;
            tempY = 54;
            if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) tempX, (double) tempY) > 2.5)
            {
              this.CallLenNgua();
              this.CallMoveFlashPos(tempX, tempY);
            }
            else
            {
              this.CallTalkNPCByPos(0, 0, tempX, tempY, false);
              Thread.Sleep(300);
              this.CallTalkNPCByPos(805009, 29, tempX, tempY, false);
              Thread.Sleep(500);
              if (this.Myself.TargetMapID == 0 || this.Myself.TargetMapID >= 19 && this.Myself.TargetMapID <= 23 || this.Myself.TargetMapID == 8)
                this.CallTalkNPCByPos(805009, 11, tempX, tempY, false);
              else if (this.Myself.TargetMapID == 2 || this.Myself.TargetMapID >= 24 && this.Myself.TargetMapID <= 29 || this.Myself.TargetMapID == 7 || this.Myself.TargetMapID == 6)
                this.CallTalkNPCByPos(805009, 27, tempX, tempY, false);
              else
                this.CallTalkNPCByPos(805009, 28, tempX, tempY, false);
              Thread.Sleep(1000);
              if (this.Myself.isMessageBox_Self == 1)
              {
                this.CallStartAutoMoveClick();
                Thread.Sleep(3000);
              }
            }
          }
          else if (GA.IsBangMapID(this.Myself.TargetMapID) && !GA.IsBangMapID(this.Myself.MapID) && !this.IsInPhaiPhuBan())
            this.GoToMyBang(false);
          else if (this.IsInPhaiPhuBan())
          {
            int X = 0;
            int Y = 0;
            if (frmLogin.GAuto.PhuBanPathDB.Count > 0)
            {
              foreach (PhuBanPath phuBanPath in frmLogin.GAuto.PhuBanPathDB)
              {
                if (phuBanPath.MapIDTrong == this.Myself.MapID)
                {
                  X = phuBanPath.ExitX;
                  Y = phuBanPath.ExitY;
                  break;
                }
              }
            }
            this.CallLenNgua();
            this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
            this.CallMoveFlashPos(X, Y);
          }
          else if (this.Myself.TargetMapID == 181 && this.Myself.MapID != 181)
          {
            tempX = 303;
            tempY = 314;
            if (this.Myself.MapID == 0)
            {
              double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) tempX, (double) tempY);
              if (distance > 2.5)
              {
                if (distance > 20.0)
                  this.CallLenNgua();
                this.CallMoveFlashPos(tempX, tempY);
              }
              else
              {
                int num = 50;
                int menuTypeID = 100;
                int menuIndex = 2;
                this.CallSelectTarget(num);
                Thread.Sleep(200);
                this.CallTalkNPC(0, 0, num);
                Thread.Sleep(200);
                this.CallTalkNPC(menuTypeID, menuIndex, num);
                Thread.Sleep(200);
              }
            }
            else
              this.CallAutoMoveToTarget(tempX, tempY, 0);
          }
          else if (this.Myself.TargetMapID == 443 && this.Myself.MapID != 443)
          {
            tempX = 150;
            tempY = 152;
            int mapID1 = 420;
            if (this.Myself.MapID == mapID1)
            {
              double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) tempX, (double) tempY);
              if (distance > 2.5)
              {
                if (distance > 20.0)
                  this.CallLenNgua();
                this.CallMoveFlashPos(tempX, tempY);
              }
              else
              {
                int num = 55;
                int menuTypeID = 403001;
                int menuIndex = 1;
                this.CallSelectTarget(num);
                Thread.Sleep(200);
                this.CallTalkNPC(0, 0, num);
                Thread.Sleep(300);
                this.CallTalkNPC(menuTypeID, menuIndex, num);
                Thread.Sleep(200);
              }
            }
            else
              this.CallAutoMoveToTarget(tempX, tempY, mapID1);
          }
          else if (GA.isInChienMinh(this.Myself.TargetMapID))
          {
            tempX = 158;
            tempY = 65;
            if (this.Myself.MapID == 480)
            {
              double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) tempX, (double) tempY);
              if (distance > 2.5)
              {
                if (distance > 20.0)
                  this.CallLenNgua();
                this.CallMoveFlashPos(tempX, tempY);
              }
              else
              {
                int num = 33;
                int menuTypeID = 890743;
                int menuIndex = 201;
                this.CallSelectTarget(num);
                Thread.Sleep(200);
                this.CallTalkNPC(0, 0, num);
                this.waitQuestFrameShow();
                this.CallTalkNPC(menuTypeID, menuIndex, num);
                Thread.Sleep(1000);
              }
            }
            else
              this.CallAutoMoveToTarget(tempX, tempY, 480);
          }
          else if (GA.isInChienMinh(this.Myself.MapID) && (GA.isInCity(this.Myself.TargetMapID) || GA.IsBangMapID(this.Myself.TargetMapID)))
          {
            tempX = 212;
            tempY = 184;
            double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) tempX, (double) tempY);
            if (distance > 2.5)
            {
              if (distance > 20.0)
                this.CallLenNgua();
              this.CallMoveFlashPos(tempX, tempY);
            }
            else
            {
              int num = 19;
              int menuTypeID = 891561;
              int menuIndex = 4;
              this.CallSelectTarget(num);
              Thread.Sleep(200);
              this.CallTalkNPC(0, 0, num);
              this.waitQuestFrameShow();
              this.CallTalkNPC(menuTypeID, menuIndex, num);
              Thread.Sleep(1000);
            }
          }
          else
          {
            this.Myself.TargetMapID = mapID;
            if (this.Target.VersionNum == 3 || this.Target.VersionNum == 4)
            {
              this.Myself.LongMoveX = tempX;
              this.Myself.LongMoveY = tempY;
              this.Myself.LongMoveMapID = mapID;
              this.Myself.IsLongMove = true;
            }
            else if (!this.Myself.JustWarped)
              this.CallAutoMoveToTarget((int) this.Myself.TargetX, (int) this.Myself.TargetY, this.Myself.TargetMapID);
          }
        }
      }
    }
    if (this.Myself.MapID == mapID)
      this.Myself.moveCounter = 0;
    if (!(this.Myself.EventString == "CLXN") || this.Myself.ActionStatus != (byte) 2)
      return;
    this.CallMoveFlashPos((int) this.Myself.PosX, (int) this.Myself.PosY);
    this.ResetEventString();
  }

  private void CallInMapMove(int tempX, int tempY, bool noattack = false)
  {
    this.ResetJustWarped();
    if (this.Myself.ActionStatus != (byte) 5 && !this.Myself.JustWarped && this.Myself.HPPercent > 0.0 && tempX > 0 && tempY > 0)
    {
      if (noattack)
        this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
      else if (this.Myself.Status != AllEnums.CharStatuses.LENLAIBAITRAIN && this.Myself.Status != AllEnums.CharStatuses.VETHANH && this.Myself.Status != AllEnums.CharStatuses.SELF_HEALING && this.Myself.Status != AllEnums.CharStatuses.SELLING_NPC && this.Myself.Status != AllEnums.CharStatuses.BUYING_NPC)
        this.Myself.Status = AllEnums.CharStatuses.IDLE;
      if (this.Myself.ActionStatus == (byte) 2)
      {
        if (this.Myself.moveCounter == 0)
        {
          this.CallMoveFlashPos(tempX, tempY);
          ++this.Myself.moveCounter;
        }
        else if (this.Myself.moveCounter >= 10)
          this.Myself.moveCounter = 0;
      }
      else
      {
        this.Myself.TargetX = (float) tempX;
        this.Myself.TargetY = (float) tempY;
        this.Myself.TargetMapID = -1;
        this.Myself.MoveAcrossMap = false;
        this.Myself.UseAutoMove = false;
        if (!this.IsMoveStuck())
          this.CallMoveFlashPos((int) this.Myself.TargetX, (int) this.Myself.TargetY);
      }
    }
    if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) tempX, (double) tempY) <= 3.0)
      this.Myself.moveCounter = 0;
    if (!(this.Myself.EventString == "CLXN") || this.Myself.ActionStatus != (byte) 2)
      return;
    this.CallMoveFlashPos((int) this.Myself.PosX, (int) this.Myself.PosY);
    this.ResetEventString();
  }

  public void ResetPacketMsg()
  {
    if (this.Myself.PacketMsg == string.Empty)
      return;
    MessageFunc msgParams = new MessageFunc();
    msgParams.Message = 2007;
    int num = 0;
    while (this.Myself.PacketMsg != "")
    {
      switch (num)
      {
        case 0:
          this.WriteFuncParams(msgParams);
          break;
        case 15:
        case 30:
        case 45:
          this.WriteFuncParams(msgParams);
          break;
        case 60:
          GA.WriteUserLog(frmMain.langErrorMsg2Reset, this);
          return;
      }
      ++num;
      Thread.Sleep(200);
    }
  }

  public void ResetEventString()
  {
    if (this.Myself.EventString == string.Empty)
      return;
    MessageFunc msgParams = new MessageFunc();
    msgParams.Message = 2008;
    int num = 0;
    while (this.Myself.EventString != "")
    {
      switch (num)
      {
        case 0:
          this.WriteFuncParams(msgParams);
          break;
        case 15:
        case 30:
        case 45:
          this.WriteFuncParams(msgParams);
          break;
        case 60:
          GA.WriteUserLog(frmMain.langErrorResetString, this);
          return;
      }
      ++num;
      Thread.Sleep(200);
    }
  }

  public void PhuBanTangKinhCac(int mapID = -1)
  {
    bool flag1 = false;
    bool flag2 = false;
    int num1 = 0;
    int num2 = 3;
    bool flag3 = false;
    double hpPercent = this.Myself.HPPercent;
    if (mapID != -1)
    {
      bool flag4 = false;
      if (this.Myself.InMapPathPoints.Count == 0)
        flag4 = true;
      else if (this.Myself.InMapPathPoints[0].MapID != mapID)
      {
        flag4 = true;
        this.Myself.InMapPathPoints.Clear();
        if (this.Myself.InPathPointIndex != 2)
          this.Myself.InPathPointIndex = 0;
      }
      if (flag4)
      {
        foreach (KhoangDuocDBElement khoangDuocDbElement in frmLogin.GAuto.ATABDB)
        {
          if (khoangDuocDbElement.MapID == mapID)
          {
            this.Myself.InMapPathPoints.Add(new InMapPoint()
            {
              Arrived = false,
              Cleared = false,
              MapID = mapID,
              PosX = khoangDuocDbElement.PosX,
              PosY = khoangDuocDbElement.PosY,
              STT = khoangDuocDbElement.STT,
              Horse = khoangDuocDbElement.Horse
            });
            if (this.Myself.InPathPointIndex != 2)
              this.Myself.InPathPointIndex = 0;
          }
        }
      }
    }
    if (mapID == -1)
      mapID = this.Myself.MapID;
    bool flag5 = false;
    if ((GA.IsInPhuBan(this.Myself.MapID, this) || this.Myself.MapID == 141) && this.Myself.InMapPathPoints.Count > 0)
    {
      if (this.Myself.InMapPathPoints[1].PosX != this.Settings.TKCLeftX)
        this.Myself.InMapPathPoints[1].PosX = this.Settings.TKCLeftX;
      if (this.Myself.InMapPathPoints[1].PosY != this.Settings.TKCLeftY)
        this.Myself.InMapPathPoints[1].PosY = this.Settings.TKCLeftY;
      if (this.Myself.InMapPathPoints[2].PosX != this.Settings.TKCRightX)
        this.Myself.InMapPathPoints[2].PosX = this.Settings.TKCRightX;
      if (this.Myself.InMapPathPoints[2].PosY != this.Settings.TKCRightY)
        this.Myself.InMapPathPoints[2].PosY = this.Settings.TKCRightY;
      try
      {
        if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared)
        {
          ++this.Myself.InPathPointIndex;
          if (this.Myself.InPathPointIndex >= this.Myself.InMapPathPoints.Count)
          {
            for (int index = 0; index < this.Myself.InMapPathPoints.Count; ++index)
            {
              this.Myself.InMapPathPoints[index].Cleared = false;
              this.Myself.InMapPathPoints[index].Arrived = false;
            }
            this.Myself.MyLastStamp = 0L;
            this.Myself.InPathPointIndex = 0;
          }
          this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = false;
          this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived = false;
        }
        if (this.Myself.InPathPointIndex == 0)
          num2 = 0;
        if (this.MyQuai.AllQuai.Count > 0)
        {
          QuaiIndividual quaiIndividual = (QuaiIndividual) null;
          try
          {
            double num3 = 200.0;
            for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
            {
              QuaiIndividual quai = this.MyQuai.AllQuai[index];
              bool flag6 = true;
              if (this.HasActivePet())
              {
                if (quai.ID != this.MyPet.AllPets[this.MyPet.ActivePetIndex].ID)
                  flag6 = false;
              }
              else
                flag6 = false;
              if (quai.ID >= 0 && (double) quai.HPPercent > 0.0 && quai.ID != this.Myself.ID && !flag6 && this.CanAttack(quai))
              {
                ++num1;
                if (quai.Name.Contains(frmMain.langAcTang))
                {
                  quaiIndividual = quai;
                  this.CallSelectTarget(quaiIndividual.ID);
                  flag3 = true;
                }
                double distance = GA.CalculateDistance(63.0, 103.0, (double) quai.PosX, (double) quai.PosY);
                if (distance < num3)
                {
                  quaiIndividual = quai;
                  num3 = distance;
                  this.CallSelectTarget(quaiIndividual.ID);
                }
              }
            }
          }
          catch (Exception ex)
          {
            GA.WriteUserLog(frmMain.langErrorLookforQuai, this);
          }
          if (quaiIndividual != null && quaiIndividual.ID >= 0)
          {
            bool flag7 = false;
            if (this.Myself.FoundQuaiStamp == 0L)
              this.Myself.FoundQuaiStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
            if (this.MyParty.PartyNumbers > 0 && this.Myself.IsPartyFollowed == (byte) 1)
            {
              this.Myself.MyLastStamp = 0L;
              GA.ResetStatusParty(this);
              this.CallRemovePartyFollow();
              Thread.Sleep(350);
              GA.PartyDoSomething(this, mode: 30);
            }
            if (num1 <= num2 && !flag3)
            {
              if (this.Myself.InPathPointIndex == 1 || this.Myself.InPathPointIndex == 2)
              {
                if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.FoundQuaiStamp >= 20000L)
                {
                  this.CallLenNgua();
                  this.Myself.FoundQuaiStamp = 0L;
                }
              }
              else
                this.CallLenNgua();
            }
            if (num1 >= 5)
            {
              if (this.Myself.HorseType != -1 && !this.Myself.PBxong1vong && this.Settings.cboxDanhQuai)
                this.CallMounting();
              int Y = (int) quaiIndividual.PosY + 7;
              int posX = (int) quaiIndividual.PosX;
              if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quaiIndividual.PosX, (double) quaiIndividual.PosY) >= 5.0 && (double) this.Myself.PosY < (double) (Y - 3))
              {
                if (this.Myself.InPathPointIndex == 1)
                {
                  flag7 = true;
                  posX -= 5;
                }
                else if (this.Myself.InPathPointIndex == 2)
                {
                  flag7 = true;
                  posX += 5;
                }
                if (flag7)
                {
                  this.CallSelectTarget(quaiIndividual.ID);
                  if (this.Settings.cboxDanhQuai)
                    this.CallAttackTarget(quaiIndividual.ID, this.MySkills.AllSkills[0].ID, 0, 0);
                  this.CallMoveFlashPos(posX, Y);
                }
              }
            }
            if (this.Settings.cboxDanhQuai)
            {
              if (!flag7 && (flag3 || !flag3 && num1 > num2))
              {
                if (this.Myself.HasTarget && (double) this.MyQuai.TargetHPPercent > 0.0)
                {
                  if (this.Settings.cboxDanhQuai)
                  {
                    if (this.Myself.IsPartyFollowed == (byte) 1)
                    {
                      this.CallRemovePartyFollow();
                      Thread.Sleep(350);
                      GA.PartyDoSomething(this, mode: 30);
                    }
                    if (this.Myself.HorseType != -1 && !this.Myself.PBxong1vong && this.Settings.cboxDanhQuai)
                      this.CallMounting();
                    double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quaiIndividual.PosX, (double) quaiIndividual.PosY);
                    if (distance >= 12.0)
                      this.CallMoveFlashPos((int) quaiIndividual.PosX, (int) quaiIndividual.PosY);
                    if (distance < 12.0 && this.Myself.CharType == AllEnums.CharTypes.NUKER || distance < 2.0 && this.Myself.CharType == AllEnums.CharTypes.TANKER)
                      this.CallAttackTargetPacket(this.Myself.ID, this.MySkills.AllSkills[0].ID, quaiIndividual.ID, 0, 0);
                    else
                      this.CallAttackTarget(quaiIndividual.ID, this.MySkills.AllSkills[0].ID, 0, 0);
                    if (this.Settings.SkillPlayList.Count > 0)
                    {
                      try
                      {
                        for (int index = 0; index < this.Settings.SkillPlayList.Count; ++index)
                        {
                          SkillPlayItem skillPlay = this.Settings.SkillPlayList[index];
                          if (skillPlay.IsEnabled)
                          {
                            if (this.PlayMySkill(skillPlay, quaiIndividual.ID))
                              break;
                          }
                        }
                      }
                      catch (Exception ex)
                      {
                        GA.WriteUserLog(frmMain.langCannotSkill + ex.Message, this);
                      }
                    }
                    this.PlayPetAOE((int) quaiIndividual.PosX, (int) quaiIndividual.PosY);
                  }
                }
                else
                  this.AttackQuai();
              }
            }
            else
            {
              if (this.Myself.IsPartyFollowed == (byte) 1)
              {
                this.CallRemovePartyFollow();
                Thread.Sleep(350);
                GA.PartyDoSomething(this, mode: 30);
              }
              this.CallMoveFlashPos((int) quaiIndividual.PosX, (int) quaiIndividual.PosY);
            }
            if (num1 >= 3)
              this.Myself.hasQuai = true;
            this.Myself.MyLastStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
            this.Myself.QuaiDiedStamp = 0L;
            this.Myself.NoTargetStamp = 0L;
            this.Myself.hetquaiStamp = 0L;
            this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived = true;
          }
        }
        int posX1 = (int) this.Myself.PosX;
        int posY1 = (int) this.Myself.PosY;
        if (this.Myself.InPathPointIndex >= 0 && this.Myself.InPathPointIndex < this.Myself.InMapPathPoints.Count && !this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived)
        {
          int posX2 = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosX;
          int posY2 = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosY;
          double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) posX2, (double) posY2);
          if (distance > 2.5)
          {
            if (!this.Myself.PBxong1vong)
            {
              if (this.Myself.actionCounter <= 1)
              {
                this.CallMoveFlashPos(posX2, posY2);
                ++this.Myself.actionCounter;
              }
              else if (distance < 10.0)
                this.CallMoveFlashPos(posX2, posY2);
              else
                this.CallInMapMove(posX2, posY2, true);
            }
            else
            {
              if (!this.Myself.HasTarget || (double) this.MyQuai.TargetHPPercent <= 0.0)
              {
                if (this.Myself.actionCounter <= 1)
                {
                  this.CallMoveFlashPos(posX2, posY2);
                  ++this.Myself.actionCounter;
                }
                else if (distance < 10.0)
                  this.CallMoveFlashPos(posX2, posY2);
                else
                  this.CallInMapMove(posX2, posY2);
              }
              flag5 = true;
            }
            this.Myself.MyLastStamp = 0L;
            this.Myself.hetquaiStamp = 0L;
          }
          else
          {
            flag5 = true;
            this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived = true;
            this.Myself.MyLastStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
            this.Myself.Status = AllEnums.CharStatuses.IDLE;
            if (this.Myself.InPathPointIndex == 1 || this.Myself.InPathPointIndex == 2)
            {
              if (this.MyParty.PartyNumbers > 0 && this.Myself.IsPartyFollowed == (byte) 1)
              {
                this.Myself.MyLastStamp = 0L;
                GA.ResetStatusParty(this);
                this.CallRemovePartyFollow();
                Thread.Sleep(350);
                GA.PartyDoSomething(this, mode: 30);
              }
              if (this.Myself.HorseType != -1 && !this.Myself.PBxong1vong && this.Settings.cboxDanhQuai)
                this.CallMounting();
            }
          }
        }
        if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived)
        {
          if (this.Myself.Status == AllEnums.CharStatuses.GOGOGO)
            this.Myself.Status = AllEnums.CharStatuses.IDLE;
          this.Myself.actionCounter = 0;
          this.Myself.MyLastStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
          flag5 = true;
        }
      }
      catch (Exception ex)
      {
        GA.WriteUserLog(frmMain.langErrorRemovePath, this);
      }
    }
    if (flag5)
    {
      if (flag3 || !flag3 && num1 > num2)
      {
        this.FuncNgaMySupport();
        this.FuncAnHPMP();
        this.FuncPetSupport();
      }
      this.NhatBoc();
      if (this.Myself.Status == AllEnums.CharStatuses.IDLE)
      {
        if (!this.Myself.HasTarget)
        {
          if (this.Myself.NoTargetStamp == 0L)
            this.Myself.NoTargetStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
        }
        else
        {
          if ((double) this.MyQuai.TargetHPPercent <= 0.0)
          {
            if (this.Myself.QuaiDiedStamp == 0L)
              this.Myself.QuaiDiedStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
          }
          else
            this.Myself.QuaiDiedStamp = 0L;
          this.Myself.NoTargetStamp = 0L;
        }
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.NoTargetStamp >= 700L && this.Myself.NoTargetStamp != 0L || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.QuaiDiedStamp >= 700L && this.Myself.QuaiDiedStamp != 0L)
          flag2 = true;
        if (flag2)
        {
          if (this.MyQuai.AllQuai.Count > 0)
          {
            QuaiIndividual quaiIndividual = (QuaiIndividual) null;
            try
            {
              for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
              {
                QuaiIndividual quai = this.MyQuai.AllQuai[index];
                bool flag8 = true;
                if (this.HasActivePet())
                {
                  if (quai.ID != this.MyPet.AllPets[this.MyPet.ActivePetIndex].ID)
                    flag8 = false;
                }
                else
                  flag8 = false;
                if (quai.ID >= 0 && (double) quai.HPPercent > 0.0 && quai.ID != this.Myself.ID && !flag8 && this.CanAttack(quai))
                {
                  quaiIndividual = quai;
                  this.CallSelectTarget(quaiIndividual.ID);
                }
                if (quai.Name.Contains("Phật Đăng") || quai.Name.Contains("uddhist Lam"))
                {
                  int id = quai.ID;
                  double posX = (double) quai.PosX;
                  double posY = (double) quai.PosY;
                }
              }
            }
            catch (Exception ex)
            {
              GA.WriteUserLog(frmMain.langErrorLookforQuai2, this);
            }
            if (quaiIndividual == null)
            {
              flag1 = true;
              if (this.Myself.hetquaiStamp == 0L)
                this.Myself.hetquaiStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
            }
            else if (quaiIndividual.ID >= 0)
            {
              if (this.Settings.cboxDanhQuai)
                this.CallAttackTarget(quaiIndividual.ID, this.MySkills.AllSkills[0].ID, 0, 0);
              else
                this.CallMoveFlashPos((int) quaiIndividual.PosX, (int) quaiIndividual.PosY);
              this.Myself.hasQuai = true;
              this.Myself.QuaiDiedStamp = 0L;
              this.Myself.NoTargetStamp = 0L;
              this.Myself.hetquaiStamp = 0L;
            }
          }
          else
          {
            flag1 = true;
            if (this.Myself.hetquaiStamp == 0L)
              this.Myself.hetquaiStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
          }
        }
      }
    }
    if (this.Myself.InMapPathPoints.Count <= 0)
      return;
    try
    {
      if (this.Myself.EventString == "QRBP")
      {
        if (this.Myself.InPathPointIndex != 2)
          flag1 = true;
        this.Myself.actionFlag = 1;
      }
      else if (this.Myself.EventString == "QRBT")
      {
        if (this.Myself.InPathPointIndex != 1)
          flag1 = true;
        this.Myself.actionFlag = 2;
      }
      if (!flag1 || this.Myself.Status != AllEnums.CharStatuses.IDLE || this.Myself.PBEnding || this.Myself.InPathPointIndex < 0 || this.Myself.InPathPointIndex >= this.Myself.InMapPathPoints.Count)
        return;
      if (this.Myself.InPathPointIndex >= this.Myself.InMapPathPoints.Count - 1 && !this.Myself.IsTKC)
        this.Myself.PBxong1vong = true;
      if (this.Myself.IsTKC)
      {
        int inPathPointIndex = this.Myself.InPathPointIndex;
        if (this.Myself.EventString == "QRBT")
        {
          if (this.Myself.InPathPointIndex == 0 || this.Myself.InPathPointIndex == 2)
          {
            this.Myself.InPathPointIndex = 0;
            this.ResetEventString();
            this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
            this.Myself.hasQuai = false;
          }
          else
          {
            if (!this.Myself.hasQuai)
            {
              this.Myself.hetquaiStamp = 0L;
              this.Myself.MyLastStamp = 0L;
              this.Myself.NoTargetStamp = 0L;
              this.Myself.FoundQuaiStamp = 0L;
              return;
            }
            if (this.Myself.ActionStatus != (byte) 2)
            {
              this.Myself.InPathPointIndex = 4;
              this.ResetEventString();
              this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
              this.Myself.hasQuai = false;
            }
          }
        }
        else if (this.Myself.EventString == "QRBP")
        {
          if (this.Myself.InPathPointIndex == 0 || this.Myself.InPathPointIndex == 1)
          {
            this.Myself.InPathPointIndex = 1;
            this.ResetEventString();
            this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
            this.Myself.hasQuai = false;
          }
          else
          {
            if (!this.Myself.hasQuai)
            {
              this.Myself.hetquaiStamp = 0L;
              this.Myself.MyLastStamp = 0L;
              this.Myself.NoTargetStamp = 0L;
              this.Myself.FoundQuaiStamp = 0L;
              return;
            }
            if (this.Myself.ActionStatus != (byte) 2)
            {
              this.Myself.InPathPointIndex = 4;
              this.ResetEventString();
              this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
              this.Myself.hasQuai = false;
            }
          }
        }
        else if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.EventStamp >= 20000L && this.Myself.EventStamp != 0L)
        {
          if (this.Myself.InPathPointIndex == 0 && inPathPointIndex == 0)
          {
            this.Myself.InPathPointIndex = 2;
            this.Myself.EventStamp = 0L;
            this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
            this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Horse = 1;
            this.Myself.hasQuai = false;
          }
          else
          {
            this.Myself.InPathPointIndex = 4;
            this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
            this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Horse = 1;
            this.Myself.hasQuai = false;
          }
        }
        else if (this.Myself.PacketMsg == "KTTKC")
        {
          this.Myself.InPathPointIndex = 3;
          this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
          this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Horse = 1;
          this.Myself.hasQuai = false;
          this.Myself.PBEnding = true;
          Thread.Sleep(6000);
        }
        else
        {
          switch (inPathPointIndex)
          {
            case 0:
              this.Myself.InPathPointIndex = this.Myself.actionFlag != 1 ? (this.Myself.actionFlag != 2 ? 4 : 1) : 0;
              this.Myself.hasQuai = false;
              this.Myself.hetquaiStamp = 0L;
              this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
              break;
            case 1:
            case 2:
              if (!this.Myself.hasQuai && (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.hetquaiStamp < 30000L || this.Myself.hetquaiStamp == 0L))
              {
                this.Myself.hetquaiStamp = 0L;
                this.Myself.MyLastStamp = 0L;
                this.Myself.NoTargetStamp = 0L;
                this.Myself.FoundQuaiStamp = 0L;
                this.Myself.hasQuai = false;
                return;
              }
              this.Myself.InPathPointIndex = 4;
              this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
              this.Myself.hasQuai = false;
              this.Myself.hetquaiStamp = 0L;
              break;
          }
        }
      }
      else
      {
        this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
        this.Myself.hasQuai = false;
      }
      this.Myself.hasQuai = false;
      this.Myself.hetquaiStamp = 0L;
      this.Myself.MyLastStamp = 0L;
      this.Myself.NoTargetStamp = 0L;
      this.Myself.FoundQuaiStamp = 0L;
      if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Horse == 1)
      {
        long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        bool flag9 = false;
        this.Myself.actionCounter = 0;
        if (this.Myself.IsPartyFollowed != (byte) 1)
          ;
        while (this.IsAIEnabled)
        {
          if (this.Myself.HorseType == -1 && this.Myself.actionCounter == 0)
          {
            this.CallLenNgua();
            ++this.Myself.actionCounter;
          }
          if (this.Myself.HorseType != -1)
          {
            if (GA.CheckStatusParty(this))
              flag9 = this.ForcePartyFollow();
            if (!flag9)
            {
              GA.TrieuTapCaNhom(this);
              long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
              long elapsedMilliseconds3 = frmLogin.GlobalTimer.ElapsedMilliseconds;
              int num4 = 4000;
              if (this.Myself.PBEnding)
                num4 = 30000;
              while (this.IsAIEnabled)
              {
                bool flag10 = this.CheckMemberDistance(7.0);
                if (!flag10 && frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds3 <= 7000L)
                  elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                if (flag10 && GA.CheckStatusParty(this))
                  flag9 = this.ForcePartyFollow();
                Thread.Sleep(300);
                if (!flag9)
                {
                  if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 > (long) num4)
                  {
                    this.ForcePartyFollow();
                    flag9 = true;
                    break;
                  }
                }
                else
                  break;
              }
            }
          }
          if (this.Myself.HorseType != -1 && this.Myself.IsPartyFollowed == (byte) 1 && flag9)
            break;
          Thread.Sleep(300);
          if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 >= 2000L)
            break;
        }
      }
      else
      {
        if (this.Settings.cboxDanhQuai || this.Myself.HorseType == -1)
          return;
        bool flag11 = this.ForcePartyFollow();
        if (flag11)
          return;
        GA.TrieuTapCaNhom(this);
        long elapsedMilliseconds4 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        long elapsedMilliseconds5 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        while (this.IsAIEnabled)
        {
          bool flag12 = this.CheckMemberDistance(7.0);
          if (!flag12 && frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds5 <= 7000L)
            elapsedMilliseconds4 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          if (flag12)
            flag11 = this.ForcePartyFollow();
          Thread.Sleep(500);
          if (flag11 || frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds4 > 3000L)
            break;
        }
      }
    }
    catch (Exception ex)
    {
      GA.WriteUserLog(frmMain.langErrorProcessingPath1 + ex.Message + frmMain.langStackTrace + ex.StackTrace, this);
    }
  }

  public bool LureQuai()
  {
    bool flag = false;
    if (this.Myself.InMapPathPoints.Count > 0)
    {
      try
      {
        int posX1 = (int) this.Myself.PosX;
        int posY1 = (int) this.Myself.PosY;
        if (this.Myself.InPathPointIndex >= 0 && this.Myself.InPathPointIndex < this.Myself.InMapPathPoints.Count && !this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived)
        {
          int posX2 = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosX;
          int posY2 = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosY;
          double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) posX2, (double) posY2);
          if (distance > 2.5)
          {
            if (distance < 10.0)
              this.CallMoveFlashPos(posX2, posY2);
            else
              this.CallInMapMove(posX2, posY2, true);
          }
          else
          {
            this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived = true;
            this.Myself.Status = AllEnums.CharStatuses.IDLE;
          }
        }
        if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived)
        {
          ++this.Myself.InPathPointIndex;
          if (this.Myself.InPathPointIndex >= this.Myself.InMapPathPoints.Count)
          {
            for (int index = 0; index < this.Myself.InMapPathPoints.Count; ++index)
              this.Myself.InMapPathPoints[index].Arrived = false;
            this.Myself.InPathPointIndex = this.Myself.InMapPathPoints.Count - 1;
            flag = true;
          }
          this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived = false;
        }
      }
      catch (Exception ex)
      {
        GA.WriteUserLog(frmMain.langErrorGatheringMobs, this);
      }
    }
    return flag;
  }

  public void PhuBanDacBiet(int mapID = -1, int startIndex = 0)
  {
    bool flag1 = false;
    bool flag2 = false;
    int num1 = 0;
    int num2 = 1;
    double hpPercent = this.Myself.HPPercent;
    if (mapID != -1)
    {
      bool flag3 = false;
      if (this.Myself.InMapPathPoints.Count == 0)
      {
        flag3 = true;
      }
      else
      {
        int mapId = this.Myself.InMapPathPoints[0].MapID;
      }
      if (flag3)
      {
        foreach (KhoangDuocDBElement khoangDuocDbElement in frmLogin.GAuto.ATABDB)
        {
          if (khoangDuocDbElement.MapID == mapID)
          {
            this.Myself.InMapPathPoints.Add(new InMapPoint()
            {
              Arrived = false,
              Cleared = false,
              MapID = mapID,
              PosX = khoangDuocDbElement.PosX,
              PosY = khoangDuocDbElement.PosY,
              STT = khoangDuocDbElement.STT,
              Horse = khoangDuocDbElement.Horse
            });
            this.Myself.InPathPointIndex = startIndex;
          }
        }
        this.Myself.InMapPathPoints.Sort(new Comparison<InMapPoint>(this.PointComparison));
      }
    }
    if (mapID == -1)
      mapID = this.Myself.MapID;
    bool flag4 = false;
    if (!GA.IsInPhuBan(this.Myself.MapID, this))
    {
      int mapId1 = this.Myself.MapID;
    }
    if (this.Myself.EventString == "ATXQ" && this.Myself.PBxong1vong)
      flag1 = true;
    if (this.Myself.InMapPathPoints.Count > 0)
    {
      if (!flag1)
      {
        try
        {
          if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared)
          {
            ++this.Myself.InPathPointIndex;
            if (this.Myself.InPathPointIndex >= this.Myself.InMapPathPoints.Count)
            {
              for (int index = 0; index < this.Myself.InMapPathPoints.Count; ++index)
              {
                this.Myself.InMapPathPoints[index].Cleared = false;
                this.Myself.InMapPathPoints[index].Arrived = false;
              }
              this.Myself.InPathPointIndex = 0;
            }
            this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = false;
            this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived = false;
          }
          int posX1 = (int) this.Myself.PosX;
          int posY1 = (int) this.Myself.PosY;
          if (this.Myself.InPathPointIndex >= 0 && this.Myself.InPathPointIndex < this.Myself.InMapPathPoints.Count && !this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived)
          {
            int posX2 = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosX;
            int posY2 = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosY;
            double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) posX2, (double) posY2);
            if (distance > 2.5)
            {
              if (!this.Myself.PBxong1vong)
              {
                if (distance < 10.0)
                  this.CallMoveFlashPos(posX2, posY2);
                else
                  this.CallInMapMove(posX2, posY2, true);
              }
              else
              {
                int count = 0;
                this.SearchQuai(ref count, canAttack: true);
                if (count > 0)
                {
                  this.CallRemovePartyFollow();
                  this.AttackQuai();
                  return;
                }
                if (!this.Myself.HasTarget || (double) this.MyQuai.TargetHPPercent <= 0.0)
                {
                  if (distance < 10.0)
                  {
                    this.CallMoveFlashPos(posX2, posY2);
                  }
                  else
                  {
                    if (distance > 40.0)
                    {
                      this.CallLenNgua();
                      if (this.Myself.HorseType != -1 && this.Myself.IsPartyFollowed == (byte) 0)
                      {
                        bool flag5 = false;
                        if (GA.CheckStatusParty(this))
                          flag5 = this.ForcePartyFollow();
                        if (!flag5)
                        {
                          GA.TrieuTapCaNhom(this);
                          long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                          long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                          while (this.IsAIEnabled)
                          {
                            bool flag6 = this.CheckMemberDistance(7.0);
                            if (!flag6 && frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 <= 7000L)
                              elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                            if (flag6 && GA.CheckStatusParty(this))
                              flag5 = this.ForcePartyFollow();
                            Thread.Sleep(500);
                            if (flag5 || frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 > 3000L)
                              break;
                          }
                        }
                      }
                    }
                    this.CallInMapMove(posX2, posY2);
                  }
                }
              }
              this.Myself.hetquaiStamp = 0L;
            }
            else
            {
              flag4 = true;
              this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived = true;
              this.Myself.Status = AllEnums.CharStatuses.IDLE;
            }
          }
          if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived)
          {
            if (this.Myself.Status == AllEnums.CharStatuses.GOGOGO)
              this.Myself.Status = AllEnums.CharStatuses.IDLE;
            flag4 = true;
          }
        }
        catch (Exception ex)
        {
          GA.WriteUserLog(frmMain.langErrorRemovePath, this);
        }
      }
    }
    if (this.Myself.EventString == "ATXQ" || this.Myself.PBEnding || this.Myself.PBxong1vong || this.MyParty.PartyNumbers < 3)
      num2 = -1;
    if (this.Myself.InPathPointIndex == this.Myself.InMapPathPoints.Count - 1)
      num2 = -1;
    else if (this.Myself.InPathPointIndex < this.Myself.InMapPathPoints.Count && this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Horse == 0)
      num2 = -1;
    if (flag4)
    {
      if (num1 > num2)
      {
        this.FuncAnHPMP();
        this.FuncPetSupport();
        this.FuncNgaMySupport();
      }
      if (this.MyQuai.AllQuai.Count > 0)
      {
        QuaiIndividual quaiIndividual = (QuaiIndividual) null;
        try
        {
          double num3 = 50.0;
          for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
          {
            QuaiIndividual quai = this.MyQuai.AllQuai[index];
            bool flag7 = true;
            if (this.HasActivePet())
            {
              if (quai.ID != this.MyPet.AllPets[this.MyPet.ActivePetIndex].ID)
                flag7 = false;
            }
            else
              flag7 = false;
            if (quai.ID >= 0 && (double) quai.HPPercent > 0.0 && quai.ID != this.Myself.ID && !flag7 && this.CanAttack(quai))
            {
              ++num1;
              double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quai.PosX, (double) quai.PosY);
              if (distance < num3)
              {
                quaiIndividual = quai;
                num3 = distance;
                this.CallSelectTarget(quaiIndividual.ID);
              }
            }
          }
        }
        catch (Exception ex)
        {
          GA.WriteUserLog(frmMain.langErrorLookforQuai, this);
        }
        if (quaiIndividual != null && quaiIndividual.ID >= 0)
        {
          if (this.Myself.Menpai == AllEnums.Menpais.NGAMI && this.Myself.InMapPathPoints.Count == 15 && this.Myself.InPathPointIndex == 3)
          {
            this.Myself.InMapPathPoints.Clear();
            this.LoadPathPoint(1140);
          }
          if (this.MyParty.PartyNumbers > 0 && this.Myself.IsPartyFollowed == (byte) 1)
          {
            this.Myself.NoTargetStamp = 0L;
            this.Myself.hetquaiStamp = 0L;
            GA.ResetStatusParty(this);
            this.CallRemovePartyFollowSafe();
          }
          if (num1 > num2 && this.Myself.HorseType != -1 && !this.Myself.PBxong1vong && this.Settings.cboxDanhQuai)
            this.CallXuongNgua();
          if (this.Settings.cboxDanhQuai)
          {
            if (num1 <= num2)
            {
              if ((double) quaiIndividual.HPPercent == 100.0)
                this.CallAttackTarget(quaiIndividual.ID, this.MySkills.AllSkills[0].ID, 0, 0);
              else
                this.CallLenNgua();
            }
            else
              this.AttackQuai();
          }
          else if (!this.Myself.IsPHLM)
            this.CallMoveFlashPos((int) quaiIndividual.PosX, (int) quaiIndividual.PosY);
          this.Myself.QuaiDiedStamp = 0L;
          this.Myself.NoTargetStamp = 0L;
          this.Myself.hetquaiStamp = 0L;
          this.Myself.hasQuai = true;
        }
      }
      this.NhatBoc();
      if (this.Myself.Status == AllEnums.CharStatuses.IDLE)
      {
        if (!this.Myself.HasTarget)
        {
          if (this.Myself.NoTargetStamp == 0L)
            this.Myself.NoTargetStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
        }
        else
        {
          if ((double) this.MyQuai.TargetHPPercent <= 0.0)
          {
            if (this.Myself.QuaiDiedStamp == 0L)
              this.Myself.QuaiDiedStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
          }
          else
            this.Myself.QuaiDiedStamp = 0L;
          this.Myself.NoTargetStamp = 0L;
        }
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.NoTargetStamp >= 700L && this.Myself.NoTargetStamp != 0L || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.QuaiDiedStamp >= 700L && this.Myself.QuaiDiedStamp != 0L)
          flag2 = true;
        if (flag2)
        {
          if (this.MyQuai.AllQuai.Count > 0)
          {
            QuaiIndividual quaiIndividual = (QuaiIndividual) null;
            try
            {
              for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
              {
                QuaiIndividual quai = this.MyQuai.AllQuai[index];
                bool flag8 = true;
                if (this.HasActivePet())
                {
                  if (quai.ID != this.MyPet.AllPets[this.MyPet.ActivePetIndex].ID)
                    flag8 = false;
                }
                else
                  flag8 = false;
                if (quai.ID >= 0 && (double) quai.HPPercent > 0.0 && quai.ID != this.Myself.ID && !flag8 && this.CanAttack(quai))
                {
                  quaiIndividual = quai;
                  this.CallSelectTarget(quaiIndividual.ID);
                }
              }
            }
            catch (Exception ex)
            {
              GA.WriteUserLog(frmMain.langErrorLookforQuai2, this);
            }
            if (quaiIndividual == null)
            {
              flag1 = true;
              if (this.Myself.hetquaiStamp == 0L)
                this.Myself.hetquaiStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
            }
            else if (quaiIndividual.ID >= 0)
            {
              if (this.Settings.cboxDanhQuai)
                this.CallAttackTarget(quaiIndividual.ID, this.MySkills.AllSkills[0].ID, 0, 0);
              else
                this.CallMoveFlashPos((int) quaiIndividual.PosX, (int) quaiIndividual.PosY);
              this.Myself.QuaiDiedStamp = 0L;
              this.Myself.NoTargetStamp = 0L;
              this.Myself.hetquaiStamp = 0L;
              this.Myself.hasQuai = true;
            }
          }
          else
          {
            flag1 = true;
            if (this.Myself.hetquaiStamp == 0L)
              this.Myself.hetquaiStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
          }
        }
      }
    }
    if (this.Myself.InMapPathPoints.Count <= 0)
      return;
    try
    {
      bool flag9 = false;
      if (this.Myself.EventString == "PBKT10")
      {
        GA.PartyDoSomething(this, mode: 10);
        if (this.Myself.HorseType == -1)
          this.CallLenNgua();
        else
          Thread.Sleep(5000);
        GA.TrieuTapCaNhom(this);
        Thread.Sleep(2000);
        this.CallRequestPartyFollow();
        long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
        while (this.IsAIEnabled)
        {
          if (!GA.IsInPhuBan(this.Myself.MapID, this))
          {
            Thread.Sleep(1000);
            break;
          }
          if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds <= 20000L)
            Thread.Sleep(500);
          else
            break;
        }
        this.ResetEventString();
      }
      else if (this.Myself.EventString == "PBKT5")
      {
        GA.TrieuTapCaNhom(this);
        Thread.Sleep(2000);
        this.CallRequestPartyFollow();
        this.ResetEventString();
        Thread.Sleep(8000);
      }
      else
      {
        if (flag1 && this.Myself.Status == AllEnums.CharStatuses.IDLE && !flag9 && !this.Myself.PBxong1vong)
        {
          int posX3 = (int) this.Myself.PosX;
          int posY3 = (int) this.Myself.PosY;
          int posX4 = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosX;
          int posY4 = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosY;
          double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) posX4, (double) posY4);
          if (distance > 2.0)
          {
            if (distance < 10.0)
              this.CallMoveFlashPos(posX4, posY4);
            else
              this.CallInMapMove(posX4, posY4, true);
            this.Myself.NoTargetStamp = 0L;
            this.Myself.hetquaiStamp = 0L;
          }
          else if (this.Myself.Status == AllEnums.CharStatuses.GOGOGO)
            this.Myself.Status = AllEnums.CharStatuses.IDLE;
        }
        if (!flag1 || this.Myself.Status != AllEnums.CharStatuses.IDLE || this.Myself.PBEnding || this.Myself.InPathPointIndex < 0 || this.Myself.InPathPointIndex >= this.Myself.InMapPathPoints.Count)
          return;
        if (this.Myself.EventString == "ATXQ")
        {
          if (this.Target.VersionNum == 3)
            GA.PartyDoSomething(this, true, 2);
          this.ResetEventString();
          this.Myself.PBEnding = true;
          this.Myself.InPathPointIndex = this.Myself.InMapPathPoints.Count - 1;
          if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosX, (double) this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosY) >= 35.0)
            this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Horse = 1;
          this.Myself.InPathPointIndex = this.Myself.InMapPathPoints.Count - 2;
        }
        if (this.Myself.InPathPointIndex >= this.Myself.InMapPathPoints.Count - 1 && !this.Myself.IsTKC)
          this.Myself.PBxong1vong = true;
        this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
        this.Myself.hasQuai = false;
        this.Myself.NoTargetStamp = 0L;
        this.Myself.hetquaiStamp = 0L;
        if (this.Myself.EventString == "ATKT")
        {
          this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = false;
          if (this.Myself.HorseType != -1)
            return;
          this.CallLenNgua();
        }
        else if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Horse == 1)
        {
          long elapsedMilliseconds3 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          bool flag10 = false;
          this.Myself.actionCounter = 0;
          if (this.Myself.IsPartyFollowed == (byte) 1)
          {
            if (!this.CheckMemberDistance(30.0, true))
              ++this.MyFlag.removePTFollowCounter;
            if (this.MyFlag.removePTFollowCounter >= 5)
            {
              this.MyFlag.removePTFollowCounter = 0;
              this.CallRemovePartyFollow();
            }
          }
          while (this.IsAIEnabled)
          {
            if (this.Myself.HorseType == -1 && this.Myself.actionCounter == 0)
            {
              this.CallLenNgua();
              ++this.Myself.actionCounter;
            }
            if (this.Myself.HorseType != -1)
            {
              if (GA.CheckStatusParty(this))
                flag10 = this.ForcePartyFollow();
              if (!flag10)
              {
                GA.TrieuTapCaNhom(this);
                long elapsedMilliseconds4 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                long elapsedMilliseconds5 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                while (this.IsAIEnabled)
                {
                  bool flag11 = this.CheckMemberDistance(7.0);
                  if (!flag11 && frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds5 <= 7000L)
                    elapsedMilliseconds4 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                  if (flag11 && GA.CheckStatusParty(this))
                    flag10 = this.ForcePartyFollow();
                  Thread.Sleep(500);
                  if (!flag10)
                  {
                    if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds4 > 3000L)
                    {
                      flag10 = true;
                      break;
                    }
                  }
                  else
                    break;
                }
              }
            }
            if (this.Myself.HorseType != -1 && this.Myself.IsPartyFollowed == (byte) 1 && flag10)
              break;
            Thread.Sleep(300);
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds3 >= 5000L)
              break;
          }
        }
        else
        {
          if (this.Settings.cboxDanhQuai && this.Myself.HorseType == -1 && !frmLogin.GAuto.Settings.optPhuBanKeoDoi && this.MyParty.NotInAutoCount <= 0)
            return;
          if (this.Myself.HorseType == -1 && !this.Settings.cboxDanhQuai)
            this.CallLenNgua();
          bool flag12 = this.ForcePartyFollow();
          if (flag12)
            return;
          GA.TrieuTapCaNhom(this);
          long elapsedMilliseconds6 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          long elapsedMilliseconds7 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          while (this.IsAIEnabled)
          {
            bool flag13 = this.CheckMemberDistance(7.0);
            if (!flag13 && frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds7 <= 7000L)
              elapsedMilliseconds6 = frmLogin.GlobalTimer.ElapsedMilliseconds;
            if (flag13)
              flag12 = this.ForcePartyFollow();
            Thread.Sleep(500);
            if (flag12 || frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds6 > 3000L)
              break;
          }
        }
      }
    }
    catch (Exception ex)
    {
      GA.WriteUserLog(frmMain.langErrorProcessingPath1 + ex.Message + frmMain.langStackTrace + ex.StackTrace, this);
    }
  }

  public void DanhQuaiPhuBan(int mapID = -1, bool pickBoc = false)
  {
    bool flag1 = false;
    bool flag2 = false;
    int NPCID = 0;
    int num1 = 0;
    int num2 = 0;
    double hpPercent = this.Myself.HPPercent;
    if (mapID == -1)
      mapID = this.Myself.MapID;
    bool flag3 = false;
    if (this.Myself.MapID == mapID)
    {
      if (this.Myself.InMapPathPoints.Count > 0)
      {
        try
        {
          if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared)
          {
            ++this.Myself.InPathPointIndex;
            if (this.Myself.InPathPointIndex >= this.Myself.InMapPathPoints.Count)
            {
              for (int index = 0; index < this.Myself.InMapPathPoints.Count; ++index)
              {
                this.Myself.InMapPathPoints[index].Cleared = false;
                this.Myself.InMapPathPoints[index].Arrived = false;
              }
              this.Myself.MyLastStamp = 0L;
              this.Myself.InPathPointIndex = 0;
            }
            this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = false;
            this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived = false;
          }
          int posX1 = (int) this.Myself.PosX;
          int posY1 = (int) this.Myself.PosY;
          if (this.Myself.InPathPointIndex >= 0 && this.Myself.InPathPointIndex < this.Myself.InMapPathPoints.Count && !this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived)
          {
            int posX2 = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosX;
            int posY2 = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosY;
            double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) posX2, (double) posY2);
            if (distance > 2.5)
            {
              if (!this.Myself.PBxong1vong)
              {
                if (distance < 10.0)
                  this.CallMoveFlashPos(posX2, posY2);
                else
                  this.CallInMapMove(posX2, posY2, true);
              }
              else
              {
                int count = 0;
                this.SearchQuai(ref count, canAttack: true);
                if (count > 0)
                {
                  this.CallRemovePartyFollow();
                  this.AttackQuai();
                  return;
                }
                if (!this.Myself.HasTarget || (double) this.MyQuai.TargetHPPercent <= 0.0)
                {
                  if (distance < 10.0)
                    this.CallMoveFlashPos(posX2, posY2);
                  else
                    this.CallInMapMove(posX2, posY2);
                }
              }
              this.Myself.MyLastStamp = 0L;
              this.Myself.hetquaiStamp = 0L;
            }
            else
            {
              flag3 = true;
              this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived = true;
              this.Myself.MyLastStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
              this.Myself.Status = AllEnums.CharStatuses.IDLE;
            }
          }
          if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived)
          {
            if (this.Myself.Status == AllEnums.CharStatuses.GOGOGO)
              this.Myself.Status = AllEnums.CharStatuses.IDLE;
            flag3 = true;
          }
        }
        catch (Exception ex)
        {
          GA.WriteUserLog(frmMain.langErrorRemovePath, this);
        }
      }
    }
    if (flag3)
    {
      this.FuncAnHPMP();
      this.FuncPetSupport();
      this.FuncNgaMySupport();
      if (this.MyQuai.AllQuai.Count > 0)
      {
        QuaiIndividual quaiIndividual = (QuaiIndividual) null;
        try
        {
          double num3 = 50.0;
          for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
          {
            QuaiIndividual quai = this.MyQuai.AllQuai[index];
            bool flag4 = true;
            if (this.HasActivePet())
            {
              if (quai.ID != this.MyPet.AllPets[this.MyPet.ActivePetIndex].ID)
                flag4 = false;
            }
            else
              flag4 = false;
            if (quai.ID >= 0 && (double) quai.HPPercent > 0.0 && quai.ID != this.Myself.ID && !flag4 && this.CanAttack(quai))
            {
              double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quai.PosX, (double) quai.PosY);
              if (distance < num3)
              {
                quaiIndividual = quai;
                num3 = distance;
                this.CallSelectTarget(quaiIndividual.ID);
              }
            }
          }
        }
        catch (Exception ex)
        {
          GA.WriteUserLog(frmMain.langErrorLookforQuai, this);
        }
        if (quaiIndividual != null)
        {
          if (this.MyParty.PartyNumbers > 0)
          {
            if (this.Myself.IsPartyFollowed == (byte) 1)
            {
              this.Myself.NoTargetStamp = 0L;
              this.Myself.MyLastStamp = 0L;
              this.Myself.hetquaiStamp = 0L;
              GA.ResetStatusParty(this);
              this.CallRemovePartyFollow();
            }
            if (this.Myself.HorseType != -1 && !this.Myself.PBxong1vong && this.Settings.cboxDanhQuai)
              this.CallXuongNgua();
          }
          if (this.Settings.cboxDanhQuai)
            this.AttackQuai();
          else
            this.CallMoveFlashPos((int) quaiIndividual.PosX, (int) quaiIndividual.PosY);
          this.Myself.QuaiDiedStamp = 0L;
          this.Myself.NoTargetStamp = 0L;
          this.Myself.hetquaiStamp = 0L;
          this.Myself.hasQuai = true;
        }
      }
      this.NhatBoc();
      if (this.Myself.Status == AllEnums.CharStatuses.IDLE)
      {
        if (!this.Myself.HasTarget)
        {
          if (this.Myself.NoTargetStamp == 0L)
            this.Myself.NoTargetStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
        }
        else
        {
          if ((double) this.MyQuai.TargetHPPercent <= 0.0)
          {
            if (this.Myself.QuaiDiedStamp == 0L)
              this.Myself.QuaiDiedStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
          }
          else
            this.Myself.QuaiDiedStamp = 0L;
          this.Myself.NoTargetStamp = 0L;
        }
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.NoTargetStamp >= 700L && this.Myself.NoTargetStamp != 0L || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.QuaiDiedStamp >= 700L && this.Myself.QuaiDiedStamp != 0L)
          flag2 = true;
        if (flag2)
        {
          if (this.MyQuai.AllQuai.Count > 0)
          {
            QuaiIndividual quaiIndividual = (QuaiIndividual) null;
            try
            {
              for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
              {
                QuaiIndividual quai = this.MyQuai.AllQuai[index];
                bool flag5 = true;
                if (this.HasActivePet())
                {
                  if (quai.ID != this.MyPet.AllPets[this.MyPet.ActivePetIndex].ID)
                    flag5 = false;
                }
                else
                  flag5 = false;
                if (quai.ID >= 0 && (double) quai.HPPercent > 0.0 && quai.ID != this.Myself.ID && !flag5 && this.CanAttack(quai))
                {
                  quaiIndividual = quai;
                  this.CallSelectTarget(quaiIndividual.ID);
                }
                if (quai.Name.Contains("Phật Đăng") || quai.Name.Contains("uddhist Lam"))
                {
                  NPCID = quai.ID;
                  num1 = (int) quai.PosX;
                  num2 = (int) quai.PosY;
                }
              }
            }
            catch (Exception ex)
            {
              GA.WriteUserLog(frmMain.langErrorLookforQuai2, this);
            }
            if (quaiIndividual == null)
            {
              flag1 = true;
              if (this.Myself.hetquaiStamp == 0L)
                this.Myself.hetquaiStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
            }
            else if (quaiIndividual.ID >= 0)
            {
              if (this.Settings.cboxDanhQuai)
                this.CallAttackTarget(quaiIndividual.ID, this.MySkills.AllSkills[0].ID, 0, 0);
              else
                this.CallMoveFlashPos((int) quaiIndividual.PosX, (int) quaiIndividual.PosY);
              this.Myself.QuaiDiedStamp = 0L;
              this.Myself.NoTargetStamp = 0L;
              this.Myself.hetquaiStamp = 0L;
              this.Myself.hasQuai = true;
            }
          }
          else
          {
            flag1 = true;
            if (this.Myself.hetquaiStamp == 0L)
              this.Myself.hetquaiStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
          }
        }
      }
    }
    if (this.Myself.InMapPathPoints.Count <= 0)
      return;
    try
    {
      if (flag1 && this.Myself.Status == AllEnums.CharStatuses.IDLE)
      {
        int posX3 = (int) this.Myself.PosX;
        int posY3 = (int) this.Myself.PosY;
        int posX4 = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosX;
        int posY4 = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosY;
        double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) posX4, (double) posY4);
        if (distance > 2.0)
        {
          if (distance < 10.0)
            this.CallMoveFlashPos(posX4, posY4);
          else
            this.CallInMapMove(posX4, posY4, true);
          this.Myself.MyLastStamp = 0L;
          this.Myself.NoTargetStamp = 0L;
          this.Myself.hetquaiStamp = 0L;
        }
        else if (this.Myself.Status == AllEnums.CharStatuses.GOGOGO)
          this.Myself.Status = AllEnums.CharStatuses.IDLE;
      }
      if (!flag1 || this.Myself.Status != AllEnums.CharStatuses.IDLE || this.Myself.PBEnding || this.Myself.InPathPointIndex < 0 || this.Myself.InPathPointIndex >= this.Myself.InMapPathPoints.Count)
        return;
      if (this.Myself.EventString == "ATXQ")
      {
        this.ResetEventString();
        this.Myself.PBEnding = true;
        this.Myself.InPathPointIndex = this.Myself.InMapPathPoints.Count - 1;
        if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosX, (double) this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosY) >= 35.0)
          this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Horse = 1;
        this.Myself.InPathPointIndex = this.Myself.InMapPathPoints.Count - 2;
      }
      if (this.Myself.InPathPointIndex >= this.Myself.InMapPathPoints.Count - 1 && !this.Myself.IsTKC)
        this.Myself.PBxong1vong = true;
      if (this.Myself.IsTKC)
      {
        int inPathPointIndex = this.Myself.InPathPointIndex;
        if (this.Myself.EventString == "QRBT")
        {
          if (this.Myself.InPathPointIndex == 0)
          {
            this.Myself.InPathPointIndex = 0;
            this.ResetEventString();
            this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
            this.Myself.hasQuai = false;
          }
          else
          {
            this.Myself.InPathPointIndex = 4;
            this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
          }
        }
        else if (this.Myself.EventString == "QRBP")
        {
          if (this.Myself.InPathPointIndex == 0)
          {
            this.Myself.InPathPointIndex = 1;
            this.ResetEventString();
            this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
            this.Myself.hasQuai = false;
          }
          else
          {
            this.Myself.InPathPointIndex = 4;
            this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
          }
        }
        else
        {
          switch (inPathPointIndex)
          {
            case 0:
              if (this.Target.VersionNum != 3)
              {
                while (NPCID >= 0 && num1 > 0 && num2 > 0)
                {
                  if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num1, (double) num2) > 2.0)
                  {
                    this.CallMoveFlashPos(num1, num2);
                  }
                  else
                  {
                    this.CallTalkNPC(0, 0, NPCID);
                    Thread.Sleep(500);
                    this.CallTalkNPC(402109, 1, NPCID);
                    NPCID = 0;
                    num1 = 0;
                    num2 = 0;
                  }
                  Thread.Sleep(300);
                }
              }
              this.Myself.InPathPointIndex = 4;
              this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
              break;
            case 1:
            case 2:
              if (this.Myself.hasQuai || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.hetquaiStamp >= 10000L && this.Myself.hetquaiStamp != 0L)
              {
                this.Myself.InPathPointIndex = 4;
                this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
                this.Myself.hasQuai = false;
                this.Myself.hetquaiStamp = 0L;
                break;
              }
              break;
          }
        }
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.EventStamp >= 30000L && this.Myself.EventStamp != 0L && this.Myself.InPathPointIndex == 4 && inPathPointIndex == 0)
        {
          this.Myself.InPathPointIndex = 2;
          this.Myself.EventStamp = 0L;
          this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
          this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Horse = 1;
          this.Myself.hasQuai = false;
        }
        if (this.Myself.PacketMsg == "KTTKC")
        {
          this.Myself.InPathPointIndex = 3;
          this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
          this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Horse = 1;
          this.Myself.hasQuai = false;
          Thread.Sleep(6000);
        }
      }
      else
      {
        this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
        this.Myself.hasQuai = false;
      }
      this.Myself.MyLastStamp = 0L;
      this.Myself.NoTargetStamp = 0L;
      if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Horse == 1)
      {
        long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        bool flag6 = false;
        this.Myself.actionCounter = 0;
        if (this.Myself.IsPartyFollowed == (byte) 1)
          this.CallRemovePartyFollow();
        while (this.IsAIEnabled)
        {
          if (this.Myself.HorseType == -1 && this.Myself.actionCounter == 0)
          {
            this.CallLenNgua();
            ++this.Myself.actionCounter;
          }
          if (this.Myself.HorseType != -1)
          {
            if (GA.CheckStatusParty(this))
              flag6 = this.ForcePartyFollow();
            if (!flag6)
            {
              GA.TrieuTapCaNhom(this);
              long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
              long elapsedMilliseconds3 = frmLogin.GlobalTimer.ElapsedMilliseconds;
              while (this.IsAIEnabled)
              {
                bool flag7 = this.CheckMemberDistance(7.0);
                if (!flag7 && frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds3 <= 7000L)
                  elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                if (flag7 && GA.CheckStatusParty(this))
                  flag6 = this.ForcePartyFollow();
                Thread.Sleep(500);
                if (!flag6)
                {
                  if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 > 3000L)
                  {
                    flag6 = true;
                    break;
                  }
                }
                else
                  break;
              }
            }
          }
          if (this.Myself.HorseType != -1 && this.Myself.IsPartyFollowed == (byte) 1 && flag6)
            break;
          Thread.Sleep(300);
          if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 >= 5000L)
            break;
        }
      }
      else
      {
        if (this.Settings.cboxDanhQuai || this.Myself.HorseType == -1)
          return;
        bool flag8 = this.ForcePartyFollow();
        if (flag8)
          return;
        GA.TrieuTapCaNhom(this);
        long elapsedMilliseconds4 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        long elapsedMilliseconds5 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        while (this.IsAIEnabled)
        {
          bool flag9 = this.CheckMemberDistance(7.0);
          if (!flag9 && frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds5 <= 7000L)
            elapsedMilliseconds4 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          if (flag9)
            flag8 = this.ForcePartyFollow();
          Thread.Sleep(500);
          if (flag8 || frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds4 > 3000L)
            break;
        }
      }
    }
    catch (Exception ex)
    {
      GA.WriteUserLog(frmMain.langErrorProcessingPath1 + ex.Message + frmMain.langStackTrace + ex.StackTrace, this);
    }
  }

  public void PhuBanYTO(int mapID = -1)
  {
    if (this.Myself.InMapPathPoints.Count <= 0)
      return;
    bool flag1 = false;
    try
    {
      if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared)
      {
        bool flag2 = false;
        while (!flag2)
        {
          this.NhatBoc();
          if (GA.CheckStatusParty(this))
            flag2 = true;
          if (this.Myself.Status == AllEnums.CharStatuses.NHATBOC)
            flag2 = false;
          if (!flag2)
          {
            if (this.MyFlag.checkNhatBocStamp < frmLogin.GlobalTimer.ElapsedMilliseconds)
              this.MyFlag.checkNhatBocStamp = frmLogin.GlobalTimer.ElapsedMilliseconds + 20000L;
            long num = this.MyFlag.checkNhatBocStamp - frmLogin.GlobalTimer.ElapsedMilliseconds;
            if (0L < num && num < 10000L)
              flag2 = true;
          }
          Thread.Sleep(200);
        }
        if (flag2)
        {
          this.MyFlag.checkNhatBocStamp = 0L;
          if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Horse == 1)
          {
            long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
            bool flag3 = false;
            this.Myself.actionCounter = 0;
            if (this.Myself.IsPartyFollowed == (byte) 1 && this.Myself.HorseType == -1)
              this.CallRemovePartyFollow();
            while (this.IsAIEnabled)
            {
              if (this.Myself.HorseType == -1 && this.Myself.actionCounter == 0)
              {
                this.CallLenNgua();
                ++this.Myself.actionCounter;
              }
              if (this.Myself.HorseType != -1)
              {
                if (GA.CheckStatusParty(this))
                  flag3 = this.ForcePartyFollow();
                if (!flag3)
                {
                  GA.TrieuTapCaNhom(this);
                  long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                  long elapsedMilliseconds3 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                  while (this.IsAIEnabled)
                  {
                    bool flag4 = this.CheckMemberDistance(7.0);
                    if (!flag4 && frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds3 <= 7000L)
                      elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                    if (flag4 && GA.CheckStatusParty(this))
                      flag3 = this.ForcePartyFollow();
                    Thread.Sleep(500);
                    if (!flag3)
                    {
                      if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 > 3000L)
                      {
                        flag3 = true;
                        break;
                      }
                    }
                    else
                      break;
                  }
                }
              }
              if (this.Myself.HorseType == -1 || this.Myself.IsPartyFollowed != (byte) 1 || !flag3)
              {
                Thread.Sleep(300);
                if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 >= 5000L)
                  break;
              }
              else
                break;
            }
          }
          ++this.Myself.InPathPointIndex;
          if (this.Myself.InPathPointIndex >= this.Myself.InMapPathPoints.Count)
          {
            for (int index = 0; index < this.Myself.InMapPathPoints.Count; ++index)
            {
              this.Myself.InMapPathPoints[index].Cleared = false;
              this.Myself.InMapPathPoints[index].Arrived = false;
            }
            this.Myself.InPathPointIndex = 0;
          }
          this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = false;
          this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived = false;
        }
      }
      int posX1 = (int) this.Myself.PosX;
      int posY1 = (int) this.Myself.PosY;
      if (this.Myself.InPathPointIndex >= 0 && this.Myself.InPathPointIndex < this.Myself.InMapPathPoints.Count && !this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived)
      {
        int posX2 = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosX;
        int posY2 = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosY;
        double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) posX2, (double) posY2);
        if (distance > 2.5)
        {
          if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].khinhcong == 0)
          {
            if (this.Myself.isYTO && GA.CheckGameVersion(this.Target.VersionNum) != 356)
              GA.TrieuTapToMyPos(this, posX2, posY2, this.Myself.MapID, false);
            else
              GA.TrieuTapToMyPos(this, posX2, posY2, this.Myself.MapID);
            if (distance < 10.0)
              this.CallMoveFlashPos(posX2, posY2);
            else
              this.CallInMapMove(posX2, posY2, true);
          }
          else
          {
            if (this.CheckMemberDistance(1.1, true))
            {
              if (!this.MyFlag.nearMe)
              {
                this.CallRequestPartyFollow();
                Thread.Sleep(1000);
                this.MyFlag.nearMe = true;
              }
              this.CallRemovePartyFollowSafe();
              if (!this.MyFlag.nearMe)
                Thread.Sleep(1000);
              GA.PartyDoSomething(this, mode: 15);
            }
            if (this.MyFlag.nearMe)
            {
              if (this.Myself.ActionStatus != (byte) 3)
              {
                GA.PartyDoSomething(this, mode: 14);
                GA.PartyDoSomething(this, mode: 5, param1: posX2, param2: posY2);
                this.CallXuongNgua();
                if (this.CheckMemberRangeMin() >= 6.0)
                {
                  if (this.MySkills.KhinhCongID == 0)
                  {
                    this.CallKhinhCongPacket(posX2, posY2);
                    Thread.Sleep(1000);
                  }
                  else
                    this.CallKhinhCongPacket(posX2, posY2, this.MySkills.KhinhCongID);
                  if (this.Myself.EventString == "KNVH")
                  {
                    int khinhCongId = this.GetKhinhCongID();
                    this.CallKhinhCongPacket(posX2, posY2, khinhCongId);
                    this.MySkills.KhinhCongID = khinhCongId;
                  }
                }
              }
              if (this.Myself.ActionStatus == (byte) 3)
              {
                if (this.MySkills.KhinhCongID == 0)
                  this.MySkills.KhinhCongID = 34;
                this.ResetEventString();
                this.MyFlag.nearMe = false;
              }
            }
            else if (this.Myself.InPathPointIndex > 0)
            {
              int posX3 = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex - 1].PosX;
              int posY3 = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex - 1].PosY;
              GA.TrieuTapToMyPos(this, posX3, posY3, this.Myself.MapID, false);
              this.CallMoveTo(posX3, posY3);
            }
          }
        }
        else
          flag1 = true;
      }
      if (flag1)
      {
        this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived = true;
        if (this.Myself.Status == AllEnums.CharStatuses.GOGOGO)
          this.Myself.Status = AllEnums.CharStatuses.IDLE;
      }
    }
    catch (Exception ex)
    {
      GA.WriteUserLog(frmMain.langErrorRemovePath, this);
    }
    if (!this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived)
      return;
    if (this.Myself.isYTO)
    {
      if (this.CheckMemberDistance(2.0))
      {
        this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
      }
      else
      {
        int posX = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosX;
        int posY = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosY;
        this.CallMoveTo(posX, posY);
        GA.TrieuTapToMyPos(this, posX, posY, this.Myself.MapID, false);
      }
    }
    else if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].DanhQuai == 0)
    {
      this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
    }
    else
    {
      QuaiIndividual quaiIndividual = (QuaiIndividual) null;
      if (this.MyQuai.AllQuai.Count > 0)
      {
        try
        {
          for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
          {
            QuaiIndividual quai = this.MyQuai.AllQuai[index];
            bool flag5 = true;
            if (this.HasActivePet())
            {
              if (quai.ID != this.MyPet.AllPets[this.MyPet.ActivePetIndex].ID)
                flag5 = false;
            }
            else
              flag5 = false;
            if (quai.ID >= 0 && (double) quai.HPPercent > 0.0 && quai.ID != this.Myself.ID && !flag5 && this.CanAttack(quai))
            {
              quaiIndividual = quai;
              this.CallSelectTarget(quaiIndividual.ID);
            }
          }
        }
        catch (Exception ex)
        {
          GA.WriteUserLog(frmMain.langErrorLookforQuai2, this);
        }
      }
      if (quaiIndividual == null)
      {
        this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
      }
      else
      {
        if (this.Myself.IsPartyFollowed == (byte) 1)
          this.CallRemovePartyFollow();
        if (!this.Settings.cboxDanhQuai)
          return;
        this.CallXuongNgua();
        this.AttackQuai();
      }
    }
  }

  private bool ForceHoiMau(bool healMP = false)
  {
    if (this.Myself.HPPercent >= 70.0 && (!healMP || this.Myself.MPPercent >= 70.0) || !this.IsInCity())
      return true;
    if (this.Myself.HPPercent > 0.0 && this.IsInCity())
    {
      bool flag = false;
      int num1 = 185;
      if (this.Target.VersionNum == 3)
        num1 = 191;
      int num2 = 336;
      int NPCID = 185;
      int menuTypeID = 129;
      int menuIndex = 1001;
      if (GA.ClientVersion(this) == 10)
      {
        num1 = 100;
        num2 = 170;
        if (this.Myself.MapID == 0)
          flag = true;
        else
          this.CallOutMapMove(num1, num2, 0);
      }
      else if (this.Target.VersionNum == 3 && this.Target.SubVersion == 10)
      {
        NPCID = 28;
        if (this.Myself.MapID == 0)
          flag = true;
        else
          this.CallOutMapMove(num1, num2, 0);
      }
      else if (this.Target.VersionNum == 3 && this.Target.SubVersion == 30)
      {
        NPCID = 162;
        if (this.Myself.MapID == 0)
          flag = true;
        else
          this.CallOutMapMove(num1, num2, 0);
      }
      else if (this.Myself.MapID == 0)
        flag = true;
      else if (this.Myself.MapID == 480)
      {
        flag = true;
        NPCID = 11;
        num1 = 123;
        num2 = 172;
        menuTypeID = 889629;
      }
      else if (this.Myself.MapID == 186)
      {
        flag = true;
        NPCID = 22;
        num1 = 293;
        num2 = 143;
        menuTypeID = 64 /*0x40*/;
      }
      else if (this.Myself.MapID == 1)
      {
        flag = true;
        num1 = 163;
        num2 = 259;
        NPCID = 113;
        menuTypeID = 64 /*0x40*/;
        if (this.Target.VersionNum == 3)
          NPCID = 85;
      }
      else if (this.Myself.MapID == 2)
      {
        flag = true;
        NPCID = 117;
        num1 = 292;
        num2 = 148;
        menuTypeID = 64 /*0x40*/;
      }
      else
        this.CallOutMapMove(num1, num2, 0);
      if (flag)
      {
        double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num1, (double) num2);
        if (distance > 2.5)
        {
          if (distance > 35.0)
            this.CallLenNgua();
          this.CallInMapMove(num1, num2);
        }
        else
        {
          Thread.Sleep(1000);
          this.CallTalkNPC(0, 0, NPCID);
          Thread.Sleep(700);
          this.CallTalkNPC(menuTypeID, 0, NPCID);
          Thread.Sleep(700);
          this.CallTalkNPC(menuTypeID, menuIndex, NPCID);
          long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          while (this.IsAIEnabled && this.Myself.HPPercent < 100.0)
          {
            Thread.Sleep(200);
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 >= 3000L)
            {
              this.CallTalkNPC(0, 0, NPCID);
              Thread.Sleep(700);
              this.CallTalkNPC(menuTypeID, 0, NPCID);
              Thread.Sleep(700);
              this.CallTalkNPC(menuTypeID, menuIndex, NPCID);
              elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
            }
            if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num1, (double) num2) > 2.0)
              this.CallInMapMove(num1, num2);
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 >= 20000L)
              break;
          }
        }
      }
    }
    return false;
  }

  public int SearchDVP(int needMapID = -1)
  {
    int num = -1;
    for (int index = 0; index < 30; ++index)
    {
      InventoryItem allItem = this.MyInventory.AllItems[index];
      if (needMapID == 1001)
      {
        if (allItem.ItemID == 30501001 || allItem.ItemID == 30501002)
          return index;
        if (allItem.ItemID >= 30501017 && allItem.ItemID <= 30501042 && allItem.ItemID != 30501035 && allItem.ItemID != 30501036 && allItem.DinhViPhuTime > (byte) 0 && num == -1)
          num = index;
      }
      else if (allItem.ItemID >= 30501017 && allItem.ItemID <= 30501042 && allItem.ItemID != 30501035 && allItem.ItemID != 30501036 && needMapID != this.Myself.MapID)
      {
        if (allItem.ItemMapID == needMapID || needMapID == -1)
        {
          if (allItem.ItemMapID != 0 || allItem.DinhViPhuTime > (byte) 0)
            return index;
        }
        else if (index == 0)
          num = index;
      }
    }
    if (num == -1)
    {
      if (this.MyFlag.DinhViPhuWarningCounter < 3)
      {
        if (this.Target.VersionNum == 3 && this.isInDiaPhu())
          GA.ShowBalloon(frmMain.langCanWarpSpell, frmMain.langCannotFindWarpingSpell, this, 20000);
        else
          GA.ShowBalloon(frmMain.langCannotFindWarpingSpell2, frmMain.langCannotFindWarpingSpell, this, 20000);
      }
      ++this.MyFlag.DinhViPhuWarningCounter;
    }
    return num;
  }

  public void RunningTrade()
  {
    if (this.Settings.AIMode != AllEnums.AIModes.THUONGNHAN)
      return;
    bool flag1 = false;
    bool flag2 = false;
    if (this.Settings.tboxIDBang == -1 || this.Settings.tBoxIDFriend == -1)
    {
      GA.ShowBalloon(frmMain.langTN_inputID, "Notice", this, 10000);
      this.Settings.AIMode = AllEnums.AIModes.DANHTUDO;
    }
    else
    {
      if (this.Settings.tboxIDBang != -1 && this.Settings.tBoxIDFriend != -1)
        flag1 = true;
      if (this.Myself.HPPercent > 0.0)
        flag2 = true;
      InventoryItem inventoryItem = (InventoryItem) null;
      int index1 = 60;
      if (!flag1 || !flag2)
        return;
      bool flag3 = false;
      for (int index2 = 60; index2 < 90; ++index2)
      {
        InventoryItem allItem = this.MyInventory.AllItems[index2];
        if (allItem.ItemID == 40002000)
        {
          flag3 = true;
          inventoryItem = allItem;
          index1 = index2;
          break;
        }
      }
      if (!flag3 && !this.Settings.cboxTNRunOnly && this.Myself.CheckPhieuStamp.ElapsedMilliseconds >= 3000L)
      {
        bool flag4 = this.NotTransitioning();
        if (this.Myself.MapID != this.Settings.tboxIDBang && flag4)
        {
          this.Myself.CheckPhieuStamp.Reset();
          this.Myself.CheckPhieuStamp.Start();
          this.Settings.TraderMode = AllEnums.TraderModes.IDLE;
          this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
          this.GoToMyBang();
        }
        if (this.Myself.MapID == this.Settings.tboxIDBang)
        {
          double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) frmLogin.GAuto.Settings.TNNPC_X, (double) frmLogin.GAuto.Settings.TNNPC_Y);
          if (distance > 3.0)
            this.CallMoveFlashPos((int) frmLogin.GAuto.Settings.TNNPC_X, (int) frmLogin.GAuto.Settings.TNNPC_Y);
          else if (distance <= 3.0)
          {
            if (this.Settings.cboTNTuNhanPhieu)
            {
              if (!this.Settings.cboxTNRunOnly)
              {
                this.CallTalkNPC(0, 0, 5);
                this.CallTalkNPC(805012, 2, 5);
                Thread.Sleep(1500);
                if (this.Myself.LogLastAction != AllEnums.LogActions.NhanPhieu)
                  GA.WriteUserLog(frmMain.langReceiveTraderLetter, this, (object) this.Settings.tboxIDBang, (object) this.Settings.tBoxIDFriend);
                this.Myself.LogLastAction = AllEnums.LogActions.NhanPhieu;
              }
              this.Settings.TraderMode = AllEnums.TraderModes.SellBuy;
            }
            else
            {
              lock (frmMain.frmMainInstance.TNLocker)
              {
                this.Myself.IsTrader = false;
                this.Settings.TraderStatus = AllEnums.CharStatuses.IDLE;
                this.Settings.TraderMode = AllEnums.TraderModes.IDLE;
                this.Myself.ResetPathLabels = true;
                this.Myself.EntirePaths = (List<AdvancedPath>) null;
                this.Myself.Status = AllEnums.CharStatuses.IDLE;
                this.Myself.MinorStatus = AllEnums.CharStatuses.IDLE;
              }
            }
          }
        }
      }
      int num1 = -1;
      int fromMapID = -1;
      if ((this.Settings.TraderMode == AllEnums.TraderModes.Chạy_Đi && this.Myself.MapID == this.Settings.tBoxIDFriend || this.Settings.TraderMode == AllEnums.TraderModes.Chạy_Về && this.Myself.MapID == this.Settings.tboxIDBang) && GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) frmLogin.GAuto.Settings.TNNPC_X, (double) frmLogin.GAuto.Settings.TNNPC_Y) <= 3.0)
        this.Settings.TraderMode = AllEnums.TraderModes.SellBuy;
      if (!this.Settings.cboxTNFullAuto)
        return;
      if (this.Settings.TraderMode == AllEnums.TraderModes.Chạy_Đi)
      {
        num1 = this.Settings.tBoxIDFriend;
        fromMapID = this.Myself.MapID;
        this.Myself.TNDirectionXuoi = true;
      }
      else if (this.Settings.TraderMode == AllEnums.TraderModes.Chạy_Về)
      {
        num1 = this.Settings.tboxIDBang;
        fromMapID = this.Myself.MapID;
        this.Myself.TNDirectionXuoi = false;
      }
      else
      {
        int traderMode = (int) this.Settings.TraderMode;
      }
      if (num1 != -1 && fromMapID != -1 && this.Myself.CalcPathStamp.ElapsedMilliseconds >= 3000L)
      {
        this.Myself.CalcPathStamp.Reset();
        this.Myself.CalcPathStamp.Start();
        List<AdvancedPath> bestPath = this.CalculateBestPath(this.Myself.MapID, num1, true);
        if (bestPath != null)
        {
          this.Myself.IsTrader = true;
          this.Myself.PossiblePaths = bestPath;
          this.Myself.PossiblePaths[this.Myself.PossiblePaths.Count - 1].TempToX = (int) frmLogin.GAuto.Settings.TNNPC_X;
          this.Myself.PossiblePaths[this.Myself.PossiblePaths.Count - 1].TempToY = (int) frmLogin.GAuto.Settings.TNNPC_Y;
          if (this.Myself.EntirePaths == null)
          {
            lock (frmMain.frmMainInstance.TNLocker)
            {
              this.Myself.EntirePaths = bestPath;
              this.Myself.ResetPathLabels = true;
            }
          }
          this.Myself.MinorStatus = AllEnums.CharStatuses.MOVE_LONG_PATH;
          this.ProcessLongMove();
        }
        else if (bestPath == null)
        {
          AutoAccount.AutoInsertMap(fromMapID);
          AutoAccount.AutoInsertMap(num1);
        }
      }
      int num2 = 0;
      if (this.Settings.TraderMode != AllEnums.TraderModes.SellBuy || this.Settings.TraderMode != AllEnums.TraderModes.SellBuy)
        return;
      if (this.Myself.EntirePaths != null)
      {
        lock (frmMain.frmMainInstance.TNLocker)
          this.Myself.EntirePaths = (List<AdvancedPath>) null;
      }
      bool flag5 = false;
      bool flag6 = true;
      bool flag7 = false;
      if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) frmLogin.GAuto.Settings.TNNPC_X, (double) frmLogin.GAuto.Settings.TNNPC_Y) <= 3.0 && (inventoryItem != null || this.Settings.cboxTNRunOnly))
      {
        if (!this.Settings.cboxTNRunOnly)
        {
          this.CallTalkNPC(0, 0, 5);
          this.CallTalkNPC(805012, 5, 5);
          Thread.Sleep(2000);
          bool flag8 = false;
          for (int index3 = 30; index3 < 60; ++index3)
          {
            if (this.MyInventory.AllItems[index3].ItemID == 0)
            {
              flag8 = true;
              break;
            }
          }
          if (flag8)
          {
            bool flag9 = true;
            bool flag10 = true;
            if (this.Myself.MapID == this.Settings.tboxIDBang)
            {
              for (int index4 = 30; index4 < 60; ++index4)
              {
                InventoryItem allItem = this.MyInventory.AllItems[index4];
                if (allItem.SellingPrice > allItem.BuyingPrice)
                {
                  flag10 = false;
                  break;
                }
              }
            }
            List<TNNPCShopItem> itemToBuy = new List<TNNPCShopItem>();
            bool noHistory = false;
            long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
            int num3 = 0;
            while (flag9 && inventoryItem.BuyingPrice < inventoryItem.SellingPrice && flag10 && this.IsAIEnabled)
            {
              if (this.Settings.cboxTNAlert)
                this.ProcessCaptcha();
              inventoryItem = this.MyInventory.AllItems[index1];
              this.RefreshTNMenu();
              this.RefreshItemInfo(itemToBuy, ref noHistory);
              TNNPCShopItem tnnpcShopItem1 = (TNNPCShopItem) null;
              int num4 = 0;
              if (this.Myself.MapID == this.Settings.tboxIDBang)
              {
                if (this.Settings.cboxTNMinhGiaHigher && num2 == 0)
                  num2 = this.Settings.txtTNMinhGiaHigher;
                num4 = this.Settings.cboTNMinhItem;
              }
              else if (this.Myself.MapID == this.Settings.tBoxIDFriend)
              {
                if (this.Settings.cboxTNFriendGiaHigher && num2 == 0)
                  num2 = this.Settings.txtTNFriendGia;
                num4 = this.Settings.cboTNFriendItem;
              }
              if (this.Settings.TNBuyingMode == 0)
              {
                int num5 = 0;
                double num6 = 0.0;
                foreach (TNNPCShopItem tnnpcShopItem2 in itemToBuy)
                {
                  if (!noHistory)
                  {
                    if (tnnpcShopItem2.HistSpread > num6 && tnnpcShopItem2.Price <= inventoryItem.BuyingPrice && tnnpcShopItem2.Amount > 0)
                    {
                      num6 = tnnpcShopItem2.HistSpread;
                      tnnpcShopItem1 = tnnpcShopItem2;
                    }
                  }
                  else if (noHistory && tnnpcShopItem2.Price > num5 && tnnpcShopItem2.Price <= inventoryItem.BuyingPrice && tnnpcShopItem2.Amount > 0)
                  {
                    num5 = tnnpcShopItem2.Price;
                    tnnpcShopItem1 = tnnpcShopItem2;
                  }
                }
              }
              else
                goto label_108;
label_87:
              if (tnnpcShopItem1 != null)
              {
                flag7 = true;
                if (this.Settings.TNBuyingMode == 1 && tnnpcShopItem1.Price > num2)
                  num2 = tnnpcShopItem1.Price;
                if (this.Myself.MapID == this.Settings.tboxIDBang)
                {
                  for (int index5 = 0; index5 < 3; ++index5)
                    this.CallBuyTN(0, tnnpcShopItem1.ItemID);
                }
                else if (this.Myself.MapID == this.Settings.tBoxIDFriend)
                {
                  for (int index6 = 0; index6 < 3; ++index6)
                    this.CallBuyTN(1, tnnpcShopItem1.ItemID);
                }
                Thread.Sleep(300);
              }
              else if (tnnpcShopItem1 == null)
              {
                if (this.Settings.TNBuyingMode == 1 && inventoryItem.BuyingPrice >= num2)
                  flag7 = true;
                flag10 = false;
              }
              if (this.Settings.TNBuyingMode == 0 && tnnpcShopItem1 == null || this.Settings.TNBuyingMode == 1 && inventoryItem.BuyingPrice < num3)
              {
                flag7 = false;
                flag9 = false;
                continue;
              }
              if (inventoryItem.BuyingPrice >= inventoryItem.SellingPrice)
              {
                flag9 = false;
                continue;
              }
              Thread.Sleep(200);
              continue;
label_108:
              if (this.Settings.TNBuyingMode == 1)
              {
                using (List<TNNPCShopItem>.Enumerator enumerator = itemToBuy.GetEnumerator())
                {
                  while (enumerator.MoveNext())
                  {
                    TNNPCShopItem current = enumerator.Current;
                    if (current.ItemID == num4 && current.Price <= inventoryItem.BuyingPrice && current.Price >= num2)
                    {
                      tnnpcShopItem1 = current;
                      break;
                    }
                    if (current.ItemID == num4 && current.Price > num2 && current.Price > num3)
                      num3 = current.Price;
                  }
                  goto label_87;
                }
              }
              goto label_87;
            }
          }
          if (inventoryItem.BuyingPrice <= inventoryItem.SellingPrice && this.Myself.MapID == this.Settings.tBoxIDFriend || this.Myself.MapID == this.Settings.tboxIDBang)
          {
            this.RefreshTNMenu();
            for (int index7 = 30; index7 < 60; ++index7)
            {
              if (this.Settings.cboxTNAlert)
                this.ProcessCaptcha();
              InventoryItem allItem = this.MyInventory.AllItems[index7];
              inventoryItem = this.MyInventory.AllItems[index1];
              if (allItem.SellingPrice > allItem.BuyingPrice && allItem.SellingPrice + inventoryItem.BuyingPrice <= inventoryItem.SellingPrice && this.Myself.MapID == this.Settings.tBoxIDFriend || allItem.SellingPrice > allItem.BuyingPrice && this.Myself.MapID == this.Settings.tboxIDBang)
              {
                flag6 = false;
                double num7 = 0.0;
                if (allItem.BuyingPrice > 0)
                  num7 = (double) allItem.SellingPrice * 1.0 / (double) allItem.BuyingPrice;
                double highSpread = Math.Round(num7, 2);
                bool flag11 = false;
                GA.GetItemSpread(allItem, this.Settings.tboxIDBang, this.Settings.tBoxIDFriend);
                if (allItem.HasHistory && allItem.MidSpread != 0.0 && allItem.MidSpread < allItem.HighSpread || highSpread == 3.78 || highSpread == 3.5 || highSpread == 3.22)
                {
                  flag11 = true;
                  if (highSpread - allItem.HighSpread >= 0.1)
                  {
                    allItem.HighSpread = highSpread;
                    List<double> doubleList = new List<double>()
                    {
                      allItem.LowSpread,
                      allItem.MidSpread,
                      allItem.HighSpread
                    };
                    doubleList.Sort();
                    allItem.LowSpread = doubleList[0];
                    allItem.HighSpread = doubleList[2];
                    allItem.MidSpread = doubleList[1];
                    GA.UpdateTNItem(allItem.ItemID, this.Settings.tboxIDBang, this.Settings.tBoxIDFriend, allItem.MidSpread, highSpread, allItem.LowSpread, allItem.HighSpread);
                  }
                }
                else if (allItem.LowSpread == 0.0 && (Math.Abs(highSpread - allItem.HighSpread) > 0.1 || allItem.HighSpread == 0.0) && (Math.Abs(highSpread - allItem.MidSpread) > 0.1 || allItem.MidSpread == 0.0))
                  allItem.LowSpread = highSpread;
                else if (allItem.MidSpread == 0.0 && (Math.Abs(highSpread - allItem.HighSpread) > 0.1 || allItem.HighSpread == 0.0) && (Math.Abs(highSpread - allItem.LowSpread) > 0.1 || allItem.LowSpread == 0.0))
                  allItem.MidSpread = highSpread;
                else if (allItem.HighSpread == 0.0 && (Math.Abs(highSpread - allItem.LowSpread) > 0.1 || allItem.LowSpread == 0.0) && (Math.Abs(highSpread - allItem.MidSpread) > 0.1 || allItem.MidSpread == 0.0))
                  allItem.HighSpread = highSpread;
                else if (allItem.LowSpread != 0.0 && allItem.MidSpread != 0.0 && allItem.HighSpread != 0.0)
                {
                  List<double> doubleList = new List<double>()
                  {
                    allItem.LowSpread,
                    allItem.MidSpread,
                    allItem.HighSpread
                  };
                  doubleList.Sort();
                  allItem.LowSpread = doubleList[0];
                  allItem.HighSpread = doubleList[2];
                  allItem.MidSpread = doubleList[1];
                  flag11 = true;
                  GA.UpdateTNItem(allItem.ItemID, this.Settings.tboxIDBang, this.Settings.tBoxIDFriend, allItem.MidSpread, allItem.HighSpread, allItem.LowSpread, allItem.HighSpread);
                }
                if (flag11 && (allItem.SellingPrice + inventoryItem.BuyingPrice <= inventoryItem.SellingPrice && (double) allItem.SellingPrice > (double) allItem.BuyingPrice * (allItem.HighSpread - 0.1) && this.Myself.MapID != this.Settings.tboxIDBang || (double) allItem.SellingPrice > (double) allItem.BuyingPrice * (allItem.HighSpread - 0.1) && this.Myself.MapID == this.Settings.tboxIDBang))
                {
                  this.CallSellTN(allItem.ItemGUID1, allItem.ItemGUID2);
                  allItem.RealSpread = (double) allItem.SellingPrice * 1.0 / (double) allItem.BuyingPrice * 100.0;
                  allItem.RealSpread = Math.Round(allItem.RealSpread, 0);
                  GA.WriteUserLog(frmMain.langTraderSellReport, this, (object) this.Myself.MapID, (object) this.Settings.tboxIDBang, (object) this.Settings.tBoxIDFriend, (object) allItem.ItemName, (object) Math.Round((double) allItem.BuyingPrice * 1.0 / 10000.0, 4).ToString("0.00"), (object) Math.Round((double) allItem.SellingPrice * 1.0 / 10000.0, 4).ToString("0.00"), (object) allItem.RealSpread.ToString(), (object) allItem.HighSpread.ToString("0.00"));
                  this.Myself.LogLastAction = AllEnums.LogActions.BanTN;
                  allItem.HighSpread = 0.0;
                  allItem.MidSpread = 0.0;
                  allItem.LowSpread = 0.0;
                  allItem.HasHistory = false;
                  Thread.Sleep(500);
                }
              }
            }
          }
          for (int index8 = 30; index8 < 60; ++index8)
          {
            InventoryItem allItem = this.MyInventory.AllItems[index8];
            if (allItem.SellingPrice > allItem.BuyingPrice)
            {
              flag6 = false;
              break;
            }
          }
        }
      }
      else
      {
        this.Myself.TargetX = frmLogin.GAuto.Settings.TNNPC_X;
        this.Myself.TargetY = frmLogin.GAuto.Settings.TNNPC_Y;
        this.Myself.MoveAcrossMap = false;
        this.Myself.UseAutoMove = false;
        this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
        flag6 = false;
        flag7 = true;
      }
      if (!flag6 || flag7)
        return;
      this.ResetTNPrices();
      if (this.Myself.MapID == this.Settings.tboxIDBang)
      {
        if (this.Myself.tempTNRounds >= this.Settings.numTNRounds)
        {
          lock (frmMain.frmMainInstance.TNLocker)
          {
            this.Myself.IsTrader = false;
            this.Settings.TraderStatus = AllEnums.CharStatuses.IDLE;
            this.Settings.TraderMode = AllEnums.TraderModes.IDLE;
            this.Myself.ResetPathLabels = true;
            this.Myself.EntirePaths = (List<AdvancedPath>) null;
            this.Myself.Status = AllEnums.CharStatuses.IDLE;
            this.Myself.MinorStatus = AllEnums.CharStatuses.IDLE;
            this.Myself.TradeMoveTemp = false;
          }
        }
        else if (!flag3 && !this.Settings.cboxTNRunOnly)
        {
          if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) frmLogin.GAuto.Settings.TNNPC_X, (double) frmLogin.GAuto.Settings.TNNPC_Y) > 1.0)
          {
            this.Myself.TargetX = frmLogin.GAuto.Settings.TNNPC_X;
            this.Myself.TargetY = frmLogin.GAuto.Settings.TNNPC_Y;
            this.Myself.MoveAcrossMap = false;
            this.Myself.UseAutoMove = false;
            this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
          }
          else
          {
            this.CallTalkNPC(0, 0, 5);
            this.CallTalkNPC(805012, 2, 5);
            Thread.Sleep(500);
          }
        }
        else if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) frmLogin.GAuto.Settings.TNNPC_X, (double) frmLogin.GAuto.Settings.TNNPC_Y) > 3.0)
        {
          this.Myself.TargetX = frmLogin.GAuto.Settings.TNNPC_X;
          this.Myself.TargetY = frmLogin.GAuto.Settings.TNNPC_Y;
          this.Myself.MoveAcrossMap = false;
          this.Myself.UseAutoMove = false;
          this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
        }
        else if (!this.Settings.cboxTNRunOnly)
        {
          if (flag5 || inventoryItem.BuyingPrice > inventoryItem.SellingPrice)
          {
            this.CallTalkNPC(0, 0, 5);
            this.CallTalkNPC(805012, 3, 5);
            if (this.Myself.LogLastAction != AllEnums.LogActions.TraPhieu)
              GA.WriteUserLog(frmMain.langTraderReturnLetter, this, (object) this.Settings.tboxIDBang, (object) this.Settings.tBoxIDFriend, (object) Math.Round((double) inventoryItem.BuyingPrice * 1.0 / 10000.0, 4).ToString("0.00"));
            this.Myself.LogLastAction = AllEnums.LogActions.TraPhieu;
            Thread.Sleep(1500);
            lock (frmLogin.lock1)
              ++this.Myself.tempTNRounds;
          }
          else if (!flag5)
          {
            this.Settings.TraderMode = AllEnums.TraderModes.Chạy_Đi;
            this.Settings.TraderStatus = AllEnums.CharStatuses.RUNNING_THUONGNHAN;
            this.Settings.TNLastDirection = this.Settings.TraderMode.ToString();
          }
        }
        else
        {
          this.Settings.TraderMode = AllEnums.TraderModes.Chạy_Đi;
          this.Settings.TraderStatus = AllEnums.CharStatuses.RUNNING_THUONGNHAN;
          this.Settings.TNLastDirection = this.Settings.TraderMode.ToString();
        }
      }
      else if (this.Myself.MapID == this.Settings.tBoxIDFriend)
      {
        this.Settings.TraderMode = AllEnums.TraderModes.Chạy_Về;
        this.Settings.TraderStatus = AllEnums.CharStatuses.RUNNING_THUONGNHAN;
        this.Settings.TNLastDirection = this.Settings.TraderMode.ToString();
        this.Myself.TradeMoveTemp = false;
      }
      else
        GA.Message(frmMain.langTraderClick);
      this.Myself.TradeMoveTemp = false;
    }
  }

  private void RefreshItemInfo(List<TNNPCShopItem> itemToBuy, ref bool noHistory)
  {
    itemToBuy.Clear();
    noHistory = false;
    for (int index = 0; index < 12; ++index)
    {
      TNNPCShopItem shopItem = this.TNNPCShopInstance[index];
      string itemType = "";
      GA.GetItemNameTypeFromID(shopItem.ItemID, out shopItem.Name, out itemType);
      GA.GetItemSpread(shopItem, this.Settings.tboxIDBang, this.Settings.tBoxIDFriend);
      itemToBuy.Add(shopItem);
      if (shopItem.HistSpread == 0.0)
        noHistory = true;
    }
  }

  private void ResetTNPrices()
  {
    for (int index = 30; index < 60; ++index)
    {
      InventoryItem allItem = this.MyInventory.AllItems[index];
      allItem.HighSpread = 0.0;
      allItem.MidSpread = 0.0;
      allItem.LowSpread = 0.0;
      allItem.HasHistory = false;
    }
  }

  private void RefreshTNMenu()
  {
    int num = 500;
    if (this.Settings.TNBuyingMode == 1)
      num = 250;
    if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.TNStamp < (long) num)
      return;
    this.Myself.TNStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    this.CallTalkNPC(0, 0, 5);
    this.CallTalkNPC(805012, 5, 5);
    Thread.Sleep(500);
  }

  public static void AutoInsertMap(int fromMapID)
  {
    try
    {
      bool flag = false;
      foreach (AdvancedPath advancedPath in frmLogin.GAuto.AutoPathDB)
      {
        if (advancedPath.MapID == fromMapID)
        {
          flag = true;
          break;
        }
      }
      if (flag)
        return;
      foreach (AdvancedPath advancedPath in frmLogin.GAuto.AutoPathDB)
      {
        if (advancedPath.ToMapID == fromMapID)
        {
          frmLogin.GAuto.AutoPathDB.Add(new AdvancedPath()
          {
            MapID = advancedPath.ToMapID,
            GateType = AllEnums.GateTypes.Portal,
            LUASupport = false,
            GatePosX = 99,
            GatePosY = 157,
            PortalConfirm = true,
            ToMapID = advancedPath.MapID,
            MapName = advancedPath.ToMapName,
            ToMapName = advancedPath.MapName,
            ToMapX = advancedPath.GatePosX,
            ToMapY = advancedPath.GatePosY
          });
          break;
        }
      }
    }
    catch (Exception ex)
    {
      GA.WriteUserLog($"{frmMain.langInsertMapError}{ex.Message}\nStack traces\n{ex.StackTrace}");
    }
  }

  private void PetCongSinh_HuyetTe()
  {
    if (this.Myself.IsPartyFollowed != (byte) 0 || this.WantMoveNow())
      return;
    bool flag1 = false;
    if (this.Myself.Menpai == AllEnums.Menpais.TINHTUC && this.MySkills.HasSkill(447) && this.MySkills.SkillDelays[14].SkillDelay <= 0 && this.Myself.MPPercent <= (double) this.Settings.numMPPercent && this.Myself.HP > 0 && this.Myself.HPPercent >= 35.0 && frmLogin.GAuto.Settings.optKinhMachNghichHanh)
    {
      flag1 = true;
      this.CallAttackTargetPacket(this.Myself.ID, 447, -1, 0, 0);
    }
    string str = "";
    int skillID = 0;
    int num = 99999;
    if (this.Myself.HPPercent <= (double) this.Settings.numHPPercent && this.Myself.HPPercent > 0.0 && this.Settings.cboxCongSinh && this.MyPet.CongSinhPetName != frmLogin.GAuto.Settings.NoPetName)
    {
      str = this.MyPet.CongSinhPetName;
      SinglePetClass petByName = this.MyPet.GetPetByName(str);
      if (petByName != null)
      {
        num = petByName.KhaiDuongDelay;
        if (petByName.PetSkill1 == 686 || petByName.PetSkill1 == 687)
          skillID = petByName.PetSkill1;
        if (skillID == 0 && (petByName.PetSkill2 == 686 || petByName.PetSkill2 == 687))
          skillID = petByName.PetSkill2;
      }
    }
    else if (this.Myself.MPPercent <= (double) this.Settings.numMPPercent && this.Myself.HPPercent > 0.0 && this.Settings.cboxHuyetTe && this.MyPet.HuyetTePetName != frmLogin.GAuto.Settings.NoPetName && !flag1)
    {
      str = this.MyPet.HuyetTePetName;
      SinglePetClass petByName = this.MyPet.GetPetByName(str);
      if (petByName != null)
      {
        num = petByName.KhaiDuongDelay;
        if (petByName.PetSkill1 == 696 || petByName.PetSkill1 == 697)
          skillID = petByName.PetSkill1;
        if (skillID == 0 && (petByName.PetSkill2 == 696 || petByName.PetSkill2 == 697))
          skillID = petByName.PetSkill2;
      }
    }
    if (!(str != "") || skillID == 0 || this.Myself.ActionStatus == (byte) 5 || this.Settings.TraderMode == AllEnums.TraderModes.SellBuy || num > 4000 || !this.MyPet.flagAllowPet)
      return;
    bool flag2 = false;
    if (this.MyPet.ActivePetIndex == -1)
      flag2 = true;
    else if (this.MyPet.ActivePetIndex >= 0)
    {
      if (this.MyPet.ActivePetIndex < this.MyPet.AllPets.Count)
      {
        try
        {
          if (this.MyPet.AllPets[this.MyPet.ActivePetIndex].PetName != str)
            flag2 = true;
        }
        catch (Exception ex)
        {
          GA.WriteUserLog($"{frmMain.langIndexPetError}{ex.Message}\nStack traces\n{ex.StackTrace}", this);
        }
      }
    }
    if (flag2)
      this.CallPetSure(str);
    if (this.MyPet.ActivePetIndex < 0 || this.MyPet.ActivePetIndex >= this.MyPet.AllPets.Count || this.MyPet.ActivePetID <= 0 || !(this.MyPet.AllPets[this.MyPet.ActivePetIndex].PetName == str))
      return;
    this.Myself.BusyXuatPet = false;
    long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
    long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
    while (this.IsAIEnabled)
    {
      if (!this.Myself.FlagHetThucAn)
        this.CallFeedMyActivePet();
      else if (this.Settings.cboxNMBuff && (!this.Myself.IsPK || this.Settings.cboxNMPKBuff && this.Myself.IsPK) && this.Settings.cboxBuffPet)
      {
        if (!this.Myself.ManaRunOut)
        {
          this.NgaMiBuffPet(frmLogin.GAuto.Settings.HTPetPercent);
          elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        }
        else
          break;
      }
      Thread.Sleep(500);
      if (!this.HasActivePet() || this.MyPet.AllPets[this.MyPet.ActivePetIndex].HPPercent >= (double) frmLogin.GAuto.Settings.HTPetPercent || frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 >= 8000L || frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 >= 16000L)
        break;
    }
    long elapsedMilliseconds3 = frmLogin.GlobalTimer.ElapsedMilliseconds;
    bool flag3 = false;
    do
    {
      if (this.HasActivePet())
      {
        if (!flag3 && this.MyPet.AllPets[this.MyPet.ActivePetIndex].KhaiDuongDelay <= 0)
          this.CallAttackTargetPacket(this.MyPet.AllPets[this.MyPet.ActivePetIndex].ID, skillID, 0, 0, 0);
        if (this.MyPet.AllPets[this.MyPet.ActivePetIndex].HPPercent <= 60.0 && !flag3)
        {
          flag3 = true;
          this.MyPet.PetAction = AllEnums.PetActions.XuatChien;
        }
        if (flag3)
        {
          if (this.MyPet.AllPets[this.MyPet.ActivePetIndex].HPPercent <= 80.0)
          {
            if (!this.Myself.FlagHetThucAn)
              this.CallFeedMyActivePet();
          }
          else
            goto label_49;
        }
      }
      if (this.MyPet.ActivePetIndex == -1)
        break;
      Thread.Sleep(500);
    }
    while (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds3 < 5000L);
    return;
label_49:
    this.MyPet.PetAction = AllEnums.PetActions.XuatChien;
  }

  public bool HasActivePet()
  {
    return this.MyPet != null && this.MyPet.AllPets.Count > 0 && this.MyPet.ActivePetIndex >= 0 && this.MyPet.ActivePetIndex < this.MyPet.AllPets.Count && this.MyPet.ActivePetID > 0;
  }

  private void CallPetSure(string mustCallPetName)
  {
    if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.nodelayAction <= 15000L || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.IsAttackedTimeStamp <= 10000L && this.Myself.IsAttackedTimeStamp > 0L && !this.IsInCity() || this.Myself.IsPartyFollowed == (byte) 1 || this.isInDiaPhu())
      return;
    SinglePetClass petByName = this.MyPet.GetPetByName(mustCallPetName);
    if (petByName == null || this.Myself.IsTBB || this.WantMoveNow())
      return;
    this.Myself.BusyXuatPet = true;
    bool flag1 = false;
    bool flag2 = false;
    long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
    while (!flag1 && !flag2 && (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.IsAttackedTimeStamp > 10000L || this.Myself.IsAttackedTimeStamp <= 0L || this.IsInCity()) && this.Myself.HPPercent > 0.0)
    {
      flag2 = petByName.Happiness < 60;
      if (flag2)
      {
        long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        while ((this.IsAIEnabled || this.Myself.Menpai == AllEnums.Menpais.NGAMI && this.Settings.cboxNMBuff) && this.CallPlayMyPet(petByName.DatabaseID, petByName.PetOwnerDBID))
        {
          Thread.Sleep(300);
          if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 < 3000L)
          {
            if (petByName.Happiness > 60)
            {
              flag2 = false;
              break;
            }
          }
          else
            break;
        }
      }
      if (!flag2)
      {
        if (this.Myself.ActionStatus != (byte) 5 && !flag2)
        {
          if (this.Myself.HorseType != -1 && this.Myself.ActionStatus != (byte) 2)
            this.CallXuongNgua();
          if (this.Myself.ActionStatus == (byte) 7)
          {
            this.CallAttackTarget(-1, 34, 0, 0);
            this.CallAttackTarget(-1, this.GetKhinhCongID(), 0, 0);
          }
          this.CallPetXuatChien(petByName.PetOwnerDBID, petByName.DatabaseID);
          Thread.Sleep(1000);
        }
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 < 10000L || elapsedMilliseconds1 == 0L)
        {
          Thread.Sleep(500);
          if (this.MyPet.ActivePetIndex >= 0 && this.MyPet.ActivePetIndex < this.MyPet.AllPets.Count && this.MyPet.AllPets.Count > 0)
          {
            if (this.MyPet.ActivePetID > 0)
            {
              try
              {
                if (this.MyPet.AllPets[this.MyPet.ActivePetIndex].PetName != "")
                {
                  if (this.MyPet.AllPets[this.MyPet.ActivePetIndex].PetName == mustCallPetName)
                    flag1 = true;
                }
              }
              catch (Exception ex)
              {
                GA.WriteUserLog($"{frmMain.langSummonPetError}{ex.Message}\nStack traces\n{ex.StackTrace}", this);
              }
            }
          }
        }
        else
          break;
      }
      else
        break;
    }
    this.Myself.LastPostStamp.Reset();
    this.Myself.LastPostStamp.Start();
  }

  private void GetDVPDetails()
  {
    for (int index = 0; index < 30; ++index)
    {
      InventoryItem allItem = this.MyInventory.AllItems[index];
      if ((allItem.ItemName.Contains("ổ linh ch") || allItem.ItemName.Contains("ịnh vị ph") || allItem.ItemName.Contains("location spell") || allItem.ItemName.Contains("light dust capsule") || allItem.ItemID >= 30501017 && allItem.ItemID <= 30501042 && allItem.ItemID != 30501035 && allItem.ItemID != 30501036 || allItem.ItemID == 30008007 || allItem.ItemID == 30505216 || allItem.ItemID == 38001079) && (allItem.ItemMapID == 0 || allItem.DinhViPhuTime == (byte) 0))
      {
        int num = allItem.ItemGUID2;
        if (this.Target.VersionNum == 7 || this.Target.VersionNum == 8)
          num = allItem.ItemGUID1;
        if (!this.Myself.CheckedItemList.Contains(num) && num != 0)
        {
          this.MyInventory.CheckItemBuffer.Add(index);
          if (this.Myself.CheckedItemList.Count >= 100)
            this.Myself.CheckedItemList.Clear();
          if (num != 0)
            this.Myself.CheckedItemList.Add(num);
        }
      }
    }
  }

  private void CleanUpInventory(bool checkCity = true)
  {
    if ((this.IsInCity() || !checkCity) && checkCity && !this.Myself.isCauPhuc && !this.Myself.IsCheDo && !this.Myself.isDoiPhieuTienVang || !frmLogin.GAuto.Settings.IsPro1)
      return;
    if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.VutDoStamp > 10000L)
      this.Myself.VutDoStamp = 0L;
    if (this.Myself.VutDoStamp != 0L)
      return;
    for (int index = 0; index < 30; ++index)
    {
      InventoryItem allItem1 = this.MyInventory.AllItems[index];
      if (allItem1.ItemID > 0 && allItem1.ItemID != 10100031 && allItem1.ItemID != 10102012 && allItem1.ItemID != 10102013 && (allItem1.LastTimeSeen == 0L || allItem1.LastTimeSeen != 0L && frmLogin.GlobalTimer.ElapsedMilliseconds - allItem1.LastTimeSeen >= 1500L))
      {
        if (allItem1.ItemName == string.Empty || allItem1.ItemType == string.Empty)
          GA.GetItemNameTypeFromID(allItem1.ItemID, out allItem1.ItemName, out allItem1.ItemType);
        if (!this.VatPhamQuy(allItem1.ItemID, allItem1.ItemName, allItem1.ItemType) && this.isTrangBiItem(allItem1.ItemType) && allItem1.ItemName != "chưa dùng")
        {
          if (allItem1.ItemSource == AllEnums.ItemSources.Chưa_biết || allItem1.SavedCode != allItem1.ItemID)
          {
            int num = allItem1.ItemGUID2;
            if (GA.CheckGameVersion(this.Target.VersionNum) == 356)
              num = allItem1.ItemGUID1;
            if (!this.Myself.CheckedItemList.Contains(num) || num == 0)
            {
              this.MyInventory.CheckItemBuffer.Add(index);
              allItem1.NeedToWait = true;
              if (this.Myself.CheckedItemList.Count >= 100)
                this.Myself.CheckedItemList.Clear();
              if (num != 0)
                this.Myself.CheckedItemList.Add(num);
            }
          }
          if (!allItem1.NeedToWait)
          {
            bool flag = false;
            InventoryItem allItem2 = this.MyInventory.AllItems[index];
            if (allItem2.ItemSource == AllEnums.ItemSources.Đồ_nhặt || allItem2.ItemSource == AllEnums.ItemSources.Đồ_cần_GĐ || allItem2.ItemSource == AllEnums.ItemSources.Đồ_Chế && this.Target.VersionNum == 3)
            {
              if (allItem2.ItemID == allItem2.SavedCode && allItem2.SavedCode != 0)
              {
                if ((int) allItem2.Lines >= this.Settings.numGiuDoDong)
                  flag = true;
                if ((int) allItem2.ItemStars >= this.Settings.numGiuDoSao)
                  flag = true;
              }
              if (!flag)
                this.CallRemoveInventoryItem(index);
            }
          }
          else
            allItem1.NeedToWait = false;
        }
      }
    }
  }

  private bool NotTransitioning()
  {
    bool move = this.SafeToMove();
    return this.Myself.MaxHP > 0 && move;
  }

  private bool SafeToMove()
  {
    if (this.Myself.isSceneTrans == 1 || (this.Myself.TransitioningStamp.ElapsedMilliseconds < 1000L || this.Myself.TransitioningStamp.ElapsedMilliseconds == 0L || this.Myself.Level <= 0) && this.Myself.TransitioningStamp.ElapsedMilliseconds != 0L)
      return false;
    this.Myself.TransitioningStamp.Reset();
    this.Myself.TransitioningStamp.Stop();
    return true;
  }

  private void ThungDo_MuaBanItem()
  {
    if (this.Myself.Status == AllEnums.CharStatuses.VETHANH)
      this.Myself.SavedStatus = AllEnums.CharStatuses.VETHANH;
    if (this.Myself.SavedStatus == AllEnums.CharStatuses.VETHANH && (this.IsInCity() || this.IsInPhai()) && this.Myself.ActionStatus != (byte) 5 && this.Myself.ActionStatus != (byte) 6 && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.CheckVeThanhStamp >= 7000L)
    {
      this.Myself.CheckVeThanhStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
      bool flag = this.NotTransitioning();
      if (this.Myself.MapID != this.Settings.HealMapID && flag && this.Settings.TraderMode == AllEnums.TraderModes.IDLE && !this.Myself.IsTrader && !this.RunningQuest())
        this.Myself.Status = AllEnums.CharStatuses.VETHANH;
    }
    bool flag1 = true;
    bool needVeThuHoach = false;
    if (this.Myself.IsTrongTrot)
    {
      if (this.Settings.TTLoaiThuHoach == 1)
        flag1 = false;
      else if (this.Settings.TTLoaiThuHoach == 2)
        flag1 = this.TrongTrot(ref needVeThuHoach);
    }
    else
      flag1 = true;
    if (this.Myself.Status == AllEnums.CharStatuses.VETHANH && !this.Myself.IsTrader)
    {
      if (this.Myself.MapID != this.Settings.HealMapID && (this.IsInCity() || this.IsInPhai()))
      {
        if (this.Myself.Status != AllEnums.CharStatuses.GOGOGO)
          Thread.Sleep(1000);
        switch (this.Settings.HealMapID)
        {
          case 0:
            this.Myself.TargetX = 227f;
            this.Myself.TargetY = 319f;
            break;
          case 1:
            this.Myself.TargetX = 201f;
            this.Myself.TargetY = 259f;
            break;
          case 2:
            this.Myself.TargetX = 253f;
            this.Myself.TargetY = 126f;
            break;
        }
        bool flag2 = this.NotTransitioning();
        if (this.Myself.MapID != this.Settings.HealMapID && flag2)
        {
          this.Myself.TargetMapID = this.Settings.HealMapID;
          this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
          this.Myself.UseAutoMove = true;
          this.Myself.MoveAcrossMap = true;
          this.Myself.SavedStatus = AllEnums.CharStatuses.VETHANH;
          this.CallAutoMoveToTarget((int) this.Myself.TargetX, (int) this.Myself.TargetY, this.Settings.HealMapID);
        }
      }
      else if (this.Myself.MapID == this.Settings.HealMapID && flag1)
      {
        this.CallLenNgua();
        if ((this.Myself.HPPercent < 70.0 || this.Myself.MPPercent < 70.0) && this.Settings.cboxDuY)
        {
          int ToX = 0;
          int ToY = 0;
          int NPCID = 0;
          int menuTypeID = 0;
          int menuIndex = 0;
          if (this.Myself.MapID == 0)
          {
            ToX = 184;
            ToY = 335;
            NPCID = 185;
            menuTypeID = 129;
            menuIndex = 1001;
          }
          else if (this.Myself.MapID == 1)
          {
            ToX = 163;
            ToY = 259;
            NPCID = 113;
            menuTypeID = 64 /*0x40*/;
            menuIndex = 1001;
          }
          else if (this.Myself.MapID == 2)
          {
            NPCID = 117;
            ToX = 292;
            ToY = 148;
            menuTypeID = 64 /*0x40*/;
            menuIndex = 1001;
          }
          else if (this.Myself.MapID == 480)
          {
            NPCID = 11;
            ToX = 123;
            ToY = 172;
            menuTypeID = 889629;
            menuIndex = 1001;
          }
          double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) ToX, (double) ToY);
          bool flag3 = this.NotTransitioning();
          if (distance > 4.0 && flag3)
          {
            this.Myself.TargetX = (float) ToX;
            this.Myself.TargetY = (float) ToY;
            this.Myself.MoveAcrossMap = false;
            this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
            this.Myself.SavedStatus = AllEnums.CharStatuses.VETHANH;
            this.CallMoveFlashPos((int) this.Myself.TargetX, (int) this.Myself.TargetY);
          }
          else
          {
            this.CallTalkNPC(0, 0, NPCID);
            this.CallTalkNPC(menuTypeID, 0, NPCID);
            this.CallTalkNPC(menuTypeID, menuIndex, NPCID);
          }
        }
        if (this.Myself.Status != AllEnums.CharStatuses.GOGOGO)
        {
          if (this.CheckNeedToBuy() && this.Settings.cboxTuMuaBan && this.Myself.MapID != 480)
            this.Myself.Status = AllEnums.CharStatuses.BUYING_NPC;
          else if (this.Settings.MapID != -1)
          {
            if (!this.Myself.StopTrain)
            {
              this.BackToTrainSpot();
            }
            else
            {
              this.Myself.Status = AllEnums.CharStatuses.IDLE;
              this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
            }
          }
          else
          {
            this.Myself.Status = AllEnums.CharStatuses.IDLE;
            this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
          }
        }
      }
    }
    if (this.Myself.Status != AllEnums.CharStatuses.BUYING_NPC || !this.Settings.cboxTuMuaBan || !flag1 || this.Settings.ListItemToBuy.Count <= 0 || this.Settings.HealMapID != this.Myself.MapID)
      return;
    int ToX1 = 0;
    int ToY1 = 0;
    int num1 = 0;
    int menuTypeID1 = 0;
    bool flag4 = false;
    bool flag5 = false;
    ItemToBuy itemToBuy1 = (ItemToBuy) null;
    try
    {
      foreach (ItemToBuy itemToBuy2 in (List<ItemToBuy>) this.Settings.ListItemToBuy)
      {
        if (itemToBuy2.NPCType == AllEnums.BuyingItemTypes.Dược && !this.CheckToBuyItem(itemToBuy2))
        {
          flag4 = true;
          itemToBuy1 = itemToBuy2;
          break;
        }
      }
    }
    catch (Exception ex)
    {
      GA.WriteUserLog($"{frmMain.langBuySuppliesError}{ex.Message}\nStack traces\n{ex.StackTrace}", this);
    }
    if (!flag4)
    {
      try
      {
        foreach (ItemToBuy itemToBuy3 in (List<ItemToBuy>) this.Settings.ListItemToBuy)
        {
          if (itemToBuy3.NPCType == AllEnums.BuyingItemTypes.Thú && !this.CheckToBuyItem(itemToBuy3))
          {
            flag5 = true;
            itemToBuy1 = itemToBuy3;
            break;
          }
        }
      }
      catch (Exception ex)
      {
        GA.WriteUserLog($"{frmMain.langBuyPetSuppliesError}{ex.Message}\nStack traces\n{ex.StackTrace}", this);
      }
    }
    if (flag4 && !flag5)
    {
      if (this.Myself.MapID == 0)
      {
        ToX1 = 230;
        ToY1 = 308;
        num1 = 159;
      }
      else if (this.Myself.MapID == 1)
      {
        ToX1 = 192 /*0xC0*/;
        ToY1 = 253;
        num1 = 30;
      }
      else if (this.Myself.MapID == 2)
      {
        num1 = 12;
        ToX1 = 106;
        ToY1 = 125;
        menuTypeID1 = 2027;
      }
      else if (this.Myself.MapID == 420)
      {
        ToX1 = 102;
        ToY1 = 94;
      }
    }
    if (flag5 && !flag4)
    {
      if (this.Myself.MapID == 0)
      {
        ToX1 = 276;
        ToY1 = 295;
        num1 = 49;
        menuTypeID1 = 101;
      }
      else if (this.Myself.MapID == 1)
      {
        ToX1 = 173;
        ToY1 = 237;
        num1 = 47;
        menuTypeID1 = 1050;
      }
      else if (this.Myself.MapID == 2)
      {
        ToX1 = 270;
        ToY1 = 131;
        num1 = 35;
        menuTypeID1 = 2051;
      }
      else if (this.Myself.MapID == 420)
      {
        ToX1 = 102;
        ToY1 = 94;
      }
    }
    if (flag4 || flag5)
    {
      double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) ToX1, (double) ToY1);
      bool flag6 = this.NotTransitioning();
      if (distance > 2.5 && flag6)
      {
        this.Myself.TargetX = (float) ToX1;
        this.Myself.TargetY = (float) ToY1;
        this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
        this.Myself.UseAutoMove = false;
        this.Myself.MoveAcrossMap = false;
        this.Myself.SavedStatus = AllEnums.CharStatuses.BUYING_NPC;
        this.CallInMapMove((int) this.Myself.TargetX, (int) this.Myself.TargetY, true);
      }
      else
      {
        if (flag5)
        {
          this.CallTalkNPC(0, 0, num1);
          this.CallTalkNPC(menuTypeID1, 0, num1);
        }
        else if (flag4)
        {
          this.CallTalkNPC(0, 0, num1);
          this.CallTalkNPC(menuTypeID1, 0, num1);
        }
        if (itemToBuy1.RealAmountToBuy > 20)
        {
          int num2 = itemToBuy1.RealAmountToBuy / 20;
          int amount = itemToBuy1.RealAmountToBuy % 20;
          for (int index = 0; index < num2; ++index)
          {
            this.CallBuyItemPacket(itemToBuy1.MenuIndex, num1, this.Myself.MapID, 20);
            Thread.Sleep(1500);
          }
          if (amount > 0)
          {
            this.CallBuyItemPacket(itemToBuy1.MenuIndex, num1, this.Myself.MapID, amount);
            Thread.Sleep(1500);
          }
        }
        else
        {
          this.CallBuyItemPacket(itemToBuy1.MenuIndex, num1, this.Myself.MapID, itemToBuy1.RealAmountToBuy);
          Thread.Sleep(1500);
        }
        for (int index = 0; index < 60; ++index)
        {
          InventoryItem allItem = this.MyInventory.AllItems[index];
          if (allItem.ItemName == string.Empty || allItem.ItemType == string.Empty)
            GA.GetItemNameTypeFromID(allItem.ItemID, out allItem.ItemName, out allItem.ItemType);
          if (allItem.ItemName != "")
          {
            bool flag7 = false;
            try
            {
              foreach (string itemBan in (List<string>) frmLogin.GAuto.Settings.ItemBanList)
              {
                if (allItem.ItemName.ToLower().Contains(itemBan))
                {
                  flag7 = true;
                  break;
                }
                if (allItem.ItemType.ToLower().Contains(itemBan))
                {
                  flag7 = true;
                  break;
                }
              }
            }
            catch (Exception ex)
            {
              GA.WriteUserLog($"{frmMain.langSellItemError}{ex.Message}\nStack traces\n{ex.StackTrace}", this);
            }
            if (flag7)
            {
              this.CallNPCSellItem(index, num1, this.Myself.MapID);
              Thread.Sleep(350);
            }
          }
        }
      }
    }
    else
    {
      if (this.Myself.StopTrain)
        return;
      this.BackToTrainSpot();
    }
  }

  private bool BanRacNPC(int NPCID = 0, bool checking = false)
  {
    for (int index = 0; index < 60; ++index)
    {
      InventoryItem allItem = this.MyInventory.AllItems[index];
      if (allItem.ItemName == string.Empty || allItem.ItemType == string.Empty)
        GA.GetItemNameTypeFromID(allItem.ItemID, out allItem.ItemName, out allItem.ItemType);
      if (allItem.ItemName != "" || allItem.ItemID > 0)
      {
        bool flag = false;
        try
        {
          foreach (string itemBan in (List<string>) frmLogin.GAuto.Settings.ItemBanList)
          {
            if (allItem.ItemName.ToLower().Contains(itemBan))
            {
              flag = true;
              break;
            }
            if (allItem.ItemType.ToLower().Contains(itemBan))
            {
              flag = true;
              break;
            }
            int result = 0;
            int.TryParse(itemBan, out result);
            if (result > 0 && result == allItem.ItemID)
            {
              flag = true;
              break;
            }
          }
        }
        catch (Exception ex)
        {
          GA.WriteUserLog($"{frmMain.langSellItemError}{ex.Message}\nStack traces\n{ex.StackTrace}", this);
        }
        if (flag)
        {
          if (checking)
            return true;
          this.CallNPCSellItem(index, NPCID, this.Myself.MapID);
          Thread.Sleep(200);
        }
      }
    }
    return false;
  }

  private void MuaDoDiTrain()
  {
    if (this.Target.VersionNum != 3)
    {
      int posX = 0;
      int posY = 0;
      int mapID = 0;
      int num1 = 0;
      int menuTypeID = 0;
      bool flag1 = false;
      bool flag2 = false;
      ItemToBuy itemToBuy1 = (ItemToBuy) null;
      if (this.IsInCity())
      {
        if (!flag2)
        {
          try
          {
            foreach (ItemToBuy itemToBuy2 in (List<ItemToBuy>) this.Settings.ListItemToBuy)
            {
              if (itemToBuy2.NPCType == AllEnums.BuyingItemTypes.Dược && !this.CheckToBuyItem(itemToBuy2))
              {
                flag1 = true;
                itemToBuy1 = itemToBuy2;
                break;
              }
            }
          }
          catch (Exception ex)
          {
            GA.WriteUserLog($"{frmMain.langBuySuppliesError}{ex.Message}\nStack traces\n{ex.StackTrace}", this);
          }
        }
        if (!flag1)
        {
          try
          {
            foreach (ItemToBuy itemToBuy3 in (List<ItemToBuy>) this.Settings.ListItemToBuy)
            {
              if (itemToBuy3.NPCType == AllEnums.BuyingItemTypes.Thú && !this.CheckToBuyItem(itemToBuy3))
              {
                flag2 = true;
                itemToBuy1 = itemToBuy3;
                break;
              }
            }
          }
          catch (Exception ex)
          {
            GA.WriteUserLog($"{frmMain.langBuyPetSuppliesError}{ex.Message}\nStack traces\n{ex.StackTrace}", this);
          }
        }
        if (this.Myself.sellItemFlag == 0 && !flag2 && !flag1 && this.Settings.cboxTuMuaBan && this.BanRacNPC(checking: true))
          this.Myself.sellItemFlag = 1;
        if (flag1 && !flag2)
        {
          if (this.Myself.MapID == 0)
          {
            posX = 230;
            posY = 308;
            mapID = 0;
            num1 = 159;
            if (GA.ClientVersion(this) == 10)
            {
              posX = 136;
              posY = 164;
            }
          }
          else if (this.Myself.MapID == 1)
          {
            posX = 192 /*0xC0*/;
            posY = 253;
            mapID = 1;
            num1 = 30;
            if (GA.ClientVersion(this) == 10)
            {
              posX = 99;
              posY = 155;
            }
          }
          else if (this.Myself.MapID == 2)
          {
            num1 = 12;
            posX = 106;
            posY = 125;
            mapID = 2;
            menuTypeID = 2027;
            if (GA.ClientVersion(this) == 10)
            {
              posX = 102;
              posY = 131;
            }
          }
          else if (this.Myself.MapID == 420)
          {
            posX = 102;
            posY = 94;
            mapID = 420;
          }
          else if (this.Myself.MapID == 480)
            flag1 = false;
          else if (this.Myself.MapID == 186)
            flag1 = false;
        }
        if ((flag2 || this.Myself.sellItemFlag == 1) && !flag1)
        {
          if (this.Myself.MapID == 0)
          {
            posX = 276;
            posY = 295;
            mapID = 0;
            num1 = 49;
            menuTypeID = 101;
            if (GA.ClientVersion(this) == 10)
            {
              posX = 182;
              posY = 157;
            }
          }
          else if (this.Myself.MapID == 1)
          {
            posX = 173;
            posY = 237;
            mapID = 1;
            num1 = 47;
            menuTypeID = 1050;
            if (GA.ClientVersion(this) == 10)
            {
              posX = 86;
              posY = 142;
            }
          }
          else if (this.Myself.MapID == 2)
          {
            posX = 270;
            posY = 131;
            mapID = 2;
            num1 = 35;
            menuTypeID = 2051;
            if (GA.ClientVersion(this) == 10)
            {
              posX = 265;
              posY = 128 /*0x80*/;
            }
          }
          else if (this.Myself.MapID == 420)
          {
            num1 = 13;
            posX = 109;
            posY = 126;
            mapID = 420;
            menuTypeID = 1186;
          }
          else if (this.Myself.MapID == 480)
          {
            num1 = 1;
            posX = 282;
            posY = 41;
            mapID = 480;
            menuTypeID = 889630;
          }
          else if (this.Myself.MapID == 186)
          {
            num1 = 54;
            posX = 109;
            posY = 121;
            mapID = 186;
            menuTypeID = 1111;
          }
        }
        if (flag1 || flag2 || this.Myself.sellItemFlag == 1)
        {
          if (!this.GoToMyPos(posX, posY, mapID))
            return;
          if (flag2 || this.Myself.sellItemFlag == 1)
          {
            this.CallTalkNPC(0, 0, num1);
            this.CallTalkNPC(menuTypeID, 0, num1);
          }
          else if (flag1)
          {
            this.CallTalkNPC(0, 0, num1);
            this.CallTalkNPC(menuTypeID, 0, num1);
          }
          if (itemToBuy1 != null)
          {
            if (itemToBuy1.RealAmountToBuy > 20)
            {
              int num2 = itemToBuy1.RealAmountToBuy / 20;
              int amount = itemToBuy1.RealAmountToBuy % 20;
              for (int index = 0; index < num2; ++index)
              {
                this.CallBuyItemPacket(itemToBuy1.MenuIndex, num1, this.Myself.MapID, 20);
                Thread.Sleep(1500);
              }
              if (amount > 0)
              {
                this.CallBuyItemPacket(itemToBuy1.MenuIndex, num1, this.Myself.MapID, amount);
                Thread.Sleep(1500);
              }
            }
            else
            {
              this.CallBuyItemPacket(itemToBuy1.MenuIndex, num1, this.Myself.MapID, itemToBuy1.RealAmountToBuy);
              Thread.Sleep(1500);
            }
          }
          if (!this.Settings.cboxTuMuaBan)
            return;
          this.BanRacNPC(num1);
          this.Myself.sellItemFlag = 2;
        }
        else
        {
          if (flag1 || flag2)
            return;
          if (!this.Myself.isMuaDoTrain)
          {
            if (this.Myself.actionFlag == 1)
            {
              this.Myself.actionFlag = 0;
              this.Settings.cboxTheoSau = true;
            }
            this.Myself.sellItemFlag = 0;
            this.BackToTrainSpot();
          }
          else
          {
            this.Myself.Status = AllEnums.CharStatuses.IDLE;
            this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
            this.Myself.sellItemFlag = 0;
            this.Myself.isMuaDoTrain = false;
            if (this.Myself.actionFlag != 1)
              return;
            this.Myself.actionFlag = 0;
            this.Settings.cboxTheoSau = true;
          }
        }
      }
      else
      {
        if (this.Myself.actionFlag == 1)
        {
          this.Myself.actionFlag = 0;
          this.Settings.cboxTheoSau = true;
        }
        this.Myself.Status = AllEnums.CharStatuses.IDLE;
        this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
        this.Myself.sellItemFlag = 0;
      }
    }
    else if (!this.Myself.StopTrain)
    {
      this.BackToTrainSpot();
    }
    else
    {
      this.BuyListItemKNB();
      this.Myself.Status = AllEnums.CharStatuses.IDLE;
      this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
    }
  }

  private void BanDoChoNPC()
  {
    int posX = 0;
    int posY = 0;
    int mapID = 0;
    int NPCID = 0;
    int menuTypeID = 0;
    bool flag1 = false;
    bool flag2 = false;
    if (this.IsInCity())
    {
      if (this.Myself.sellItemFlag == 0 && !flag2 && !flag1 && this.Settings.cboxTuMuaBan && this.BanRacNPC(checking: true))
        this.Myself.sellItemFlag = 1;
      if (flag1 && !flag2)
      {
        if (this.Myself.MapID == 0)
        {
          posX = 230;
          posY = 308;
          mapID = 0;
          NPCID = 159;
          if (GA.ClientVersion(this) == 10)
          {
            posX = 136;
            posY = 164;
          }
        }
        else if (this.Myself.MapID == 1)
        {
          posX = 192 /*0xC0*/;
          posY = 253;
          mapID = 1;
          NPCID = 30;
          if (GA.ClientVersion(this) == 10)
          {
            posX = 99;
            posY = 155;
          }
        }
        else if (this.Myself.MapID == 2)
        {
          NPCID = 12;
          posX = 106;
          posY = 125;
          mapID = 2;
          menuTypeID = 2027;
          if (GA.ClientVersion(this) == 10)
          {
            posX = 102;
            posY = 131;
          }
        }
        else if (this.Myself.MapID == 420)
        {
          posX = 102;
          posY = 94;
          mapID = 420;
        }
        else if (this.Myself.MapID == 480)
          flag1 = false;
        else if (this.Myself.MapID == 186)
          flag1 = false;
      }
      if ((flag2 || this.Myself.sellItemFlag == 1) && !flag1)
      {
        if (this.Myself.MapID == 0)
        {
          posX = 276;
          posY = 295;
          mapID = 0;
          NPCID = 49;
          menuTypeID = 101;
          if (GA.ClientVersion(this) == 10)
          {
            posX = 182;
            posY = 157;
          }
        }
        else if (this.Myself.MapID == 1)
        {
          posX = 173;
          posY = 237;
          mapID = 1;
          NPCID = 47;
          menuTypeID = 1050;
          bool flag3 = false;
          if (this.MyParty.PartyNumbers > 0)
          {
            try
            {
              for (int index1 = 0; index1 <= this.MyParty.PartyNumbers; ++index1)
              {
                PartyMember allMember = this.MyParty.AllMembers[index1];
                AutoAccount autoAccount = (AutoAccount) null;
                for (int index2 = frmLogin.GAuto.AllAutoAccounts.Count - 1; index2 >= 0; --index2)
                {
                  AutoAccount allAutoAccount = frmLogin.GAuto.AllAutoAccounts[index2];
                  if (allAutoAccount.Myself.DatabaseID == allMember.DatabaseID)
                  {
                    autoAccount = allAutoAccount;
                    break;
                  }
                }
                if (autoAccount != null && autoAccount.Myself.isThuyLao)
                {
                  flag3 = true;
                  break;
                }
              }
            }
            catch (Exception ex)
            {
            }
          }
          if (GA.ClientVersion(this) == 10)
          {
            posX = 86;
            posY = 142;
          }
          else if (flag3)
          {
            posX = 316;
            posY = 170;
            if (this.Target.VersionNum == 3)
            {
              posX = 314;
              posY = 167;
            }
            NPCID = 28;
          }
        }
        else if (this.Myself.MapID == 2)
        {
          posX = 270;
          posY = 131;
          mapID = 2;
          NPCID = 35;
          menuTypeID = 2051;
          if (GA.ClientVersion(this) == 10)
          {
            posX = 265;
            posY = 128 /*0x80*/;
          }
        }
        else if (this.Myself.MapID == 420)
        {
          NPCID = 13;
          posX = 109;
          posY = 126;
          mapID = 420;
          menuTypeID = 1186;
        }
        else if (this.Myself.MapID == 480)
        {
          NPCID = 1;
          posX = 282;
          posY = 41;
          mapID = 480;
          menuTypeID = 889630;
        }
        else if (this.Myself.MapID == 186)
        {
          NPCID = 54;
          posX = 109;
          posY = 121;
          mapID = 186;
          menuTypeID = 1111;
        }
      }
      if (flag1 || flag2 || this.Myself.sellItemFlag == 1)
      {
        if (!this.GoToMyPos(posX, posY, mapID))
          return;
        if (flag2 || this.Myself.sellItemFlag == 1)
        {
          this.CallTalkNPC(0, 0, NPCID);
          this.CallTalkNPC(menuTypeID, 0, NPCID);
        }
        else if (flag1)
        {
          this.CallTalkNPC(0, 0, NPCID);
          this.CallTalkNPC(menuTypeID, 0, NPCID);
        }
        if (!this.Settings.cboxTuMuaBan)
          return;
        this.BanRacNPC(NPCID);
        this.Myself.sellItemFlag = 2;
      }
      else
      {
        if (flag1 || flag2)
          return;
        if (!this.Myself.isBanDoChoNPC)
        {
          if (this.Myself.actionFlag == 1)
          {
            this.Myself.actionFlag = 0;
            this.Settings.cboxTheoSau = true;
          }
          this.Myself.sellItemFlag = 0;
        }
        else
        {
          this.Myself.Status = AllEnums.CharStatuses.IDLE;
          this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
          this.Myself.sellItemFlag = 0;
          this.Myself.isBanDoChoNPC = false;
          if (this.Myself.actionFlag != 1)
            return;
          this.Myself.actionFlag = 0;
          this.Settings.cboxTheoSau = true;
        }
      }
    }
    else
    {
      if (this.Myself.actionFlag == 1)
      {
        this.Myself.actionFlag = 0;
        this.Settings.cboxTheoSau = true;
      }
      this.Myself.Status = AllEnums.CharStatuses.IDLE;
      this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
      this.Myself.sellItemFlag = 0;
    }
  }

  public void BackToTrainSpot()
  {
    if (this.Settings.AIMode == AllEnums.AIModes.NHIEMVU || this.Settings.AIMode == AllEnums.AIModes.THUONGNHAN || this.Settings.AIMode == AllEnums.AIModes.KHAIKHOANG_HAIDUOC)
      return;
    this.Myself.SavedMapID = this.Settings.MapID;
    this.Myself.SavedPosX = (float) (int) this.Settings.CenterX;
    this.Myself.SavedPosY = (float) (int) this.Settings.CenterY;
    bool flag1 = false;
    int num1 = 5;
    if (this.Target.VersionNum == 3 && (this.Target.SubVersion == 4 || this.Target.SubVersion == 12) && !GA.IsCTVMember())
    {
      long num2 = frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.TLCStamp;
      if (this.MyFlag.TLCStamp > 0L && num2 < (long) (60000 * num1))
      {
        flag1 = true;
        int num3 = (int) num2 / 60000;
        GA.ShowBalloon(frmMain.langTLCLimitTime, "", this, 5000, (object) (num1 - num3));
      }
    }
    int itemIndex1 = -1;
    int itemIndex2 = -1;
    if (this.Settings.cboxThoLinhChau && !flag1)
    {
      for (int index = 0; index < 30; ++index)
      {
        InventoryItem allItem = this.MyInventory.AllItems[index];
        if (allItem.ItemID == 30008007 || allItem.ItemID == 30505216 || allItem.ItemID == 30008030 || allItem.ItemID == 38001079)
        {
          if (index == 0)
            itemIndex2 = 0;
          if ((allItem.ItemMapID == this.Settings.MapID || allItem.ItemMapID == this.Myself.SavedMapID) && allItem.DinhViPhuTime > (byte) 0)
          {
            itemIndex1 = index;
            break;
          }
        }
      }
    }
    if (itemIndex1 >= 0)
    {
      if (this.Myself.HorseType != -1)
        this.CallMounting();
      while (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.dungphuStamp < 25000L && this.MyFlag.dungphuStamp > 0L)
        Thread.Sleep(200);
      this.CallUseItem(itemIndex1, this.Myself.ID);
      Thread.Sleep(7000);
      this.Myself.TargetX = this.Myself.SavedPosX;
      this.Myself.TargetY = this.Myself.SavedPosY;
      this.Myself.TargetMapID = this.Myself.SavedMapID;
      this.Myself.MoveFlashPos = true;
      this.Myself.UseAutoMove = false;
      this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
      this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
      this.Myself.LongMoveX = 0;
      this.Myself.LongMoveY = 0;
      this.Myself.LongMoveMapID = -1;
      this.Myself.IsLongMove = false;
    }
    else if (itemIndex2 == 0)
    {
      if (this.Myself.HorseType != -1)
        this.CallMounting();
      while (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.dungphuStamp < 25000L && this.MyFlag.dungphuStamp > 0L)
        Thread.Sleep(200);
      this.CallUseItem(itemIndex2, this.Myself.ID);
      Thread.Sleep(7000);
      this.Myself.TargetX = this.Myself.SavedPosX;
      this.Myself.TargetY = this.Myself.SavedPosY;
      this.Myself.TargetMapID = this.Myself.SavedMapID;
      this.Myself.MoveFlashPos = true;
      this.Myself.UseAutoMove = false;
      this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
      this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
      this.Myself.LongMoveX = 0;
      this.Myself.LongMoveY = 0;
      this.Myself.LongMoveMapID = -1;
      this.Myself.IsLongMove = false;
    }
    else
    {
      bool flag2 = true;
      if (this.Myself.MapID == this.Myself.SavedMapID && GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) this.Myself.SavedPosX, (double) this.Myself.SavedPosY) <= 35.0)
        flag2 = false;
      if (flag2)
        this.CallLenNgua();
      if (this.Myself.SavedMapID <= 2 || (double) this.Myself.SavedPosX <= 0.0 || (double) this.Myself.SavedPosY <= 0.0)
        return;
      this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
      this.Myself.LongMoveX = (int) this.Myself.SavedPosX;
      this.Myself.LongMoveY = (int) this.Myself.SavedPosY;
      this.Myself.LongMoveMapID = this.Myself.SavedMapID;
      this.Myself.MoveLongTrigger = true;
      if (this.Target.VersionNum != 3 && this.Target.VersionNum != 4)
        return;
      this.Myself.IsLongMove = true;
    }
  }

  public void LongMoveTrigger()
  {
    if (!this.Myself.MoveLongTrigger || this.Myself.IsPartyFollowed != (byte) 0 && !this.IsPartyKey() || this.Myself.CalcPathStamp.ElapsedMilliseconds < 1000L)
      return;
    this.Myself.CalcPathStamp.Reset();
    this.Myself.CalcPathStamp.Start();
    if (this.Myself.LongMoveMapID == this.Myself.MapID)
      this.MoveWithinMapFromLong();
    List<AdvancedPath> bestPath = this.CalculateBestPath(this.Myself.MapID, this.Myself.LongMoveMapID);
    if (bestPath != null)
    {
      if (this.Myself.LongMoveX == 0)
        this.Myself.LongMoveX = (int) this.Myself.TargetX;
      if (this.Myself.LongMoveY == 0)
        this.Myself.LongMoveY = (int) this.Myself.TargetY;
      if (this.Myself.LongMoveMapID == -1)
        this.Myself.LongMoveMapID = this.Myself.TargetMapID;
      this.Myself.IsTrader = false;
      this.Myself.PossiblePaths = bestPath;
      this.Myself.PossiblePaths[this.Myself.PossiblePaths.Count - 1].TempToX = this.Myself.LongMoveX;
      this.Myself.PossiblePaths[this.Myself.PossiblePaths.Count - 1].TempToY = this.Myself.LongMoveY;
      this.Myself.MinorStatus = AllEnums.CharStatuses.MOVE_LONG_PATH;
      this.ProcessLongMove();
    }
    else
    {
      if (bestPath != null)
        return;
      if (this.Myself.LongMoveX == 0)
        this.Myself.LongMoveX = (int) this.Myself.TargetX;
      if (this.Myself.LongMoveY == 0)
        this.Myself.LongMoveY = (int) this.Myself.TargetY;
      if (this.Myself.LongMoveMapID == -1)
        this.Myself.LongMoveMapID = this.Myself.TargetMapID;
      this.Myself.SavedMapID = this.Myself.LongMoveMapID;
      this.Myself.SavedPosX = (float) this.Myself.LongMoveX;
      this.Myself.SavedPosY = (float) this.Myself.LongMoveY;
      this.Myself.TargetMapID = this.Myself.SavedMapID;
      this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
      this.Myself.UseAutoMove = true;
      this.Myself.MoveAcrossMap = true;
      this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
      int targetMapId = this.Myself.TargetMapID;
      if (this.Myself.MapID != this.Myself.TargetMapID)
      {
        if (this.Myself.HorseType == -1)
          this.CallLenNgua();
        bool flag = this.NotTransitioning();
        if (this.Myself.ActionStatus == (byte) 2 || this.Myself.ActionStatus == (byte) 5 || !flag)
          return;
        if (targetMapId != 5001)
          this.CallOutMapMove((int) this.Myself.SavedPosX, (int) this.Myself.SavedPosY, targetMapId);
        else if (GA.IsBangMapID(this.Myself.MapID))
          this.CallResetAutoMove();
        else
          this.GoToMyBang();
      }
      else
        this.MoveWithinMapFromLong();
    }
  }

  private void MoveWithinMapFromLong()
  {
    this.Myself.IsTrader = false;
    if (this.Myself.LongMoveX == 0)
      this.Myself.LongMoveX = (int) this.Myself.PosX;
    if (this.Myself.LongMoveY == 0)
      this.Myself.LongMoveY = (int) this.Myself.PosY;
    this.Myself.TargetX = (float) this.Myself.LongMoveX;
    this.Myself.TargetY = (float) this.Myself.LongMoveY;
    this.Myself.UseAutoMove = false;
    this.Myself.MoveAcrossMap = false;
    this.Myself.TargetMapID = -1;
    this.Myself.MoveFlashPos = true;
    this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
  }

  public void WarpingToCity(bool thuhoach)
  {
    if (frmLogin.GAuto.Settings.AppMode == AllEnums.AutoModes.Lite)
      return;
    if (this.Myself.Status == AllEnums.CharStatuses.VETHANH)
    {
      if (this.Settings.MapID == -1)
      {
        this.Settings.MapID = this.Myself.MapID;
        this.Settings.SavedPosX = this.Myself.PosX;
        this.Settings.SavedPosY = this.Myself.PosY;
        this.Settings.SavedMapID = this.Myself.MapID;
      }
      if (this.Myself.veThanhFlagTimeStamp.ElapsedMilliseconds >= (long) this.Myself.VeThanhReset && this.Myself.MapID == this.Settings.MapID)
      {
        this.Myself.tempcboxVeThanhHetMau = this.Settings.cboxVeThanhHetMau;
        this.Myself.tempcboxVeThanhHetThucAn = this.Settings.cboxVeThanhHetThucAn;
        this.Myself.tempcboxVeThanhHetBNM = this.Settings.cboxVeThanhHetBNM;
        this.Myself.tempcboxFullThungVE = this.Settings.cboxFullThungVE;
        this.Settings.cboxVeThanhHetMau = false;
        this.Settings.cboxVeThanhHetThucAn = false;
        this.Settings.cboxVeThanhHetBNM = false;
        this.Settings.cboxFullThungVE = false;
        this.Myself.Status = AllEnums.CharStatuses.IDLE;
        this.Myself.veThanhAutoFlag = true;
        this.Myself.veThanhFlagTimeStamp.Reset();
        this.Myself.veThanhFlagTimeStamp.Start();
      }
    }
    if (this.Myself.veThanhAutoFlag && this.Myself.veThanhFlagTimeStamp.ElapsedMilliseconds >= (long) this.Myself.VeThanhRecheck)
    {
      this.Myself.veThanhAutoFlag = false;
      this.Settings.cboxVeThanhHetMau = this.Myself.tempcboxVeThanhHetMau;
      this.Settings.cboxVeThanhHetThucAn = this.Myself.tempcboxVeThanhHetThucAn;
      this.Settings.cboxVeThanhHetBNM = this.Myself.tempcboxVeThanhHetBNM;
      this.Settings.cboxFullThungVE = this.Myself.tempcboxFullThungVE;
    }
    if (this.Myself.HPPercent <= 0.0 || this.Myself.Status == AllEnums.CharStatuses.VETHANH || this.IsInCity() || GA.IsInPhuBan(this.Myself.MapID, this))
      return;
    bool flag = false;
    string str = "";
    if ((this.Myself.HPPercent < (double) this.Settings.numVeThanhHP || this.Myself.MPPercent < (double) this.Settings.numVeThanhMP) && this.Settings.HealMapID >= 0 && this.Settings.cboxVeThanhHetMau)
    {
      flag = true;
      str = frmMain.langHPMPUnderLimit;
    }
    if (!flag && (this.Settings.cboxVeThanhHetThucAn || this.Settings.cboxVeThanhHetBNM))
    {
      int num1 = 0;
      int minItemID;
      int maxItemID;
      this.GetPetFoodRange(out minItemID, out maxItemID);
      int num2 = 0;
      for (int index = 0; index < 30; ++index)
      {
        InventoryItem allItem = this.MyInventory.AllItems[index];
        if (allItem.ItemID == 30601004)
          num1 += (int) allItem.ItemCount;
        if (allItem.ItemID >= minItemID && allItem.ItemID <= maxItemID)
          num2 += (int) allItem.ItemCount;
      }
      if (num1 <= 0 && this.Settings.cboxVeThanhHetBNM)
      {
        flag = true;
        str = frmMain.langHetBNM;
      }
      if (num2 <= 0 && this.Settings.cboxVeThanhHetThucAn)
      {
        flag = true;
        str = frmMain.langHetPetFood;
      }
    }
    if (!flag && this.Settings.cboxFullThungVE && this.Myself.FullThungRoi && this.Settings.AIMode != AllEnums.AIModes.NHIEMVU && !GA.IsInPhuBan(this.Myself.MapID, this))
    {
      str = frmMain.langInventoryFull;
      flag = true;
      this.Myself.FullThungRoi = false;
    }
    if (!flag)
      return;
    this.Myself.isMuaDoTrain = false;
    if (this.Myself.MapID != this.Settings.MapID)
    {
      this.Myself.SavedMapID = this.Myself.MapID;
      this.Myself.SavedPosX = this.Myself.PosX;
      this.Myself.SavedPosY = this.Myself.PosY;
    }
    else
    {
      this.Myself.SavedMapID = this.Settings.MapID;
      this.Myself.SavedPosX = (float) (int) this.Settings.CenterX;
      this.Myself.SavedPosY = (float) (int) this.Settings.CenterY;
    }
    GA.WriteUserLog(str + frmMain.langWarpToCity, this);
    this.VeThanhMuaDo();
  }

  public void CallSendAdsPM(string name, string msg)
  {
    if (!(name != "") || !(msg != ""))
      return;
    this.CallSendMessage(3, GA.ConvertToVISCII(msg), ChatTarget: GA.ConvertToVISCII(name));
  }

  private bool isTrangBiItem(string type = "")
  {
    if (frmLogin.CompilingLanguage == "VN" && (type == "mão" || type == "y phục" || type == "hộ thủ" || type == "hài" || type == "hộ uyển" || type == "hộ kiên" || type == "yêu đai" || type == "hạng liên" || type == "giới chỉ" || type == "hộ phù" || type == "đao búa" || type == "thương bổng" || type == "đơn đoản" || type == "song đoản" || type == "phiến" || type == "khuyên" || type == "nỏ") || frmLogin.CompilingLanguage == "EN" && (type == "hat" || type == "garments" || type == "gloves" || type == "shoes" || type == "wristbands" || type == "shoulderpad" || type == "belt" || type == "necklace" || type == "ring" || type == "amulet" || type == "falchion" || type == "spear" || type == "one-handed" || type == "two-handed" || type == "fans" || type == "circle"))
      return true;
    if (!(frmLogin.CompilingLanguage == "CN"))
      return false;
    return type == "帽子" || type == "衣服" || type == "手套" || type == "鞋" || type == "护腕" || type == "护肩" || type == "腰带" || type == "项链" || type == "戒指" || type == "护符" || type == "刀斧类" || type == "枪棒类" || type == "单短类" || type == "双短类" || type == "扇类" || type == "环类" || type == "弩类";
  }

  private bool VatPhamQuy(int itemID, string name = "", string type = "")
  {
    if (this.Settings.cboxGiuVuKhi && (itemID >= 10400001 && itemID <= 10406016 || itemID >= 10430001 && itemID <= 10436103 || itemID >= 10200001 && itemID <= 10200030 || itemID >= 10201001 && itemID <= 10201030 || itemID >= 10202001 && itemID <= 10202030 || itemID >= 10203001 && itemID <= 10203030 || itemID >= 10204001 && itemID <= 10204030 || itemID >= 10205001 && itemID <= 10205030 || itemID >= 10206001 && itemID <= 10206030) || itemID >= 10141702 && itemID <= 10141790 || itemID >= 10300000 && itemID <= 10308179 || itemID >= 10155001 && itemID <= 10155007 || itemID >= 10156001 && itemID <= 10156005 || itemID >= 10158001 && itemID <= 10158005 || itemID >= 60000000 && itemID <= 60308010)
      return true;
    if (name != "" || type != "")
    {
      List<string> stringList = new List<string>()
      {
        "bí kíp",
        "bí tịch",
        "tàng bảo đồ"
      };
      if (stringList.Count > 0)
      {
        try
        {
          for (int index = stringList.Count - 1; index >= 0; --index)
          {
            string str = stringList[index];
            if (!string.IsNullOrEmpty(str) && (name != "" && name.ToLower().Contains(str.ToLower()) || type != "" && type.ToLower().Contains(str.ToLower())))
              return true;
          }
        }
        catch (Exception ex)
        {
          if (GA.isVipMember())
            GA.WriteUserLog(frmMain.langTreasureItemError, this);
        }
        return false;
      }
    }
    return false;
  }

  private bool IsInPhai()
  {
    if (this.Myself.Menpai == AllEnums.Menpais.QUYCOC && this.Myself.MapID == 496 || this.Myself.Menpai == AllEnums.Menpais.THIEULAM && this.Myself.MapID == 9 || this.Myself.Menpai == AllEnums.Menpais.DUONGMON && this.Myself.MapID == 521 || this.Myself.Menpai == AllEnums.Menpais.MODUNG && this.Myself.MapID == 195 || this.Myself.Menpai == AllEnums.Menpais.TINHTUC && this.Myself.MapID == 16 /*0x10*/ || this.Myself.Menpai == AllEnums.Menpais.TIEUDAO && this.Myself.MapID == 14 || this.Myself.Menpai == AllEnums.Menpais.THIENSON && this.Myself.MapID == 17 || this.Myself.Menpai == AllEnums.Menpais.THIENLONG && this.Myself.MapID == 13 || this.Myself.Menpai == AllEnums.Menpais.NGAMI && this.Myself.MapID == 15 || this.Myself.Menpai == AllEnums.Menpais.VODANG && this.Myself.MapID == 12 || this.Myself.Menpai == AllEnums.Menpais.MINHGIAO && this.Myself.MapID == 11)
      return true;
    return this.Myself.Menpai == AllEnums.Menpais.CAIBANG && this.Myself.MapID == 10;
  }

  private bool IsInPhaiMap()
  {
    return this.Myself.MapID >= 9 && this.Myself.MapID <= 17 || this.Myself.MapID == 521 || this.Myself.MapID == 195;
  }

  private bool IsInPhaiPhuBan()
  {
    return this.Myself.MapID >= 139 && this.Myself.MapID <= 147 || this.Myself.MapID == 522 || this.Myself.MapID == 200;
  }

  public List<AdvancedPath> CalculateBestPath(int fromMapID, int toMapID, bool isTrader = false)
  {
    if (this.Myself.bestPathPublic != null)
    {
      int mapId1 = this.Myself.bestPathPublic[0].MapID;
      int mapId2 = this.Myself.bestPathPublic[this.Myself.bestPathPublic.Count - 1].MapID;
      if (mapId1 == fromMapID && mapId2 == toMapID)
        return this.Myself.bestPathPublic;
    }
    List<List<AdvancedPath>> advancedPathListList = this.Settings.AIMode != AllEnums.AIModes.THUONGNHAN ? GA.BuildMapPath(fromMapID, toMapID) : GA.BuildMapPath(fromMapID, toMapID, true);
    List<AdvancedPath> bestPath = (List<AdvancedPath>) null;
    string str = "";
    foreach (List<AdvancedPath> advancedPathList in advancedPathListList)
    {
      foreach (AdvancedPath advancedPath in advancedPathList)
        str = $"{str}--> {advancedPath.MapName}";
      str += "\n";
    }
    if (advancedPathListList.Count > 0)
    {
      bestPath = advancedPathListList[0];
      if (!isTrader)
      {
        if (advancedPathListList.Count > 1)
        {
          int num1 = 0;
          foreach (AdvancedPath advancedPath in bestPath)
          {
            if (advancedPath.LUASupport)
              ++num1;
          }
          for (int index = 1; index < advancedPathListList.Count - 1; ++index)
          {
            List<AdvancedPath> advancedPathList = advancedPathListList[index];
            int num2 = 0;
            foreach (AdvancedPath advancedPath in advancedPathList)
            {
              if (advancedPath.LUASupport)
                ++num2;
            }
            if (this.Target.VersionNum == 3 || this.Target.VersionNum == 4)
            {
              if (num2 < num1)
              {
                num1 = num2;
                bestPath = advancedPathList;
              }
            }
            else if (num2 > num1)
            {
              num1 = num2;
              bestPath = advancedPathList;
            }
          }
        }
      }
      else if (advancedPathListList.Count > 1)
      {
        for (int index1 = advancedPathListList.Count - 1; index1 >= 0; --index1)
        {
          bool flag = false;
          if (advancedPathListList.Count >= 2)
          {
            for (int index2 = 0; index2 < advancedPathListList[index1].Count - 2; ++index2)
            {
              if (advancedPathListList[index1][index2].GateType == AllEnums.GateTypes.NPC)
              {
                flag = true;
                break;
              }
            }
          }
          if (flag)
            advancedPathListList.RemoveAt(index1);
        }
        bool flag1 = false;
        foreach (AdvancedPath advancedPath in bestPath)
        {
          if (advancedPath.GateType == AllEnums.GateTypes.NPC)
          {
            flag1 = true;
            break;
          }
        }
        if (flag1 && advancedPathListList.Count > 0)
          bestPath = advancedPathListList[0];
        for (int index = 1; index < advancedPathListList.Count - 1; ++index)
        {
          if (advancedPathListList[index].Count < bestPath.Count)
            bestPath = advancedPathListList[index];
        }
      }
      if (bestPath.Count > 0)
      {
        for (int index = 0; index < bestPath.Count; ++index)
        {
          if (bestPath[index].LUASupport)
          {
            this.Myself.LUAStartMap = bestPath[index];
            break;
          }
        }
        for (int index = bestPath.Count - 1; index >= 0; --index)
        {
          if (bestPath[index].LUASupport)
          {
            this.Myself.LUAEndMap = bestPath[index];
            break;
          }
        }
      }
    }
    if (bestPath != null)
      this.Myself.bestPathPublic = bestPath;
    return bestPath;
  }

  public void ProcessLongMove()
  {
    bool flag1 = true;
    if (this.Target.VersionNum == 4 && this.Settings.AIMode != AllEnums.AIModes.THUONGNHAN)
      flag1 = false;
    if (this.Target.VersionNum == 3)
    {
      flag1 = false;
      if (this.Settings.AIMode == AllEnums.AIModes.THUONGNHAN)
        flag1 = true;
    }
    bool flag2 = this.NotTransitioning();
    if (this.Myself.MinorStatus == AllEnums.CharStatuses.MOVE_LONG_PATH && this.Myself.ActionStatus != (byte) 5 && !this.Myself.IsPK && flag2 && flag1)
    {
      bool flag3 = false;
      if (this.Myself.Status == AllEnums.CharStatuses.GOGOGO && this.Myself.MoveLongStamp.ElapsedMilliseconds >= 1000L && flag2)
      {
        this.Myself.MoveLongStamp.Reset();
        this.Myself.MoveLongStamp.Start();
        flag3 = true;
      }
      if (!flag3 && this.Myself.Status != AllEnums.CharStatuses.GOGOGO)
        flag3 = true;
      if (flag3 && this.Myself.PossiblePaths.Count > 0)
      {
        bool flag4 = false;
        AdvancedPath advancedPath1 = (AdvancedPath) null;
        AdvancedPath advancedPath2 = (AdvancedPath) null;
        bool flag5 = false;
        bool flag6 = false;
        for (int index = 0; index < this.Myself.PossiblePaths.Count; ++index)
        {
          AdvancedPath possiblePath = this.Myself.PossiblePaths[index];
          if (this.Myself.MapID == possiblePath.MapID)
          {
            flag4 = true;
            advancedPath1 = possiblePath;
            if (advancedPath1.MapID == this.Myself.PossiblePaths[this.Myself.PossiblePaths.Count - 1].MapID)
            {
              flag5 = true;
              break;
            }
            advancedPath2 = this.Myself.PossiblePaths[index + 1];
            break;
          }
        }
        if (!flag4)
          this.Myself.PossiblePaths = this.CalculateBestPath(this.Myself.MapID, this.Myself.TargetMapID, this.Myself.IsManualMove);
        else if (advancedPath1 != null)
        {
          if (!flag5)
          {
            if (this.Myself.LUAEndMap != null && !this.Myself.IsTrader && !this.Myself.IsManualMove)
            {
              bool flag7 = this.NotTransitioning();
              if (this.Myself.LUAEndMap.MapID != this.Myself.MapID && flag7)
              {
                if (this.Myself.LUAEndMap == this.Myself.PossiblePaths[this.Myself.PossiblePaths.Count - 1])
                {
                  this.Myself.TargetX = (float) this.Myself.LUAEndMap.TempToX;
                  this.Myself.TargetY = (float) this.Myself.LUAEndMap.TempToY;
                  this.Myself.TargetMapID = this.Myself.LUAEndMap.MapID;
                }
                else
                {
                  this.Myself.TargetX = (float) this.Myself.LUAEndMap.GatePosX;
                  this.Myself.TargetY = (float) this.Myself.LUAEndMap.GatePosY;
                  this.Myself.TargetMapID = this.Myself.LUAEndMap.MapID;
                }
                if (advancedPath1.LUASupport)
                  flag6 = true;
                this.Myself.MoveAcrossMap = true;
              }
            }
            if (!flag6)
            {
              if (advancedPath2 != null)
              {
                bool flag8 = this.NotTransitioning();
                this.auto_paths_fix(ref advancedPath1.GatePosX, ref advancedPath1.GatePosY, ref advancedPath1.MapID, ref advancedPath1.NPC_ID);
                if (advancedPath1.GatePosX != 0 && advancedPath1.GatePosY != 0 && flag8)
                {
                  double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) advancedPath1.GatePosX, (double) advancedPath1.GatePosY);
                  if (advancedPath1.GateType == AllEnums.GateTypes.Portal || advancedPath1.GateType == AllEnums.GateTypes.NPC && distance > 2.0)
                  {
                    this.Myself.TargetX = (float) advancedPath1.GatePosX;
                    this.Myself.TargetY = (float) advancedPath1.GatePosY;
                    this.Myself.TargetMapID = advancedPath2.MapID;
                    this.Myself.MoveAcrossMap = false;
                    this.Myself.UseAutoMove = false;
                    this.Myself.MoveFlashPos = true;
                    this.Myself.AutoMoveConfirm = advancedPath1.GateType == AllEnums.GateTypes.Portal;
                  }
                  else if (advancedPath1.GateType == AllEnums.GateTypes.NPC && distance <= 3.0 && advancedPath1.NPC_ID >= 0)
                  {
                    QuaiIndividual quaiIndividual = this.SearchNPCByPos(advancedPath1.GatePosX, advancedPath1.GatePosY, 5);
                    if (quaiIndividual != null)
                      advancedPath1.NPC_ID = quaiIndividual.ID;
                    this.CallTalkNPC(0, 0, advancedPath1.NPC_ID);
                    this.CallTalkNPC(advancedPath1.NPCMenuTypeID_1, advancedPath1.NPCMenuIndex_1, advancedPath1.NPC_ID);
                    if (advancedPath1.NPCMenuTypeID_2 >= 0 && advancedPath1.NPCMenuIndex_2 >= 0)
                      this.CallTalkNPC(advancedPath1.NPCMenuTypeID_2, advancedPath1.NPCMenuIndex_2, advancedPath1.NPC_ID);
                    if (advancedPath1.NPCMenuTypeID_3 >= 0 && advancedPath1.NPCMenuIndex_3 >= 0)
                      this.CallTalkNPC(advancedPath1.NPCMenuTypeID_3, advancedPath1.NPCMenuIndex_3, advancedPath1.NPC_ID);
                    this.CallSendPortalConfirmation(advancedPath1.NPCMenuTypeID_1, advancedPath1.NPC_ID, advancedPath1.NPCMenuIndex_1);
                    this.Myself.LastPostStamp.Reset();
                    this.Myself.LastPostStamp.Start();
                  }
                }
              }
              else
                this.Myself.Status = AllEnums.CharStatuses.IDLE;
            }
            this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
            if (advancedPath1.LUASupport && flag6)
            {
              int targetMapId = this.Myself.TargetMapID;
              this.CallLenNgua();
              bool flag9 = this.NotTransitioning();
              if (this.Myself.ActionStatus != (byte) 2 && this.Myself.ActionStatus != (byte) 5 && flag9)
              {
                this.CallLenNgua();
                this.CallOutMapMove((int) this.Myself.TargetX, (int) this.Myself.TargetY, targetMapId);
                this.Myself.UseAutoMove = this.Target.VersionNum != 3 && this.Target.VersionNum != 4;
              }
            }
            this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
          }
          else
          {
            if (this.Myself.IsTrader && this.Settings.tboxIDBang != -1 && this.Settings.tBoxIDFriend != -1 && (this.Myself.MapID == this.Settings.tboxIDBang || this.Myself.MapID == this.Settings.tBoxIDFriend))
            {
              this.Settings.SavedPosX = (float) advancedPath1.TempToX;
              this.Settings.SavedPosY = (float) advancedPath1.TempToY;
            }
            if ((double) this.Settings.SavedPosX == 0.0)
              this.Settings.SavedPosX = (float) (int) this.Settings.CenterX;
            if ((double) this.Settings.SavedPosY == 0.0)
              this.Settings.SavedPosY = (float) (int) this.Settings.CenterY;
            if (GA.CalculateDistance((double) this.Settings.SavedPosX, (double) this.Settings.SavedPosY, (double) this.Myself.PosX, (double) this.Myself.PosY) > 2.0 && (double) this.Settings.SavedPosX > 0.0 && (double) this.Settings.SavedPosY > 0.0)
            {
              if (this.Myself.MapID != this.Settings.SavedMapID)
              {
                this.Myself.TargetX = (float) advancedPath1.TempToX;
                this.Myself.TargetY = (float) advancedPath1.TempToY;
                this.Myself.TargetMapID = this.Settings.SavedMapID;
                this.Myself.UseAutoMove = false;
                this.Myself.MoveAcrossMap = false;
                this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
                this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
                this.Myself.MoveFlashPos = true;
              }
              else if (this.Myself.MapID == this.Settings.SavedMapID && (double) this.Settings.SavedPosX != 0.0 && (double) this.Settings.SavedPosY != 0.0)
              {
                this.Myself.TargetX = this.Settings.SavedPosX;
                this.Myself.TargetY = this.Settings.SavedPosY;
                this.Myself.TargetMapID = this.Settings.SavedMapID;
                this.Myself.UseAutoMove = false;
                this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
                this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
                this.Myself.MoveFlashPos = true;
                this.Myself.MoveAcrossMap = false;
              }
            }
            else
            {
              this.Myself.MinorStatus = AllEnums.CharStatuses.IDLE;
              this.Myself.MoveLongTrigger = false;
              this.Myself.MoveFlashPos = false;
            }
          }
        }
      }
    }
    this.ResetJustWarped();
  }

  private void ProcessRegularMove()
  {
    bool flag1 = this.NotTransitioning();
    if (this.Myself.Status != AllEnums.CharStatuses.GOGOGO || this.Myself.ActionStatus == (byte) 5 || !flag1 || this.Myself.JustWarped || this.IsNhatBoc() || this.Myself.IsPartyFollowed != (byte) 0 && !this.IsPartyKey())
      return;
    if (this.Myself.isMessageBox_Self == 1)
      this.CallStartAutoMoveClick();
    if (this.Myself.TargetMapID == 5001)
    {
      if (!GA.IsBangMapID(this.Myself.MapID))
        return;
      this.CallResetAutoMove();
    }
    else if ((double) Math.Abs(this.Myself.PosX - this.Myself.TargetX) <= 3.0 && (double) Math.Abs(this.Myself.PosY - this.Myself.TargetY) <= 3.0)
    {
      bool flag2 = false;
      if (this.Myself.MoveAcrossMap)
      {
        if (this.Myself.MapID == this.Myself.TargetMapID)
          flag2 = true;
        if (GA.isInChienMinh(this.Myself.MapID) && GA.isInChienMinh(this.Myself.TargetMapID))
          flag2 = true;
      }
      else
        flag2 = true;
      if (!flag2)
        return;
      if (this.Myself.MapID == this.Myself.LongMoveMapID || this.Myself.MapID == this.Myself.TargetMapID)
      {
        this.Myself.LongMoveX = 0;
        this.Myself.LongMoveY = 0;
        this.Myself.LongMoveMapID = -1;
        this.Myself.IsLongMove = false;
        this.Myself.SavedPosX = 0.0f;
        this.Myself.SavedPosY = 0.0f;
        this.Myself.SavedMapID = -1;
        this.Settings.SavedPosX = 0.0f;
        this.Settings.SavedPosY = 0.0f;
        this.Settings.SavedMapID = -1;
        this.Myself.MoveLongTrigger = false;
        if (this.Myself.SavedStatus == AllEnums.CharStatuses.GOGOGO)
          this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
        this.Myself.MinorStatus = AllEnums.CharStatuses.IDLE;
      }
      if (this.Myself.MapID == this.Settings.SavedMapID)
      {
        this.Settings.SavedPosX = 0.0f;
        this.Settings.SavedPosY = 0.0f;
        this.Settings.SavedMapID = -1;
        this.Myself.MinorStatus = AllEnums.CharStatuses.IDLE;
      }
      this.Myself.TargetX = 0.0f;
      this.Myself.TargetY = 0.0f;
      this.Myself.TargetMapID = -1;
      this.Myself.MoveFlashPos = false;
      this.Myself.UseAutoMove = false;
      this.Myself.MoveAcrossMap = false;
      this.Myself.Status = AllEnums.CharStatuses.IDLE;
      if (this.Myself.MinorStatus == AllEnums.CharStatuses.MOVE_LONG_PATH && this.Myself.AutoMoveStamp.ElapsedMilliseconds >= 1000L)
      {
        this.Myself.MinorStatus = AllEnums.CharStatuses.IDLE;
        this.Myself.AutoMoveStamp.Reset();
        this.Myself.AutoMoveStamp.Start();
        if (this.Myself.Status == AllEnums.CharStatuses.LENLAIBAITRAIN)
        {
          this.Myself.Status = AllEnums.CharStatuses.IDLE;
          this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
          this.Myself.MinorStatus = AllEnums.CharStatuses.IDLE;
        }
        if (this.Myself.AutoMoveConfirm)
        {
          this.Myself.AutoMoveConfirm = false;
          if (this.Myself.MapID == this.Settings.tboxIDBang || this.Myself.MapID == this.Settings.tBoxIDFriend)
          {
            int mapId = this.Myself.MapID;
          }
        }
      }
      if (this.ScriptEngine.CurrentCommand != null)
      {
        switch (this.ScriptEngine.CurrentCommand.Command.ToLower())
        {
          case "move":
          case "moveto":
          case "dichuyen":
          case "khaikhoang":
          case "haiduoc":
            this.ScriptEngine.CurrentCommand.Status = AllEnums.ScriptStatuses.FINISHED;
            break;
          case "moveattack":
            this.ScriptEngine.CurrentCommand.MinorStatus = AllEnums.ScriptStatuses.FINISHED;
            break;
        }
      }
      if (this.Myself.IsPartyFollowed == (byte) 1 && this.IsPartyKey() && this.Settings.AIMode != AllEnums.AIModes.NHIEMVU)
      {
        if (!this.IsInCity() && !this.IsInPhaiMap())
          this.CallRemovePartyFollow();
        GA.ResetStatusParty(this);
      }
      if (this.Myself.MinorStatus2 == AllEnums.CharStatuses.TRIEUTAP)
        this.Myself.MinorStatus2 = AllEnums.CharStatuses.IDLE;
      if (this.Myself.SavedStatus == AllEnums.CharStatuses.NHATBOC)
      {
        this.MyBoc.nhatBocTimeStamp.Reset();
        this.MyBoc.nhatBocTimeStamp.Start();
        Thread.Sleep(100);
        this.CallThocBocFunc(this.Myself.TargetBocID);
        this.PickupItems();
        Thread.Sleep(100);
        this.Myself.TargetBocID = 0;
      }
      else
      {
        if (this.Myself.SavedStatus == AllEnums.CharStatuses.IDLE)
          return;
        if (this.Myself.SavedStatus == AllEnums.CharStatuses.VETHANH && !this.IsInCity())
          this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
        this.Myself.Status = this.Myself.SavedStatus;
      }
    }
    else
    {
      bool flag3 = this.IsMoveStuck();
      if (this.Myself.MapID == this.Myself.TargetMapID)
        this.Myself.UseAutoMove = false;
      if (this.Myself.UseAutoMove || flag3)
        return;
      bool flag4 = false;
      int myType = 1;
      bool flag5 = false;
      if ((this.Myself.IsTrader && this.Settings.cboxTNChayNhanh || this.Myself.IsKhaiKhoang) && this.Myself.IsPartyFollowed == (byte) 0 && this.Myself.HorseType == -1 && this.Myself.MPPercent >= 5.0 && !GA.IsInPhuBan(this.Myself.MapID, this))
      {
        int delay1 = 999;
        int delay2 = 999;
        this.GetRunDelay(out delay1, out delay2);
        if (this.Myself.Menpai == AllEnums.Menpais.THIENSON)
        {
          if (delay2 <= 0 && this.MySkills.HasSkill(503))
          {
            myType = 2;
            flag4 = true;
          }
          else if (delay1 <= 0 && this.MySkills.HasSkill(494))
          {
            myType = 1;
            flag4 = true;
          }
        }
        else if (delay1 <= 0 && this.MySkills.HasSkill(this.Myself.MenpaiRunSkill))
          flag4 = true;
        if (this.Myself.ActionStatus == (byte) 2 && flag4)
        {
          flag5 = true;
          this.CallRunSkill(myType);
          Thread.Sleep(200);
          switch (myType)
          {
            case 1:
              this.Myself.RunSkillStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
              break;
            case 2:
              this.Myself.RunSkillStamp2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
              break;
          }
        }
      }
      bool flag6 = this.NotTransitioning();
      if (this.Myself.LastTimeMove.ElapsedMilliseconds < 2000L && !flag5 || this.Myself.ActionStatus == (byte) 5 || this.Myself.ActionStatus == (byte) 2 || !flag6)
        return;
      bool flag7 = false;
      if ((this.Settings.TraderMode == AllEnums.TraderModes.Chạy_Đi && this.Myself.MapID == this.Settings.tBoxIDFriend || this.Settings.TraderMode == AllEnums.TraderModes.Chạy_Về && this.Myself.MapID == this.Settings.tboxIDBang) && this.Myself.IsTrader && !this.Myself.TradeMoveTemp)
      {
        double distance1 = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, 149.0, 56.0);
        double distance2 = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, 99.0, 85.0);
        if (distance2 > 4.0 && distance2 < distance1)
        {
          flag7 = true;
          this.CallMoveFlashPos(99, 85);
          this.Myself.LastTimeMove.Reset();
          this.Myself.LastTimeMove.Start();
        }
        else
          this.Myself.TradeMoveTemp = true;
      }
      if (this.Myself.MapID == 5 && this.Settings.AIMode == AllEnums.AIModes.THUONGNHAN && this.Myself.IsTrader && !this.Myself.TradeMoveTemp)
      {
        int num1 = 157;
        int num2 = 150;
        double distance3 = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) (int) this.Myself.TargetX, (double) (int) this.Myself.TargetY);
        double distance4 = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num1, (double) num2);
        if (distance4 > 4.0 && distance4 < distance3)
        {
          flag7 = true;
          this.CallMoveFlashPos(num1, num2);
          this.Myself.LastTimeMove.Reset();
          this.Myself.LastTimeMove.Start();
        }
        else
          this.Myself.TradeMoveTemp = true;
      }
      if (this.Myself.MapID == 1 || this.Myself.MapID == 6)
        this.Myself.TradeMoveTemp = false;
      if (flag7)
        return;
      int num = this.Myself.MoveAcrossMap ? 1 : 0;
      if (!this.Myself.MoveFlashPos)
      {
        if (this.Target.VersionNum == 3 && this.Myself.MapID == 18 && (double) this.Myself.TargetX == 247.0 && (double) this.Myself.TargetY == 32.0)
        {
          this.Myself.TargetX = 248f;
          this.Myself.TargetY = 37f;
        }
        this.CallMoveTo((int) this.Myself.TargetX, (int) this.Myself.TargetY);
        this.Myself.LastTimeMove.Reset();
        this.Myself.LastTimeMove.Start();
      }
      else
      {
        if (!this.Myself.MoveFlashPos)
          return;
        this.CallMoveFlashPos((int) this.Myself.TargetX, (int) this.Myself.TargetY);
        this.Myself.LastTimeMove.Reset();
        this.Myself.LastTimeMove.Start();
        if ((double) this.Myself.ToX != 0.0 || (double) this.Myself.ToY != 0.0 || this.Myself.ActionStatus != (byte) 2)
          return;
        this.CallMoveTo((int) this.Myself.PosX, (int) this.Myself.PosY);
      }
    }
  }

  private void GetRunDelay(out int delay1, out int delay2)
  {
    if (this.Myself.Menpai == AllEnums.Menpais.TIEUDAO)
    {
      delay1 = this.MySkills.ChayNhanhDelay1;
      delay2 = 999;
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.CAIBANG)
    {
      delay1 = this.MySkills.ChayNhanhDelay1;
      delay2 = 999;
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.THIEULAM)
    {
      delay1 = this.MySkills.ChayNhanhDelay1;
      delay2 = 999;
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.DUONGMON)
    {
      delay1 = this.MySkills.ChayNhanhDelay1;
      delay2 = 999;
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.THIENLONG)
    {
      delay1 = this.MySkills.ChayNhanhDelay1;
      delay2 = 999;
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.THIENSON)
    {
      delay1 = this.MySkills.ChayNhanhDelay1;
      delay2 = this.MySkills.ChayNhanhDelay3;
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.NGAMI)
    {
      delay1 = 999;
      delay2 = 999;
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.TINHTUC)
    {
      delay1 = 999;
      delay2 = 999;
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.VODANG)
    {
      delay1 = this.MySkills.ChayNhanhDelay2;
      delay2 = 999;
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.MODUNG)
    {
      delay1 = this.MySkills.ChayNhanhDelay1;
      delay2 = 999;
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.MINHGIAO)
    {
      delay1 = this.MySkills.ChayNhanhDelay1;
      delay2 = 999;
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.QUYCOC)
    {
      delay1 = this.MySkills.ChayNhanhDelay1;
      delay2 = 999;
    }
    else
    {
      delay1 = 999;
      delay2 = 999;
    }
  }

  private bool IsMoveStuck()
  {
    bool flag1 = false;
    bool flag2 = false;
    if (this.MyParty.PartyNumbers > 0 && !this.IsPartyKey() && this.Myself.IsPartyFollowed == (byte) 1)
      flag2 = true;
    if (this.Myself.isSceneTrans == 1 || this.Myself.ActionStatus == (byte) 7 || this.Myself.ActionStatus == (byte) 5 || this.Myself.ActionStatus == (byte) 8 || this.Myself.IsCheDo || flag2 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.talkNPCStamp < 15000L && this.MyFlag.talkNPCStamp > 0L)
    {
      this.Myself.LastPostStamp.Reset();
      this.Myself.LastPostStamp.Start();
    }
    if (this.Myself.LastPostStamp.ElapsedMilliseconds >= 5000L)
    {
      this.Myself.LastPostStamp.Reset();
      this.Myself.LastPostStamp.Start();
      bool flag3 = this.NotTransitioning();
      int num = 1;
      if (this.Settings.AIMode == AllEnums.AIModes.NHIEMVU)
        num = 2;
      if ((double) Math.Abs(this.Myself.PosX - this.Myself.Last3SecX) <= (double) num && (double) Math.Abs(this.Myself.PosY - this.Myself.last3SecY) <= (double) num && this.Myself.MapID == this.Myself.Last3SecMapID && this.Myself.isSceneTrans <= 0 && !this.Myself.JustWarped)
        flag1 = true;
      if (!flag1 && this.Myself.flagMoveStuck && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.flagMoveStuckStamp <= 60000L && !this.Myself.JustWarped && this.Myself.isSceneTrans <= 0)
        flag1 = true;
      if (!flag1 && this.Myself.ActionStatus != (byte) 5 && this.Myself.ActionStatus != (byte) 6)
      {
        this.Myself.Last3SecX = this.Myself.PosX;
        this.Myself.last3SecY = this.Myself.PosY;
        this.Myself.Last3SecMapID = this.Myself.MapID;
      }
      if (flag1 && flag3)
      {
        bool flag4 = true;
        if (this.Myself.MapID == 3 && GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, 221.0, 205.0) < 20.0)
        {
          this.CallMoveTo(199, 205);
          Thread.Sleep(10000);
          flag4 = false;
        }
        if (flag4)
        {
          Random random = new Random();
          this.Myself.LastTimeMove.Reset();
          this.Myself.LastTimeMove.Start();
          long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          int X = (int) this.Myself.PosX + random.Next(-5, 5);
          int Y = (int) this.Myself.PosY + random.Next(-5, 5);
          int posX = (int) this.Myself.PosX;
          int posY = (int) this.Myself.PosY;
          while (this.IsAIEnabled)
          {
            this.CallMoveTo(X, Y);
            Thread.Sleep(300);
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 >= 1000L)
            {
              elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
              if (this.Myself.ActionStatus == (byte) 0)
              {
                X = (int) this.Myself.PosX + random.Next(-5, 5);
                Y = (int) this.Myself.PosY + random.Next(-5, 5);
              }
            }
            if (Math.Abs(posX - X) >= 1 || Math.Abs(posY - Y) >= 1)
            {
              this.ResetMoveStuckFlag();
              Thread.Sleep(500);
              return false;
            }
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 >= 10000L)
              break;
          }
        }
        this.Myself.LastPostStamp.Reset();
        this.Myself.LastPostStamp.Start();
      }
    }
    return flag1;
  }

  private void ResetMoveStuckFlag() => new MessageFunc().Message = 2010;

  private bool CheckNeedToBuy()
  {
    bool buy = false;
    if (this.Settings.ListItemToBuy.Count > 0)
    {
      foreach (ItemToBuy itemToBuy in (List<ItemToBuy>) this.Settings.ListItemToBuy)
      {
        if (itemToBuy.Amount > 0)
        {
          int num = 0;
          for (int index = 0; index < 30; ++index)
          {
            InventoryItem allItem = this.MyInventory.AllItems[index];
            if (allItem.ItemID == itemToBuy.ID)
              num += (int) allItem.ItemCount;
          }
          if (num < itemToBuy.Amount)
          {
            buy = true;
            break;
          }
        }
      }
    }
    return buy;
  }

  private bool CheckToBuyItem(ItemToBuy item)
  {
    int num = 0;
    for (int index = 0; index < 30; ++index)
    {
      InventoryItem allItem = this.MyInventory.AllItems[index];
      if (allItem.ItemID == item.ID)
        num += (int) allItem.ItemCount;
    }
    bool buyItem;
    if (num < item.Amount)
    {
      buyItem = false;
      item.RealAmountToBuy = item.Amount - num;
    }
    else
      buyItem = true;
    return buyItem;
  }

  internal void CallUpdateHotKey(int sequence, int keyValue)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_UPDATEHOTKEY, (IntPtr) sequence, (IntPtr) keyValue);
  }

  private void SaveSkillList(object list, string key)
  {
    string str = "";
    foreach (SkillPlayItem skillPlayItem in (List<SkillPlayItem>) (list as GAutoList<SkillPlayItem>))
    {
      if (key != "SkillBuffList")
        str = $"{str}{$"{skillPlayItem.SkillItem.ID};{skillPlayItem.SkillItem.Name};{skillPlayItem.SkillDelayInSecond.ToString("0")};{skillPlayItem.IsEnabled.ToString()}"}|";
      else if (key == "SkillBuffList")
        str = $"{str}{$"{skillPlayItem.SkillItem.ID};{skillPlayItem.SkillItem.Name};{skillPlayItem.SkillDelayInSecond.ToString("0")};{skillPlayItem.WaitingTime.ToString("0")};{skillPlayItem.BuffSelf.ToString()};{skillPlayItem.BuffParty.ToString()};{skillPlayItem.BuffList.ToString()};{skillPlayItem.BuffArmy.ToString()};{skillPlayItem.IsEnabled.ToString()}"}|";
    }
    this.Settings.SaveSingleSetting(key, str);
  }

  private void SaveSchedulerEventList(object list, string key)
  {
    string str = "";
    foreach (GEventClass geventClass in (List<GEventClass>) (list as GAutoList<GEventClass>))
    {
      if (key == "ListScheduler")
        str += $"{geventClass.FormatHour};{geventClass.EventName}|";
    }
    this.Settings.SaveSingleSetting(key, str);
  }

  private void SaveListItemToBuy(object list)
  {
    if (!this.Settings.AllInformationLoaded)
      return;
    string str = "";
    foreach (ItemToBuy itemToBuy in (List<ItemToBuy>) (list as GAutoList<ItemToBuy>))
      str = $"{str}{$"{itemToBuy.ID};{itemToBuy.Amount}"}|";
    this.Settings.SaveSingleSetting("ListItemToBuy", str);
  }

  private void SaveListItemToUse(object list)
  {
    if (!this.Settings.AllInformationLoaded)
      return;
    string str = "";
    foreach (ItemToUse itemToUse in (List<ItemToUse>) (list as GAutoList<ItemToUse>))
      str = $"{str}{$"{itemToUse.Name};{itemToUse.DelaySeconds}"}|";
    this.Settings.SaveSingleSetting("ListItemToUse", str);
  }

  private void SaveStringList(object list, string keyname)
  {
    string str1 = "";
    foreach (string str2 in (List<string>) (list as GAutoList<string>))
      str1 = $"{str1}{str2}|";
    this.Settings.SaveSingleSetting(keyname, str1, "Danh sách các món đồ không nhặt");
  }

  private void SaveIntList(object list, string keyname)
  {
    string str = "";
    foreach (int num in (List<int>) (list as GAutoList<int>))
      str = $"{str}{num.ToString()}|";
    this.Settings.SaveSingleSetting(keyname, str, "Nhìn cái gì?");
  }

  public void AutoPartyList_OnRemove(object sender, EventArgs e)
  {
    this.SaveStringList(sender, "AutoPartyList");
  }

  public void QuaiNoAttackList_OnRemove(object sender, EventArgs e)
  {
    this.SaveStringList(sender, "QuaiNoAttackList");
  }

  public void QuaiNoAttackList_OnAdd(object sender, EventArgs e)
  {
    this.SaveStringList(sender, "QuaiNoAttackList");
  }

  public void PTBlacklist_OnRemove(object sender, EventArgs e)
  {
    this.SaveStringList(sender, "PTBlacklist");
  }

  public void PTBlacklist_OnAdd(object sender, EventArgs e)
  {
    this.SaveStringList(sender, "PTBlacklist");
  }

  public void AutoPartyList_OnAdd(object sender, EventArgs e)
  {
    this.SaveStringList(sender, "AutoPartyList");
  }

  public void ListItemNhatIgnore_OnAdd(object sender, EventArgs e)
  {
    this.SaveStringList(sender, "ListItemNhatIgnore");
  }

  public void ListItemNhatIgnore_OnRemove(object sender, EventArgs e)
  {
    this.SaveStringList(sender, "ListItemNhatIgnore");
  }

  public void SkillBuffList_OnRemove(object sender, EventArgs e)
  {
    this.SaveSkillList(sender, "SkillBuffList");
  }

  public void SkillBuffList_OnAdd(object sender, EventArgs e)
  {
    this.SaveSkillList(sender, "SkillBuffList");
  }

  public void ListScheduler_OnRemove(object sender, EventArgs e)
  {
    this.SaveSchedulerEventList(sender, "ListScheduler");
  }

  public void ListScheduler_OnAdd(object sender, EventArgs e)
  {
    this.SaveSchedulerEventList(sender, "ListScheduler");
  }

  public void PKBangList_OnRemove(object sender, EventArgs e)
  {
    this.SaveIntList(sender, "PKBangList");
  }

  public void PKBangList_OnAdd(object sender, EventArgs e)
  {
    this.SaveIntList(sender, "PKBangList");
  }

  public void PKPlayerList_OnRemove(object sender, EventArgs e)
  {
    this.SaveStringList(sender, "PKPlayerList");
  }

  public void PKPlayerList_OnAdd(object sender, EventArgs e)
  {
    this.SaveStringList(sender, "PKPlayerList");
  }

  public void PKBlackList_OnRemove(object sender, EventArgs e)
  {
    this.SaveStringList(sender, "PKBlackList");
  }

  public void PKBlackList_OnAdd(object sender, EventArgs e)
  {
    this.SaveStringList(sender, "PKBlackList");
  }

  internal void SkillPKList_OnAdd(object sender, EventArgs e)
  {
    this.SaveSkillList(sender, "SkillPKList");
  }

  internal void SkillPKList_OnRemove(object sender, EventArgs e)
  {
    this.SaveSkillList(sender, "SkillPKList");
  }

  public void SkillPlayList_OnRemove(object sender, EventArgs e)
  {
    this.SaveSkillList(sender, "SkillPlayList");
  }

  public void SkillPlayList_OnAdd(object sender, EventArgs e)
  {
    this.SaveSkillList(sender, "SkillPlayList");
  }

  public void ListItemToUse_OnAdd(object sender, EventArgs e) => this.SaveListItemToUse(sender);

  public void ListItemToUse_OnRemove(object sender, EventArgs e) => this.SaveListItemToUse(sender);

  public void ListItemToBuy_OnRemove(object sender, EventArgs e) => this.SaveListItemToBuy(sender);

  public void ListItemToBuy_OnAdd(object sender, EventArgs e) => this.SaveListItemToBuy(sender);

  public void CallPhatTest(string string1 = "", string string2 = "", int int1 = 0, int int2 = 0, int int3 = 0)
  {
    this.Target.SendMessageCommand(frmLogin.GAuto.Settings.WM_PHATTEST, new MyParamsClass()
    {
      string1 = string1,
      string2 = string2,
      myInt1 = int1,
      myInt2 = int2,
      myInt3 = int3
    });
  }

  public void CallPhatTest2(string string1 = "", string string2 = "", int int1 = 0, int int2 = 0, int int3 = 0)
  {
    this.Target.SendMessageCommand(frmLogin.GAuto.Settings.WM_PHATTEST2, new MyParamsClass()
    {
      string1 = string1,
      string2 = string2,
      myInt1 = int1,
      myInt2 = int2,
      myInt3 = int3
    });
  }

  public void AdjustDelay(int ms = 200)
  {
    if (ms < 200)
      ms = 200;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_SETDELAY, (IntPtr) ms, (IntPtr) 0);
  }

  internal void CallDanhHieuOnOff(int myValue)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_TITLEONOFF, (IntPtr) myValue, (IntPtr) 0);
  }

  internal void CallSoiItemOnOff(int myValue)
  {
    this.Myself.isGiamDinh = myValue == 1;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_SIFLAG, (IntPtr) myValue, (IntPtr) 0);
  }

  public void CallPhatTest3(string string1 = "", string string2 = "", int int1 = 0, int int2 = 0, int int3 = 0)
  {
    this.Target.SendMessageCommand(frmLogin.GAuto.Settings.WM_PHATTEST3, new MyParamsClass()
    {
      string1 = string1,
      string2 = string2,
      myInt1 = int1,
      myInt2 = int2,
      myInt3 = int3
    });
  }

  public void CallResetInformation()
  {
    this.WriteFuncParams(new MessageFunc()
    {
      Message = 2000
    });
  }

  public void WriteFuncParams(MessageFunc msgParams)
  {
    this.Target.Ring3[(int) ((this.Target.funcWriteIndex + 1L) % (long) this.Target.funcBufferLength)] = msgParams;
    ++this.Target.funcWriteIndex;
  }

  public void CallSelectTarget(int targetID)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_SELECTTARGET, (IntPtr) 0, (IntPtr) targetID);
  }

  public void CallSendMessage(int channel, string message, bool userSend = false, string ChatTarget = "")
  {
    if (this.MyFlag.IsBlockedChat)
      return;
    bool flag = true;
    if (this.Myself.BangID == 0 && channel == 6)
      flag = false;
    if (this.Myself.DongMinhID == 0 && channel == 12)
      flag = false;
    if (this.Myself.Level < 15 && channel == 2)
      flag = false;
    if (channel == 3 && ChatTarget == string.Empty)
      flag = false;
    if (this.Myself.JustWarped || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.WarpStamp < 15000L || this.Myself.ID <= 0 || !flag || !(message != ""))
      return;
    if (userSend && frmLogin.GAuto.Settings.AppMode == AllEnums.AutoModes.Lite)
    {
      if (this.Target.VersionNum < 4)
        message += " #ecc33cc(GAuto -> gam/eauto. net)";
      else if (this.Target.VersionNum == 4)
        message += " #ecc33cc(AutoTL -> tianlongauto.net)";
      else if (this.Target.VersionNum >= 7 && this.Target.VersionNum <= 8)
        message += " #ecc33cc(123bot)";
      else if (this.Target.VersionNum >= 5 && this.Target.VersionNum <= 6)
        message += " #ecc33cc(123自动 -》 123bot.net)";
    }
    MyControlClass msgParams = new MyControlClass();
    msgParams.string1 = message;
    switch (channel)
    {
      case 3:
        msgParams.string2 = ChatTarget;
        break;
      case 6:
        this.CallSendChatGroupID(this.Myself.BangID);
        break;
      case 12:
        this.CallSendChatGroupID(this.Myself.DongMinhID);
        break;
    }
    this.Target.SendControlMessage(frmLogin.GAuto.Settings.WM_SENDCHAT, msgParams, ref this.Target.ChatAlloc, channel);
  }

  public void CallSendChatGroupID(int groupID)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_SENDCHATID, (IntPtr) groupID, (IntPtr) 0);
  }

  public void CallPickAllItems()
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_PICKALLITEMS, (IntPtr) 0, (IntPtr) 0);
  }

  public void CallPickAllItemsList(int bocID)
  {
    if (this.MyBoc.AllItems.Count <= 0)
      return;
    try
    {
      for (int index = this.MyBoc.AllItems.Count - 1; index >= 0; --index)
      {
        ItemTrongBoc allItem = this.MyBoc.AllItems[index];
        this.CallPickItemPacket(bocID, allItem.itemGUID1, allItem.itemGUID2);
      }
    }
    catch (Exception ex)
    {
      GA.WriteUserLog(frmMain.langPickAllError, this);
    }
  }

  public void HuyNhiemVu(int menuType)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_HUYNHIEMVU, (IntPtr) menuType, (IntPtr) 0);
  }

  public void OpenKNBShop(int indexMenu, int indexSubMenu)
  {
    if (this.Target.SubVersion == 10)
      return;
    if (this.Target.SubVersion == 12)
      indexMenu += 100;
    this.RemovePartyFollowForce();
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_OPENSHOPKNB, (IntPtr) indexMenu, (IntPtr) indexSubMenu);
  }

  public void BuyKNBItem(int indexItem, int mapID = -1)
  {
    if (this.Target.SubVersion == 10)
      return;
    mapID = this.Myself.MapID;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_BUYITEMKNB, (IntPtr) indexItem, (IntPtr) mapID);
  }

  public void CallLeavePT()
  {
    if (this.Myself == null)
      return;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_PTLEAVE, (IntPtr) this.Myself.DatabaseID, (IntPtr) 0);
  }

  public void CallTransferPTKey(int nextDBID, int nextDBID2)
  {
    if (this.Myself == null)
      return;
    if (GA.CheckGameVersion(this.Target.VersionNum) == 356)
    {
      MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_PTTRANSFER, (IntPtr) this.Myself.DatabaseID, (IntPtr) nextDBID);
      MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_PTTRANSFER_1, (IntPtr) this.Myself.DatabaseIDLow, (IntPtr) nextDBID2);
    }
    else
      MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_PTTRANSFER, (IntPtr) this.Myself.DatabaseID, (IntPtr) nextDBID);
  }

  public void GivePetToNPC(
    int npcID,
    int menuIndex,
    int menuType,
    int petIndex,
    int myDBID,
    int petID)
  {
    if (this.Target.VersionNum == 3)
      return;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_TALKNPCPET_1, (IntPtr) npcID, (IntPtr) menuIndex);
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_TALKNPCPET_2, (IntPtr) menuType, (IntPtr) petIndex);
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_TALKNPCPET, (IntPtr) myDBID, (IntPtr) petID);
  }

  public void CallBuyTN(int castle, int itemID)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_TNBUYITEM, (IntPtr) castle, (IntPtr) itemID);
  }

  public void CallSellTN(int GUID1, int GUID2)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_TNSELLITEM, (IntPtr) GUID1, (IntPtr) GUID2);
  }

  public void CallBringWindowUp(IntPtr handle, int myType = 0)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_BRINGMEUP, handle, (IntPtr) myType);
  }

  public void SaveWindowHandle()
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_SAVEHANDLE, this.Target.MainWindowHandle, (IntPtr) 0);
  }

  public void CallHideWindow(IntPtr handle, int myType)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_HIDEGAME, handle, (IntPtr) myType);
  }

  public void CallSendPortalConfirmation(int menuID = 805021, int NPC_ID = 9999, int menuIndex = 538)
  {
    if (this.Target.VersionNum == 3 || this.Target.VersionNum == 4 || this.Myself.JustWarped || this.Myself.isSceneTrans == 1 || this.Myself.ID <= 0 || !this.CustomSleep(12, 3000))
      return;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_PORTALCONFIRM_1, (IntPtr) menuID, (IntPtr) 0);
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_PORTALCONFIRM, (IntPtr) NPC_ID, (IntPtr) menuIndex);
    this.Myself.MoveLongStamp.Reset();
    this.Myself.MoveLongStamp.Start();
    this.Myself.CalcPathStamp.Reset();
    this.Myself.CalcPathStamp.Start();
  }

  public void CallNhanNhiemVu()
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CLOSECONFIRMBOX, (IntPtr) 5, (IntPtr) 0);
  }

  public void CallStringWithEnv(int param, int param2 = -1)
  {
    if ((param == 32 /*0x20*/ || param == 33) && (this.Myself.JustWarped || this.Myself.isSceneTrans == 1 || this.Myself.ID <= 0))
      return;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CLOSECONFIRMBOX, (IntPtr) param, (IntPtr) param2);
  }

  public void CallKNBTab(int tabType, bool DDorDD)
  {
    int lParam = 191;
    if (!DDorDD)
      lParam = 193;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_SETKNB, (IntPtr) tabType, (IntPtr) lParam);
  }

  public void CallClickCheDo()
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CLOSECONFIRMBOX, (IntPtr) 7, (IntPtr) 0);
  }

  public void CallClickRuongTrongKho(int RuongIndex)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CLOSECONFIRMBOX, (IntPtr) 9, (IntPtr) RuongIndex);
  }

  public void CallClickItemInventory(int LineNum, int LineIndex)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CLOSECONFIRMBOX_1, (IntPtr) LineNum, (IntPtr) LineIndex);
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CLOSECONFIRMBOX, (IntPtr) 8, (IntPtr) 0);
  }

  public void CallClickTabInventory(int TabIndex)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CLOSECONFIRMBOX, (IntPtr) 10, (IntPtr) TabIndex);
  }

  public void CallClickSkillMenu(int menuIndex)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CLOSECONFIRMBOX, (IntPtr) 11, (IntPtr) menuIndex);
  }

  public void CallClickOpenInventory()
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CLOSECONFIRMBOX, (IntPtr) 12, (IntPtr) 0);
  }

  public void CallMuaKNB()
  {
    if (this.Target.VersionNum == 3)
      return;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CLOSECONFIRMBOX, (IntPtr) 6, (IntPtr) 0);
  }

  public void CallTraNhiemVu()
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CLOSECONFIRMBOX, (IntPtr) 4, (IntPtr) 0);
  }

  public void CallSendPortalConfirmationClick()
  {
    if (this.Target.VersionNum == 3 || this.Myself.JustWarped || this.Myself.isSceneTrans == 1 || this.Myself.ID <= 0 || !frmLogin.GAuto.Settings.TuDongYChuyenCanh || !this.CustomSleep(4, 1000))
      return;
    if (this.Myself.isAcceptBox == 1)
    {
      this.DoSomeThingDLL(5);
      MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CLOSECONFIRMBOX, (IntPtr) 1, (IntPtr) 0);
    }
    this.Myself.MoveLongStamp.Reset();
    this.Myself.MoveLongStamp.Start();
    this.Myself.CalcPathStamp.Reset();
    this.Myself.CalcPathStamp.Start();
    if (GA.CheckGameVersion(this.Target.VersionNum) != 356 || !this.Settings.FixLoiCuongChe)
      return;
    GA.WriteUserLog("Tự bấm bảng đồng ý 1", this);
  }

  public void CallServerClickTK(int serverID)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CLOSECONFIRMBOX, (IntPtr) 19, (IntPtr) serverID);
  }

  public void CallServerClick(int serverID)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CLOSECONFIRMBOX, (IntPtr) 13, (IntPtr) serverID);
  }

  public void CallInterfaceClick(int actionID)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CLOSECONFIRMBOX, (IntPtr) actionID, (IntPtr) 0);
  }

  public void CallEnableThread()
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ENABLETHREAD, (IntPtr) 0, (IntPtr) 0);
  }

  public void CallNPCSellItem(int inventoryIndex, int NPC_ID, int mapID)
  {
    if (inventoryIndex < 0 || inventoryIndex >= 60)
      return;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_NPCSELLITEM_1, (IntPtr) inventoryIndex, (IntPtr) NPC_ID);
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_NPCSELLITEM_2, (IntPtr) mapID, (IntPtr) 0);
  }

  public void CallSendDisconnect()
  {
    if (this.Target.VersionNum == 3 || this.Target.VersionNum == 4)
      return;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_DISCONNECT, (IntPtr) 0, (IntPtr) 0);
  }

  public void CallRemoveInventoryItem(int inventoryIndex)
  {
    if (inventoryIndex < 0 || inventoryIndex >= 60 || this.Myself.ID <= 0)
      return;
    InventoryItem allItem = this.MyInventory.AllItems[inventoryIndex];
    if (frmLogin.GAuto.Settings.ItemNotRemove.Contains(allItem.ItemID))
      return;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_REMOVEINVENTORYITEM_1, (IntPtr) inventoryIndex, (IntPtr) allItem.ItemGUID1);
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_REMOVEINVENTORYITEM, (IntPtr) allItem.ItemGUID2, (IntPtr) 0);
  }

  public void CallInventoryItemDetail(int inventoryIndex)
  {
    if (this.Myself.JustWarped || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.WarpStamp < 15000L || this.Myself.ID <= 0)
      return;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_INVENTORYDETAIL, (IntPtr) 0, (IntPtr) inventoryIndex);
  }

  public void SetDLLValue(int loai, int value)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CALLFUNCTION, (IntPtr) loai, (IntPtr) value);
  }

  public void CallEnterReconnect()
  {
    if (this.Target.VersionNum == 3 || this.Target.VersionNum == 4 || this.Target.VersionNum == 5 || this.Target.VersionNum == 6 || this.Target.VersionNum == 7 || this.Target.VersionNum == 8)
      return;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ENTERRECONNECT, (IntPtr) 0, (IntPtr) 0);
  }

  public void CallThocBocFunc(int bocID)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_THOCBOC, (IntPtr) 0, (IntPtr) bocID);
    this.Myself.Status = AllEnums.CharStatuses.NHATBOC;
    this.CheckPickStuck();
  }

  public bool CallThocBocPacket(int bocID, int bocX, int bocY, bool move = true)
  {
    if (bocX != 0 && bocY != 0)
    {
      double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) bocX, (double) bocY);
      if (distance > 2.0 && move)
        this.CallMoveFlashPos(bocX, bocY);
      if (distance <= 2.0 || !move)
      {
        if (GA.CheckGameVersion(this.Target.VersionNum) == 356)
        {
          if (bocID == this.MyFlag.savedBocID)
          {
            ++this.MyFlag.savedBocID_Count;
          }
          else
          {
            this.MyFlag.savedBocID_Count = 0;
            this.MyFlag.savedBocID = bocID;
          }
          if (this.MyFlag.savedBocID_Count >= 4)
          {
            this.CallThocBocFunc(bocID);
            return true;
          }
        }
        MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_THOCBOCPACKET, (IntPtr) 0, (IntPtr) bocID);
        return true;
      }
      this.Myself.Status = AllEnums.CharStatuses.NHATBOC;
      this.CheckPickStuck();
    }
    return false;
  }

  public void CallThocBocPacketNow(int bocID)
  {
    if (GA.CheckGameVersion(this.Target.VersionNum) == 356)
    {
      if (bocID == this.MyFlag.savedBocID)
      {
        ++this.MyFlag.savedBocID_Count;
      }
      else
      {
        this.MyFlag.savedBocID_Count = 0;
        this.MyFlag.savedBocID = bocID;
      }
      if (this.MyFlag.savedBocID_Count >= 4)
      {
        this.CallThocBocFunc(bocID);
        return;
      }
    }
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_THOCBOCPACKET, (IntPtr) 0, (IntPtr) bocID);
    this.CheckPickStuck();
  }

  public void CallPickItemPacket(int bocID, int GUID1, int GUID2)
  {
    if (GA.CheckGameVersion(this.Target.VersionNum) == 356)
    {
      if (GUID1 == this.MyFlag.savedItemTrongBocID && bocID == this.MyFlag.savedBocDangPickID)
      {
        ++this.MyFlag.savedItemTrongBocID_Count;
      }
      else
      {
        this.MyFlag.savedItemTrongBocID_Count = 0;
        this.MyFlag.savedItemTrongBocID = GUID1;
        this.MyFlag.savedBocDangPickID = bocID;
      }
      if (this.MyFlag.savedItemTrongBocID_Count >= 4)
      {
        this.CallPickAllItems();
        return;
      }
    }
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_PICKITEM_1, (IntPtr) bocID, (IntPtr) GUID1);
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_PICKITEM, (IntPtr) GUID2, (IntPtr) 0);
  }

  public void CallClearBoc(int bocID)
  {
    if (this.Target.VersionNum == 3)
      return;
    this.WriteFuncParams(new MessageFunc()
    {
      Message = 2001,
      int1 = bocID
    });
  }

  public void CallOutGame()
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_OUTGAME, (IntPtr) 0, (IntPtr) 0);
  }

  public void CallRequestPartyFollow()
  {
    if (this.Myself.isSceneTrans == 1 || this.Myself.ID <= 0)
      return;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ASKPARTYFOLLOW, (IntPtr) 0, (IntPtr) 0);
  }

  public void CallResetPacketRing()
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_RESETRING, (IntPtr) 0, (IntPtr) 0);
  }

  internal void CallInviteParty(string inviteName)
  {
    if (string.IsNullOrEmpty(inviteName))
      return;
    string viscii = GA.ConvertToVISCII(inviteName);
    this.Target.SendControlMessage(frmLogin.GAuto.Settings.WM_INVITEPARTY, new MyControlClass()
    {
      string1 = viscii
    }, ref this.Target.InvitePartyAlloc);
  }

  internal void CallXinVaoParty(string requestName)
  {
    if (string.IsNullOrEmpty(requestName))
      return;
    string viscii = GA.ConvertToVISCII(requestName);
    this.Target.SendControlMessage(frmLogin.GAuto.Settings.WM_XINVAOPARTY, new MyControlClass()
    {
      string1 = viscii
    }, ref this.Target.InvitePartyAlloc);
  }

  public void CallHoiSinh()
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_HOISINH, (IntPtr) 0, (IntPtr) 0);
  }

  public void CallThoatXac()
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_THOATXAC, (IntPtr) 0, (IntPtr) 0);
  }

  public void CallAcceptPartyFollowClick()
  {
    if (this.Target.VersionNum == 3 && this.Target.SubVersion == 4 || this.Target.VersionNum == 4 || this.Myself.JustWarped || this.Myself.isSceneTrans == 1 || this.Myself.ID <= 0)
      return;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CLOSECONFIRMBOX, (IntPtr) 2, (IntPtr) 0);
  }

  public void CallMoveFlashPos(int X, int Y)
  {
    if (X == 0 || Y == 0)
    {
      if (this.Myself.Status != AllEnums.CharStatuses.GOGOGO)
        return;
      this.Myself.Status = AllEnums.CharStatuses.IDLE;
    }
    else
    {
      if (this.Myself.JustWarped || this.Myself.isSceneTrans == 1 || this.Myself.HP <= 0 || this.Myself.ID <= 0 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.NoMoveStamp < 1500L || this.Myself.IDLEStamp - frmLogin.GlobalTimer.ElapsedMilliseconds > 0L)
        return;
      if (this.Target.VersionNum == 3 || this.Target.VersionNum == 4)
        MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CALLMOVETO, (IntPtr) X, (IntPtr) Y);
      else
        MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CALLMOVEFLASHPOS, (IntPtr) X, (IntPtr) Y);
    }
  }

  public void CallResetNhiemVuData()
  {
    MessageFunc msgParams = new MessageFunc();
    msgParams.Message = 2005;
    int num = 0;
    while (this.Myself.QuestInfo != "" || this.Myself.NhiemVuPosX > 0 || this.Myself.NhiemVuPosY > 0 || this.Myself.NhiemVuMapID != -1 || this.Myself.NhiemVuType != 0 || this.Myself.NhiemVuItemIndex != -1)
    {
      if (num == 0)
        this.WriteFuncParams(msgParams);
      else if (num == 15 || num == 30 || num == 45)
        this.WriteFuncParams(msgParams);
      else if (num >= 60)
      {
        GA.WriteUserLog(frmMain.langResetQData, this);
        break;
      }
      ++num;
      Thread.Sleep(100);
    }
  }

  public void ResetXYnow()
  {
    if ((double) this.Myself.ToXnow <= 0.0 && (double) this.Myself.ToYnow <= 0.0)
      return;
    this.WriteFuncParams(new MessageFunc()
    {
      Message = 2012
    });
  }

  public void PleaseUnhook(bool glogin = false)
  {
    MessageFunc msgParams = new MessageFunc();
    msgParams.Message = 2014;
    msgParams.int1 = 0;
    if (glogin)
      msgParams.int1 = 1;
    this.WriteFuncParams(msgParams);
  }

  public bool WantMoveNow()
  {
    if (this.Myself.IsAcTac || this.Myself.IsAcBa || (double) this.Myself.ToXnow == 0.0 && (double) this.Myself.ToYnow == 0.0)
      return false;
    double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) this.Myself.ToXnow, (double) this.Myself.ToYnow);
    if (distance <= 3.0)
      return false;
    if (distance != this.Myself.distMove)
    {
      this.Myself.distMove = distance;
      this.Myself.distMoveCounter = 0;
    }
    else
      ++this.Myself.distMoveCounter;
    if (this.Myself.distMoveCounter < 5)
      return true;
    this.Myself.distMoveCounter = 0;
    this.ResetXYnow();
    return false;
  }

  public void CallSetUpNhiemVuData(int nvPosX = -1, int nvPosY = -1, int nvMapID = -1, int nvType = -1)
  {
    MessageFunc msgParams = new MessageFunc();
    msgParams.Message = 2011;
    msgParams.int1 = nvPosX;
    msgParams.int2 = nvPosY;
    msgParams.int3 = nvMapID;
    msgParams.int4 = nvType;
    for (int index = 0; index < 12; ++index)
    {
      if (index == 0)
        this.WriteFuncParams(msgParams);
      Thread.Sleep(150);
      if (this.Myself.NhiemVuPosX == nvPosX && nvPosX != -1 || this.Myself.NhiemVuPosY == nvPosY && nvPosY != -1 || this.Myself.NhiemVuMapID == nvMapID && nvMapID != -1 || this.Myself.NhiemVuType == nvType && nvType != -1)
        break;
    }
  }

  public void CallMoveTo(int X, int Y)
  {
    if (X == 0 || Y == 0)
    {
      if (this.Myself.Status != AllEnums.CharStatuses.GOGOGO)
        return;
      this.Myself.Status = AllEnums.CharStatuses.IDLE;
    }
    else
    {
      if (this.Myself.HP <= 0 || this.Myself.ID <= 0 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.NoMoveStamp < 1500L || this.Myself.IDLEStamp - frmLogin.GlobalTimer.ElapsedMilliseconds > 0L)
        return;
      MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CALLMOVETO, (IntPtr) X, (IntPtr) Y);
    }
  }

  public void GiamDinhThungDo(int mode = 0)
  {
    if (mode == 1)
      Thread.Sleep(300);
    for (int index = 0; index < 30; ++index)
    {
      InventoryItem allItem = this.MyInventory.AllItems[index];
      if (allItem.ItemID > 0 && this.isTrangBiItem(allItem.ItemType))
      {
        if (mode == 1)
          this.CallInventoryItemDetail(index);
        else if (allItem.ItemSource == AllEnums.ItemSources.Chưa_biết || allItem.SavedCode != allItem.ItemID)
          this.CallInventoryItemDetail(index);
        Thread.Sleep(50);
      }
    }
    if (mode != 1)
      return;
    Thread.Sleep(300);
  }

  public void CallClearNhiemVuData() => this.CallResetNhiemVuData();

  public void CallToggleMission(int open = 1)
  {
    if (this.Target.VersionNum == 3)
      return;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_TOGGLEMISSION, (IntPtr) open, (IntPtr) 0);
  }

  public void CallKhinhCongPacket(int posX, int posY, int skillID = 34)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_KHINHCONGPACKET_1, (IntPtr) this.Myself.ID, (IntPtr) skillID);
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_KHINHCONGPACKET, (IntPtr) posX, (IntPtr) posY);
  }

  public void CallPetXuatChien(int petGUID, int petDB)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_PETXUATCHIEN, (IntPtr) petGUID, (IntPtr) petDB);
  }

  public void CallThuPet(int petGUID, int petDB)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_THUPET, (IntPtr) petGUID, (IntPtr) petDB);
  }

  public bool CallPlayMyPet(int databaseID, int PetOwnerDBID)
  {
    SinglePetClass petByDbid = this.MyPet.GetPetByDBID(databaseID, PetOwnerDBID);
    int itemIndex1 = -1;
    int itemIndex2 = -1;
    for (int index = 0; index < 30; ++index)
    {
      if (this.MyInventory.AllItems[index].ItemID == 30601001 || this.MyInventory.AllItems[index].ItemID == 30601004 || this.MyInventory.AllItems[index].ItemID == 30601011)
        itemIndex1 = index;
      if (petByDbid.Happiness <= 59 && this.MyInventory.AllItems[index].ItemID >= 30607000 && this.MyInventory.AllItems[index].ItemID <= 30607004)
        itemIndex2 = index;
    }
    if (petByDbid != null)
    {
      if (itemIndex1 >= 0)
      {
        this.CallUseItem(itemIndex1, petByDbid.ID, petGUID: petByDbid.PetOwnerDBID, petDBID: petByDbid.DatabaseID);
        return true;
      }
      if (itemIndex2 >= 0)
      {
        this.CallUseItem(itemIndex2, petByDbid.ID, petGUID: petByDbid.PetOwnerDBID, petDBID: petByDbid.DatabaseID);
        return true;
      }
    }
    return false;
  }

  public QuaiIndividual SearchNPCByName(string name)
  {
    name = name.ToLower();
    QuaiIndividual quaiIndividual1 = (QuaiIndividual) null;
    if (this.MyQuai != null)
    {
      if (this.MyQuai.AllQuai.Count > 0)
      {
        try
        {
          for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
          {
            QuaiIndividual quaiIndividual2 = this.MyQuai.AllQuai[index];
            string lower = quaiIndividual2.Name.ToLower();
            if (lower != "")
            {
              if (lower == name || lower.Contains(name) || name.Contains(lower))
                quaiIndividual1 = quaiIndividual2;
              if (name == "npcyto")
              {
                string name1 = quaiIndividual2.Name;
                if (name1.Contains("c Lão Ta") || name1.Contains("ân Trung H") || name1.Contains("ệp Nhị Nư") || name1.Contains("iên Khá") || name1.Contains("aosan Yu") || name1.Contains("Brute") || name1.Contains("razy Moth") || name1.Contains("ruel Tua"))
                  quaiIndividual1 = quaiIndividual2;
              }
            }
          }
        }
        catch (Exception ex)
        {
          GA.WriteUserLog("Lỗi khi tìm NPC theo tên. Nếu xảy ra lỗi auto vì điều này vui lòng báo cho Admin biết", this);
        }
      }
    }
    return quaiIndividual1;
  }

  public QuaiIndividual SearchNPCByPos(int x, int y, int distance)
  {
    QuaiIndividual quaiIndividual = (QuaiIndividual) null;
    if (this.MyQuai != null && this.MyQuai.AllQuai.Count > 0)
    {
      double num = 9999.0;
      try
      {
        for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
        {
          QuaiIndividual quai = this.MyQuai.AllQuai[index];
          double distance1 = GA.CalculateDistance((double) x, (double) y, (double) quai.PosX, (double) quai.PosY);
          if (distance1 <= 10.0 && distance1 < num && this.IsNPC2(quai) && quai.Name != "")
          {
            num = distance1;
            quaiIndividual = quai;
          }
        }
      }
      catch (Exception ex)
      {
      }
    }
    return quaiIndividual;
  }

  public void CallTalkNPCByPos(int menuTypeID, int menuIndex, int x, int y, bool initiateMenu = true)
  {
    QuaiIndividual quaiIndividual = this.SearchNPCByPos(x, y, 10);
    if (quaiIndividual == null || quaiIndividual.ID < 0)
      return;
    this.CallSelectTarget(quaiIndividual.ID);
    if (initiateMenu)
    {
      this.CallTalkNPC(0, 0, quaiIndividual.ID);
      long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
      while (this.Myself.isQuestFrameShow == 0)
      {
        Thread.Sleep(200);
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds > 2000L)
          break;
      }
    }
    if (this.Myself.isBachHoaDuyen && !GA.IsBangMapID(this.Myself.MapID))
      this.CallTalkNPCAdv(menuTypeID, menuIndex, quaiIndividual.ID);
    else
      this.CallTalkNPC(menuTypeID, menuIndex, quaiIndividual.ID);
  }

  public void CallTalkNPCByPos2(int menuTypeID, int menuIndex, int x, int y, bool initiateMenu = false)
  {
    QuaiIndividual quaiIndividual = this.SearchNPCByPos(x, y, 10);
    if (quaiIndividual == null || quaiIndividual.ID < 0)
      return;
    this.CallSelectTarget(quaiIndividual.ID);
    if (initiateMenu)
      this.CallTalkNPC(menuTypeID, menuIndex, quaiIndividual.ID);
    else
      this.CallTalkNPC(0, 0, quaiIndividual.ID);
  }

  public void CallTalkNPC(
    int menuTypeID,
    int menuIndex,
    int NPCID,
    bool NoMove = false,
    bool removeGroup = false)
  {
    if (this.Myself.ID <= 0)
      return;
    if (!removeGroup)
      this.MyFlag.talkNPCStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    if (NoMove)
      this.MyFlag.NoMoveStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_TALKNPC_1, (IntPtr) menuTypeID, (IntPtr) menuIndex);
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_TALKNPC, (IntPtr) NPCID, (IntPtr) 0);
    this.Myself.LastPostStamp.Reset();
    this.Myself.LastPostStamp.Start();
  }

  public bool CallTalkNPCQuest(
    string textOK = "thanhcong",
    int mode = 0,
    int menuType1 = 0,
    int menuIndex1 = 0,
    int NPCID = 0,
    int menuType2 = -1,
    int menuIndex2 = -1,
    int timeout = 10000,
    bool modetimeout = true)
  {
    this.ResetEventString();
    this.ResetPacketMsg();
    this.CallResetNhiemVuData();
    long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
    long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
    int num = 0;
    while (this.IsAIEnabled)
    {
      if (this.Myself.isQuestFrameShow == 0)
      {
        this.CallTalkNPC(0, 0, NPCID);
        long elapsedMilliseconds3 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        while (this.Myself.isQuestFrameShow == 0)
        {
          Thread.Sleep(200);
          if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds3 > 2000L)
            break;
        }
      }
      if (this.Myself.isQuestFrameShow == 1)
      {
        if (num == 0)
        {
          this.CallTalkNPC(menuType1, menuIndex1, NPCID);
          if (this.Myself.isQSM)
            this.CallTalkNPCAdv(menuType1, menuIndex1, NPCID);
          ++num;
        }
        if (num == 1)
        {
          if (menuType2 > 0)
          {
            Thread.Sleep(400);
            this.CallTalkNPC(menuType2, menuIndex2, NPCID);
            ++num;
          }
          else
            ++num;
        }
        if (num == 2)
        {
          switch (mode)
          {
            case 1:
              Thread.Sleep(400);
              this.CallNhanNhiemVu();
              break;
            case 2:
              Thread.Sleep(400);
              this.CallTraNhiemVu();
              break;
          }
        }
        if (this.Myself.EventString == textOK || this.Myself.PacketMsg == textOK)
          return true;
      }
      if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 >= 3000L)
      {
        num = 0;
        this.CallTalkNPC(0, 0, NPCID);
        long elapsedMilliseconds4 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        while (this.Myself.isQuestFrameShow == 0)
        {
          Thread.Sleep(200);
          if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds4 > 2000L)
            break;
        }
        elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
      }
      if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 >= (long) timeout)
        return modetimeout;
      if (this.Myself.isCauNguyen && this.Myself.PacketMsg == "HLCN")
        return false;
      Thread.Sleep(200);
    }
    return false;
  }

  public void CallTalkNPCAdv(int menuTypeID, int menuIndex, int NPCID)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_TALKNPC_1, (IntPtr) menuTypeID, (IntPtr) menuIndex);
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_TALKNPC, (IntPtr) NPCID, (IntPtr) 1);
    this.Myself.LastPostStamp.Reset();
    this.Myself.LastPostStamp.Start();
    this.MyFlag.talkNPCStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
  }

  public void CallAdjustLock(bool setlock)
  {
    if (setlock)
    {
      MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_SETLOCK, (IntPtr) 0, (IntPtr) 0);
    }
    else
    {
      if (setlock)
        return;
      MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_REMOVELOCK, (IntPtr) 0, (IntPtr) 0);
    }
  }

  public void CallBuyItemPacket(int itemIndex, int NPC_ID, int mapID, int amount)
  {
    if (this.Target.VersionNum == 3 || amount > 20)
      return;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_BUYITEM_1, (IntPtr) itemIndex, (IntPtr) NPC_ID);
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_BUYITEM, (IntPtr) mapID, (IntPtr) amount);
  }

  public void CallGetMemAlloc()
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_MEMALLOC, (IntPtr) 0, (IntPtr) 0);
  }

  public void CallGetVIPdll()
  {
    Process currentProcess = Process.GetCurrentProcess();
    if (currentProcess == null)
      return;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CRITDLL, currentProcess.MainWindowHandle, (IntPtr) 0);
  }

  public void CallStartAutoMoveClick()
  {
    if (this.Myself.JustWarped || this.Myself.isSceneTrans == 1 || this.Myself.ID <= 0 || this.Myself.isMessageBox_Self == 0 || !frmLogin.GAuto.Settings.TuDongYChuyenCanh)
      return;
    bool flag = this.NotTransitioning();
    if (!this.CustomSleep(3, 1000) || !flag)
      return;
    if (this.Myself.isMessageBox_Self == 1)
    {
      this.DoSomeThingDLL(5);
      MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CLOSECONFIRMBOX, (IntPtr) 0, (IntPtr) 0);
    }
    this.Myself.MoveLongStamp.Reset();
    this.Myself.MoveLongStamp.Start();
    this.Myself.CalcPathStamp.Reset();
    this.Myself.CalcPathStamp.Start();
    if (GA.CheckGameVersion(this.Target.VersionNum) != 356 || !this.Settings.FixLoiCuongChe)
      return;
    GA.WriteUserLog("Tự bấm bảng đồng ý 2", this);
  }

  public void CallStartPortalMove()
  {
    if (this.Target.VersionNum == 3 || this.Target.VersionNum == 4 || !this.NotTransitioning())
      return;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_STARTPOTALMOVE, (IntPtr) 0, (IntPtr) 0);
  }

  public void CallAutoMoveToTarget(int posX, int posY, int mapID)
  {
    if (posX == 0 || posY == 0)
    {
      if (this.Myself.Status != AllEnums.CharStatuses.GOGOGO)
        return;
      this.Myself.Status = AllEnums.CharStatuses.IDLE;
    }
    else
    {
      if (this.Myself.JustWarped || this.Myself.isSceneTrans == 1 || this.Myself.HP <= 0 || this.Myself.ID <= 0 || !this.Target.GLoginAIReady || this.Myself.IDLEStamp - frmLogin.GlobalTimer.ElapsedMilliseconds > 0L || frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.moveEXStamp < 3000L)
        return;
      this.MyFlag.moveEXStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
      if (this.Target.VersionNum == 3 || this.Target.VersionNum == 4)
      {
        this.Myself.LongMoveX = posX;
        this.Myself.LongMoveY = posY;
        this.Myself.LongMoveMapID = mapID;
        this.Myself.IsLongMove = true;
      }
      else
      {
        bool flag = false;
        if (mapID == -1)
          flag = true;
        MapDBElement mapElement = GA.GetMapElement(mapID);
        if (mapElement != null && mapElement.MapIDforLUA != -1)
          mapID = mapElement.MapIDforLUA;
        if (flag || posX <= 0 || posY <= 0 || mapID < 0)
          return;
        MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_AUTOMOVE_1, (IntPtr) posX, (IntPtr) posY);
        MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_AUTOMOVE, (IntPtr) mapID, (IntPtr) 0);
      }
    }
  }

  public void CallFeedMyActivePetLUA(int index)
  {
    if (!this.HasActivePet())
      return;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_PETCARE, (IntPtr) index, (IntPtr) 0);
  }

  public void CallFeedMyActivePet()
  {
    if (this.Myself.ID <= 0 || this.MyPet.ActivePetIndex < 0 || this.MyPet.ActivePetIndex >= this.MyPet.AllPets.Count)
      return;
    this.CallFeedMyActivePetLUA(this.MyPet.ActivePetIndex);
  }

  private void GetPetFoodRange(out int minItemID, out int maxItemID)
  {
    if (this.Settings.cboPetFoodType == 0)
    {
      minItemID = 30607000;
      maxItemID = 30607004;
    }
    else
    {
      minItemID = 30601001 + 1000 * this.Settings.cboPetFoodType;
      maxItemID = 30601010 + 1000 * this.Settings.cboPetFoodType;
    }
  }

  public void CallFeedMyPet(int itemIndex, int petID, int petGUID, int petDBID)
  {
    if (this.Myself.ID <= 0 || itemIndex < 0 || itemIndex >= 30)
      return;
    InventoryItem allItem = this.MyInventory.AllItems[itemIndex];
    int itemId = allItem.ItemID;
    int itemGuiD1 = allItem.ItemGUID1;
    int itemGuiD2 = allItem.ItemGUID2;
    this.CallUseItem(itemIndex, petID, petGUID: petGUID, petDBID: petDBID);
  }

  public void CallUseItem(
    int itemIndex,
    int targetID = 0,
    int posX = 0,
    int posY = 0,
    int petGUID = 0,
    int petDBID = 0)
  {
    this.CallXuongNgua();
    if (targetID == 0)
      targetID = this.Myself.ID;
    if (this.Myself.ID <= 0 || (itemIndex < 0 || itemIndex >= 30) && (itemIndex < 60 || itemIndex >= 90))
      return;
    InventoryItem allItem = this.MyInventory.AllItems[itemIndex];
    int itemId = allItem.ItemID;
    int itemGuiD1 = allItem.ItemGUID1;
    int itemGuiD2 = allItem.ItemGUID2;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_USEITEM_1, (IntPtr) itemIndex, (IntPtr) itemId);
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_USEITEM_2, (IntPtr) itemGuiD1, (IntPtr) itemGuiD2);
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_USEITEM_3, (IntPtr) targetID, (IntPtr) posX);
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_USEITEM_4, (IntPtr) posY, (IntPtr) petGUID);
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_USEITEM, (IntPtr) petDBID, (IntPtr) 0);
    if (this.Target.VersionNum != 3 || allItem.ItemID != 30008007 && allItem.ItemID != 30505216 && allItem.ItemID != 30008030 && allItem.ItemID != 38001079)
      return;
    this.MyFlag.TLCStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
  }

  public void CallConfirmTrungAc()
  {
    if (this.Target.VersionNum == 3)
      return;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_TRUNGAC, (IntPtr) 0, (IntPtr) 0);
  }

  public void CallSetChatRecordFlag()
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_RECORDCHAT, (IntPtr) 0, (IntPtr) 0);
  }

  public void CallSetIsInGame(int i)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ISINGAME, (IntPtr) i, (IntPtr) 0);
  }

  public void CallSendSavedChat()
  {
    this.Target.SendMessageCommand(frmLogin.GAuto.Settings.WM_SENDSAVEDCHAT, new MyParamsClass()
    {
      string1 = this.Myself.ChatRecordedMessage
    });
  }

  public void CallAttackTarget(
    int targetID,
    int skillID,
    int posX,
    int posY,
    bool isPK = false,
    bool isPlaySkill = false)
  {
    if (skillID == 22 && this.Myself.IsPartyFollowed == (byte) 1)
    {
      this.CallRemovePartyFollow();
      Thread.Sleep(1000);
    }
    if (frmLogin.GAuto.Settings.cboxOnlyCheDo && !frmLogin.GAuto.Settings.ThangCheDo)
    {
      GA.ShowBalloon("Bạn đang ở trạng thái đăng nhập Chế đồ, không thể đánh quái", "Thông báo", this);
    }
    else
    {
      if (this.Myself.IDLEStamp - frmLogin.GlobalTimer.ElapsedMilliseconds > 0L)
        return;
      if (targetID == -1 && this.MySkills.AllSkills[0].ID == skillID)
      {
        this.CallSelectTarget(-1);
      }
      else
      {
        if (this.Myself.ID <= 0)
          return;
        int num1 = 0;
        int num2 = -1;
        bool flag1 = false;
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.SkillNguTongAttackStamp <= 20000L && frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.SkillNguTongReadmemChangeStamp <= 20000L && this.MyFlag.SkillNguTongID > 0 && skillID == this.MySkills.AllSkills[0].ID)
        {
          ++num1;
          num2 = this.MyFlag.SkillNguTongID;
          flag1 = true;
        }
        if (num2 == -1 && skillID == this.MySkills.AllSkills[0].ID && frmLogin.GAuto.Settings.IsPro1)
        {
          if (!isPK)
          {
            if (this.Settings.SkillPlayList.Count > 0 && this.Settings.cboxSkillOnOff)
            {
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.noPlaySkillStamp >= 7000L)
              {
                try
                {
                  for (int index1 = 0; index1 < this.Settings.SkillPlayList.Count; ++index1)
                  {
                    SkillPlayItem skillPlay = this.Settings.SkillPlayList[index1];
                    bool flag2 = this.PlayMySkill(skillPlay, targetID);
                    if (num1 <= 0)
                    {
                      if (flag2 && num1 == 0)
                      {
                        if (this.MySkills.SkillBuffer.Count == 0)
                          num2 = skillPlay.SkillItem.ID;
                        else if (this.MySkills.SkillBuffer.Count == 1)
                        {
                          num2 = skillPlay.SkillItem.ID;
                          this.MySkills.SkillBuffer.Clear();
                        }
                        else if (this.MySkills.SkillBuffer.Count > 1)
                        {
                          for (int index2 = 0; index2 < this.MySkills.SkillBuffer.Count; ++index2)
                          {
                            if (!this.MySkills.SkillBuffer[index2].isBuff)
                            {
                              num2 = this.MySkills.SkillBuffer[index2].SkillID;
                              this.MySkills.SkillBuffer.RemoveAt(index2);
                              break;
                            }
                          }
                        }
                        if (skillPlay.SkillItem.ID == 402 || skillPlay.SkillItem.ID == 395 || skillPlay.SkillItem.ID == 374 || skillPlay.SkillItem.ID == 426 && this.Target.VersionNum == 3 || skillPlay.SkillItem.ID >= 840 && skillPlay.SkillItem.ID <= 849 || this.Myself.Menpai == AllEnums.Menpais.QUYCOC && (skillPlay.SkillItem.ID == 1851 || skillPlay.SkillItem.ID == 1858 || skillPlay.SkillItem.ID == 1859 || skillPlay.SkillItem.ID == 1867 || skillPlay.SkillItem.ID == 1871 || skillPlay.SkillItem.ID == 1873))
                        {
                          if (this.Myself.CurrentTarget != null)
                          {
                            posX = (int) this.Myself.CurrentTarget.PosX;
                            posY = (int) this.Myself.CurrentTarget.PosY;
                          }
                          else
                          {
                            try
                            {
                              for (int index3 = this.MyQuai.AllQuai.Count - 1; index3 >= 0; --index3)
                              {
                                QuaiIndividual quaiIndividual = this.MyQuai.AllQuai[index3];
                                if (quaiIndividual.ID == targetID)
                                {
                                  posX = (int) quaiIndividual.PosX;
                                  posY = (int) quaiIndividual.PosY;
                                  break;
                                }
                              }
                              for (int index4 = this.MyPlayers.AllPlayers.Count - 1; index4 >= 0; --index4)
                              {
                                PlayerIndividual allPlayer = this.MyPlayers.AllPlayers[index4];
                                if (allPlayer.ID == targetID)
                                {
                                  posX = (int) allPlayer.PosX;
                                  posY = (int) allPlayer.PosY;
                                  break;
                                }
                              }
                            }
                            catch (Exception ex)
                            {
                              GA.WriteUserLog("Lỗi đánh skill AOE nhân vật 0", this);
                            }
                          }
                        }
                        ++num1;
                      }
                    }
                    else
                      break;
                  }
                }
                catch (Exception ex)
                {
                  GA.WriteUserLog(frmMain.langPlaySkillYet + ex.Message, this);
                }
              }
            }
          }
          else if (this.Settings.SkillPKList.Count > 0)
          {
            try
            {
              for (int index5 = 0; index5 < this.Settings.SkillPKList.Count; ++index5)
              {
                SkillPlayItem skillPk = this.Settings.SkillPKList[index5];
                bool flag3 = this.PlayMySkill(skillPk, targetID);
                if (num1 <= 0)
                {
                  if (flag3 && num1 == 0)
                  {
                    num2 = skillPk.SkillItem.ID;
                    if (skillPk.SkillItem.ID == 402 || skillPk.SkillItem.ID == 395 || skillPk.SkillItem.ID == 374 || skillPk.SkillItem.ID == 426 && this.Target.VersionNum == 3 || skillPk.SkillItem.ID >= 840 && skillPk.SkillItem.ID <= 849)
                    {
                      if (this.Myself.CurrentTarget != null)
                      {
                        posX = (int) this.Myself.CurrentTarget.PosX;
                        posY = (int) this.Myself.CurrentTarget.PosY;
                      }
                      else
                      {
                        try
                        {
                          for (int index6 = this.MyPlayers.AllPlayers.Count - 1; index6 >= 0; --index6)
                          {
                            PlayerIndividual allPlayer = this.MyPlayers.AllPlayers[index6];
                            if (allPlayer.ID == targetID)
                            {
                              posX = (int) allPlayer.PosX;
                              posY = (int) allPlayer.PosY;
                              break;
                            }
                          }
                        }
                        catch (Exception ex)
                        {
                          GA.WriteUserLog("Lỗi đánh skill AOE nhân vật 1", this);
                        }
                      }
                    }
                    ++num1;
                  }
                }
                else
                  break;
              }
            }
            catch (Exception ex)
            {
              GA.WriteUserLog(frmMain.langPlaySkillYet + ex.Message, this);
            }
          }
        }
        if (frmLogin.GAuto.Settings.optSuDungF1 && this.MySkills != null && skillID == this.MySkills.AllSkills[0].ID)
          skillID = this.MySkills.AllSkills[1].ID;
        if (num1 > 0 && num2 >= 0)
        {
          MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ATTACKTARGET_1, (IntPtr) targetID, (IntPtr) num2);
          MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ATTACKTARGET_2, (IntPtr) posX, (IntPtr) posY);
        }
        if (!isPlaySkill)
        {
          bool flag4 = true;
          if (this.MyFlag.SavedTargetID == targetID && this.Myself.ActionStatus == (byte) 7 && this.MySkills.AllSkills[0].ID == skillID)
            flag4 = false;
          this.MyFlag.SavedTargetID = targetID;
          if (flag4)
          {
            MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ATTACKTARGET_1, (IntPtr) targetID, (IntPtr) skillID);
            MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ATTACKTARGET_2, (IntPtr) posX, (IntPtr) posY);
          }
        }
        this.Myself.SkillActionStamp.Reset();
        this.Myself.SkillActionStamp.Start();
        if (flag1 || !this.isSkillNguTong(skillID) && !this.isSkillNguTong(num2))
          return;
        this.MyFlag.SkillNguTongAttackStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
      }
    }
  }

  public void CallAttackTargetFast(int targetID, int skillID, int posX, int posY)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ATTACKTARGET_1, (IntPtr) targetID, (IntPtr) skillID);
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ATTACKTARGET_2, (IntPtr) posX, (IntPtr) posY);
  }

  public void CallAttackTargetPacket(
    int playerID,
    int skillID,
    int targetID,
    int posX,
    int posY,
    bool isPK = false)
  {
    if (frmLogin.GAuto.Settings.cboxOnlyCheDo && !frmLogin.GAuto.Settings.ThangCheDo)
    {
      GA.ShowBalloon("Bạn đang ở trạng thái đăng nhập Chế đồ, không thể đánh quái", "Thông báo", this);
    }
    else
    {
      if (this.Myself.IDLEStamp - frmLogin.GlobalTimer.ElapsedMilliseconds > 0L || targetID == -1 && this.MySkills.AllSkills[0].ID == skillID || this.Myself.ID <= 0 || this.Myself.isSceneTrans != 0 || this.Myself.JustWarped)
        return;
      int num1 = 0;
      int num2 = -1;
      bool flag1 = false;
      if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.SkillNguTongAttackStamp <= 20000L && frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.SkillNguTongReadmemChangeStamp <= 20000L && this.MyFlag.SkillNguTongID > 0 && skillID == this.MySkills.AllSkills[0].ID)
      {
        ++num1;
        num2 = this.MyFlag.SkillNguTongID;
        flag1 = true;
      }
      if (num2 == -1 && skillID == this.MySkills.AllSkills[0].ID)
      {
        if (!isPK)
        {
          if (frmLogin.GAuto.Settings.IsPro1 && this.Settings.SkillPlayList.Count > 0 && this.Settings.cboxSkillOnOff)
          {
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.noPlaySkillStamp >= 7000L)
            {
              try
              {
                for (int index1 = 0; index1 < this.Settings.SkillPlayList.Count; ++index1)
                {
                  SkillPlayItem skillPlay = this.Settings.SkillPlayList[index1];
                  bool flag2 = this.PlayMySkill(skillPlay, targetID);
                  if (num1 <= 0)
                  {
                    if (flag2 && num1 == 0)
                    {
                      if (this.MySkills.SkillBuffer.Count == 0)
                        num2 = skillPlay.SkillItem.ID;
                      else if (this.MySkills.SkillBuffer.Count == 1)
                      {
                        num2 = skillPlay.SkillItem.ID;
                        this.MySkills.SkillBuffer.Clear();
                      }
                      else if (this.MySkills.SkillBuffer.Count > 1)
                      {
                        for (int index2 = 0; index2 < this.MySkills.SkillBuffer.Count; ++index2)
                        {
                          if (!this.MySkills.SkillBuffer[index2].isBuff)
                          {
                            num2 = this.MySkills.SkillBuffer[index2].SkillID;
                            this.MySkills.SkillBuffer.RemoveAt(index2);
                            break;
                          }
                        }
                      }
                      if (skillPlay.SkillItem.ID == 402 || skillPlay.SkillItem.ID == 395 || skillPlay.SkillItem.ID == 374 || skillPlay.SkillItem.ID == 426 && this.Target.VersionNum == 3 || skillPlay.SkillItem.ID >= 840 && skillPlay.SkillItem.ID <= 849 || this.Myself.Menpai == AllEnums.Menpais.QUYCOC && (skillPlay.SkillItem.ID == 1851 || skillPlay.SkillItem.ID == 1858 || skillPlay.SkillItem.ID == 1859 || skillPlay.SkillItem.ID == 1867 || skillPlay.SkillItem.ID == 1871 || skillPlay.SkillItem.ID == 1873))
                      {
                        if (this.Myself.CurrentTarget != null)
                        {
                          posX = (int) this.Myself.CurrentTarget.PosX;
                          posY = (int) this.Myself.CurrentTarget.PosY;
                        }
                        else
                        {
                          try
                          {
                            for (int index3 = this.MyQuai.AllQuai.Count - 1; index3 >= 0; --index3)
                            {
                              QuaiIndividual quaiIndividual = this.MyQuai.AllQuai[index3];
                              if (quaiIndividual.ID == targetID)
                              {
                                posX = (int) quaiIndividual.PosX;
                                posY = (int) quaiIndividual.PosY;
                                break;
                              }
                            }
                            for (int index4 = this.MyPlayers.AllPlayers.Count - 1; index4 >= 0; --index4)
                            {
                              PlayerIndividual allPlayer = this.MyPlayers.AllPlayers[index4];
                              if (allPlayer.ID == targetID)
                              {
                                posX = (int) allPlayer.PosX;
                                posY = (int) allPlayer.PosY;
                                break;
                              }
                            }
                          }
                          catch (Exception ex)
                          {
                            GA.WriteUserLog("Lỗi đánh skill AOE nhân vật 2", this);
                          }
                        }
                      }
                      ++num1;
                    }
                  }
                  else
                    break;
                }
              }
              catch (Exception ex)
              {
                GA.WriteUserLog(frmMain.langPlaySkillYet + ex.Message, this);
              }
            }
          }
        }
        else if (this.Settings.SkillPKList.Count > 0)
        {
          try
          {
            for (int index5 = 0; index5 < this.Settings.SkillPKList.Count; ++index5)
            {
              SkillPlayItem skillPk = this.Settings.SkillPKList[index5];
              bool flag3 = this.PlayMySkill(skillPk, targetID);
              if (num1 <= 0)
              {
                if (flag3 && num1 == 0)
                {
                  num2 = skillPk.SkillItem.ID;
                  if (skillPk.SkillItem.ID == 402 || skillPk.SkillItem.ID == 395 || skillPk.SkillItem.ID == 374 || skillPk.SkillItem.ID == 426 && this.Target.VersionNum == 3 || skillPk.SkillItem.ID >= 840 && skillPk.SkillItem.ID <= 849)
                  {
                    if (this.Myself.CurrentTarget != null)
                    {
                      posX = (int) this.Myself.CurrentTarget.PosX;
                      posY = (int) this.Myself.CurrentTarget.PosY;
                    }
                    else
                    {
                      try
                      {
                        for (int index6 = this.MyPlayers.AllPlayers.Count - 1; index6 >= 0; --index6)
                        {
                          PlayerIndividual allPlayer = this.MyPlayers.AllPlayers[index6];
                          if (allPlayer.ID == targetID)
                          {
                            posX = (int) allPlayer.PosX;
                            posY = (int) allPlayer.PosY;
                            break;
                          }
                        }
                      }
                      catch (Exception ex)
                      {
                        GA.WriteUserLog("Lỗi đánh skill AOE nhân vật 3", this);
                      }
                    }
                  }
                  ++num1;
                }
              }
              else
                break;
            }
          }
          catch (Exception ex)
          {
            GA.WriteUserLog(frmMain.langPlaySkillYet + ex.Message, this);
          }
        }
      }
      if (frmLogin.GAuto.Settings.optSuDungF1 && this.MySkills != null && skillID == this.MySkills.AllSkills[0].ID)
        skillID = this.MySkills.AllSkills[1].ID;
      if (skillID == -1)
      {
        if (this.Settings.cboxOnlyPet)
        {
          if (GA.CheckGameVersion(this.Target.VersionNum) == 356 && this.Settings.FixLoiCuongChe)
          {
            this.Settings.cboxOnlyPet = false;
            GA.WriteUserLog("Auto Vinagame tạm tắt chức năng đánh chỉ dùng Pet để kiểm tra. Nếu bạn muốn dùng vui lòng liên hệ Admin GAuto", this);
            return;
          }
        }
        else
          GA.WriteUserLog("Lỗi dữ liệu đánh quái. Vui lòng báo cho Admin biết lỗi này. Code[1] {0}", this, (object) this.Myself.Menpai.ToString());
      }
      if (playerID >= (int) ushort.MaxValue || targetID >= (int) ushort.MaxValue)
      {
        GA.WriteUserLog("Lỗi dữ liệu đánh quái. Vui lòng báo cho Admin biết lỗi này. Code[2] {0} - {1}", this, (object) playerID.ToString(), (object) targetID.ToString());
        this.CallAttackTarget(targetID, skillID, posX, posY, isPK);
      }
      else
      {
        if (num1 > 0 && num2 >= 0)
        {
          if (GA.CheckGameVersion(this.Target.VersionNum) == 356 && targetID >= 0 && skillID != 21 && skillID != 34 && !frmLogin.GAuto.Settings.AOEPetSkills.Contains(skillID) && !frmLogin.GAuto.Settings.AOEBuffSkills.Contains(skillID))
          {
            if (skillID != 424 && skillID != 407)
            {
              if (targetID == this.MyFlag.savedMucTieuID)
              {
                ++this.MyFlag.savedMucTieuID_Count;
              }
              else
              {
                this.MyFlag.savedMucTieuID_Count = 0;
                this.MyFlag.savedMucTieuID = targetID;
              }
            }
            if (this.MyFlag.savedMucTieuID_Count >= 4 || this.Settings.FixLoiCuongChe)
            {
              this.CallAttackTarget(targetID, skillID, posX, posY, isPK);
              return;
            }
          }
          MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ATTACKTARGETPACKET_1, (IntPtr) playerID, (IntPtr) num2);
          MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ATTACKTARGETPACKET_2, (IntPtr) targetID, (IntPtr) posX);
          MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ATTACKTARGETPACKET, (IntPtr) posY, (IntPtr) 0);
        }
        bool flag4 = true;
        if (this.MyFlag.SavedTargetID == targetID && this.Myself.ActionStatus == (byte) 7 && this.MySkills.AllSkills[0].ID == skillID)
          flag4 = false;
        this.MyFlag.SavedTargetID = targetID;
        if (flag4)
        {
          if (GA.CheckGameVersion(this.Target.VersionNum) == 356 && targetID >= 0 && skillID != 21 && skillID != 34 && !frmLogin.GAuto.Settings.AOEPetSkills.Contains(skillID) && !frmLogin.GAuto.Settings.AOEBuffSkills.Contains(skillID))
          {
            if (skillID != 424 && skillID != 407)
            {
              if (targetID == this.MyFlag.savedMucTieuID)
              {
                ++this.MyFlag.savedMucTieuID_Count;
              }
              else
              {
                this.MyFlag.savedMucTieuID_Count = 0;
                this.MyFlag.savedMucTieuID = targetID;
              }
            }
            if (this.MyFlag.savedMucTieuID_Count >= 4 || this.Settings.FixLoiCuongChe)
            {
              this.CallAttackTarget(targetID, skillID, posX, posY, isPK);
              return;
            }
          }
          MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ATTACKTARGETPACKET_1, (IntPtr) playerID, (IntPtr) skillID);
          MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ATTACKTARGETPACKET_2, (IntPtr) targetID, (IntPtr) posX);
          MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ATTACKTARGETPACKET, (IntPtr) posY, (IntPtr) 0);
        }
        if (flag1 || !this.isSkillNguTong(skillID) && !this.isSkillNguTong(num2))
          return;
        this.MyFlag.SkillNguTongAttackStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
      }
    }
  }

  public void CallAttackTargetPacketFast(
    int playerID,
    int skillID,
    int targetID,
    int posX,
    int posY,
    bool isPK = false)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ATTACKTARGETPACKET_1, (IntPtr) playerID, (IntPtr) skillID);
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ATTACKTARGETPACKET_2, (IntPtr) targetID, (IntPtr) posX);
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ATTACKTARGETPACKET, (IntPtr) posY, (IntPtr) 0);
  }

  public void CallSplitItemPacket(int index, int number)
  {
    if (this.Target.VersionNum == 3)
      return;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_SPLITITEM, (IntPtr) index, (IntPtr) number);
  }

  public void CallJoinItemPacket(int index1, int index2)
  {
    if (this.Target.VersionNum == 3)
      return;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_JOINITEM, (IntPtr) index1, (IntPtr) index2);
  }

  public void CallUpLevelPacket()
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_UPLEVEL, (IntPtr) 0, (IntPtr) 0);
  }

  public void SwapScriptEngine()
  {
    if (this.ScriptEngine == null || this.ScriptEngine2 == null)
      return;
    GScriptEngine scriptEngine2 = this.ScriptEngine2;
    this.ScriptEngine2 = this.ScriptEngine;
    this.ScriptEngine = scriptEngine2;
    this.IsMainScript = !this.IsMainScript;
  }

  public void AIDanhQuai()
  {
  }

  public void LoadPathPoint(int mapID = -1, string mapSection = "")
  {
    if (mapID != -1)
    {
      bool flag = false;
      if (this.Myself.InMapPathPoints.Count == 0)
        flag = true;
      else if (this.Myself.InMapPathPoints[0].MapID != mapID)
      {
        flag = true;
        this.Myself.InMapPathPoints.Clear();
      }
      if (flag)
      {
        foreach (KhoangDuocDBElement khoangDuocDbElement in frmLogin.GAuto.ATABDB)
        {
          if (khoangDuocDbElement.MapID == mapID)
            this.Myself.InMapPathPoints.Add(new InMapPoint()
            {
              Arrived = false,
              Cleared = false,
              MapID = mapID,
              PosX = khoangDuocDbElement.PosX,
              PosY = khoangDuocDbElement.PosY,
              STT = khoangDuocDbElement.STT,
              Horse = khoangDuocDbElement.Horse
            });
        }
        this.Myself.InMapPathPoints.Sort(new Comparison<InMapPoint>(this.PointComparison));
      }
    }
    if (!(mapSection != ""))
      return;
    bool flag1 = false;
    if (this.Myself.InMapPathPoints.Count == 0)
      flag1 = true;
    else if (this.Myself.InMapPathPoints[0].SectionName != mapSection)
    {
      flag1 = true;
      this.Myself.InMapPathPoints.Clear();
    }
    if (!flag1)
      return;
    UserPathPoint userPathPoint1 = (UserPathPoint) null;
    if (frmLogin.UserPathPoints.Count > 0)
    {
      foreach (UserPathPoint userPathPoint2 in frmLogin.UserPathPoints)
      {
        if (userPathPoint2.SectionName == mapSection)
        {
          userPathPoint1 = userPathPoint2;
          break;
        }
      }
    }
    if (userPathPoint1 == null || userPathPoint1.PathPoints.Count <= 0)
      return;
    foreach (InMapPoint pathPoint in userPathPoint1.PathPoints)
      this.Myself.InMapPathPoints.Add(new InMapPoint()
      {
        Arrived = false,
        Cleared = false,
        SectionName = mapSection,
        PosX = pathPoint.PosX,
        PosY = pathPoint.PosY,
        STT = pathPoint.STT,
        Horse = pathPoint.Horse
      });
  }

  public void Loadphubanpp(int mapID = -1)
  {
    if (mapID == -1)
      return;
    bool flag = false;
    if (this.Myself.InMapPathPoints.Count == 0)
      flag = true;
    else if (this.Myself.InMapPathPoints[0].MapID != mapID)
    {
      flag = true;
      this.Myself.InMapPathPoints.Clear();
    }
    if (!flag)
      return;
    foreach (PhuBanPathDBNewElement pathDbNewElement in frmLogin.GAuto.PhuBanPathDBNew)
    {
      if (pathDbNewElement.MapID == mapID)
        this.Myself.InMapPathPoints.Add(new InMapPoint()
        {
          Arrived = false,
          Cleared = false,
          MapID = mapID,
          PosX = pathDbNewElement.PosX,
          PosY = pathDbNewElement.PosY,
          STT = pathDbNewElement.STT,
          Horse = pathDbNewElement.Horse,
          khinhcong = pathDbNewElement.khinhcong,
          DanhQuai = pathDbNewElement.DanhQuai
        });
    }
    this.Myself.InMapPathPoints.Sort(new Comparison<InMapPoint>(this.PointComparison));
  }

  public void CalcNearPoint()
  {
    if (this.Myself.InMapPathPoints.Count <= 0 || !this.Myself.indexPPcalc)
      return;
    int num1 = 0;
    if (this.Myself.InPathPointIndex != 0 || this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived || (double) this.Myself.PosX <= 0.0 || (double) this.Myself.PosY <= 0.0)
      return;
    double num2 = 999.0;
    int num3 = 0;
    for (int index = 0; index < this.Myself.InMapPathPoints.Count; ++index)
    {
      InMapPoint inMapPathPoint = this.Myself.InMapPathPoints[index];
      if (this.Myself.isYTO)
      {
        if (this.Myself.InMapPathPoints[index].khinhcong == 1)
        {
          ++num3;
          continue;
        }
        if (this.Myself.QuestStep == 0)
        {
          if (num3 >= 16 /*0x10*/ && num3 <= 21)
          {
            ++num3;
            continue;
          }
        }
        else if (num3 <= 15)
        {
          ++num3;
          continue;
        }
      }
      double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) inMapPathPoint.PosX, (double) inMapPathPoint.PosY);
      if (distance < num2)
      {
        num2 = distance;
        num1 = num3;
      }
      ++num3;
    }
    if (num1 == this.Myself.InMapPathPoints.Count - 1 && !this.Myself.isYTO)
      return;
    this.Myself.InPathPointIndex = num1;
  }

  public void CalcNearPointForOutMap()
  {
    if (this.Myself.OutMapPathPoints.Count <= 0)
      return;
    int num1 = 0;
    double num2 = 999.0;
    int num3 = 0;
    for (int index = 0; index < this.Myself.OutMapPathPoints.Count; ++index)
    {
      InMapPoint outMapPathPoint = this.Myself.OutMapPathPoints[index];
      double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) outMapPathPoint.PosX, (double) outMapPathPoint.PosY);
      if (distance < num2)
      {
        num2 = distance;
        num1 = num3;
      }
      ++num3;
    }
    this.Myself.OutPathPointIndex = num1;
  }

  public void PlayMyLockSkill()
  {
    if (this.MyQuai.TargetID < 0)
      return;
    if (this.Myself.Menpai == AllEnums.Menpais.TIEUDAO)
      this.CallAttackTarget(this.MyQuai.TargetID, 547, 0, 0);
    else if (this.Myself.Menpai == AllEnums.Menpais.THIENLONG)
    {
      this.CallAttackTarget(this.MyQuai.TargetID, 465, 0, 0);
      this.CallAttackTarget(this.MyQuai.TargetID, 490, 0, 0);
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.VODANG)
    {
      this.CallAttackTarget(this.MyQuai.TargetID, 378, 0, 0);
      this.CallAttackTarget(this.MyQuai.TargetID, 391, 0, 0);
      this.CallAttackTarget(this.MyQuai.TargetID, 397, 0, 0);
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.THIENSON)
    {
      this.CallAttackTarget(this.MyQuai.TargetID, 518, 0, 0);
      this.CallAttackTarget(this.MyQuai.TargetID, 495, 0, 0);
      this.CallAttackTarget(this.MyQuai.TargetID, 511 /*0x01FF*/, 0, 0);
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.NGAMI)
    {
      this.CallAttackTarget(this.MyQuai.TargetID, 405, 0, 0);
      this.CallAttackTarget(this.MyQuai.TargetID, 428, 0, 0);
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.CAIBANG)
    {
      this.CallAttackTarget(this.MyQuai.TargetID, 345, 0, 0);
      this.CallAttackTarget(this.MyQuai.TargetID, 348, 0, 0);
      this.CallAttackTarget(this.MyQuai.TargetID, 364, 0, 0);
      this.CallAttackTarget(this.MyQuai.TargetID, 367, 0, 0);
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.THIEULAM)
    {
      this.CallAttackTarget(this.MyQuai.TargetID, 282, 0, 0);
      this.CallAttackTarget(this.MyQuai.TargetID, 285, 0, 0);
      this.CallAttackTarget(this.MyQuai.TargetID, 308, 0, 0);
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.TINHTUC)
    {
      this.CallAttackTarget(this.MyQuai.TargetID, 457, 0, 0);
      this.CallAttackTarget(this.MyQuai.TargetID, 455, 0, 0);
      this.CallAttackTarget(this.MyQuai.TargetID, 435, 0, 0);
    }
    else
    {
      if (this.Myself.Menpai != AllEnums.Menpais.MINHGIAO)
        return;
      this.CallAttackTarget(this.MyQuai.TargetID, 315, 0, 0);
      this.CallAttackTarget(this.MyQuai.TargetID, 337, 0, 0);
      this.CallAttackTarget(this.MyQuai.TargetID, 327, 0, 0);
    }
  }

  public int SearchTLC(int mapID)
  {
    int num1 = -1;
    int num2 = -1;
    for (int index = 0; index < 30; ++index)
    {
      InventoryItem allItem = this.MyInventory.AllItems[index];
      if (allItem.ItemID == 30008007 || allItem.ItemID == 30505216 || allItem.ItemID == 38001079)
      {
        if (allItem.ItemMapID == mapID)
          return index;
        if (index == 0)
          num1 = index;
      }
      if (allItem.ItemID >= 30501017 && allItem.ItemID <= 30501042 && allItem.ItemID != 30501035 && allItem.ItemID != 30501036)
      {
        if (allItem.ItemMapID == 0)
        {
          if (allItem.DinhViPhuTime > (byte) 0)
            num2 = index;
        }
        else
          num2 = index;
        if (index == 0)
          num2 = index;
      }
    }
    if (num1 == -1)
    {
      GA.ShowBalloon(frmMain.langNotFoundTLCMsg, frmMain.langNotFoundTLC, this, 10000);
      num1 = num2;
    }
    return num1;
  }

  public int GetKhinhCongID()
  {
    int khinhCongId = 34;
    if (this.Myself.Menpai == AllEnums.Menpais.MODUNG)
      khinhCongId = 110;
    else if (this.Myself.Menpai == AllEnums.Menpais.THIEULAM)
      khinhCongId = 23;
    else if (this.Myself.Menpai == AllEnums.Menpais.TINHTUC)
      khinhCongId = 28;
    else if (this.Myself.Menpai == AllEnums.Menpais.VODANG)
      khinhCongId = 26;
    else if (this.Myself.Menpai == AllEnums.Menpais.THIENSON)
      khinhCongId = 30;
    else if (this.Myself.Menpai == AllEnums.Menpais.MINHGIAO)
      khinhCongId = 24;
    else if (this.Myself.Menpai == AllEnums.Menpais.NGAMI)
      khinhCongId = 27;
    else if (this.Myself.Menpai == AllEnums.Menpais.TIEUDAO)
      khinhCongId = 31 /*0x1F*/;
    else if (this.Myself.Menpai == AllEnums.Menpais.THIENLONG)
      khinhCongId = 29;
    else if (this.Myself.Menpai == AllEnums.Menpais.DUONGMON)
      khinhCongId = 2942;
    else if (this.Myself.Menpai == AllEnums.Menpais.CAIBANG)
      khinhCongId = 25;
    return khinhCongId;
  }

  public void BuyListItemKNB()
  {
    int num1 = 0;
    List<ItemToBuy> itemToBuyList = new List<ItemToBuy>();
    for (int index = 0; index < this.Settings.ListItemToBuy.Count; ++index)
    {
      ItemToBuy itemToBuy = this.Settings.ListItemToBuy[index];
      if (itemToBuy.Name.Contains("KNB") || itemToBuy.Name.Contains("YB") || itemToBuy.Name.Contains("TK"))
      {
        itemToBuy.invenCount = 0;
        itemToBuyList.Add(itemToBuy);
      }
    }
    while (true)
    {
      for (int index1 = 0; index1 < 30; ++index1)
      {
        InventoryItem allItem = this.MyInventory.AllItems[index1];
        if (allItem.ItemID > 0)
        {
          for (int index2 = 0; index2 < itemToBuyList.Count; ++index2)
          {
            if (allItem.ItemID == itemToBuyList[index2].ID)
            {
              ++itemToBuyList[index2].invenCount;
              if (allItem.ItemID != 31000001 && allItem.ItemID != 31000003 && allItem.ItemID != 30607001)
              {
                itemToBuyList[index2].buyStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                this.CallUseItem(index1, this.Myself.ID);
                Thread.Sleep(150);
                break;
              }
              break;
            }
          }
        }
      }
      if (num1 <= 0)
      {
        for (int index3 = 0; index3 < itemToBuyList.Count; ++index3)
        {
          int num2 = itemToBuyList[index3].Amount - itemToBuyList[index3].invenCount;
          if (num2 > 0 && (frmLogin.GlobalTimer.ElapsedMilliseconds - itemToBuyList[index3].buyStamp >= (long) itemToBuyList[index3].buyStampMax || itemToBuyList[index3].buyStamp == 0L))
          {
            ++num1;
            this.OpenKNBShop(itemToBuyList[index3].MenuKNB1, itemToBuyList[index3].MenuKNB2);
            Thread.Sleep(300);
            this.BuyKNBItem(itemToBuyList[index3].MenuIndex);
            Thread.Sleep(200);
            if (num2 > 1)
            {
              for (int index4 = 1; index4 < num2; ++index4)
              {
                this.BuyKNBItem(itemToBuyList[index3].MenuIndex);
                Thread.Sleep(200);
              }
            }
          }
        }
        if (num1 > 0)
          Thread.Sleep(300);
        else
          goto label_16;
      }
      else
        break;
    }
    return;
label_16:;
  }

  public bool isThisMyFriend(PlayerIndividual player)
  {
    bool flag = false;
    for (int index = frmLogin.GAuto.AllAutoAccounts.Count - 1; index >= 0; --index)
    {
      if (frmLogin.GAuto.AllAutoAccounts[index].Myself.DatabaseID == player.DatabaseID)
      {
        flag = true;
        break;
      }
    }
    if (this.MyParty.PartyNumbers >= 1 && !flag)
    {
      for (int partyNumbers = this.MyParty.PartyNumbers; partyNumbers >= 0; --partyNumbers)
      {
        if (this.MyParty.AllMembers[partyNumbers].DatabaseID == player.DatabaseID)
        {
          flag = true;
          break;
        }
      }
    }
    if (this.MyArmy.HasQuanDoan && this.Target.VersionNum != 3 && this.Target.VersionNum != 4 && !flag)
    {
      for (int index = 0; index < 30; ++index)
      {
        if (this.MyArmy.AllMembers[index].DatabaseID == player.DatabaseID)
        {
          flag = true;
          break;
        }
      }
    }
    return flag;
  }

  public bool isThisMyFriendbyName(string iName = "")
  {
    bool flag = false;
    for (int index = frmLogin.GAuto.AllAutoAccounts.Count - 1; index >= 0; --index)
    {
      if (frmLogin.GAuto.AllAutoAccounts[index].Myself.Name == iName)
      {
        flag = true;
        break;
      }
    }
    if (this.MyParty.PartyNumbers >= 1 && !flag)
    {
      for (int partyNumbers = this.MyParty.PartyNumbers; partyNumbers >= 0; --partyNumbers)
      {
        if (this.MyParty.AllMembers[partyNumbers].Name == iName)
        {
          flag = true;
          break;
        }
      }
    }
    if (this.MyArmy.HasQuanDoan && this.Target.VersionNum != 3 && this.Target.VersionNum != 4 && !flag)
    {
      for (int index = 0; index < 30; ++index)
      {
        if (this.MyArmy.AllMembers[index].Name == iName)
        {
          flag = true;
          break;
        }
      }
    }
    return flag;
  }

  private void auto_paths_fix(ref int posX, ref int posY, ref int mapID, ref int npcID)
  {
    if (this.Target.VersionNum == 3)
    {
      if (mapID == 1 && npcID == 151)
        npcID = 75;
      if (posX == 304 && posY == 149 && GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) posX, (double) posY) <= 3.0)
      {
        Thread.Sleep(1000);
        this.CallMoveTo(298, 149);
        Thread.Sleep(2000);
      }
      if (mapID == 4 && posX == 90 && posY == 21)
      {
        posX = 91;
        posY = 23;
      }
      if (mapID == 8 && npcID == 95)
        npcID = 254;
    }
    if (GA.ClientVersion(this) != 10)
      return;
    if (mapID == 1)
      npcID = 151;
    if (mapID == 0)
    {
      if (posX == 235 && posY == 322)
      {
        posX = 140;
        posY = 183;
      }
      else if (posX == 85 && posY == 257)
      {
        posX = 33;
        posY = 130;
      }
      else if (posX == 441 && posY == 260)
      {
        posX = 286;
        posY = 129;
      }
      else
      {
        if (posX != (int) byte.MaxValue || posY != 465)
          return;
        posX = 159;
        posY = 287;
      }
    }
    else if (mapID == 2)
    {
      if (posX == 251 && posY == 122)
      {
        posX = 241;
        posY = 136;
      }
      else if (posX == 304 && posY == 149)
      {
        posX = 288;
        posY = 151;
      }
      else if (posX == 31 /*0x1F*/ && posY == 148)
      {
        posX = 31 /*0x1F*/;
        posY = 151;
      }
      else
      {
        if (posX != 159 || posY != 293)
          return;
        posX = 159;
        posY = 287;
      }
    }
    else if (mapID == 1)
    {
      if (posX == 334 && posY == 224 /*0xE0*/)
      {
        posX = 240 /*0xF0*/;
        posY = 128 /*0x80*/;
      }
      else if (posX == 65 && posY == 270)
      {
        posX = 32 /*0x20*/;
        posY = 162;
      }
      else if (posX == 279 && posY == 44)
      {
        posX = 181;
        posY = 33;
      }
      else
      {
        if (posX != 278 || posY != 413)
          return;
        posX = 182;
        posY = 287;
      }
    }
    else if (mapID == 4)
    {
      if (posX != 90 || posY != 21)
        return;
      posX = 91;
      posY = 23;
    }
    else
    {
      if (mapID != 30 || npcID != 23)
        return;
      npcID = 91;
    }
  }

  public void CallAddPetPoint(int petDBid, int point, int type)
  {
    int wParam = this.Myself.DatabaseID;
    if (GA.CheckGameVersion(this.Target.VersionNum) == 356)
      wParam = this.MyPet.ActivePetGuidID;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ADDPETPOINT_1, (IntPtr) wParam, (IntPtr) petDBid);
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ADDPETPOINT_2, (IntPtr) point, (IntPtr) type);
  }

  private bool WaitPacketMsg(string PacketMsg, int timeWait = 2000, bool resetMsg = true)
  {
    bool flag = true;
    long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
    while (this.Myself.PacketMsg != PacketMsg)
    {
      if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds > (long) timeWait)
      {
        flag = false;
        break;
      }
      Thread.Sleep(100);
    }
    if (resetMsg)
      this.ResetPacketMsg();
    return flag;
  }

  public void CallQuestItemChoice(int menuType, int itemChoice)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_QUESTITEMCHOICE, (IntPtr) menuType, (IntPtr) itemChoice);
  }

  public bool isSkillNguTong(int skillID)
  {
    if (skillID >= 1851 && skillID <= 1898)
      return true;
    return skillID >= 2500 && skillID <= 2547;
  }

  public void StopAttackNow()
  {
    if (this.Myself.ActionStatus != (byte) 7 && this.Myself.ActionStatus != (byte) 5)
      return;
    this.MyFlag.noBuffStamp = frmLogin.GlobalTimer.ElapsedMilliseconds - 9000L;
    this.MyFlag.noAttackStamp = frmLogin.GlobalTimer.ElapsedMilliseconds - 4000L;
    if (this.MySkills.KhinhCongID > 0)
    {
      this.CallAttackTarget(-1, this.MySkills.KhinhCongID, 0, 0);
    }
    else
    {
      this.CallAttackTarget(-1, 34, 0, 0);
      this.CallAttackTarget(-1, this.GetKhinhCongID(), 0, 0);
    }
  }

  public bool isInDiaPhu()
  {
    if (this.Myself.MapID == 77 || this.Myself.MapID == 463)
      return true;
    if (GA.CheckGameVersion(this.Target.VersionNum) != 356)
      return false;
    if (this.Myself.MapID == 584 || this.Myself.MapID == 585 || this.Myself.MapID == 586)
      return true;
    return this.Myself.MapID >= 972 && this.Myself.MapID <= 977;
  }

  public void CallHuyItemNhiemVu(int index)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_HUYITEMNHIEMVU, (IntPtr) index, (IntPtr) 0);
  }

  public bool TrieuTapToQuestPoint(int toX, int toY, int tomapID)
  {
    bool questPoint = false;
    if (this.CustomSleep(5, 3000))
    {
      ++this.Myself.trieutapCounter;
      if (this.Myself.trieutapCounter == 1)
        GA.TrieuTapToMyPos(this, toX, toY, tomapID);
      else if (this.Myself.trieutapCounter >= 3)
        this.Myself.trieutapCounter = 0;
      if (this.GoToMyPos(toX, toY, tomapID) && this.WaitPartyFull(2, this.Settings.numPTLevel))
      {
        this.CallMoveTo(toX, toY);
        GA.TrieuTapCaNhom(this, true);
        if (this.CheckMemberGPS(7, toX, toY, tomapID))
          questPoint = true;
        else
          GA.ShowBalloon(frmMain.langQ1KetMap, frmMain.langPhuBanTitleWarning, this, 10000);
      }
    }
    return questPoint;
  }

  public QuaiIndividual TimQuaiXungQuanh()
  {
    QuaiIndividual quaiIndividual = (QuaiIndividual) null;
    if (this.MyQuai.AllQuai.Count > 0)
    {
      try
      {
        for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
        {
          QuaiIndividual quai = this.MyQuai.AllQuai[index];
          bool flag = true;
          if (this.HasActivePet())
          {
            if (quai.ID != this.MyPet.AllPets[this.MyPet.ActivePetIndex].ID)
              flag = false;
          }
          else
            flag = false;
          if (quai.ID >= 0 && (double) quai.HPPercent > 0.0 && quai.ID != this.Myself.ID && !flag && this.CanAttack(quai))
          {
            quaiIndividual = quai;
            this.CallSelectTarget(quaiIndividual.ID);
          }
        }
      }
      catch (Exception ex)
      {
        GA.WriteUserLog(frmMain.langErrorLookforQuai2, this);
      }
    }
    if (quaiIndividual == null && this.Myself.hetquaiStamp == 1L)
      this.Myself.hetquaiStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    return quaiIndividual;
  }

  public void RemovePartyFollowForce()
  {
    if (this.Myself.IsPartyFollowed != (byte) 1)
      return;
    long num = frmLogin.GlobalTimer.ElapsedMilliseconds + 5000L;
    this.MyFlag.talkNPCStamp = 0L;
    while (this.Myself.IsPartyFollowed == (byte) 1)
    {
      this.CallRemovePartyFollow();
      if (num < frmLogin.GlobalTimer.ElapsedMilliseconds)
        break;
      Thread.Sleep(300);
    }
  }

  private void CallPickTheoDanhSach()
  {
    string itemName = "";
    string itemType = "";
    if (this.MyBoc.AllItems.Count <= 0)
      return;
    try
    {
      for (int index1 = this.MyBoc.AllItems.Count - 1; index1 >= 0; --index1)
      {
        ItemTrongBoc allItem = this.MyBoc.AllItems[index1];
        GA.GetItemNameTypeFromID(allItem.ItemID, out itemName, out itemType);
        bool flag = false;
        if (this.Settings.NhatItemMode == AllEnums.NhatItemModes.NHATLIST)
        {
          if (frmLogin.GAuto.Settings.ListItemNhat.Count > 0)
          {
            try
            {
              for (int index2 = frmLogin.GAuto.Settings.ListItemNhat.Count - 1; index2 >= 0; --index2)
              {
                string s = frmLogin.GAuto.Settings.ListItemNhat[index2];
                if (!string.IsNullOrEmpty(itemName) && (itemName.Contains(s.ToLower()) || itemType.Contains(s.ToLower()) || allItem.ItemID >= 60000000 && allItem.ItemID <= 60308010))
                {
                  flag = true;
                  break;
                }
                int result = 0;
                int.TryParse(s, out result);
                if (result > 0 && result == allItem.ItemID)
                {
                  flag = true;
                  break;
                }
              }
            }
            catch (Exception ex)
            {
              if (GA.isVipMember())
                GA.WriteUserLog("Lỗi đọc item trong list nhặt, báo ngay cho GATeam", this);
            }
          }
        }
        else
          goto label_17;
label_13:
        if (flag)
        {
          this.CallPickItemPacket(this.Myself.BocShowID, allItem.itemGUID1, allItem.itemGUID2);
          if (this.Myself.BocShowID == 0)
          {
            this.CallPickAllItems();
            continue;
          }
          continue;
        }
        continue;
label_17:
        if (this.Settings.NhatItemMode == AllEnums.NhatItemModes.NHATLOAITRU)
        {
          flag = true;
          try
          {
            for (int index3 = this.Settings.ListItemNhatIgnore.Count - 1; index3 >= 0; --index3)
            {
              string s = this.Settings.ListItemNhatIgnore[index3];
              if (!string.IsNullOrEmpty(itemName) && (itemName.Contains(s.ToLower()) || itemType.Contains(s.ToLower())))
              {
                flag = false;
                break;
              }
              int result = 0;
              int.TryParse(s, out result);
              if (result > 0 && result == allItem.ItemID)
              {
                flag = false;
                break;
              }
            }
            goto label_13;
          }
          catch (Exception ex)
          {
            if (GA.isVipMember())
            {
              GA.WriteUserLog("Lỗi đọc item trong list ko nhặt, báo ngay cho GATeam", this);
              goto label_13;
            }
            goto label_13;
          }
        }
        else
          goto label_13;
      }
    }
    catch (Exception ex)
    {
    }
  }

  private void ClearPickedBocList()
  {
    for (int index = 0; index < this.MyBoc.PickedBocList.Count; ++index)
      this.MyBoc.PickedBocList[index].BocID = 0;
  }

  private void PlayPetAOE(int posX, int posY)
  {
    if (!frmLogin.GAuto.Settings.IsPro1 || !this.Settings.cboxAOE)
      return;
    if (!this.HasActivePet())
      return;
    try
    {
      if (this.MyPet.AllPets[this.MyPet.ActivePetIndex].PhaQuanDelay > 500)
        return;
      int skillID = -1;
      if (frmLogin.GAuto.Settings.AOEPetSkills.Contains(this.MyPet.AllPets[this.MyPet.ActivePetIndex].PetSkill1))
        skillID = this.MyPet.AllPets[this.MyPet.ActivePetIndex].PetSkill1;
      if (skillID == -1)
      {
        if (frmLogin.GAuto.Settings.AOEPetSkills.Contains(this.MyPet.AllPets[this.MyPet.ActivePetIndex].PetSkill2))
          skillID = this.MyPet.AllPets[this.MyPet.ActivePetIndex].PetSkill2;
        else if (frmLogin.GAuto.Settings.AOEPetSkills.Contains(this.MyPet.AllPets[this.MyPet.ActivePetIndex].PetSkill3))
          skillID = this.MyPet.AllPets[this.MyPet.ActivePetIndex].PetSkill3;
        if (frmLogin.GAuto.Settings.AOEPetSkills.Contains(this.MyPet.AllPets[this.MyPet.ActivePetIndex].PetSkill4))
          skillID = this.MyPet.AllPets[this.MyPet.ActivePetIndex].PetSkill4;
      }
      if (skillID == -1)
        return;
      bool flag = true;
      if (GA.IsInPhuBan(this.Myself.MapID, this) && this.Myself.CurrentTarget != null && (double) this.Myself.CurrentTarget.PosX >= 35.0 && (double) this.Myself.CurrentTarget.PosX <= 75.0 && (double) this.Myself.CurrentTarget.PosY >= 45.0 && (double) this.Myself.CurrentTarget.PosX <= 80.0 && this.MyQuai.noAttackArray.Count > 0)
      {
        for (int index = 0; index < this.MyQuai.noAttackArray.Count; ++index)
        {
          if (this.MyQuai.noAttackArray[index] == frmMain.langNguyTongQuanDoThong)
            flag = false;
        }
      }
      if (!flag || posX <= 0 || posY <= 0 || !this.CustomSleep(0, 60000))
        return;
      this.CallAttackTargetPacket(this.MyPet.AllPets[this.MyPet.ActivePetIndex].ID, skillID, 0, posX, posY);
    }
    catch (Exception ex)
    {
      GA.WriteUserLog($"{frmMain.langPetAOEError}{this.MyPet.ActivePetIndex.ToString()}\n{ex.Message}\n{ex.StackTrace}", this);
    }
  }

  public bool CustomSleep(int mode, int delay)
  {
    bool flag = false;
    while (mode >= this.MyFlag.CustomSleepStamp.Count)
    {
      try
      {
        this.MyFlag.CustomSleepStamp.Add(0L);
      }
      catch (Exception ex1)
      {
        if (Monitor.TryEnter(this.MyFlag.CustomSleepLock, 200))
        {
          try
          {
            this.MyFlag.CustomSleepStamp.Add(0L);
          }
          catch (Exception ex2)
          {
          }
          finally
          {
            Monitor.Exit(this.MyFlag.CustomSleepLock);
          }
        }
      }
    }
    if (this.MyFlag.CustomSleepStamp[mode] >= frmLogin.GlobalTimer.ElapsedMilliseconds)
    {
      if (delay != 0)
        return flag;
    }
    try
    {
      this.MyFlag.CustomSleepStamp[mode] = frmLogin.GlobalTimer.ElapsedMilliseconds + (long) delay;
    }
    catch (Exception ex3)
    {
      if (Monitor.TryEnter(this.MyFlag.CustomSleepLock, 200))
      {
        try
        {
          this.MyFlag.CustomSleepStamp[mode] = this.nowStamp() + (long) delay;
        }
        catch (Exception ex4)
        {
        }
        finally
        {
          Monitor.Exit(this.MyFlag.CustomSleepLock);
        }
      }
    }
    return true;
  }

  private void NhanQuaGame()
  {
    if (GA.CheckGameVersion(this.Target.VersionNum) != 356)
      return;
    int delay = 60000;
    if (this.Myself.Level > 29 || !this.CustomSleep(1, delay))
      return;
    this.CallStringWithEnv(33);
  }

  public void SetTimeAnToan() => this.DoSomeThingDLL(1);

  public void CallClickAcceptBoxDaiLy(int gateID) => this.DoSomeThingDLL(2);

  public long nowStamp() => frmLogin.GlobalTimer.ElapsedMilliseconds;

  public void whileSleep(int sleepTime, int mode = 0)
  {
    long num = this.nowStamp() + (long) sleepTime;
    while (num > this.nowStamp())
    {
      Thread.Sleep(300);
      if (mode == 1 && this.Myself.isAcceptBox == 0)
        break;
    }
  }

  private void DoSomeThingDLL(int wParam, int lParam = 0)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_DOSOMETHING, (IntPtr) wParam, (IntPtr) lParam);
  }

  public void AIActionSet(int mode)
  {
    if (!Monitor.TryEnter(this.MyFlag.AIActionLock, 200))
      return;
    try
    {
      this.MyFlag.AIAction = mode;
    }
    finally
    {
      Monitor.Exit(this.MyFlag.AIActionLock);
    }
  }

  public void CheckPickStuck()
  {
    if (this.MyFlag.AIAction != 1)
      return;
    long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
    int posX = (int) this.Myself.PosX;
    int posY = (int) this.Myself.PosY;
    while (this.IsAIEnabled)
    {
      Random random = new Random();
      this.CallMoveTo((int) this.Myself.PosX + random.Next(-2, 2), (int) this.Myself.PosY + random.Next(-2, 2));
      Thread.Sleep(280);
      if (posX != (int) this.Myself.PosX || posY != (int) this.Myself.PosY || frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds > 1200L)
        break;
    }
    this.AIActionSet(0);
  }

  public int InventorySearch(int itemCode = 0, string itemName = "", int indexS = 0, int indexE = 80 /*0x50*/)
  {
    int num = -1;
    if (itemCode > 0)
    {
      for (int index = indexS; index <= indexE; ++index)
      {
        if (this.MyInventory.AllItems[index].ItemID == itemCode)
        {
          num = index;
          break;
        }
      }
    }
    if (itemName != "")
    {
      for (int index = indexS; index <= indexE; ++index)
      {
        if (this.MyInventory.AllItems[index].ItemName == itemName)
        {
          num = index;
          break;
        }
      }
    }
    return num;
  }

  public int InventorySearchByRange(int itemCodeS, int itemCodeE, int indexS = 0, int indexE = 80 /*0x50*/)
  {
    int num = -1;
    for (int index = indexS; index <= indexE; ++index)
    {
      InventoryItem allItem = this.MyInventory.AllItems[index];
      if (itemCodeS <= allItem.ItemID && allItem.ItemID <= itemCodeE)
      {
        num = index;
        break;
      }
    }
    return num;
  }

  public void AddLockInt(ref int myFlag, int myInt)
  {
    if (!Monitor.TryEnter(this.MyFlag.MyFlagLock, 200))
      return;
    try
    {
      myFlag = myInt;
    }
    catch (Exception ex)
    {
    }
    finally
    {
      Monitor.Exit(this.MyFlag.MyFlagLock);
    }
  }

  public void PacketInfoGetPos(string packetString)
  {
    string midString = GA.GetMidString(packetString, "*", "}", 3);
    try
    {
      if (!(midString != ""))
        return;
      string[] strArray = midString.Split('*');
      if (strArray.Length < 3)
        return;
      strArray[strArray.Length - 3] = strArray[strArray.Length - 3].Substring(1, strArray[strArray.Length - 3].Length - 1);
      strArray[strArray.Length - 2] = strArray[strArray.Length - 2].Substring(1, strArray[strArray.Length - 2].Length - 1);
      strArray[strArray.Length - 1] = strArray[strArray.Length - 1].Substring(1, strArray[strArray.Length - 1].Length - 1);
      int result1 = 0;
      int result2 = 0;
      int result3 = -1;
      int.TryParse(strArray[strArray.Length - 3], out result1);
      int.TryParse(strArray[strArray.Length - 2], out result2);
      int.TryParse(strArray[strArray.Length - 1], out result3);
      if (result1 <= 0 || result2 <= 0 || this.Myself == null)
        return;
      this.Myself.NhiemVuPosX = result1;
      this.Myself.NhiemVuPosY = result2;
      this.Myself.NhiemVuMapID = result3;
    }
    catch (Exception ex)
    {
    }
  }

  public void PacketInfoGetXY(string packetString, int cutIndex = 2)
  {
    string midString = GA.GetMidString(packetString, "*", "}", cutIndex);
    try
    {
      if (!(midString != ""))
        return;
      string[] strArray = midString.Split('*');
      if (strArray.Length < 2)
        return;
      int result1 = 0;
      int result2 = 0;
      int.TryParse(strArray[0].Substring(1, strArray[0].Length - 1), out result1);
      int.TryParse(strArray[1].Substring(1, strArray[1].Length - 1), out result2);
      if (result1 <= 0 || result2 <= 0 || this.Myself == null)
        return;
      this.Myself.NhiemVuPosX = result1;
      this.Myself.NhiemVuPosY = result2;
    }
    catch (Exception ex)
    {
    }
  }

  public QuaiIndividual SearchQuaiByInput(
    string quaiName = "",
    int bossValue = 0,
    bool attack = false,
    bool exactly = true)
  {
    QuaiIndividual quaiIndividual1 = (QuaiIndividual) null;
    if (this.MyQuai.AllQuai.Count > 0)
    {
      try
      {
        for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
        {
          QuaiIndividual quaiIndividual2 = this.MyQuai.AllQuai[index];
          if (quaiName != "" && (quaiName == quaiIndividual2.Name && exactly || quaiIndividual2.Name.Contains(quaiName) && !exactly))
          {
            quaiIndividual1 = quaiIndividual2;
            break;
          }
          if (bossValue > 0 && bossValue == quaiIndividual2.IsBossValue)
          {
            quaiIndividual1 = quaiIndividual2;
            break;
          }
        }
      }
      catch (Exception ex)
      {
      }
    }
    if (quaiIndividual1 != null && attack && quaiIndividual1.ID >= 0)
    {
      this.CallSelectTarget(quaiIndividual1.ID);
      this.CallAttackTarget(quaiIndividual1.ID, this.MySkills.AllSkills[0].ID, 0, 0);
    }
    return quaiIndividual1;
  }

  private bool CalcTimeOut(int maxTime = 7000)
  {
    bool flag = false;
    if (this.MyFlag.CalcTimeOutStamp < this.nowStamp())
      this.MyFlag.CalcTimeOutStamp = this.nowStamp() + 10000L + (long) maxTime;
    long num = this.MyFlag.CalcTimeOutStamp - this.nowStamp();
    if (0L < num && num < 10000L)
    {
      this.MyFlag.CalcTimeOutStamp = 0L;
      flag = true;
    }
    return flag;
  }

  private void waitQuestFrameShow()
  {
    long num = this.nowStamp() + 2000L;
    while (this.Myself.isQuestFrameShow == 0)
    {
      Thread.Sleep(200);
      if (num < this.nowStamp())
        break;
    }
  }

  public void CallMoPass2()
  {
    if (!this.Settings.cboxPassCap2 || string.IsNullOrEmpty(this.Settings.txtPassCap2) || this.Myself.Pass2Stamp.ElapsedMilliseconds < 5000L)
      return;
    this.CallSendPass2();
    Thread.Sleep(1000);
    this.Myself.Pass2Stamp.Reset();
    this.Myself.Pass2Stamp.Start();
  }

  public void CallMoPass2Ruong()
  {
    if (!this.Settings.cboxPassCap2 || string.IsNullOrEmpty(this.Settings.txtPassCap2) || !this.CustomSleep(9, 36000000))
      return;
    this.CallSendPass2();
  }

  public void CallSetupAutoMove(int posX, int posY, int mapID)
  {
    this.Myself.LongMoveMapID = mapID;
    this.Myself.LongMoveX = posX;
    this.Myself.LongMoveY = posY;
    if (this.Target.VersionNum == 3 || this.Target.VersionNum == 4)
      this.Myself.IsLongMove = true;
    else
      this.Myself.MoveLongTrigger = true;
    this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
    this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
    if (this.IsAIEnabled)
      return;
    this.IsAIEnabled = true;
  }

  public void CallResetAutoMove()
  {
    this.Myself.LongMoveX = 0;
    this.Myself.LongMoveY = 0;
    this.Myself.LongMoveMapID = -1;
    this.Myself.IsLongMove = false;
    this.Myself.SavedPosX = 0.0f;
    this.Myself.SavedPosY = 0.0f;
    this.Myself.SavedMapID = -1;
    this.Settings.SavedPosX = 0.0f;
    this.Settings.SavedPosY = 0.0f;
    this.Settings.SavedMapID = -1;
    this.Myself.MoveLongTrigger = false;
    if (this.Myself.SavedStatus == AllEnums.CharStatuses.GOGOGO)
      this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
    this.Myself.MinorStatus = AllEnums.CharStatuses.IDLE;
    this.Myself.Status = AllEnums.CharStatuses.IDLE;
  }

  private void HandleGLogin()
  {
    if (this.AutoProfile == null || !this.AutoProfile.NeedHandle || this.AutoProfile.InvalidPassword)
      return;
    if (this.MyFlag.InGameStatus == 2 && 0L < this.MyFlag.InGameFinishLoadingStamp && this.MyFlag.InGameFinishLoadingStamp <= this.nowStamp())
    {
      int serverID = 0;
      if (this.Target.VersionNum == 3)
      {
        bool flag = false;
        if (frmLogin.TKServers.Contains(this.AutoProfile.Server))
          flag = true;
        if (this.Target.SubVersion == 4 || flag)
        {
          if (frmLogin.TKServers.Count > 0)
          {
            for (int index = 0; index < frmLogin.TKServers.Count; ++index)
            {
              if (frmLogin.TKServers[index] == this.AutoProfile.Server)
              {
                serverID = index;
                break;
              }
            }
          }
        }
        else
        {
          int result = 0;
          int.TryParse(this.AutoProfile.Server, out result);
          if (result > 0)
            --result;
          serverID = result;
        }
        int num = 0;
        if (this.Target.SubVersion == 4 || flag)
        {
          if (this.AutoProfile.MinorServer != "" && frmLogin.TKMinorServers.Count > 0)
          {
            for (int index = 0; index < frmLogin.TKMinorServers.Count; ++index)
            {
              if (frmLogin.TKMinorServers[index] == this.AutoProfile.MinorServer)
              {
                num = index;
                break;
              }
            }
          }
          this.SetDLLValue(1, num);
        }
        this.CallInterfaceClick(18);
        Thread.Sleep(500);
        this.CallServerClickTK(serverID);
        Thread.Sleep(500);
        this.CallInterfaceClick(21);
        Thread.Sleep(500);
        this.CallInterfaceClick(14);
        Thread.Sleep(500);
        GA.SendMyString(this.Target.MainWindowHandle, this.AutoProfile.Username);
        this.CallInterfaceClick(15);
        Thread.Sleep(500);
        GA.SendMyString(this.Target.MainWindowHandle, GA.SecureStringToString(this.AutoProfile.Password));
        Thread.Sleep(500);
        GA.SendMyKey(this.Target.MainWindowHandle, 13);
        this.MyFlag.InGameStatus = 3;
        this.MyFlag.InGameFinishLoadingStamp = this.nowStamp() + 3000L;
      }
      else if (this.Target.VersionNum == 4)
      {
        if (frmLogin.TLUSServers.Count > 0)
        {
          for (int index = 0; index < frmLogin.TLUSServers.Count; ++index)
          {
            if (frmLogin.TLUSServers[index] == this.AutoProfile.Server)
            {
              serverID = index;
              break;
            }
          }
        }
        this.CallInterfaceClick(18);
        Thread.Sleep(500);
        this.CallInterfaceClick(18);
        Thread.Sleep(500);
        this.CallServerClickTK(serverID);
        Thread.Sleep(500);
        this.CallInterfaceClick(21);
        Thread.Sleep(500);
        this.CallInterfaceClick(14);
        Thread.Sleep(500);
        GA.SendMyString(this.Target.MainWindowHandle, this.AutoProfile.Username);
        this.CallInterfaceClick(15);
        Thread.Sleep(500);
        GA.SendMyString(this.Target.MainWindowHandle, GA.SecureStringToString(this.AutoProfile.Password));
        Thread.Sleep(500);
        GA.SendMyKey(this.Target.MainWindowHandle, 13);
        this.MyFlag.InGameStatus = 3;
        this.MyFlag.InGameFinishLoadingStamp = this.nowStamp() + 3000L;
      }
      else if (this.Target.VersionNum == 1 || this.Target.VersionNum == 2)
      {
        if (frmLogin.VNGServers.Count > 0)
        {
          for (int index = 0; index < frmLogin.VNGServers.Count; ++index)
          {
            if (frmLogin.VNGServers[index] == this.AutoProfile.Server)
            {
              serverID = index;
              break;
            }
          }
        }
        this.CallServerClick(serverID);
        Thread.Sleep(1000);
        this.CallInterfaceClick(14);
        Thread.Sleep(1000);
        GA.SendMyString(this.Target.MainWindowHandle, this.AutoProfile.Username);
        this.CallInterfaceClick(15);
        Thread.Sleep(1000);
        GA.SendMyString(this.Target.MainWindowHandle, GA.SecureStringToString(this.AutoProfile.Password));
        Thread.Sleep(1000);
        GA.SendMyKey(this.Target.MainWindowHandle, 13);
        Thread.Sleep(1000);
        this.MyFlag.InGameStatus = 3;
        this.MyFlag.InGameFinishLoadingStamp = this.nowStamp() + 3000L;
      }
    }
    if (this.MyFlag.InGameStatus == 4)
    {
      if (this.AutoProfile.InvalidPassword)
      {
        GA.WriteUserLog("Sai mật khẩu đăng nhập.", this);
      }
      else
      {
        this.CallInterfaceClick(17);
        Thread.Sleep(2000);
        GA.SendMyKey(this.Target.MainWindowHandle, 13);
        this.MyFlag.InGameStatus = 3;
        this.MyFlag.InGameFinishLoadingStamp = this.nowStamp() + 3000L;
      }
    }
    if (this.MyFlag.InGameStatus != 100 || 0L >= this.MyFlag.InGameFinishLoadingStamp || this.MyFlag.InGameFinishLoadingStamp > this.nowStamp())
      return;
    this.CallInterfaceClick(16 /*0x10*/);
    this.MyFlag.InGameStatus = 101;
    this.AutoProfile.NeedHandle = false;
    this.AutoProfile.IsHandled = true;
  }

  public bool AttackPlayer(int targetID = 0)
  {
    PlayerIndividual playerIndividual1 = (PlayerIndividual) null;
    PlayerIndividual playerIndividual2 = (PlayerIndividual) null;
    PlayerIndividual playerIndividual3 = (PlayerIndividual) null;
    PlayerIndividual playerIndividual4 = (PlayerIndividual) null;
    if ((this.Myself.HasTarget || this.MyQuai.TargetIDforPK >= 0 || targetID > 0) && (double) this.MyQuai.TargetHPPercent > 0.0)
    {
      int targetIdforPk = this.MyQuai.TargetIDforPK;
      try
      {
        for (int index = this.MyPlayers.AllPlayers.Count - 1; index >= 0; --index)
        {
          PlayerIndividual allPlayer = this.MyPlayers.AllPlayers[index];
          if (allPlayer.ID == targetIdforPk)
          {
            if (!this.isThisMyFriend(allPlayer))
            {
              playerIndividual1 = allPlayer;
              break;
            }
            break;
          }
        }
      }
      catch (Exception ex)
      {
        GA.WriteUserLog("Lỗi loop người chơi, vui lòng báo cho Admin", this);
      }
    }
    if (playerIndividual4 == null && playerIndividual1 != null)
      playerIndividual4 = playerIndividual1;
    if (targetID == 0)
    {
      if (playerIndividual4 == null && this.Settings.cboxPKPlayerList)
      {
        if (this.Settings.PKPlayerList.Count > 0)
        {
          try
          {
            for (int index1 = 0; index1 < this.Settings.PKPlayerList.Count; ++index1)
            {
              string pkPlayer = this.Settings.PKPlayerList[index1];
              if (pkPlayer != "")
              {
                if (this.MyPlayers.AllPlayers.Count > 0)
                {
                  try
                  {
                    for (int index2 = this.MyPlayers.AllPlayers.Count - 1; index2 >= 0; --index2)
                    {
                      PlayerIndividual allPlayer = this.MyPlayers.AllPlayers[index2];
                      if (allPlayer.Name == pkPlayer && (double) allPlayer.HPPercent > 0.0)
                      {
                        if (this.Settings.cboxPKThieuLamLast && allPlayer.Menpai == 0)
                        {
                          playerIndividual3 = allPlayer;
                        }
                        else
                        {
                          playerIndividual1 = allPlayer;
                          if (this.Settings.cboxPKNgaMyFirst)
                          {
                            if (allPlayer.Menpai == 4)
                            {
                              playerIndividual2 = allPlayer;
                              break;
                            }
                          }
                          else
                            break;
                        }
                      }
                    }
                  }
                  catch (Exception ex)
                  {
                    GA.WriteUserLog("Lỗi loop người chơi, vui lòng báo cho Admin", this);
                  }
                }
              }
            }
          }
          catch (Exception ex)
          {
            GA.WriteUserLog("Lỗi auto PK 1, Vui lòng báo cho Admin biết", this);
          }
        }
      }
      if (this.Settings.cboxPKNgaMyFirst && playerIndividual2 != null)
        playerIndividual4 = playerIndividual2;
      if (playerIndividual4 == null && playerIndividual1 != null)
        playerIndividual4 = playerIndividual1;
      if (playerIndividual4 == null && this.Settings.cboxPKBangList)
      {
        if (this.Settings.PKBangList.Count > 0)
        {
          try
          {
            for (int index3 = 0; index3 < this.Settings.PKBangList.Count; ++index3)
            {
              int pkBang = this.Settings.PKBangList[index3];
              if (this.MyPlayers.AllPlayers.Count > 0)
              {
                try
                {
                  for (int index4 = this.MyPlayers.AllPlayers.Count - 1; index4 >= 0; --index4)
                  {
                    PlayerIndividual allPlayer = this.MyPlayers.AllPlayers[index4];
                    bool flag1 = this.isThisMyFriend(allPlayer);
                    if (allPlayer.BangID == pkBang && (double) allPlayer.HPPercent > 0.0 && !flag1)
                    {
                      bool flag2 = false;
                      if (this.Settings.cboxBlacklist && this.Settings.PKBlackList.Count > 0)
                      {
                        for (int index5 = 0; index5 < this.Settings.PKBlackList.Count; ++index5)
                        {
                          string pkBlack = this.Settings.PKBlackList[index5];
                          if (allPlayer.Name == pkBlack)
                          {
                            flag2 = true;
                            break;
                          }
                        }
                      }
                      if (!flag2)
                      {
                        if (this.Settings.cboxPKThieuLamLast && allPlayer.Menpai == 0)
                        {
                          playerIndividual3 = allPlayer;
                        }
                        else
                        {
                          playerIndividual1 = allPlayer;
                          if (this.Settings.cboxPKNgaMyFirst)
                          {
                            if (allPlayer.Menpai == 4)
                            {
                              playerIndividual2 = allPlayer;
                              break;
                            }
                          }
                          else
                            break;
                        }
                      }
                    }
                  }
                }
                catch (Exception ex)
                {
                  GA.WriteUserLog("Lỗi loop người chơi, vui lòng báo cho Admin", this);
                }
              }
            }
          }
          catch (Exception ex)
          {
            GA.WriteUserLog("Lỗi auto PK 2, Vui lòng báo cho Admin biết", this);
          }
        }
      }
      if (this.Settings.cboxPKNgaMyFirst && playerIndividual1 != null)
        playerIndividual4 = playerIndividual2;
      if (playerIndividual4 == null && playerIndividual1 != null)
        playerIndividual4 = playerIndividual1;
      if (playerIndividual4 == null)
      {
        if (this.Settings.cboxPKAnyOne)
        {
          try
          {
            for (int index6 = this.MyPlayers.AllPlayers.Count - 1; index6 >= 0; --index6)
            {
              PlayerIndividual allPlayer = this.MyPlayers.AllPlayers[index6];
              bool flag3 = this.isThisMyFriend(allPlayer);
              if ((double) allPlayer.HPPercent > 0.0 && !flag3)
              {
                bool flag4 = false;
                if (this.Settings.cboxBlacklist && this.Settings.PKBlackList.Count > 0)
                {
                  for (int index7 = 0; index7 < this.Settings.PKBlackList.Count; ++index7)
                  {
                    string pkBlack = this.Settings.PKBlackList[index7];
                    if (allPlayer.Name == pkBlack)
                    {
                      flag4 = true;
                      break;
                    }
                  }
                }
                if (!flag4)
                {
                  if (this.Settings.cboxPKThieuLamLast && allPlayer.Menpai == 0)
                  {
                    playerIndividual3 = allPlayer;
                  }
                  else
                  {
                    playerIndividual1 = allPlayer;
                    if (this.Settings.cboxPKNgaMyFirst)
                    {
                      if (allPlayer.Menpai == 4)
                      {
                        playerIndividual2 = allPlayer;
                        break;
                      }
                    }
                    else
                      break;
                  }
                }
              }
            }
          }
          catch (Exception ex)
          {
            GA.WriteUserLog("Lỗi loop người chơi, vui lòng báo cho Admin", this);
          }
        }
      }
      if (this.Settings.cboxPKNgaMyFirst && playerIndividual2 != null)
        playerIndividual4 = playerIndividual2;
      if (playerIndividual4 == null && playerIndividual1 != null)
        playerIndividual4 = playerIndividual1;
      if (playerIndividual4 == null && playerIndividual3 != null)
        playerIndividual4 = playerIndividual3;
    }
    if (playerIndividual4 == null || playerIndividual4.ID < 0)
      return false;
    this.CallSelectTarget(playerIndividual4.ID);
    bool flag = false;
    double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) playerIndividual4.PosX, (double) playerIndividual4.PosY);
    if (distance <= 2.0 || this.Myself.CharType == AllEnums.CharTypes.NUKER && distance <= 11.0)
      flag = true;
    if (!flag)
      this.CallAttackTarget(playerIndividual4.ID, this.MySkills.AllSkills[0].ID, 0, 0, true);
    else
      this.CallAttackTargetPacket(this.Myself.ID, this.MySkills.AllSkills[0].ID, playerIndividual4.ID, 0, 0, true);
    if (this.Settings.SkillPKList.Count > 0)
    {
      foreach (SkillPlayItem skillPk in (List<SkillPlayItem>) this.Settings.SkillPKList)
      {
        if (this.PlayMySkill(skillPk, playerIndividual4.ID))
          break;
      }
    }
    this.PlayPetAOE((int) playerIndividual4.PosX, (int) playerIndividual4.PosY);
    return true;
  }

  public void AttackQuai(int nullDelay = 3000)
  {
    // hoint change: nếu ở đại lý thì ko làm gì cả
    if (this.Myself.MapID == 2)
    {
      return;
    }

    if (GA.isShitMember())
      Thread.Sleep(new Random().Next(1000, 2000));
    if (this.Myself.IDLEStamp - frmLogin.GlobalTimer.ElapsedMilliseconds > 0L)
      return;
    if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.MDPPlayDCTD <= 8000L)
    {
      if (this.Myself.ActionStatus != (byte) 7)
        return;
      this.CallAttackTarget(-1, 34, 0, 0);
    }
    else
    {
      if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.noAttackStamp <= 5000L || !this.Settings.cboxDanhQuai)
        return;
      bool flag1 = true;
      if (this.Myself.Status == AllEnums.CharStatuses.NMBUFFMAU || this.Myself.Status == AllEnums.CharStatuses.NHATBOC)
        flag1 = false;
      if (this.Myself.ActionStatus == (byte) 5 || this.Myself.ActionStatus == (byte) 6)
        flag1 = false;
      if (this.Myself.IsPK || this.Myself.IsPartyFollowed == (byte) 1)
        flag1 = false;
      if (this.WantMoveNow())
        flag1 = false;
      if (!flag1)
        return;
      bool flag2 = false;
      if (this.Myself.ListStatusNoAttack.Contains(this.Myself.Status))
        return;
      bool flag3 = false;
      if (this.Settings.FightMode == AllEnums.FightingModes.DANHGOMQUAI)
      {
        int num1 = 0;
        try
        {
          for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
          {
            QuaiIndividual quai = this.MyQuai.AllQuai[index];
            if (quai.ID > -1)
            {
              double distance = GA.CalculateDistance((double) quai.PosX, (double) quai.PosY, (double) this.Myself.PosX, (double) this.Myself.PosY);
              double num2 = AutoAccount.CheckQuaiPos0(quai, distance);
              if ((quai.IsHitByMe || !this.Settings.cboxGomQuaiKS || this.Settings.cboxGomQuaiKS && quai.JustHit == (byte) 1 || (double) quai.HPPercent < 100.0) && this.CanAttack(quai) && num2 <= this.Settings.Diameter4)
                ++num1;
              if ((!quai.IsHitByMe && !this.Settings.cboxGomQuaiKS || quai.JustHit == (byte) 0 && this.Settings.cboxGomQuaiKS && !quai.IsHitByMe) && !this.IsPet(quai) && this.CanAttack(quai) && !this.IsNPC(quai) && !this.IsPlayer(quai) && num2 <= this.Settings.Diameter4)
              {
                if (this.HasActivePet())
                {
                  if (quai.ID != this.MyPet.AllPets[this.MyPet.ActivePetIndex].ID)
                    flag2 = true;
                }
                else
                  flag2 = true;
              }
            }
          }
        }
        catch (Exception ex)
        {
        }
        if (num1 < this.Settings.numGomQuai && flag2)
        {
          flag3 = true;
          this.Myself.TempFightMode = AllEnums.FightingModes.DANHGOMQUAI;
        }
        else if (!flag2 || num1 >= this.Settings.numGomQuai)
        {
          flag3 = false;
          this.Myself.TempFightMode = AllEnums.FightingModes.DANHTUNGCON;
        }
      }
      QuaiIndividual quai1 = (QuaiIndividual) null;
      QuaiIndividual quaiIndividual = (QuaiIndividual) null;
      bool flag4 = false;
      if (this.Settings.cboxDanhTheoKey && this.MyParty.PartyNumbers > 0 || this.Settings.txtDanhTheoAi != "" && this.Settings.cboxDanhTheoAi)
      {
        Debug.WriteLine("flag 4 true--------------");
        flag4 = true;
      }
      bool flag5 = false;
      if (this.MyQuai.AllQuai.Count > 0)
      {
        if (!flag4)
        {
          try
          {
            for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
            {
              if ((this.MyQuai.AllQuai[index].Name.Contains("Ác Tăng") || this.MyQuai.AllQuai[index].Name.Contains("Evil Monk") || this.MyQuai.AllQuai[index].Name.Contains("Thị Ma Giả") || this.MyQuai.AllQuai[index].Name.Contains("Đào Thoán Phỉ Loại") || this.MyQuai.AllQuai[index].Name.Contains("Fleeing Gangsters")) && this.Myself.TempFightMode == AllEnums.FightingModes.DANHTUNGCON)
              {
                quai1 = this.MyQuai.AllQuai[index];
                flag5 = true;
                break;
              }
            }
          }
          catch (Exception ex)
          {
          }
        }
      }
      bool flag6 = false;
      if ((this.Settings.cboxDanhTheoKey && this.MyParty.PartyNumbers > 0 || this.Settings.txtDanhTheoAi != "" && this.Settings.cboxDanhTheoAi) && (this.MyQuai.TargetID != this.Myself.AttackedID || this.Myself.AttackedID == -1))
        flag6 = true;
      if (
        (this.MyQuai.TargetID == -1 ||
          !this.CanAttack() ||
          (double) this.MyQuai.TargetHPPercent <= (double) frmLogin.GAuto.Settings.releaseHPPercent ||
          this.Myself.CurrentTargetID == -1 ||
          flag3 || flag5 || flag6
        ) && (this.MyQuai.AllQuai.Count > 0 || flag4))
      {
        double num3 = 35.0;
        if (this.Myself.TempFightMode == AllEnums.FightingModes.DANHGOMQUAI)
          num3 = 0.0;
        bool flag7 = false;
        if (flag4)
        {
          PartyMember partyMember = (PartyMember) null;
          if (this.Settings.cboxDanhTheoKey && this.MyParty.PartyNumbers > 0 && !this.IsPartyKey())
            partyMember = this.MyParty.AllMembers[0];
          if (this.Settings.cboxDanhTheoAi)
          {
            if (this.Settings.txtDanhTheoAi == string.Empty)
              partyMember = this.MyParty.AllMembers[0];
            else if (this.MyPlayers.AllPlayers.Count > 0)
            {
              try
              {
                for (int index = this.MyPlayers.AllPlayers.Count - 1; index >= 0; --index)
                {
                  if (this.MyPlayers.AllPlayers[index].Name == this.Settings.txtDanhTheoAi)
                  {
                    partyMember = new PartyMember();
                    partyMember.DatabaseID = this.MyPlayers.AllPlayers[index].DatabaseID;
                    partyMember.ID = this.MyPlayers.AllPlayers[index].ID;
                    partyMember.PosX = this.MyPlayers.AllPlayers[index].PosX;
                    partyMember.PosY = this.MyPlayers.AllPlayers[index].PosY;
                    partyMember.MapID = this.MyPlayers.AllPlayers[index].MapID;
                    break;
                  }
                }
              }
              catch (Exception ex)
              {
              }
            }
          }
          if (!this.IsPartyKey() && this.Settings.cboxDanhTheoKey && partyMember != null || this.Settings.cboxDanhTheoAi && partyMember != null)
          {
            if (partyMember.MapID == this.Myself.MapID || this.MyQuai.TargetID == partyMember.ID)
            {
              AutoAccount autoAccount = (AutoAccount) null;
              if (frmLogin.GAuto.AllAutoAccounts.Count > 1)
              {
                try
                {
                  for (int index = frmLogin.GAuto.AllAutoAccounts.Count - 1; index >= 0; --index)
                  {
                    AutoAccount allAutoAccount = frmLogin.GAuto.AllAutoAccounts[index];
                    if (allAutoAccount != null && allAutoAccount.Myself != null && allAutoAccount.Myself.ID != this.Myself.ID && allAutoAccount.Myself.DatabaseID == partyMember.DatabaseID)
                    {
                      autoAccount = allAutoAccount;
                      break;
                    }
                  }
                }
                catch (Exception ex)
                {
                }
              }
              if (autoAccount != null)
              {
                int num4 = -1;
                if ((double) autoAccount.MyQuai.TargetHPPercent > 0.0)
                  num4 = autoAccount.MyQuai.TargetID;
                if (num4 >= 0 && num4 != this.Myself.ID)
                {
                  if (this.Myself.HorseType != -1)
                    this.CallMounting();
                  this.CallSelectTarget(num4);
                  if (this.Settings.cboxOnlyPet && this.HasActivePet())
                    this.CallAttackTargetPacket(this.Myself.ID, -1, num4, 0, 0);
                  else
                    this.CallAttackTarget(num4, this.MySkills.AllSkills[0].ID, 0, 0);
                  quai1 = this.MyQuai.GetQuaiByID(num4);
                  flag7 = true;
                }
              }
              else
              {
                if (this.Myself.MyAttackerID != partyMember.ID && partyMember.ID != -1)
                  this.Myself.MyAttackerID = partyMember.ID;
                bool flag8 = false;
                if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.targetKeyStamp >= 200L && (this.MyQuai.TargetID == -1 || this.MyQuai.TargetID == partyMember.ID || this.MyQuai.TargetID != this.Myself.AttackedID || (double) this.MyQuai.TargetHPPercent <= 0.0 || this.Myself.CurrentTargetID == -1) && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.AttackedIDStamp < 10000L)
                {
                  long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                  if ((this.MyQuai.TargetID == partyMember.ID || this.MyQuai.TargetID == -1 || this.MyQuai.TargetID != this.Myself.AttackedID || (double) this.MyQuai.TargetHPPercent <= 0.0 || this.MyQuai.TargetID != this.Myself.AttackedID && this.MyQuai.TargetID != -1 || this.IsPet() || this.IsNPC()) && this.Myself.AttackedID != -1 && this.MyQuai.TargetID != this.Myself.AttackedID)
                  {
                    long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                    while (this.MyQuai.TargetID != this.Myself.AttackedID)
                    {
                      this.CallSelectTarget(this.Myself.AttackedID);
                      Thread.Sleep(100);
                      if (this.MyQuai.TargetID == this.Myself.AttackedID)
                      {
                        flag8 = true;
                        break;
                      }
                      if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 >= 1000L)
                        break;
                    }
                  }
                }
                if (flag8 || this.Myself.AttackedID > 0 && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.AttackedIDStamp < 5000L)
                {
                  quai1 = this.MyQuai.GetQuaiByID(this.Myself.AttackedID);
                  if (quai1 == null && quai1 == null && this.Myself.AttackedID != 0)
                    quai1 = this.MyPlayers.GetPlayerByIDAsQuai(this.Myself.AttackedID);
                  if (quai1 != null && (quai1.ID == -1 || (double) quai1.HPPercent <= 0.0))
                    quai1 = (QuaiIndividual) null;
                }
                int targetID = -1;
                if (quai1 == null && this.Myself.ActionStatus == (byte) 7)
                {
                  if (this.MyQuai.TargetID >= 0)
                  {
                    targetID = this.MyQuai.TargetID;
                    quai1 = this.MyQuai.GetQuaiByID(this.MyQuai.TargetID);
                    if (quai1 != null)
                      this.CanAttack(quai1);
                  }
                  else
                    targetID = this.MyQuai.TargetIDforPK;
                }
                if (quai1 != null)
                {
                  if (quai1.ID >= 0)
                  {
                    if (this.Myself.HorseType != -1)
                      this.CallMounting();
                    this.Myself.CurrentTargetID = this.MyQuai.TargetID;
                    if (this.Settings.cboxOnlyPet && this.HasActivePet())
                    {
                      this.CallAttackTargetPacket(this.Myself.ID, -1, quai1.ID, 0, 0);
                    }
                    else
                    {
                      double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quai1.PosX, (double) quai1.PosY);
                      double num5 = AutoAccount.CheckQuaiPos0(quai1, distance);
                      if (num5 <= 11.0 && this.Myself.CharType == AllEnums.CharTypes.NUKER || num5 <= 2.0 && this.Myself.CharType == AllEnums.CharTypes.TANKER)
                        this.CallAttackTargetPacket(this.Myself.ID, this.MySkills.AllSkills[0].ID, quai1.ID, 0, 0);
                      else
                        this.CallAttackTarget(quai1.ID, this.MySkills.AllSkills[0].ID, 0, 0);
                    }
                    flag7 = true;
                  }
                }
                else if (targetID >= 0)
                  this.CallAttackTarget(targetID, this.MySkills.AllSkills[0].ID, 0, 0);
              }
            }
            if (!flag7 && !this.Settings.cboxDanhHoTro)
              flag7 = true;
          }
          if (this.Settings.cboxDanhTheoAi && this.Settings.txtDanhTheoAi != "" && partyMember == null)
            flag7 = true;
        }
        if (this.MyQuai.TargetID != -1 && (double) this.MyQuai.TargetHPPercent > 0.0)
          this.Myself.LastNullTargetStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
        if (!flag7 && (this.MyParty.PartyNumbers <= 0 || this.MyParty.PartyNumbers > 0 && (this.IsPartyKey() || !this.Settings.cboxDanhTheoKey)))
        {
          if (quai1 == null)
          {
            try
            {
              for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
              {
                QuaiIndividual quai2 = this.MyQuai.AllQuai[index];
                bool flag9 = true;
                if (this.HasActivePet())
                {
                  if (quai2.ID != this.MyPet.AllPets[this.MyPet.ActivePetIndex].ID)
                    flag9 = false;
                }
                else
                  flag9 = false;
                if (quai2.ID >= 0 && (double) quai2.HPPercent > 0.0 && quai2.ID != this.Myself.ID && !flag9 && this.CanAttack(quai2) && (frmLogin.GAuto.Settings.cboxNoKS && quai2.KSMode != byte.MaxValue || !frmLogin.GAuto.Settings.cboxNoKS))
                {
                  double distance1 = GA.CalculateDistance((double) quai2.PosX, (double) quai2.PosY, (double) this.Myself.PosX, (double) this.Myself.PosY);
                  double num6 = AutoAccount.CheckQuaiPos0(quai2, distance1);
                  bool flag10 = false;
                  if (this.Myself.TempFightMode == AllEnums.FightingModes.DANHTUNGCON && num6 < num3)
                    flag10 = true;
                  if (this.Myself.TempFightMode == AllEnums.FightingModes.DANHGOMQUAI && (double) quai2.HPPercent >= 100.0 && num6 > num3)
                  {
                    double num7 = this.Settings.Diameter4;
                    if (this.MyFlag.VuotQuaPhamViCount >= 3)
                      num7 = 11.0;
                    if (num6 <= num7)
                      flag10 = true;
                  }
                  if (flag10 || quai1 == null)
                  {
                    double distance2 = GA.CalculateDistance((double) quai2.PosX, (double) quai2.PosY, this.Settings.CenterX, this.Settings.CenterY);
                    double num8 = AutoAccount.CheckQuaiPos0(quai2, distance2);
                    bool flag11 = false;
                    if (this.Settings.cboxDanhHoTro && !this.Settings.cboxDanhTheoKey && this.MyParty.PartyNumbers > 0 && !this.IsPartyKey())
                      flag11 = true;
                    if (!flag11 && !this.IsPartyKey() && this.MyParty.PartyNumbers > 0 && this.Settings.cboxTheoSau)
                      flag11 = true;
                    if (flag11)
                    {
                      PartyMember allMember = this.MyParty.AllMembers[0];
                      if (allMember.MapID == this.Myself.MapID)
                        num8 = GA.CalculateDistance((double) quai2.PosX, (double) quai2.PosY, (double) allMember.PosX, (double) allMember.PosY);
                    }
                    if (this.Settings.AIMode != AllEnums.AIModes.DANHQUANHDIEM || num8 <= this.Settings.Diameter4 || GA.IsInPhuBan(this.Myself.MapID, this))
                    {
                      if (this.Myself.TempFightMode == AllEnums.FightingModes.DANHTUNGCON || !flag3 || flag3 && this.Myself.TempFightMode == AllEnums.FightingModes.DANHGOMQUAI && (quai2.JustHit == (byte) 0 && this.Settings.cboxGomQuaiKS || !quai2.IsHitByMe && !this.Settings.cboxGomQuaiKS) || quai1 == null)
                      {
                        quai1 = quai2;
                        num3 = num6;
                      }
                      else
                        quaiIndividual = quai2;
                      if ((double) quai2.HPPercent > (double) frmLogin.GAuto.Settings.releaseHPPercent && this.Myself.TempFightMode == AllEnums.FightingModes.DANHTUNGCON)
                      {
                        quai1 = quai2;
                        num3 = num6;
                      }
                      else
                        quaiIndividual = quai2;
                    }
                  }
                }
              }
            }
            catch (Exception ex)
            {
              GA.WriteUserLog(frmMain.langAttackQuaiError, this);
            }
          }
        }
        if (quai1 == null && quaiIndividual != null)
          quai1 = quaiIndividual;
        if (quai1 != null)
        {
          if (quai1.ID >= 0)
          {
            this.CallSelectTarget(quai1.ID);
            if ((double) quai1.HPPercent > 0.0)
              this.Myself.LastNullTargetStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
            if (this.Myself.HorseType != -1)
              this.CallMounting();
            if (flag3)
            {
              if (this.Settings.cboxOnlyPet && this.HasActivePet())
              {
                this.CallAttackTargetPacket(this.Myself.ID, -1, quai1.ID, 0, 0);
              }
                
              else if (num3 <= 10.0 && this.Myself.CharType == AllEnums.CharTypes.NUKER)
              {
                this.CallAttackTargetPacket(this.Myself.ID, this.MySkills.AllSkills[0].ID, quai1.ID, 0, 0);
              }
              else
              {
                this.CallAttackTarget(quai1.ID, this.MySkills.AllSkills[0].ID, 0, 0);
              }
                
              if (this.MyQuai.AllQuai.Count > 1)
              {
                if ((double) quai1.HPPercent == 100.0)
                {
                  try
                  {
                    quai1.JustHit = (byte) 1;
                    quai1.LastHitStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                  }
                  catch (Exception ex)
                  {
                  }
                }
              }
            }
            else if (this.Myself.LastTargetID != this.MyQuai.TargetID || this.Myself.AttackStatus == (byte) 0)
            {
              if (this.Settings.cboxOnlyPet && this.HasActivePet())
              {
                this.CallAttackTargetPacket(this.Myself.ID, -1, quai1.ID, 0, 0);
              }
              else
              {
                this.CallAttackTarget(quai1.ID, this.MySkills.AllSkills[0].ID, 0, 0);
              }
              this.Myself.LastTargetID = quai1.ID;
            }
            this.Myself.CurrentTarget = this.TimQuaiTheoID(quai1.ID);
            this.Myself.CurrentTargetID = quai1.ID;
            quai1 = (QuaiIndividual) null;
          }
        }
        else if (quai1 == null && this.Myself.TempFightMode == AllEnums.FightingModes.DANHGOMQUAI)
          this.Myself.TempFightMode = AllEnums.FightingModes.DANHTUNGCON;
        if ((quai1 == null || this.MyQuai.TargetID == -1) && this.ScriptEngine.CurrentCommand != null)
        {
          string lower = this.ScriptEngine.CurrentCommand.Command.ToLower();
          if (lower == "moveattack" || lower == "attack")
          {
            if (this.Myself.LastNullTargetStamp != 0L)
            {
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LastNullTargetStamp >= (long) nullDelay)
              {
                this.ScriptEngine.CurrentCommand.Status = AllEnums.ScriptStatuses.FINISHED;
                this.Myself.LastNullTargetStamp = 0L;
              }
            }
            else
              this.Myself.LastNullTargetStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
          }
        }
      }
      if (this.MyQuai.TargetID != -1 && (double) this.MyQuai.TargetHPPercent > 0.0)
        this.Myself.LastNullTargetStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
      if ((this.Settings.FightMode == AllEnums.FightingModes.DANHGOMQUAI && this.Settings.cboxGomXongVeTam && !flag3 || this.Settings.cboxTheoSau && this.Myself.CurrentTarget == null && !this.IsPartyKey()) && this.Myself.Status != AllEnums.CharStatuses.NHATBOC && !this.IsNhatBoc() && this.Settings.cboxBanKinh && this.Settings.AIMode != AllEnums.AIModes.NHIEMVU && !GA.IsInPhuBan(this.Myself.MapID, this))
      {
        double num9 = 1.0;
        int num10 = -1;
        int num11 = -1;
        int num12 = -1;
        if (this.Settings.cboxTheoSau)
        {
          PartyMember partyMember = this.TheoSauAiDo(false);
          if (partyMember != null && partyMember.MapID == this.Myself.MapID)
          {
            num9 = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) partyMember.PosX, (double) partyMember.PosY);
            num10 = (int) partyMember.PosX;
            num11 = (int) partyMember.PosY;
            num12 = partyMember.MapID;
          }
        }
        if (this.Settings.AIMode == AllEnums.AIModes.DANHQUANHDIEM && !GA.IsInPhuBan(this.Myself.MapID, this))
        {
          num9 = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, this.Settings.CenterX, this.Settings.CenterY);
          num10 = (int) this.Settings.CenterX;
          num11 = (int) this.Settings.CenterY;
          num12 = this.Myself.MapID;
        }
        if (num9 >= (double) this.Settings.numTheoSau)
        {
          this.Myself.TargetX = (float) num10;
          this.Myself.TargetY = (float) num11;
          this.Myself.TargetMapID = num12;
          this.Myself.MoveAcrossMap = false;
          this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
          this.CallMoveTo((int) this.Myself.TargetX, (int) this.Myself.TargetY);
        }
      }
      if ((double) this.MyQuai.TargetHPPercent <= 0.0 || this.Myself.CurrentTarget == null)
        return;
      if (this.MyQuai.TargetID != -1)
      {
        bool flag12 = false;
        try
        {
          for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
          {
            QuaiIndividual quai3 = this.MyQuai.AllQuai[index];
            if (quai3.ID == this.MyQuai.TargetID && (double) quai3.HPPercent > 0.0)
            {
              this.Myself.CurrentTarget = quai3;
              flag12 = true;
              double distance = GA.CalculateDistance((double) quai3.PosX, (double) quai3.PosY, (double) this.Myself.PosX, (double) this.Myself.PosY);
              if (AutoAccount.CheckQuaiPos0(quai3, distance) > this.Settings.Diameter4 || !this.CanAttack(quai3) || frmLogin.GAuto.Settings.cboxNoKS && quai3.KSMode == byte.MaxValue)
                this.Myself.CurrentTargetID = -1;
              if (this.Myself.IsKyCuoc && (quai3.IsBossValue == 31770 || quai3.IsBossValue == 31780 || quai3.Name == "Cờ Trắng" || quai3.Name == "Cờ Đen" || quai3.Name == "White Stone" || quai3.Name == "Black Stone"))
                this.MyFlag.cotrangdenStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
              if (this.Settings.AIMode == AllEnums.AIModes.NHIEMVU && this.Myself.IsXayDung)
              {
                if ((quai3.IsBossValue < 500 || quai3.IsBossValue > 548) && (quai3.IsBossValue < 704 || quai3.IsBossValue > 890))
                {
                  if (quai3.IsBossValue >= 9100)
                  {
                    if (quai3.IsBossValue > 9139)
                      break;
                  }
                  else
                    break;
                }
                flag12 = false;
                break;
              }
            }
          }
        }
        catch (Exception ex)
        {
        }
        if (!flag12)
          this.Myself.CurrentTargetID = -1;
      }
      if (!this.CanAttack() || (!frmLogin.GAuto.Settings.cboxNoKS || this.Myself.CurrentTarget.KSMode == byte.MaxValue) && frmLogin.GAuto.Settings.cboxNoKS)
        return;
      double num13 = AutoAccount.CheckQuaiPos0(this.Myself.CurrentTarget, GA.CalculateDistance(this.Settings.CenterX, this.Settings.CenterY, (double) this.Myself.CurrentTarget.PosX, (double) this.Myself.CurrentTarget.PosY));
      double num14 = AutoAccount.CheckQuaiPos0(this.Myself.CurrentTarget, GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) this.Myself.CurrentTarget.PosX, (double) this.Myself.CurrentTarget.PosY));
      bool flag13 = false;
      if (num14 <= 10.0)
      {
        if (this.Myself.CharType == AllEnums.CharTypes.NUKER)
          flag13 = true;
        if (this.Myself.CharType == AllEnums.CharTypes.TANKER && num14 <= 1.5)
          flag13 = true;
      }
      double num15 = 35.0;
      bool flag14 = true;
      bool flag15 = true;
      if (this.Settings.AIMode == AllEnums.AIModes.DANHQUANHDIEM && num13 > this.Settings.Diameter4)
        flag15 = false;
      if (num14 > num15)
        flag14 = false;
      if (flag14 && (flag15 || GA.IsInPhuBan(this.Myself.MapID, this)) && (double) this.MyQuai.TargetHPPercent > (double) frmLogin.GAuto.Settings.releaseHPPercent && (double) this.MyQuai.TargetHPPercent > 0.0 && this.CanAttack())
      {
        if (this.Myself.HorseType != -1 && !this.Myself.IsTKC)
          this.CallXuongNgua();
        this.PlayPetAOE((int) this.Myself.CurrentTarget.PosX, (int) this.Myself.CurrentTarget.PosY);
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LastActionTimeStamp >= (long) frmLogin.GAuto.Settings.ActionDelay)
        {
          if (this.MyQuai.AllQuai.Count > 1 && !this.IsPlayer(this.Myself.CurrentTarget) && (this.Settings.FightMode == AllEnums.FightingModes.DANHGOMQUAI || frmLogin.GAuto.Settings.optChangeTargetFast))
          {
            int num16 = 25;
            if (this.Settings.numGomMode == 2)
              num16 = 100;
            if ((double) this.Myself.CurrentTarget.HPPercent <= (double) num16)
            {
              bool flag16 = false;
              if (!this.Settings.cboxDanhTheoKey && !this.Settings.cboxDanhTheoAi)
                flag16 = true;
              if (this.IsPartyKeyInt() == 2 || this.MyParty.PartyNumbers <= 1)
                flag16 = true;
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.nodelayAction <= 15000L)
                flag16 = false;
              if (flag16)
                this.Myself.CurrentTarget.noAttackStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
            }
          }
          if ((double) this.Myself.TargetLastHPPercent != (double) this.MyQuai.TargetHPPercent)
          {
            this.Myself.TargetLastHPPercent = this.MyQuai.TargetHPPercent;
            this.Myself.TargetTimestamp.Reset();
          }
          if (this.MyQuai.TargetID >= 0)
          {
            if (!this.Settings.cboxOnlyPet)
            {
              this.CallAttackTarget(this.MyQuai.TargetID, this.MySkills.AllSkills[0].ID, 0, 0, isPlaySkill: true);
              if (this.MyQuai.TargetID != -1 && (this.Myself.LastTargetID != this.MyQuai.TargetID || this.Myself.ActionStatus == (byte) 0))
              {
                if (!flag13)
                {
                  this.CallAttackTarget(this.MyQuai.TargetID, this.MySkills.AllSkills[0].ID, 0, 0);
                }
                  
                else
                {
                  this.CallAttackTargetPacket(this.Myself.ID, this.MySkills.AllSkills[0].ID, this.MyQuai.TargetID, 0, 0);
                }
                this.Myself.LastTargetID = this.MyQuai.TargetID;
                this.Myself.CurrentTarget = this.TimQuaiTheoID(this.MyQuai.TargetID);
                if (this.Myself.TempFightMode == AllEnums.FightingModes.DANHGOMQUAI && this.Myself.CurrentTarget != null && this.Myself.CurrentTarget.JustHit == (byte) 1)
                  this.CallSelectTarget(-1);
              }
            }
            else if (this.HasActivePet())
            {
              try
              {
                this.CallAttackTargetPacket(this.Myself.ID, -1, this.MyQuai.TargetID, 0, 0);
              }
              catch (Exception ex)
              {
                GA.WriteUserLog(frmMain.langPetAttackOnlyError + ex.Message, this);
              }
            }
          }
        }
      }
      else if ((double) this.MyQuai.TargetHPPercent <= (double) frmLogin.GAuto.Settings.releaseHPPercent)
        this.Myself.CurrentTargetID = -1;
      if (this.Myself.TargetTimestamp.ElapsedMilliseconds < 3000L || this.Myself.CurrentTarget == null || (double)this.MyQuai.TargetHPPercent < (double)this.Myself.TargetLastHPPercent)
        return;
      this.Myself.CurrentTargetID = -1;
      this.Myself.TargetTimestamp.Reset();
      this.Myself.TargetTimestamp.Start();
    }
  }

  private static double CheckQuaiPos0(QuaiIndividual quai, double myDistance)
  {
    if ((double) quai.PosX == 0.0 && (double) quai.PosY == 0.0 && frmLogin.GlobalTimer.ElapsedMilliseconds - quai.LastTimeSeen <= 3000L && quai.LastTimeSeen != 0L)
      myDistance = 16.0;
    return myDistance;
  }

  private void AutoIsLongMove()
  {
    if (this.Myself.LongMoveX == 0 || this.Myself.LongMoveY == 0 || this.Myself.LongMoveMapID == -1 || !this.NotTransitioning() || this.Myself.ActionStatus == (byte) 5 || this.Myself.IsPK || this.Myself.ID <= 0)
      return;
    this.CallLenNgua();
    List<AdvancedPath> bestPath = this.CalculateBestPath(this.Myself.MapID, this.Myself.LongMoveMapID);
    if (bestPath != null)
    {
      this.Myself.IsTrader = true;
      this.Myself.PossiblePaths = bestPath;
      this.Myself.PossiblePaths[this.Myself.PossiblePaths.Count - 1].TempToX = this.Myself.LongMoveX;
      this.Myself.PossiblePaths[this.Myself.PossiblePaths.Count - 1].TempToY = this.Myself.LongMoveY;
      bool flag1 = false;
      if (this.Myself.MoveLongStamp.ElapsedMilliseconds >= 1000L)
      {
        this.Myself.MoveLongStamp.Reset();
        this.Myself.MoveLongStamp.Start();
        flag1 = true;
      }
      if (!flag1)
        flag1 = true;
      if (!flag1 || this.Myself.PossiblePaths.Count <= 0)
        return;
      bool flag2 = false;
      AdvancedPath advancedPath1 = (AdvancedPath) null;
      AdvancedPath advancedPath2 = (AdvancedPath) null;
      bool flag3 = false;
      for (int index = 0; index < this.Myself.PossiblePaths.Count; ++index)
      {
        AdvancedPath possiblePath = this.Myself.PossiblePaths[index];
        if (this.Myself.MapID == possiblePath.MapID)
        {
          flag2 = true;
          advancedPath1 = possiblePath;
          if (advancedPath1.MapID == this.Myself.PossiblePaths[this.Myself.PossiblePaths.Count - 1].MapID)
          {
            flag3 = true;
            break;
          }
          advancedPath2 = this.Myself.PossiblePaths[index + 1];
          break;
        }
      }
      if (!flag2)
      {
        this.Myself.PossiblePaths = this.CalculateBestPath(this.Myself.MapID, this.Myself.LongMoveMapID);
      }
      else
      {
        if (advancedPath1 == null)
          return;
        if (!flag3)
        {
          if (advancedPath2 != null && advancedPath2.MapID != this.Myself.MapID && this.NotTransitioning())
          {
            if (advancedPath2 == this.Myself.PossiblePaths[this.Myself.PossiblePaths.Count - 1])
            {
              this.Myself.TargetX = (float) advancedPath2.TempToX;
              this.Myself.TargetY = (float) advancedPath2.TempToY;
              this.Myself.TargetMapID = advancedPath2.MapID;
            }
            else
            {
              this.Myself.TargetX = (float) advancedPath2.GatePosX;
              this.Myself.TargetY = (float) advancedPath2.GatePosY;
              this.Myself.TargetMapID = advancedPath2.MapID;
            }
            this.Myself.MoveAcrossMap = true;
          }
          if (advancedPath2 != null)
          {
            if (advancedPath1.GatePosX != 0 && advancedPath1.GatePosY != 0 && this.NotTransitioning())
            {
              this.auto_paths_fix(ref advancedPath1.GatePosX, ref advancedPath1.GatePosY, ref advancedPath1.MapID, ref advancedPath1.NPC_ID);
              double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) advancedPath1.GatePosX, (double) advancedPath1.GatePosY);
              if (advancedPath1.GateType == AllEnums.GateTypes.Portal || advancedPath1.GateType == AllEnums.GateTypes.NPC && distance > 2.0)
              {
                this.Myself.TargetX = (float) advancedPath1.GatePosX;
                this.Myself.TargetY = (float) advancedPath1.GatePosY;
                this.Myself.TargetMapID = advancedPath2.MapID;
                this.Myself.MoveAcrossMap = false;
                this.Myself.UseAutoMove = false;
                this.Myself.MoveFlashPos = false;
                if (this.Myself.ActionStatus == (byte) 0)
                  this.CallMoveTo(advancedPath1.GatePosX, advancedPath1.GatePosY);
              }
              else if (advancedPath1.GateType == AllEnums.GateTypes.NPC && distance <= 3.0 && advancedPath1.NPC_ID >= 0)
              {
                if (this.Target.VersionNum == 3 && this.Target.SubVersion == 4 && GA.isInCity(this.Myself.MapID))
                  this.ResetPacketMsg();
                this.CallTalkNPC(0, 0, advancedPath1.NPC_ID, true);
                Thread.Sleep(700);
                int menuIndex1 = advancedPath1.NPCMenuIndex_1;
                int menuIndex2 = advancedPath1.NPCMenuIndex_2;
                int npcMenuIndex3 = advancedPath1.NPCMenuIndex_3;
                int menuTypeID1 = advancedPath1.NPCMenuTypeID_1;
                int menuTypeID2 = advancedPath1.NPCMenuTypeID_2;
                int menuTypeID3 = advancedPath1.NPCMenuTypeID_3;
                if (this.Target.VersionNum == 3 && (this.Target.SubVersion == 4 || this.Target.SubVersion == 12 || this.Target.SubVersion == 30))
                {
                  bool flag4 = true;
                  if (this.Target.SubVersion == 4)
                  {
                    Thread.Sleep(300);
                    if (this.Myself.PacketMsg == "MNKC")
                    {
                      flag4 = false;
                      this.ResetPacketMsg();
                    }
                  }
                  else if (this.Target.SubVersion != 12 && this.Target.SubVersion != 30)
                    flag4 = false;
                  if (flag4)
                  {
                    int num = menuTypeID1;
                    int targetMapId = this.Myself.TargetMapID;
                    if (num == 82 || num == 1081 || num == 2026 || num == 1100 || num == 12009 || num == 10050 || num == 9036 || num == 16006 || num == 14007 || num == 9009 || num == 17005 || num == 13005 || num == 15010 || num == 12009 || num == 11003 || num == 10008)
                    {
                      menuTypeID1 = 12009;
                      if (menuTypeID2 > -1)
                        menuTypeID2 = 12009;
                      if (menuTypeID3 > -1)
                        menuTypeID3 = 12009;
                      switch (targetMapId)
                      {
                        case 0:
                          menuIndex1 = 1;
                          break;
                        case 1:
                          menuIndex1 = 3;
                          break;
                        case 2:
                          menuIndex1 = 5;
                          break;
                        case 186:
                          menuIndex1 = 6;
                          break;
                        case 420:
                          menuIndex1 = 7;
                          break;
                      }
                      if (menuIndex1 == 1012)
                      {
                        menuIndex1 = 8;
                        switch (targetMapId)
                        {
                          case 9:
                            menuIndex2 = 10;
                            break;
                          case 10:
                            menuIndex2 = 12;
                            break;
                          case 11:
                            menuIndex2 = 11;
                            break;
                          case 12:
                            menuIndex2 = 13;
                            break;
                          case 13:
                            menuIndex2 = 16 /*0x10*/;
                            break;
                          case 14:
                            menuIndex2 = 18;
                            break;
                          case 15:
                            menuIndex2 = 14;
                            break;
                          case 16 /*0x10*/:
                            menuIndex2 = 15;
                            break;
                          case 17:
                            menuIndex2 = 17;
                            break;
                          case 195:
                            menuIndex2 = 19;
                            break;
                          case 435:
                            menuIndex2 = 19;
                            break;
                        }
                      }
                    }
                  }
                }
                if (GA.CheckGameVersion(this.Target.VersionNum) == 356 && this.Myself.MapID == 420 && menuTypeID1 == 12009)
                {
                  menuTypeID1 = 1171;
                  switch (menuIndex1)
                  {
                    case 0:
                      menuIndex1 = 1001;
                      break;
                    case 1:
                      menuIndex1 = 1002;
                      break;
                    case 2:
                      menuIndex1 = 1003;
                      break;
                    case 5:
                      menuIndex1 = 1008;
                      break;
                  }
                }
                this.CallTalkNPC(menuTypeID1, menuIndex1, advancedPath1.NPC_ID, true);
                if (menuTypeID2 >= 0 || menuTypeID3 >= 0)
                  Thread.Sleep(1000);
                else
                  Thread.Sleep(2000);
                if (menuTypeID2 >= 0 && menuIndex2 >= 0)
                {
                  int menuIndex3 = -1;
                  if (this.Target.VersionNum == 4 && this.Myself.MapID <= 2)
                    menuIndex3 = menuIndex2 + 1;
                  if (menuIndex3 == -1)
                    this.CallTalkNPC(menuTypeID2, menuIndex2, advancedPath1.NPC_ID);
                  else
                    this.CallTalkNPC(menuTypeID2, menuIndex3, advancedPath1.NPC_ID);
                  Thread.Sleep(1500);
                }
                if (menuTypeID3 >= 0 && npcMenuIndex3 >= 0)
                {
                  int menuIndex4 = -1;
                  if (this.Target.VersionNum == 4 && this.Myself.MapID <= 2 && npcMenuIndex3 == 1)
                    menuIndex4 = 0;
                  if (menuIndex4 == -1)
                    this.CallTalkNPC(menuTypeID3, npcMenuIndex3, advancedPath1.NPC_ID);
                  else
                    this.CallTalkNPC(menuTypeID3, menuIndex4, advancedPath1.NPC_ID);
                  Thread.Sleep(1500);
                }
                this.Myself.LastPostStamp.Reset();
                this.Myself.LastPostStamp.Start();
              }
            }
          }
          else
            this.Myself.Status = AllEnums.CharStatuses.IDLE;
          this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
          if (this.Myself.SavedStatus == AllEnums.CharStatuses.VETHANH)
            return;
          this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
        }
        else if (GA.CalculateDistance((double) this.Myself.LongMoveX, (double) this.Myself.LongMoveY, (double) this.Myself.PosX, (double) this.Myself.PosY) <= 2.0 || this.Myself.LongMoveX <= 0 || this.Myself.LongMoveY <= 0)
        {
          this.Myself.MinorStatus = AllEnums.CharStatuses.IDLE;
          this.Myself.Status = AllEnums.CharStatuses.IDLE;
          this.Myself.MoveLongTrigger = false;
          this.Myself.MoveFlashPos = false;
          this.Myself.IsLongMove = false;
        }
        else if (this.Myself.MapID != this.Myself.LongMoveMapID)
        {
          this.Myself.TargetX = (float) this.Myself.LongMoveX;
          this.Myself.TargetY = (float) this.Myself.LongMoveY;
          this.Myself.TargetMapID = this.Myself.LongMoveMapID;
          this.Myself.UseAutoMove = false;
          this.Myself.MoveAcrossMap = false;
          this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
          if (this.Myself.SavedStatus != AllEnums.CharStatuses.VETHANH)
            this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
          this.Myself.MoveFlashPos = true;
        }
        else
        {
          if (this.Myself.MapID != this.Myself.LongMoveMapID)
            return;
          this.Myself.TargetX = (float) this.Myself.LongMoveX;
          this.Myself.TargetY = (float) this.Myself.LongMoveY;
          this.Myself.TargetMapID = this.Myself.LongMoveMapID;
          this.Myself.UseAutoMove = false;
          this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
          if (this.Myself.SavedStatus != AllEnums.CharStatuses.VETHANH)
            this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
          this.Myself.MoveFlashPos = false;
          this.Myself.MoveAcrossMap = false;
        }
      }
    }
    else
    {
      if (bestPath != null)
        return;
      if (this.Myself.LongMoveMapID == 5001)
      {
        if (GA.IsBangMapID(this.Myself.MapID))
          this.CallResetAutoMove();
        else
          this.GoToMyBang();
      }
      else
      {
        if (!GA.IsInPhuBan(this.Myself.LongMoveMapID) && this.Myself.MapID == 0 && this.Myself.MapID == 1 && this.Myself.MapID == 2 && this.Myself.MapID == 186 && this.Myself.MapID == 480 && this.Myself.MapID == 181)
          GA.WriteUserLog(frmMain.langMapNotSupport, this);
        this.Myself.IsLongMove = false;
        this.Myself.LongMoveX = 0;
        this.Myself.LongMoveY = 0;
        this.Myself.LongMoveMapID = -1;
      }
    }
  }

  private bool PlayMySkill(SkillPlayItem skill, int myTargetID, bool isBuff = false)
  {
    if (skill.IsEnabled && this.Myself.IsPartyFollowed == (byte) 0)
    {
      if (this.Myself.HorseType == -1)
      {
        try
        {
          if (skill != null)
          {
            if (skill.SkillItem != null)
            {
              if (skill.SkillItem.DelayIndex == -1)
              {
                for (int index = 0; index < this.MySkills.SkillDelays.Count; ++index)
                {
                  if (this.MySkills.SkillDelays[index].SkillID == skill.SkillItem.ID)
                  {
                    skill.SkillItem.DelayIndex = index;
                    break;
                  }
                }
              }
              bool flag1 = true;
              if (this.Myself.MPPercent <= 2.0)
                flag1 = false;
              bool flag2 = false;
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - skill.LastPlayTimeStamp >= (long) (skill.SkillDelayInSecond * 1000))
                flag2 = true;
              if (skill.SkillItem.DelayIndex != -1)
              {
                skill.SkillItem.SkillDelay = this.MySkills.SkillDelays[skill.SkillItem.DelayIndex].SkillDelay;
                skill.SkillItem.RageRequired = this.MySkills.SkillDelays[skill.SkillItem.DelayIndex].RageRequired;
                if (skill.SkillItem.SkillDelay > 0 && skill.LastPlayTimeStamp == 0L)
                  skill.LastPlayTimeStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
              }
              else if (!flag2)
                return false;
              bool flag3 = true;
              if (this.Myself.Rage < skill.SkillItem.RageRequired && skill.SkillItem.RageRequired > 0)
                flag3 = false;
              if (flag3 && skill.SkillItem.RageRequired > 0)
                flag1 = true;
              if (skill.SkillItem.SkillDelay <= 50 && flag3 && flag1 && flag2 || skill.SkillItem.DelayIndex == -1 && flag2 && this.Myself.MPPercent >= 2.0)
              {
                bool flag4 = false;
                if (skill.SkillItem.ID == 402 || skill.SkillItem.ID == 395 || skill.SkillItem.ID == 374 || skill.SkillItem.ID == 426 && this.Target.VersionNum == 3 || skill.SkillItem.ID >= 840 && skill.SkillItem.ID <= 849)
                {
                  flag4 = true;
                  if (this.Myself.CurrentTarget != null)
                  {
                    this.AdjustShootList(skill.SkillItem.ID, myTargetID, (int) this.Myself.CurrentTarget.PosX, (int) this.Myself.CurrentTarget.PosY);
                    skill.LastPlayTimeStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                  }
                }
                else if (skill.SkillItem.Special == 1)
                {
                  bool flag5 = false;
                  if (skill.SkillItem.ID == 312 || skill.SkillItem.ID == 492 || skill.SkillItem.ID == 282)
                    flag5 = true;
                  bool flag6 = false;
                  if (skill.SkillItem.ID == 462 || skill.SkillItem.ID == 432)
                    flag6 = true;
                  if (flag5 || flag6)
                  {
                    int num = 0;
                    if (this.MyQuai.AllQuai.Count > 0)
                    {
                      try
                      {
                        for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
                        {
                          if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) this.MyQuai.AllQuai[index].PosX, (double) this.MyQuai.AllQuai[index].PosY) <= 4.0 && this.CanAttack(this.MyQuai.AllQuai[index]))
                            ++num;
                        }
                      }
                      catch (Exception ex)
                      {
                      }
                    }
                    bool flag7 = false;
                    if (num > 0 && flag5)
                      flag7 = true;
                    if (num >= 3 && flag6)
                      flag7 = true;
                    if (flag7)
                    {
                      flag4 = true;
                      this.AdjustShootList(skill.SkillItem.ID, -1);
                      skill.LastPlayTimeStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                    }
                  }
                  else
                  {
                    if (this.Myself.CharType == AllEnums.CharTypes.NUKER || isBuff)
                      this.AdjustShootList(skill.SkillItem.ID, myTargetID, isBuff: isBuff);
                    else
                      this.AdjustShootList(skill.SkillItem.ID, myTargetID, packet: false, isBuff: isBuff);
                    flag4 = true;
                    skill.LastPlayTimeStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                  }
                }
                else
                {
                  if (this.Myself.CharType == AllEnums.CharTypes.NUKER || isBuff)
                    this.AdjustShootList(skill.SkillItem.ID, myTargetID, isBuff: isBuff);
                  else
                    this.AdjustShootList(skill.SkillItem.ID, myTargetID, packet: false, isBuff: isBuff);
                  flag4 = true;
                  skill.LastPlayTimeStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                }
                if (flag4)
                  return true;
              }
              else
              {
                long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
                long lastPlayTimeStamp = skill.LastPlayTimeStamp;
              }
            }
          }
        }
        catch (Exception ex)
        {
          if (skill != null)
          {
            if (skill.SkillItem != null)
              GA.WriteUserLog($"{frmMain.langCannotSkill1}{skill.SkillItem.ID.ToString()} message: {ex.Message}", this);
            else
              GA.WriteUserLog($"{frmMain.langCannotSkill2} message: {ex.Message}", this);
          }
          else
            GA.WriteUserLog($"{frmMain.langCannotSkill3} Message: {ex.Message}", this);
        }
        return false;
      }
    }
    return false;
  }

  private bool AdjustShootList(
    int skillID,
    int myTargetID,
    int X = 0,
    int Y = 0,
    bool packet = true,
    bool isBuff = false)
  {
    bool flag1 = false;
    bool flag2 = false;
    if (this.MySkills.SkillBuffer.Count > 0)
    {
      foreach (SkillBufferItem skillBufferItem in this.MySkills.SkillBuffer)
      {
        if (skillBufferItem.SkillID == skillID && skillID > 0)
        {
          flag2 = true;
          break;
        }
      }
    }
    if (!flag2)
    {
      this.MySkills.SkillBuffer.Add(new SkillBufferItem()
      {
        SkillID = skillID,
        TargetID = myTargetID,
        PosX = X,
        PosY = Y,
        Packet = packet,
        isBuff = isBuff
      });
      flag1 = true;
    }
    return flag1;
  }

  public void NhiemVuTrungAc()
  {
    bool flag1 = false;
    bool flag2 = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    int itemIndex1 = 60;
    if (!flag1)
      return;
    if (this.isInDiaPhu())
    {
      this.CallMoveTo(12, 24);
    }
    else
    {
      bool flag3 = false;
      for (int index = 60; index < 90; ++index)
      {
        if (this.MyInventory.AllItems[index].ItemID == frmLogin.GAuto.Settings.TrungAcItemID)
        {
          flag3 = true;
          itemIndex1 = index;
          break;
        }
      }
      if (!this.Myself.TrungAcCheckMap && flag3)
      {
        this.CallUseItem(itemIndex1, this.Myself.ID);
        this.Myself.TrungAcItemUsed = false;
        this.Myself.TrungAcCheckMap = true;
        Thread.Sleep(2000);
      }
      int num1 = 224 /*0xE0*/;
      int num2 = 226;
      if (this.Target.VersionNum == 4)
      {
        num1 = (int) sbyte.MaxValue;
        num2 = 133;
      }
      if (!flag3 && !this.Myself.TrungAcItemUsed && this.Settings.cboxTANhanNV && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.CheckLenhBaiTAStamp >= frmLogin.GAuto.Settings.NVActionDelay)
      {
        this.Myself.CheckLenhBaiTAStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
        if (this.Myself.HorseType == -1)
          this.CallMounting();
        if (this.Myself.MapID == 1 && !this.Myself.JustWarped)
        {
          if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num1, (double) num2) > 2.5)
          {
            if (this.Myself.ActionStatus != (byte) 2)
            {
              this.Myself.TargetX = (float) num1;
              this.Myself.TargetY = (float) num2;
              this.Myself.MoveAcrossMap = false;
              this.Myself.UseAutoMove = false;
              this.CallMoveFlashPos((int) this.Myself.TargetX, (int) this.Myself.TargetY);
            }
          }
          else
          {
            this.CallClearNhiemVuData();
            this.Myself.actionFlag = 0;
            bool flag4 = false;
            bool flag5 = false;
            long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
            long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
            while (!flag4 && !flag5 && this.Myself.IsTrungAc)
            {
              if (this.Myself.isQuestFrameShow == 0 && this.Myself.actionFlag == 0)
              {
                this.CallTalkNPC(0, 0, 115);
                long elapsedMilliseconds3 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                while (this.Myself.isQuestFrameShow == 0)
                {
                  Thread.Sleep(200);
                  if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds3 > 2000L)
                    break;
                }
                this.CallTalkNPC(229020, -1, 115);
              }
              Thread.Sleep(700);
              if (this.Myself.isQuestFrameShow == 1)
              {
                this.CallNhanNhiemVu();
                this.Myself.actionFlag = 1;
              }
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 >= 3000L)
              {
                this.CallTalkNPC(0, 0, 115);
                Thread.Sleep(500);
                this.CallTalkNPC(229020, -1, 115);
                elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
              }
              for (int index = 60; index < 90; ++index)
              {
                if (this.MyInventory.AllItems[index].ItemID == frmLogin.GAuto.Settings.TrungAcItemID)
                  flag5 = true;
              }
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 >= 10000L)
                flag4 = true;
            }
            if (flag4 && !flag5)
            {
              this.Myself.TrungAcFinished = true;
              this.Myself.TrungAcFoundQuai = true;
              this.Myself.TrungAcItemUsed = true;
              this.Myself.TrungAcQuaiDied = true;
              this.Myself.TrungAcCheckMap = true;
              this.Myself.TrungAcFoundBoc = true;
            }
          }
        }
        else if (this.Myself.MapID != 1 && !this.Myself.JustWarped)
        {
          this.CallLenNgua();
          if (GA.IsBangMapID(this.Myself.MapID))
          {
            int num3 = 99;
            int num4 = 54;
            if (GA.CalculateDistance((double) num3, (double) num4, (double) this.Myself.PosX, (double) this.Myself.PosY) > 2.5)
            {
              this.CallInMapMove(num3, num4);
            }
            else
            {
              int mapId = this.Myself.MapID;
              long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
              while (this.IsAIEnabled)
              {
                Thread.Sleep(500);
                if (this.Myself.MapID == mapId)
                {
                  this.CallTalkNPCByPos(805009, 29, num3, num4);
                  this.CallTalkNPCByPos(805009, 28, num3, num4, false);
                  if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds >= 5000L)
                    break;
                }
                else
                  break;
              }
            }
          }
          else
            this.CallOutMapMove(num1, num2, 1);
        }
      }
      if (flag3 && !this.Myself.TrungAcItemUsed)
      {
        if (this.Myself.NhiemVuPosX != 0 && this.Myself.NhiemVuPosY != 0 && this.Myself.PacketMsg != "" && this.Myself.NhiemVuMapID != -1)
        {
          int nhiemVuPosX = this.Myself.NhiemVuPosX;
          int nhiemVuPosY = this.Myself.NhiemVuPosY;
          if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.CheckLenhBaiTAStamp >= frmLogin.GAuto.Settings.NVActionDelay)
          {
            this.Myself.CheckLenhBaiTAStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
            if (this.Myself.MapID == this.Myself.NhiemVuMapID && !this.Myself.JustWarped)
            {
              if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) nhiemVuPosX, (double) nhiemVuPosY) > 5.0)
              {
                if (this.Myself.ActionStatus != (byte) 2 && this.Myself.ActionStatus != (byte) 5 && !this.Myself.JustWarped)
                {
                  this.CallLenNgua();
                  this.Myself.TargetX = (float) nhiemVuPosX;
                  this.Myself.TargetY = (float) nhiemVuPosY;
                  this.Myself.MoveAcrossMap = false;
                  this.Myself.UseAutoMove = false;
                  this.CallMoveFlashPos((int) this.Myself.TargetX, (int) this.Myself.TargetY);
                }
              }
              else
              {
                this.CallXuongNgua();
                if (!this.Myself.TrungAcItemUsed)
                {
                  if (this.Myself.TrungAcQuaiList.Count == 0)
                  {
                    double num5 = 999.0;
                    if (this.MyQuai.AllQuai.Count > 0)
                    {
                      try
                      {
                        for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
                        {
                          QuaiIndividual quai = this.MyQuai.AllQuai[index];
                          if (!string.IsNullOrEmpty(quai.Name))
                          {
                            if ((double) quai.PosX != 0.0 && (double) quai.PosY != 0.0)
                              num5 = GA.CalculateDistance((double) quai.PosX, (double) quai.PosY, (double) this.Myself.NhiemVuPosX, (double) this.Myself.NhiemVuPosY);
                            if (num5 <= 10.0 && this.CanAttack(quai))
                              this.Myself.TrungAcQuaiList.Add(quai);
                          }
                        }
                      }
                      catch (Exception ex)
                      {
                      }
                    }
                  }
                  this.CallUseItem(itemIndex1, this.Myself.ID);
                  this.Myself.TrungAcItemUsed = true;
                  this.CleanUpInventory();
                  if (this.MyPet.ActivePetID == 0)
                    this.CallPetSure(this.MyPet.AlwaysActivePetName);
                  this.Myself.TrungAcItemUsedStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                }
              }
            }
            else if (this.Myself.MapID != this.Myself.NhiemVuMapID && !this.Myself.JustWarped && this.Myself.ActionStatus != (byte) 2)
            {
              int itemIndex2 = -1;
              if (!this.Settings.cboxTAHoiPhuc)
                flag2 = true;
              if (!flag2 && this.Settings.cboxTAHoiPhuc)
                flag2 = this.ForceHoiMau();
              if (flag2)
              {
                if (this.Settings.cboxTADungPhu && (this.Myself.MapID == 1 || this.Myself.MapID == 0))
                {
                  int needMapID = -1;
                  if (this.Myself.NhiemVuMapID >= 18 && this.Myself.NhiemVuMapID <= 19 && this.Settings.cboxPhuQuaLD)
                    needMapID = 0;
                  else if (this.Myself.NhiemVuMapID == 24 && this.Settings.cboxPhuQuaLD && this.Myself.NhiemVuMapID != 25)
                    needMapID = 2;
                  if (needMapID >= 0)
                    itemIndex2 = this.SearchDVP(needMapID);
                }
                if (itemIndex2 >= 0)
                {
                  this.CallXuongNgua();
                  this.CallUseItem(itemIndex2, this.Myself.ID);
                }
                else
                {
                  bool flag6 = false;
                  int menuIndex1 = 0;
                  int menuIndex2 = 0;
                  if (this.IsInCity() && this.Settings.cboxTAXaPhu)
                  {
                    if (this.Myself.NhiemVuMapID >= 20 && this.Myself.NhiemVuMapID <= 23)
                    {
                      menuIndex1 = 6;
                      menuIndex2 = 61;
                      flag6 = true;
                    }
                    else if (this.Myself.NhiemVuMapID >= 26 && this.Myself.NhiemVuMapID <= 29)
                    {
                      menuIndex1 = 5;
                      menuIndex2 = 51;
                      flag6 = true;
                    }
                    else if (this.Myself.NhiemVuMapID >= 32 /*0x20*/ && this.Myself.NhiemVuMapID <= 35)
                    {
                      menuIndex1 = 4;
                      menuIndex2 = 41;
                      flag6 = true;
                    }
                    if (flag6)
                    {
                      int num6 = 334;
                      int num7 = 250;
                      int num8 = 153;
                      if (this.Target.VersionNum == 4)
                      {
                        num6 = 241;
                        num7 = 158;
                      }
                      if (this.Myself.MapID == 1)
                      {
                        if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num6, (double) num7) > 3.0)
                        {
                          if (!this.Myself.JustWarped)
                          {
                            this.CallLenNgua();
                            this.CallInMapMove(num6, num7);
                          }
                        }
                        else
                        {
                          this.CallSelectTarget(num8);
                          Thread.Sleep(300);
                          this.CallTalkNPC(0, 0, num8);
                          Thread.Sleep(700);
                          this.CallTalkNPC(400957, menuIndex1, num8);
                          Thread.Sleep(700);
                          this.CallTalkNPC(400957, menuIndex2, num8);
                          Thread.Sleep(1000);
                          if (this.Myself.isMessageBox_Self == 1)
                          {
                            this.CallStartAutoMoveClick();
                            Thread.Sleep(3000);
                          }
                          else
                            Thread.Sleep(2000);
                          flag6 = false;
                        }
                      }
                      else if (!this.Myself.JustWarped)
                      {
                        this.CallLenNgua();
                        this.CallOutMapMove(num6, num7, 1);
                      }
                    }
                  }
                  if (!flag6 && this.Myself.ActionStatus != (byte) 2 && this.Myself.ActionStatus != (byte) 5 && !this.Myself.JustWarped)
                  {
                    this.CallLenNgua();
                    if ((this.Myself.MapID == 1 || this.Myself.MapID == 0) && flag2 || this.Myself.MapID != 1)
                      this.CallOutMapMove(nhiemVuPosX, nhiemVuPosY, this.Myself.NhiemVuMapID);
                  }
                }
              }
            }
          }
        }
        if (this.Myself.NhiemVuPosX == 0 || this.Myself.NhiemVuPosY == 0 || this.Myself.PacketMsg == string.Empty)
          this.CallUseItem(itemIndex1, this.Myself.ID);
      }
      if (!flag3 && this.Myself.TrungAcItemUsed && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.TrungAcItemUsedStamp >= 2000L)
      {
        if (this.Myself.CaptchaRemaining > 0)
          this.Myself.TrungAcQuaiDied = true;
        bool flag7 = false;
        QuaiIndividual quaiIndividual1 = (QuaiIndividual) null;
        QuaiIndividual quaiIndividual2 = (QuaiIndividual) null;
        if (this.MyQuai.AllQuai.Count > 0)
        {
          if (!this.IsInCity())
          {
            try
            {
              for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
              {
                QuaiIndividual quai = this.MyQuai.AllQuai[index];
                if (!string.IsNullOrEmpty(quai.Name))
                {
                  double num9 = 999.0;
                  if ((double) quai.PosX != 0.0 && (double) quai.PosY != 0.0)
                    num9 = GA.CalculateDistance((double) quai.PosX, (double) quai.PosY, (double) this.Myself.NhiemVuPosX, (double) this.Myself.NhiemVuPosY);
                  if (num9 <= 20.0 && this.CanAttack(quai))
                  {
                    bool flag8 = false;
                    foreach (QuaiIndividual trungAcQuai in this.Myself.TrungAcQuaiList)
                    {
                      if (trungAcQuai.ID == quai.ID)
                      {
                        flag8 = true;
                        break;
                      }
                    }
                    if (!this.Myself.TrungAcFoundQuai)
                    {
                      if ((double) quai.HPPercent > 0.0 && (quai.IsBossValue >= 3500 && quai.IsBossValue <= 3509 || quai.IsBossValue >= 33500 && quai.IsBossValue <= 33509 || quai.IsBossValue >= 31860 && quai.IsBossValue <= 31869 || quai.IsBossValue >= 1860 && quai.IsBossValue <= 1869))
                      {
                        quaiIndividual1 = quai;
                        this.Myself.TrungAcFoundQuai = true;
                        break;
                      }
                      if (!flag8 && quai.Level >= this.Myself.Level - 1 && quai.Level <= this.Myself.Level + 1)
                        quaiIndividual2 = quai;
                    }
                  }
                }
              }
              flag7 = true;
            }
            catch (Exception ex)
            {
            }
          }
        }
        if (quaiIndividual1 == null && flag7 && quaiIndividual2 != null)
        {
          quaiIndividual1 = quaiIndividual2;
          this.Myself.TrungAcFoundQuai = true;
        }
        if (quaiIndividual1 != null && !this.Myself.TrungAcQuaiDied && quaiIndividual1.ID >= 0)
        {
          this.CallSelectTarget(quaiIndividual1.ID);
          this.CallAttackTarget(quaiIndividual1.ID, this.MySkills.AllSkills[0].ID, 0, 0);
        }
        if (this.Myself.TrungAcFoundQuai && (double) this.MyQuai.TargetHPPercent > 0.0 && this.MyQuai.TargetID >= 0)
          this.CallAttackTarget(this.MyQuai.TargetID, this.MySkills.AllSkills[0].ID, 0, 0);
        if (this.Myself.EventString == "DCTAB" && !this.Myself.TrungAcQuaiDied)
        {
          this.Myself.TrungAcQuaiDied = true;
          this.Myself.TrungAcHetQuaiStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
        }
        if (this.Myself.EventString == "DCTAB" && this.Myself.TrungAcQuaiDied && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.TrungAcHetQuaiStamp >= 1500L)
        {
          this.FuncHuyItem();
          this.CleanUpInventory();
          NewBoc newBoc = (NewBoc) null;
          if (this.MyBoc.AllBocs.Count > 0)
          {
            try
            {
              for (int index = this.MyBoc.AllBocs.Count - 1; index >= 0; --index)
              {
                NewBoc allBoc = this.MyBoc.AllBocs[index];
                if (allBoc.BocType == 5000 && allBoc.BocID != 0)
                {
                  newBoc = allBoc;
                  break;
                }
              }
            }
            catch (Exception ex)
            {
              GA.WriteUserLog(frmMain.langTABocError, this);
            }
          }
          if (newBoc != null)
          {
            this.Myself.TrungAcFoundBoc = true;
            this.NhatBoc();
          }
          if ((newBoc == null || this.Myself.FlagFullBoc) && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.TrungAcHetQuaiStamp >= 3000L && this.Myself.TrungAcFoundBoc)
            this.Myself.TrungAcFinished = true;
        }
      }
      if (!this.Myself.TrungAcFinished || !this.Myself.TrungAcFoundBoc)
        return;
      int ToX = 224 /*0xE0*/;
      int ToY = 226;
      if (this.Target.VersionNum == 4)
      {
        ToX = (int) sbyte.MaxValue;
        ToY = 133;
      }
      if (this.Myself.MapID != 1)
      {
        this.CallPhuOrGoHome();
        if (this.Myself.ActionStatus == (byte) 2 || this.Myself.ActionStatus == (byte) 5)
          ;
      }
      else
      {
        if (this.Myself.MapID != 1)
          return;
        if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) ToX, (double) ToY) > 2.5)
        {
          this.Myself.TargetX = (float) ToX;
          this.Myself.TargetY = (float) ToY;
          this.Myself.MoveAcrossMap = false;
          this.Myself.UseAutoMove = false;
          this.CallInMapMove((int) this.Myself.TargetX, (int) this.Myself.TargetY);
        }
        else
        {
          if (!this.Myself.TrungAcFinished)
            return;
          this.Myself.actionFlag = 0;
          bool flag9 = false;
          bool flag10 = false;
          long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
          while (!flag9 && !flag10 && this.Myself.IsTrungAc)
          {
            if (this.Myself.isQuestFrameShow == 0 && this.Myself.actionFlag == 0)
            {
              this.CallTalkNPC(0, 0, 115);
              Thread.Sleep(300);
              this.CallTalkNPC(229020, -1, 115);
            }
            Thread.Sleep(500);
            if (this.Myself.isQuestFrameShow == 1)
            {
              this.CallTraNhiemVu();
              Thread.Sleep(1000);
              this.CallTraNhiemVu();
              this.Myself.actionFlag = 1;
            }
            if (this.Myself.EventString == "TAXQ" || this.Myself.actionCounter >= 3)
            {
              this.Myself.TrungAcFinished = false;
              this.Myself.TrungAcFoundQuai = false;
              this.Myself.TrungAcItemUsed = false;
              this.Myself.TrungAcQuaiDied = false;
              this.Myself.TrungAcCheckMap = false;
              this.Myself.TrungAcFoundBoc = false;
              this.Myself.TrungAcQuaiList.Clear();
              this.Myself.actionCounter = 0;
              this.CallResetNhiemVuData();
              this.ResetEventString();
              ++this.Myself.trungacCounter;
              GA.WriteUserLog(frmMain.langFightDevilRounds, this, (object) this.Myself.trungacCounter);
              flag9 = true;
            }
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds >= 3000L)
            {
              this.CallTalkNPC(0, 0, 115);
              Thread.Sleep(300);
              this.CallTalkNPC(229020, -1, 115);
              ++this.Myself.actionCounter;
              break;
            }
          }
        }
      }
    }
  }

  public void NhiemVuLuyenKim()
  {
    bool flag1 = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    if (!flag1 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LuyenKimStamp < 200L)
      return;
    int menuIndex = 14;
    if (this.Settings.cboxLuyenKimCham)
      menuIndex = 11;
    this.Myself.LuyenKimStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    bool flag2 = GA.IsBangMapID(this.Myself.MapID);
    int num1 = 238;
    int num2 = 236;
    if (!flag2)
    {
      this.GoToMyBang();
    }
    else
    {
      if (!flag2)
        return;
      if (!this.Myself.LuyenKimHasInfo)
      {
        if (this.Myself.QLKF1 >= 1766 && this.Myself.QLKF1 <= 1769)
        {
          this.Myself.LuyenKimNhanQ = true;
          this.Myself.LuyenKimHasInfo = true;
          this.Myself.LuyenKimVanChuyen = false;
        }
        if (!this.Myself.LuyenKimNhanQ)
        {
          if (this.Settings.cboxLKTuNhanNV)
          {
            num1 = 66;
            num2 = 134;
            if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num1, (double) num2) > 2.5)
            {
              this.CallInMapMove(num1, num2);
            }
            else
            {
              this.ResetPacketMsg();
              this.CallXuongNgua();
              bool flag3 = false;
              bool flag4 = false;
              long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
              long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
              while (!flag3 && !flag4 && this.Myself.IsLuyenKim)
              {
                if (this.Myself.isQuestFrameShow == 0 && this.Myself.actionFlag == 0)
                  this.CallTalkNPCByPos2(600059, menuIndex, 66, 135);
                long elapsedMilliseconds3 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                while (this.Myself.isQuestFrameShow == 0)
                {
                  Thread.Sleep(200);
                  if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds3 > 2000L)
                    break;
                }
                if (this.Myself.PacketMsg == "NNVLK")
                {
                  this.CallNhanNhiemVu();
                  this.Myself.actionFlag = 1;
                }
                else if (this.Myself.PacketMsg == "CNBT")
                {
                  this.CallTalkNPCByPos2(600059, 12, 66, 135, true);
                  this.Myself.actionFlag = 1;
                }
                else if (this.Myself.PacketMsg == "NNVL")
                {
                  this.CallTalkNPCByPos2(600059, menuIndex, 66, 135, true);
                  this.Myself.actionFlag = 1;
                }
                else
                {
                  if (this.Myself.PacketMsg == "HDLKN")
                  {
                    this.Settings.cboxLuyenKimCham = true;
                    GA.WriteUserLog(frmMain.langHoatDongPoint2, this);
                    return;
                  }
                  if (this.Myself.PacketMsg == "HDHD")
                  {
                    this.Myself.IsLuyenKim = false;
                    this.IsAIEnabled = false;
                    GA.WriteUserLog(frmMain.langHoatDongPoint1, this);
                    break;
                  }
                }
                if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 >= 3000L)
                {
                  if (this.Myself.PacketMsg == "CNBT")
                    this.CallTalkNPCByPos(600059, 12, 66, 135);
                  else
                    this.CallTalkNPCByPos(600059, menuIndex, 66, 135);
                  elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                }
                if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 >= 12000L)
                {
                  if (this.CustomSleep(6, 21600000))
                    GA.WriteUserLog(frmMain.langAutoALTQ, this);
                  flag3 = true;
                }
                if (this.Myself.PacketMsg == "LKT" || this.Myself.PacketMsg == "CTNV" || this.Myself.QLKF1 >= 1766 && this.Myself.QLKF1 <= 1769 || flag3)
                {
                  this.Myself.LuyenKimNhanQ = true;
                  this.Myself.actionFlag = 0;
                  break;
                }
                Thread.Sleep(500);
              }
            }
          }
        }
        else if (this.Myself.LuyenKimNhanQ && !this.Myself.LuyenKimHasInfo)
        {
          bool flag5 = false;
          long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
          this.CallResetNhiemVuData();
          while (!flag5)
          {
            if (this.Myself.QuestInfo == string.Empty)
            {
              this.CallToggleMission();
              Thread.Sleep(1000);
              this.CallToggleMission(2);
              Thread.Sleep(500);
            }
            if (this.Myself.QuestInfo != "")
            {
              int num3 = 0;
              bool flag6 = false;
              while (this.Myself.QuestInfo.Contains("BHRWSC_110331"))
              {
                int num4 = this.Myself.QuestInfo.IndexOf("(");
                int num5 = this.Myself.QuestInfo.IndexOf(")");
                int num6 = this.Myself.QuestInfo.LastIndexOf("(");
                this.Myself.QuestInfo.LastIndexOf(")");
                if (num4 == num6 && num4 != -1)
                {
                  flag5 = true;
                  flag6 = true;
                  break;
                }
                if (num4 != num6 && num5 != -1)
                {
                  if (!string.IsNullOrEmpty(this.Myself.QuestInfo))
                  {
                    try
                    {
                      string[] strArray = this.Myself.QuestInfo.Substring(num4 + 1, num5 - num4 - 1).Split(',');
                      this.Myself.LuyenKimVanChuyen = true;
                      int result1 = 0;
                      int result2 = 0;
                      int.TryParse(strArray[0], out result1);
                      int.TryParse(strArray[1], out result2);
                      this.CallSetUpNhiemVuData(result1, result2);
                      flag5 = true;
                      this.Myself.LuyenKimCheckMap = true;
                      flag6 = true;
                      break;
                    }
                    catch (Exception ex)
                    {
                      GA.WriteUserLog(frmMain.langLKGetPosError + ex.Message, this);
                    }
                  }
                }
                ++num3;
                this.CallToggleMission(2);
                Thread.Sleep(1000);
                if (num3 > 3)
                  break;
              }
              if (!flag6)
                this.Myself.LuyenKimNhanQ = false;
            }
            Thread.Sleep(300);
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds >= 2000L)
              break;
          }
          if (flag5)
            this.Myself.LuyenKimHasInfo = true;
        }
      }
      if (this.Myself.LuyenKimHasInfo)
      {
        GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num1, (double) num2);
        if (this.Myself.LuyenKimNhanQ && !this.Myself.LuyenKimFinished && this.Myself.LuyenKimIntraTour < 2 && (!this.Myself.LuyenKimCheckMap || this.Myself.NhiemVuPosX == 0) && !this.Myself.LuyenKimVanChuyen)
        {
          if (this.Myself.NhiemVuPosX > 0 && this.Myself.NhiemVuPosY > 0)
          {
            this.Myself.LuyenKimCheckMap = true;
          }
          else
          {
            if (this.Myself.QLKF1 == 1767)
              Thread.Sleep(1000);
            this.CallResetNhiemVuData();
            this.CallAttackTarget(-1, 1766, 0, 0);
            Thread.Sleep(300);
            if (this.Myself.NhiemVuPosX > 0 && this.Myself.NhiemVuPosY > 0)
              this.Myself.LuyenKimCheckMap = true;
          }
          if (this.Myself.NhiemVuPosX == 66 && this.Myself.NhiemVuPosY == 135)
            this.Myself.LuyenKimFinished = true;
        }
        if (this.Myself.NhiemVuPosX != 0 && this.Myself.NhiemVuPosY != 0 && this.Myself.LuyenKimNhanQ && this.Myself.LuyenKimCheckMap && !this.Myself.LuyenKimFinished)
        {
          if (!this.Myself.LuyenKimVanChuyen)
          {
            int nhiemVuPosX = this.Myself.NhiemVuPosX;
            int nhiemVuPosY = this.Myself.NhiemVuPosY;
            double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) nhiemVuPosX, (double) nhiemVuPosY);
            if (distance > 4.0)
              this.CallInMapMove(nhiemVuPosX, nhiemVuPosY);
            else if (distance <= 4.0 && !this.Myself.LuyenKimPlaySkill)
            {
              Thread.Sleep(200);
              this.CallAttackTarget(-1, this.Myself.QLKF1, 0, 0);
              this.Myself.LuyenKimFoundBoc = false;
              this.Myself.LuyenKimHetBoc = false;
              Thread.Sleep(2000);
              if (this.Myself.ActionStatus == (byte) 6 || this.Myself.ActionStatus == (byte) 5)
              {
                bool flag7 = false;
                while (!flag7 && this.Myself.IsLuyenKim)
                {
                  if (this.Myself.ActionStatus != (byte) 6 && this.Myself.ActionStatus != (byte) 5)
                    flag7 = true;
                  Thread.Sleep(1000);
                }
                this.Myself.LuyenKimBocStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                this.Myself.LuyenKimPlaySkill = true;
              }
              if (this.Myself.PacketMsg == "DDXR")
              {
                this.Myself.LuyenKimBocStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                this.Myself.LuyenKimPlaySkill = true;
                this.ResetPacketMsg();
              }
            }
          }
          if (this.Myself.LuyenKimVanChuyen && this.Myself.NhiemVuPosX != 0 && this.Myself.NhiemVuPosY != 0)
          {
            int nhiemVuPosX = this.Myself.NhiemVuPosX;
            int nhiemVuPosY = this.Myself.NhiemVuPosY;
            double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) nhiemVuPosX, (double) nhiemVuPosY);
            if (distance > 5.0)
            {
              this.CallLenNgua();
              this.CallInMapMove(nhiemVuPosX, nhiemVuPosY);
            }
            else if (distance <= 5.0)
            {
              this.CallResetNhiemVuData();
              this.CallXuongNgua();
              bool flag8 = false;
              long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
              while (!flag8 && this.Myself.IsLuyenKim)
              {
                if (!this.Settings.cboxLuyenKimCham)
                  this.CallTalkNPCByPos(891017, 12, nhiemVuPosX, nhiemVuPosY);
                else
                  this.CallTalkNPCByPos(600060, 12, nhiemVuPosX, nhiemVuPosY);
                Thread.Sleep(300);
                if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds >= 10000L)
                  flag8 = true;
                if (this.Myself.EventString == "LKXQ" || this.Myself.PacketMsg == "LKXQ" || flag8)
                {
                  this.Myself.LuyenKimFinished = true;
                  this.Myself.LuyenKimHetBoc = true;
                  flag8 = true;
                }
              }
            }
          }
          if (this.Myself.LuyenKimPlaySkill && !this.Myself.LuyenKimVanChuyen)
          {
            NewBoc newBoc = (NewBoc) null;
            if (this.Myself.QLKF1 == 1769)
            {
              if (this.MyBoc.AllBocs.Count > 0)
              {
                try
                {
                  for (int index = this.MyBoc.AllBocs.Count - 1; index >= 0; --index)
                  {
                    NewBoc allBoc = this.MyBoc.AllBocs[index];
                    if (allBoc.BocType == 5000 && allBoc.BocID != 0)
                    {
                      newBoc = allBoc;
                      break;
                    }
                  }
                }
                catch (Exception ex)
                {
                }
              }
              if (newBoc != null)
              {
                this.NhatBoc();
                this.Myself.LuyenKimFoundBoc = true;
                if (this.Myself.NhiemVuPosX == 66 && this.Myself.NhiemVuPosY == 135)
                  this.Myself.LuyenKimFinished = true;
              }
              if (newBoc == null && this.Myself.LuyenKimFoundBoc && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LuyenKimBocStamp >= 2000L)
                this.Myself.LuyenKimHetBoc = true;
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LuyenKimBocStamp >= 15000L)
                this.Myself.LuyenKimHetBoc = true;
            }
            else
              this.Myself.LuyenKimHetBoc = true;
            if (newBoc == null && !this.Myself.LuyenKimFinished && this.Myself.LuyenKimHetBoc)
            {
              this.Myself.LuyenKimPlaySkill = false;
              this.Myself.LuyenKimCheckMap = false;
              this.CallResetNhiemVuData();
            }
          }
        }
      }
      if (!this.Myself.LuyenKimFinished)
        return;
      bool flag9 = false;
      if (this.Myself.QLKF1 >= 1766 && this.Myself.QLKF1 <= 1769)
      {
        this.CallAttackTarget(-1, 143, 0, 0);
        flag9 = true;
      }
      int num7 = 66;
      int num8 = 134;
      double distance1 = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num7, (double) num8);
      if (distance1 > 20.0 && flag9)
      {
        Thread.Sleep(1500);
        this.CallLenNgua();
      }
      if (distance1 > 2.5)
      {
        this.CallInMapMove(num7, num8);
      }
      else
      {
        if (!this.Myself.LuyenKimFinished)
          return;
        this.ResetPacketMsg();
        this.ResetEventString();
        this.CallResetNhiemVuData();
        bool flag10 = false;
        bool flag11 = false;
        long elapsedMilliseconds4 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        long elapsedMilliseconds5 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        while (!flag10 && !flag11 && this.Myself.IsLuyenKim)
        {
          if (this.Myself.isQuestFrameShow == 0 && this.Myself.actionFlag == 0)
            this.CallTalkNPCByPos(600059, menuIndex, 66, 135);
          Thread.Sleep(500);
          if (this.Myself.PacketMsg == "CTNV" || this.Myself.isQuestFrameShow == 1)
          {
            this.CallTraNhiemVu();
            Thread.Sleep(700);
            this.CallTraNhiemVu();
            this.Myself.actionFlag = 1;
          }
          if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds5 >= 3000L)
          {
            this.CallTalkNPCByPos(600059, menuIndex, 66, 135);
            elapsedMilliseconds5 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          }
          if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds4 >= 10000L)
            flag10 = true;
          if (this.Myself.EventString == "LKXQ" || this.Myself.PacketMsg == "LKXQ" || flag10)
          {
            this.Myself.LuyenKimCheckMap = false;
            this.Myself.LuyenKimFinished = false;
            this.Myself.LuyenKimFoundBoc = false;
            this.Myself.LuyenKimHetBoc = false;
            this.Myself.LuyenKimIntraTour = 0;
            this.Myself.LuyenKimNhanQ = false;
            this.Myself.LuyenKimPlaySkill = false;
            this.Myself.LuyenKimVanChuyen = false;
            this.Myself.LuyenKimHasInfo = false;
            this.Myself.actionFlag = 0;
            ++this.Myself.luyenkimCounter;
            GA.WriteUserLog(frmMain.langLKRounds, this, (object) this.Myself.luyenkimCounter);
            Thread.Sleep(500);
            break;
          }
        }
      }
    }
  }

  public void NhiemVuXayDung()
  {
    bool flag1 = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    if (!flag1 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.XayDungStamp < 300L)
      return;
    this.Myself.XayDungStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    bool flag2 = GA.IsBangMapID(this.Myself.MapID);
    int tempX1 = 238;
    int tempY1 = 236;
    if (this.isInDiaPhu())
    {
      this.CallMoveTo(12, 24);
    }
    else
    {
      if ((this.Myself.NhiemVuPosX == 0 || this.Myself.QuestInfo == string.Empty) && !this.Myself.XayDungFinished && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.XayDungStamp2 >= 10000L && this.Myself.actionFlag == 0)
      {
        this.Myself.XayDungStamp2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        this.CheckXayDungQ(ref tempX1, ref tempY1);
      }
      if (!flag2 && !this.Myself.XayDungNhanQ)
        this.GoToMyBang();
      else if (flag2 && !this.Myself.XayDungNhanQ && !this.Myself.XayDungNhanQ)
      {
        tempX1 = 99;
        tempY1 = 54;
        double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) tempX1, (double) tempY1);
        if (distance > 2.5)
        {
          if (distance > 40.0)
            this.CallLenNgua();
          this.CallInMapMove(tempX1, tempY1);
        }
        else
        {
          this.CallClearNhiemVuData();
          this.Myself.actionFlag = 0;
          this.ResetPacketMsg();
          this.ResetEventString();
          bool flag3 = false;
          bool flag4 = false;
          long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          while (!flag3 && !flag4 && this.Myself.IsXayDung)
          {
            if (this.Myself.isQuestFrameShow == 0 && this.Myself.actionFlag == 0)
            {
              this.CallTalkNPCByPos(600035, -1, tempX1, tempY1);
              Thread.Sleep(500);
            }
            Thread.Sleep(500);
            if (this.Myself.isQuestFrameShow == 1)
              this.Myself.actionFlag = 1;
            if (this.Myself.PacketMsg == "XDDC")
            {
              flag3 = true;
              this.Myself.XayDungDichChuyen = true;
              this.Myself.XayDungDanhQuai = true;
              this.Myself.XayDungNhanQ = true;
              this.Myself.actionFlag = 0;
            }
            else if (this.Myself.PacketMsg == "XDCT")
            {
              flag3 = true;
              this.Myself.XayDungNhanQ = true;
              this.Myself.actionFlag = 0;
              this.Myself.XayDungFinished = false;
              this.Myself.XayDungCongTruong = true;
            }
            else if (this.Myself.EventString == "XDTT" || this.Myself.PacketMsg == "XDMD")
            {
              flag3 = true;
              this.Myself.XayDungDichChuyen = false;
              this.Myself.XayDungNhanQ = true;
              this.Myself.actionFlag = 0;
            }
            if (this.Myself.QuestInfo.Contains("BHRW_"))
              this.Myself.XayDungCheckQ = true;
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 >= 10000L)
            {
              this.Myself.actionFlag = 0;
              if (this.CustomSleep(6, 21600000))
              {
                GA.WriteUserLog(frmMain.langQXDALTQ, this);
                break;
              }
              break;
            }
          }
          if (!this.Myself.XayDungDichChuyen)
          {
            this.CallResetNhiemVuData();
            Thread.Sleep(500);
            this.CallToggleMission();
            Thread.Sleep(1000);
            this.CallToggleMission(2);
            bool flag5 = false;
            bool flag6 = false;
            long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
            while (!flag5 && !flag6)
            {
              if (this.Myself.QuestInfo == string.Empty)
              {
                this.CallToggleMission();
                Thread.Sleep(1000);
                this.CallToggleMission();
              }
              else if (this.Myself.QuestInfo != "")
              {
                if (this.Myself.QuestInfo.Contains("BHRW_"))
                {
                  try
                  {
                    string[] strArray = GA.GetMidString(this.Myself.QuestInfo, "{_INFOAIM", "}").Split(',');
                    if (strArray.Length >= 3)
                    {
                      int result1 = 0;
                      int result2 = 0;
                      int result3 = -1;
                      int.TryParse(strArray[0], out result1);
                      int.TryParse(strArray[1], out result2);
                      int.TryParse(strArray[2], out result3);
                      this.CallSetUpNhiemVuData(result1, result2, result3);
                      flag5 = true;
                    }
                  }
                  catch (Exception ex)
                  {
                    GA.WriteUserLog(frmMain.langQXDErrorPos + ex.Message, this);
                  }
                  if (this.Myself.NhiemVuMapID == 2)
                  {
                    if (this.Myself.NhiemVuPosX == 166 && this.Myself.NhiemVuPosY == 124)
                      this.CallSetUpNhiemVuData(nvPosY: 137);
                    if (this.Myself.NhiemVuPosX == 154 && this.Myself.NhiemVuPosY == 130)
                      this.CallSetUpNhiemVuData(nvPosY: 125);
                    if (this.Myself.NhiemVuPosX == 166 && this.Myself.NhiemVuPosY == 131)
                      this.CallSetUpNhiemVuData(nvPosY: (int) sbyte.MaxValue);
                    if (this.Myself.NhiemVuPosX == 166 && this.Myself.NhiemVuPosY == 128 /*0x80*/)
                      this.CallSetUpNhiemVuData(nvPosY: 124);
                    if (this.Myself.NhiemVuPosX == 166 && this.Myself.NhiemVuPosY == 138)
                      this.CallSetUpNhiemVuData(nvPosY: 134);
                    if (this.Myself.NhiemVuPosX == 166 && this.Myself.NhiemVuPosY == 135)
                      this.CallSetUpNhiemVuData(nvPosY: 131);
                  }
                  if (this.Myself.NhiemVuMapID == 8 && this.Myself.NhiemVuPosX == 64 /*0x40*/ && this.Myself.NhiemVuPosY == 63 /*0x3F*/)
                    this.CallSetUpNhiemVuData(54);
                  if (this.Myself.NhiemVuMapID == 6)
                  {
                    if (this.Myself.NhiemVuPosX == 234 && this.Myself.NhiemVuPosY == 176 /*0xB0*/)
                      this.CallSetUpNhiemVuData(233, 184);
                    if (this.Myself.NhiemVuPosX == 240 /*0xF0*/ && this.Myself.NhiemVuPosY == 181)
                      this.CallSetUpNhiemVuData(241, 182);
                    if (this.Myself.NhiemVuPosX == 234 && this.Myself.NhiemVuPosY == 175)
                      this.CallSetUpNhiemVuData(nvPosY: 171);
                  }
                  if (this.Myself.NhiemVuMapID == 26 && this.Myself.NhiemVuPosX == 183 && this.Myself.NhiemVuPosY == 167)
                    this.CallSetUpNhiemVuData(nvPosY: 168);
                  if (this.Myself.NhiemVuMapID == 25 && this.Myself.NhiemVuPosX == 155 && this.Myself.NhiemVuPosY == 250)
                    this.CallSetUpNhiemVuData(nvPosY: 205);
                  if (this.Myself.QuestInfo.ToLower().Contains("cần các hạ đi đoạt lại") || this.Myself.QuestInfoHex.ToLower().Contains("c¥n các hÕ ði ðoÕt lÕi"))
                    this.Myself.XayDungDanhQuai = true;
                  if (this.Myself.QuestInfo.Contains("Tìm thủ lĩnh mà giang hồ") || this.Myself.QuestInfoHex.Contains("Tìm thü lînh mà giang h") || this.Myself.XayDungCongTruong)
                  {
                    if (GA.IsBangMapID(this.Myself.MapID))
                    {
                      int num1 = 99;
                      int num2 = 54;
                      if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num1, (double) num2) > 3.0)
                      {
                        this.CallInMapMove(num1, num2);
                      }
                      else
                      {
                        this.Myself.InMapPathPoints.Clear();
                        this.Myself.InPathPointIndex = 0;
                        this.Myself.InMapPathPoints.Add(new InMapPoint()
                        {
                          PosX = 22,
                          PosY = 39
                        });
                        this.Myself.InMapPathPoints.Add(new InMapPoint()
                        {
                          PosX = 39,
                          PosY = 36
                        });
                        this.Myself.InMapPathPoints.Add(new InMapPoint()
                        {
                          PosX = 31 /*0x1F*/,
                          PosY = 23
                        });
                        this.Myself.XayDungDichChuyen = true;
                        this.Myself.XayDungNhanQ = true;
                        this.Myself.XayDungFinished = false;
                        this.Myself.XayDungCongTruong = true;
                        this.CallTalkNPCByPos(600039, -1, 99, 54);
                        Thread.Sleep(1000);
                        this.CallTalkNPCByPos(600039, 1, 99, 54, false);
                        Thread.Sleep(1000);
                        if (this.Myself.PacketMsg == "XDTQ")
                        {
                          this.CallTraNhiemVu();
                          Thread.Sleep(700);
                          this.CallTraNhiemVu();
                          Thread.Sleep(500);
                          this.Myself.XayDungFinished = false;
                          this.Myself.XayDungNhanQ = false;
                          this.Myself.XayDungInMap = false;
                          this.Myself.XayDungDichChuyen = false;
                          this.Myself.XayDungCheckQ = false;
                          this.Myself.XayDungDanhQuai = false;
                          this.Myself.OldQuestInfo = "";
                          this.Myself.XayDungCongTruong = false;
                          this.Myself.XayDungVaoCongTruong = false;
                          this.Myself.actionCounter = 0;
                          this.ResetPacketMsg();
                          this.ResetEventString();
                          this.CallResetNhiemVuData();
                          ++this.Myself.xaydungCounter;
                          GA.WriteUserLog(frmMain.langQXDRounds, this, (object) this.Myself.xaydungCounter);
                        }
                      }
                    }
                    else
                      this.GoToMyBang();
                  }
                }
              }
              Thread.Sleep(500);
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 >= 5000L)
                break;
            }
            if (flag5)
              this.Myself.XayDungNhanQ = true;
          }
          else if (this.Myself.XayDungDichChuyen)
          {
            tempX1 = 99;
            tempY1 = 54;
            bool flag7 = true;
            long elapsedMilliseconds3 = frmLogin.GlobalTimer.ElapsedMilliseconds;
            while (flag7)
            {
              Thread.Sleep(500);
              this.CallTalkNPCByPos(600038, 1, tempX1, tempY1, false);
              ++this.Myself.actionCounter;
              if (this.Myself.isSceneTrans == 1 || this.Myself.isMessageBox_Self == 1 || this.Myself.actionCounter++ >= 10)
              {
                this.Myself.actionCounter = 0;
                break;
              }
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds3 >= 10000L)
                break;
            }
            bool flag8 = false;
            bool flag9 = false;
            long elapsedMilliseconds4 = frmLogin.GlobalTimer.ElapsedMilliseconds;
            while (!flag8 && !flag9)
            {
              if (this.Myself.isMessageBox_Self == 1)
              {
                flag8 = true;
                this.CallStartAutoMoveClick();
                Thread.Sleep(500);
              }
              Thread.Sleep(500);
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds4 >= 5000L)
                break;
            }
            if (flag8)
            {
              int id = this.Myself.ID;
              Thread.Sleep(1000);
              bool flag10 = false;
              long elapsedMilliseconds5 = frmLogin.GlobalTimer.ElapsedMilliseconds;
              while (!flag10)
              {
                if (this.Myself.MapID >= 0 && this.Myself.MapID != id && this.Myself.HPPercent > 0.0)
                {
                  flag10 = true;
                  this.Myself.XayDungNhanQ = true;
                  this.Myself.XayDungInMap = true;
                }
                else
                {
                  Thread.Sleep(500);
                  if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds5 >= 5000L)
                    break;
                }
              }
            }
          }
        }
      }
      if (this.Myself.XayDungNhanQ && !this.Myself.XayDungFinished && (this.Myself.NhiemVuMapID != -1 && this.Myself.NhiemVuPosX != 0 && this.Myself.NhiemVuPosY != 0 || this.Myself.XayDungDichChuyen))
      {
        if (!this.Myself.XayDungDichChuyen)
        {
          if (flag2)
          {
            tempX1 = 99;
            tempY1 = 54;
            double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) tempX1, (double) tempY1);
            if (distance > 3.0)
            {
              if (distance > 35.0)
                this.CallLenNgua();
              this.CallInMapMove(tempX1, tempY1);
            }
            else
            {
              int mapId = this.Myself.MapID;
              Thread.Sleep(500);
              this.CallTalkNPCByPos(0, 0, tempX1, tempY1, false);
              Thread.Sleep(1000);
              this.CallTalkNPCByPos(805009, 29, tempX1, tempY1, false);
              Thread.Sleep(500);
              if (this.Myself.NhiemVuMapID == 0)
              {
                this.CallTalkNPCByPos(805009, 11, tempX1, tempY1, false);
                Thread.Sleep(500);
              }
              else if (this.Myself.NhiemVuMapID == 2)
              {
                this.CallTalkNPCByPos(805009, 27, tempX1, tempY1, false);
                Thread.Sleep(500);
              }
              else
              {
                this.CallTalkNPCByPos(805009, 28, tempX1, tempY1, false);
                Thread.Sleep(500);
              }
              bool flag11 = false;
              long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
              while (!flag11)
              {
                if (this.Myself.MapID != mapId && this.Myself.HPPercent > 0.0 && !this.Myself.JustWarped)
                  flag11 = true;
                else if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds < 6000L)
                  Thread.Sleep(500);
                else
                  break;
              }
              Thread.Sleep(1000);
            }
          }
          else
          {
            bool flag12 = false;
            int menuIndex1 = 0;
            int menuIndex2 = 0;
            if (this.IsInCity() && this.Settings.cboxXDXaPhu)
            {
              if (this.Myself.NhiemVuMapID >= 20 && this.Myself.NhiemVuMapID <= 23)
              {
                menuIndex1 = 6;
                menuIndex2 = 61;
                flag12 = true;
              }
              else if (this.Myself.NhiemVuMapID >= 26 && this.Myself.NhiemVuMapID <= 29)
              {
                menuIndex1 = 5;
                menuIndex2 = 51;
                flag12 = true;
              }
              else if (this.Myself.NhiemVuMapID >= 32 /*0x20*/ && this.Myself.NhiemVuMapID <= 35)
              {
                menuIndex1 = 4;
                menuIndex2 = 41;
                flag12 = true;
              }
              if (flag12)
              {
                if (this.Myself.MapID == 1)
                {
                  if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, 334.0, 250.0) > 3.0)
                  {
                    if (!this.Myself.JustWarped)
                      this.CallInMapMove(334, 250);
                  }
                  else
                  {
                    this.CallSelectTarget(153);
                    Thread.Sleep(200);
                    this.CallTalkNPC(0, 0, 153);
                    Thread.Sleep(500);
                    this.CallTalkNPC(400957, menuIndex1, 153);
                    Thread.Sleep(500);
                    this.CallTalkNPC(400957, menuIndex2, 153);
                    Thread.Sleep(1000);
                    if (this.Myself.isMessageBox_Self == 1)
                    {
                      this.CallStartAutoMoveClick();
                      Thread.Sleep(3000);
                    }
                    else
                      Thread.Sleep(2000);
                    flag12 = false;
                  }
                }
                else if (!this.Myself.JustWarped)
                {
                  this.CallLenNgua();
                  this.CallOutMapMove(334, 250, 1);
                }
              }
            }
            if (!this.Myself.JustWarped && !flag12)
            {
              this.CallLenNgua();
              if (this.Myself.MapID != this.Myself.NhiemVuMapID)
                this.CallOutMapMove(this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY, this.Myself.NhiemVuMapID);
              else
                this.CallInMapMove(this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY);
            }
          }
        }
        if ((this.Myself.MapID == this.Myself.NhiemVuMapID && !this.Myself.JustWarped || this.Myself.XayDungDichChuyen) && this.Myself.HPPercent > 0.0 && !this.Myself.XayDungFinished)
        {
          if (!this.Myself.XayDungDichChuyen)
          {
            double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) this.Myself.NhiemVuPosX, (double) this.Myself.NhiemVuPosY);
            if (distance > 5.0)
            {
              if (distance > 35.0)
                this.CallLenNgua();
              this.CallInMapMove(this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY);
            }
            else if (this.Myself.XayDungDanhQuai)
            {
              this.Myself.XayDungDichChuyen = true;
            }
            else
            {
              Thread.Sleep(2000);
              this.CallTalkNPCByPos(0, 0, this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY);
              Thread.Sleep(500);
              this.ResetPacketMsg();
              this.ResetEventString();
              bool flag13 = false;
              bool flag14 = false;
              long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
              while (!flag13 && !flag14)
              {
                if (this.Myself.EventString == "XDXQ")
                {
                  this.Myself.XayDungFinished = true;
                  flag13 = true;
                  this.Myself.actionCounter = 0;
                }
                if (this.Myself.PacketMsg == "XDMD" || this.Myself.actionCounter >= 2 || this.Myself.isQuestFrameShow == 1)
                {
                  this.Myself.XayDungCheckQ = false;
                  int tempX2 = 0;
                  int tempY2 = 0;
                  this.CheckXayDungQ(ref tempX2, ref tempY2);
                  break;
                }
                Thread.Sleep(500);
                if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds >= 2000L)
                {
                  ++this.Myself.actionCounter;
                  break;
                }
              }
            }
          }
          if (this.Myself.XayDungDichChuyen)
          {
            this.ResetEventString();
            bool flag15 = false;
            bool flag16 = false;
            long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
            while (!flag15 && !flag16 && this.Myself.IsXayDung && this.IsAIEnabled && this.Myself.IsXayDung && !GA.IsBangMapID(this.Myself.MapID))
            {
              if (this.Myself.XayDungCongTruong && !GA.IsBangMapID(this.Myself.MapID))
              {
                this.Myself.XayDungVaoCongTruong = true;
                this.DanhQuaiPhuBan(this.Myself.MapID);
              }
              if (this.Myself.HorseType != -1)
                this.CallMounting();
              this.FuncAnHPMP();
              this.FuncHuyItem();
              this.CleanUpInventory();
              this.FuncPetSupport();
              this.FuncNgaMySupport();
              this.PhucHoiSkillNM();
              if (this.MyPet.ActivePetID == 0)
                this.CallPetSure(this.MyPet.AlwaysActivePetName);
              if (!flag15)
                this.AttackQuai();
              if (this.MyQuai.TargetID != -1)
                this.Myself.LastNullTargetStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
              NewBoc newBoc = (NewBoc) null;
              if (this.MyBoc.AllBocs.Count > 0)
              {
                try
                {
                  for (int index = this.MyBoc.AllBocs.Count - 1; index >= 0; --index)
                  {
                    NewBoc allBoc = this.MyBoc.AllBocs[index];
                    if (allBoc.BocType == 5000 && allBoc.BocID != 0)
                    {
                      newBoc = allBoc;
                      break;
                    }
                  }
                }
                catch (Exception ex)
                {
                }
              }
              if (newBoc != null)
              {
                this.NhatBoc();
                Thread.Sleep(1000);
              }
              if (this.Myself.flagXayDungFinished || this.Myself.EventString == "XDXQ" || this.Myself.EventString == "XDTT")
              {
                this.Myself.OldQuestInfo = "";
                this.Myself.XayDungDanhQuai = false;
                this.Myself.XayDungDichChuyen = false;
                flag15 = true;
              }
              if (this.Myself.MapID <= 2 || this.isInDiaPhu())
              {
                this.Myself.XayDungNhanQ = false;
                break;
              }
              if (this.Myself.MapID == this.Myself.NhiemVuMapID || this.Myself.NhiemVuMapID == -1 || this.Myself.XayDungCongTruong)
              {
                if (this.Myself.EventString == "XDCTF")
                {
                  this.Myself.XayDungFinished = true;
                  this.ResetEventString();
                  break;
                }
                if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds < 300000L)
                {
                  Thread.Sleep(500);
                  this.ResetJustWarped();
                }
                else
                  break;
              }
              else
                break;
            }
            if (flag15)
            {
              this.Myself.OldQuestInfo = this.Myself.QuestInfo;
              this.Myself.XayDungCheckQ = false;
              int tempX3 = 0;
              int tempY3 = 0;
              if (!this.Myself.XayDungCongTruong)
                this.CheckXayDungQ(ref tempX3, ref tempY3);
              else
                this.Myself.XayDungFinished = true;
              if ((!GA.IsInPhuBan(this.Myself.MapID, this) || this.Myself.MapID == 39) && !GA.IsBangMapID(this.Myself.MapID))
                this.CallPhuOrGoHome();
            }
          }
        }
      }
      if (!this.Myself.XayDungFinished)
        return;
      if (!flag2)
      {
        if (this.Myself.MapID <= 2)
        {
          bool flag17 = false;
          if (this.Settings.cboxXDHoiMau)
            flag17 = this.ForceHoiMau();
          if (!this.Settings.cboxXDHoiMau || this.Settings.cboxXDHoiMau && flag17)
            this.GoToMyBang();
        }
        else if (!GA.IsInPhuBan(this.Myself.MapID, this) || this.Myself.MapID == 39)
          this.CallPhuOrGoHome();
      }
      if (!flag2)
        return;
      tempX1 = 99;
      tempY1 = 54;
      if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) tempX1, (double) tempY1) > 3.0)
      {
        this.CallInMapMove(tempX1, tempY1);
      }
      else
      {
        if (!this.Myself.XayDungFinished)
          return;
        this.ResetPacketMsg();
        this.ResetEventString();
        this.Myself.actionFlag = 0;
        bool flag18 = false;
        bool flag19 = false;
        long elapsedMilliseconds6 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        long elapsedMilliseconds7 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        while (!flag18 && !flag19 && this.Myself.IsXayDung)
        {
          if (this.Myself.isQuestFrameShow == 0 && this.Myself.actionFlag == 0)
          {
            this.CallTalkNPCByPos(0, 0, tempX1, tempY1);
            Thread.Sleep(500);
            this.CallTalkNPCByPos(600036, -1, tempX1, tempY1);
            Thread.Sleep(200);
            this.CallTalkNPCByPos(600037, -1, tempX1, tempY1, false);
            Thread.Sleep(200);
            this.CallTalkNPCByPos(600039, -1, tempX1, tempY1, false);
            Thread.Sleep(200);
            this.CallTalkNPCByPos(600038, -1, tempX1, tempY1, false);
          }
          Thread.Sleep(500);
          if (this.Myself.isQuestFrameShow == 1)
          {
            this.CallTraNhiemVu();
            Thread.Sleep(500);
            this.CallTraNhiemVu();
            Thread.Sleep(500);
            this.Myself.actionFlag = 1;
          }
          if (this.Myself.actionCounter >= 2)
          {
            flag18 = true;
            this.Myself.actionFlag = 0;
          }
          if (this.Myself.EventString == "XDXQ" || flag18)
          {
            this.Myself.XayDungFinished = false;
            this.Myself.XayDungNhanQ = false;
            this.Myself.XayDungInMap = false;
            this.Myself.XayDungDichChuyen = false;
            this.Myself.XayDungCheckQ = false;
            this.Myself.XayDungDanhQuai = false;
            this.Myself.OldQuestInfo = "";
            this.Myself.XayDungCongTruong = false;
            this.Myself.XayDungVaoCongTruong = false;
            this.Myself.actionCounter = 0;
            this.ResetPacketMsg();
            this.ResetEventString();
            this.CallResetNhiemVuData();
            ++this.Myself.xaydungCounter;
            GA.WriteUserLog(frmMain.langQXDRounds, this, (object) this.Myself.xaydungCounter);
          }
          if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds6 >= 3000L)
          {
            ++this.Myself.actionCounter;
            break;
          }
        }
      }
    }
  }

  public void NhiemVuTBB()
  {
    bool flag1 = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    if (!flag1 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.TBBStamp < 50L)
      return;
    this.Myself.TBBStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    if (this.Myself.IsMinimized)
      GA.ShowBalloon(frmMain.langPhiThuyMsg1, frmMain.langPhiThuyMsg2, this, 600000);
    bool flag2 = GA.IsBangMapID(this.Myself.MapID);
    if (!flag2 && !this.Myself.TBBNhanQ)
      this.GoToMyBang();
    else if (flag2 && !this.Myself.TBBNhanQ && !this.Myself.TBBNhanQ)
    {
      if (this.Myself.QLKF1 == 3106 || this.Myself.QLKF2 == 3107)
        this.Myself.TBBNhanQ = true;
      if (!this.Myself.TBBNhanQ)
      {
        int num1 = 100;
        int num2 = 79;
        if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num1, (double) num2) > 3.0)
        {
          this.CallInMapMove(num1, num2);
        }
        else
        {
          this.CallXuongNgua();
          Thread.Sleep(1000);
          bool flag3 = false;
          long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          while (!flag3 && this.Myself.IsTBB)
          {
            if (this.Myself.QLKF1 == 3106 || this.Myself.QLKF2 == 3107)
            {
              flag3 = true;
              this.Myself.TBBNhanQ = true;
            }
            if (this.Myself.isQuestFrameShow == 0 && this.Myself.actionFlag == 0)
              this.CallTalkNPCByPos(890841, 1, num1, num2);
            if (this.Myself.isQuestFrameShow == 1)
            {
              this.CallTalkNPCByPos(890841, 11, num1, num2, false);
              this.Myself.actionFlag = 1;
              this.CallTalkNPCByPos(890841, 2, num1, num2, false);
            }
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 >= 3000L)
            {
              this.Myself.actionFlag = 0;
              elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
            }
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 < 10000L)
              Thread.Sleep(200);
            else
              break;
          }
        }
      }
    }
    if (!flag2 || !this.Myself.TBBNhanQ)
      return;
    if (!this.Myself.TBBF1Played)
    {
      this.Myself.actionFlag = 0;
      this.ResetPacketMsg();
      int num3;
      int num4;
      if (this.Settings.cboTuBaoBon == 0)
      {
        num3 = 100;
        num4 = 146;
      }
      else if (this.Settings.cboTuBaoBon == 1)
      {
        num3 = 52;
        num4 = 89;
      }
      else
      {
        num3 = 146;
        num4 = 91;
      }
      double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num3, (double) num4);
      if (distance > 3.0)
      {
        if (this.Myself.actionCounter <= 1)
        {
          this.CallMoveFlashPos(num3, num4);
          ++this.Myself.actionCounter;
        }
        else if (distance < 7.0)
          this.CallMoveFlashPos(num3, num4);
        else
          this.CallInMapMove(num3, num4);
      }
      else
      {
        this.Myself.actionCounter = 0;
        if (this.Myself.QLKF1 != 3106)
          this.Myself.TBBF1Played = true;
        this.CallAttackTargetPacket(this.Myself.ID, 3106, -1, 0, 0);
        bool flag4 = false;
        long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
        while (!flag4 && this.Myself.IsTBB)
        {
          if (this.Myself.ActionStatus == (byte) 6 || this.Myself.ActionStatus == (byte) 5)
            this.Myself.actionFlag = 1;
          if (this.Myself.PacketMsg == "CDVB" || this.Myself.PacketMsg == "PTTC" || this.Myself.PacketMsg == "BBKT")
          {
            this.Myself.TBBF1Played = true;
            break;
          }
          if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num3, (double) num4) > 3.0 && !this.Myself.TBBF1Played && this.Myself.ActionStatus != (byte) 5)
            this.CallMoveFlashPos(num3, num4);
          if (this.Myself.actionFlag == 0 || this.Myself.ActionStatus != (byte) 6 || this.Myself.ActionStatus != (byte) 5)
          {
            if (this.Myself.PacketMsg == "CDVB" || this.Myself.PacketMsg == "PTTC")
            {
              this.Myself.TBBF1Played = true;
              break;
            }
            this.CallAttackTargetPacket(this.Myself.ID, 3106, -1, 0, 0);
          }
          Thread.Sleep(200);
        }
      }
    }
    if (this.Myself.TBBF1Played && !this.Myself.TBBF2Played)
    {
      this.Myself.actionFlag = 0;
      this.ResetPacketMsg();
      int num5 = 100;
      int num6 = 80 /*0x50*/;
      if (this.Myself.QLKF1 != 3106)
        this.Myself.TBBF2Played = true;
      double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num5, (double) num6);
      if (distance > 3.0)
      {
        if (this.Myself.actionCounter <= 1)
        {
          this.CallMoveFlashPos(num5, num6);
          ++this.Myself.actionCounter;
        }
        else if (distance < 7.0)
          this.CallMoveFlashPos(num5, num6);
        else
          this.CallInMapMove(num5, num6);
      }
      else
      {
        this.Myself.actionCounter = 0;
        int delay1 = 99999;
        int delay2 = 99999;
        this.GetRunDelay(out delay1, out delay2);
        this.CallAttackTargetPacket(this.Myself.ID, 3107, -1, 0, 0);
        bool flag5 = false;
        bool flag6 = false;
        long elapsedMilliseconds3 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        while (!flag6 && this.Myself.IsTBB)
        {
          if (this.Myself.ActionStatus == (byte) 6 || this.Myself.ActionStatus == (byte) 5)
            this.Myself.actionFlag = 1;
          if (this.Myself.PacketMsg == "CNPT" || this.Myself.PacketMsg == "DPTX" || this.Myself.PacketMsg == "BBKT")
            flag5 = true;
          if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num5, (double) num6) > 3.0 && !flag5 && this.Myself.ActionStatus != (byte) 5)
            this.CallMoveFlashPos(num5, num6);
          if (this.Myself.actionFlag == 0 || this.Myself.ActionStatus != (byte) 6 || this.Myself.ActionStatus != (byte) 5)
          {
            if (this.Myself.PacketMsg == "DPTX" || this.Myself.PacketMsg == "CNPT")
              flag5 = true;
            else
              this.CallAttackTargetPacket(this.Myself.ID, 3107, -1, 0, 0);
          }
          if (flag5)
          {
            if (this.Settings.cboxTBBchaynhanh && delay1 < 3000 && this.Myself.MPPercent > 3.0 && (this.Myself.Menpai == AllEnums.Menpais.CAIBANG || this.Myself.Menpai == AllEnums.Menpais.MODUNG || this.Myself.Menpai == AllEnums.Menpais.THIENLONG || this.Myself.Menpai == AllEnums.Menpais.THIENSON || this.Myself.Menpai == AllEnums.Menpais.THIEULAM))
            {
              while (this.Myself.IsTBB)
              {
                this.CallAttackTarget(-1, 3109, 0, 0);
                if (this.Myself.QLKF1 == 3106)
                  Thread.Sleep(200);
                else
                  break;
              }
              bool flag7 = false;
              long elapsedMilliseconds4 = frmLogin.GlobalTimer.ElapsedMilliseconds;
              long elapsedMilliseconds5 = frmLogin.GlobalTimer.ElapsedMilliseconds;
              while (!flag7 && this.Myself.IsTBB)
              {
                while (delay1 < 2000 && this.Myself.IsTBB)
                {
                  if (this.Myself.QLKF1 == 3106 || this.Myself.QLKF2 == 3107)
                    this.CallAttackTarget(-1, 3109, 0, 0);
                  else
                    this.CallAttackTargetPacket(this.Myself.ID, this.Myself.MenpaiRunSkill, 0, 0, 0);
                  this.GetRunDelay(out delay1, out delay2);
                  Thread.Sleep(150);
                  if (delay1 > 2000)
                    break;
                }
                Thread.Sleep(200);
                this.GetRunDelay(out delay1, out delay2);
                if (delay1 > 2000)
                  this.CallTalkNPCByPos(890841, 2, num5, num6);
                if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds4 >= 3000L)
                {
                  this.CallTalkNPCByPos(890841, 2, num5, num6);
                  elapsedMilliseconds4 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                }
                if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds5 < 30000L)
                {
                  this.GetRunDelay(out delay1, out delay2);
                  if ((this.Myself.QLKF1 == 3106 || this.Myself.QLKF2 == 3107) && delay1 > 2000)
                  {
                    this.Myself.TBBNhanQ = true;
                    break;
                  }
                }
                else
                  break;
              }
            }
            this.Myself.TBBF2Played = true;
            break;
          }
          Thread.Sleep(200);
        }
      }
    }
    if (this.Myself.TBBF1Played && this.Myself.TBBF2Played && (this.Myself.QLKF1 == 3106 || this.Myself.QLKF2 == 3107))
    {
      ++this.Myself.TBBCounter;
      this.Myself.TBBF1Played = false;
      this.Myself.TBBF2Played = false;
    }
    if (this.Myself.QLKF1 == 3106 || this.Myself.TBBNhanPhiThuy || !this.Myself.TBBNhanQ || this.Myself.TBBCounter <= 2 || !this.Myself.NhiemVuFinish || !this.Settings.cboxTBBPhiThuy)
      return;
    int num7 = 100;
    int num8 = 79;
    double distance1 = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num7, (double) num8);
    if (distance1 > 3.0)
      this.CallMoveFlashPos(num7, num8);
    if (distance1 > 3.0)
      return;
    long elapsedMilliseconds6 = frmLogin.GlobalTimer.ElapsedMilliseconds;
    long elapsedMilliseconds7 = frmLogin.GlobalTimer.ElapsedMilliseconds;
    while (this.Myself.IsTBB)
    {
      if (this.Myself.isQuestFrameShow == 0 && this.Myself.actionFlag == 0)
        this.CallTalkNPCByPos(890841, 3, num7, num8);
      Thread.Sleep(700);
      if (this.Myself.isQuestFrameShow == 1)
        this.CallTalkNPCByPos(890841, 31 /*0x1F*/, num7, num8, false);
      if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds6 >= 3000L)
      {
        this.CallTalkNPCByPos(890841, 3, num7, num8);
        elapsedMilliseconds6 = frmLogin.GlobalTimer.ElapsedMilliseconds;
      }
      if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds7 >= 20000L)
        break;
      if (this.Myself.PacketMsg == "NPTR")
      {
        GA.WriteUserLog(frmMain.langTBBPhiThuyCount, this, (object) this.Myself.TBBCounter);
        this.Myself.TBBNhanPhiThuy = true;
        break;
      }
      if (this.Myself.PacketMsg == "CKTBB")
        break;
    }
  }

  public void NhiemVuTuDuongCon()
  {
    int NPCID1 = 216;
    int posX = 151;
    int posY = 187;
    int menuTypeID1 = 890511;
    int menuIndex1 = 100;
    int menuTypeID2 = 890511;
    int num1 = 0;
    int NPCID2 = 0;
    int num2 = 0;
    int num3 = 0;
    int menuIndex2 = 0;
    List<int> intList = new List<int>()
    {
      111,
      222,
      333,
      444
    };
    bool flag1 = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    if (!flag1 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LuyenKimStamp < 300L)
      return;
    this.Myself.LuyenKimStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    switch (this.Settings.cboTuDuongCon)
    {
      case 1:
        num1 = 890511;
        NPCID2 = 1;
        num2 = 220;
        num3 = 236;
        menuIndex2 = 101;
        break;
      case 2:
        num1 = 890512;
        num2 = 0;
        num3 = 0;
        break;
      case 3:
        num1 = 890513;
        NPCID2 = 0;
        num2 = 0;
        num3 = 0;
        menuIndex2 = 103;
        break;
      case 4:
        num1 = 890514;
        NPCID2 = 89;
        num2 = 162;
        num3 = 266;
        menuIndex2 = 102;
        break;
      case 5:
        num1 = 890515;
        num2 = 176 /*0xB0*/;
        num3 = 150;
        break;
    }
    if (this.Myself.QuestStep == 0 && this.GoToMyPos(posX, posY, 0))
    {
      if (this.Myself.Status == AllEnums.CharStatuses.GOGOGO)
        this.Myself.Status = AllEnums.CharStatuses.IDLE;
      ++this.Myself.QuestStep;
    }
    if (this.Myself.QuestStep == 1)
    {
      this.ResetEventString();
      this.ResetPacketMsg();
      if (this.Settings.cboTuDuongCon == 2)
        this.CallResetNhiemVuData();
      this.Myself.actionFlag = 0;
      bool flag2 = false;
      long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
      long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
      while (this.Myself.IsTuDuongCon)
      {
        if (this.Myself.actionFlag == 0)
        {
          this.CallTalkNPC(0, 0, NPCID1);
          Thread.Sleep(500);
          this.CallTalkNPC(menuTypeID1, menuIndex1, NPCID1);
        }
        Thread.Sleep(500);
        if (this.Myself.isQuestFrameShow == 1)
        {
          this.CallTalkNPC(menuTypeID2, num1, NPCID1);
          this.Myself.actionFlag = 1;
          Thread.Sleep(500);
        }
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 >= 4000L)
        {
          this.Myself.actionFlag = 0;
          elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        }
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 >= 10000L)
          flag2 = true;
        if (this.Myself.EventString == "QCMR")
        {
          long elapsedMilliseconds3 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          long elapsedMilliseconds4 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          if (this.Settings.cboTuDuongCon < 5)
          {
            ++this.Settings.cboTuDuongCon;
            break;
          }
          this.Settings.cboTuDuongCon = 1;
          break;
        }
        if (this.Settings.cboTuDuongCon == 2)
        {
          if (this.Myself.NhiemVuPosX > 0 || flag2)
          {
            ++this.Myself.QuestStep;
            this.Myself.actionFlag = 0;
            break;
          }
        }
        else if (this.Myself.EventString == "QCNNV" || flag2)
        {
          ++this.Myself.QuestStep;
          this.Myself.actionFlag = 0;
          break;
        }
      }
    }
    if (this.Myself.QuestStep == 2)
    {
      if (this.Settings.cboTuDuongCon == 2)
      {
        if (this.GoToMyPos(this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY, this.Myself.NhiemVuMapID))
          ++this.Myself.QuestStep;
      }
      else if (this.Settings.cboTuDuongCon == 3)
      {
        if (this.Myself.PacketMsg == "QCTTN")
        {
          NPCID2 = 217;
          num2 = 118;
          num3 = 138;
        }
        else if (this.Myself.PacketMsg == "QCTTM")
        {
          NPCID2 = 218;
          num2 = 118;
          num3 = 132;
        }
        else if (this.Myself.PacketMsg == "QCLTK")
        {
          NPCID2 = 219;
          num2 = (int) sbyte.MaxValue;
          num3 = 132;
        }
        if (num2 > 0 && num3 > 0 && NPCID2 >= 0)
        {
          if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num2, (double) num3) > 3.0)
            this.CallInMapMove(num2, num3);
          else
            ++this.Myself.QuestStep;
        }
      }
      else if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num2, (double) num3) > 3.0)
        this.CallInMapMove(num2, num3);
      else
        ++this.Myself.QuestStep;
    }
    if (this.Myself.QuestStep == 3)
    {
      if (this.Settings.cboTuDuongCon == 1 || this.Settings.cboTuDuongCon == 4)
      {
        this.ResetEventString();
        long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
        int index = 0;
        while (this.Myself.IsTuDuongCon)
        {
          if (this.Myself.isQuestFrameShow == 0 && this.Myself.actionFlag == 0)
          {
            this.CallTalkNPC(0, 0, NPCID2);
            Thread.Sleep(500);
            this.CallTalkNPC(num1, menuIndex2, NPCID2);
            Thread.Sleep(500);
          }
          if (this.Myself.isQuestFrameShow == 1)
          {
            this.CallTalkNPC(num1, intList[index], NPCID2);
            this.Myself.actionFlag = 1;
          }
          Thread.Sleep(1000);
          if (this.Myself.EventString == "QCTLS")
          {
            if (index < 3)
              ++index;
            else
              index = 0;
          }
          if (this.Myself.EventString == "QCTLD")
            index = 0;
          if (this.Myself.EventString == "QCXNV")
          {
            ++this.Myself.QuestStep;
            this.Myself.actionFlag = 0;
            break;
          }
          if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds >= 20000L)
          {
            ++this.Myself.QuestStep;
            this.Myself.actionFlag = 0;
            break;
          }
        }
      }
      else
      {
        if (this.Settings.cboTuDuongCon == 2)
        {
          this.CallXuongNgua();
          this.ResetEventString();
          long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
label_74:
          for (int index = 60; index < 90; ++index)
          {
            if (this.MyInventory.AllItems[index].ItemID == 40004789)
            {
              bool flag3 = true;
              int itemIndex = index;
              while (this.Myself.IsTuDuongCon)
              {
                if (flag3 && this.Myself.ActionStatus != (byte) 6 && this.Myself.ActionStatus != (byte) 5)
                {
                  this.CallUseItem(itemIndex, this.Myself.ID);
                  Thread.Sleep(1000);
                }
                Thread.Sleep(500);
                if (this.Myself.EventString == "QCXNV")
                {
                  ++this.Myself.QuestStep;
                  this.Myself.actionFlag = 0;
                  break;
                }
                if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds >= 30000L)
                {
                  ++this.Myself.QuestStep;
                  this.Myself.actionFlag = 0;
                  break;
                }
              }
              goto label_130;
            }
          }
          goto label_74;
        }
        if (this.Settings.cboTuDuongCon == 3)
        {
          this.CallXuongNgua();
          this.ResetEventString();
          long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
          int skillID = this.Myself.QLKF1;
          while (this.Myself.IsTuDuongCon)
          {
            if (this.Myself.isQuestFrameShow == 0 && this.Myself.actionFlag == 0)
            {
              this.CallTalkNPC(0, 0, NPCID2);
              Thread.Sleep(500);
              this.CallTalkNPC(num1, menuIndex2, NPCID2);
              Thread.Sleep(500);
            }
            if (this.Myself.QLKF1 >= 2940 && this.Myself.QLKF1 <= 3000)
            {
              if (skillID <= 0)
                skillID = this.Myself.QLKF1;
              this.CallAttackTargetPacket(this.Myself.ID, skillID, -1, 0, 0);
              this.Myself.actionFlag = 1;
            }
            Thread.Sleep(3000);
            if (this.Myself.EventString == "QCTLS")
            {
              if (skillID == this.Myself.QLKF1)
                skillID = this.Myself.QLKF2;
              else if (skillID == this.Myself.QLKF2)
                skillID = this.Myself.QLKF3;
              else if (skillID == this.Myself.QLKF3)
                skillID = this.Myself.QLKF4 > 0 ? this.Myself.QLKF4 : this.Myself.QLKF1;
              else if (skillID == this.Myself.QLKF4)
                skillID = this.Myself.QLKF1;
            }
            if (this.Myself.EventString == "QCXNV")
            {
              ++this.Myself.QuestStep;
              this.Myself.actionFlag = 0;
              break;
            }
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds >= 120000L)
            {
              ++this.Myself.QuestStep;
              this.Myself.actionFlag = 0;
              break;
            }
          }
        }
        else if (this.Settings.cboTuDuongCon == 5)
        {
          this.CallXuongNgua();
          this.ResetEventString();
          long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
          bool flag4 = false;
          int itemIndex = 0;
          for (int index = 60; index < 90; ++index)
          {
            if (this.MyInventory.AllItems[index].ItemID == 40004791)
            {
              flag4 = true;
              itemIndex = index;
              break;
            }
          }
          int targetID = 220;
          while (this.Myself.IsTuDuongCon)
          {
            this.CallSelectTarget(targetID);
            Thread.Sleep(200);
            if (flag4)
            {
              this.CallUseItem(itemIndex, targetID);
              Thread.Sleep(4000);
            }
            if (this.Myself.EventString == "QCTLS")
            {
              if (targetID < 222)
                ++targetID;
              else
                targetID = 220;
            }
            if (this.Myself.EventString == "QCTLD")
              targetID = 220;
            if (this.Myself.EventString == "QCXNV")
            {
              ++this.Myself.QuestStep;
              this.Myself.actionFlag = 0;
              break;
            }
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds >= 300000L)
            {
              ++this.Myself.QuestStep;
              this.Myself.actionFlag = 0;
              break;
            }
          }
        }
      }
    }
label_130:
    if (this.Myself.QuestStep == 4 && this.GoToMyPos(posX, posY, 0))
      ++this.Myself.QuestStep;
    if (this.Myself.QuestStep != 5)
      return;
    this.ResetEventString();
    bool flag5 = false;
    long elapsedMilliseconds5 = frmLogin.GlobalTimer.ElapsedMilliseconds;
    long elapsedMilliseconds6 = frmLogin.GlobalTimer.ElapsedMilliseconds;
    while (this.Myself.IsTuDuongCon)
    {
      if (this.Myself.isQuestFrameShow == 0 && this.Myself.actionFlag == 0)
      {
        this.CallTalkNPC(0, 0, NPCID1);
        Thread.Sleep(500);
        this.CallTalkNPC(menuTypeID1, menuIndex1, NPCID1);
      }
      Thread.Sleep(500);
      if (this.Myself.isQuestFrameShow == 1)
      {
        this.CallTalkNPC(menuTypeID2, num1, NPCID1);
        this.Myself.actionFlag = 1;
        Thread.Sleep(500);
        this.CallTraNhiemVu();
      }
      if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds6 >= 4000L)
      {
        this.Myself.actionFlag = 0;
        elapsedMilliseconds6 = frmLogin.GlobalTimer.ElapsedMilliseconds;
      }
      if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds5 >= 12000L)
        flag5 = true;
      if (this.Myself.EventString == "QCTNV" || flag5)
      {
        this.Myself.QuestStep = 0;
        this.Myself.actionFlag = 0;
        ++this.Myself.tuduongconCounter;
        GA.WriteUserLog(frmMain.langCompleteXTDCQ, this, (object) this.Myself.tuduongconCounter);
        break;
      }
    }
  }

  public void NhiemVuDaoBTD()
  {
    bool flag1 = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    if (!flag1 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LuyenKimStamp < 1000L)
      return;
    this.Myself.LuyenKimStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    if (this.isInDiaPhu())
    {
      this.CallMoveTo(12, 24);
    }
    else
    {
      if (this.Myself.QuestStep == 0)
      {
        bool flag2 = false;
        bool flag3 = false;
        int num1 = -1;
        int nvPosX = 0;
        int nvPosY = 0;
        int nvMapID = 0;
        int num2 = 20;
        for (int index = 0; index < 30; ++index)
        {
          InventoryItem allItem = this.MyInventory.AllItems[index];
          if (allItem.ItemID == 30000000)
          {
            if (allItem.BTDMapID == 0)
            {
              this.CallUseItem(index, this.Myself.ID);
              flag3 = true;
            }
            else
            {
              flag2 = true;
              if (allItem.BTDMapID == this.Myself.MapID)
              {
                this.CallSetUpNhiemVuData(allItem.BTDposX, allItem.BTDposY, allItem.BTDMapID);
                num2 = 1;
                this.Myself.NhiemVuItemIndex = index;
              }
              else
              {
                List<AdvancedPath> bestPath = this.CalculateBestPath(this.Myself.MapID, allItem.BTDMapID, true);
                if (bestPath != null && bestPath.Count < num2)
                {
                  num2 = bestPath.Count;
                  num1 = index;
                  nvPosX = allItem.BTDposX;
                  nvPosY = allItem.BTDposY;
                  nvMapID = allItem.BTDMapID;
                }
              }
            }
          }
        }
        if (flag2 & !flag3)
        {
          if (this.Myself.NhiemVuItemIndex < 0 && num1 >= 0)
          {
            this.CallSetUpNhiemVuData(nvPosX, nvPosY, nvMapID);
            this.Myself.NhiemVuItemIndex = num1;
          }
          if ((num2 <= 3 || this.IsInCity()) && this.Myself.NhiemVuItemIndex >= 0)
            ++this.Myself.QuestStep;
          else
            this.CallPhuOrGoHome();
        }
        if (!flag2 & !flag3)
        {
          if (!this.IsInCity())
          {
            this.CallPhuOrGoHome();
          }
          else
          {
            this.Myself.isDaoBTD = false;
            this.IsAIEnabled = false;
            GA.WriteUserLog(frmMain.langOutofTreasureMap, this);
          }
        }
      }
      if (this.Myself.QuestStep == 1)
      {
        if (this.IsInCity())
        {
          if (this.ForceHoiMau())
            ++this.Myself.QuestStep;
        }
        else
          ++this.Myself.QuestStep;
      }
      if (this.Myself.QuestStep == 2 && (!this.Settings.cboxBTDXaPhu || this.DiXaPhu(this.Myself.NhiemVuMapID)) && this.GoToMyPos(this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY, this.Myself.NhiemVuMapID))
        ++this.Myself.QuestStep;
      if (this.Myself.QuestStep == 3)
      {
        int num3 = 1;
        int index1 = -1;
        if (this.Myself.actionFlag == 0)
        {
          for (int index2 = 0; index2 < 30; ++index2)
          {
            InventoryItem allItem = this.MyInventory.AllItems[index2];
            if (allItem.ItemCount > (byte) 1 && (int) allItem.ItemCount > num3 && allItem.ItemCount <= (byte) 250)
            {
              num3 = (int) allItem.ItemCount;
              index1 = index2;
              if ((allItem.ItemName.ToLower().Contains("đạo cụ trân thú") || allItem.ItemName.ToLower().Contains("dược phẩm") || allItem.ItemName.ToLower().Contains("thực phẩm")) && allItem.ItemCount >= (byte) 20 || num3 >= 20)
                break;
            }
          }
          if (index1 < 0)
          {
            GA.WriteUserLog(frmMain.langNotFoundChiaNho2, this);
            this.Myself.isDaoBTD = false;
            this.IsAIEnabled = false;
            return;
          }
          for (int index3 = 0; index3 < num3; ++index3)
          {
            this.CallSplitItemPacket(index1, 1);
            Thread.Sleep(100);
            if (this.Myself.EventString == "PCTB")
            {
              GA.WriteUserLog(frmMain.langNotFoundChiaNho, this);
              this.Myself.isDaoBTD = false;
              this.IsAIEnabled = false;
              break;
            }
            if (this.Myself.EventString == "KTPC")
            {
              this.Myself.actionFlag = 1;
              this.ResetEventString();
              break;
            }
          }
        }
        if (this.Myself.actionFlag == 1)
        {
          int num4 = 1;
          int index4 = -1;
          for (int index5 = 30; index5 < 60; ++index5)
          {
            InventoryItem allItem = this.MyInventory.AllItems[index5];
            if (allItem.ItemCount > (byte) 1 && (int) allItem.ItemCount > num4)
            {
              num4 = (int) allItem.ItemCount;
              index4 = index5;
              if (allItem.ItemID == 20502009 && allItem.ItemCount >= (byte) 20 || num4 >= 20)
                break;
            }
          }
          if (index4 < 0)
          {
            GA.WriteUserLog(frmMain.langNotFoundChiaNho4, this);
            this.Myself.isDaoBTD = false;
            this.IsAIEnabled = false;
            return;
          }
          for (int index6 = 0; index6 < num4; ++index6)
          {
            this.CallSplitItemPacket(index4, 1);
            Thread.Sleep(100);
            if (this.Myself.EventString == "PCTB")
            {
              GA.WriteUserLog(frmMain.langNotFoundChiaNho3, this);
              this.Myself.isDaoBTD = false;
              this.IsAIEnabled = false;
              break;
            }
            if (this.Myself.EventString == "KTPC")
            {
              this.Myself.actionFlag = 2;
              this.ResetEventString();
              break;
            }
          }
        }
        if (this.Myself.actionFlag == 2)
        {
          if (this.Myself.SlotDC == 0 || this.Myself.SlotNL == 0)
          {
            for (int index7 = 59; index7 >= 0; --index7)
            {
              if (this.MyInventory.AllItems[index7].ItemID > 0)
              {
                if (index7 < 30)
                {
                  this.Myself.SlotDC = index7;
                  this.Myself.actionFlag = 3;
                  break;
                }
                this.Myself.SlotNL = index7;
                index7 = 30;
              }
            }
          }
          else
            this.Myself.actionFlag = 3;
        }
        if (this.Myself.actionFlag == 3)
        {
          if (this.Myself.SlotNL >= 49 && this.Myself.SlotDC >= 19)
          {
            this.Myself.actionFlag = 0;
            ++this.Myself.QuestStep;
          }
          else
          {
            this.Myself.SlotDC = 0;
            this.Myself.SlotNL = 0;
            this.Myself.actionFlag = 0;
          }
        }
      }
      if (this.Myself.QuestStep == 4)
      {
        if (this.Myself.NhiemVuType <= 1)
          this.CallUseItem(this.Myself.NhiemVuItemIndex, this.Myself.ID);
        else if (this.Myself.NhiemVuType >= 7)
        {
          bool flag4 = this.JoinMyItem(needslot: 9);
          bool flag5 = this.JoinMyItem(1, 5);
          if (this.Myself.actionCounter <= 4)
          {
            flag4 = this.JoinMyItem(needslot: 9 - this.Myself.actionCounter);
            flag5 = this.JoinMyItem(1, 5 - this.Myself.actionCounter);
          }
          else
          {
            GA.ShowBalloon(frmMain.langInventoryFull2, frmMain.langInventoryNotEnoughSpace, this);
            GA.WriteUserLog(frmMain.langInventoryFull3, this);
            this.Myself.actionCounter = 0;
            ++this.Myself.actionFlag;
          }
          ++this.Myself.actionCounter;
          if (flag4 && flag5 || this.Myself.actionFlag >= 3)
          {
            this.Myself.actionCounter = 0;
            this.Myself.actionFlag = 0;
            ++this.Myself.QuestStep;
          }
        }
        else
          this.Myself.QuestStep = 6;
      }
      if (this.Myself.QuestStep == 5 && this.Myself.NhiemVuType == 7)
      {
        if (this.MyQuai.AllQuai.Count > 0)
        {
          QuaiIndividual quaiIndividual = (QuaiIndividual) null;
          try
          {
            double num = 50.0;
            for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
            {
              QuaiIndividual quai = this.MyQuai.AllQuai[index];
              bool flag6 = true;
              if (this.HasActivePet())
              {
                if (quai.ID != this.MyPet.AllPets[this.MyPet.ActivePetIndex].ID)
                  flag6 = false;
              }
              else
                flag6 = false;
              if (quai.ID >= 0 && (double) quai.HPPercent > 0.0 && quai.ID != this.Myself.ID && !flag6 && this.CanAttack(quai))
              {
                double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quai.PosX, (double) quai.PosY);
                if (distance < num)
                  num = distance;
                if (quai.IsBossValue >= 3520 && quai.IsBossValue <= 3529 || quai.IsBossValue >= 31870 && quai.IsBossValue <= 31879 || quai.IsBossValue >= 1870 && quai.IsBossValue <= 1879 || quai.IsBossValue >= 33520 && quai.IsBossValue <= 33529 || quai.Name.Contains("hủ Kho "))
                {
                  this.Myself.actionFlag = 1;
                  quaiIndividual = quai;
                  break;
                }
              }
            }
          }
          catch (Exception ex)
          {
            GA.WriteUserLog(frmMain.langErrorTreasureMapQuai, this);
          }
          if (quaiIndividual != null)
          {
            if (quaiIndividual.ID >= 0)
            {
              if (this.Myself.actionFlag < 1)
                this.Myself.NhiemVuQuaiID = quaiIndividual.ID;
              this.CallXuongNgua();
              this.CallSelectTarget(quaiIndividual.ID);
              this.CallAttackTarget(quaiIndividual.ID, this.MySkills.AllSkills[0].ID, 0, 0);
              if (this.Settings.SkillPlayList.Count > 0)
              {
                try
                {
                  for (int index = 0; index < this.Settings.SkillPlayList.Count; ++index)
                  {
                    SkillPlayItem skillPlay = this.Settings.SkillPlayList[index];
                    if (skillPlay.IsEnabled && this.Myself.CurrentTarget != null)
                    {
                      if (this.PlayMySkill(skillPlay, this.Myself.CurrentTarget.ID))
                        break;
                    }
                  }
                }
                catch (Exception ex)
                {
                  GA.WriteUserLog(frmMain.langCannotSkill + ex.Message, this);
                }
              }
              if (quaiIndividual.ID == this.Myself.NhiemVuQuaiID && (double) quaiIndividual.HPPercent <= 0.0)
              {
                this.Myself.actionFlag = 2;
                Thread.Sleep(2000);
              }
            }
          }
          else if (this.Myself.actionFlag == 1)
          {
            this.Myself.actionFlag = 2;
            Thread.Sleep(2000);
          }
        }
        else if (this.Myself.actionFlag == 1)
        {
          this.Myself.actionFlag = 2;
          Thread.Sleep(2000);
        }
        if (this.Myself.actionFlag == 2)
        {
          NewBoc newBoc = (NewBoc) null;
          if (this.MyBoc.AllBocs.Count > 0)
          {
            try
            {
              for (int index = this.MyBoc.AllBocs.Count - 1; index >= 0; --index)
              {
                NewBoc allBoc = this.MyBoc.AllBocs[index];
                if (allBoc.BocType == 5000 && allBoc.BocID != 0)
                {
                  newBoc = allBoc;
                  break;
                }
              }
            }
            catch (Exception ex)
            {
              GA.WriteUserLog(frmMain.langErrorFindingTreasurePath, this);
            }
          }
          if (newBoc != null)
          {
            this.NhatBoc();
          }
          else
          {
            this.Myself.actionFlag = 0;
            this.Myself.QuestStep = 7;
          }
        }
      }
      if (this.Myself.QuestStep == 6)
      {
        this.Myself.QuestStep = 0;
        this.CallResetNhiemVuData();
        this.Myself.actionFlag = 0;
        ++this.Myself.btdCounter;
        GA.WriteUserLog(frmMain.langCompleteXBTD, this, (object) this.Myself.btdCounter);
      }
      if (this.Myself.QuestStep != 7)
        return;
      if (GA.IsInPhuBan(this.Myself.MapID, this))
      {
        if (this.Myself.HorseType == -1)
        {
          this.CallTangHinh();
          Thread.Sleep(500);
          this.CallLenNgua();
        }
        if (this.GoToMyPos(48 /*0x30*/, 30, this.Myself.MapID))
        {
          int itemCount = 0;
          this.SearchItemIventory(ref itemCount, 20309009, "chìa khóa", 0);
          if (itemCount >= 6)
          {
            if (this.Settings.cboxTNAlert)
            {
              if (this.Myself.EventStamp == 0L)
                this.Myself.EventStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
              this.CallBringWindowUp(this.Target.MainWindowHandle);
              try
              {
                new SoundPlayer("event.wav").Play();
              }
              catch (Exception ex)
              {
              }
            }
            GA.ShowBalloon(frmMain.langHaveEnoughKey, frmMain.langHave6Keys, this, 10000);
            if (!this.Settings.cboxTNAlert || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.EventStamp > 60000L)
            {
              this.Myself.EventStamp = 0L;
              this.Myself.actionFlag = 1;
            }
          }
          else
            this.Myself.actionFlag = 1;
        }
        if (this.Myself.actionFlag == 1 && GA.IsInPhuBan(this.Myself.MapID, this))
          this.CallMoveFlashPos(53, 48 /*0x30*/);
      }
      if (GA.IsInPhuBan(this.Myself.MapID, this) || this.Myself.actionFlag != 1)
        return;
      this.Myself.QuestStep = 6;
    }
  }

  public bool JoinMyItem(int mode = 0, int needslot = 1)
  {
    int num1 = -1;
    int num2 = -1;
    int num3 = 0;
    int num4 = 0;
    int index2 = -1;
    int num5 = 0;
    bool flag = false;
    int num6 = -1;
    int num7 = -1;
    switch (mode)
    {
      case 0:
        num6 = this.Myself.SlotNL;
        num7 = this.Myself.SlotDC;
        break;
      case 1:
        num6 = this.Myself.SlotDC;
        num7 = 0;
        break;
    }
    if (this.Myself.actionFlag <= 1)
    {
      for (int index = num6; index > num7; --index)
      {
        InventoryItem allItem = this.MyInventory.AllItems[index];
        if (allItem.ItemCount == (byte) 1)
        {
          if (allItem.ItemID == num1 && allItem.ItemID != 30000000 && allItem.ItemID != 20309009 || num1 == -1)
          {
            ++num3;
            if (num3 == 3 && num2 == -1)
              num2 = allItem.ItemID;
          }
          num1 = allItem.ItemID;
        }
        if (allItem.ItemID == num2)
        {
          if (!flag)
            index2 = index;
          if (allItem.ItemCount > (byte) 1)
            flag = true;
        }
        if (allItem.ItemID == 0)
        {
          ++num4;
          if (num4 >= needslot)
            return true;
        }
      }
      if (num2 >= 0 && index2 >= 0)
      {
        for (int index = num6; index > num7; --index)
        {
          InventoryItem allItem = this.MyInventory.AllItems[index];
          if (allItem.ItemCount == (byte) 1 && allItem.ItemID == num2)
          {
            this.CallJoinItemPacket(index, index2);
            ++num5;
            if (num5 >= 5)
              break;
          }
        }
      }
    }
    return false;
  }

  public void NhiemVuBachHoaDuyen()
  {
    int NPCID1 = 174;
    int posX = 185;
    int posY = 65;
    int mapID = 2;
    int num1 = 808200;
    int menuIndex1 = 220;
    int menuIndex2 = 410;
    int menuTypeID1 = 808200;
    int menuIndex3 = 410;
    bool flag1 = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    if (!flag1 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LuyenKimStamp < 300L)
      return;
    this.Myself.LuyenKimStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    if (this.isInDiaPhu())
    {
      this.CallMoveTo(12, 24);
    }
    else
    {
      if (this.Myself.NhiemVuPosX == 0 && this.Myself.NhiemVuPosY == 0 && this.Myself.QuestStep == 0 && !this.Myself.NhiemVuFinish && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.EventStamp >= 10000L)
      {
        this.Myself.EventStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
        this.CallToggleMission();
        Thread.Sleep(500);
        this.CallToggleMission();
        Thread.Sleep(300);
      }
      if (this.Myself.QuestStep == 0)
      {
        if (this.Myself.NhiemVuPosX > 0 && this.Myself.NhiemVuPosY > 0 && !this.Myself.NhiemVuFinish)
          this.Myself.QuestStep = 2;
        else if (this.GoToMyPos(posX, posY, mapID))
        {
          Thread.Sleep(500);
          ++this.Myself.QuestStep;
        }
      }
      if (this.Myself.QuestStep == 1)
      {
        if (this.MyFlag.BHDcounter <= 1)
        {
          this.CallTalkNPC(0, 0, NPCID1);
          long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
          while (this.Myself.isQuestFrameShow == 0)
          {
            Thread.Sleep(200);
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds > 2000L)
              break;
          }
          this.CallTalkNPC(210252, 1, NPCID1);
          Thread.Sleep(1000);
          this.CallMoveTo(183, 66);
          Thread.Sleep(1000);
          this.CallTalkNPC(0, 0, 175);
          Thread.Sleep(1000);
          while (this.Myself.isQuestFrameShow == 0)
          {
            Thread.Sleep(200);
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds > 2000L)
              break;
          }
          this.CallTalkNPC(210253, 1, 175);
          Thread.Sleep(1000);
          ++this.MyFlag.BHDcounter;
        }
        this.ResetEventString();
        this.ResetPacketMsg();
        this.CallResetNhiemVuData();
        if (frmLogin.GAuto.Settings.soVongQHoa <= 0 || this.MyFlag.BHDcounter <= -2)
        {
          this.Myself.isBachHoaDuyen = false;
          this.IsAIEnabled = false;
          this.MyFlag.BHDcounter = 0;
          if (this.Settings.cboxBHDThoatKhiXong)
          {
            GA.WriteUserLog("Đã hết {0} vòng nv Hoa. Thoát game theo cài đặt", this, (object) this.Myself.haihoaCounter);
            this.CallOutGame();
            return;
          }
          GA.WriteUserLog("Đã hết {0} vòng nv Hoa, dừng nhiệm vụ.", this, (object) this.Myself.haihoaCounter);
          return;
        }
        this.Myself.actionFlag = 0;
        bool flag2 = false;
        long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        while (this.Myself.isBachHoaDuyen)
        {
          if (this.Myself.actionFlag == 0)
          {
            this.CallTalkNPC(0, 0, NPCID1);
            long elapsedMilliseconds3 = frmLogin.GlobalTimer.ElapsedMilliseconds;
            while (this.Myself.isQuestFrameShow == 0)
            {
              Thread.Sleep(200);
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds3 > 2000L)
                break;
            }
            this.CallTalkNPC(num1, menuIndex1, NPCID1);
          }
          Thread.Sleep(500);
          if (this.Myself.isQuestFrameShow == 1)
          {
            this.ResetPacketMsg();
            this.CallTalkNPC(num1, menuIndex2, NPCID1);
            this.Myself.actionFlag = 1;
            Thread.Sleep(500);
            if (this.Myself.NhiemVuFinish)
              this.CallTraNhiemVu();
          }
          if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 >= 3000L)
          {
            this.Myself.actionFlag = 0;
            elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          }
          if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 >= 10000L)
          {
            if (this.CustomSleep(6, 21600000))
              GA.WriteUserLog(frmMain.langBachHoaDuyenALTQ, this);
            flag2 = true;
          }
          if (!this.Myself.NhiemVuFinish)
          {
            if (this.Myself.NhiemVuType > 0 || flag2)
            {
              ++this.Myself.QuestStep;
              this.Myself.actionFlag = 0;
              break;
            }
          }
          else
          {
            if (this.Myself.EventString == "HVQH")
            {
              this.MyFlag.BHDcounter = -4;
              break;
            }
            if (this.Myself.EventString == "NVHF" || flag2)
            {
              this.Myself.QuestStep = 1;
              this.Myself.NhiemVuFinish = false;
              this.Myself.actionFlag = 0;
              if (this.Myself.OutMapPathPoints.Count > 0)
                this.Myself.OutMapPathPoints.Clear();
              this.CallResetNhiemVuData();
              this.Myself.actionFlag = 0;
              break;
            }
          }
        }
      }
      if (this.Myself.QuestStep == 2)
      {
        switch (this.Myself.NhiemVuType)
        {
          case 2:
            this.CallSetUpNhiemVuData(105, 123, 2);
            break;
          case 3:
            if (this.Settings.cboxHuyNVNhatDo)
            {
              this.HuyNhiemVu(num1);
              this.Myself.QuestStep = 0;
              this.CallResetNhiemVuData();
              GA.WriteUserLog("Hủy nhiệm vụ hái hoa Thái Hồ theo cài đặt. 5 phút sau tự nhận lại", this);
              return;
            }
            this.CallSetUpNhiemVuData(279, 226, 4);
            this.ClearPickedBocList();
            break;
          case 4:
            if (this.Settings.cboxHuyNVDanhQuai)
            {
              this.HuyNhiemVu(num1);
              this.Myself.QuestStep = 0;
              this.CallResetNhiemVuData();
              GA.WriteUserLog("Hủy nhiệm vụ đánh quái theo cài đặt. 5 phút sau tự nhận lại", this);
              return;
            }
            this.ClearPickedBocList();
            break;
          case 5:
            if (this.Settings.cboxHuyNVNhatDo)
            {
              this.HuyNhiemVu(num1);
              this.Myself.QuestStep = 0;
              this.CallResetNhiemVuData();
              GA.WriteUserLog("Hủy nhiệm vụ tìm đồ ở môn phái theo cài đặt. 5 phút sau tự nhận lại", this);
              return;
            }
            this.ClearPickedBocList();
            break;
        }
        if (this.Myself.NhiemVuPosX == 0 && this.Myself.NhiemVuPosY == 0 && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.EventStamp >= 3000L)
        {
          this.Myself.EventStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
          this.CallToggleMission();
          Thread.Sleep(500);
          this.CallToggleMission();
          Thread.Sleep(500);
          ++this.MyFlag.BHDCheckQuestCounter;
        }
        if (this.Myself.NhiemVuPosX > 0 && this.Myself.NhiemVuPosY > 0)
        {
          ++this.Myself.QuestStep;
          this.MyFlag.BHDCheckQuestCounter = 0;
        }
        else if (this.MyFlag.BHDCheckQuestCounter >= 3)
        {
          this.Myself.QuestStep = 0;
          this.MyFlag.BHDCheckQuestCounter = 0;
        }
      }
      if (this.Myself.QuestStep == 3)
      {
        if (this.Myself.NhiemVuType == 4 && this.Settings.cboxHuyNVDanhQuai)
        {
          this.HuyNhiemVu(num1);
          this.Myself.QuestStep = 0;
          this.CallResetNhiemVuData();
          GA.WriteUserLog("Hủy nhiệm vụ đánh quái theo cài đặt. 5 phút sau tự nhận lại", this);
          return;
        }
        bool flag3 = false;
        if (this.Myself.NhiemVuType == 2)
        {
          for (int index = 0; index < 30; ++index)
          {
            if (this.MyInventory.AllItems[index].ItemID == 30101039)
            {
              flag3 = true;
              this.Myself.QuestStep = 5;
            }
          }
        }
        if (!flag3)
        {
          if (this.Myself.MapID == 2 && this.Myself.NhiemVuType == 3)
            this.GoToMyPos(98, 167, 11);
          else if (this.IsInPhaiPhuBan() && this.Myself.NhiemVuType == 5)
            ++this.Myself.QuestStep;
          else if (this.GoToMyPos(this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY, this.Myself.NhiemVuMapID))
          {
            this.Myself.NhiemVuPosX_Save = this.Myself.NhiemVuPosX;
            this.Myself.NhiemVuPosY_Save = this.Myself.NhiemVuPosY;
            this.Myself.NhiemVuMapID_Save = this.Myself.NhiemVuMapID;
            ++this.Myself.QuestStep;
          }
        }
      }
      if (this.Myself.QuestStep == 4)
      {
        switch (this.Myself.NhiemVuType)
        {
          case 1:
            this.ResetEventString();
            this.ResetPacketMsg();
            Thread.Sleep(1500);
            this.Myself.actionFlag = 0;
            bool flag4 = false;
            long elapsedMilliseconds4 = frmLogin.GlobalTimer.ElapsedMilliseconds;
            long elapsedMilliseconds5 = frmLogin.GlobalTimer.ElapsedMilliseconds;
            while (this.Myself.isBachHoaDuyen)
            {
              if (this.Myself.actionFlag == 0)
                this.CallTalkNPCByPos(menuTypeID1, menuIndex3, this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY);
              Thread.Sleep(500);
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds5 >= 2000L)
              {
                this.Myself.actionFlag = 0;
                elapsedMilliseconds5 = frmLogin.GlobalTimer.ElapsedMilliseconds;
              }
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds4 >= 10000L)
                flag4 = true;
              if (flag4 || this.Myself.PacketMsg == "NVBHD")
              {
                ++this.Myself.QuestStep;
                this.Myself.actionFlag = 0;
                break;
              }
            }
            break;
          case 2:
            this.CallTalkNPC(0, 0, 12);
            Thread.Sleep(300);
            this.CallTalkNPC(2027, 0, 12);
            Thread.Sleep(1000);
            this.CallBuyItemPacket(17, 12, this.Myself.MapID, 20);
            Thread.Sleep(500);
            ++this.Myself.QuestStep;
            break;
          case 3:
            this.DiTimBauVat(801, 4);
            if (this.Myself.EventString == "HHXR")
            {
              this.CallMoveFlashPos((int) this.Myself.PosX, (int) this.Myself.PosY);
              this.Myself.Status = AllEnums.CharStatuses.IDLE;
              ++this.Myself.QuestStep;
              break;
            }
            break;
          case 4:
            if (this.Settings.cboxHuyNVDanhQuai)
            {
              this.HuyNhiemVu(num1);
              this.Myself.QuestStep = 0;
              this.CallResetNhiemVuData();
              GA.WriteUserLog("Hủy nhiệm vụ đánh quái theo cài đặt. 5 phút sau tự nhận lại", this);
              return;
            }
            if (this.IsInPhaiMap())
            {
              int num2 = 0;
              int num3 = 0;
              int NPCID2 = 0;
              int menuTypeID2 = 0;
              int menuIndex4 = 0;
              foreach (PhuBanPath phuBanPath in frmLogin.GAuto.PhuBanPathDB)
              {
                if (phuBanPath.MapIDNgoai == this.Myself.MapID)
                {
                  num2 = phuBanPath.NPCPosX;
                  num3 = phuBanPath.NPCPosY;
                  NPCID2 = phuBanPath.NPCID;
                  menuTypeID2 = phuBanPath.NPCMenuTypeID1;
                  menuIndex4 = phuBanPath.NPCMenuIndex1;
                  break;
                }
              }
              if (num2 > 0 && num3 > 0)
              {
                if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num2, (double) num3) > 3.0)
                {
                  this.CallMoveFlashPos(num2, num3);
                  break;
                }
                this.Myself.Status = AllEnums.CharStatuses.IDLE;
                this.Myself.MinorStatus = AllEnums.CharStatuses.IDLE;
                this.Myself.MoveLongTrigger = false;
                this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
                this.Myself.UseAutoMove = false;
                this.Myself.previousMapID = this.Myself.MapID;
                this.CallTalkNPC(0, 0, NPCID2);
                Thread.Sleep(300);
                this.CallTalkNPC(menuTypeID2, menuIndex4, NPCID2);
                Thread.Sleep(1500);
                if (this.Myself.isMessageBox_Self == 1)
                {
                  this.CallStartAutoMoveClick();
                  break;
                }
                break;
              }
              break;
            }
            if (this.IsInPhaiPhuBan())
            {
              if (this.Myself.NhiemVuMapID != this.Myself.MapID)
              {
                this.CallToggleMission();
                Thread.Sleep(500);
                this.CallToggleMission();
                Thread.Sleep(500);
              }
              else
              {
                if (this.Myself.MapID == 146 && GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, 91.0, 144.0) < 5.0)
                {
                  Thread.Sleep(1000);
                  this.CallMoveFlashPos(96 /*0x60*/, 126);
                  Thread.Sleep(5000);
                }
                double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) this.Myself.NhiemVuPosX, (double) this.Myself.NhiemVuPosY);
                if (distance > 20.0)
                {
                  if (distance > 35.0)
                    this.CallLenNgua();
                  this.CallInMapMove(this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY);
                }
                else
                {
                  bool flag5 = false;
                  if (this.MyFlag.tempStamp2 == 0L)
                    this.MyFlag.tempStamp2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                  if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.tempStamp2 > 5000L)
                  {
                    this.MyFlag.tempStamp2 = 0L;
                    for (int index = 60; index < 80 /*0x50*/; ++index)
                    {
                      InventoryItem allItem = this.MyInventory.AllItems[index];
                      if (allItem.ItemID == 40004498 && allItem.ItemCount >= (byte) 10)
                      {
                        flag5 = true;
                        break;
                      }
                    }
                  }
                  if (flag5)
                  {
                    ++this.Myself.QuestStep;
                    this.Myself.actionFlag = 0;
                    return;
                  }
                  this.AttackQuai();
                  this.NhatBoc();
                }
              }
              if (this.Myself.PacketMsg == "NDDR")
              {
                ++this.Myself.QuestStep;
                this.Myself.actionFlag = 0;
                break;
              }
              break;
            }
            this.Myself.NhiemVuPosX = this.Myself.NhiemVuPosX_Save;
            this.Myself.NhiemVuPosY = this.Myself.NhiemVuPosY_Save;
            this.Myself.NhiemVuMapID = this.Myself.NhiemVuMapID_Save;
            --this.Myself.QuestStep;
            break;
          case 5:
            if (this.IsInPhaiMap())
            {
              int num4 = 0;
              int num5 = 0;
              int NPCID3 = 0;
              int menuTypeID3 = 0;
              int menuIndex5 = 0;
              foreach (PhuBanPath phuBanPath in frmLogin.GAuto.PhuBanPathDB)
              {
                if (phuBanPath.MapIDNgoai == this.Myself.MapID)
                {
                  num4 = phuBanPath.NPCPosX;
                  num5 = phuBanPath.NPCPosY;
                  NPCID3 = phuBanPath.NPCID;
                  menuTypeID3 = phuBanPath.NPCMenuTypeID1;
                  menuIndex5 = phuBanPath.NPCMenuIndex1;
                  break;
                }
              }
              if (num4 > 0 && num5 > 0)
              {
                if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num4, (double) num5) > 4.0)
                {
                  this.CallMoveFlashPos(num4, num5);
                  break;
                }
                this.Myself.Status = AllEnums.CharStatuses.IDLE;
                this.Myself.MinorStatus = AllEnums.CharStatuses.IDLE;
                this.Myself.MoveLongTrigger = false;
                this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
                this.Myself.UseAutoMove = false;
                this.Myself.previousMapID = this.Myself.MapID;
                this.CallTalkNPC(0, 0, NPCID3);
                Thread.Sleep(300);
                this.CallTalkNPC(menuTypeID3, menuIndex5, NPCID3);
                Thread.Sleep(1500);
                if (this.Myself.isMessageBox_Self == 1)
                {
                  this.CallStartAutoMoveClick();
                  break;
                }
                break;
              }
              break;
            }
            if (this.IsInPhaiPhuBan())
            {
              if (this.Myself.previousMapID <= 0)
              {
                if (frmLogin.GAuto.PhuBanPathDB.Count > 0)
                {
                  foreach (PhuBanPath phuBanPath in frmLogin.GAuto.PhuBanPathDB)
                  {
                    if (phuBanPath.MapIDTrong == this.Myself.MapID)
                      this.Myself.previousMapID = phuBanPath.MapIDNgoai;
                  }
                }
              }
              else
              {
                if (this.Myself.MapID == 146 && GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, 91.0, 144.0) < 5.0)
                {
                  Thread.Sleep(1000);
                  this.CallMoveFlashPos(96 /*0x60*/, 126);
                  Thread.Sleep(5000);
                }
                this.DiTimBauVat(800, this.Myself.previousMapID);
              }
              if (this.Myself.EventString == "HHXR")
              {
                this.CallMoveFlashPos((int) this.Myself.PosX, (int) this.Myself.PosY);
                this.Myself.Status = AllEnums.CharStatuses.IDLE;
                ++this.Myself.QuestStep;
                break;
              }
              break;
            }
            this.Myself.NhiemVuPosX = this.Myself.NhiemVuPosX_Save;
            this.Myself.NhiemVuPosY = this.Myself.NhiemVuPosY_Save;
            this.Myself.NhiemVuMapID = this.Myself.NhiemVuMapID_Save;
            --this.Myself.QuestStep;
            break;
        }
      }
      if (this.Myself.QuestStep != 5)
        return;
      bool flag6 = false;
      bool flag7;
      if (this.Myself.MapID != 2)
      {
        int itemIndex = -1;
        if (itemIndex == -1)
          itemIndex = this.SearchDVP(2);
        if (itemIndex >= 0)
        {
          this.CallXuongNgua();
          if (this.IsInPhaiPhuBan())
          {
            this.CallTangHinh();
            Thread.Sleep(700);
          }
          this.CallUseItem(itemIndex, this.Myself.ID);
          long elapsedMilliseconds6 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          long elapsedMilliseconds7 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          while (this.IsAIEnabled)
          {
            if (this.Myself.MapID == 2)
            {
              flag6 = true;
              break;
            }
            if (this.Myself.isSceneTrans == 1)
            {
              Thread.Sleep(2000);
              flag6 = true;
              break;
            }
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds7 >= 9000L && this.Myself.ActionStatus != (byte) 5)
            {
              if (this.IsInPhaiPhuBan())
              {
                this.CallTangHinh();
                Thread.Sleep(700);
              }
              this.CallUseItem(itemIndex, this.Myself.ID);
              elapsedMilliseconds7 = frmLogin.GlobalTimer.ElapsedMilliseconds;
            }
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds6 < 60000L || this.Myself.ActionStatus == (byte) 5)
              Thread.Sleep(500);
            else
              break;
          }
          flag7 = true;
        }
        else
          flag7 = true;
      }
      else
        flag7 = true;
      if (!flag7)
        return;
      if (this.IsInPhaiPhuBan() && !flag6)
      {
        int tempX = 0;
        int tempY = 0;
        if (frmLogin.GAuto.PhuBanPathDB.Count > 0)
        {
          foreach (PhuBanPath phuBanPath in frmLogin.GAuto.PhuBanPathDB)
          {
            if (phuBanPath.MapIDTrong == this.Myself.MapID)
            {
              tempX = phuBanPath.ExitX;
              tempY = phuBanPath.ExitY;
            }
          }
        }
        this.CallLenNgua();
        this.CallInMapMove(tempX, tempY, true);
      }
      else
      {
        this.Myself.NhiemVuFinish = true;
        this.Myself.QuestStep = 0;
        this.CallResetNhiemVuData();
      }
    }
  }

  public void NhiemVuSuMon()
  {
    int num1 = 0;
    int num2 = 0;
    int num3 = 0;
    int num4 = 0;
    int num5 = 0;
    int num6 = -1;
    bool flag1 = false;
    if (this.Myself.Menpai == AllEnums.Menpais.THIEULAM)
    {
      num1 = 9;
      num2 = 96 /*0x60*/;
      num3 = 82;
      num4 = 9;
      num5 = 229000;
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.TINHTUC)
    {
      num1 = 9;
      num2 = 96 /*0x60*/;
      num3 = 93;
      num4 = 16 /*0x10*/;
      num5 = 229007;
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.THIENLONG)
    {
      num1 = 4;
      num2 = 96 /*0x60*/;
      num3 = 89;
      num4 = 13;
      num5 = 229004;
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.THIENSON)
    {
      num1 = 2;
      num2 = 95;
      num3 = 61;
      num4 = 17;
      num5 = 229006;
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.MINHGIAO)
    {
      num1 = 1;
      num2 = 98;
      num3 = 105;
      num4 = 11;
      num5 = 229001;
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.CAIBANG)
    {
      num1 = 16 /*0x10*/;
      num2 = 92;
      num3 = 77;
      num4 = 10;
      num5 = 229008;
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.VODANG)
    {
      num1 = 9;
      num2 = 78;
      num3 = 95;
      num4 = 12;
      num5 = 229002;
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.NGAMI)
    {
      num1 = 7;
      num2 = 96 /*0x60*/;
      num3 = 87;
      num4 = 15;
      num5 = 229003;
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.TIEUDAO)
    {
      num1 = 13;
      num2 = 119;
      num3 = 152;
      num4 = 14;
      num5 = 229005;
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.MODUNG)
    {
      num1 = 9;
      num2 = 69;
      num3 = 126;
      num4 = 195;
      num5 = 229014;
    }
    else if (this.Myself.Menpai == AllEnums.Menpais.DUONGMON)
    {
      num1 = 2;
      num2 = 100;
      num3 = 64 /*0x40*/;
      num4 = 521;
      num5 = 229015;
    }
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    if (!flag1 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LuyenKimStamp < 300L)
      return;
    this.Myself.LuyenKimStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    if (this.isInDiaPhu())
    {
      this.CallMoveTo(12, 24);
    }
    else
    {
      if (this.Myself.NhiemVuPosX == 0 && this.Myself.NhiemVuPosY == 0 && this.Myself.QuestStep == 0 && !this.Myself.NhiemVuFinish && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.EventStamp >= 10000L)
      {
        this.Myself.EventStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
        this.CallToggleMission();
        Thread.Sleep(500);
        this.CallToggleMission();
        Thread.Sleep(500);
      }
      if (this.Myself.QuestStep == 0)
      {
        if ((this.Myself.NhiemVuPosX > 0 && this.Myself.NhiemVuPosY > 0 || this.Myself.NhiemVuType > 0) && !this.Myself.NhiemVuFinish)
          this.Myself.QuestStep = 2;
        else if (this.GoToMyPos(num2, num3, num4))
        {
          Thread.Sleep(500);
          ++this.Myself.QuestStep;
        }
      }
      if (this.Myself.QuestStep == 1)
      {
        if (!this.Myself.NhiemVuFinish)
        {
          this.ResetEventString();
          this.ResetPacketMsg();
          this.CallResetNhiemVuData();
        }
        this.Myself.actionFlag = 0;
        bool flag2 = false;
        long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        while (this.Myself.isQSM)
        {
          if (this.Myself.actionFlag == 0)
          {
            this.CallTalkNPC(0, 0, num1);
            Thread.Sleep(300);
            this.CallTalkNPC(num5, num6, num1);
            ++this.Myself.actionFlag;
          }
          Thread.Sleep(500);
          if (this.Myself.actionFlag == 1 && this.Myself.NhiemVuType == 2)
          {
            int petIndex = -1;
            int petID = 0;
            int myDBID = 0;
            if (this.MyPet.AllPets.Count > 0)
            {
              try
              {
                for (int index = 0; index < this.MyPet.AllPets.Count; ++index)
                {
                  SinglePetClass allPet = this.MyPet.AllPets[index];
                  if (allPet.PetName == this.Myself.NhiemVuString1 || allPet.PetName.Contains(this.Myself.NhiemVuString1))
                  {
                    petIndex = index;
                    petID = allPet.DatabaseID;
                    myDBID = allPet.PetOwnerDBID;
                    break;
                  }
                }
              }
              catch (Exception ex)
              {
                if (GA.isVipMember())
                  GA.WriteUserLog(frmMain.langErrorReturnPet, this);
              }
            }
            if (petIndex >= 0)
            {
              if (this.Target.VersionNum == 5 || this.Target.VersionNum == 6)
                this.GivePetToNPC(num1, num6, num5, petIndex, this.Myself.DatabaseID, petID);
              else
                this.GivePetToNPC(num1, num6, num5, petIndex, myDBID, petID);
              Thread.Sleep(3000);
            }
          }
          if (this.Myself.isQuestFrameShow == 1 && this.Myself.NhiemVuType != 2)
          {
            this.ResetPacketMsg();
            this.Myself.actionFlag = 1;
            Thread.Sleep(300);
            if (this.Myself.NhiemVuFinish)
              this.CallTraNhiemVu();
          }
          if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 >= 3000L)
          {
            this.Myself.actionFlag = 0;
            elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          }
          if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 >= 10000L)
          {
            if (this.Myself.PacketMsg == "SM15M")
            {
              elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
            }
            else
            {
              if (this.CustomSleep(6, 21600000))
              {
                string langQsmaltQ = frmMain.langQSMALT_Q;
                if (this.Myself.LogString != langQsmaltQ)
                {
                  GA.WriteUserLog(langQsmaltQ, this);
                  this.Myself.LogString = langQsmaltQ;
                }
              }
              flag2 = true;
            }
          }
          if (!this.Myself.NhiemVuFinish)
          {
            if (this.Myself.NhiemVuType > 0 || flag2)
            {
              ++this.Myself.QuestStep;
              this.Myself.actionFlag = 0;
              break;
            }
          }
          else if (this.Myself.EventString == "QSMFN" || flag2)
          {
            if (this.Myself.NhiemVuType == 2)
              this.Settings.cboxTuNhatVatPham = true;
            this.Myself.QuestStep = 1;
            this.Myself.NhiemVuFinish = false;
            this.Myself.actionFlag = 0;
            this.CallResetNhiemVuData();
            this.ResetEventString();
            this.ResetPacketMsg();
            this.Myself.NhiemVuQuaiID = 0;
            if (this.Myself.EventString == "QSMFN")
            {
              this.MyFlag.huyQcounter = 0;
              break;
            }
            break;
          }
        }
      }
      if (this.Myself.QuestStep == 2)
      {
        switch (this.Myself.NhiemVuType)
        {
          case 0:
            if (this.MyFlag.huyQcounter >= 1)
            {
              this.HuyNhiemVu(num5);
              GA.WriteUserLog(frmMain.langQSMRemoveQ, this);
              this.CallResetNhiemVuData();
              this.ResetEventString();
              this.ResetPacketMsg();
              this.Myself.QuestStep = 0;
              this.MyFlag.huyQcounter = 0;
              return;
            }
            break;
          case 1:
            bool flag3 = false;
            if (this.MyFlag.huyQcounter == 0)
            {
              flag3 = this.CallTalkNPCQuest("QSMFN", menuType1: 229013, menuIndex1: 10, NPCID: num1, menuType2: 229013, menuIndex2: 11, timeout: 7000, modetimeout: false);
              if (!flag3 && this.Settings.cboxDongMon)
              {
                this.CallTalkNPC(0, 0, num1);
                flag3 = this.CallTalkNPCQuest("QSMFN", menuType1: 229011, menuIndex1: 1, NPCID: num1, menuType2: 229011, menuIndex2: 2, timeout: 7000, modetimeout: false);
              }
              if (flag3)
              {
                this.Myself.QuestStep = 1;
                this.CallResetNhiemVuData();
                this.ResetEventString();
                this.ResetPacketMsg();
                return;
              }
            }
            if (!flag3)
            {
              if (this.MyFlag.huyQcounter >= 1)
              {
                this.HuyNhiemVu(num5);
                GA.WriteUserLog(frmMain.langQSMRemoveQ, this);
                this.CallResetNhiemVuData();
                this.ResetEventString();
                this.ResetPacketMsg();
                this.Myself.QuestStep = 0;
                this.MyFlag.huyQcounter = 0;
                return;
              }
              this.Myself.NhiemVuFinish = true;
              this.Myself.QuestStep = 0;
              ++this.MyFlag.huyQcounter;
              break;
            }
            break;
          case 2:
            int num7 = -1;
            if (this.MyPet.AllPets.Count > 0)
            {
              try
              {
                for (int index = 0; index < this.MyPet.AllPets.Count; ++index)
                {
                  SinglePetClass allPet = this.MyPet.AllPets[index];
                  if (allPet.PetName == this.Myself.NhiemVuString1 || allPet.PetName.Contains(this.Myself.NhiemVuString1))
                  {
                    num7 = index;
                    int databaseId = allPet.DatabaseID;
                    break;
                  }
                }
              }
              catch (Exception ex)
              {
                if (GA.isVipMember())
                  GA.WriteUserLog(frmMain.langErrorLoopForPet, this);
              }
            }
            if (num7 >= 0)
            {
              this.Myself.QuestStep = 5;
              return;
            }
            break;
          case 6:
            this.CallSetUpNhiemVuData(num2, num3, num4);
            for (int index = 0; index < frmLogin.GAuto.ItemNVDB.Count; ++index)
            {
              ItemNhiemVuElement itemNhiemVuElement = frmLogin.GAuto.ItemNVDB[index];
              if (itemNhiemVuElement.Name == this.Myself.NhiemVuString1 || itemNhiemVuElement.Name.Contains(this.Myself.NhiemVuString1))
                this.Myself.NhiemVuQuaiID = itemNhiemVuElement.BocType;
            }
            break;
          case 7:
            int nvPosX = 0;
            int nvPosY = 0;
            if (this.Myself.Menpai == AllEnums.Menpais.THIEULAM)
            {
              nvPosX = 61;
              nvPosY = 62;
            }
            else if (this.Myself.Menpai == AllEnums.Menpais.TINHTUC)
            {
              nvPosX = 128 /*0x80*/;
              nvPosY = 78;
            }
            else if (this.Myself.Menpai == AllEnums.Menpais.THIENLONG)
            {
              nvPosX = 35;
              nvPosY = 86;
            }
            else if (this.Myself.Menpai == AllEnums.Menpais.THIENSON)
            {
              nvPosX = 101;
              nvPosY = 45;
            }
            else if (this.Myself.Menpai == AllEnums.Menpais.MINHGIAO)
            {
              nvPosX = 89;
              nvPosY = 56;
            }
            else if (this.Myself.Menpai == AllEnums.Menpais.CAIBANG)
            {
              nvPosX = 41;
              nvPosY = 144 /*0x90*/;
            }
            else if (this.Myself.Menpai == AllEnums.Menpais.VODANG)
            {
              nvPosX = 58;
              nvPosY = 73;
            }
            else if (this.Myself.Menpai == AllEnums.Menpais.NGAMI)
            {
              nvPosX = 96 /*0x60*/;
              nvPosY = 73;
            }
            else if (this.Myself.Menpai == AllEnums.Menpais.TIEUDAO)
            {
              nvPosX = 63 /*0x3F*/;
              nvPosY = 69;
            }
            else if (this.Myself.Menpai == AllEnums.Menpais.MODUNG)
            {
              nvPosX = 69;
              nvPosY = 109;
            }
            else if (this.Myself.Menpai == AllEnums.Menpais.DUONGMON)
            {
              nvPosX = 66;
              nvPosY = 30;
            }
            this.CallSetUpNhiemVuData(nvPosX, nvPosY, num4);
            break;
        }
        if (this.Myself.NhiemVuType != 1)
        {
          if (this.Myself.NhiemVuPosX == 0 && this.Myself.NhiemVuPosY == 0 && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.EventStamp >= 5000L)
          {
            this.Myself.EventStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
            this.CallToggleMission();
            Thread.Sleep(500);
            this.CallToggleMission();
            Thread.Sleep(500);
            ++this.Myself.actionCounter;
          }
          if (this.Myself.actionCounter >= 2)
          {
            this.Myself.actionCounter = 0;
            this.Myself.QuestStep = 0;
          }
          if (this.Myself.NhiemVuPosX > 0 && this.Myself.NhiemVuPosY > 0 && this.Myself.NhiemVuType > 0)
          {
            this.Myself.actionCounter = 0;
            ++this.Myself.QuestStep;
          }
        }
      }
      if (this.Myself.QuestStep == 3)
      {
        if (this.Myself.NhiemVuType == 6 && this.IsInPhai())
          ++this.Myself.QuestStep;
        else if (this.Myself.NhiemVuType != 5 ? this.GoToMyPos(this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY, this.Myself.NhiemVuMapID) : this.GoToMyPos(this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY, num4))
          ++this.Myself.QuestStep;
      }
      if (this.Myself.QuestStep == 4)
      {
        switch (this.Myself.NhiemVuType)
        {
          case 2:
            if (this.IsInCity())
            {
              this.Myself.NhiemVuQuaiID = 0;
              this.Myself.QuestStep = 3;
            }
            if (this.Myself.NhiemVuQuaiID == 0)
            {
              this.Settings.cboxTuNhatVatPham = false;
              this.DiTimBauVat(danhquai: true, quainame: this.Myself.NhiemVuString1);
            }
            else
            {
              if (this.Myself.batPetStamp == 0L)
                this.Myself.batPetStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
              else if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.batPetStamp >= 60000L)
              {
                this.Myself.batPetStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                this.Myself.NhiemVuQuaiID = 0;
              }
              this.CallXuongNgua();
              if (this.Myself.ActionStatus != (byte) 5)
                this.CallTangHinh();
              if (this.Myself.NhiemVuQuaiID >= 0)
                this.CallAttackTarget(this.Myself.NhiemVuQuaiID, 1, 0, 0);
              if (this.Myself.EventString == "BDPR")
                ++this.Myself.QuestStep;
            }
            int num8 = -1;
            if (this.MyPet.AllPets.Count > 0)
            {
              try
              {
                for (int index = 0; index < this.MyPet.AllPets.Count; ++index)
                {
                  SinglePetClass allPet = this.MyPet.AllPets[index];
                  if (allPet.PetName == this.Myself.NhiemVuString1 || allPet.PetName.Contains(this.Myself.NhiemVuString1))
                  {
                    num8 = index;
                    int databaseId = allPet.DatabaseID;
                    break;
                  }
                }
              }
              catch (Exception ex)
              {
                if (GA.isVipMember())
                  GA.WriteUserLog(frmMain.langErrorLoopForPet, this);
              }
            }
            if (num8 >= 0)
            {
              ++this.Myself.QuestStep;
              return;
            }
            break;
          case 3:
          case 7:
            int menuTypeID = 0;
            int menuIndex = 0;
            int num9 = 0;
            int num10 = 0;
            if (this.Myself.MapID == 9)
            {
              menuTypeID = 889803;
              num9 = 32 /*0x20*/;
              num10 = 53;
            }
            else if (this.Myself.MapID == 16 /*0x10*/)
            {
              menuTypeID = 889808;
              num9 = 9;
              num10 = 39;
            }
            else if (this.Myself.MapID == 13)
            {
              menuTypeID = 889809;
              num9 = 53;
              num10 = 48 /*0x30*/;
            }
            else if (this.Myself.MapID == 17)
            {
              menuTypeID = 889840;
              num9 = 24;
              num10 = 54;
            }
            else if (this.Myself.MapID == 11)
            {
              menuTypeID = 889804;
              num9 = 12;
              num10 = 41;
            }
            else if (this.Myself.MapID == 10)
            {
              menuTypeID = 889805;
              num9 = 44;
              num10 = 51;
            }
            else if (this.Myself.MapID == 12)
            {
              menuTypeID = 889806;
              num9 = 44;
              num10 = 52;
            }
            else if (this.Myself.MapID == 15)
            {
              menuTypeID = 889807;
              num9 = 18;
              num10 = 52;
            }
            else if (this.Myself.MapID == 14)
            {
              menuTypeID = 889841;
              num9 = 43;
              num10 = 55;
            }
            else if (this.Myself.MapID == 195)
            {
              menuTypeID = 889842;
              num9 = 13;
              num10 = 47;
            }
            else if (this.Myself.MapID == 521)
            {
              menuTypeID = 889802;
              num9 = 35;
              num10 = 16 /*0x10*/;
            }
            if (num9 > 0 && num10 > 0)
            {
              this.Myself.TempPosX = num9;
              this.Myself.TempPosY = num10;
            }
            if (this.IsInPhai() && this.Myself.NhiemVuType == 7 || this.IsInPhaiMap() && this.Myself.NhiemVuType == 3)
            {
              QuaiIndividual quaiIndividual = this.SearchNPCByPos(this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY, 5);
              if (quaiIndividual != null && quaiIndividual.ID >= 0)
              {
                if (this.Myself.actionFlag == 0)
                {
                  this.CallTalkNPC(0, 0, quaiIndividual.ID);
                  Thread.Sleep(500);
                  this.CallTalkNPC(menuTypeID, menuIndex, quaiIndividual.ID);
                  Thread.Sleep(500);
                  this.CallNhanNhiemVu();
                  Thread.Sleep(500);
                  if (this.Myself.DiPhuBanStamp == 0L)
                    this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                  if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp >= 25000L)
                  {
                    this.Myself.actionFlag = 0;
                    ++this.Myself.QuestStep;
                    this.Myself.DiPhuBanStamp = 0L;
                  }
                }
                else
                {
                  this.Myself.actionFlag = 0;
                  ++this.Myself.QuestStep;
                }
              }
              if (this.Myself.actionFlag == 1)
              {
                this.Myself.actionFlag = 0;
                ++this.Myself.QuestStep;
                break;
              }
              break;
            }
            this.Myself.actionFlag = 1;
            this.CallMoveFlashPos(this.Myself.TempPosX, this.Myself.TempPosY);
            break;
          case 4:
            QuaiIndividual quaiIndividual1 = (QuaiIndividual) null;
            if (this.Myself.NhiemVuString1 != "")
              quaiIndividual1 = this.SearchNPCByName(this.Myself.NhiemVuString1);
            if (quaiIndividual1 == null)
              quaiIndividual1 = this.SearchNPCByPos(this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY, 5);
            if (quaiIndividual1 != null && this.GoToMyPos((int) quaiIndividual1.PosX, (int) quaiIndividual1.PosY, this.Myself.MapID) && this.CallTalkNPCQuest("SMXQ", menuType1: num5, menuIndex1: num6, NPCID: quaiIndividual1.ID))
            {
              ++this.Myself.QuestStep;
              break;
            }
            break;
          case 5:
            int itemIndex1 = -1;
            if (this.Myself.NhiemVuString1 != "")
            {
              for (int index = 60; index < 90; ++index)
              {
                InventoryItem allItem = this.MyInventory.AllItems[index];
                if (string.Compare(allItem.ItemName, this.Myself.NhiemVuString1, true) == 0 || allItem.ItemName.Contains(this.Myself.NhiemVuString1.ToLower()))
                {
                  itemIndex1 = index;
                  this.CallXuongNgua();
                  break;
                }
              }
              if (itemIndex1 > 0)
              {
                if (this.Myself.ActionStatus != (byte) 6 && this.Myself.ActionStatus != (byte) 5)
                {
                  this.CallUseItem(itemIndex1, this.Myself.ID);
                  Thread.Sleep(500);
                }
              }
              else
                ++this.Myself.QuestStep;
              if (this.Myself.EventString == "SMXQ")
              {
                ++this.Myself.QuestStep;
                break;
              }
              break;
            }
            break;
          case 6:
            if (this.Myself.NhiemVuQuaiID > 0)
              this.DiTimBauVat(this.Myself.NhiemVuQuaiID, this.Myself.MapID);
            if (this.Myself.EventString == "TDXR")
            {
              ++this.Myself.QuestStep;
              break;
            }
            break;
        }
      }
      if (this.Myself.QuestStep == 5)
      {
        if (this.Myself.NhiemVuType == 2)
        {
          ++this.Myself.QuestStep;
        }
        else
        {
          this.Myself.NhiemVuFinish = true;
          this.Myself.QuestStep = 0;
        }
      }
      if (this.Myself.QuestStep != 6)
        return;
      bool flag4;
      if (!this.IsInCity() && !this.IsInPhaiMap())
      {
        int itemIndex2 = -1;
        if (itemIndex2 == -1)
          itemIndex2 = this.SearchDVP(1001);
        if (itemIndex2 >= 0)
        {
          this.CallXuongNgua();
          if (!this.IsInCity())
          {
            this.CallTangHinh();
            Thread.Sleep(700);
          }
          this.CallUseItem(itemIndex2, this.Myself.ID);
          long elapsedMilliseconds3 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          long elapsedMilliseconds4 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          while (this.IsAIEnabled && !this.IsInCity())
          {
            if (this.Myself.isSceneTrans == 1)
            {
              Thread.Sleep(2000);
              break;
            }
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds4 >= 9000L && this.Myself.ActionStatus != (byte) 5)
            {
              if (!this.IsInCity())
              {
                this.CallTangHinh();
                Thread.Sleep(700);
              }
              this.CallUseItem(itemIndex2, this.Myself.ID);
              elapsedMilliseconds4 = frmLogin.GlobalTimer.ElapsedMilliseconds;
            }
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds3 < 60000L || this.Myself.ActionStatus == (byte) 5)
              Thread.Sleep(500);
            else
              break;
          }
          flag4 = true;
        }
        else
          flag4 = true;
      }
      else
        flag4 = true;
      if (!flag4)
        return;
      this.Myself.NhiemVuFinish = true;
      this.Myself.QuestStep = 0;
    }
  }

  public void KhaiKhoangHaiDuoc()
  {
    if (this.Myself.HPPercent <= 0.0 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LuyenKimStamp < 100L)
      return;
    this.Myself.LuyenKimStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    if (this.isInDiaPhu())
      this.CallMoveTo(12, 24);
    else if (this.Myself.MapID != this.Settings.KhoangDuocMapID)
      this.GoToMyPos(50, 50, this.Settings.KhoangDuocMapID);
    else
      this.DiTimBauVat(1001, this.Settings.KhoangDuocMapID);
  }

  public void NhiemVuMuaKNB()
  {
    if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.KNBStamp < 1000L)
      return;
    int num1 = 254;
    int num2 = 320;
    this.Myself.KNBStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    if (this.Myself.MapID != 0)
    {
      this.CallOutMapMove(num1, num2, 0);
    }
    else
    {
      if (this.Myself.MapID != 0)
        return;
      double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num1, (double) num2);
      if (distance > 5.0)
      {
        this.CallInMapMove(num1, num2);
      }
      else
      {
        if (distance > 5.0)
          return;
        if (this.Myself.isMessageBox_Self == 1)
        {
          this.CallMuaKNB();
          this.Myself.KNBStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
        }
        if (this.Myself.isMessageBox_Self == 0 && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.KNBStamp >= 1000L)
          this.Myself.KNBConfirm = false;
        if (!this.Myself.IsMuaKNB || this.Myself.KNBConfirm || this.Myself.isMessageBox_Self != 0 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.KNBStamp < 1000L)
          return;
        this.Myself.KNBStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
        if (this.Myself.KNBTabType == -1)
        {
          if (this.Settings.txtKNB50 > 0)
            this.Myself.KNBTabType = 0;
          else if (this.Settings.txtKNB200 > 0)
            this.Myself.KNBTabType = 1;
          else if (this.Settings.txtKNB500 > 0)
            this.Myself.KNBTabType = 2;
        }
        if (this.Settings.txtKNB500 > 0 && this.Myself.KNBTabType == 2)
        {
          this.CallKNBTab(this.Myself.KNBTabType, this.Myself.DDorDD);
          this.Myself.DDorDD = !this.Myself.DDorDD;
          this.Myself.KNBTabType = -1;
        }
        if (this.Settings.txtKNB200 > 0 && this.Myself.KNBTabType == 1)
        {
          this.CallKNBTab(this.Myself.KNBTabType, this.Myself.DDorDD);
          if (this.Settings.txtKNB500 > 0)
          {
            this.Myself.KNBTabType = 2;
          }
          else
          {
            this.Myself.DDorDD = !this.Myself.DDorDD;
            this.Myself.KNBTabType = -1;
          }
        }
        else
        {
          if (this.Settings.txtKNB50 <= 0 || this.Myself.KNBTabType != 0)
            return;
          this.CallKNBTab(this.Myself.KNBTabType, this.Myself.DDorDD);
          if (this.Settings.txtKNB200 > 0)
            this.Myself.KNBTabType = 1;
          else if (this.Settings.txtKNB500 > 0)
            this.Myself.KNBTabType = 2;
          else
            this.Myself.DDorDD = !this.Myself.DDorDD;
        }
      }
    }
  }

  public void NhiemVuLinhThu()
  {
    bool flag1 = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    if (!flag1 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LinhThuStamp < 300L)
      return;
    this.Myself.LinhThuStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    int num = 158;
    bool flag2 = this.Myself.MapID == num;
    if (!flag2 && !GA.IsInPhuBan(this.Myself.MapID, this))
      this.CallOutMapMove(100, 200, num);
    if (flag2)
    {
      if (this.Myself.PhoBanVaoMap)
      {
        ++this.Myself.linhthuCounter;
        GA.WriteUserLog(frmMain.langCompleteLinhThu, this, (object) this.Myself.linhthuCounter);
        frmMain.ResetPhoBan(this);
      }
      this.PhuBanATAB(num, 402102, -1, frmLogin.GAuto.Settings.LinhThuNames, 0);
    }
    if (!GA.IsInPhuBan(this.Myself.MapID, this))
      return;
    this.Myself.PhoBanVaoMap = true;
    this.PhuBanATAB(num, 402102, -1, frmLogin.GAuto.Settings.LinhThuNames, 0);
    if (this.MyQuai.TargetID != -1)
    {
      this.Myself.LastNullTargetStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    }
    else
    {
      if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LastNullTargetStamp < 3000L)
        return;
      this.CallInMapMove(89, 64 /*0x40*/);
      this.Myself.LastNullTargetStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    }
  }

  public void NhiemVuTangKinhCac()
  {
    bool flag1 = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    if (!flag1 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.TangKinhCacStamp < 300L)
      return;
    this.Myself.TangKinhCacStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    int cboTkcMaps = this.Settings.cboTKCMaps;
    bool flag2 = this.Myself.MapID == cboTkcMaps;
    if (!flag2 && !GA.IsInPhuBan(this.Myself.MapID, this))
      this.CallOutMapMove(42, 52, cboTkcMaps);
    if (flag2 && cboTkcMaps != 141)
    {
      if (this.Myself.PhoBanVaoMap)
      {
        ++this.Myself.tkcCounter;
        GA.WriteUserLog(frmMain.langCompleteXTKC, this, (object) this.Myself.tkcCounter);
        frmMain.ResetPhoBan(this);
      }
      int menuid = 808042;
      int menuindex = 1;
      if (this.Target.VersionNum == 3)
      {
        menuid = 910120;
        menuindex = 0;
      }
      this.PhuBanATAB(cboTkcMaps, menuid, menuindex, frmLogin.GAuto.Settings.TKCNames, 12);
    }
    if (!GA.IsInPhuBan(this.Myself.MapID, this) && this.Myself.MapID != 141)
      return;
    this.Myself.PhoBanVaoMap = true;
    if (this.Myself.QuestStep == 0)
    {
      Thread.Sleep(1000);
      if (this.Myself.IsTKC && (double) this.Myself.PosY < 100.0 && this.Myself.actionFlag == 0)
      {
        this.Myself.QuestStep = 1;
        this.CallSelectTarget(-1);
      }
      this.ResetEventString();
      this.ResetPacketMsg();
      this.Myself.actionFlag = 0;
      long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
      long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
      while (this.Myself.IsTKC && this.Myself.QuestStep == 0)
      {
        if (this.Myself.actionFlag <= 1)
        {
          this.CallTalkNPCByPos(402108, 1, 64 /*0x40*/, 104);
          ++this.Myself.actionFlag;
        }
        Thread.Sleep(300);
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 >= 1000L)
        {
          this.CallTalkNPCByPos(402108, 1, 64 /*0x40*/, 104);
          elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        }
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 >= 5000L)
        {
          this.Myself.QuestStep = 1;
          this.CallSelectTarget(-1);
          if (this.Settings.cboxTKCNhanh)
          {
            this.Myself.actionFlag = 0;
            this.Myself.InPathPointIndex = 2;
            this.CallMoveFlashPos(99, 57);
            break;
          }
          break;
        }
      }
    }
    if (this.Myself.QuestStep != 1)
      return;
    if (this.Settings.cboxTKCNhanh)
      this.PhuBanTangKinhCac(1102);
    else
      this.PhuBanATAB(1101, 808042, 1, frmLogin.GAuto.Settings.TKCNames, 12);
  }

  public void PhungHoangLangMo()
  {
    bool flag1 = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    if (!flag1 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 300L)
      return;
    this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    int num1 = 443;
    List<string> tenNPC = new List<string>()
    {
      "Mô Kim Hiệu Úy"
    };
    if (this.Myself.MapID != num1 && !GA.IsInPhuBan(this.Myself.MapID, this))
    {
      int num2 = 150;
      int num3 = 152;
      int num4 = 420;
      int num5 = 55;
      int num6 = 403001;
      int menuIndex = 1;
      ++this.Myself.trieutapCounter;
      if (this.Myself.trieutapCounter == 1)
        GA.TrieuTapToMyPos(this, num2, num3, num4);
      else if (this.Myself.trieutapCounter >= 15)
        this.Myself.trieutapCounter = 0;
      if (this.GoToMyPos(num2, num3, num4) && this.CheckMemberGPS(3, num2, num3, num4, num1))
      {
        if (this.Myself.talkCounter == 0)
        {
          this.CallRemovePartyFollow();
          GA.PartyTalkNPC(this, num5, num6, menuIndex);
          this.CallTalkNPC(0, 0, num5);
          Thread.Sleep(300);
          this.CallTalkNPC(num6, menuIndex, num5);
          Thread.Sleep(1500);
          if (this.Myself.isMessageBox_Self == 1)
            this.CallStartAutoMoveClick();
        }
        else
          ++this.Myself.talkCounter;
        if (this.Myself.talkCounter >= 10)
          this.Myself.talkCounter = 0;
      }
      if (this.Myself.MapID == 420)
        this.Myself.previousMapID_2 = 420;
    }
    if (this.Myself.MapID == num1)
    {
      this.Myself.talkCounter = 0;
      if (this.Myself.PhoBanVaoMap)
      {
        ++this.Myself.phlmCounter;
        GA.WriteUserLog(frmMain.langCompleteXPHLM, this, (object) this.Myself.phlmCounter);
        frmMain.ResetPhoBan(this);
      }
      this.PhuBanATAB(num1, 50063, 100, tenNPC);
    }
    if (!GA.IsInPhuBan(this.Myself.MapID, this))
      return;
    this.Myself.PhoBanVaoMap = true;
    bool flag2 = false;
    int num7 = 0;
    int num8 = 0;
    int num9 = 0;
    double num10 = 50.0;
    if (this.Myself.InMapPathPoints.Count > 0 && (this.Myself.InPathPointIndex == this.Myself.InMapPathPoints.Count - 1 || this.Myself.PBEnding || this.Myself.InPathPointIndex == 0))
    {
      if (this.MyQuai.AllQuai.Count > 0)
      {
        try
        {
          for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
          {
            QuaiIndividual quaiIndividual = this.MyQuai.AllQuai[index];
            if (quaiIndividual.Name == "Cao Bạo Đạn" || quaiIndividual.Name == "Nhiên Thiêu Đạn")
            {
              ++num7;
              this.Myself.EventStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
              double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quaiIndividual.PosX, (double) quaiIndividual.PosY);
              if (distance < 5.0 && distance < num10)
              {
                num10 = distance;
                num8 = (int) quaiIndividual.PosX;
                num9 = (int) quaiIndividual.PosY;
              }
            }
          }
        }
        catch (Exception ex)
        {
          GA.WriteUserLog(frmMain.langErrorLookingQuaiPHLM, this);
        }
      }
    }
    if (num7 == 0)
    {
      this.Myself.phubanFlag = 0;
      if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.EventStamp > 2000L && this.Myself.EventStamp != 0L)
      {
        GA.ResetStatusParty(this);
        this.CallRemovePartyFollow();
        if (this.Myself.Status == AllEnums.CharStatuses.GOGOGO)
          this.Myself.Status = AllEnums.CharStatuses.IDLE;
      }
      this.PhuBanATAB(num1, 50063, 100, tenNPC);
    }
    else if (num7 <= 3)
    {
      if (num8 > 0 && num9 > 0)
        flag2 = true;
      else
        GA.TrieuTapCaNhom(this, true);
    }
    else if (num7 > 3)
    {
      List<int> intList1 = new List<int>() { 38 };
      List<int> intList2 = new List<int>() { 73 };
      double num11 = 50.0;
      int num12 = 0;
      int num13 = 0;
      int mapId = this.Myself.MapID;
      for (int index = 0; index <= 0; ++index)
      {
        double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) intList1[index], (double) intList2[index]);
        if (distance < num11)
        {
          num12 = intList1[index];
          num13 = intList2[index];
          num11 = distance;
        }
      }
      if (num11 <= 2.5 && num8 > 0 && num9 > 0)
        flag2 = true;
      if (num12 > 0 && num13 > 0 && !flag2)
      {
        this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
        this.CallSelectTarget(-1);
        this.CallRequestPartyFollow();
        this.CallMoveFlashPos(num12, num13);
        GA.TrieuTapToMyPos(this, num12, num13, mapId);
      }
    }
    if (!flag2)
      return;
    if (this.Myself.phubanFlag == 0)
    {
      List<int> intList3 = new List<int>()
      {
        num8 + 6,
        num8 - 6,
        num8,
        num8
      };
      List<int> intList4 = new List<int>()
      {
        num9,
        num9,
        num9 + 6,
        num9 - 6
      };
      ++this.Myself.phubanFlag;
      double num14 = 50.0;
      if (num7 > 3)
      {
        this.Myself.TargetX = (float) intList3[1];
        this.Myself.TargetY = (float) intList4[1];
      }
      else
      {
        for (int index = 0; index <= 3; ++index)
        {
          double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) intList3[index], (double) intList4[index]);
          if (distance < num14 && intList3[index] >= 38 && intList3[index] <= 89 && intList4[index] >= 48 /*0x30*/ && intList4[index] <= 94)
          {
            num14 = distance;
            this.Myself.TargetX = (float) intList3[index];
            this.Myself.TargetY = (float) intList4[index];
          }
        }
      }
    }
    this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
    this.CallSelectTarget(-1);
    if (num7 > 3)
      this.CallRequestPartyFollow();
    this.CallMoveFlashPos((int) this.Myself.TargetX, (int) this.Myself.TargetY);
    GA.TrieuTapToMyPos(this, (int) this.Myself.TargetX, (int) this.Myself.TargetY, this.Myself.MapID);
  }

  public void NhiemVuKyCuoc()
  {
    bool flag1 = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    if (!flag1 || this.Myself.DiPhuBanStamp >= this.nowStamp())
      return;
    int num1 = 300;
    this.Myself.DiPhuBanStamp = this.nowStamp() + (long) num1;
    if (!GA.IsInPhuBan(this.Myself.MapID, this))
    {
      int num2 = 366;
      int num3 = 228;
      int num4 = 0;
      int NPCID = 142;
      int menuTypeID1 = 401001;
      int menuIndex1 = -1;
      if (this.Target.VersionNum == 4)
      {
        num2 = 269;
        num3 = 88;
      }
      this.Myself.phubanFlag = 0;
      this.MyFlag.phubanActionCounter = 0;
      this.ResetPacketMsg();
      ++this.Myself.trieutapCounter;
      if (this.Myself.trieutapCounter == 1)
        GA.TrieuTapToMyPos(this, num2, num3, num4);
      else if (this.Myself.trieutapCounter >= 15)
        this.Myself.trieutapCounter = 0;
      if (this.GoToMyPos(num2, num3, num4))
      {
        this.CheckMemberGPS(3, num2, num3, num4);
        if (this.Myself.talkCounter == 0)
        {
          this.CallTalkNPC(0, 0, NPCID);
          this.waitQuestFrameShow();
          if (GA.CheckGameVersion(this.Target.VersionNum) == 356)
          {
            int menuIndex2 = 110;
            this.CallTalkNPC(menuTypeID1, menuIndex2, NPCID);
            Thread.Sleep(1500);
            int menuTypeID2 = 90;
            int menuIndex3 = 113;
            if (this.Settings.cboxKyCuocNhanh)
              menuIndex3 = 112 /*0x70*/;
            this.CallTalkNPC(menuTypeID2, menuIndex3, NPCID);
          }
          else
          {
            this.CallTalkNPC(menuTypeID1, menuIndex1, NPCID);
            Thread.Sleep(1500);
            if (this.Myself.isMessageBox_Self == 1)
              this.CallStartAutoMoveClick();
          }
        }
        else
          ++this.Myself.talkCounter;
        if (this.Myself.talkCounter >= 5)
          this.Myself.talkCounter = 0;
      }
    }
    if (!GA.IsInPhuBan(this.Myself.MapID, this))
      return;
    if (this.Myself.PacketMsg == "KCKT")
    {
      if (this.MyFlag.tempStamp == 0L)
        this.MyFlag.tempStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
      if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.tempStamp <= 5000L)
        return;
      int num5 = 40;
      int num6 = 40;
      if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num5, (double) num6) > 3.0)
      {
        this.CallMoveTo(num5, num6);
      }
      else
      {
        this.CallRemovePartyFollow();
        QuaiIndividual quaiIndividual = this.SearchNPCByPos(num5, num6, 5);
        if (quaiIndividual == null)
        {
          this.CallMoveTo((int) this.Myself.PosX, (int) this.Myself.PosY);
        }
        else
        {
          int id = quaiIndividual.ID;
          int num7 = 44000;
          int menuIndex = 0;
          GA.PartyTalkNPC(this, id, num7, menuIndex);
          if (this.CheckMemberRangeMin() < 10.0)
            return;
          this.CallTalkNPC(0, 0, id);
          Thread.Sleep(700);
          this.CallTalkNPC(num7, menuIndex, id);
          Thread.Sleep(700);
        }
      }
    }
    else
    {
      if (this.MyFlag.phubanActionCounter <= 1)
      {
        this.CallRemovePartyFollow();
        this.CallXuongNgua();
        GA.PartyDoSomething(this, true, 2);
        this.MyFlag.phubanActionCounter += 5;
      }
      if (this.MyQuai.AllQuai.Count > 0)
      {
        QuaiIndividual quaiIndividual = (QuaiIndividual) null;
        try
        {
          for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
          {
            QuaiIndividual quai = this.MyQuai.AllQuai[index];
            bool flag2 = true;
            if (this.HasActivePet())
            {
              if (quai.ID != this.MyPet.AllPets[this.MyPet.ActivePetIndex].ID)
                flag2 = false;
            }
            else
              flag2 = false;
            if (quai.ID >= 0 && (double) quai.HPPercent > 0.0 && quai.ID != this.Myself.ID && !flag2 && this.CanAttack(quai))
            {
              quaiIndividual = quai;
              this.CallSelectTarget(quaiIndividual.ID);
            }
          }
        }
        catch (Exception ex)
        {
          GA.WriteUserLog(frmMain.langErrorLookforQuai2, this);
        }
        if (quaiIndividual == null)
        {
          if (this.Myself.hetquaiStamp == 1L)
            this.Myself.hetquaiStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
        }
        else
        {
          double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quaiIndividual.PosX, (double) quaiIndividual.PosY);
          if (this.Settings.cboxDanhQuai)
          {
            bool flag3 = false;
            double posX = (double) quaiIndividual.PosX;
            double posY = (double) quaiIndividual.PosY;
            if (distance > 4.0 && !flag3)
              this.CallMoveFlashPos((int) quaiIndividual.PosX, (int) quaiIndividual.PosY);
            else
              this.AttackQuai();
          }
          else
            this.CallMoveFlashPos((int) quaiIndividual.PosX, (int) quaiIndividual.PosY);
          this.Myself.hetquaiStamp = 1L;
        }
      }
      else if (this.Myself.hetquaiStamp == 1L)
        this.Myself.hetquaiStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
      if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.hetquaiStamp <= 5000L || this.Myself.hetquaiStamp <= 1L || !(this.Myself.PacketMsg != "KCXQ") || !(this.Myself.PacketMsg != "KCKT"))
        return;
      List<int> intList1 = new List<int>()
      {
        45,
        82,
        82,
        45
      };
      List<int> intList2 = new List<int>()
      {
        82,
        45,
        82,
        45
      };
      int phubanFlag = this.Myself.phubanFlag;
      if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) intList1[phubanFlag], (double) intList2[phubanFlag]) > 3.0)
      {
        this.CallMoveTo(intList1[phubanFlag], intList2[phubanFlag]);
      }
      else
      {
        ++this.Myself.phubanFlag;
        if (this.Myself.phubanFlag < 4)
          return;
        this.Myself.phubanFlag = 0;
      }
    }
  }

  public void NhiemVuCauPhuc()
  {
    bool flag1 = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    if (!flag1 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 100L)
      return;
    this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    if (this.Myself.MapID != 2)
      return;
    this.FuncHuyItem();
    this.CleanUpInventory();
    bool flag2 = false;
    if (this.Myself.NhiemVuQuaiID <= 0)
    {
      bool flag3 = false;
      if (!this.Myself.NhiemVuFinish)
      {
        if (this.MyQuai.AllQuai.Count > 0)
        {
          try
          {
            for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
            {
              QuaiIndividual quaiIndividual = this.MyQuai.AllQuai[index];
              if (quaiIndividual.Name.Contains("iên Cun") || quaiIndividual.Name.Contains("ầu Phú") || quaiIndividual.IsBossValue >= 14410 && quaiIndividual.IsBossValue <= 14437)
              {
                this.Myself.NhiemVuQuaiID = quaiIndividual.ID;
                while (this.IsAIEnabled)
                {
                  this.CallMoveTo((int) quaiIndividual.PosX, (int) quaiIndividual.PosY);
                  if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) (int) quaiIndividual.PosX, (double) (int) quaiIndividual.PosY) >= 2.5)
                    Thread.Sleep(200);
                  else
                    break;
                }
                this.Myself.ActionStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                flag3 = true;
                break;
              }
            }
            if (this.Myself.NhiemVuQuaiID <= 0)
              GA.ShowBalloon(frmMain.langThaCau, frmMain.langNotFoundCau, this, 10000);
          }
          catch (Exception ex)
          {
            GA.WriteUserLog(frmMain.langErrorFoundCau, this);
          }
        }
      }
      if (!flag3)
      {
        NewBoc newBoc = (NewBoc) null;
        if (this.MyBoc.AllBocs.Count > 0)
        {
          try
          {
            for (int index = this.MyBoc.AllBocs.Count - 1; index >= 0; --index)
            {
              NewBoc allBoc = this.MyBoc.AllBocs[index];
              if (allBoc.BocType == 807 && allBoc.BocID != 0)
              {
                newBoc = allBoc;
                this.Myself.NhiemVuFinish = true;
                break;
              }
            }
          }
          catch (Exception ex)
          {
            GA.WriteUserLog(frmMain.langErrorFoundCauPhuc, this);
          }
        }
        if (newBoc == null)
        {
          this.ResetEventString();
          this.Myself.NhiemVuFinish = false;
        }
        else if (this.Settings.cboxTuNhatVatPham)
        {
          flag2 = true;
          this.NhatBoc(807);
        }
      }
    }
    if (this.Myself.NhiemVuQuaiID <= 0 || flag2)
      return;
    int nhiemVuQuaiId = this.Myself.NhiemVuQuaiID;
    int menuTypeID = 2107;
    int menuIndex1 = 1;
    bool flag4 = false;
    if (this.Myself.QuestStep == 0)
    {
      this.CallTalkNPC(0, 0, nhiemVuQuaiId);
      Thread.Sleep(350);
      if (this.Myself.isQuestFrameShow == 1)
        ++this.Myself.QuestStep;
    }
    if (this.Myself.QuestStep == 1 && this.Myself.PacketMsg != "")
    {
      if (this.Myself.PacketMsg == "CPID2")
        menuIndex1 = 2;
      this.CallTalkNPC(menuTypeID, menuIndex1, nhiemVuQuaiId);
      ++this.Myself.QuestStep;
      Thread.Sleep(350);
    }
    if (this.Myself.QuestStep == 2)
    {
      if (this.Myself.isQuestFrameShow == 0)
      {
        flag4 = true;
      }
      else
      {
        for (int menuIndex2 = 102; menuIndex2 <= 152; ++menuIndex2)
        {
          this.CallTalkNPC(menuTypeID, menuIndex2, nhiemVuQuaiId);
          Thread.Sleep(10);
          if (this.Myself.EventString == "CPTC" || this.Myself.PacketMsg == "CPTC" || this.Myself.isQuestFrameShow == 0)
          {
            flag4 = true;
            break;
          }
        }
      }
    }
    if (!flag4 && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.ActionStamp < 2000L)
      return;
    this.Myself.QuestStep = 0;
    this.ResetEventString();
    this.ResetPacketMsg();
    this.Myself.NhiemVuQuaiID = -1;
  }

  public void NhiemVuCauNguyen()
  {
    bool flag = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag = true;
    if (!flag || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 300L)
      return;
    this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    int NPCID = 157;
    int posX = 282;
    int posY = 276;
    int mapID = 1;
    int menuType1 = 808131;
    int menuIndex1_1 = 101;
    if (this.Myself.QuestStep == 0)
    {
      if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.EventStamp >= 2000L)
      {
        this.Myself.EventStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
        this.CallToggleMission();
        Thread.Sleep(500);
        this.CallToggleMission();
        Thread.Sleep(500);
        ++this.Myself.actionCounter;
      }
      if (this.Myself.PacketMsg == "CNVCNR")
      {
        this.Myself.actionCounter = 0;
        this.Myself.QuestStep = 3;
      }
      if (this.Myself.actionCounter >= 1)
      {
        GA.WriteUserLog(frmMain.langThienLinhALT_Q, this);
        this.Myself.QuestStep = 1;
      }
    }
    if (this.Myself.QuestStep == 1)
    {
      this.DungPhuWithMap(1);
      if (this.GoToMyPos(posX, posY, mapID))
      {
        Thread.Sleep(500);
        ++this.Myself.QuestStep;
      }
    }
    if (this.Myself.QuestStep == 2)
    {
      if (!this.Myself.NhiemVuFinish)
      {
        this.CallTalkNPCQuest("CNNQ", 1, menuType1, menuIndex1_1, NPCID);
        if (this.Myself.PacketMsg == "HLCN")
        {
          GA.WriteUserLog(frmMain.langNoMoreCauNguyen, this);
          this.Myself.isCauNguyen = false;
          this.IsAIEnabled = false;
          this.ResetPacketMsg();
          return;
        }
      }
      else
      {
        int menuIndex1_2 = 100;
        if (this.CallTalkNPCQuest("CNTQOK", 2, menuType1, menuIndex1_2, NPCID))
        {
          GA.WriteUserLog(frmMain.langCompleteThienLinh, this);
          this.Myself.isCauNguyen = false;
          this.IsAIEnabled = false;
          this.ResetPacketMsg();
          return;
        }
      }
      ++this.Myself.QuestStep;
    }
    if (this.Myself.QuestStep == 3 && this.GoToMyPos(157, 185, 4))
    {
      Thread.Sleep(500);
      this.CallXuongNgua();
      this.ResetPacketMsg();
      ++this.Myself.QuestStep;
    }
    if (this.Myself.QuestStep != 4)
      return;
    if (this.Myself.ActionStatus != (byte) 5)
    {
      for (int index = 0; index < 30; ++index)
      {
        if (this.MyInventory.AllItems[index].ItemID == 30505255)
        {
          this.CallUseItem(index, this.Myself.ID);
          Thread.Sleep(700);
          break;
        }
      }
    }
    if (!(this.Myself.PacketMsg == "CNNQ") && !(this.Myself.PacketMsg == "KTCN"))
      return;
    this.Myself.NhiemVuFinish = true;
    this.Myself.QuestStep = 1;
  }

  public void NhiemVuDoatBaoRuong()
  {
    bool flag1 = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    if (!flag1 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 300L)
      return;
    this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    List<int> intList = new List<int>()
    {
      29,
      26,
      34,
      444,
      22
    };
    if (this.Myself.QuestStep == 0)
    {
      int num1 = 0;
      int num2 = 0;
      for (int index = 0; index < 30; ++index)
      {
        InventoryItem allItem = this.MyInventory.AllItems[index];
        if (allItem.ItemID == 31100016)
          num1 += (int) allItem.ItemCount;
        if (allItem.ItemID == 31100017)
          num2 += (int) allItem.ItemCount;
      }
      this.Myself.NhiemVuCounter = num2 / 49;
      if (num1 == 0)
        this.Myself.QuestStep = 1;
      else if (num1 >= this.Myself.NhiemVuCounter)
      {
        this.Myself.QuestStep = 3;
      }
      else
      {
        this.Myself.QuestStep = 1;
        for (int index = 0; index < 5; ++index)
        {
          if (this.Myself.MapID == intList[index])
          {
            this.Myself.QuestStep = 3;
            break;
          }
        }
      }
    }
    if (this.Myself.QuestStep == 1)
    {
      if (GA.IsBangMapID(this.Myself.MapID))
      {
        if (this.GoToMyPos(135, 50, this.Myself.MapID))
          ++this.Myself.QuestStep;
      }
      else if (this.IsInCity())
        this.GoToMyBang();
      else
        this.VeThanhMuaDo(false);
    }
    if (this.Myself.QuestStep == 2)
    {
      int menuTypeID = 805028;
      int menuIndex = 101;
      int NPCID = 3;
      this.CallTalkNPC(0, 0, NPCID);
      for (int index = 0; index <= 4; ++index)
      {
        this.CallTalkNPC(menuTypeID, menuIndex, NPCID);
        Thread.Sleep(500);
      }
      ++this.Myself.QuestStep;
    }
    if (this.Myself.QuestStep == 3)
    {
      if (this.Myself.MapID != this.Settings.cboBaoRuongMap)
      {
        bool flag2 = false;
        int itemIndex = 0;
        if (this.Settings.cboxThoLinhChau)
        {
          for (int index = 0; index < 30; ++index)
          {
            InventoryItem allItem = this.MyInventory.AllItems[index];
            if ((allItem.ItemID == 30008007 || allItem.ItemID == 30505216 || allItem.ItemID == 38001079) && allItem.ItemMapID == this.Settings.cboBaoRuongMap && allItem.DinhViPhuTime > (byte) 0)
            {
              if (this.Myself.HorseType != -1)
                this.CallMounting();
              flag2 = true;
              itemIndex = index;
              break;
            }
          }
        }
        else
          ++this.Myself.QuestStep;
        if (flag2)
        {
          this.CallUseItem(itemIndex, this.Myself.ID);
          Thread.Sleep(5000);
        }
        else
          ++this.Myself.QuestStep;
      }
      else
        ++this.Myself.QuestStep;
    }
    if (this.Myself.QuestStep == 4)
    {
      if (GA.IsBangMapID(this.Myself.MapID))
      {
        bool flag3 = false;
        if (this.Settings.cboBaoRuongMap == 29)
        {
          string mapName = GA.GetMapName(this.Myself.MapID);
          if (mapName.Contains("iêu Cươn") || mapName.Contains("am Chiê"))
            flag3 = true;
        }
        else if (this.Settings.cboBaoRuongMap == 26)
        {
          string mapName = GA.GetMapName(this.Myself.MapID);
          if (mapName.Contains("hạch Lâ") || mapName.Contains("hĩ Hả") || mapName.Contains("am Chiê"))
            flag3 = true;
        }
        else if (this.Settings.cboBaoRuongMap == 34)
        {
          if (GA.GetMapName(this.Myself.MapID).Contains("am Vự"))
            flag3 = true;
        }
        else if (this.Settings.cboBaoRuongMap == 444)
        {
          string mapName = GA.GetMapName(this.Myself.MapID);
          if (mapName.Contains("ây Hồ") || mapName.Contains("ong Tuy"))
            flag3 = true;
        }
        else if (this.Settings.cboBaoRuongMap == 22)
        {
          string mapName = GA.GetMapName(this.Myself.MapID);
          if (mapName.Contains("ờng Bạc") || mapName.Contains("oàng Lon"))
            flag3 = true;
        }
        if (flag3)
          this.GoToMyPos(99, 157, this.Myself.MapID);
        else
          this.GoToMyPos(334, 250, 1);
      }
      else
      {
        int num3 = 0;
        int num4 = 0;
        int cboBaoRuongMap = this.Settings.cboBaoRuongMap;
        if (this.Settings.cboBaoRuongMap == 29)
        {
          num3 = 93;
          num4 = 266;
        }
        else if (this.Settings.cboBaoRuongMap == 26)
        {
          num3 = 240 /*0xF0*/;
          num4 = 181;
        }
        else if (this.Settings.cboBaoRuongMap == 34)
        {
          num3 = 116;
          num4 = 59;
        }
        else if (this.Settings.cboBaoRuongMap == 444)
        {
          num3 = 261;
          num4 = 170;
        }
        else if (this.Settings.cboBaoRuongMap == 22)
        {
          num3 = 234;
          num4 = 78;
        }
        this.CallSetUpNhiemVuData(num3, num4);
        if ((!this.Settings.cboxBRXaPhu || this.DiXaPhu(cboBaoRuongMap)) && this.GoToMyPos(num3, num4, cboBaoRuongMap))
          ++this.Myself.QuestStep;
      }
    }
    if (this.Myself.QuestStep != 5)
      return;
    NewBoc newBoc = (NewBoc) null;
    if (this.MyBoc.AllBocs.Count > 0)
    {
      try
      {
        for (int index = this.MyBoc.AllBocs.Count - 1; index >= 0; --index)
        {
          NewBoc allBoc = this.MyBoc.AllBocs[index];
          if (allBoc.BocType == 799 && allBoc.BocID != 0)
          {
            newBoc = allBoc;
            break;
          }
        }
      }
      catch (Exception ex)
      {
      }
    }
    if (newBoc != null || !this.Settings.cboxNhanHop || !this.GoToMyPos(this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY, this.Myself.MapID))
      return;
    this.CallTalkNPCByPos(50248, 1, (int) this.Myself.PosX, (int) this.Myself.PosY);
    Thread.Sleep(200);
    this.CallTalkNPCByPos(50248, 1, (int) this.Myself.PosX, (int) this.Myself.PosY, false);
    Thread.Sleep(200);
    this.CallTalkNPCByPos(50248, 101, (int) this.Myself.PosX, (int) this.Myself.PosY, false);
  }

  public void NhiemVuCheDo()
  {
    bool flag1 = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    if (!flag1 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 500L)
      return;
    this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    int num1 = 2;
    int numCheDoSlmua = this.Settings.numCheDoSLmua;
    string cboCheDoDtd = this.Settings.cboCheDoDTD;
    string oldValue = "Cấp ";
    if (this.Target.SubVersion == 12)
      oldValue = "Level ";
    string s = cboCheDoDtd.Replace(oldValue, "");
    int result = 0;
    int.TryParse(s, out result);
    string cboItemCheDo = this.Settings.cboItemCheDo;
    int NPCID = 187;
    int num2 = 186;
    int num3 = 351;
    int num4 = 250;
    int num5 = 347;
    int num6 = 250;
    int cboCheDoMap = this.Settings.cboCheDoMap;
    if (this.Settings.cboCheDoMap == 0)
    {
      if (this.Target.SubVersion == 1 || this.Target.SubVersion == 8 || this.Target.SubVersion == 2 || this.Target.SubVersion == 10 || this.Target.SubVersion == 13 || this.Target.SubVersion == 14)
      {
        NPCID = 59;
        num2 = 13;
      }
      if (GA.ClientVersion(this) == 10)
      {
        num3 = 254;
        num4 = 108;
        num5 = 251;
        num6 = 108;
      }
    }
    if (this.Settings.cboCheDoMap == 2)
    {
      NPCID = 7;
      num2 = 107;
      num3 = 205;
      num4 = 179;
      num5 = 202;
      num6 = 179;
      if (this.Target.SubVersion == 8 || this.Target.SubVersion == 13)
      {
        NPCID = 70;
        num2 = 19;
      }
      else if (this.Target.SubVersion == 1)
      {
        NPCID = 2;
        num2 = 160 /*0xA0*/;
        num3 = 327;
        num4 = 272;
        num5 = 324;
        num6 = 272;
      }
      else if (this.Target.SubVersion == 2)
      {
        NPCID = 2;
        num2 = 160 /*0xA0*/;
        num3 = 205;
        num4 = 171;
        num5 = 199;
        num6 = 171;
      }
    }
    if (this.Settings.cboCheDoMap == 1)
    {
      NPCID = 19;
      num2 = 114;
      num3 = 186;
      num4 = 274;
      num5 = 186;
      num6 = 277;
      if (this.Target.SubVersion == 8 || this.Target.SubVersion == 13)
      {
        NPCID = 48 /*0x30*/;
        num2 = 21;
      }
      else if (this.Target.SubVersion == 1 || this.Target.SubVersion == 2)
      {
        NPCID = 20;
        num2 = 142;
      }
    }
    if (this.Settings.cboCheDoMap == 186)
    {
      NPCID = 9;
      num2 = 10;
      num3 = 217;
      num4 = 128 /*0x80*/;
      num5 = 217;
      num6 = 124;
    }
    if (this.Myself.QuestStep == 0)
    {
      bool flag2;
      if (this.Target.SubVersion == 4 && num1 == 2)
      {
        num5 = 202;
        num6 = 179;
        flag2 = true;
      }
      else
        flag2 = this.GoToMyPos(num5, num6, cboCheDoMap);
      if (flag2)
      {
        if (this.Target.SubVersion != 4 || num1 != 2)
          this.CallMoveTo(num5, num6);
        if (this.Myself.Status == AllEnums.CharStatuses.GOGOGO)
          this.Myself.Status = AllEnums.CharStatuses.IDLE;
        ++this.Myself.QuestStep;
      }
    }
    if (this.Myself.QuestStep == 1)
    {
      int num7 = 0;
      int num8 = 0;
      int indexMenu = 6;
      int indexSubMenu = -1;
      int indexItem = -1;
      if (this.Target.SubVersion == 8 || this.Target.SubVersion == 1 || this.Target.SubVersion == 2 || this.Target.SubVersion == 9 || this.Target.SubVersion == 10 || this.Target.SubVersion == 11 || this.Target.SubVersion == 14 || this.Target.SubVersion == 15 || this.Target.SubVersion == 16 /*0x10*/ || this.Target.SubVersion == 18)
        indexMenu = 8;
      else if (this.Target.SubVersion == 13)
        indexMenu = 7;
      switch (cboItemCheDo)
      {
        case "Nón":
        case "Hat":
          indexSubMenu = 4;
          switch (result)
          {
            case 3:
              num7 = 20308063;
              indexItem = 4;
              break;
            case 4:
              num7 = 20308064;
              indexItem = 6;
              break;
            case 5:
              num7 = 20308065;
              indexItem = 8;
              break;
            case 6:
              num7 = 20308066;
              indexItem = 10;
              break;
            case 7:
              num7 = 20308067;
              indexItem = 12;
              break;
            case 8:
              num7 = 20308068;
              indexItem = 14;
              break;
            case 9:
              num7 = 20308069;
              indexItem = 16 /*0x10*/;
              break;
            case 10:
              num7 = 20308070;
              indexItem = 18;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 19;
                break;
              }
              break;
          }
          break;
        case "Y Phục":
        case "Garments":
          indexSubMenu = 4;
          switch (result)
          {
            case 3:
              num7 = 20308073;
              indexItem = 5;
              break;
            case 4:
              num7 = 20308074;
              indexItem = 7;
              break;
            case 5:
              num7 = 20308075;
              indexItem = 9;
              break;
            case 6:
              num7 = 20308076;
              indexItem = 11;
              break;
            case 7:
              num7 = 20308077;
              indexItem = 13;
              break;
            case 8:
              num7 = 20308078;
              indexItem = 15;
              break;
            case 9:
              num7 = 20308079;
              indexItem = 17;
              break;
            case 10:
              num7 = 20308080;
              indexItem = 19;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 21;
                break;
              }
              break;
          }
          break;
        case "Hộ Thủ":
        case "Gloves":
          indexSubMenu = 5;
          switch (result)
          {
            case 3:
              num7 = 20308083;
              indexItem = 4;
              break;
            case 4:
              num7 = 20308084;
              indexItem = 6;
              break;
            case 5:
              num7 = 20308085;
              indexItem = 8;
              break;
            case 6:
              num7 = 20308086;
              indexItem = 10;
              break;
            case 7:
              num7 = 20308087;
              indexItem = 12;
              break;
            case 8:
              num7 = 20308088;
              indexItem = 14;
              break;
            case 9:
              num7 = 20308089;
              indexItem = 16 /*0x10*/;
              break;
            case 10:
              num7 = 20308090;
              indexItem = 18;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 19;
                break;
              }
              break;
          }
          break;
        case "Hài":
        case "Shoes":
          indexSubMenu = 5;
          switch (result)
          {
            case 3:
              num7 = 20308093;
              indexItem = 5;
              break;
            case 4:
              num7 = 20308094;
              indexItem = 7;
              break;
            case 5:
              num7 = 20308095;
              indexItem = 9;
              break;
            case 6:
              num7 = 20308096;
              indexItem = 11;
              break;
            case 7:
              num7 = 20308097;
              indexItem = 13;
              break;
            case 8:
              num7 = 20308098;
              indexItem = 15;
              break;
            case 9:
              num7 = 20308099;
              indexItem = 17;
              break;
            case 10:
              num7 = 20308100;
              indexItem = 19;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 21;
                break;
              }
              break;
          }
          break;
        case "Hộ Uyển":
        case "Wristbands":
          indexSubMenu = 6;
          switch (result)
          {
            case 3:
              num7 = 20308133;
              indexItem = 4;
              break;
            case 4:
              num7 = 20308134;
              indexItem = 6;
              break;
            case 5:
              num7 = 20308135;
              indexItem = 8;
              break;
            case 6:
              num7 = 20308136;
              indexItem = 10;
              break;
            case 7:
              num7 = 20308137;
              indexItem = 12;
              break;
            case 8:
              num7 = 20308138;
              indexItem = 14;
              break;
            case 9:
              num7 = 20308139;
              indexItem = 16 /*0x10*/;
              break;
            case 10:
              num7 = 20308140;
              indexItem = 18;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 19;
                break;
              }
              break;
          }
          break;
        case "Hộ Kiên":
        case "Shoulderpad":
          indexSubMenu = 6;
          switch (result)
          {
            case 3:
              num7 = 20308143;
              indexItem = 5;
              break;
            case 4:
              num7 = 20308144;
              indexItem = 7;
              break;
            case 5:
              num7 = 20308145;
              indexItem = 9;
              break;
            case 6:
              num7 = 20308146;
              indexItem = 11;
              break;
            case 7:
              num7 = 20308147;
              indexItem = 13;
              break;
            case 8:
              num7 = 20308148;
              indexItem = 15;
              break;
            case 9:
              num7 = 20308149;
              indexItem = 17;
              break;
            case 10:
              num7 = 20308150;
              indexItem = 19;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 21;
                break;
              }
              break;
          }
          break;
        case "Yêu Đái":
        case "Belt":
          indexSubMenu = 7;
          switch (result)
          {
            case 3:
              num7 = 20308153;
              indexItem = 4;
              break;
            case 4:
              num7 = 20308154;
              indexItem = 6;
              break;
            case 5:
              num7 = 20308155;
              indexItem = 8;
              break;
            case 6:
              num7 = 20308156;
              indexItem = 10;
              break;
            case 7:
              num7 = 20308157;
              indexItem = 12;
              break;
            case 8:
              num7 = 20308158;
              indexItem = 14;
              break;
            case 9:
              num7 = 20308159;
              indexItem = 16 /*0x10*/;
              break;
            case 10:
              num7 = 20308160;
              indexItem = 18;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 19;
                break;
              }
              break;
          }
          break;
        case "Hạng Liên":
        case "Necklace":
          indexSubMenu = 7;
          switch (result)
          {
            case 3:
              num7 = 20308103;
              indexItem = 5;
              break;
            case 4:
              num7 = 20308104;
              indexItem = 7;
              break;
            case 5:
              num7 = 20308105;
              indexItem = 9;
              break;
            case 6:
              num7 = 20308106;
              indexItem = 11;
              break;
            case 7:
              num7 = 20308107;
              indexItem = 13;
              break;
            case 8:
              num7 = 20308108;
              indexItem = 15;
              break;
            case 9:
              num7 = 20308109;
              indexItem = 17;
              break;
            case 10:
              num7 = 20308110;
              indexItem = 19;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 21;
                break;
              }
              break;
          }
          break;
        case "Giới Chỉ":
        case "Ring":
          indexSubMenu = 8;
          switch (result)
          {
            case 3:
              num7 = 20308113;
              indexItem = 4;
              break;
            case 4:
              num7 = 20308114;
              indexItem = 6;
              break;
            case 5:
              num7 = 20308115;
              indexItem = 8;
              break;
            case 6:
              num7 = 20308116;
              indexItem = 10;
              break;
            case 7:
              num7 = 20308117;
              indexItem = 12;
              break;
            case 8:
              num7 = 20308118;
              indexItem = 14;
              break;
            case 9:
              num7 = 20308119;
              indexItem = 16 /*0x10*/;
              break;
            case 10:
              num7 = 20308120;
              indexItem = 18;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 19;
                break;
              }
              break;
          }
          break;
        case "Hộ Phù":
        case "Amulet":
          indexSubMenu = 8;
          switch (result)
          {
            case 3:
              num7 = 20308123;
              indexItem = 5;
              break;
            case 4:
              num7 = 20308124;
              indexItem = 7;
              break;
            case 5:
              num7 = 20308125;
              indexItem = 9;
              break;
            case 6:
              num7 = 20308126;
              indexItem = 11;
              break;
            case 7:
              num7 = 20308127;
              indexItem = 13;
              break;
            case 8:
              num7 = 20308128;
              indexItem = 15;
              break;
            case 9:
              num7 = 20308129;
              indexItem = 17;
              break;
            case 10:
              num7 = 20308130;
              indexItem = 19;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 21;
                break;
              }
              break;
          }
          break;
        case "Đao Phủ":
        case "Falchion":
          indexSubMenu = 1;
          switch (result)
          {
            case 3:
              num7 = 20308003;
              indexItem = 4;
              break;
            case 4:
              num7 = 20308004;
              indexItem = 6;
              break;
            case 5:
              num7 = 20308005;
              indexItem = 8;
              break;
            case 6:
              num7 = 20308006;
              indexItem = 10;
              break;
            case 7:
              num7 = 20308007;
              indexItem = 12;
              break;
            case 8:
              num7 = 20308008;
              indexItem = 14;
              break;
            case 9:
              num7 = 20308009;
              indexItem = 16 /*0x10*/;
              break;
            case 10:
              num7 = 20308010;
              indexItem = 18;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 19;
                break;
              }
              break;
          }
          break;
        case "Thương Bổng":
        case "Spear":
          indexSubMenu = 1;
          switch (result)
          {
            case 3:
              num7 = 20308013;
              indexItem = 5;
              break;
            case 4:
              num7 = 20308014;
              indexItem = 7;
              break;
            case 5:
              num7 = 20308015;
              indexItem = 9;
              break;
            case 6:
              num7 = 20308016;
              indexItem = 11;
              break;
            case 7:
              num7 = 20308017;
              indexItem = 13;
              break;
            case 8:
              num7 = 20308018;
              indexItem = 15;
              break;
            case 9:
              num7 = 20308019;
              indexItem = 17;
              break;
            case 10:
              num7 = 20308020;
              indexItem = 19;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 21;
                break;
              }
              break;
          }
          break;
        case "Đơn Đoản":
        case "One-handed":
          indexSubMenu = 2;
          switch (result)
          {
            case 3:
              num7 = 20308023;
              indexItem = 4;
              break;
            case 4:
              num7 = 20308024;
              indexItem = 6;
              break;
            case 5:
              num7 = 20308025;
              indexItem = 8;
              break;
            case 6:
              num7 = 20308026;
              indexItem = 10;
              break;
            case 7:
              num7 = 20308027;
              indexItem = 12;
              break;
            case 8:
              num7 = 20308028;
              indexItem = 14;
              break;
            case 9:
              num7 = 20308029;
              indexItem = 16 /*0x10*/;
              break;
            case 10:
              num7 = 20308030;
              indexItem = 18;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 19;
                break;
              }
              break;
          }
          break;
        case "Song Đoản":
        case "Two-handed":
          indexSubMenu = 2;
          switch (result)
          {
            case 3:
              num7 = 20308033;
              indexItem = 5;
              break;
            case 4:
              num7 = 20308034;
              indexItem = 7;
              break;
            case 5:
              num7 = 20308035;
              indexItem = 9;
              break;
            case 6:
              num7 = 20308036;
              indexItem = 11;
              break;
            case 7:
              num7 = 20308037;
              indexItem = 13;
              break;
            case 8:
              num7 = 20308038;
              indexItem = 15;
              break;
            case 9:
              num7 = 20308039;
              indexItem = 17;
              break;
            case 10:
              num7 = 20308040;
              indexItem = 19;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 21;
                break;
              }
              break;
          }
          break;
        case "Phiến":
        case "Fans":
          indexSubMenu = 3;
          switch (result)
          {
            case 3:
              num7 = 20308043;
              indexItem = 4;
              break;
            case 4:
              num7 = 20308044;
              indexItem = 6;
              break;
            case 5:
              num7 = 20308045;
              indexItem = 8;
              break;
            case 6:
              num7 = 20308046;
              indexItem = 10;
              break;
            case 7:
              num7 = 20308047;
              indexItem = 12;
              break;
            case 8:
              num7 = 20308048;
              indexItem = 14;
              break;
            case 9:
              num7 = 20308049;
              indexItem = 16 /*0x10*/;
              break;
            case 10:
              num7 = 20308050;
              indexItem = 18;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 19;
                break;
              }
              break;
          }
          break;
        case "Hoàn":
        case "Circle":
          indexSubMenu = 3;
          switch (result)
          {
            case 3:
              num7 = 20308053;
              indexItem = 5;
              break;
            case 4:
              num7 = 20308054;
              indexItem = 7;
              break;
            case 5:
              num7 = 20308055;
              indexItem = 9;
              break;
            case 6:
              num7 = 20308056;
              indexItem = 11;
              break;
            case 7:
              num7 = 20308057;
              indexItem = 13;
              break;
            case 8:
              num7 = 20308058;
              indexItem = 15;
              break;
            case 9:
              num7 = 20308059;
              indexItem = 17;
              break;
            case 10:
              num7 = 20308060;
              indexItem = 19;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 21;
                break;
              }
              break;
          }
          break;
      }
      for (int index = 30; index < 60; ++index)
      {
        InventoryItem allItem = this.MyInventory.AllItems[index];
        if (allItem.ItemID == num7)
          num8 += (int) allItem.ItemCount;
      }
      if (num8 >= 10)
      {
        ++this.Myself.QuestStep;
      }
      else
      {
        if (this.Target.SubVersion == 0)
        {
          GA.ShowBalloon(frmMain.langNotSupportCrafting, frmMain.langWaringSetup, this, 10000);
          return;
        }
        if (this.Target.SubVersion == 11 || this.Target.SubVersion == 15)
        {
          GA.ShowBalloon(frmMain.langNotRightDaTaoDo, frmMain.langWaringSetup, this, 10000);
          return;
        }
        if (indexSubMenu >= 0)
          this.OpenKNBShop(indexMenu, indexSubMenu);
        int num9 = numCheDoSlmua - num8;
        for (int index = 0; index <= num9; ++index)
        {
          this.BuyKNBItem(indexItem, this.Myself.MapID);
          Thread.Sleep(80 /*0x50*/);
        }
      }
    }
    if (this.Myself.QuestStep == 2)
    {
      int num10 = 0;
      int indexMenu = 4;
      int indexSubMenu = 2;
      if (this.Target.SubVersion == 1)
        indexSubMenu = 1;
      else if (this.Target.SubVersion == 8)
      {
        indexMenu = 2;
        indexSubMenu = 5;
      }
      else if (this.Target.SubVersion == 9)
      {
        indexMenu = 2;
        indexSubMenu = 7;
      }
      else if (this.Target.SubVersion == 11 || this.Target.SubVersion == 13)
        indexSubMenu = 1;
      else if (this.Target.SubVersion == 14)
        indexSubMenu = 3;
      else if (this.Target.SubVersion == 15)
      {
        indexMenu = 1;
        indexSubMenu = 1;
      }
      else
      {
        int subVersion = this.Target.SubVersion;
      }
      int indexItem;
      int num11;
      switch (cboItemCheDo)
      {
        case "Đao Phủ":
        case "Thương Bổng":
        case "Đơn Đoản":
        case "Song Đoản":
        case "Phiến":
        case "Hoàn":
        case "Falchion":
        case "Spear":
        case "One-handed":
        case "Two-handed":
        case "Fans":
        case "Circle":
          if (this.Settings.numCheDoChiSo > 0)
            GA.ShowBalloon(frmMain.langCheVuKhiWarning, frmMain.langWaringSetup, this, 300000);
          indexItem = 2;
          num11 = 20500004;
          if (this.Target.SubVersion == 1)
          {
            GA.WriteUserLog(frmMain.langNotFoundTinhThiet, this);
            break;
          }
          if (this.Target.SubVersion == 2)
          {
            indexItem = 1;
            num11 = 20500005;
            break;
          }
          if (this.Target.SubVersion == 8)
          {
            indexItem = 9;
            break;
          }
          if (this.Target.SubVersion == 9)
          {
            indexItem = 1;
            break;
          }
          if (this.Target.SubVersion == 10)
          {
            indexItem = 3;
            num11 = 20500005;
            break;
          }
          if (this.Target.SubVersion == 11 || this.Target.SubVersion == 15)
          {
            GA.WriteUserLog(frmMain.langNotFoundTinhThiet, this);
            break;
          }
          if (this.Target.SubVersion == 13)
          {
            indexItem = 7;
            num11 = 20500006;
            break;
          }
          if (this.Target.SubVersion == 14)
          {
            indexItem = 1;
            num11 = 20500008;
            break;
          }
          if (this.Target.SubVersion == 16 /*0x10*/ || this.Target.SubVersion == 18)
          {
            indexItem = 14;
            num11 = 20500005;
            break;
          }
          break;
        case "Hạng Liên":
        case "Giới Chỉ":
        case "Hộ Phù":
        case "Necklace":
        case "Ring":
        case "Amulet":
          indexItem = 0;
          num11 = 20502004;
          if (this.Target.SubVersion == 1)
          {
            indexItem = 2;
            break;
          }
          if (this.Target.SubVersion == 2)
          {
            indexItem = 3;
            num11 = 20502005;
            break;
          }
          if (this.Target.SubVersion == 8)
          {
            indexItem = 11;
            break;
          }
          if (this.Target.SubVersion == 9)
          {
            indexItem = 5;
            break;
          }
          if (this.Target.SubVersion == 10)
          {
            indexItem = 5;
            num11 = 20502005;
            break;
          }
          if (this.Target.SubVersion == 11)
          {
            indexItem = 11;
            num11 = 20502003;
            break;
          }
          if (this.Target.SubVersion == 13)
          {
            indexItem = 9;
            num11 = 20502006;
            break;
          }
          if (this.Target.SubVersion == 14)
          {
            indexItem = 3;
            num11 = 20502003;
            break;
          }
          if (this.Target.SubVersion == 15)
          {
            indexItem = 25;
            num11 = 20502004;
            break;
          }
          if (this.Target.SubVersion == 16 /*0x10*/ || this.Target.SubVersion == 18)
          {
            indexItem = 18;
            num11 = 20502005;
            break;
          }
          break;
        default:
          indexItem = 1;
          num11 = 20501004;
          if (this.Target.SubVersion == 1)
          {
            indexItem = 3;
            break;
          }
          if (this.Target.SubVersion == 2)
          {
            indexItem = 2;
            num11 = 20501005;
            break;
          }
          if (this.Target.SubVersion == 8)
          {
            indexItem = 10;
            break;
          }
          if (this.Target.SubVersion == 9)
          {
            indexItem = 3;
            break;
          }
          if (this.Target.SubVersion == 10)
          {
            indexItem = 4;
            num11 = 20501005;
            break;
          }
          if (this.Target.SubVersion == 11)
          {
            indexItem = 10;
            num11 = 20501003;
            break;
          }
          if (this.Target.SubVersion == 13)
          {
            indexItem = 8;
            num11 = 20501006;
            break;
          }
          if (this.Target.SubVersion == 14)
          {
            indexItem = 2;
            num11 = 20501003;
            break;
          }
          if (this.Target.SubVersion == 15)
          {
            indexItem = 29;
            num11 = 20501004;
            break;
          }
          if (this.Target.SubVersion == 16 /*0x10*/ || this.Target.SubVersion == 18)
          {
            indexItem = 16 /*0x10*/;
            num11 = 20501005;
            break;
          }
          break;
      }
      for (int index = 30; index < 60; ++index)
      {
        InventoryItem allItem = this.MyInventory.AllItems[index];
        if (allItem.ItemID >= num11 - 1 && allItem.ItemID <= num11 + 4 && allItem.ItemID != 20502009)
          num10 += (int) allItem.ItemCount;
      }
      if (num10 >= 10)
      {
        ++this.Myself.QuestStep;
      }
      else
      {
        if (this.Target.SubVersion == 0)
        {
          GA.ShowBalloon(frmMain.langNotSupportCrafting, frmMain.langWaringSetup, this, 10000);
          return;
        }
        if (this.Target.SubVersion == 4 && num1 == 2)
        {
          this.NhiemVuDoiPhieuTienVang(3);
        }
        else
        {
          if (indexSubMenu >= 0)
            this.OpenKNBShop(indexMenu, indexSubMenu);
          int num12 = numCheDoSlmua - num10;
          for (int index = 0; index <= num12; ++index)
          {
            this.BuyKNBItem(indexItem, this.Myself.MapID);
            Thread.Sleep(100);
          }
        }
      }
    }
    if (this.Myself.QuestStep == 3)
    {
      int menuIndex;
      int num13;
      switch (cboItemCheDo)
      {
        case "Đao Phủ":
        case "Thương Bổng":
        case "Đơn Đoản":
        case "Song Đoản":
        case "Phiến":
        case "Hoàn":
        case "Falchion":
        case "Spear":
        case "One-handed":
        case "Two-handed":
        case "Fans":
        case "Circle":
          if (this.MySkills.AllSkills[3].ID != 46)
          {
            GA.ShowBalloon(frmMain.langDatTinhLuyen, frmMain.langSkillPlacement, this);
            this.Myself.IsCheDo = false;
            this.IsAIEnabled = false;
            return;
          }
          menuIndex = 3;
          num13 = 20500004;
          if (this.Target.SubVersion == 2 || this.Target.SubVersion == 16 /*0x10*/ || this.Target.SubVersion == 18)
            num13 = 20500005;
          if (this.Target.SubVersion == 14)
          {
            num13 = 20500008;
            break;
          }
          break;
        case "Hạng Liên":
        case "Giới Chỉ":
        case "Hộ Phù":
        case "Necklace":
        case "Ring":
        case "Amulet":
          menuIndex = 1;
          num13 = 20502004;
          if (this.Target.SubVersion == 2 || this.Target.SubVersion == 16 /*0x10*/ || this.Target.SubVersion == 18)
            num13 = 20502005;
          if (this.Target.SubVersion == 11 || this.Target.SubVersion == 14)
          {
            num13 = 20502003;
            break;
          }
          break;
        default:
          menuIndex = 2;
          num13 = 20501004;
          if (this.Target.SubVersion == 2 || this.Target.SubVersion == 16 /*0x10*/ || this.Target.SubVersion == 18)
            num13 = 20501005;
          if (this.Target.SubVersion == 11 || this.Target.SubVersion == 14)
          {
            num13 = 20501003;
            break;
          }
          break;
      }
      if (this.Myself.SynthesizeShow <= 0 || this.Target.SubVersion == 11 || this.Target.SubVersion == 15)
        this.CallClickSkillMenu(menuIndex);
      if (this.Myself.InventoryShow <= 0 || this.Target.SubVersion == 11 || this.Target.SubVersion == 15)
      {
        this.CallClickOpenInventory();
        Thread.Sleep(500);
      }
      if (this.Myself.InventoryShow == 1 || this.Target.SubVersion == 11 || this.Target.SubVersion == 15)
      {
        this.CallClickTabInventory(1);
        Thread.Sleep(300);
        for (int index = 30; index < 60; ++index)
        {
          InventoryItem allItem = this.MyInventory.AllItems[index];
          if (allItem.ItemID >= num13 - 1 && allItem.ItemID <= num13 + 4 && allItem.ItemID != 20502009)
          {
            int LineNum = index / 5 - 5;
            int LineIndex = index - 30 - (LineNum - 1) * 5 + 1;
            this.CallClickItemInventory(LineNum, LineIndex);
            this.CallXuongNgua();
            Thread.Sleep(500);
            ++this.Myself.QuestStep;
            break;
          }
        }
      }
    }
    if (this.Myself.QuestStep == 4 && this.Myself.ActionStatus != (byte) 8)
    {
      this.CallClickCheDo();
      if (this.Myself.EventString == "TDTKG")
      {
        this.ResetEventString();
        ++this.Myself.QuestStep;
      }
      if (this.Myself.EventString == "HDTR")
      {
        this.ResetEventString();
        this.Myself.QuestStep = 1;
      }
      if (this.Myself.EventString == "HNLR")
      {
        this.ResetEventString();
        this.Myself.QuestStep = 2;
      }
    }
    if (this.Myself.QuestStep == 5)
    {
      this.GiamDinhThungDo();
      Thread.Sleep(500);
      List<int> intList1 = new List<int>();
      List<int> intList2 = new List<int>();
      bool flag3 = false;
      for (int index1 = 0; index1 < 30; ++index1)
      {
        InventoryItem allItem = this.MyInventory.AllItems[index1];
        if (allItem.ItemID > 0 && this.isTrangBiItem(allItem.ItemType))
        {
          if (allItem.ItemSource == AllEnums.ItemSources.Chưa_biết || allItem.SavedCode != allItem.ItemID)
          {
            this.CallInventoryItemDetail(index1);
            Thread.Sleep(50);
          }
          if (allItem.ItemSource == AllEnums.ItemSources.Đồ_Chế)
          {
            int num14 = 0;
            if ((int) allItem.ItemStars >= this.Settings.numCheDoSao && (int) allItem.Lines >= this.Settings.numCheDoDong)
              ++num14;
            if (num14 == 1)
            {
              if (this.Settings.numCheDoChiSo == 0)
                ++num14;
              else if (allItem.LineValueArray.Count > 0)
              {
                for (int index2 = 0; index2 < allItem.LineValueArray.Count; ++index2)
                {
                  int lineValue = allItem.LineValueArray[index2];
                  if (lineValue >= 70 && lineValue >= this.Settings.numCheDoChiSo)
                  {
                    if (lineValue <= 107)
                      ++num14;
                    if (this.Target.SubVersion != 4 && this.Target.SubVersion != 5 && lineValue <= 130)
                      ++num14;
                  }
                }
              }
            }
            if (num14 >= 2)
            {
              intList1.Add(index1);
              bool flag4 = false;
              for (int index3 = 0; index3 < this.Myself.itemXinArrayGlobal.Count; ++index3)
              {
                if (allItem.ItemGUID2 == this.Myself.itemXinArrayGlobal[index3])
                {
                  flag4 = true;
                  break;
                }
              }
              if (!flag4)
              {
                this.Myself.itemXinArrayGlobal.Add(allItem.ItemGUID2);
                flag3 = true;
              }
            }
            else if (num14 < 2)
            {
              bool flag5 = false;
              for (int index4 = 0; index4 < this.Myself.itemXinArrayGlobal.Count; ++index4)
              {
                if (allItem.ItemGUID2 == this.Myself.itemXinArrayGlobal[index4])
                {
                  flag5 = true;
                  break;
                }
              }
              if (!flag5)
                intList2.Add(index1);
            }
          }
        }
      }
      if (flag3)
        GA.WriteUserLog(frmMain.langCheXTheoYeuCau, this, (object) this.Myself.itemXinArrayGlobal.Count);
      bool flag6 = false;
      int num15 = 1;
      if (this.Target.SubVersion == 4 && num1 == 2)
        num15 = 50;
      if (intList1.Count >= num15)
      {
        flag6 = true;
        if (num5 > 0 && GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num5, (double) num6) > 1.0)
        {
          this.CallMoveTo(num5, num6);
          Thread.Sleep(1500);
        }
        this.CallTalkNPC(0, 0, NPCID);
        Thread.Sleep(500);
        this.CallTalkNPC(7, -1, NPCID);
        Thread.Sleep(700);
        this.CallClickTabInventory(0);
        Thread.Sleep(350);
        int count = intList1.Count;
        for (int index = 0; index < count; ++index)
        {
          int num16 = intList1[index];
          int LineNum = num16 / 5 + 1;
          int LineIndex = num16 - (LineNum - 1) * 5 + 1;
          this.CallClickItemInventory(LineNum, LineIndex);
          int millisecondsTimeout = 350;
          if (this.Target.SubVersion == 4 || this.Target.SubVersion == 5 || this.Target.SubVersion == 12)
            millisecondsTimeout = 2500;
          Thread.Sleep(millisecondsTimeout);
          if (this.Myself.EventString == "RDDD")
          {
            ++this.Myself.actionFlag;
            this.ResetEventString();
            if (this.Myself.actionFlag >= 3)
            {
              ++this.Myself.actionCounter;
              this.Myself.actionFlag = 0;
              break;
            }
            if (this.Myself.actionFlag <= 2)
            {
              this.CallClickRuongTrongKho(this.Myself.actionFlag + 1);
              Thread.Sleep(350);
            }
            index -= 2;
            if (index <= 0)
              index = -1;
          }
        }
        this.CallTalkNPC(0, 0, NPCID);
      }
      if (intList2.Count > 0)
      {
        flag6 = false;
        if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num3, (double) num4) > 1.0)
        {
          this.CallMoveTo(num3, num4);
          Thread.Sleep(1500);
        }
        for (int index = 0; index < intList2.Count; ++index)
        {
          int inventoryIndex = intList2[index];
          if (this.Target.SubVersion == 1 || this.Target.SubVersion == 2)
          {
            this.CallRemoveInventoryItem(inventoryIndex);
          }
          else
          {
            if (index == 0)
            {
              this.CallTalkNPC(0, 0, num2);
              Thread.Sleep(300);
              this.CallClickTabInventory(0);
            }
            this.CallNPCSellItem(inventoryIndex, num2, this.Myself.MapID);
            Thread.Sleep(350);
            this.CallRemoveInventoryItem(inventoryIndex);
          }
        }
        this.CallStringWithEnv(23);
      }
      if (flag6)
      {
        this.CallTalkNPC(0, 0, NPCID);
        this.CallMoveTo(num3, num4);
        Thread.Sleep(1000);
      }
      if (this.Myself.itemXinArrayGlobal.Count >= this.Settings.numCheDoAmount)
        this.Myself.NhiemVuFinish = true;
      this.Myself.actionFlag = 0;
      ++this.Myself.QuestStep;
    }
    if (this.Myself.QuestStep != 6)
      return;
    if (!this.Myself.NhiemVuFinish)
    {
      this.ResetEventString();
      this.Myself.QuestStep = 0;
    }
    else
    {
      this.Myself.IsCheDo = false;
      this.IsAIEnabled = false;
      if (this.Settings.cboCheDoXong.Contains("ồi ch") || this.Settings.cboCheDoXong.Contains("Sit Idle"))
        GA.WriteUserLog(frmMain.langIdleCrafting, this);
      else if (this.Settings.cboCheDoXong.Contains("áo độ") || this.Settings.cboCheDoXong.Contains("Alert"))
      {
        GA.WriteUserLog(frmMain.langIdleCrafting, this);
        GA.ShowBalloon(frmMain.langCraftFinished, frmMain.langCraftFinished2, this, 10000);
        try
        {
          new SoundPlayer("event.wav").Play();
        }
        catch (Exception ex)
        {
        }
      }
      else if (this.Settings.cboCheDoXong.Contains("át ga") || this.Settings.cboCheDoXong.Contains("Exit game"))
      {
        GA.WriteUserLog(frmMain.langCraftFinishedOutGame, this);
        this.CallOutGame();
      }
      else
      {
        if (!this.Settings.cboCheDoXong.Contains("ắt m") && !this.Settings.cboCheDoXong.Contains("Shutdown PC"))
          return;
        GA.WriteUserLog(frmMain.langCraftFinishedShutdown, this);
        Process.Start("shutdown", "/s /t 60 /f");
      }
    }
  }

  public void NhiemVuCheDo_New()
  {
    bool flag1 = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    if (!flag1 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 500L)
      return;
    this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    int num1 = 2;
    int numCheDoSlmua = this.Settings.numCheDoSLmua;
    string cboCheDoDtd = this.Settings.cboCheDoDTD;
    string oldValue = "Cấp ";
    if (this.Target.SubVersion == 12)
      oldValue = "Level ";
    string s = cboCheDoDtd.Replace(oldValue, "");
    int result = 0;
    int.TryParse(s, out result);
    string cboItemCheDo = this.Settings.cboItemCheDo;
    int NPCID = 187;
    int num2 = 186;
    int num3 = 351;
    int num4 = 250;
    int num5 = 347;
    int num6 = 250;
    int cboCheDoMap = this.Settings.cboCheDoMap;
    if (this.Settings.cboCheDoMap == 0)
    {
      if (this.Target.SubVersion == 1 || this.Target.SubVersion == 8 || this.Target.SubVersion == 2 || this.Target.SubVersion == 10 || this.Target.SubVersion == 13 || this.Target.SubVersion == 14)
      {
        NPCID = 59;
        num2 = 13;
      }
      if (GA.ClientVersion(this) == 10)
      {
        num3 = 254;
        num4 = 108;
        num5 = 251;
        num6 = 108;
      }
    }
    if (this.Settings.cboCheDoMap == 2)
    {
      NPCID = 7;
      num2 = 107;
      num3 = 205;
      num4 = 179;
      num5 = 202;
      num6 = 179;
      if (this.Target.SubVersion == 8 || this.Target.SubVersion == 13)
      {
        NPCID = 70;
        num2 = 19;
      }
      else if (this.Target.SubVersion == 1)
      {
        NPCID = 2;
        num2 = 160 /*0xA0*/;
        num3 = 327;
        num4 = 272;
        num5 = 324;
        num6 = 272;
      }
      else if (this.Target.SubVersion == 2)
      {
        NPCID = 2;
        num2 = 160 /*0xA0*/;
        num3 = 205;
        num4 = 171;
        num5 = 199;
        num6 = 171;
      }
    }
    if (this.Settings.cboCheDoMap == 1)
    {
      NPCID = 19;
      num2 = 114;
      num3 = 186;
      num4 = 274;
      num5 = 186;
      num6 = 277;
      if (this.Target.SubVersion == 8 || this.Target.SubVersion == 13)
      {
        NPCID = 48 /*0x30*/;
        num2 = 21;
      }
      else if (this.Target.SubVersion == 1 || this.Target.SubVersion == 2)
      {
        NPCID = 20;
        num2 = 142;
      }
    }
    if (this.Settings.cboCheDoMap == 186)
    {
      NPCID = 9;
      num2 = 10;
      num3 = 217;
      num4 = 128 /*0x80*/;
      num5 = 217;
      num6 = 124;
    }
    if (this.Myself.QuestStep == 0 && (this.Target.SubVersion == 4 && num1 == 2 || num1 == 2 || this.GoToMyPos(num5, num6, cboCheDoMap)))
    {
      if (this.Target.SubVersion != 4 || num1 != 2)
        this.CallMoveTo(num5, num6);
      if (this.Myself.Status == AllEnums.CharStatuses.GOGOGO)
        this.Myself.Status = AllEnums.CharStatuses.IDLE;
      ++this.Myself.QuestStep;
    }
    if (this.Myself.QuestStep == 1)
    {
      int num7 = 0;
      int num8 = 0;
      int indexMenu = 6;
      int indexSubMenu = -1;
      int indexItem = -1;
      if (this.Target.SubVersion == 8 || this.Target.SubVersion == 1 || this.Target.SubVersion == 2 || this.Target.SubVersion == 9 || this.Target.SubVersion == 10 || this.Target.SubVersion == 11 || this.Target.SubVersion == 14 || this.Target.SubVersion == 15 || this.Target.SubVersion == 16 /*0x10*/ || this.Target.SubVersion == 18)
        indexMenu = 8;
      else if (this.Target.SubVersion == 13 || this.Target.SubVersion == 20)
        indexMenu = 7;
      switch (cboItemCheDo)
      {
        case "Nón":
        case "Hat":
          indexSubMenu = 4;
          switch (result)
          {
            case 3:
              num7 = 20308063;
              indexItem = 4;
              break;
            case 4:
              num7 = 20308064;
              indexItem = 6;
              break;
            case 5:
              num7 = 20308065;
              indexItem = 8;
              break;
            case 6:
              num7 = 20308066;
              indexItem = 10;
              break;
            case 7:
              num7 = 20308067;
              indexItem = 12;
              break;
            case 8:
              num7 = 20308068;
              indexItem = 14;
              break;
            case 9:
              num7 = 20308069;
              indexItem = 16 /*0x10*/;
              break;
            case 10:
              num7 = 20308070;
              indexItem = 18;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 19;
                break;
              }
              break;
          }
          break;
        case "Y Phục":
        case "Garments":
          indexSubMenu = 4;
          switch (result)
          {
            case 3:
              num7 = 20308073;
              indexItem = 5;
              break;
            case 4:
              num7 = 20308074;
              indexItem = 7;
              break;
            case 5:
              num7 = 20308075;
              indexItem = 9;
              break;
            case 6:
              num7 = 20308076;
              indexItem = 11;
              break;
            case 7:
              num7 = 20308077;
              indexItem = 13;
              break;
            case 8:
              num7 = 20308078;
              indexItem = 15;
              break;
            case 9:
              num7 = 20308079;
              indexItem = 17;
              break;
            case 10:
              num7 = 20308080;
              indexItem = 19;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 21;
                break;
              }
              break;
          }
          break;
        case "Hộ Thủ":
        case "Gloves":
          indexSubMenu = 5;
          switch (result)
          {
            case 3:
              num7 = 20308083;
              indexItem = 4;
              break;
            case 4:
              num7 = 20308084;
              indexItem = 6;
              break;
            case 5:
              num7 = 20308085;
              indexItem = 8;
              break;
            case 6:
              num7 = 20308086;
              indexItem = 10;
              break;
            case 7:
              num7 = 20308087;
              indexItem = 12;
              break;
            case 8:
              num7 = 20308088;
              indexItem = 14;
              break;
            case 9:
              num7 = 20308089;
              indexItem = 16 /*0x10*/;
              break;
            case 10:
              num7 = 20308090;
              indexItem = 18;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 19;
                break;
              }
              break;
          }
          break;
        case "Hài":
        case "Shoes":
          indexSubMenu = 5;
          switch (result)
          {
            case 3:
              num7 = 20308093;
              indexItem = 5;
              break;
            case 4:
              num7 = 20308094;
              indexItem = 7;
              break;
            case 5:
              num7 = 20308095;
              indexItem = 9;
              break;
            case 6:
              num7 = 20308096;
              indexItem = 11;
              break;
            case 7:
              num7 = 20308097;
              indexItem = 13;
              break;
            case 8:
              num7 = 20308098;
              indexItem = 15;
              break;
            case 9:
              num7 = 20308099;
              indexItem = 17;
              break;
            case 10:
              num7 = 20308100;
              indexItem = 19;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 21;
                break;
              }
              break;
          }
          break;
        case "Hộ Uyển":
        case "Wristbands":
          indexSubMenu = 6;
          switch (result)
          {
            case 3:
              num7 = 20308133;
              indexItem = 4;
              break;
            case 4:
              num7 = 20308134;
              indexItem = 6;
              break;
            case 5:
              num7 = 20308135;
              indexItem = 8;
              break;
            case 6:
              num7 = 20308136;
              indexItem = 10;
              break;
            case 7:
              num7 = 20308137;
              indexItem = 12;
              break;
            case 8:
              num7 = 20308138;
              indexItem = 14;
              break;
            case 9:
              num7 = 20308139;
              indexItem = 16 /*0x10*/;
              break;
            case 10:
              num7 = 20308140;
              indexItem = 18;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 19;
                break;
              }
              break;
          }
          break;
        case "Hộ Kiên":
        case "Shoulderpad":
          indexSubMenu = 6;
          switch (result)
          {
            case 3:
              num7 = 20308143;
              indexItem = 5;
              break;
            case 4:
              num7 = 20308144;
              indexItem = 7;
              break;
            case 5:
              num7 = 20308145;
              indexItem = 9;
              break;
            case 6:
              num7 = 20308146;
              indexItem = 11;
              break;
            case 7:
              num7 = 20308147;
              indexItem = 13;
              break;
            case 8:
              num7 = 20308148;
              indexItem = 15;
              break;
            case 9:
              num7 = 20308149;
              indexItem = 17;
              break;
            case 10:
              num7 = 20308150;
              indexItem = 19;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 21;
                break;
              }
              break;
          }
          break;
        case "Yêu Đái":
        case "Belt":
          indexSubMenu = 7;
          switch (result)
          {
            case 3:
              num7 = 20308153;
              indexItem = 4;
              break;
            case 4:
              num7 = 20308154;
              indexItem = 6;
              break;
            case 5:
              num7 = 20308155;
              indexItem = 8;
              break;
            case 6:
              num7 = 20308156;
              indexItem = 10;
              break;
            case 7:
              num7 = 20308157;
              indexItem = 12;
              break;
            case 8:
              num7 = 20308158;
              indexItem = 14;
              break;
            case 9:
              num7 = 20308159;
              indexItem = 16 /*0x10*/;
              break;
            case 10:
              num7 = 20308160;
              indexItem = 18;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 19;
                break;
              }
              break;
          }
          break;
        case "Hạng Liên":
        case "Necklace":
          indexSubMenu = 7;
          switch (result)
          {
            case 3:
              num7 = 20308103;
              indexItem = 5;
              break;
            case 4:
              num7 = 20308104;
              indexItem = 7;
              break;
            case 5:
              num7 = 20308105;
              indexItem = 9;
              break;
            case 6:
              num7 = 20308106;
              indexItem = 11;
              break;
            case 7:
              num7 = 20308107;
              indexItem = 13;
              break;
            case 8:
              num7 = 20308108;
              indexItem = 15;
              break;
            case 9:
              num7 = 20308109;
              indexItem = 17;
              break;
            case 10:
              num7 = 20308110;
              indexItem = 19;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 21;
                break;
              }
              break;
          }
          break;
        case "Giới Chỉ":
        case "Ring":
          indexSubMenu = 8;
          switch (result)
          {
            case 3:
              num7 = 20308113;
              indexItem = 4;
              break;
            case 4:
              num7 = 20308114;
              indexItem = 6;
              break;
            case 5:
              num7 = 20308115;
              indexItem = 8;
              break;
            case 6:
              num7 = 20308116;
              indexItem = 10;
              break;
            case 7:
              num7 = 20308117;
              indexItem = 12;
              break;
            case 8:
              num7 = 20308118;
              indexItem = 14;
              break;
            case 9:
              num7 = 20308119;
              indexItem = 16 /*0x10*/;
              break;
            case 10:
              num7 = 20308120;
              indexItem = 18;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 19;
                break;
              }
              break;
          }
          break;
        case "Hộ Phù":
        case "Amulet":
          indexSubMenu = 8;
          switch (result)
          {
            case 3:
              num7 = 20308123;
              indexItem = 5;
              break;
            case 4:
              num7 = 20308124;
              indexItem = 7;
              break;
            case 5:
              num7 = 20308125;
              indexItem = 9;
              break;
            case 6:
              num7 = 20308126;
              indexItem = 11;
              break;
            case 7:
              num7 = 20308127;
              indexItem = 13;
              break;
            case 8:
              num7 = 20308128;
              indexItem = 15;
              break;
            case 9:
              num7 = 20308129;
              indexItem = 17;
              break;
            case 10:
              num7 = 20308130;
              indexItem = 19;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 21;
                break;
              }
              break;
          }
          break;
        case "Đao Phủ":
        case "Falchion":
          indexSubMenu = 1;
          switch (result)
          {
            case 3:
              num7 = 20308003;
              indexItem = 4;
              break;
            case 4:
              num7 = 20308004;
              indexItem = 6;
              break;
            case 5:
              num7 = 20308005;
              indexItem = 8;
              break;
            case 6:
              num7 = 20308006;
              indexItem = 10;
              break;
            case 7:
              num7 = 20308007;
              indexItem = 12;
              break;
            case 8:
              num7 = 20308008;
              indexItem = 14;
              break;
            case 9:
              num7 = 20308009;
              indexItem = 16 /*0x10*/;
              break;
            case 10:
              num7 = 20308010;
              indexItem = 18;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 19;
                break;
              }
              break;
          }
          break;
        case "Thương Bổng":
        case "Spear":
          indexSubMenu = 1;
          switch (result)
          {
            case 3:
              num7 = 20308013;
              indexItem = 5;
              break;
            case 4:
              num7 = 20308014;
              indexItem = 7;
              break;
            case 5:
              num7 = 20308015;
              indexItem = 9;
              break;
            case 6:
              num7 = 20308016;
              indexItem = 11;
              break;
            case 7:
              num7 = 20308017;
              indexItem = 13;
              break;
            case 8:
              num7 = 20308018;
              indexItem = 15;
              break;
            case 9:
              num7 = 20308019;
              indexItem = 17;
              break;
            case 10:
              num7 = 20308020;
              indexItem = 19;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 21;
                break;
              }
              break;
          }
          break;
        case "Đơn Đoản":
        case "One-handed":
          indexSubMenu = 2;
          switch (result)
          {
            case 3:
              num7 = 20308023;
              indexItem = 4;
              break;
            case 4:
              num7 = 20308024;
              indexItem = 6;
              break;
            case 5:
              num7 = 20308025;
              indexItem = 8;
              break;
            case 6:
              num7 = 20308026;
              indexItem = 10;
              break;
            case 7:
              num7 = 20308027;
              indexItem = 12;
              break;
            case 8:
              num7 = 20308028;
              indexItem = 14;
              break;
            case 9:
              num7 = 20308029;
              indexItem = 16 /*0x10*/;
              break;
            case 10:
              num7 = 20308030;
              indexItem = 18;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 19;
                break;
              }
              break;
          }
          break;
        case "Song Đoản":
        case "Two-handed":
          indexSubMenu = 2;
          switch (result)
          {
            case 3:
              num7 = 20308033;
              indexItem = 5;
              break;
            case 4:
              num7 = 20308034;
              indexItem = 7;
              break;
            case 5:
              num7 = 20308035;
              indexItem = 9;
              break;
            case 6:
              num7 = 20308036;
              indexItem = 11;
              break;
            case 7:
              num7 = 20308037;
              indexItem = 13;
              break;
            case 8:
              num7 = 20308038;
              indexItem = 15;
              break;
            case 9:
              num7 = 20308039;
              indexItem = 17;
              break;
            case 10:
              num7 = 20308040;
              indexItem = 19;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 21;
                break;
              }
              break;
          }
          break;
        case "Phiến":
        case "Fans":
          indexSubMenu = 3;
          switch (result)
          {
            case 3:
              num7 = 20308043;
              indexItem = 4;
              break;
            case 4:
              num7 = 20308044;
              indexItem = 6;
              break;
            case 5:
              num7 = 20308045;
              indexItem = 8;
              break;
            case 6:
              num7 = 20308046;
              indexItem = 10;
              break;
            case 7:
              num7 = 20308047;
              indexItem = 12;
              break;
            case 8:
              num7 = 20308048;
              indexItem = 14;
              break;
            case 9:
              num7 = 20308049;
              indexItem = 16 /*0x10*/;
              break;
            case 10:
              num7 = 20308050;
              indexItem = 18;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 19;
                break;
              }
              break;
          }
          break;
        case "Hoàn":
        case "Circle":
          indexSubMenu = 3;
          switch (result)
          {
            case 3:
              num7 = 20308053;
              indexItem = 5;
              break;
            case 4:
              num7 = 20308054;
              indexItem = 7;
              break;
            case 5:
              num7 = 20308055;
              indexItem = 9;
              break;
            case 6:
              num7 = 20308056;
              indexItem = 11;
              break;
            case 7:
              num7 = 20308057;
              indexItem = 13;
              break;
            case 8:
              num7 = 20308058;
              indexItem = 15;
              break;
            case 9:
              num7 = 20308059;
              indexItem = 17;
              break;
            case 10:
              num7 = 20308060;
              indexItem = 19;
              if (this.Target.SubVersion == 8)
              {
                indexItem = 21;
                break;
              }
              break;
          }
          break;
      }
      for (int index = 30; index < 60; ++index)
      {
        InventoryItem allItem = this.MyInventory.AllItems[index];
        if (allItem.ItemID == num7)
          num8 += (int) allItem.ItemCount;
      }
      if (num8 >= 10)
      {
        ++this.Myself.QuestStep;
      }
      else
      {
        if (this.Target.SubVersion == 0)
        {
          GA.ShowBalloon(frmMain.langNotSupportCrafting, frmMain.langWaringSetup, this, 10000);
          return;
        }
        if (this.Target.SubVersion == 11 || this.Target.SubVersion == 15)
        {
          GA.ShowBalloon(frmMain.langNotRightDaTaoDo, frmMain.langWaringSetup, this, 10000);
          return;
        }
        if (indexSubMenu >= 0)
          this.OpenKNBShop(indexMenu, indexSubMenu);
        int num9 = numCheDoSlmua - num8;
        if (this.Target.SubVersion == 20)
        {
          if (indexItem % 2 == 0)
          {
            indexItem = indexItem / 2 - 3;
            if (indexItem < 0)
              indexItem = 0;
          }
          else
          {
            int num10 = (indexItem - 1) / 2 - 3;
            if (num10 < 0)
              num10 = 0;
            indexItem = num10 + 7;
          }
          num9 /= 20;
        }
        for (int index = 0; index <= num9; ++index)
        {
          this.BuyKNBItem(indexItem, this.Myself.MapID);
          Thread.Sleep(80 /*0x50*/);
        }
      }
    }
    if (this.Myself.QuestStep == 2)
    {
      int num11 = 0;
      int indexMenu = 4;
      int indexSubMenu = 2;
      if (this.Target.SubVersion == 1)
        indexSubMenu = 1;
      else if (this.Target.SubVersion == 8)
      {
        indexMenu = 2;
        indexSubMenu = 5;
      }
      else if (this.Target.SubVersion == 9)
      {
        indexMenu = 2;
        indexSubMenu = 7;
      }
      else if (this.Target.SubVersion == 11 || this.Target.SubVersion == 13)
        indexSubMenu = 1;
      else if (this.Target.SubVersion == 14)
        indexSubMenu = 3;
      else if (this.Target.SubVersion == 15)
      {
        indexMenu = 1;
        indexSubMenu = 1;
      }
      else
      {
        int subVersion = this.Target.SubVersion;
      }
      int indexItem;
      int num12;
      switch (cboItemCheDo)
      {
        case "Đao Phủ":
        case "Thương Bổng":
        case "Đơn Đoản":
        case "Song Đoản":
        case "Phiến":
        case "Hoàn":
        case "Falchion":
        case "Spear":
        case "One-handed":
        case "Two-handed":
        case "Fans":
        case "Circle":
          if (this.Settings.numCheDoChiSo > 0)
            GA.ShowBalloon(frmMain.langCheVuKhiWarning, frmMain.langWaringSetup, this, 300000);
          indexItem = 2;
          num12 = 20500004;
          if (this.Target.SubVersion == 1)
          {
            GA.WriteUserLog(frmMain.langNotFoundTinhThiet, this);
            break;
          }
          if (this.Target.SubVersion == 2)
          {
            indexItem = 1;
            num12 = 20500005;
            break;
          }
          if (this.Target.SubVersion == 8)
          {
            indexItem = 9;
            break;
          }
          if (this.Target.SubVersion == 9)
          {
            indexItem = 1;
            break;
          }
          if (this.Target.SubVersion == 10)
          {
            indexItem = 3;
            num12 = 20500005;
            break;
          }
          if (this.Target.SubVersion == 11 || this.Target.SubVersion == 15)
          {
            GA.WriteUserLog(frmMain.langNotFoundTinhThiet, this);
            break;
          }
          if (this.Target.SubVersion == 13)
          {
            indexItem = 7;
            num12 = 20500006;
            break;
          }
          if (this.Target.SubVersion == 14)
          {
            indexItem = 1;
            num12 = 20500008;
            break;
          }
          if (this.Target.SubVersion == 16 /*0x10*/ || this.Target.SubVersion == 18)
          {
            indexItem = 14;
            num12 = 20500005;
            break;
          }
          if (this.Target.SubVersion == 19)
          {
            indexItem = 0;
            num12 = 20500005;
            break;
          }
          if (this.Target.SubVersion == 20)
          {
            indexItem = 0;
            break;
          }
          break;
        case "Hạng Liên":
        case "Giới Chỉ":
        case "Hộ Phù":
        case "Necklace":
        case "Ring":
        case "Amulet":
          indexItem = 0;
          num12 = 20502004;
          if (this.Target.SubVersion == 1)
          {
            indexItem = 2;
            break;
          }
          if (this.Target.SubVersion == 2)
          {
            indexItem = 3;
            num12 = 20502005;
            break;
          }
          if (this.Target.SubVersion == 8)
          {
            indexItem = 11;
            break;
          }
          if (this.Target.SubVersion == 9)
          {
            indexItem = 5;
            break;
          }
          if (this.Target.SubVersion == 10)
          {
            indexItem = 5;
            num12 = 20502005;
            break;
          }
          if (this.Target.SubVersion == 11)
          {
            indexItem = 11;
            num12 = 20502003;
            break;
          }
          if (this.Target.SubVersion == 13)
          {
            indexItem = 9;
            num12 = 20502006;
            break;
          }
          if (this.Target.SubVersion == 14)
          {
            indexItem = 3;
            num12 = 20502003;
            break;
          }
          if (this.Target.SubVersion == 15)
          {
            indexItem = 25;
            num12 = 20502004;
            break;
          }
          if (this.Target.SubVersion == 16 /*0x10*/ || this.Target.SubVersion == 18)
          {
            indexItem = 18;
            num12 = 20502005;
            break;
          }
          if (this.Target.SubVersion == 19)
          {
            indexItem = 2;
            num12 = 20502005;
            break;
          }
          if (this.Target.SubVersion == 20)
          {
            indexItem = 2;
            break;
          }
          break;
        default:
          indexItem = 1;
          num12 = 20501004;
          if (this.Target.SubVersion == 1)
          {
            indexItem = 3;
            break;
          }
          if (this.Target.SubVersion == 2)
          {
            indexItem = 2;
            num12 = 20501005;
            break;
          }
          if (this.Target.SubVersion == 8)
          {
            indexItem = 10;
            break;
          }
          if (this.Target.SubVersion == 9)
          {
            indexItem = 3;
            break;
          }
          if (this.Target.SubVersion == 10)
          {
            indexItem = 4;
            num12 = 20501005;
            break;
          }
          if (this.Target.SubVersion == 11)
          {
            indexItem = 10;
            num12 = 20501003;
            break;
          }
          if (this.Target.SubVersion == 13)
          {
            indexItem = 8;
            num12 = 20501006;
            break;
          }
          if (this.Target.SubVersion == 14)
          {
            indexItem = 2;
            num12 = 20501003;
            break;
          }
          if (this.Target.SubVersion == 15)
          {
            indexItem = 29;
            num12 = 20501004;
            break;
          }
          if (this.Target.SubVersion == 16 /*0x10*/ || this.Target.SubVersion == 18)
          {
            indexItem = 16 /*0x10*/;
            num12 = 20501005;
            break;
          }
          break;
      }
      for (int index = 30; index < 60; ++index)
      {
        InventoryItem allItem = this.MyInventory.AllItems[index];
        if (allItem.ItemID >= num12 - 1 && allItem.ItemID <= num12 + 4 && allItem.ItemID != 20502009)
          num11 += (int) allItem.ItemCount;
        if (this.Target.SubVersion == 4 && num1 == 2 && this.Settings.cboxHuyNLThua)
        {
          if (20501001 <= num12 && num12 <= 20501008)
          {
            if (20502001 <= allItem.ItemID && allItem.ItemID <= 20502008)
              this.CallRemoveInventoryItem(index);
            if (20500001 <= allItem.ItemID && allItem.ItemID <= 20500008)
              this.CallRemoveInventoryItem(index);
          }
          else if (20502001 <= num12 && num12 <= 20502008)
          {
            if (20501001 <= allItem.ItemID && allItem.ItemID <= 20501008)
              this.CallRemoveInventoryItem(index);
            if (20500001 <= allItem.ItemID && allItem.ItemID <= 20500008)
              this.CallRemoveInventoryItem(index);
          }
          else if (20500001 <= num12 && num12 <= 20500008)
          {
            if (20502001 <= allItem.ItemID && allItem.ItemID <= 20502008)
              this.CallRemoveInventoryItem(index);
            if (20501001 <= allItem.ItemID && allItem.ItemID <= 20501008)
              this.CallRemoveInventoryItem(index);
          }
        }
      }
      if (num11 >= this.MyFlag.chedoItemNeedCount)
      {
        this.MyFlag.chedoItemNeedCount = 10;
        ++this.Myself.QuestStep;
      }
      else
      {
        if (this.Target.SubVersion == 0)
        {
          GA.ShowBalloon(frmMain.langNotSupportCrafting, frmMain.langWaringSetup, this, 10000);
          return;
        }
        if (this.Target.SubVersion == 4 && num1 == 2)
        {
          this.MyFlag.chedoItemNeedCount = numCheDoSlmua;
          this.NhiemVuDoiPhieuTienVang(3);
        }
        else
        {
          if (indexSubMenu >= 0)
            this.OpenKNBShop(indexMenu, indexSubMenu);
          int num13 = numCheDoSlmua - num11;
          if (this.Target.SubVersion == 20)
            num13 /= 10;
          for (int index = 0; index <= num13; ++index)
          {
            this.BuyKNBItem(indexItem, this.Myself.MapID);
            Thread.Sleep(100);
          }
        }
      }
    }
    if (this.Myself.QuestStep == 3)
    {
      int menuIndex;
      int num14;
      switch (cboItemCheDo)
      {
        case "Đao Phủ":
        case "Thương Bổng":
        case "Đơn Đoản":
        case "Song Đoản":
        case "Phiến":
        case "Hoàn":
        case "Falchion":
        case "Spear":
        case "One-handed":
        case "Two-handed":
        case "Fans":
        case "Circle":
          if (this.MySkills.AllSkills[3].ID != 46)
          {
            GA.ShowBalloon(frmMain.langDatTinhLuyen, frmMain.langSkillPlacement, this);
            this.Myself.IsCheDo = false;
            this.IsAIEnabled = false;
            return;
          }
          menuIndex = 3;
          num14 = 20500004;
          if (this.Target.SubVersion == 2 || this.Target.SubVersion == 16 /*0x10*/ || this.Target.SubVersion == 18)
            num14 = 20500005;
          if (this.Target.SubVersion == 14)
          {
            num14 = 20500008;
            break;
          }
          break;
        case "Hạng Liên":
        case "Giới Chỉ":
        case "Hộ Phù":
        case "Necklace":
        case "Ring":
        case "Amulet":
          menuIndex = 1;
          num14 = 20502004;
          if (this.Target.SubVersion == 2 || this.Target.SubVersion == 16 /*0x10*/ || this.Target.SubVersion == 18)
            num14 = 20502005;
          if (this.Target.SubVersion == 11 || this.Target.SubVersion == 14)
          {
            num14 = 20502003;
            break;
          }
          break;
        default:
          menuIndex = 2;
          num14 = 20501004;
          if (this.Target.SubVersion == 2 || this.Target.SubVersion == 16 /*0x10*/ || this.Target.SubVersion == 18)
            num14 = 20501005;
          if (this.Target.SubVersion == 11 || this.Target.SubVersion == 14)
          {
            num14 = 20501003;
            break;
          }
          break;
      }
      if (this.Myself.SynthesizeShow <= 0 || this.Target.SubVersion == 11 || this.Target.SubVersion == 15)
        this.CallClickSkillMenu(menuIndex);
      if (this.Myself.InventoryShow <= 0 || this.Target.SubVersion == 11 || this.Target.SubVersion == 15 || this.Target.SubVersion == 20)
      {
        this.CallClickOpenInventory();
        Thread.Sleep(500);
      }
      if (this.Myself.InventoryShow == 1 || this.Target.SubVersion == 11 || this.Target.SubVersion == 15 || this.Target.SubVersion == 20)
      {
        this.CallClickTabInventory(1);
        Thread.Sleep(300);
        for (int index = 30; index < 60; ++index)
        {
          InventoryItem allItem = this.MyInventory.AllItems[index];
          if (allItem.ItemID >= num14 - 1 && allItem.ItemID <= num14 + 4 && allItem.ItemID != 20502009)
          {
            int LineNum = index / 5 - 5;
            int LineIndex = index - 30 - (LineNum - 1) * 5 + 1;
            this.CallClickItemInventory(LineNum, LineIndex);
            this.CallXuongNgua();
            Thread.Sleep(500);
            ++this.Myself.QuestStep;
            break;
          }
        }
      }
    }
    if (this.Myself.QuestStep == 4)
    {
      if (this.Myself.ActionStatus != (byte) 8)
      {
        this.MyFlag.chedoCheckItemMode = 0;
        this.CallClickCheDo();
        if (this.Myself.EventString == "TDTKG")
        {
          this.ResetEventString();
          ++this.Myself.QuestStep;
        }
        if (this.Myself.EventString == "HDTR")
        {
          this.ResetEventString();
          this.Myself.QuestStep = 1;
        }
        if (this.Myself.EventString == "HNLR")
        {
          this.ResetEventString();
          this.Myself.QuestStep = 2;
        }
      }
      else if (this.MyFlag.chedoCheckItemMode == 0)
      {
        this.MyFlag.chedoCheckItemMode = 1;
        this.GiamDinhThungDo();
        Thread.Sleep(500);
        int num15 = 107;
        int num16 = 167;
        int num17 = 148;
        int menuTypeID = 2028;
        int menuIndex = 0;
        List<int> intList1 = new List<int>();
        List<int> intList2 = new List<int>();
        bool flag2 = false;
        for (int index1 = 0; index1 < 30; ++index1)
        {
          InventoryItem allItem = this.MyInventory.AllItems[index1];
          if (allItem.ItemID > 0 && this.isTrangBiItem(allItem.ItemType))
          {
            if (allItem.ItemSource == AllEnums.ItemSources.Chưa_biết || allItem.SavedCode != allItem.ItemID)
            {
              this.CallInventoryItemDetail(index1);
              Thread.Sleep(50);
            }
            if (allItem.ItemSource == AllEnums.ItemSources.Đồ_Chế)
            {
              int num18 = 0;
              if ((int) allItem.ItemStars >= this.Settings.numCheDoSao && (int) allItem.Lines >= this.Settings.numCheDoDong)
                ++num18;
              if (num18 == 1)
              {
                if (this.Settings.numCheDoChiSo == 0)
                  ++num18;
                else if (allItem.LineValueArray.Count > 0)
                {
                  for (int index2 = 0; index2 < allItem.LineValueArray.Count; ++index2)
                  {
                    int lineValue = allItem.LineValueArray[index2];
                    if (lineValue >= 70 && lineValue >= this.Settings.numCheDoChiSo)
                    {
                      if (lineValue <= 107)
                        ++num18;
                      if (this.Target.SubVersion != 4 && this.Target.SubVersion != 5 && lineValue <= 130)
                        ++num18;
                    }
                  }
                }
              }
              if (num18 >= 2)
              {
                intList1.Add(index1);
                bool flag3 = false;
                for (int index3 = 0; index3 < this.Myself.itemXinArrayGlobal.Count; ++index3)
                {
                  if (allItem.ItemGUID2 == this.Myself.itemXinArrayGlobal[index3])
                  {
                    flag3 = true;
                    break;
                  }
                }
                if (!flag3)
                {
                  this.Myself.itemXinArrayGlobal.Add(allItem.ItemGUID2);
                  flag2 = true;
                }
              }
              else if (num18 < 2)
              {
                bool flag4 = false;
                for (int index4 = 0; index4 < this.Myself.itemXinArrayGlobal.Count; ++index4)
                {
                  if (allItem.ItemGUID2 == this.Myself.itemXinArrayGlobal[index4])
                  {
                    flag4 = true;
                    break;
                  }
                }
                if (!flag4)
                {
                  if (this.Settings.cboxBanChoNPC && this.Target.VersionNum == 4 && num1 == 2)
                  {
                    double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num15, (double) num16);
                    while (distance > 3.0 && this.IsAIEnabled)
                    {
                      this.MyFlag.chedoTalkNPCMode = 0;
                      distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num15, (double) num16);
                      this.CallMoveTo(num15, num16);
                      Thread.Sleep(500);
                    }
                    if (distance <= 3.0)
                    {
                      if (this.MyFlag.chedoTalkNPCMode == 0)
                      {
                        this.MyFlag.chedoTalkNPCMode = 1;
                        this.CallTalkNPC(0, 0, num17);
                        Thread.Sleep(300);
                        this.CallTalkNPC(menuTypeID, menuIndex, num17);
                        Thread.Sleep(300);
                        this.CallStringWithEnv(23);
                        this.CallClickTabInventory(0);
                      }
                      this.CallNPCSellItem(index1, num17, this.Myself.MapID);
                      Thread.Sleep(350);
                      this.CallRemoveInventoryItem(index1);
                    }
                  }
                  else
                    this.CallRemoveInventoryItem(index1);
                }
              }
            }
          }
        }
        if (flag2)
          GA.WriteUserLog(frmMain.langCheXTheoYeuCau, this, (object) this.Myself.itemXinArrayGlobal.Count);
      }
    }
    if (this.Myself.QuestStep == 5)
    {
      this.GiamDinhThungDo();
      Thread.Sleep(500);
      List<int> intList3 = new List<int>();
      List<int> intList4 = new List<int>();
      bool flag5 = false;
      for (int index5 = 0; index5 < 30; ++index5)
      {
        InventoryItem allItem = this.MyInventory.AllItems[index5];
        if (allItem.ItemID > 0 && this.isTrangBiItem(allItem.ItemType))
        {
          if (allItem.ItemSource == AllEnums.ItemSources.Chưa_biết || allItem.SavedCode != allItem.ItemID)
          {
            this.CallInventoryItemDetail(index5);
            Thread.Sleep(50);
          }
          if (allItem.ItemSource == AllEnums.ItemSources.Đồ_Chế)
          {
            int num19 = 0;
            if ((int) allItem.ItemStars >= this.Settings.numCheDoSao && (int) allItem.Lines >= this.Settings.numCheDoDong)
              ++num19;
            if (num19 == 1)
            {
              if (this.Settings.numCheDoChiSo == 0)
                ++num19;
              else if (allItem.LineValueArray.Count > 0)
              {
                for (int index6 = 0; index6 < allItem.LineValueArray.Count; ++index6)
                {
                  int lineValue = allItem.LineValueArray[index6];
                  if (lineValue >= 70 && lineValue >= this.Settings.numCheDoChiSo)
                  {
                    if (lineValue <= 107)
                      ++num19;
                    if (this.Target.SubVersion != 4 && this.Target.SubVersion != 5 && lineValue <= 130)
                      ++num19;
                  }
                }
              }
            }
            if (num19 >= 2)
            {
              intList3.Add(index5);
              bool flag6 = false;
              for (int index7 = 0; index7 < this.Myself.itemXinArrayGlobal.Count; ++index7)
              {
                if (allItem.ItemGUID2 == this.Myself.itemXinArrayGlobal[index7])
                {
                  flag6 = true;
                  break;
                }
              }
              if (!flag6)
              {
                this.Myself.itemXinArrayGlobal.Add(allItem.ItemGUID2);
                flag5 = true;
              }
            }
            else if (num19 < 2)
            {
              bool flag7 = false;
              for (int index8 = 0; index8 < this.Myself.itemXinArrayGlobal.Count; ++index8)
              {
                if (allItem.ItemGUID2 == this.Myself.itemXinArrayGlobal[index8])
                {
                  flag7 = true;
                  break;
                }
              }
              if (!flag7)
                intList4.Add(index5);
            }
          }
        }
      }
      if (flag5)
        GA.WriteUserLog(frmMain.langCheXTheoYeuCau, this, (object) this.Myself.itemXinArrayGlobal.Count);
      bool flag8 = false;
      int num20 = 1;
      if (this.Target.SubVersion == 4 && num1 == 2)
        num20 = 50;
      if (intList3.Count >= num20)
      {
        flag8 = true;
        if (num5 > 0)
        {
          double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num5, (double) num6);
          while (distance > 3.0 && this.IsAIEnabled)
          {
            distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num5, (double) num6);
            this.CallMoveTo(num5, num6);
            Thread.Sleep(500);
          }
        }
        this.CallTalkNPC(0, 0, NPCID);
        Thread.Sleep(500);
        this.CallTalkNPC(7, -1, NPCID);
        Thread.Sleep(700);
        this.CallClickTabInventory(0);
        Thread.Sleep(350);
        int count = intList3.Count;
        for (int index = 0; index < count; ++index)
        {
          int num21 = intList3[index];
          int LineNum = num21 / 5 + 1;
          int LineIndex = num21 - (LineNum - 1) * 5 + 1;
          this.CallClickItemInventory(LineNum, LineIndex);
          int millisecondsTimeout = 350;
          if (this.Target.SubVersion == 4 || this.Target.SubVersion == 5 || this.Target.SubVersion == 12)
            millisecondsTimeout = 2500;
          Thread.Sleep(millisecondsTimeout);
          if (this.Myself.EventString == "RDDD")
          {
            ++this.Myself.actionFlag;
            this.ResetEventString();
            if (this.Myself.actionFlag >= 3)
            {
              ++this.Myself.actionCounter;
              this.Myself.actionFlag = 0;
              break;
            }
            if (this.Myself.actionFlag <= 2)
            {
              this.CallClickRuongTrongKho(this.Myself.actionFlag + 1);
              Thread.Sleep(350);
            }
            index -= 2;
            if (index <= 0)
              index = -1;
          }
        }
        this.CallTalkNPC(0, 0, NPCID);
      }
      if (intList4.Count > 0)
      {
        flag8 = false;
        double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num3, (double) num4);
        while (distance > 3.0 && this.IsAIEnabled)
        {
          distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num3, (double) num4);
          this.CallMoveTo(num3, num4);
          Thread.Sleep(500);
        }
        for (int index = 0; index < intList4.Count; ++index)
        {
          int inventoryIndex = intList4[index];
          if (this.Target.SubVersion == 1 || this.Target.SubVersion == 2)
          {
            this.CallRemoveInventoryItem(inventoryIndex);
          }
          else
          {
            if (index == 0)
            {
              this.CallTalkNPC(0, 0, num2);
              Thread.Sleep(300);
              this.CallClickTabInventory(0);
            }
            this.CallNPCSellItem(inventoryIndex, num2, this.Myself.MapID);
            Thread.Sleep(350);
            this.CallRemoveInventoryItem(inventoryIndex);
          }
        }
        this.CallStringWithEnv(23);
      }
      if (flag8)
      {
        this.CallTalkNPC(0, 0, NPCID);
        this.CallMoveTo(num3, num4);
        Thread.Sleep(1000);
      }
      if (this.Myself.itemXinArrayGlobal.Count >= this.Settings.numCheDoAmount)
        this.Myself.NhiemVuFinish = true;
      this.Myself.actionFlag = 0;
      ++this.Myself.QuestStep;
    }
    if (this.Myself.QuestStep != 6)
      return;
    if (!this.Myself.NhiemVuFinish)
    {
      this.ResetEventString();
      this.Myself.QuestStep = 0;
    }
    else
    {
      this.Myself.IsCheDo = false;
      this.IsAIEnabled = false;
      if (this.Settings.cboCheDoXong.Contains("ồi ch") || this.Settings.cboCheDoXong.Contains("Sit Idle"))
        GA.WriteUserLog(frmMain.langIdleCrafting, this);
      else if (this.Settings.cboCheDoXong.Contains("áo độ") || this.Settings.cboCheDoXong.Contains("Alert"))
      {
        GA.WriteUserLog(frmMain.langIdleCrafting, this);
        GA.ShowBalloon(frmMain.langCraftFinished, frmMain.langCraftFinished2, this, 10000);
        try
        {
          new SoundPlayer("event.wav").Play();
        }
        catch (Exception ex)
        {
        }
      }
      else if (this.Settings.cboCheDoXong.Contains("át ga") || this.Settings.cboCheDoXong.Contains("Exit game"))
      {
        GA.WriteUserLog(frmMain.langCraftFinishedOutGame, this);
        this.CallOutGame();
      }
      else
      {
        if (!this.Settings.cboCheDoXong.Contains("ắt m") && !this.Settings.cboCheDoXong.Contains("Shutdown PC"))
          return;
        GA.WriteUserLog(frmMain.langCraftFinishedShutdown, this);
        Process.Start("shutdown", "/s /t 60 /f");
      }
    }
  }

  public void NhiemVuDietGon()
  {
    bool flag1 = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    if (!flag1 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 500L)
      return;
    this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    if (!GA.IsInPhuBan(this.Myself.MapID, this))
    {
      int num1 = 133;
      int num2 = 260;
      int num3 = 1;
      int num4 = 138;
      int num5 = 50100;
      int menuIndex1 = 1;
      int num6 = 50100;
      int menuIndex2 = 2;
      if (this.Target.VersionNum == 3 && this.Target.SubVersion != 2)
      {
        num1 = 130;
        num2 = 260;
        num3 = 1;
        num4 = 110;
      }
      if (this.Target.VersionNum == 3 && this.Target.SubVersion == 10)
        num4 = 39;
      if (this.Target.SubVersion == 12)
        num4 = 102;
      if (GA.CheckGameVersion(this.Target.VersionNum) == 356)
      {
        num5 = 891074;
        num6 = 891074;
      }
      this.Myself.indexPPcalc = false;
      this.ResetEventString();
      this.ResetPacketMsg();
      this.Myself.actionFlag = 0;
      this.Myself.DietGonFlag = 0;
      this.Settings.cboxTheoSau = true;
      this.Myself.NhiemVuFinish = false;
      this.MyFlag.xonglinhQ1 = false;
      this.Myself.PBxong1vong = false;
      this.MyFlag.sotquaiQ1 = false;
      if (this.Myself.InMapPathPoints.Count > 0)
      {
        this.Myself.InMapPathPoints.Clear();
        this.Myself.InPathPointIndex = 0;
      }
      ++this.Myself.trieutapCounter;
      if (this.Myself.trieutapCounter == 1)
        GA.TrieuTapToMyPos(this, num1, num2, num3);
      else if (this.Myself.trieutapCounter >= 2)
        this.Myself.trieutapCounter = 0;
      if (this.GoToMyPos(num1, num2, num3) && this.WaitPartyFull(this.Settings.numQ12ChoPT - 1, this.Settings.numPTLevel))
      {
        if (this.IsPartyKeyInt() == 2 && !this.Settings.cboxTuHuyNV)
        {
          if (this.MyFlag.nhanQstamp == 0L)
            this.MyFlag.nhanQstamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
          if (this.MyFlag.nhanQstamp > 0L && frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.nhanQstamp >= 240000L)
          {
            this.MyFlag.nhanQstamp = 0L;
            if (frmLogin.GAuto.Settings.cboxQ12AutoExtend)
            {
              GA.WriteUserLog(frmMain.langIgnoreQ4min, this);
              frmLogin.GAuto.Settings.cboxQ12AutoExtend = false;
              return;
            }
          }
        }
        this.MyFlag.NamePartyArray.Clear();
        this.CallMoveTo(num1, num2);
        GA.TrieuTapCaNhom(this, true);
        if (this.CheckMemberGPS(7, num1, num2, num3) || this.IsPartyKeyInt() == 1 || this.MyFlag.xongQstamp > 0L && frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.xongQstamp <= 150000L)
        {
          if (this.Myself.talkCounter <= 2)
          {
            int millisecondsTimeout = 700;
            this.CallRemovePartyFollow();
            if (this.Myself.IsPartyFollowed == (byte) 1)
            {
              Thread.Sleep(1000);
              GA.TrieuTapToMyPos(this, num1, num2, num3);
              Thread.Sleep(3000);
            }
            this.CallTalkNPC(0, 0, num4);
            long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
            while (this.Myself.isQuestFrameShow == 0)
            {
              Thread.Sleep(200);
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds > 2000L)
                break;
            }
            this.CallTalkNPC(num5, menuIndex1, num4);
            Thread.Sleep(millisecondsTimeout);
            if (this.Myself.PacketMsg == "DGXQ")
            {
              this.CallTraNhiemVu();
              Thread.Sleep(millisecondsTimeout);
              this.CallTraNhiemVu();
              this.ResetPacketMsg();
              this.MyFlag.hongQcounter = 0;
            }
            else
            {
              this.CallNhanNhiemVu();
              Thread.Sleep(millisecondsTimeout);
              if (this.Myself.PacketMsg == "NVFQ")
              {
                this.MyFlag.nhanQstamp = 0L;
                ++this.MyFlag.fullQCounter;
                if (this.MyFlag.fullQCounter >= 6)
                {
                  this.MyFlag.fullQCounter = 0;
                  this.Myself.IsQ1 = false;
                  this.MyFlag.Q1UuTien = false;
                  Thread.Sleep(1500);
                  if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.fullQStamp <= 300000L && this.MyFlag.fullQStamp > 0L)
                  {
                    GA.WriteUserLog(frmMain.langFullQ12, this);
                    if (this.Settings.cboQ12Xong.Contains("ồi ch") || this.Settings.cboQ12Xong.Contains("Sit idle"))
                    {
                      GA.WriteUserLog(frmMain.langXongQ1, this);
                      return;
                    }
                    if (this.Settings.cboQ12Xong.Contains("áo độ") || this.Settings.cboQ12Xong.Contains("Alert"))
                    {
                      GA.WriteUserLog(frmMain.langXongQ1Alert1, this);
                      GA.ShowBalloon(frmMain.langFullQ12Content, frmMain.langXongQ1Alert2, this, 10000);
                      try
                      {
                        new SoundPlayer("event.wav").Play();
                        return;
                      }
                      catch (Exception ex)
                      {
                        return;
                      }
                    }
                    else
                    {
                      if (this.Settings.cboQ12Xong.Contains("át ga") || this.Settings.cboQ12Xong.Contains("Exit"))
                      {
                        GA.WriteUserLog(frmMain.langFulQ12ThoatGame, this);
                        GA.PartyDoSomething(this, true, 9);
                        return;
                      }
                      if (!this.Settings.cboQ12Xong.Contains("ắt m") && !this.Settings.cboQ12Xong.Contains("Shutd"))
                        return;
                      GA.WriteUserLog(frmMain.langFullQ12Shutdown, this);
                      Process.Start("shutdown", "/s /t 30000 /f");
                      return;
                    }
                  }
                  else
                  {
                    frmMain.frmMainInstance.cboxIsQ2.Invoke((Delegate) (() =>
                    {
                      this.MyFlag.DatLichFlag = true;
                      frmMain.frmMainInstance.NVQ2ToChau(this);
                    }));
                    this.MyFlag.fullQStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                    GA.WriteUserLog(frmMain.langFullQ1ChangeQ2, this);
                    return;
                  }
                }
                else
                  this.ResetPacketMsg();
              }
              if ((this.MyFlag.xongQstamp <= 0L || frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.xongQstamp > 150000L) && this.IsPartyKeyInt() != 1 && this.IsPartyKeyInt() == 2 && this.MyFlag.xongQstamp == 0L)
              {
                if (GA.CheckGameVersion(this.Target.VersionNum) == 356)
                {
                  this.CallTalkNPC(0, 0, num4);
                  Thread.Sleep(500);
                }
                this.CallTalkNPC(num6, menuIndex2, num4);
              }
              if (this.IsPartyKeyInt() == 1)
              {
                string npcName = "ân Đô Th";
                if (this.Target.SubVersion == 12 || this.Target.VersionNum == 4)
                  npcName = "oly Spear Kni";
                this.AddNPCNameToArray(npcName);
              }
            }
            if (this.Myself.PacketMsg == "NVTB")
            {
              if (this.MyFlag.hongQcounter >= 4)
              {
                if (this.Settings.cboxTuHuyNV)
                  this.HuyNhiemVu(num5);
                if (this.Settings.cboxHongQPT)
                  this.CallLeavePT();
                this.MyFlag.hongQcounter = 0;
              }
              else
                ++this.MyFlag.hongQcounter;
              this.ResetPacketMsg();
            }
            if (this.MyFlag.fullQCounter == 0)
            {
              GA.PartyTalkNPC(this, num4, num5, menuIndex1, mode: 1);
              ++this.Myself.talkCounter;
              GA.PartyTalkNPC(this, num4, num6, menuIndex2, false);
            }
            else
              GA.PartyTalkNPC(this, num4, num5, menuIndex1, mode: 2);
          }
          else
            ++this.Myself.talkCounter;
          if (this.Myself.talkCounter >= 1)
            this.Myself.talkCounter = 0;
        }
        else
        {
          this.CallRemovePartyFollow();
          GA.PartyDoSomething(this, mode: 4);
          GA.ShowBalloon(frmMain.langQ1KetMap, frmMain.langQ1Warning, this, 10000);
        }
      }
    }
    if (!GA.IsInPhuBan(this.Myself.MapID, this))
      return;
    this.MyFlag.nhanQstamp = 0L;
    this.MyFlag.hongQcounter = 0;
    if (this.IsPartyKeyInt() == 2)
    {
      this.LoadPathPoint(1120);
      this.CalcNearPoint();
    }
    else if (this.IsPartyKeyInt() == 1)
    {
      if (this.Settings.cboxDanhQuai)
        this.AttackQuai();
      if (this.Settings.cboxNMBuff)
        this.FuncNgaMySupport();
    }
    if (this.IsPartyKeyInt() == 2)
    {
      if (this.Myself.InPathPointIndex >= 1 && GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, 60.0, 13.0) < 20.0)
      {
        this.CallMoveTo(this.Myself.InMapPathPoints[0].PosX, this.Myself.InMapPathPoints[0].PosY);
        return;
      }
      bool flag2 = false;
      if (this.Myself.InPathPointIndex <= this.Myself.InMapPathPoints.Count - 3)
      {
        if (this.Myself.actionFlag <= 1)
        {
          string nguyTongQuanDoThong = frmMain.langNguyTongQuanDoThong;
          this.AddNPCNameToArray(nguyTongQuanDoThong);
          GA.PartyNoAttack(this, 1, nguyTongQuanDoThong);
          ++this.Myself.actionFlag;
        }
        if (this.Myself.InPathPointIndex == 0)
        {
          this.MyFlag.talkNPCStamp = 0L;
          if (!this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived)
          {
            this.CallPartyFollowMe(30000);
            if (this.Target.VersionNum == 3 && this.Target.SubVersion != 10)
              GA.PartyDoSomething(this, true, 13);
          }
          if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived && this.Myself.IsPartyFollowed == (byte) 0)
            GA.PartyDoSomething(this, true, 2, stamp: 60000);
        }
      }
      if (this.Myself.InPathPointIndex == 1)
      {
        if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived && this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared)
        {
          flag2 = true;
          this.Myself.DietGonFlag = 1;
          int num7 = 38;
          int num8 = 54;
          double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num7, (double) num8);
          if (distance > 3.0)
            this.CallMoveFlashPos(num7, num8);
          if (distance <= 3.0)
          {
            Thread.Sleep(1000);
            this.Myself.DietGonFlag = 0;
          }
        }
      }
      else if (this.Myself.InPathPointIndex == 2)
      {
        if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived && this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared)
        {
          flag2 = true;
          this.Myself.DietGonFlag = 1;
          int num9 = 22;
          int num10 = 86;
          double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num9, (double) num10);
          if (distance > 3.0)
            this.CallMoveFlashPos(num9, num10);
          if (distance <= 3.0)
          {
            Thread.Sleep(1000);
            this.Myself.DietGonFlag = 0;
          }
        }
      }
      else if (this.Myself.InPathPointIndex == 5)
      {
        if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived && this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared)
        {
          flag2 = true;
          this.Myself.DietGonFlag = 1;
          int num11 = 94;
          int num12 = 76;
          double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num11, (double) num12);
          if (distance > 3.0)
            this.CallMoveFlashPos(num11, num12);
          if (distance <= 3.0)
          {
            Thread.Sleep(1000);
            this.Myself.DietGonFlag = 0;
          }
        }
      }
      else if (this.Myself.InPathPointIndex == 6)
      {
        if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived && this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared)
        {
          flag2 = true;
          this.Myself.DietGonFlag = 1;
          int num13 = 109;
          int num14 = 48 /*0x30*/;
          double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num13, (double) num14);
          if (distance > 3.0)
            this.CallMoveFlashPos(num13, num14);
          if (distance <= 3.0)
          {
            Thread.Sleep(1000);
            this.Myself.DietGonFlag = 0;
          }
        }
      }
      else if (this.Myself.InPathPointIndex == 7)
      {
        if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived && this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared)
        {
          flag2 = true;
          this.Myself.DietGonFlag = 1;
          int num15 = 72;
          int num16 = 64 /*0x40*/;
          double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num15, (double) num16);
          if (distance > 3.0)
            this.CallMoveFlashPos(num15, num16);
          if (distance <= 3.0)
          {
            Thread.Sleep(1000);
            this.Myself.DietGonFlag = 0;
          }
        }
      }
      else if (this.Myself.InPathPointIndex == 8 && this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived && this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared)
      {
        if (!this.MyFlag.xonglinhQ1)
        {
          this.Myself.InPathPointIndex = 0;
          this.Myself.indexPPcalc = false;
          if (this.Myself.InMapPathPoints.Count > 0)
          {
            for (int index = 0; index < this.Myself.InMapPathPoints.Count; ++index)
            {
              this.Myself.InMapPathPoints[index].Arrived = false;
              this.Myself.InMapPathPoints[index].Cleared = false;
            }
          }
          this.MyFlag.sotquaiQ1 = true;
          if (!GA.isVipMember())
            return;
          GA.WriteUserLog("Sót quái Q1, quay lại tìm", this);
          return;
        }
        flag2 = true;
        this.Myself.DietGonFlag = 1;
        int num17 = 71;
        int num18 = 82;
        double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num17, (double) num18);
        if (distance > 3.0)
          this.CallMoveFlashPos(num17, num18);
        if (distance <= 3.0)
        {
          Thread.Sleep(1500);
          this.Myself.DietGonFlag = 0;
        }
      }
      if (this.Myself.InPathPointIndex == this.Myself.InMapPathPoints.Count - 2 && this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived)
      {
        int num19 = 80 /*0x50*/;
        int num20 = 88;
        flag2 = true;
        this.Myself.DietGonFlag = 1;
        GA.PartyDoSomething(this, true, 14);
        if (this.Myself.actionFlag <= 1)
        {
          if (this.Myself.IsPartyFollowed == (byte) 1)
            this.CallRemovePartyFollow();
          this.MyQuai.noAttackArray.Clear();
          GA.PartyNoAttack(this);
          ++this.Myself.actionFlag;
        }
        if (this.Myself.actionFlag == 2 || this.Myself.actionFlag == 3)
        {
          string tongQuanPhoDoThong = frmMain.langNguyTongQuanPhoDoThong;
          this.AddNPCNameToArray(tongQuanPhoDoThong);
          GA.PartyNoAttack(this, 1, tongQuanPhoDoThong);
          ++this.Myself.actionFlag;
        }
        if (!this.Myself.NhiemVuFinish)
        {
          string nguyTongQuanDoThong = frmMain.langNguyTongQuanDoThong;
          int count = 0;
          this.SearchQuai(ref count, nguyTongQuanDoThong);
          int num21 = 20;
          if (this.Target.VersionNum == 3 && this.Target.SubVersion == 2)
            num21 = 0;
          if (count > 0 && this.MyFlag.tempInt <= num21)
          {
            GA.TrieuTapToMyPos(this, 43, 91, this.Myself.MapID, false);
            if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num19, (double) num20) > 3.0)
            {
              if (this.Myself.ActionStatus == (byte) 7 && !this.Myself.NhiemVuFinish)
              {
                this.CallAttackTarget(-1, 34, 0, 0);
                this.CallAttackTarget(-1, this.GetKhinhCongID(), 0, 0);
                Thread.Sleep(200);
              }
              this.CallMoveFlashPos(num19, num20);
            }
          }
        }
        if (this.Myself.EventString == "DDQDT" || this.Myself.PacketMsg == "DDQDT")
        {
          this.Myself.NhiemVuFinish = true;
          GA.TrieuTapToMyPos(this, 43, 91, this.Myself.MapID, false);
          if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num19, (double) num20) > 2.0)
          {
            if (this.Myself.ActionStatus == (byte) 7)
            {
              this.CallAttackTarget(-1, 34, 0, 0);
              this.CallAttackTarget(-1, this.GetKhinhCongID(), 0, 0);
              Thread.Sleep(200);
            }
            this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
            this.CallMoveFlashPos(num19, num20);
          }
          else
          {
            this.Myself.Status = AllEnums.CharStatuses.IDLE;
            this.MyQuai.noAttackArray.Clear();
            GA.PartyNoAttack(this);
          }
          if (this.MyFlag.SaveFightMode == AllEnums.FightingModes.DANHPETONLY)
            GA.PartyDoSomething(this, true, 20, 14);
        }
        if (this.Settings.cboxDanhQuai)
          this.AttackQuai();
        if (this.Settings.cboxNMBuff)
          this.FuncNgaMySupport();
        if (this.Myself.EventString == "DDPL" || this.Myself.PacketMsg == "DDPL")
        {
          this.Myself.DietGonFlag = 0;
          this.MyQuai.noAttackArray.Clear();
          GA.PartyNoAttack(this);
          GA.TrieuTapToMyPos(this, 67, 81, this.Myself.MapID);
          this.ResetEventString();
          this.ResetPacketMsg();
          this.Myself.actionFlag = 0;
          this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
          string tongQuanPhoDoThong = frmMain.langNguyTongQuanPhoDoThong;
          int count = 0;
          this.SearchQuai(ref count, tongQuanPhoDoThong);
          if (count > 0 && this.Settings.cboxDanhQuai)
          {
            if (this.Myself.Status == AllEnums.CharStatuses.GOGOGO)
              this.Myself.Status = AllEnums.CharStatuses.IDLE;
            if (this.Myself.IsPartyFollowed == (byte) 1)
              this.CallRemovePartyFollow();
            this.AttackQuai();
          }
          GA.PartyDoSomething(this, true, 2);
          if (this.MyFlag.SaveFightMode != AllEnums.FightingModes.DANHPETONLY)
            GA.PartyDoSomething(this, true, 21, 30);
        }
      }
      if (this.Myself.InPathPointIndex == this.Myself.InMapPathPoints.Count - 1)
      {
        if (!this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived)
        {
          string tongQuanPhoDoThong = frmMain.langNguyTongQuanPhoDoThong;
          int count = 0;
          this.SearchQuai(ref count, tongQuanPhoDoThong);
          if (count > 0)
          {
            flag2 = true;
            this.Myself.DietGonFlag = 1;
            if (this.Settings.cboxDanhQuai)
            {
              if (this.Myself.Status == AllEnums.CharStatuses.GOGOGO)
                this.Myself.Status = AllEnums.CharStatuses.IDLE;
              if (this.Myself.IsPartyFollowed == (byte) 1)
                this.CallRemovePartyFollow();
              this.AttackQuai();
            }
          }
        }
        if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived)
        {
          flag2 = true;
          this.Myself.DietGonFlag = 1;
          if (this.Myself.actionFlag <= 3)
          {
            if (this.Myself.IsPartyFollowed == (byte) 1)
              this.CallRemovePartyFollowSafe();
            this.MyQuai.noAttackArray.Clear();
            GA.PartyNoAttack(this);
            ++this.Myself.actionFlag;
          }
          if (this.Settings.cboxDanhQuai)
            this.AttackQuai();
          if (this.Settings.cboxNMBuff)
            this.FuncNgaMySupport();
          if (this.Myself.EventString == "TDDD" || this.Myself.PacketMsg == "TDDD")
          {
            if (this.Myself.actionFlag == 4)
            {
              GA.PartyDoSomething(this, true, 2);
              Thread.Sleep(5000);
              GA.PartyDoSomething(this, true, 1);
              if (this.Myself.IsPartyFollowed == (byte) 0)
                this.CallPartyFollowMe();
              this.Myself.TargetX = 0.0f;
              this.Myself.TargetY = 0.0f;
              ++this.Myself.actionFlag;
              this.Settings.cboxTheoSau = true;
            }
            if (this.Myself.actionFlag <= 5)
            {
              int num22 = 38;
              int num23 = 70;
              double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num22, (double) num23);
              if (distance > 3.0)
                this.CallMoveFlashPos(num22, num23);
              if (distance <= 3.0)
                ++this.Myself.actionFlag;
            }
            if (this.Myself.actionFlag == 6)
            {
              int num24 = 29;
              int num25 = 35;
              double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num24, (double) num25);
              if (distance > 3.0)
                this.CallMoveFlashPos(num24, num25);
              if (distance <= 3.0)
                ++this.Myself.actionFlag;
            }
            if (this.Myself.actionFlag >= 7)
              this.CallMoveFlashPos(30, 12);
          }
        }
      }
      if (!flag2)
      {
        this.Myself.actionFlag = 0;
        this.Myself.DietGonFlag = 0;
      }
    }
    if (this.Myself.EventString == "DXNTB" || this.Myself.PacketMsg == "DXNTB")
    {
      this.MyFlag.xonglinhQ1 = true;
      if (this.IsPartyKeyInt() == 2 && this.Myself.InPathPointIndex < this.Myself.InMapPathPoints.Count - 4)
      {
        this.Myself.InPathPointIndex = this.Myself.InMapPathPoints.Count - 4;
        this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
      }
      if (this.IsPartyKeyInt() == 1)
        this.MyQuai.noAttackArray.Clear();
      this.ResetEventString();
      this.ResetPacketMsg();
    }
    bool flag3 = false;
    if (this.IsPartyKeyInt() == 1 && this.MyQuai.noAttackArray.Count == 0 && !this.Myself.NhiemVuFinish && GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, 62.0, 84.0) < 10.0 && ((double) this.MyQuai.TargetHPPercent <= 15.0 && this.Myself.HasTarget || (double) this.MyQuai.TargetHPPercent == 0.0 && this.Myself.HasTarget))
      flag3 = true;
    if (this.Myself.EventString == "DDQDT" || this.Myself.PacketMsg == "DDQDT" || flag3)
    {
      this.Myself.NhiemVuFinish = true;
      this.MyFlag.nodelayAction = frmLogin.GlobalTimer.ElapsedMilliseconds;
      if (this.MyFlag.SaveFightMode == AllEnums.FightingModes.DANHPETONLY)
      {
        this.MyFlag.SaveFightMode = this.Settings.FightMode;
        this.Settings.FightMode = AllEnums.FightingModes.DANHGOMQUAI;
      }
      int posX = 80 /*0x50*/;
      int posY = 88;
      if (this.IsPartyKeyInt() == 1 && this.Settings.cboQ1Cau.Contains(frmMain.langQ1Bridge))
      {
        posX = 43;
        posY = 91;
        this.Settings.cboxTheoSau = false;
      }
      if (this.GoToMyPos(posX, posY, this.Myself.MapID))
      {
        this.Myself.Status = AllEnums.CharStatuses.IDLE;
        this.ResetEventString();
        this.ResetPacketMsg();
      }
      else
      {
        if (this.Myself.ActionStatus == (byte) 7)
        {
          this.CallAttackTarget(-1, 34, 0, 0);
          this.CallAttackTarget(-1, this.GetKhinhCongID(), 0, 0);
          Thread.Sleep(200);
        }
        this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
      }
      GA.TrieuTapToMyPos(this, 43, 91, this.Myself.MapID, false);
      this.Myself.DietGonFlag = 1;
      if (this.IsPartyKeyInt() == 2)
        this.CallMoveFlashPos(80 /*0x50*/, 88);
    }
    if (this.Myself.EventString == "DDPL" || this.Myself.PacketMsg == "DDPL")
    {
      this.Myself.DietGonFlag = 0;
      this.MyQuai.noAttackArray.Clear();
      GA.PartyNoAttack(this);
      GA.TrieuTapCaNhom(this, true);
      this.ResetEventString();
      this.ResetPacketMsg();
      this.Myself.actionFlag = 0;
      if (this.Myself.InPathPointIndex > 0)
        this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
      this.Settings.cboxTheoSau = true;
      GA.PartyDoSomething(this, true, 2);
      if (this.MyFlag.SaveFightMode != AllEnums.FightingModes.DANHPETONLY)
      {
        this.Settings.FightMode = this.MyFlag.SaveFightMode;
        this.MyFlag.SaveFightMode = AllEnums.FightingModes.DANHPETONLY;
      }
    }
    if ((this.Myself.EventString == "TDDD" || this.Myself.PacketMsg == "TDDD") && this.Myself.actionFlag <= 4)
    {
      GA.PartyDoSomething(this, true, 2);
      if (this.IsPartyKeyInt() == 2)
        Thread.Sleep(5000);
      GA.PartyDoSomething(this, true, 1);
      if (this.Myself.IsPartyFollowed == (byte) 0)
        this.CallPartyFollowMe();
      this.Myself.TargetX = 0.0f;
      this.Myself.TargetY = 0.0f;
      this.CallMoveFlashPos(30, 12);
      this.Settings.cboxTheoSau = true;
    }
    if (this.IsPartyKeyInt() != 2)
      return;
    bool flag4 = true;
    if (this.Target.SubVersion == 4 && frmLogin.GAuto.Settings.EnableQ12 == 0 && this.Myself.InPathPointIndex < 1 && !this.MyFlag.sotquaiQ1 && this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared && !GA.isVipMember() && !GA.IsCTVMember() && !this.MyFlag.Q1UuTien)
    {
      this.Myself.IsQ1 = false;
      GA.ShowBalloon("Tính năng tự động tắt\nĐến tọa độ (29,53) để mở lại", frmMain.langCharacter, this, 3000);
      flag4 = false;
    }
    if (!flag4 || this.Myself.DietGonFlag != 0)
      return;
    this.PhuBanDacBiet(startIndex: this.Myself.InPathPointIndex);
  }

  public void NhiemVuTruHai()
  {
    bool flag1 = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    if (!flag1 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 500L)
      return;
    this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    string name = "ã Hùn";
    string str = "ng Vươ";
    if (this.Target.SubVersion == 12 || this.Target.VersionNum == 4)
    {
      name = "ild Bear";
      str = "ed Bear Kin";
    }
    if (!GA.IsInPhuBan(this.Myself.MapID, this))
    {
      int num1 = 353;
      int num2 = 203;
      int num3 = 1;
      int num4 = 33;
      int num5 = 50101;
      int menuIndex1 = 1;
      int num6 = 50101;
      int menuIndex2 = 2;
      if (this.Target.VersionNum == 3 && this.Target.SubVersion != 2)
      {
        num1 = 351;
        num2 = 204;
      }
      if (this.Target.VersionNum == 3 && this.Target.SubVersion == 10)
        num4 = 28;
      this.Myself.indexPPcalc = false;
      this.Myself.TruHaiFlag = 0;
      this.ResetEventString();
      this.ResetPacketMsg();
      this.Myself.TruHaiFlag = 0;
      this.Myself.actionFlag = 0;
      this.Myself.NhiemVuFinish = false;
      this.Myself.PBEnding = false;
      this.Myself.PBxong1vong = false;
      this.Myself.NhiemVuCounter = 0;
      this.MyFlag.truhaiFoundBoss = 0;
      this.MyFlag.dosomethingCounter = 0;
      this.MyFlag.Q2_ppCounter = 0;
      if (this.Myself.InMapPathPoints.Count > 0)
      {
        this.Myself.InMapPathPoints.Clear();
        this.Myself.InPathPointIndex = 0;
      }
      ++this.Myself.trieutapCounter;
      if (this.Myself.trieutapCounter == 1)
        GA.TrieuTapToMyPos(this, num1, num2, num3);
      else if (this.Myself.trieutapCounter >= 3)
        this.Myself.trieutapCounter = 0;
      if (this.GoToMyPos(num1, num2, num3) && this.WaitPartyFull(this.Settings.numQ12ChoPT - 1, this.Settings.numPTLevel))
      {
        if (this.IsPartyKeyInt() == 2 && !this.Settings.cboxTuHuyNV)
        {
          if (this.MyFlag.nhanQstamp == 0L)
            this.MyFlag.nhanQstamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
          if (this.MyFlag.nhanQstamp > 0L && frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.nhanQstamp >= 240000L)
          {
            this.MyFlag.nhanQstamp = 0L;
            if (frmLogin.GAuto.Settings.cboxQ12AutoExtend)
            {
              GA.WriteUserLog(frmMain.langQ2Over4min, this);
              frmLogin.GAuto.Settings.cboxQ12AutoExtend = false;
              return;
            }
          }
        }
        this.MyFlag.NamePartyArray.Clear();
        this.CallMoveTo(num1, num2);
        GA.TrieuTapCaNhom(this, true);
        if (this.CheckMemberGPS(7, num1, num2, num3) || this.IsPartyKeyInt() == 1 || this.MyFlag.xongQstamp > 0L && frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.xongQstamp <= 150000L)
        {
          if (this.Myself.talkCounter <= 2)
          {
            int millisecondsTimeout = 700;
            this.CallRemovePartyFollow();
            this.CallTalkNPC(0, 0, num4);
            long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
            while (this.Myself.isQuestFrameShow == 0)
            {
              Thread.Sleep(200);
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds > 2000L)
                break;
            }
            this.CallTalkNPC(num5, menuIndex1, num4);
            Thread.Sleep(millisecondsTimeout);
            if (this.Myself.PacketMsg == "DGXQ")
            {
              this.CallTraNhiemVu();
              Thread.Sleep(millisecondsTimeout);
              this.CallTraNhiemVu();
              this.ResetPacketMsg();
              this.MyFlag.hongQcounter = 0;
            }
            else
            {
              this.CallNhanNhiemVu();
              Thread.Sleep(millisecondsTimeout);
              if (this.Myself.PacketMsg == "NVFQ" || this.Myself.PacketMsg == "CDDLB")
              {
                this.MyFlag.nhanQstamp = 0L;
                ++this.MyFlag.fullQCounter;
                if (this.MyFlag.fullQCounter >= 6)
                {
                  this.MyFlag.fullQCounter = 0;
                  this.Myself.IsQ2 = false;
                  this.MyFlag.Q2UuTien = false;
                  Thread.Sleep(1500);
                  if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.fullQStamp <= 300000L && this.MyFlag.fullQStamp > 0L)
                  {
                    if (this.Myself.PacketMsg == "NVFQ")
                      GA.WriteUserLog(frmMain.langFullQ12StopAuto, this);
                    else
                      GA.WriteUserLog(frmMain.langOutOfTokenQ12, this);
                    if (this.Settings.cboQ12Xong.Contains("ồi ch") || this.Settings.cboQ12Xong.Contains("idle"))
                    {
                      GA.WriteUserLog(frmMain.langFullQ12SitIdle, this);
                      return;
                    }
                    if (this.Settings.cboQ12Xong.Contains("áo độ") || this.Settings.cboQ12Xong.Contains("Alert"))
                    {
                      GA.WriteUserLog(frmMain.langfullq12Alert, this);
                      GA.ShowBalloon(frmMain.langFullQ12Content, frmMain.langXongQ1Alert2, this, 10000);
                      try
                      {
                        new SoundPlayer("event.wav").Play();
                        return;
                      }
                      catch (Exception ex)
                      {
                        return;
                      }
                    }
                    else
                    {
                      if (this.Settings.cboQ12Xong.Contains("át ga") || this.Settings.cboQ12Xong.Contains("game"))
                      {
                        GA.WriteUserLog(frmMain.langFulQ12ThoatGame, this);
                        GA.PartyDoSomething(this, true, 9);
                        return;
                      }
                      if (!this.Settings.cboQ12Xong.Contains("ắt m") && !this.Settings.cboQ12Xong.Contains("tdown"))
                        return;
                      GA.WriteUserLog(frmMain.langFullQ12Shutdown, this);
                      Process.Start("shutdown", "/s /t 30000 /f");
                      return;
                    }
                  }
                  else
                  {
                    frmMain.frmMainInstance.cboxIsQ1.Invoke((Delegate) (() =>
                    {
                      this.MyFlag.DatLichFlag = true;
                      frmMain.frmMainInstance.NVQ1ToChau(this);
                    }));
                    if (this.Myself.PacketMsg == "NVFQ")
                    {
                      GA.WriteUserLog(frmMain.langFullQ1ChuyenQ1, this);
                      return;
                    }
                    GA.WriteUserLog(frmMain.langFullTokenToQ1, this);
                    return;
                  }
                }
                else
                  this.ResetPacketMsg();
              }
              if ((this.MyFlag.xongQstamp <= 0L || frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.xongQstamp > 150000L) && this.IsPartyKeyInt() != 1 && this.IsPartyKeyInt() == 2 && this.MyFlag.xongQstamp == 0L)
                this.CallTalkNPC(num6, menuIndex2, num4);
            }
            if (this.Myself.PacketMsg == "NVTB")
            {
              if (this.MyFlag.hongQcounter >= 4)
              {
                if (this.Settings.cboxTuHuyNV)
                  this.HuyNhiemVu(num5);
                if (this.Settings.cboxHongQPT)
                  this.CallLeavePT();
                this.MyFlag.hongQcounter = 0;
              }
              else
                ++this.MyFlag.hongQcounter;
              this.ResetPacketMsg();
            }
            if (this.MyFlag.fullQCounter == 0)
            {
              GA.PartyTalkNPC(this, num4, num5, menuIndex1, mode: 1);
              ++this.Myself.talkCounter;
              GA.PartyTalkNPC(this, num4, num6, menuIndex2, false);
            }
            else
              GA.PartyTalkNPC(this, num4, num5, menuIndex1, mode: 2);
          }
          else
            ++this.Myself.talkCounter;
          if (this.Myself.talkCounter >= 1)
            this.Myself.talkCounter = 0;
        }
        else
          GA.ShowBalloon(frmMain.langQ1KetMap, frmMain.langQ2Warning, this, 10000);
      }
    }
    if (!GA.IsInPhuBan(this.Myself.MapID, this))
      return;
    if (!this.Settings.PTYeu || this.IsPartyKeyInt() == 1 || this.Myself.PBxong1vong)
    {
      this.MyFlag.nhanQstamp = 0L;
      if (this.IsPartyKeyInt() == 2)
      {
        this.LoadPathPoint(1130);
        this.CalcNearPoint();
      }
      if (this.Myself.TruHaiFlag == 0)
      {
        if (this.Myself.actionFlag == 0)
        {
          Thread.Sleep(4000);
          this.AddNPCNameToArray(str);
          GA.PartyNoAttack(this, 1, str);
          ++this.Myself.actionFlag;
        }
        if (this.Myself.IsPartyFollowed == (byte) 0 && this.Myself.InPathPointIndex < this.Myself.InMapPathPoints.Count - 2 && this.Myself.ActionStatus != (byte) 7)
        {
          int waitTimeOut = 30000;
          if (this.Myself.PBxong1vong)
            waitTimeOut = 5000;
          this.CallPartyFollowMe(waitTimeOut);
        }
        if (this.IsPartyKeyInt() == 2)
        {
          if (this.Myself.PBxong1vong)
          {
            int count = 0;
            this.SearchQuai(ref count, name);
            if (count > 0)
            {
              this.CallRemovePartyFollow();
              this.Myself.Status = AllEnums.CharStatuses.IDLE;
              if (this.Myself.HorseType != -1)
                this.CallXuongNgua();
              Thread.Sleep(500);
              this.AttackQuai();
              Thread.Sleep(1000);
            }
            if (this.Myself.NhiemVuFinish)
            {
              count = 0;
              this.SearchQuai(ref count, str);
              if (count > 0)
              {
                this.CallMoveTo(this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY);
                Thread.Sleep(1500);
                this.Myself.TruHaiFlag = 1;
                ++this.MyFlag.truhaiFoundBoss;
                return;
              }
            }
          }
          bool flag2 = true;
          if (!this.Myself.PBxong1vong && this.Target.SubVersion == 4 && frmLogin.GAuto.Settings.EnableQ12 == 0 && this.Myself.InPathPointIndex < 4 && !GA.isVipMember() && !GA.IsCTVMember() && !this.MyFlag.Q2UuTien)
          {
            this.Myself.IsQ2 = false;
            GA.ShowBalloon("Tính năng tự động tắt\nĐến tọa độ (26,107) để mở lại", frmMain.langCharacter, this, 10000);
            flag2 = false;
          }
          if (flag2 && this.LureQuai())
          {
            this.AddNPCNameToArray(str);
            GA.PartyNoAttack(this, 1, str);
            this.Myself.TruHaiFlag = 1;
            this.Myself.PBxong1vong = true;
          }
        }
        else if (this.MyParty.PartyNumbers >= 2)
          this.Myself.TruHaiFlag = 1;
      }
      if (this.Myself.TruHaiFlag == 1)
      {
        if (this.Myself.InPathPointIndex >= 20 || this.Myself.InPathPointIndex == 0)
        {
          if (this.Myself.IsPartyFollowed == (byte) 1)
          {
            this.CallRemovePartyFollow();
            GA.PartyDoSomething(this, true, 2);
          }
          this.Myself.Status = AllEnums.CharStatuses.IDLE;
          this.AttackQuai();
          if (this.Myself.NhiemVuFinish)
          {
            this.MyFlag.nodelayAction = frmLogin.GlobalTimer.ElapsedMilliseconds;
            if ((double) this.MyQuai.TargetHPPercent <= 65.0 && this.Myself.HasTarget && (double) this.MyQuai.TargetHPPercent > 0.0)
            {
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.dosomethingStamp >= 2000L)
                this.MyFlag.dosomethingStamp = 0L;
              if (this.MyFlag.dosomethingStamp == 0L)
              {
                GA.PartyDoSomething(this, true, 3);
                ++this.MyFlag.dosomethingCounter;
              }
            }
          }
        }
        if (this.Myself.EventString == "DDDH" || this.Myself.PacketMsg == "DDDH")
        {
          this.MyQuai.noAttackArray.Clear();
          GA.PartyNoAttack(this);
          this.Myself.NhiemVuFinish = true;
          GA.PartyDoSomething(this, true, 2);
          this.ResetEventString();
          this.ResetPacketMsg();
        }
        if ((this.Myself.EventString == "DDHV" || this.Myself.PacketMsg == "DDHV") && !this.Myself.PBEnding)
        {
          GA.PartyDoSomething(this, true, 2);
          this.MyFlag.nodelayAction = 0L;
          Thread.Sleep(500);
          GA.PartyDoSomething(this, true, 1);
          this.Myself.PBEnding = true;
          this.ResetEventString();
          this.ResetPacketMsg();
        }
        if (this.IsPartyKeyInt() == 2)
        {
          bool flag3 = false;
          if (this.MyQuai.AllQuai.Count > 0)
          {
            int num7 = 0;
            int num8 = 0;
            try
            {
              for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
              {
                QuaiIndividual quaiIndividual = this.MyQuai.AllQuai[index];
                bool flag4 = true;
                if (this.HasActivePet())
                {
                  if (quaiIndividual.ID != this.MyPet.AllPets[this.MyPet.ActivePetIndex].ID)
                    flag4 = false;
                }
                else
                  flag4 = false;
                if (quaiIndividual.ID >= 0 && (double) quaiIndividual.HPPercent > 0.0 && quaiIndividual.ID != this.Myself.ID && !flag4 && quaiIndividual.Name.Contains(name))
                  ++num7;
                if (quaiIndividual.ID >= 0 && (double) quaiIndividual.HPPercent > 0.0 && quaiIndividual.ID != this.Myself.ID && !flag4 && quaiIndividual.Name.Contains(str))
                {
                  if (this.Myself.NhiemVuFinish)
                  {
                    double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quaiIndividual.PosX, (double) quaiIndividual.PosY);
                    if (distance > 3.0)
                    {
                      this.CallMoveTo((int) quaiIndividual.PosX, (int) quaiIndividual.PosY);
                      Thread.Sleep((int) distance * 150);
                    }
                    this.CallRemovePartyFollow();
                    this.CallXuongNgua();
                    this.Myself.Status = AllEnums.CharStatuses.IDLE;
                    this.AttackQuai();
                    if ((double) this.MyQuai.TargetHPPercent <= 65.0 && this.Myself.HasTarget && (double) this.MyQuai.TargetHPPercent > 0.0)
                    {
                      if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp >= 2000L)
                        this.MyFlag.dosomethingStamp = 0L;
                      if (this.MyFlag.dosomethingStamp == 0L)
                      {
                        GA.PartyDoSomething(this, true, 3);
                        ++this.MyFlag.dosomethingCounter;
                      }
                    }
                  }
                  ++num8;
                }
              }
            }
            catch (Exception ex)
            {
              GA.WriteUserLog(frmMain.langErrorFoundMobQ2, this);
            }
            if (num7 >= 1)
              this.MyFlag.nodelayAction = frmLogin.GlobalTimer.ElapsedMilliseconds;
            if (num7 <= 0)
            {
              int posX = 69;
              int posY = 112 /*0x70*/;
              if (!this.Myself.NhiemVuFinish)
              {
                this.CallPartyFollowMe();
                this.Myself.InPathPointIndex = 2;
                this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
                if (this.GoToMyPos(posX, posY, this.Myself.MapID))
                {
                  this.Myself.TruHaiFlag = 0;
                  this.Myself.Status = AllEnums.CharStatuses.IDLE;
                  if (this.Myself.InMapPathPoints.Count > 0)
                  {
                    for (int index = 0; index < this.Myself.InMapPathPoints.Count; ++index)
                      this.Myself.InMapPathPoints[index].Arrived = false;
                  }
                }
              }
              else if (!this.Myself.PBEnding && num8 <= 0)
                flag3 = true;
            }
            else if (this.Myself.PBxong1vong && this.Myself.InPathPointIndex < 20 && this.Myself.InPathPointIndex > 0)
              this.Myself.TruHaiFlag = 0;
          }
          else if (!this.Myself.PBEnding)
            flag3 = true;
          if (flag3 && !this.Myself.PBEnding)
          {
            int posX = 89;
            int posY = 89;
            if (this.Myself.NhiemVuFinish)
            {
              this.CallLenNgua();
              if (this.MyFlag.truhaiFoundBoss == 0 && this.Myself.HorseType != -1)
              {
                this.CallPartyFollowMe();
                this.Myself.InPathPointIndex = 11;
                this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
                if (this.GoToMyPos(posX, posY, this.Myself.MapID))
                {
                  this.Myself.TruHaiFlag = 0;
                  this.Myself.Status = AllEnums.CharStatuses.IDLE;
                  if (this.Myself.InMapPathPoints.Count > 0)
                  {
                    for (int index = 0; index < this.Myself.InMapPathPoints.Count; ++index)
                      this.Myself.InMapPathPoints[index].Arrived = false;
                    this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived = true;
                  }
                }
                int count = 0;
                this.SearchQuai(ref count, str);
                if (count > 0)
                {
                  double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) this.Myself.NhiemVuPosX, (double) this.Myself.NhiemVuPosY);
                  this.CallMoveTo(this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY);
                  Thread.Sleep((int) distance * 100);
                  ++this.MyFlag.truhaiFoundBoss;
                  return;
                }
              }
              else if (this.Myself.HorseType != -1)
              {
                this.CallPartyFollowMe(3000);
                this.Myself.TruHaiFlag = 0;
              }
            }
          }
        }
      }
    }
    if (!this.Settings.PTYeu || this.IsPartyKeyInt() != 2 || this.Myself.PBxong1vong)
      return;
    int mapID = 1131;
    if (this.MyFlag.Q2_ppCounter == 1)
      mapID = 1132;
    if (this.MyFlag.Q2_ppCounter == 2)
      mapID = 1133;
    this.LoadPathPoint(mapID);
    this.CalcNearPoint();
    if (this.Myself.TruHaiFlag == 0)
    {
      if (this.Myself.actionFlag == 0)
      {
        Thread.Sleep(4000);
        this.AddNPCNameToArray(str);
        GA.PartyNoAttack(this, 1, str);
        ++this.Myself.actionFlag;
      }
      if (this.Myself.IsPartyFollowed == (byte) 0 && this.Myself.InPathPointIndex < this.Myself.InMapPathPoints.Count - 2)
        this.CallPartyFollowMe(30000);
      if (this.IsPartyKeyInt() == 2)
      {
        if (this.Myself.PBxong1vong)
        {
          int count = 0;
          this.SearchQuai(ref count, name);
          if (count > 0)
          {
            this.CallRemovePartyFollow();
            this.Myself.Status = AllEnums.CharStatuses.IDLE;
            this.AttackQuai();
          }
          if (this.Myself.NhiemVuFinish)
          {
            count = 0;
            this.SearchQuai(ref count, str);
            if (count > 0)
            {
              this.CallMoveTo(this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY);
              Thread.Sleep(1500);
              this.Myself.TruHaiFlag = 1;
              ++this.MyFlag.truhaiFoundBoss;
              return;
            }
          }
        }
        bool flag5 = true;
        if (!this.Myself.PBxong1vong && this.Target.SubVersion == 4 && frmLogin.GAuto.Settings.EnableQ12 == 0 && this.Myself.InPathPointIndex < 4 && !GA.isVipMember() && !GA.IsCTVMember() && !this.MyFlag.Q2UuTien)
        {
          this.Myself.IsQ2 = false;
          GA.ShowBalloon("Tính năng tự động tắt\nĐến tọa độ (26,107) để mở lại", frmMain.langCharacter, this, 3000);
          flag5 = false;
        }
        if (flag5 && this.LureQuai())
        {
          this.AddNPCNameToArray(str);
          GA.PartyNoAttack(this, 1, str);
          this.Myself.TruHaiFlag = 1;
          ++this.MyFlag.Q2_ppCounter;
          if (this.MyFlag.Q2_ppCounter >= 3)
          {
            this.Myself.InPathPointIndex = 28;
            this.Myself.PBxong1vong = true;
          }
        }
      }
      else if (this.MyParty.PartyNumbers >= 2)
        this.Myself.TruHaiFlag = 1;
    }
    if (this.Myself.TruHaiFlag != 1)
      return;
    if (this.Myself.InPathPointIndex >= 7 || this.Myself.InPathPointIndex == 0)
    {
      if (this.Myself.IsPartyFollowed == (byte) 1)
      {
        this.CallRemovePartyFollow();
        GA.PartyDoSomething(this, true, 2);
      }
      this.Myself.Status = AllEnums.CharStatuses.IDLE;
      this.AttackQuai();
    }
    if (this.IsPartyKeyInt() != 2)
      return;
    if (this.MyQuai.AllQuai.Count > 0)
    {
      int num9 = 0;
      int num10 = 0;
      try
      {
        for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
        {
          QuaiIndividual quaiIndividual = this.MyQuai.AllQuai[index];
          bool flag6 = true;
          if (this.HasActivePet())
          {
            if (quaiIndividual.ID != this.MyPet.AllPets[this.MyPet.ActivePetIndex].ID)
              flag6 = false;
          }
          else
            flag6 = false;
          if (quaiIndividual.ID >= 0 && (double) quaiIndividual.HPPercent > 0.0 && quaiIndividual.ID != this.Myself.ID && !flag6 && quaiIndividual.Name.Contains(name))
            ++num9;
          if (quaiIndividual.ID >= 0 && (double) quaiIndividual.HPPercent > 0.0 && quaiIndividual.ID != this.Myself.ID && !flag6 && quaiIndividual.Name.Contains(str))
          {
            if (this.Myself.NhiemVuFinish)
            {
              double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quaiIndividual.PosX, (double) quaiIndividual.PosY);
              if (distance > 3.0)
              {
                this.CallMoveTo((int) quaiIndividual.PosX, (int) quaiIndividual.PosY);
                Thread.Sleep((int) distance * 150);
              }
              this.CallRemovePartyFollow();
              this.CallXuongNgua();
              this.Myself.Status = AllEnums.CharStatuses.IDLE;
              this.AttackQuai();
              if ((double) this.MyQuai.TargetHPPercent <= 65.0 && this.Myself.HasTarget && (double) this.MyQuai.TargetHPPercent > 0.0)
              {
                if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp >= 2000L)
                  this.MyFlag.dosomethingStamp = 0L;
                if (this.MyFlag.dosomethingStamp == 0L)
                {
                  GA.PartyDoSomething(this, true, 3);
                  ++this.MyFlag.dosomethingCounter;
                }
              }
            }
            ++num10;
          }
        }
      }
      catch (Exception ex)
      {
        GA.WriteUserLog(frmMain.langErrorFoundMobQ2, this);
      }
      if (num9 >= 1)
        this.MyFlag.nodelayAction = frmLogin.GlobalTimer.ElapsedMilliseconds;
      if (num9 > 0)
        return;
      this.Myself.TruHaiFlag = 0;
      this.Myself.InMapPathPoints.Clear();
      this.Myself.InPathPointIndex = 0;
    }
    else
    {
      this.Myself.TruHaiFlag = 0;
      this.Myself.InMapPathPoints.Clear();
      this.Myself.InPathPointIndex = 0;
    }
  }

  public void NhiemVuTrongHoa()
  {
    if (this.MyFlag.NoTrongHoaBonHoaStamp > this.nowStamp())
    {
      if (!this.Myself.isThuHoach)
        return;
      this.NhiemVuThuHoachHoa(10);
    }
    else
    {
      bool flag1 = false;
      if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
        flag1 = true;
      if (!flag1 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 300L)
        return;
      this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
      int num1 = 47;
      int num2 = 290;
      int num3 = 143;
      int Y1 = 154;
      int mapID = 2;
      bool flag2 = true;
      int num4 = 30505260;
      if (this.Myself.MapID != mapID)
      {
        this.CallOutMapMove(252, 122, mapID);
      }
      else
      {
        if ((double) this.Myself.PosX < (double) num1 || (double) this.Myself.PosX > (double) num2 || (int) this.Myself.PosY < num3 || (int) this.Myself.PosY > Y1)
          flag2 = false;
        if (!flag2)
        {
          if (this.Myself.NhiemVuPosX <= 0 && this.Myself.NhiemVuPosY <= 0)
          {
            Random random = new Random();
            this.CallSetUpNhiemVuData((int) this.Myself.PosX, 143);
          }
          if (this.Myself.NhiemVuPosX > 0 && this.Myself.NhiemVuPosY > 0)
            this.CallInMapMove(this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY);
        }
        if (!flag2)
          return;
        if (!this.MyFlag.TrongHoaFirstMove)
        {
          for (int index = 0; index <= 20; ++index)
          {
            this.CallMoveTo((int) this.Myself.PosX, Y1);
            if (Math.Abs((int) this.Myself.PosY - Y1) <= 1)
            {
              Thread.Sleep(500);
              break;
            }
            Thread.Sleep(500);
          }
          this.MyFlag.TrongHoaFirstMove = true;
          if (this.MyFlag.ToaDoTrongHoaList.Count > 0 && GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) this.MyFlag.ToaDoTrongHoaList[0].posX, (double) this.MyFlag.ToaDoTrongHoaList[0].posY) >= 15.0)
          {
            this.MyFlag.ToaDoTrongHoaList.Clear();
            this.MyFlag.TrongHoaListMax = (frmLogin.GAuto.Settings.soHangTrongHoa - 1) * 6;
          }
        }
        int itemIndex = -1;
        for (int index = 0; index < 30; ++index)
        {
          if (this.MyInventory.AllItems[index].ItemID == num4)
          {
            itemIndex = index;
            break;
          }
        }
        if (itemIndex >= 0)
        {
          int num5 = frmLogin.GAuto.Settings.soHangTrongHoa - 1;
          this.MyFlag.TrongHoaListMax = num5 * 6;
          int num6 = 2;
          if (this.MyFlag.ToaDoTrongHoaList.Count < this.MyFlag.TrongHoaListMax)
          {
            int posX = (int) this.Myself.PosX;
            int posY = (int) this.Myself.PosY;
            int num7 = 1;
            for (int index1 = 0; index1 <= num5; ++index1)
            {
              for (int index2 = 0; index2 <= 4; ++index2)
              {
                this.MyFlag.ToaDoTrongHoaList.Add(new MyFlagClass.ToaDoTrongHoaClass()
                {
                  posX = posX,
                  posY = posY
                });
                if (num7 % 2 == 0)
                  posY += num6;
                else
                  posY -= num6;
              }
              this.MyFlag.ToaDoTrongHoaList.Add(new MyFlagClass.ToaDoTrongHoaClass()
              {
                posX = posX,
                posY = posY
              });
              posX += num6;
              ++num7;
            }
            this.MyFlag.TrongHoaListMax = this.MyFlag.ToaDoTrongHoaList.Count;
          }
          else
          {
            int X = 0;
            int Y2 = 0;
            int index3 = -1;
            for (int index4 = 0; index4 < this.MyFlag.ToaDoTrongHoaList.Count; ++index4)
            {
              bool flag3 = false;
              int posX = this.MyFlag.ToaDoTrongHoaList[index4].posX;
              int posY = this.MyFlag.ToaDoTrongHoaList[index4].posY;
              try
              {
                for (int index5 = this.MyQuai.AllQuai.Count - 1; index5 >= 0; --index5)
                {
                  QuaiIndividual quaiIndividual = this.MyQuai.AllQuai[index5];
                  if ((quaiIndividual.Name.Contains("a Ấu Miêu") || quaiIndividual.Name.Contains("oa Trưởng Th")) && GA.CalculateDistance((double) quaiIndividual.PosX, (double) quaiIndividual.PosY, (double) posX, (double) posY) <= 1.0)
                  {
                    flag3 = true;
                    break;
                  }
                }
              }
              catch (Exception ex)
              {
              }
              if (!flag3 && this.MyFlag.ToaDoTrongHoaList[index4].noPutStamp < this.nowStamp())
              {
                X = posX;
                Y2 = posY;
                index3 = index4;
                break;
              }
            }
            if (X > 0)
            {
              if (Y2 > 0)
              {
                for (int index6 = 0; index6 <= 20; ++index6)
                {
                  float num8 = Math.Abs(this.Myself.PosX - (float) X);
                  float num9 = Math.Abs(this.Myself.PosY - (float) Y2);
                  if ((double) num8 <= 1.0 && (double) num9 <= 1.0)
                  {
                    this.CallUseItem(itemIndex, this.Myself.ID);
                    Thread.Sleep(700);
                    if (this.Myself.PacketMsg == "HCTH")
                    {
                      if (index3 < this.MyFlag.ToaDoTrongHoaList.Count)
                        this.MyFlag.ToaDoTrongHoaList[index3].noPutStamp = this.nowStamp() + 600000L;
                      this.ResetPacketMsg();
                      if (this.Myself.isThuHoach)
                        this.NhiemVuThuHoachHoa(10);
                      if (this.Myself.isBonHoa)
                        this.NhiemVuBonHoa();
                    }
                    if (this.Myself.EventString == "SCHP")
                    {
                      this.ResetEventString();
                      Thread.Sleep(500);
                      if (this.Myself.isThuHoach)
                        this.NhiemVuThuHoachHoa(10);
                      if (!this.Myself.isBonHoa)
                        break;
                      this.NhiemVuBonHoa();
                      break;
                    }
                    if (this.Myself.ActionStatus != (byte) 5)
                      break;
                    while (this.IsAIEnabled)
                    {
                      Thread.Sleep(200);
                      if (this.Myself.ActionStatus != (byte) 5)
                      {
                        if (this.Myself.isBonHoa)
                        {
                          Thread.Sleep(500);
                          this.NhiemVuBonHoa();
                        }
                        if (!this.Myself.isThuHoach)
                          break;
                        this.NhiemVuThuHoachHoa(10);
                        break;
                      }
                    }
                    break;
                  }
                  this.CallMoveTo(X, Y2);
                  Thread.Sleep(500);
                }
                return;
              }
            }
            try
            {
              for (int index7 = 0; index7 < this.MyFlag.ToaDoTrongHoaList.Count; ++index7)
                this.MyFlag.ToaDoTrongHoaList[index7].noPutStamp = 0L;
            }
            catch (Exception ex)
            {
            }
            if (this.Myself.isThuHoach)
              this.NhiemVuThuHoachHoa(10);
            if (!this.Myself.isBonHoa)
              return;
            this.NhiemVuBonHoa();
          }
        }
        else
        {
          GA.WriteUserLog("Đã hết hoa để trồng.", this);
          this.Myself.isTrongHoa = false;
        }
      }
    }
  }

  public void NhiemVuBonHoa()
  {
    bool flag1 = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    if (!flag1 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 300L)
      return;
    this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    int mapID = 2;
    int num = 30505261;
    if (this.Myself.MapID != mapID)
    {
      this.CallOutMapMove(252, 122, mapID);
    }
    else
    {
      if (this.MyFlag.NoTrongHoaBonHoaStamp < this.nowStamp())
      {
        int itemIndex = -1;
        for (int index = 0; index < 30; ++index)
        {
          if (this.MyInventory.AllItems[index].ItemID == num)
          {
            itemIndex = index;
            break;
          }
        }
        if (itemIndex >= 0)
        {
          if (this.MyQuai.AllQuai.Count > 0 && this.Myself.NhiemVuQuaiID <= 0)
          {
            int numBhdBanKinh = this.Settings.numBHDBanKinh;
            QuaiIndividual quaiIndividual1 = (QuaiIndividual) null;
            List<QuaiIndividual> quaiIndividualList = new List<QuaiIndividual>();
            try
            {
              for (int index1 = this.MyQuai.AllQuai.Count - 1; index1 >= 0; --index1)
              {
                QuaiIndividual quaiIndividual2 = this.MyQuai.AllQuai[index1];
                if (quaiIndividual2.Name.Contains("a Ấu Miêu"))
                {
                  bool flag2 = false;
                  if (this.Myself.HoaDaBonArrayGlobal.Count > 0)
                  {
                    for (int index2 = 0; index2 < this.Myself.HoaDaBonArrayGlobal.Count; ++index2)
                    {
                      if (quaiIndividual2.ID == this.Myself.HoaDaBonArrayGlobal[index2])
                      {
                        flag2 = true;
                        break;
                      }
                    }
                  }
                  if (!flag2 && this.isThisMyFriendbyName(quaiIndividual2.DanhHieu))
                    quaiIndividualList.Add(quaiIndividual2);
                }
              }
              int index = new Random().Next(0, quaiIndividualList.Count);
              if (quaiIndividualList.Count > 0)
              {
                quaiIndividual1 = quaiIndividualList[index];
                this.Myself.NhiemVuQuaiID = quaiIndividualList[index].ID;
              }
              if (quaiIndividual1 != null)
              {
                while (this.IsAIEnabled)
                {
                  if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) (int) quaiIndividual1.PosX, (double) (int) quaiIndividual1.PosY) >= 11.0)
                  {
                    this.CallMoveTo((int) quaiIndividual1.PosX, (int) quaiIndividual1.PosY);
                    Thread.Sleep(300);
                  }
                  else
                    break;
                }
              }
            }
            catch (Exception ex)
            {
              GA.WriteUserLog("Lỗi tìm cây hoa", this);
            }
          }
          if (this.Myself.NhiemVuQuaiID > 0)
          {
            this.CallSelectTarget(this.Myself.NhiemVuQuaiID);
            Thread.Sleep(300);
            this.CallUseItem(itemIndex, this.Myself.NhiemVuQuaiID);
            Thread.Sleep(700);
            if (this.Myself.PacketMsg == "HDBR")
            {
              this.ResetPacketMsg();
              this.Myself.HoaDaBonArrayGlobal.Add(this.Myself.NhiemVuQuaiID);
            }
            if (this.Myself.ActionStatus == (byte) 5)
            {
              this.Myself.HoaDaBonArrayGlobal.Add(this.Myself.NhiemVuQuaiID);
              while (this.IsAIEnabled && this.Myself.ActionStatus == (byte) 5)
                Thread.Sleep(500);
            }
            this.Myself.NhiemVuQuaiID = 0;
          }
        }
        else
        {
          GA.WriteUserLog("Đã hết Hoa Phì để bón.", this);
          this.Myself.isBonHoa = false;
        }
      }
      if (!this.Myself.isThuHoach)
        return;
      this.NhiemVuThuHoachHoa();
    }
  }

  public void NhiemVuThuHoachHoa(int maxLoop = 1)
  {
    bool flag1 = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    if (!flag1)
      return;
label_116:
    for (int index1 = 0; index1 < maxLoop && this.Myself.isThuHoach && this.IsAIEnabled; ++index1)
    {
      int mapID = 2;
      if (this.Myself.MapID != mapID)
      {
        this.CallOutMapMove(252, 122, mapID);
      }
      else
      {
        bool flag2 = true;
        if (this.MyQuai.TargetID >= 0)
        {
          QuaiIndividual quaiIndividual1 = (QuaiIndividual) null;
          try
          {
            for (int index2 = this.MyQuai.AllQuai.Count - 1; index2 >= 0; --index2)
            {
              QuaiIndividual quaiIndividual2 = this.MyQuai.AllQuai[index2];
              if (quaiIndividual2.Name.Contains("oa Trưởng Thàn") && quaiIndividual2.ID == this.MyQuai.TargetID)
              {
                bool flag3 = this.isThisMyFriendbyName(quaiIndividual2.DanhHieu);
                if (GA.IsCTVMember())
                  flag3 = true;
                if (flag3)
                {
                  quaiIndividual1 = quaiIndividual2;
                  flag2 = false;
                }
              }
            }
            if (quaiIndividual1 != null)
            {
              if (quaiIndividual1.ID >= 0)
              {
                if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quaiIndividual1.PosX, (double) quaiIndividual1.PosY) < 2.5)
                  this.CallAttackTargetFast(quaiIndividual1.ID, 3, 0, 0);
                else
                  this.CallMoveTo((int) quaiIndividual1.PosX, (int) quaiIndividual1.PosY);
              }
            }
          }
          catch (Exception ex)
          {
            GA.WriteUserLog("Lỗi thu hoạch liên tục", this);
          }
        }
        if (flag2)
        {
          double num1 = (double) this.Settings.numBHDBanKinh;
          QuaiIndividual quaiIndividual3 = (QuaiIndividual) null;
          try
          {
            for (int index3 = this.MyQuai.AllQuai.Count - 1; index3 >= 0; --index3)
            {
              QuaiIndividual quaiIndividual4 = this.MyQuai.AllQuai[index3];
              if (quaiIndividual4.Name.Contains("oa Trưởng Thàn"))
              {
                bool flag4 = false;
                if (this.Myself.HoaDaBonArrayGlobal.Count > 0)
                {
                  for (int index4 = 0; index4 < this.Myself.HoaDaBonArrayGlobal.Count; ++index4)
                  {
                    if (quaiIndividual4.ID == this.Myself.HoaDaBonArrayGlobal[index4])
                    {
                      flag4 = true;
                      break;
                    }
                  }
                }
                if (!flag4)
                {
                  bool flag5 = this.isThisMyFriendbyName(quaiIndividual4.DanhHieu);
                  if (GA.IsCTVMember())
                    flag5 = true;
                  if (this.Settings.cboxThuHoachHoaChinhMinh && this.Myself.Name != quaiIndividual4.DanhHieu)
                    flag5 = false;
                  if (flag5)
                  {
                    bool flag6 = false;
                    for (int index5 = 0; index5 < this.Myself.HoaThuHoachData.Count; ++index5)
                    {
                      if (this.Myself.HoaThuHoachData[index5].id == quaiIndividual4.ID && this.Myself.HoaThuHoachData[index5].thuhoachStamp > this.nowStamp())
                        flag6 = true;
                    }
                    if (!flag6)
                    {
                      double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quaiIndividual4.PosX, (double) quaiIndividual4.PosY);
                      if (distance < num1)
                      {
                        num1 = distance;
                        this.Myself.NhiemVuInt_1 = quaiIndividual4.ID;
                        quaiIndividual3 = quaiIndividual4;
                      }
                    }
                  }
                }
              }
            }
            if (quaiIndividual3 != null)
            {
              while (this.IsAIEnabled)
              {
                if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quaiIndividual3.PosX, (double) quaiIndividual3.PosY) >= 2.5)
                {
                  this.CallMoveTo((int) quaiIndividual3.PosX, (int) quaiIndividual3.PosY);
                  Thread.Sleep(150);
                }
                else
                  break;
              }
            }
          }
          catch (Exception ex)
          {
            GA.WriteUserLog("Lỗi tìm cây hoa", this);
          }
          if (this.Myself.NhiemVuInt_1 > 0)
          {
            this.ResetPacketMsg();
            this.CallAttackTargetFast(this.Myself.NhiemVuInt_1, 3, 0, 0);
            long num2 = this.nowStamp() + 1000L;
            while (num2 > this.nowStamp())
            {
              Thread.Sleep(150);
              if (this.Myself.PacketMsg.Contains("Time:"))
                break;
            }
            if (this.Myself.PacketMsg.Contains("Time:"))
            {
              int result = 0;
              int.TryParse(this.Myself.PacketMsg.Replace("Time:", ""), out result);
              if (result > 0)
              {
                bool flag7 = false;
                for (int index6 = 0; index6 < this.Myself.HoaThuHoachData.Count; ++index6)
                {
                  if (this.Myself.HoaThuHoachData[index6].id == this.Myself.NhiemVuInt_1)
                  {
                    this.Myself.HoaThuHoachData[index6].thuhoachStamp = this.nowStamp() + (long) (result * 1000);
                    flag7 = true;
                    break;
                  }
                }
                if (!flag7)
                  this.Myself.HoaThuHoachData.Add(new MainPlayerClass.HoaThuHoachClass()
                  {
                    id = this.Myself.NhiemVuInt_1,
                    thuhoachStamp = this.nowStamp() + (long) (result * 1000)
                  });
                this.ResetPacketMsg();
              }
            }
            while (this.Myself.ActionStatus == (byte) 5)
              Thread.Sleep(200);
            this.Myself.NhiemVuInt_1 = 0;
          }
        }
label_114:
        while (this.Myself.HoaThuHoachData.Count > 0)
        {
          int index7 = -1;
          int num3 = -1;
          int num4 = -1;
          long num5 = 0;
          long num6 = 5000;
          for (int index8 = 0; index8 < this.Myself.HoaThuHoachData.Count; ++index8)
          {
            num5 = this.Myself.HoaThuHoachData[index8].thuhoachStamp - this.nowStamp();
            if (num5 <= 0L)
            {
              index7 = index8;
              num3 = this.Myself.HoaThuHoachData[index8].id;
              break;
            }
            if (num5 < num6)
            {
              num4 = index8;
              num3 = this.Myself.HoaThuHoachData[index8].id;
              num6 = num5;
            }
          }
          bool flag8 = false;
          if (index7 == -1 && num4 >= 0)
          {
            index7 = num4;
            flag8 = true;
          }
          if (index7 >= 0)
          {
            QuaiIndividual quaiIndividual5 = (QuaiIndividual) null;
            try
            {
              for (int index9 = this.MyQuai.AllQuai.Count - 1; index9 >= 0; --index9)
              {
                QuaiIndividual quaiIndividual6 = this.MyQuai.AllQuai[index9];
                if (quaiIndividual6.Name.Contains("oa Trưởng Thàn") && quaiIndividual6.ID == num3)
                {
                  quaiIndividual5 = quaiIndividual6;
                  break;
                }
              }
              if (quaiIndividual5 != null)
              {
                int num7 = 0;
                while (this.IsAIEnabled)
                {
                  if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quaiIndividual5.PosX, (double) quaiIndividual5.PosY) < 2.5)
                  {
                    this.CallAttackTargetFast(quaiIndividual5.ID, 3, 0, 0);
                    this.CallSelectTarget(quaiIndividual5.ID);
                    break;
                  }
                  if (this.Myself.ActionStatus != (byte) 2 || num7 == 0)
                  {
                    this.CallMoveTo((int) quaiIndividual5.PosX, (int) quaiIndividual5.PosY);
                    ++num7;
                  }
                  Thread.Sleep(100);
                }
                if (!flag8)
                {
                  this.CallAttackTargetFast(quaiIndividual5.ID, 3, 0, 0);
                  bool flag9 = false;
                  long num8 = this.nowStamp() + 1000L;
                  do
                  {
                    do
                      ;
                    while (num8 <= this.nowStamp());
                    this.CallAttackTargetFast(quaiIndividual5.ID, 3, 0, 0);
                    Thread.Sleep(50);
                  }
                  while (this.Myself.ActionStatus != (byte) 5);
                  while (this.Myself.ActionStatus == (byte) 5)
                  {
                    Thread.Sleep(100);
                    flag9 = true;
                  }
                  if (flag9)
                    this.Myself.HoaThuHoachData.RemoveAt(index7);
                  else
                    break;
                }
                else
                {
                  this.MyFlag.NoTrongHoaBonHoaStamp = this.nowStamp() + num5 + 500L;
                  if (num6 < 2000L)
                  {
label_104:
                    bool flag10 = false;
                    long num9 = this.nowStamp() + 1000L + num6;
                    while (num9 > this.nowStamp())
                    {
                      this.CallAttackTargetFast(quaiIndividual5.ID, 3, 0, 0);
                      Thread.Sleep(20);
                      if (this.Myself.ActionStatus == (byte) 5)
                      {
                        while (this.Myself.ActionStatus == (byte) 5)
                        {
                          Thread.Sleep(100);
                          flag10 = true;
                        }
                        if (flag10)
                        {
                          this.Myself.HoaThuHoachData.RemoveAt(index7);
                          goto label_114;
                        }
                        goto label_116;
                      }
                    }
                    goto label_104;
                  }
                  break;
                }
              }
              else
              {
                this.Myself.HoaThuHoachData.RemoveAt(index7);
                break;
              }
            }
            catch (Exception ex)
            {
              GA.WriteUserLog("Lỗi thu hoạch hoa", this);
              break;
            }
          }
          else
            break;
        }
      }
    }
  }

  public void NhiemVuNhatTuyet()
  {
    bool flag1 = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    if (this.Myself.isBanDoChoNPC)
    {
      this.BanDoChoNPC();
    }
    else
    {
      if (!flag1 || this.Myself.SavedStatus == AllEnums.CharStatuses.VETHANH)
        return;
      bool flag2 = true;
      if (this.Settings.cboxNhatTuyetDungIm && (double) this.MyFlag.posX_Saved > 0.0)
      {
        if (this.GoToMyPos((int) this.MyFlag.posX_Saved, (int) this.MyFlag.posY_Saved, this.MyFlag.MapID_Saved))
        {
          this.MyFlag.posX_Saved = 0.0f;
          this.MyFlag.posY_Saved = 0.0f;
          this.MyFlag.MapID_Saved = 0;
        }
        else
          flag2 = false;
      }
      if (flag2)
        this.DiTimBauVat(809, 0);
      if (!this.Myself.FlagFullBoc || !this.Settings.cboxTuMuaBan)
        return;
      this.Myself.isBanDoChoNPC = true;
      if (!this.Settings.cboxNhatTuyetDungIm)
        return;
      this.MyFlag.posX_Saved = this.Myself.PosX;
      this.MyFlag.posY_Saved = this.Myself.PosY;
      this.MyFlag.MapID_Saved = this.Myself.MapID;
    }
  }

  public void NhiemVuYTO()
  {
    if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 100L)
      return;
    if (this.Myself.Menpai == AllEnums.Menpais.NGAMI && !this.Settings.cboxDanhQuai)
      GA.ShowBalloon(frmMain.langYTONgaMi, this.Myself.Name, this);
    this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    if (!GA.IsInPhuBan(this.Myself.MapID, this))
    {
      int num1 = 70;
      int num2 = 119;
      int num3 = 4;
      int NPCID = 0;
      int menuTypeID = 401040;
      int menuIndex = -1;
      this.Myself.indexPPcalc = false;
      this.ResetEventString();
      this.ResetPacketMsg();
      this.Myself.actionFlag = 0;
      this.MyFlag.dosomethingCounter = 0;
      this.MyFlag.dosomethingFlag = 0;
      this.Myself.QuestStep = 0;
      this.MyFlag.phubanFlag = 0;
      if (this.Myself.InMapPathPoints.Count > 0)
      {
        this.Myself.InMapPathPoints.Clear();
        this.Myself.InPathPointIndex = 0;
      }
      ++this.Myself.trieutapCounter;
      if (this.Myself.trieutapCounter == 1)
        GA.TrieuTapToMyPos(this, num1, num2, num3);
      else if (this.Myself.trieutapCounter >= 3)
        this.Myself.trieutapCounter = 0;
      if (this.GoToMyPos(num1, num2, num3) && this.WaitPartyFull(2, this.Settings.numPTLevel))
      {
        if (this.IsPartyKeyInt() == 2 && !this.Settings.cboxTuHuyNV)
        {
          if (this.MyFlag.nhanQstamp == 0L)
            this.MyFlag.nhanQstamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
          if (this.MyFlag.nhanQstamp > 0L && frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.nhanQstamp >= 240000L)
          {
            this.MyFlag.nhanQstamp = 0L;
            if (frmLogin.GAuto.Settings.cboxQ12AutoExtend)
            {
              GA.WriteUserLog(frmMain.langQ2Over4min, this);
              frmLogin.GAuto.Settings.cboxQ12AutoExtend = false;
              return;
            }
          }
        }
        this.MyFlag.NamePartyArray.Clear();
        this.CallMoveTo(num1, num2);
        GA.TrieuTapCaNhom(this, true);
        if (this.CheckMemberGPS(7, num1, num2, num3) || this.IsPartyKeyInt() == 1 || this.MyFlag.xongQstamp > 0L && frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.xongQstamp <= 150000L)
        {
          if (this.Myself.talkCounter <= 2)
          {
            int millisecondsTimeout = 500;
            this.CallRemovePartyFollow();
            this.CallRemovePartyFollowSafe();
            if (this.Myself.IsPartyFollowed == (byte) 0)
            {
              this.CallTalkNPC(0, 0, NPCID);
              Thread.Sleep(millisecondsTimeout);
              this.CallTalkNPC(menuTypeID, menuIndex, NPCID);
              Thread.Sleep(millisecondsTimeout);
            }
          }
          else
            ++this.Myself.talkCounter;
          if (this.Myself.talkCounter >= 1)
            this.Myself.talkCounter = 0;
        }
        else
          GA.ShowBalloon(frmMain.langQ1KetMap, frmMain.langPhuBanTitleWarning, this, 10000);
      }
    }
    if (!GA.IsInPhuBan(this.Myself.MapID, this))
      return;
    this.IsPartyKeyInt();
    int mapID = 1140;
    this.Loadphubanpp(mapID);
    this.CalcNearPoint();
    if (this.Myself.InPathPointIndex < 15 && this.Myself.actionFlag <= 1)
    {
      if (this.Settings.cboxDanhQuai)
        GA.PartyDoSomething(this, mode: 6);
      this.AddNPCNameToArray("ytonpc", 2);
      ++this.Myself.actionFlag;
    }
    bool flag1 = false;
    bool flag2 = false;
    if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived)
    {
      flag1 = true;
      if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared)
        flag2 = true;
    }
    if (GA.CheckGameVersion(this.Target.VersionNum) == 356)
    {
      if (this.Myself.InPathPointIndex < 15)
        this.Myself.InPathPointIndex = 15;
      else if (16 /*0x10*/ <= this.Myself.InPathPointIndex && this.Myself.InPathPointIndex <= 26)
        this.Myself.InPathPointIndex = 27;
    }
    if (this.Myself.InPathPointIndex == 15)
    {
      if (flag2)
      {
        this.MyFlag.phubanFlag = 1;
        if (this.Myself.actionFlag <= 5)
        {
          int millisecondsTimeout = 1000;
          int num4 = 79;
          int num5 = 202;
          int menuTypeID = 402241;
          int menuIndex = 1;
          double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num4, (double) num5);
          if (distance > 2.5)
            this.CallMoveFlashPos(num4, num5);
          if (distance <= 2.5)
          {
            QuaiIndividual quaiIndividual1 = this.SearchNPCByName(frmMain.langHoDienBao);
            if (quaiIndividual1 != null)
            {
              int id = quaiIndividual1.ID;
              Thread.Sleep(millisecondsTimeout);
              this.CallTalkNPC(0, 0, id);
              Thread.Sleep(millisecondsTimeout);
              this.CallTalkNPC(menuTypeID, menuIndex, id);
              Thread.Sleep(millisecondsTimeout);
            }
            if (quaiIndividual1 == null)
            {
              quaiIndividual1 = this.SearchNPCByName("n báo");
              if (quaiIndividual1 != null)
              {
                int id = quaiIndividual1.ID;
                Thread.Sleep(millisecondsTimeout);
                this.CallTalkNPC(0, 0, id);
                Thread.Sleep(millisecondsTimeout);
                this.CallTalkNPC(menuTypeID, menuIndex, id);
                Thread.Sleep(millisecondsTimeout);
              }
            }
            if (quaiIndividual1 == null)
            {
              quaiIndividual1 = this.SearchNPCByName("n b");
              if (quaiIndividual1 != null)
              {
                int id = quaiIndividual1.ID;
                Thread.Sleep(millisecondsTimeout);
                this.CallTalkNPC(0, 0, id);
                Thread.Sleep(millisecondsTimeout);
                this.CallTalkNPC(menuTypeID, menuIndex, id);
                Thread.Sleep(millisecondsTimeout);
              }
            }
            if (quaiIndividual1 == null)
            {
              this.CallMoveTo(num4, num5);
              GA.WriteUserLog("Không tìm thấy Hô Diên Báo, vui lòng báo cho Admin biết", this);
              string str = "";
              try
              {
                for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
                {
                  QuaiIndividual quaiIndividual2 = this.MyQuai.AllQuai[index];
                  if (quaiIndividual2.Name != str)
                  {
                    str = quaiIndividual2.Name;
                    GA.WriteUserLog("Quái {0}: {1}", this, (object) index, (object) str);
                  }
                }
              }
              catch (Exception ex)
              {
                GA.WriteUserLog("Lỗi khi tìm NPC theo tên trong YTO. Nếu xảy ra lỗi auto vì điều này vui lòng báo cho Admin biết", this);
              }
            }
          }
        }
        if (this.Myself.actionFlag <= 5 && this.SearchNPCByName("npcyto") != null)
          ++this.Myself.actionFlag;
        if (this.Myself.actionFlag > 0)
        {
          if (this.Myself.IsPartyFollowed == (byte) 1)
            this.CallRemovePartyFollow();
          this.AttackQuai();
        }
        if (this.Myself.PacketMsg == "TDDDK" || this.Myself.PacketMsg == "XQTTR")
        {
          GA.PartyDoSomething(this, true, 2);
          if (this.Myself.PacketMsg == "TDDDK")
            Thread.Sleep(7000);
          GA.PartyDoSomething(this, true, 12, 4);
          this.MyQuai.FirstAttackArray.Clear();
          this.MyFlag.phubanFlag = 0;
          this.Myself.actionFlag = 0;
          this.ResetPacketMsg();
        }
      }
      else
        this.Myself.actionFlag = 0;
    }
    if (this.Myself.InPathPointIndex == 27)
    {
      if (flag2)
      {
        this.MyFlag.phubanFlag = 1;
        int millisecondsTimeout = 500;
        int posX = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosX;
        int posY = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosY;
        int menuTypeID = 402241;
        if (this.Target.VersionNum != 3)
          menuTypeID = 402246;
        int menuIndex = 1;
        double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) posX, (double) posY);
        if (distance > 2.5)
          this.CallMoveFlashPos(posX, posY);
        if (distance <= 2.5 && this.Myself.actionFlag == 0)
        {
          GA.TrieuTapCaNhom(this, true);
          QuaiIndividual quaiIndividual = this.SearchNPCByName(frmMain.langTienHoanhVu);
          if (quaiIndividual != null)
          {
            int id = quaiIndividual.ID;
            Thread.Sleep(millisecondsTimeout);
            this.CallTalkNPC(0, 0, id);
            Thread.Sleep(millisecondsTimeout);
            this.CallTalkNPC(menuTypeID, menuIndex, id);
            Thread.Sleep(millisecondsTimeout);
          }
          else
            this.CallMoveTo((int) this.Myself.PosX, (int) this.Myself.PosY);
        }
        if (this.Myself.PacketMsg == "DCTXR")
        {
          this.MyQuai.FirstAttackArray.Clear();
          this.MyFlag.phubanFlag = 0;
          this.Myself.actionFlag = 0;
          this.Myself.InPathPointIndex += 3;
          this.ResetPacketMsg();
        }
        if (this.Myself.PacketMsg == "NCTHVR")
        {
          this.MyQuai.FirstAttackArray.Clear();
          this.MyFlag.phubanFlag = 0;
          this.Myself.actionFlag = 0;
          this.ResetPacketMsg();
        }
      }
      else
        this.Myself.actionFlag = 0;
    }
    if (this.Myself.InPathPointIndex == 28 && flag2)
    {
      this.MyFlag.phubanFlag = 1;
      if (this.Myself.actionFlag == 0 && this.Myself.HorseType == -1)
      {
        GA.PartyDoSomething(this, true, 2);
        ++this.Myself.actionFlag;
      }
      int posX = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosX;
      int posY = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosY;
      double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) posX, (double) posY);
      if (distance > 10.0)
        this.CallMoveFlashPos(posX, posY);
      if (distance <= 10.0)
      {
        if (this.Myself.IsPartyFollowed == (byte) 1)
        {
          this.CallRemovePartyFollow();
          Thread.Sleep(1000);
          GA.TrieuTapCaNhom(this, true);
        }
        this.AttackQuai();
      }
      if (this.Myself.PacketMsg == "TDCMT")
      {
        Thread.Sleep(3000);
        this.MyFlag.phubanFlag = 0;
        ++this.Myself.InPathPointIndex;
        this.ResetPacketMsg();
      }
    }
    if (this.Myself.InPathPointIndex == 31 /*0x1F*/ && flag2)
    {
      this.MyFlag.phubanFlag = 1;
      int millisecondsTimeout = 500;
      int posX = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosX;
      int posY = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosY;
      int num = 402249;
      int menuIndex = 1;
      double distance1 = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, 154.0, 96.0);
      if (distance1 < 5.0)
      {
        this.CallLenNgua();
        this.CallRequestPartyFollow();
        if (this.CheckMemberDistance(5.0))
          this.MyFlag.phubanFlag = 0;
      }
      if (this.MyFlag.phubanFlag == 1)
      {
        double distance2 = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) posX, (double) posY);
        if (distance2 > 2.5 && distance1 > 5.0)
          this.CallMoveFlashPos(posX, posY);
        if (distance2 <= 2.5 || distance1 <= 5.0)
        {
          if (distance1 > 5.0 && this.Myself.IsPartyFollowed == (byte) 1)
            this.CallRemovePartyFollowSafe();
          if (this.Myself.IsPartyFollowed == (byte) 0)
          {
            GA.TrieuTapToMyPos(this, posX, posY, this.Myself.MapID);
            Thread.Sleep(2000);
            QuaiIndividual quaiIndividual = this.SearchNPCByName(frmMain.langHoaHachCan);
            if (quaiIndividual != null)
              this.Myself.NhiemVuQuaiID = quaiIndividual.ID;
            else
              this.CallMoveTo((int) this.Myself.PosX, (int) this.Myself.PosY);
            if (this.Myself.NhiemVuQuaiID >= 0)
            {
              int nhiemVuQuaiId = this.Myself.NhiemVuQuaiID;
              this.CallTalkNPC(0, 0, nhiemVuQuaiId);
              Thread.Sleep(millisecondsTimeout);
              this.CallTalkNPC(num, menuIndex, nhiemVuQuaiId);
              Thread.Sleep(millisecondsTimeout);
              GA.PartyTalkNPC(this, nhiemVuQuaiId, num, menuIndex);
            }
          }
        }
      }
    }
    if (this.Myself.InPathPointIndex == 33 && flag2)
    {
      this.MyFlag.phubanFlag = 1;
      bool flag3 = false;
      if (this.MyFlag.MDPPlayDCTD == 0L || frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.MDPPlayDCTD >= 300000L)
      {
        if ((double) this.MyQuai.TargetHPPercent <= 96.0 && (double) this.MyQuai.TargetHPPercent > 0.0 && this.MyQuai.CanAttackInt == 28)
        {
          if (this.CanAttack())
            flag3 = true;
        }
        else
        {
          GA.PartyDoSomething(this, true, 18);
          GA.PartyDoSomething(this, true, 19);
        }
      }
      if (this.MyFlag.MDPPlayDCTD > 0L || flag3)
      {
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.MDPPlayDCTD <= 2000L)
          GA.PartyDoSomething(this, true, 16 /*0x10*/);
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.MDPPlayDCTD >= 3000L && frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.MDPPlayDCTD <= 4000L)
          GA.PartyDoSomething(this, true, 17);
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.MDPPlayDCTD >= 8000L && frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.MDPPlayDCTD <= 17000L && this.Myself.CurrentTarget != null && (double) this.Myself.CurrentTarget.HPPercent <= 15.0 && (double) this.Myself.CurrentTarget.HPPercent > 0.0 && this.CanAttack())
        {
          this.MyFlag.nodelayAction = frmLogin.GlobalTimer.ElapsedMilliseconds;
          if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.dosomethingStamp >= 2000L)
            this.MyFlag.dosomethingStamp = 0L;
          if (this.MyFlag.dosomethingStamp == 0L)
          {
            GA.PartyDoSomething(this, true, 3);
            ++this.MyFlag.dosomethingCounter;
          }
        }
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.MDPPlayDCTD <= 30000L && frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.MDPPlayDCTD >= 17000L && (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.useItemTriggerStamp >= 180000L || this.MyFlag.useItemTriggerStamp == 0L) || flag3)
        {
          if (this.Myself.ActionStatus == (byte) 7)
          {
            if (this.MySkills.KhinhCongID > 0)
            {
              this.CallAttackTarget(-1, this.MySkills.KhinhCongID, 0, 0);
            }
            else
            {
              this.CallAttackTarget(-1, 34, 0, 0);
              this.CallAttackTarget(-1, this.GetKhinhCongID(), 0, 0);
            }
          }
          GA.PartyDoSomething(this, mode: 11, param1: 1);
          GA.PartyDoSomething(this, true, 16 /*0x10*/);
          if (this.Target.VersionNum != 3)
            return;
          GA.PartyDoSomething(this, true, 22, 1);
          return;
        }
      }
      int posX = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosX;
      int posY = this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].PosY;
      double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) posX, (double) posY);
      if (distance > 6.0)
        this.CallMoveFlashPos(posX, posY);
      if (distance <= 6.0)
      {
        if (this.Myself.IsPartyFollowed == (byte) 1)
        {
          this.CallRemovePartyFollowSafe();
          GA.TrieuTapCaNhom(this, true);
          GA.PartyDoSomething(this, true, 18);
          GA.PartyDoSomething(this, true, 7);
        }
        this.AttackQuai();
        if (this.MyQuai.AllQuai.Count == 0)
          this.CallMoveTo((int) this.Myself.PosX, (int) this.Myself.PosY);
      }
      if (this.Myself.EventString == "TTBQC")
      {
        GA.PartyDoSomething(this, true, 7, 1);
        this.ResetEventString();
      }
      if (this.Myself.EventString == "TDMDP" || this.Myself.PacketMsg == "TDMDP")
      {
        if (this.Myself.actionFlag <= 1)
        {
          GA.PartyDoSomething(this, true, 12, 1);
          GA.PartyDoSomething(this, true, 13, 1);
          this.MyFlag.dosomethingHoisinhFlag = 0;
          GA.PartyDoSomething(this, true, 22);
          if (this.MyFlag.dosomethingHoisinhFlag == 0)
          {
            Thread.Sleep(1000);
            GA.PartyDoSomething(this, true, 22);
          }
          if (this.MyFlag.dosomethingHoisinhFlag == 0)
          {
            Thread.Sleep(1000);
            GA.PartyDoSomething(this, true, 22);
          }
          if (this.MyFlag.dosomethingHoisinhFlag == 0)
          {
            Thread.Sleep(1000);
            GA.PartyDoSomething(this, true, 22, 2);
          }
          GA.PartyDoSomething(this, true, 2);
          GA.PartyDoSomething(this, true, 17);
          this.Myself.actionFlag += 2;
          ++this.MyFlag.YTOCounter;
          GA.WriteUserLog(frmMain.langCompletedYTO, this, (object) this.MyFlag.YTOCounter);
        }
        this.MyFlag.phubanFlag = 0;
        this.MyFlag.MDPPlayDCTD = 0L;
        ++this.Myself.InPathPointIndex;
        flag2 = false;
        this.CallPartyFollowMe(6000);
        this.MyFlag.YTOxongStamp = frmLogin.GlobalTimer.ElapsedMilliseconds + 30000L;
      }
    }
    if (this.Myself.InPathPointIndex == 34)
    {
      if (flag2)
        this.MyFlag.phubanFlag = 1;
      if (this.MyFlag.YTOxongStamp < frmLogin.GlobalTimer.ElapsedMilliseconds)
      {
        this.CallRemovePartyFollow();
        if (this.MyFlag.dosomethingFlag == 0)
        {
          Thread.Sleep(5000);
          GA.PartyDoSomething(this, mode: 8);
        }
        if (this.MyFlag.dosomethingFlag == 1)
        {
          GA.PartyDoSomething(this, true, 8);
          this.MyFlag.MDPPlayDCTD = 0L;
          Thread.Sleep(7000);
        }
      }
      else if (flag1)
        GA.PartyDoSomething(this, mode: 8);
    }
    if (this.MyFlag.phubanFlag != 0)
      return;
    this.PhuBanYTO(mapID);
  }

  public void NhiemVuTanThu()
  {
    bool flag1 = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    if (!flag1 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LuyenKimBocStamp < 100L)
      return;
    this.Myself.LuyenKimBocStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    if (this.HasActivePet() && (this.MyPet.AllPets[this.MyPet.ActivePetIndex].PetName.ToLower().Contains("hoa tiên") || this.MyPet.AllPets[this.MyPet.ActivePetIndex].PetName.ToLower().Contains("thất tịch uy")) && this.MyPet.AllPets[this.MyPet.ActivePetIndex].Level > this.MyFlag.tempLevel)
    {
      this.MyFlag.tempLevel = this.MyPet.AllPets[this.MyPet.ActivePetIndex].Level;
      this.CallAddPetPoint(this.MyPet.ActivePetDBID, 160 /*0xA0*/, 16 /*0x10*/);
      this.CallAddPetPoint(this.MyPet.ActivePetDBID, 80 /*0x50*/, 16 /*0x10*/);
      this.CallAddPetPoint(this.MyPet.ActivePetDBID, 40, 16 /*0x10*/);
      this.CallAddPetPoint(this.MyPet.ActivePetDBID, 20, 16 /*0x10*/);
      this.CallAddPetPoint(this.MyPet.ActivePetDBID, 10, 16 /*0x10*/);
      this.CallAddPetPoint(this.MyPet.ActivePetDBID, 5, 16 /*0x10*/);
      this.CallAddPetPoint(this.MyPet.ActivePetDBID, 5, 16 /*0x10*/);
    }
    int millisecondsTimeout = 1000;
    this.Settings.cboxTuNhatVatPham = false;
    int questStep1 = this.Myself.QuestStep;
    if (this.Myself.QuestStep == 20)
    {
      List<int> intList1 = new List<int>()
      {
        160 /*0xA0*/,
        287,
        267,
        366,
        356,
        366
      };
      List<int> intList2 = new List<int>()
      {
        158,
        138,
        242,
        228,
        208 /*0xD0*/,
        228
      };
      List<int> intList3 = new List<int>()
      {
        2,
        2,
        1,
        0,
        0,
        0
      };
      List<int> intList4 = new List<int>()
      {
        139,
        156,
        143,
        142,
        202,
        142
      };
      List<int> intList5 = new List<int>()
      {
        1018702,
        1018702,
        1018703,
        1018704,
        1018705,
        402060
      };
      List<int> intList6 = new List<int>()
      {
        -1,
        -1,
        -1,
        -1,
        -1,
        -1
      };
      List<int> intList7 = new List<int>()
      {
        0,
        1,
        1,
        1,
        0,
        0
      };
      List<int> intList8 = new List<int>()
      {
        0,
        1,
        1,
        1,
        1,
        0
      };
      List<int> intList9 = new List<int>()
      {
        1,
        1,
        1,
        1,
        1,
        0
      };
      int counter = this.MyFlag.counter;
      if (counter <= 5)
      {
        int posX = intList1[counter];
        int posY = intList2[counter];
        int mapID = intList3[counter];
        int NPCID = intList4[counter];
        int menuTypeID1 = intList5[counter];
        int menuIndex1 = intList6[counter];
        int num1 = intList7[counter];
        int num2 = intList8[counter];
        int num3 = intList9[counter];
        bool flag2 = false;
        if (!GA.IsInPhuBan(this.Myself.MapID, this))
          flag2 = this.GoToMyPos(posX, posY, mapID);
        if (flag2)
        {
          this.CallTalkNPC(0, 0, NPCID);
          long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
          while (this.Myself.isQuestFrameShow == 0)
          {
            Thread.Sleep(200);
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds > 2000L)
              break;
          }
          this.CallTalkNPC(menuTypeID1, menuIndex1, NPCID);
          Thread.Sleep(millisecondsTimeout);
          if (num1 == 1)
          {
            this.CallTraNhiemVu();
            Thread.Sleep(millisecondsTimeout);
          }
          if (num2 == 1)
          {
            this.CallTraNhiemVu();
            Thread.Sleep(millisecondsTimeout);
          }
          if (num3 == 1)
          {
            this.CallNhanNhiemVu();
            Thread.Sleep(millisecondsTimeout);
          }
          if (counter < 5)
            ++this.MyFlag.counter;
          if (counter == 5)
          {
            if (this.MyFlag.tempStamp == 0L)
              this.MyFlag.tempStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.tempStamp > 30000L)
            {
              this.MyFlag.tempStamp = 0L;
              this.MyFlag.counter = 0;
              ++this.Myself.QuestStep;
            }
          }
        }
        if (GA.IsInPhuBan(this.Myself.MapID, this))
        {
          this.MyFlag.tempStamp = 0L;
          Thread.Sleep(1000);
          QuaiIndividual quaiIndividual = this.SearchNPCByPos(40, 40, 5);
          if (quaiIndividual != null)
          {
            int menuTypeID2 = 500601;
            int menuIndex2 = 746;
            this.CallTalkNPC(0, 0, quaiIndividual.ID);
            long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
            while (this.Myself.isQuestFrameShow == 0)
            {
              Thread.Sleep(200);
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds > 2000L)
                break;
            }
            this.CallTalkNPC(menuTypeID2, menuIndex2, quaiIndividual.ID);
            Thread.Sleep(millisecondsTimeout);
            this.CallTraNhiemVu();
            Thread.Sleep(millisecondsTimeout);
            this.CallNhanNhiemVu();
            Thread.Sleep(millisecondsTimeout);
            this.MyFlag.counter = 0;
            ++this.Myself.QuestStep;
          }
        }
      }
    }
    if (this.Myself.QuestStep == 21)
    {
      if (this.Myself.MapID == 0)
      {
        int questStep2 = this.Myself.QuestStep;
        frmMain.ResetPhoBan(this);
        this.Myself.QuestStep = questStep2;
        ++this.Myself.QuestStep;
      }
      else
        this.NhiemVuKyCuoc();
    }
    if (this.Myself.QuestStep == 22)
    {
      List<int> intList10 = new List<int>()
      {
        256 /*0x0100*/,
        256 /*0x0100*/,
        215,
        108
      };
      List<int> intList11 = new List<int>()
      {
        273,
        273,
        325,
        110
      };
      List<int> intList12 = new List<int>() { 0, 0, 0, 3 };
      List<int> intList13 = new List<int>()
      {
        199,
        199,
        201,
        62
      };
      List<int> intList14 = new List<int>()
      {
        250552,
        1018707,
        1018707,
        402061
      };
      List<int> intList15 = new List<int>()
      {
        -1,
        -1,
        -1,
        1
      };
      List<int> intList16 = new List<int>() { 0, 0, 1, 0 };
      List<int> intList17 = new List<int>() { 1, 0, 1, 0 };
      List<int> intList18 = new List<int>() { 0, 1, 1, 0 };
      int counter = this.MyFlag.counter;
      if (counter <= 3)
      {
        int posX = intList10[counter];
        int posY = intList11[counter];
        int mapID = intList12[counter];
        int NPCID = intList13[counter];
        int menuTypeID3 = intList14[counter];
        int menuIndex3 = intList15[counter];
        int num4 = intList16[counter];
        int num5 = intList17[counter];
        int num6 = intList18[counter];
        bool flag3 = false;
        if (!GA.IsInPhuBan(this.Myself.MapID, this))
          flag3 = this.GoToMyPos(posX, posY, mapID);
        if (flag3)
        {
          this.CallTalkNPC(0, 0, NPCID);
          long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
          while (this.Myself.isQuestFrameShow == 0)
          {
            Thread.Sleep(200);
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds > 2000L)
              break;
          }
          this.CallTalkNPC(menuTypeID3, menuIndex3, NPCID);
          Thread.Sleep(millisecondsTimeout);
          if (num4 == 1)
          {
            this.CallTraNhiemVu();
            Thread.Sleep(millisecondsTimeout);
          }
          if (num5 == 1)
          {
            this.CallTraNhiemVu();
            Thread.Sleep(millisecondsTimeout);
          }
          if (num6 == 1)
          {
            this.CallNhanNhiemVu();
            Thread.Sleep(millisecondsTimeout);
          }
          if (counter < 3)
            ++this.MyFlag.counter;
          if (counter == 3)
          {
            if (this.MyFlag.tempStamp == 0L)
              this.MyFlag.tempStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.tempStamp > 30000L)
            {
              this.MyFlag.tempStamp = 0L;
              this.MyFlag.counter = 0;
              ++this.Myself.QuestStep;
            }
          }
        }
        if (GA.IsInPhuBan(this.Myself.MapID, this))
        {
          this.MyFlag.tempStamp = 0L;
          Thread.Sleep(1000);
          int num7 = 73;
          int num8 = 111;
          this.CallMoveTo(num7, num8);
          Thread.Sleep(1000);
          QuaiIndividual quaiIndividual = this.SearchNPCByPos(num7, num8, 5);
          if (quaiIndividual != null)
          {
            int menuTypeID4 = 500604;
            int menuIndex4 = 752;
            this.CallTalkNPC(0, 0, quaiIndividual.ID);
            long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
            while (this.Myself.isQuestFrameShow == 0)
            {
              Thread.Sleep(200);
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds > 2000L)
                break;
            }
            this.CallTalkNPC(menuTypeID4, menuIndex4, quaiIndividual.ID);
            Thread.Sleep(millisecondsTimeout);
            this.CallTraNhiemVu();
            Thread.Sleep(millisecondsTimeout);
            this.CallNhanNhiemVu();
            Thread.Sleep(millisecondsTimeout);
            this.MyFlag.counter = 0;
            ++this.Myself.QuestStep;
          }
        }
      }
    }
    if (this.Myself.QuestStep == 23)
    {
      if (this.Myself.MapID == 3)
      {
        int questStep3 = this.Myself.QuestStep;
        frmMain.ResetPhoBan(this);
        this.Myself.QuestStep = questStep3;
        ++this.Myself.QuestStep;
      }
      else
      {
        this.LoadPathPoint(48 /*0x30*/);
        this.PhuBanDacBiet(this.Myself.MapID);
      }
    }
    if (this.Myself.QuestStep == 24)
    {
      List<int> intList19 = new List<int>()
      {
        256 /*0x0100*/,
        256 /*0x0100*/,
        215,
        96 /*0x60*/
      };
      List<int> intList20 = new List<int>()
      {
        273,
        273,
        325,
        86
      };
      List<int> intList21 = new List<int>() { 0, 0, 0, 15 };
      List<int> intList22 = new List<int>()
      {
        199,
        199,
        201,
        7
      };
      List<int> intList23 = new List<int>()
      {
        250553,
        1018708,
        1018708,
        402062
      };
      List<int> intList24 = new List<int>()
      {
        -1,
        -1,
        -1,
        0
      };
      List<int> intList25 = new List<int>() { 0, 0, 1, 0 };
      List<int> intList26 = new List<int>() { 1, 0, 1, 0 };
      List<int> intList27 = new List<int>() { 0, 1, 1, 0 };
      int counter = this.MyFlag.counter;
      if (counter <= 3)
      {
        int posX = intList19[counter];
        int posY = intList20[counter];
        int mapID = intList21[counter];
        int NPCID = intList22[counter];
        int menuTypeID5 = intList23[counter];
        int menuIndex5 = intList24[counter];
        int num9 = intList25[counter];
        int num10 = intList26[counter];
        int num11 = intList27[counter];
        if (counter == 3)
        {
          if (this.Myself.Menpai == AllEnums.Menpais.MODUNG)
          {
            posX = 69;
            posY = 125;
            mapID = 195;
            NPCID = 9;
          }
          else if (this.Myself.Menpai == AllEnums.Menpais.THIEULAM)
          {
            posX = 96 /*0x60*/;
            posY = 82;
            mapID = 9;
            NPCID = 9;
          }
          else if (this.Myself.Menpai == AllEnums.Menpais.TINHTUC)
          {
            posX = 96 /*0x60*/;
            posY = 92;
            mapID = 16 /*0x10*/;
            NPCID = 9;
          }
          else if (this.Myself.Menpai == AllEnums.Menpais.VODANG)
          {
            posX = 78;
            posY = 95;
            mapID = 12;
            NPCID = 9;
          }
          else if (this.Myself.Menpai == AllEnums.Menpais.THIENSON)
          {
            posX = 95;
            posY = 60;
            mapID = 17;
            NPCID = 2;
          }
          else if (this.Myself.Menpai == AllEnums.Menpais.MINHGIAO)
          {
            posX = 98;
            posY = 105;
            mapID = 11;
            NPCID = 1;
          }
          else if (this.Myself.Menpai != AllEnums.Menpais.NGAMI)
          {
            if (this.Myself.Menpai == AllEnums.Menpais.TIEUDAO)
            {
              posX = 119;
              posY = 152;
              mapID = 14;
              NPCID = 13;
            }
            else if (this.Myself.Menpai == AllEnums.Menpais.THIENLONG)
            {
              posX = 95;
              posY = 88;
              mapID = 13;
              NPCID = 4;
            }
            else if (this.Myself.Menpai == AllEnums.Menpais.DUONGMON)
            {
              posX = 100;
              posY = 64 /*0x40*/;
              mapID = 521;
              NPCID = 2;
            }
            else if (this.Myself.Menpai == AllEnums.Menpais.CAIBANG)
            {
              posX = 92;
              posY = 77;
              mapID = 10;
              NPCID = 16 /*0x10*/;
            }
          }
        }
        bool flag4 = false;
        if (!GA.IsInPhuBan(this.Myself.MapID, this))
          flag4 = this.GoToMyPos(posX, posY, mapID);
        if (flag4)
        {
          this.CallTalkNPC(0, 0, NPCID);
          long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
          while (this.Myself.isQuestFrameShow == 0)
          {
            Thread.Sleep(200);
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds > 2000L)
              break;
          }
          this.CallTalkNPC(menuTypeID5, menuIndex5, NPCID);
          Thread.Sleep(millisecondsTimeout);
          if (num9 == 1)
          {
            this.CallTraNhiemVu();
            Thread.Sleep(millisecondsTimeout);
          }
          if (num10 == 1)
          {
            this.CallTraNhiemVu();
            Thread.Sleep(millisecondsTimeout);
          }
          if (num11 == 1)
          {
            this.CallNhanNhiemVu();
            Thread.Sleep(millisecondsTimeout);
          }
          if (counter < 3)
            ++this.MyFlag.counter;
          if (counter == 3)
          {
            if (this.MyFlag.tempStamp == 0L)
              this.MyFlag.tempStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
            if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.tempStamp > 30000L)
            {
              this.MyFlag.tempStamp = 0L;
              this.MyFlag.counter = 0;
              ++this.Myself.QuestStep;
            }
          }
        }
        if (GA.IsInPhuBan(this.Myself.MapID, this))
        {
          this.MyFlag.tempStamp = 0L;
          Thread.Sleep(1000);
          QuaiIndividual quaiIndividual = this.SearchNPCByPos((int) this.Myself.PosX, (int) this.Myself.PosY, 10);
          if (quaiIndividual != null)
          {
            this.CallMoveTo((int) quaiIndividual.PosX, (int) quaiIndividual.PosY);
            Thread.Sleep(millisecondsTimeout + 2000);
            int menuTypeID6 = 500607;
            int menuIndex6 = 758;
            this.CallTalkNPC(0, 0, quaiIndividual.ID);
            long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
            while (this.Myself.isQuestFrameShow == 0)
            {
              Thread.Sleep(200);
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds > 2000L)
                break;
            }
            this.CallTalkNPC(menuTypeID6, menuIndex6, quaiIndividual.ID);
            Thread.Sleep(millisecondsTimeout);
            this.CallTraNhiemVu();
            Thread.Sleep(millisecondsTimeout);
            this.CallNhanNhiemVu();
            Thread.Sleep(millisecondsTimeout);
            this.MyFlag.counter = 0;
            ++this.Myself.QuestStep;
            Thread.Sleep(2000);
          }
        }
      }
    }
    if (this.Myself.QuestStep == 25)
    {
      if (this.IsInPhai())
      {
        int questStep4 = this.Myself.QuestStep;
        frmMain.ResetPhoBan(this);
        this.Myself.QuestStep = questStep4;
        ++this.Myself.QuestStep;
      }
      else
      {
        if (this.Settings.cboABMenuID == 0 && this.Settings.cboABMaps == -1 || this.Myself.NhiemVuPosX == 0 && this.Myself.NhiemVuPosY == 0)
        {
          if (this.Myself.Menpai == AllEnums.Menpais.MODUNG)
          {
            this.Settings.cboABMenuID = 808043;
            this.Settings.cboABMaps = 195;
            this.CallSetUpNhiemVuData(29, 137);
          }
          else if (this.Myself.Menpai == AllEnums.Menpais.THIEULAM)
          {
            this.Settings.cboABMenuID = 808027;
            this.Settings.cboABMaps = 9;
            this.CallSetUpNhiemVuData(95, 137);
          }
          else if (this.Myself.Menpai == AllEnums.Menpais.TINHTUC)
          {
            this.Settings.cboABMenuID = 808028;
            this.Settings.cboABMaps = 16 /*0x10*/;
            this.CallSetUpNhiemVuData(96 /*0x60*/, 152);
          }
          else if (this.Myself.Menpai == AllEnums.Menpais.VODANG)
          {
            this.Settings.cboABMenuID = 808033;
            this.Settings.cboABMaps = 12;
            this.CallSetUpNhiemVuData(103, 140);
          }
          else if (this.Myself.Menpai == AllEnums.Menpais.THIENSON)
          {
            this.Settings.cboABMenuID = 808030;
            this.Settings.cboABMaps = 17;
            this.CallSetUpNhiemVuData(95, 120);
          }
          else if (this.Myself.Menpai == AllEnums.Menpais.MINHGIAO)
          {
            this.Settings.cboABMenuID = 808031;
            this.Settings.cboABMaps = 11;
            this.CallSetUpNhiemVuData(98, 167);
          }
          else if (this.Myself.Menpai == AllEnums.Menpais.NGAMI)
          {
            this.Settings.cboABMenuID = 808034;
            this.Settings.cboABMaps = 115;
            this.CallSetUpNhiemVuData(89, 144 /*0x90*/);
          }
          else if (this.Myself.Menpai == AllEnums.Menpais.TIEUDAO)
          {
            this.Settings.cboABMenuID = 808016;
            this.Settings.cboABMaps = 14;
            this.CallSetUpNhiemVuData(68, 144 /*0x90*/);
          }
          else if (this.Myself.Menpai == AllEnums.Menpais.THIENLONG)
          {
            this.Settings.cboABMenuID = 808029;
            this.Settings.cboABMaps = 13;
            this.CallSetUpNhiemVuData(96 /*0x60*/, 120);
          }
          else if (this.Myself.Menpai == AllEnums.Menpais.DUONGMON)
          {
            this.Settings.cboABMenuID = 808044;
            this.Settings.cboABMaps = 521;
            this.CallSetUpNhiemVuData(126, 69);
          }
          else if (this.Myself.Menpai == AllEnums.Menpais.CAIBANG)
          {
            this.Settings.cboABMenuID = 808032;
            this.Settings.cboABMaps = 10;
            this.CallSetUpNhiemVuData(91, 116);
          }
        }
        this.LoadPathPoint(this.Settings.cboABMaps);
        this.PhuBanDacBiet(this.Myself.MapID);
      }
    }
    if (this.Myself.QuestStep != 26)
      return;
    bool flag5 = false;
    int posX1 = 347;
    int posY1 = 282;
    int mapID1 = 0;
    if (!GA.IsInPhuBan(this.Myself.MapID, this))
      flag5 = this.GoToMyPos(posX1, posY1, mapID1);
    if (!flag5)
      return;
    this.IsAIEnabled = false;
    this.Myself.isTanThu = false;
    GA.WriteUserLog(frmMain.langNhiemVuTanThuStop, this);
  }

  public void NhiemVuDoiKimTamTi()
  {
    bool flag = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag = true;
    if (!flag || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 100L)
      return;
    this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    int posX = 256 /*0x0100*/;
    int posY = 246;
    int mapID = 0;
    int menuTypeID = 889284;
    if (!this.GoToMyPos(posX, posY, mapID))
      return;
    QuaiIndividual quaiIndividual = this.SearchNPCByName("Bụi Hoa Hồng");
    if (quaiIndividual == null)
      return;
    if (this.Myself.QuestStep == 0)
    {
      this.CallTalkNPC(0, 0, quaiIndividual.ID);
      if (this.Myself.isQuestFrameShow == 1)
        ++this.Myself.QuestStep;
    }
    if (this.Myself.QuestStep == 1)
    {
      this.CallTalkNPC(menuTypeID, 5, quaiIndividual.ID);
      if (this.WaitPacketMsg("D5KTT"))
        ++this.Myself.QuestStep;
      else
        this.Myself.QuestStep = 0;
    }
    if (this.Myself.QuestStep == 2)
    {
      this.CallTalkNPC(menuTypeID, 50, quaiIndividual.ID);
      if (this.WaitPacketMsg("CKTT"))
        ++this.Myself.QuestStep;
      else
        this.Myself.QuestStep = 0;
    }
    if (this.Myself.QuestStep != 3)
      return;
    this.CallQuestItemChoice(889284, 20310166);
    if (this.WaitPacketMsg("KTTTC"))
      this.Myself.QuestStep = 0;
    else
      this.Myself.QuestStep = 0;
  }

  public void NhiemVuDoiChiTonCH()
  {
    bool flag = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag = true;
    if (!flag || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 100L)
      return;
    this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    int posX = 258;
    int posY = 164;
    int mapID = 0;
    int NPCID = 71;
    int menuTypeID = 5137;
    if (!this.GoToMyPos(posX, posY, mapID))
      return;
    if (this.Myself.QuestStep == 0)
    {
      this.CallTalkNPC(0, 0, NPCID);
      if (this.Myself.isQuestFrameShow == 1)
        ++this.Myself.QuestStep;
    }
    if (this.Myself.QuestStep == 1)
    {
      this.CallTalkNPC(menuTypeID, 100, NPCID);
      if (this.WaitPacketMsg("CDMD"))
        ++this.Myself.QuestStep;
      else
        this.Myself.QuestStep = 0;
    }
    if (this.Myself.QuestStep == 2)
    {
      this.CallTalkNPC(menuTypeID, 101, NPCID);
      if (this.WaitPacketMsg("CCTCH"))
        ++this.Myself.QuestStep;
      else
        this.Myself.QuestStep = 0;
    }
    if (this.Myself.QuestStep != 3)
      return;
    this.CallTraNhiemVu();
    if (this.WaitPacketMsg("DCTTC"))
      this.Myself.QuestStep = 0;
    else
      this.Myself.QuestStep = 0;
  }

  public void NhiemVuThuTaiVanMay()
  {
    bool flag = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag = true;
    if (!flag || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 100L)
      return;
    this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    int posX = 230;
    int posY = 350;
    int mapID = 1;
    int NPCID = 3;
    int menuTypeID = 808071;
    if (!this.GoToMyPos(posX, posY, mapID))
      return;
    if (this.Myself.QuestStep == 0)
    {
      this.CallTalkNPC(0, 0, NPCID);
      if (this.Myself.isQuestFrameShow == 1)
        ++this.Myself.QuestStep;
    }
    if (this.Myself.QuestStep == 1)
    {
      this.CallTalkNPC(menuTypeID, 111, NPCID);
      if (this.WaitPacketMsg("TTVMR", resetMsg: false))
      {
        ++this.Myself.QuestStep;
      }
      else
      {
        int num1 = 0;
        int num2 = 0;
        int num3 = 0;
        while (num1 == num2 || num1 == num3 || num2 == num3)
        {
          Random random = new Random();
          num1 = random.Next(1, 20);
          num2 = random.Next(1, 20);
          num3 = random.Next(1, 20);
          Thread.Sleep(200);
        }
        List<int> intList = new List<int>();
        intList.Add(num1);
        intList.Add(num2);
        intList.Add(num3);
        for (int index = 0; index < 3; ++index)
        {
          if (this.Myself.PacketMsg == "TTPC")
            this.DoSomeThingDLL(9, intList[index]);
          else
            this.CallStringWithEnv(24, intList[index]);
          Thread.Sleep(2000);
        }
        ++this.Myself.QuestStep;
      }
    }
    if (this.Myself.QuestStep != 2)
      return;
    this.CallTalkNPC(0, 0, NPCID);
    Thread.Sleep(1000);
    this.CallTalkNPC(menuTypeID, 112 /*0x70*/, NPCID);
    Thread.Sleep(1000);
    this.ResetPacketMsg();
    this.Myself.isThuTaiVanMay = false;
    this.Myself.QuestStep = 0;
    if (this.Settings.cboxTiepTucNhiemVuNgay)
    {
      this.Myself.isNguHanhPhapThiep = true;
      GA.WriteUserLog("Đã xong NV Thử Tài Vận May. Tự chuyển sang NV Ngũ hành pháp thiệp", this);
    }
    else
    {
      this.IsAIEnabled = false;
      GA.WriteUserLog("Đã xong NV Thử Tài Vận May", this);
    }
  }

  public void NhiemVuThienLongTueHong()
  {
    bool flag1 = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag1 = true;
    if (!flag1 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 100L)
      return;
    this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    int posX = 175;
    int posY = 143;
    int mapID = 2;
    int NPCID = 118;
    int menuTypeID1 = 809314;
    if (this.MySkills.PhuDaiLyDelay <= 0 && this.Myself.MapID != 2)
    {
      this.CallXuongNgua();
      this.CallAttackTarget(0, 22, 0, 0);
      long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
      long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
      while (this.IsAIEnabled && this.Myself.MapID != 2 && this.Myself.isSceneTrans != 1)
      {
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 >= 20000L && this.Myself.ActionStatus != (byte) 5)
        {
          this.CallAttackTarget(0, 22, 0, 0);
          elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        }
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 < 90000L || this.Myself.ActionStatus == (byte) 5)
          Thread.Sleep(500);
        else
          break;
      }
    }
    if (!this.GoToMyPos(posX, posY, mapID))
      return;
    int num = 20700000;
    int menuTypeID2 = 809312;
    if (this.Myself.NhiemVuQuaiID > 20700000)
      num = this.Myself.NhiemVuQuaiID;
    if (this.Myself.NhiemVuItemIndex >= 809311)
      menuTypeID2 = this.Myself.NhiemVuItemIndex;
    if (this.Myself.QuestStep == 0)
    {
      this.CallTalkNPC(0, 0, NPCID);
      Thread.Sleep(1000);
      if (this.Myself.isQuestFrameShow == 1)
      {
        this.CallTalkNPC(menuTypeID1, 1, NPCID);
        if (this.WaitPacketMsg("NVTTH"))
          ++this.Myself.QuestStep;
        else
          this.Myself.QuestStep = 0;
      }
    }
    if (this.Myself.QuestStep == 1)
    {
      bool flag2 = false;
      for (int index = 30; index < 60; ++index)
      {
        if (this.MyInventory.AllItems[index].ItemID == num)
        {
          flag2 = true;
          break;
        }
      }
      if (flag2)
      {
        this.CallTalkNPC(menuTypeID2, -1, NPCID);
        long elapsedMilliseconds3 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        while (this.IsAIEnabled)
        {
          if (this.Myself.PacketMsg == "HNHR")
          {
            ++this.Myself.QuestStep;
            break;
          }
          if (this.Myself.PacketMsg == "CTNV")
          {
            long elapsedMilliseconds4 = frmLogin.GlobalTimer.ElapsedMilliseconds;
            while (this.Myself.isQuestFrameShow == 1)
            {
              this.CallTraNhiemVu();
              Thread.Sleep(200);
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds4 > 2000L)
                break;
            }
            ++this.Myself.QuestStep;
            break;
          }
          if (this.Myself.PacketMsg == "CNNV")
          {
            long elapsedMilliseconds5 = frmLogin.GlobalTimer.ElapsedMilliseconds;
            while (this.Myself.isQuestFrameShow == 1)
            {
              this.CallNhanNhiemVu();
              Thread.Sleep(200);
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds5 > 2000L)
                break;
            }
            this.ResetPacketMsg();
            this.Myself.QuestStep = 0;
            break;
          }
          if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds3 > 5000L)
          {
            this.ResetPacketMsg();
            this.Myself.QuestStep = 0;
            break;
          }
          Thread.Sleep(200);
        }
      }
      else
        ++this.Myself.QuestStep;
    }
    if (this.Myself.QuestStep == 2)
    {
      this.ResetPacketMsg();
      if (this.Myself.actionFlag == 0)
      {
        this.Myself.NhiemVuQuaiID = 20700001;
        this.Myself.NhiemVuItemIndex = 809311;
        ++this.Myself.actionFlag;
        this.Myself.QuestStep = 0;
      }
      else if (this.Myself.actionFlag == 1)
      {
        this.Myself.NhiemVuQuaiID = 20700002;
        this.Myself.NhiemVuItemIndex = 809313;
        ++this.Myself.actionFlag;
        this.Myself.QuestStep = 0;
      }
      else if (this.Myself.actionFlag == 2)
      {
        this.Myself.actionFlag = 0;
        ++this.Myself.QuestStep;
      }
    }
    if (this.Myself.QuestStep != 3)
      return;
    this.CallTalkNPC(0, 0, NPCID);
    Thread.Sleep(1000);
    if (this.Myself.isQuestFrameShow != 1)
      return;
    this.CallTalkNPC(menuTypeID1, 2, NPCID);
    Thread.Sleep(1000);
    this.CallTalkNPC(menuTypeID1, 2, NPCID);
    Thread.Sleep(500);
    this.CallTalkNPC(menuTypeID1, 2, NPCID);
    Thread.Sleep(500);
    this.Myself.QuestStep = 0;
    this.Myself.isThienLongTueHong = false;
    this.IsAIEnabled = false;
    GA.WriteUserLog("Đã xong nhiệm vụ Thiên Long Tuế Hồng, dừng auto", this);
  }

  public void NhiemVuNguHanhPhapThiep()
  {
    bool flag = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag = true;
    if (!flag || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 100L)
      return;
    this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    int posX = 200;
    int posY = 334;
    int mapID = 1;
    int NPCID = 171;
    int menuTypeID = 890060;
    if (!this.GoToMyPos(posX, posY, mapID))
      return;
    if (this.Myself.QuestStep == 0)
    {
      this.CallTalkNPC(0, 0, NPCID);
      Thread.Sleep(1000);
      if (this.Myself.isQuestFrameShow == 1)
      {
        this.CallTalkNPC(menuTypeID, 15, NPCID);
        if (this.WaitPacketMsg("DNXR"))
          ++this.Myself.QuestStep;
        else
          ++this.Myself.QuestStep;
      }
      this.DoSomeThingDLL(8);
    }
    if (this.Myself.QuestStep != 1)
      return;
    this.ResetPacketMsg();
    this.Myself.QuestStep = 0;
    this.Myself.isNguHanhPhapThiep = false;
    if (this.Settings.cboxTiepTucNhiemVuNgay)
    {
      this.Myself.isLoLyHoa = true;
      GA.WriteUserLog("Đã nhận xong Ngũ Hành Pháp Thiệp. Tự chuyển sang NV Lò ly hỏa", this);
    }
    else
    {
      this.IsAIEnabled = false;
      GA.WriteUserLog("Đã nhận xong Ngũ Hành Pháp Thiệp", this);
    }
  }

  public void NhiemVuLoLyHoa()
  {
    bool flag = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag = true;
    if (!flag || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 100L)
      return;
    this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    int posX = 363;
    int posY = 243;
    int mapID = 1;
    int NPCID = 173;
    int menuTypeID = 890174;
    if (!this.GoToMyPos(posX, posY, mapID))
      return;
    if (this.Myself.QuestStep == 0)
    {
      this.CallTalkNPC(0, 0, NPCID);
      Thread.Sleep(1000);
      if (this.Myself.isQuestFrameShow == 1)
      {
        this.CallTalkNPC(menuTypeID, 100, NPCID);
        Thread.Sleep(1000);
        ++this.Myself.QuestStep;
      }
    }
    if (this.Myself.QuestStep == 1)
    {
      this.CallStringWithEnv(25);
      if (this.WaitPacketMsg("DCXR"))
        ++this.Myself.QuestStep;
      else
        this.Myself.QuestStep = 10;
    }
    if (this.Myself.QuestStep == 2)
    {
      this.CallStringWithEnv(26);
      if (this.WaitPacketMsg("LDTC"))
        this.Myself.QuestStep = 1;
      else
        this.CallStringWithEnv(27);
    }
    if (this.Myself.QuestStep != 10)
      return;
    this.ResetPacketMsg();
    this.Myself.QuestStep = 0;
    this.Myself.isLoLyHoa = false;
    if (this.Settings.cboxTiepTucNhiemVuNgay)
    {
      this.Myself.isThienLongTueHong = true;
      GA.WriteUserLog("Đã xong NV Lò Ly Hỏa, Tự chuyển sang NV Thiên long tuế hồng", this);
    }
    else
    {
      this.IsAIEnabled = false;
      GA.WriteUserLog("Đã xong NV Lò Ly Hỏa", this);
    }
  }

  public void NhiemVuDoiKimTinhThach()
  {
    bool flag = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag = true;
    if (!flag || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 100L)
      return;
    this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    int posX = 363;
    int posY = 243;
    int mapID = 1;
    int NPCID = 173;
    int menuTypeID = 890174;
    if (!this.GoToMyPos(posX, posY, mapID))
      return;
    if (this.Myself.QuestStep == 0)
    {
      this.CallTalkNPC(0, 0, NPCID);
      Thread.Sleep(1000);
      if (this.Myself.isQuestFrameShow == 1)
      {
        this.CallTalkNPC(menuTypeID, 101, NPCID);
        Thread.Sleep(1000);
        ++this.Myself.QuestStep;
      }
    }
    if (this.Myself.QuestStep == 1)
    {
      this.CallStringWithEnv(28);
      this.Myself.QuestStep = !this.WaitPacketMsg("DKTC") ? 10 : 0;
    }
    if (this.Myself.QuestStep != 10)
      return;
    this.ResetPacketMsg();
    this.Myself.QuestStep = 0;
    this.Myself.isDoiKimTinhThach = false;
    this.IsAIEnabled = false;
    GA.WriteUserLog("Đã đổi xong Kim Tinh Thạch, dừng auto", this);
  }

  public void NhiemVuBuonDuaHau()
  {
    if (this.Settings.cboDHAutoPick && GA.IsBangMapID(this.Myself.MapID) && GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, 45.0, 74.0) < 30.0)
    {
      bool flag1 = false;
      bool flag2 = false;
      bool flag3 = false;
      int LoaiBoc = 808;
      if (this.MyBoc.AllBocs.Count > 0)
      {
        for (int index = this.MyBoc.AllBocs.Count - 1; index >= 0; --index)
        {
          if (this.MyBoc.AllBocs[index].BocType == LoaiBoc)
          {
            this.Settings.nhathopDuaHauStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
            flag1 = true;
            break;
          }
        }
      }
      if (this.Settings.cboDHFromCity && flag1)
      {
        for (int index = 60; index < 80 /*0x50*/; ++index)
        {
          InventoryItem allItem = this.MyInventory.AllItems[index];
          if (allItem.ItemID == 40004541 || allItem.ItemID == 40004543 || allItem.ItemID == 40004544 || allItem.ItemID == 40004545)
            flag2 = true;
        }
      }
      if (!flag1 && !flag2 && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Settings.nhathopDuaHauStamp < 5000L)
      {
        this.Settings.nhathopDuaHauStamp = frmLogin.GlobalTimer.ElapsedMilliseconds - 5000L;
        this.CallMoveTo(45, 72);
      }
      if (flag1 && !flag2)
      {
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Settings.txtDHBangIDStampFalse <= 1200000L && this.Settings.txtDHBangIDStampFalse > 0L)
          flag1 = false;
        else if (this.Settings.txtDHBangIDStamp == 0L || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Settings.txtDHBangIDStamp >= 1200000L)
        {
          flag3 = true;
          int num1 = 45;
          int num2 = 74;
          if (this.GoToMyPos(num1, num2, this.Myself.MapID))
          {
            this.ResetPacketMsg();
            QuaiIndividual quaiIndividual = this.SearchNPCByPos(num1, num2, 5);
            if (quaiIndividual != null)
            {
              this.CallTalkNPC(0, 0, quaiIndividual.ID);
              Thread.Sleep(700);
              if (this.Myself.isQuestFrameShow == 1)
              {
                if (this.WaitPacketMsg("DLBM"))
                {
                  this.Settings.txtDHBangID = this.Myself.MapID;
                  this.Settings.txtDHBangIDStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                }
                else
                {
                  flag1 = false;
                  this.Settings.txtDHBangIDStampFalse = frmLogin.GlobalTimer.ElapsedMilliseconds;
                }
              }
            }
          }
        }
        bool flag4 = false;
        if (GA.IsCTVMember())
          flag4 = true;
        if (!flag1)
        {
          PlayerIndividual playerIndividual = (PlayerIndividual) null;
          bool flag5 = true;
          try
          {
            for (int index = this.MyPlayers.AllPlayers.Count - 1; index >= 0; --index)
            {
              PlayerIndividual allPlayer = this.MyPlayers.AllPlayers[index];
              flag5 = this.isThisMyFriend(allPlayer);
              if (!flag5 && this.Myself.BangID != allPlayer.BangID)
              {
                playerIndividual = allPlayer;
                break;
              }
            }
          }
          catch (Exception ex)
          {
            GA.WriteUserLog("Lỗi loop người chơi, vui lòng báo cho Admin", this);
          }
          if (!flag5 && frmLogin.GAuto.Settings.DuaHauBangMapIDArray.Count > 0)
          {
            for (int index = 0; index < frmLogin.GAuto.Settings.DuaHauBangMapIDArray.Count; ++index)
            {
              if (this.Myself.MapID == frmLogin.GAuto.Settings.DuaHauBangMapIDArray[index])
              {
                flag5 = true;
                break;
              }
            }
          }
          if (flag5)
            flag4 = true;
          else if (playerIndividual != null)
            GA.ShowBalloon($"Có người lạ tên {playerIndividual.Name} trong phạm vi, vui lòng tổ đội với nhau\nNếu có người lạ auto sẽ không nhặt hộp quà", "Cảnh báo", this);
        }
        if ((!flag1 || this.Settings.txtDHBangID != this.Myself.MapID) && !flag4)
          return;
        if (!flag3)
          this.NhatBoc(LoaiBoc);
        this.Settings.nhathopDuaHauStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
        return;
      }
    }
    if (this.Myself.ID <= 0 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 100L || !this.Settings.cboDHFromCity)
      return;
    int num3 = 129;
    int num4 = 98;
    int menuTypeID1 = 808150;
    if (this.isInDiaPhu())
    {
      this.CallMoveTo(12, 24);
      this.Myself.QuestStep = 0;
    }
    else
    {
      if (this.Myself.QuestStep == 0)
      {
        bool flag = false;
        for (int index = 60; index < 80 /*0x50*/; ++index)
        {
          InventoryItem allItem = this.MyInventory.AllItems[index];
          if (allItem.ItemID == 40004541 || allItem.ItemID == 40004543 || allItem.ItemID == 40004544 || allItem.ItemID == 40004545)
          {
            this.Myself.QuestStep = 5;
            flag = true;
            break;
          }
          if (allItem.ItemID == 40004542)
          {
            this.Myself.QuestStep = 3;
            flag = true;
            break;
          }
        }
        if (!flag)
          this.Myself.QuestStep = 1;
      }
      if (this.Myself.QuestStep == 1)
      {
        if (GA.IsBangMapID(this.Myself.MapID))
        {
          if (this.GoToMyPos(num3, num4, this.Myself.MapID))
            ++this.Myself.QuestStep;
        }
        else if (this.IsInCity())
          this.GoToMyBang();
        else
          this.VeThanhMuaDo(false);
      }
      if (this.Myself.QuestStep == 2)
      {
        this.GoToMyPos(num3, num4, this.Myself.MapID);
        QuaiIndividual quaiIndividual = this.SearchNPCByPos(num3, num4, 5);
        if (quaiIndividual != null)
        {
          this.CallTalkNPC(0, 0, quaiIndividual.ID);
          if (this.Myself.HorseType >= 0)
            this.CallXuongNgua();
          Thread.Sleep(700);
          if (this.Myself.isQuestFrameShow == 1)
          {
            this.CallTalkNPC(menuTypeID1, -1, quaiIndividual.ID);
            Thread.Sleep(700);
            this.CallTalkNPC(menuTypeID1, 1, quaiIndividual.ID);
            Thread.Sleep(700);
            this.CallNhanNhiemVu();
            Thread.Sleep(700);
            if (this.Myself.actionCounter > 3)
            {
              this.Myself.isBuonDuaHau = false;
              this.IsAIEnabled = false;
              GA.WriteUserLog("Xong Q Dưa, dừng Auto", this);
              return;
            }
            ++this.Myself.actionCounter;
            for (int index = 60; index < 80 /*0x50*/; ++index)
            {
              if (this.MyInventory.AllItems[index].ItemID == 40004542)
              {
                this.Myself.actionCounter = 0;
                this.Settings.txtDHBangID = this.Myself.MapID;
                ++this.Myself.QuestStep;
              }
            }
          }
        }
      }
      if (this.Myself.QuestStep == 3)
      {
        if (!GA.IsBangMapID(this.Myself.MapID))
        {
          ++this.Myself.QuestStep;
          return;
        }
        if (this.Settings.cboxDuaHauCity == 5010)
        {
          this.GoToMyPos(99, 157, this.Myself.MapID);
        }
        else
        {
          int num5 = 100;
          int num6 = 55;
          menuTypeID1 = 805009;
          if (this.GoToMyPos(num5, num6, this.Myself.MapID))
          {
            QuaiIndividual quaiIndividual = this.SearchNPCByPos(num5, num6, 5);
            if (quaiIndividual != null)
            {
              this.CallTalkNPC(0, 0, quaiIndividual.ID);
              Thread.Sleep(700);
              if (this.Myself.isQuestFrameShow == 1)
              {
                this.CallTalkNPC(menuTypeID1, 29, quaiIndividual.ID);
                Thread.Sleep(700);
                if (this.Settings.cboxDuaHauCity == 0)
                  this.CallTalkNPC(menuTypeID1, 11, quaiIndividual.ID);
                else if (this.Settings.cboxDuaHauCity == 1)
                  this.CallTalkNPC(menuTypeID1, 28, quaiIndividual.ID);
                else if (this.Settings.cboxDuaHauCity == 2)
                  this.CallTalkNPC(menuTypeID1, 27, quaiIndividual.ID);
                Thread.Sleep(700);
              }
            }
          }
        }
      }
      if (this.Myself.QuestStep == 4)
      {
        if (this.Myself.NhiemVuMapID < 0)
        {
          foreach (DuaHauDBElement duaHauDbElement in frmLogin.GAuto.DuaHauDB)
          {
            if (duaHauDbElement.MapID == this.Settings.cboxDuaHauMaps)
            {
              this.CallSetUpNhiemVuData(duaHauDbElement.PosX, duaHauDbElement.PosY, duaHauDbElement.MapID);
              break;
            }
          }
        }
        if (this.Myself.NhiemVuMapID > 0 && this.GoToMyPos(this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY, this.Myself.NhiemVuMapID))
        {
          QuaiIndividual quaiIndividual = this.SearchNPCByPos(this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY, 5);
          if (quaiIndividual != null)
          {
            this.CallTalkNPC(0, 0, quaiIndividual.ID);
            Thread.Sleep(700);
            if (this.Myself.isQuestFrameShow == 1)
            {
              this.CallTalkNPC(menuTypeID1, -1, quaiIndividual.ID);
              Thread.Sleep(700);
            }
          }
          for (int index = 60; index < 80 /*0x50*/; ++index)
          {
            InventoryItem allItem = this.MyInventory.AllItems[index];
            if (allItem.ItemID == 40004541 || allItem.ItemID == 40004543 || allItem.ItemID == 40004544 || allItem.ItemID == 40004545)
            {
              this.CallResetNhiemVuData();
              ++this.Myself.QuestStep;
              break;
            }
          }
        }
      }
      if (this.Myself.QuestStep == 5)
      {
        if (GA.IsBangMapID(this.Myself.MapID))
        {
          ++this.Myself.QuestStep;
          this.CallResetNhiemVuData();
          return;
        }
        if (this.Settings.cboxDuaHauCity == 5010 && this.Settings.txtDHBangID > 0 && !this.IsInCity())
        {
          if (this.Myself.NhiemVuMapID < 0)
          {
            foreach (AdvancedPath advancedPath in frmLogin.GAuto.AutoPathDB)
            {
              if (advancedPath.ToMapID == this.Settings.txtDHBangID)
              {
                this.CallSetUpNhiemVuData(advancedPath.GatePosX, advancedPath.GatePosY, advancedPath.MapID);
                break;
              }
            }
          }
          if (this.Myself.NhiemVuMapID > 0 && this.GoToMyPos(this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY, this.Myself.NhiemVuMapID))
          {
            int menuTypeID2 = 0;
            int menuIndex = 0;
            int NPCID = -1;
            foreach (AdvancedPath advancedPath in frmLogin.GAuto.AutoPathDB)
            {
              if (advancedPath.ToMapID == this.Settings.txtDHBangID)
              {
                menuTypeID2 = advancedPath.NPCMenuTypeID_1;
                menuIndex = advancedPath.NPCMenuIndex_1;
                NPCID = advancedPath.NPC_ID;
                break;
              }
            }
            if (NPCID >= 0)
            {
              this.CallTalkNPC(0, 0, NPCID);
              Thread.Sleep(700);
              if (this.Myself.isQuestFrameShow == 1)
              {
                this.CallTalkNPC(menuTypeID2, menuIndex, NPCID);
                Thread.Sleep(700);
              }
            }
          }
        }
        else
          this.GoToMyBang();
      }
      if (this.Myself.QuestStep == 6)
      {
        int num7 = 45;
        int num8 = 74;
        if (this.GoToMyPos(num7, num8, this.Myself.MapID))
        {
          if (this.Settings.cboDHAlertTuu && this.Myself.actionCounter == 0)
          {
            ++this.Myself.actionCounter;
            try
            {
              new SoundPlayer("event.wav").Play();
            }
            catch (Exception ex)
            {
            }
          }
          if (this.Settings.cboDHAutoNV)
          {
            QuaiIndividual quaiIndividual = this.SearchNPCByPos(num7, num8, 5);
            if (quaiIndividual != null)
            {
              this.CallTalkNPC(0, 0, quaiIndividual.ID);
              Thread.Sleep(700);
              if (this.Myself.isQuestFrameShow == 1)
              {
                this.CallTalkNPC(menuTypeID1, -1, quaiIndividual.ID);
                Thread.Sleep(700);
                this.CallTraNhiemVu();
                Thread.Sleep(700);
              }
            }
          }
          bool flag6 = true;
          for (int index = 60; index < 80 /*0x50*/; ++index)
          {
            InventoryItem allItem = this.MyInventory.AllItems[index];
            if (allItem.ItemID == 40004541 || allItem.ItemID == 40004543 || allItem.ItemID == 40004544 || allItem.ItemID == 40004545)
            {
              flag6 = false;
              break;
            }
          }
          if (flag6)
          {
            bool flag7 = false;
            if (frmLogin.GAuto.Settings.DuaHauBangMapIDArray.Count > 0)
            {
              for (int index = 0; index < frmLogin.GAuto.Settings.DuaHauBangMapIDArray.Count; ++index)
              {
                if (frmLogin.GAuto.Settings.DuaHauBangMapIDArray[index] == this.Myself.MapID)
                  flag7 = true;
              }
            }
            if (!flag7)
              frmLogin.GAuto.Settings.DuaHauBangMapIDArray.Add(this.Myself.MapID);
            this.Settings.txtDHBangID = this.Myself.MapID;
            this.Myself.actionCounter = 0;
            ++this.Myself.QuestStep;
          }
        }
      }
      if (this.Myself.QuestStep != 7)
        return;
      this.CallResetNhiemVuData();
      this.Myself.QuestStep = 1;
    }
  }

  public void NhiemVuHuyItemNhiemVu()
  {
    bool flag = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag = true;
    if (!flag || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 100L)
      return;
    this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    int posX = 78;
    int posY = 136;
    int mapID = 2;
    if (this.Target.VersionNum == 3)
    {
      posX = 80 /*0x50*/;
      posY = 133;
    }
    if (!this.GoToMyPos(posX, posY, mapID))
      return;
    if (this.Target.VersionNum == 3)
    {
      if (this.Myself.InventoryShow == 0)
      {
        this.CallClickOpenInventory();
        Thread.Sleep(500);
      }
      if (this.Myself.InventoryShow == 1)
      {
        this.CallClickTabInventory(2);
        Thread.Sleep(300);
      }
    }
    for (int index = 60; index < 90; ++index)
    {
      InventoryItem allItem = this.MyInventory.AllItems[index];
      if (allItem.ItemID > 0)
      {
        if (!this.MyFlag.HuyItemNhiemVuFlag)
        {
          if (allItem.ItemID == 40004316 || allItem.ItemID == 40004430)
          {
            this.CallHuyItemNhiemVu(index);
            Thread.Sleep(200);
          }
        }
        else
        {
          this.CallHuyItemNhiemVu(index);
          Thread.Sleep(200);
        }
      }
    }
    GA.ShowBalloon(frmMain.langNhiemVuHuyItemNhiemVuXong, "", frmLogin.GAuto.CurrentAuto);
    this.IsAIEnabled = false;
    this.Myself.isHuyItemNhiemVu = false;
  }

  public void NhiemVuDoiThanBinhPhu()
  {
    bool flag = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag = true;
    if (!flag || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 100L)
      return;
    this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    int posX = 355;
    int posY = 238;
    int mapID = 1;
    int NPCID = 65;
    int menuTypeID = 161;
    int menuIndex = 2000;
    if (this.Myself.DoiThanBinhPhuMode == 1)
      menuIndex = 3001;
    if (!this.GoToMyPos(posX, posY, mapID) || this.Myself.QuestStep != 0)
      return;
    this.CallTalkNPC(0, 0, NPCID);
    Thread.Sleep(500);
    this.CallTalkNPC(menuTypeID, menuIndex, NPCID);
    Thread.Sleep(500);
    this.CallTalkNPC(menuTypeID, menuIndex + 1, NPCID);
    if (this.WaitPacketMsg("TDTC", resetMsg: false))
    {
      this.Myself.QuestStep = 0;
      this.ResetPacketMsg();
    }
    else
    {
      if (!(this.Myself.PacketMsg == "TDTB"))
        return;
      if (this.Myself.DoiThanBinhPhuMode == 0)
      {
        this.Myself.DoiThanBinhPhuMode = 1;
        this.ResetPacketMsg();
      }
      else
      {
        GA.ShowBalloon(frmMain.langComplete + frmMain.langDoiTBP, "", frmLogin.GAuto.CurrentAuto);
        this.IsAIEnabled = false;
        this.Myself.isDoiThanBinhPhu = false;
        this.Myself.DoiThanBinhPhuMode = 0;
        this.ResetPacketMsg();
      }
    }
  }

  public void NhiemVuNhanX2EXP()
  {
    bool flag = false;
    if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
      flag = true;
    if (!flag || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 100L)
      return;
    this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    int posX = 242;
    int posY = 233;
    int mapID = 0;
    int NPCID = 17;
    int menuTypeID = 311002;
    int menuIndex = 2;
    if (this.Myself.NhanX2EXPMode == 1)
      menuIndex = 3;
    else if (this.Myself.NhanX2EXPMode == 2)
      menuIndex = 4;
    if (!this.GoToMyPos(posX, posY, mapID) || this.Myself.QuestStep != 0)
      return;
    this.CallTalkNPC(0, 0, NPCID);
    Thread.Sleep(700);
    this.CallTalkNPC(menuTypeID, menuIndex, NPCID);
    Thread.Sleep(700);
    if (this.Myself.NhanX2EXPMode == 0)
      this.CallTalkNPC(menuTypeID, 204, NPCID);
    if (this.Myself.NhanX2EXPMode >= 1)
    {
      Thread.Sleep(1000);
      if (this.Myself.isMessageBox_Self == 1)
        this.CallStartAutoMoveClick();
    }
    string str = frmMain.langNhanX2EXP;
    if (this.Myself.NhanX2EXPMode == 1)
      str = frmMain.langDongBangX2EXP;
    else if (this.Myself.NhanX2EXPMode == 2)
      str = frmMain.langKichHoatX2EXP;
    GA.ShowBalloon(frmMain.langComplete + str, "", frmLogin.GAuto.CurrentAuto);
    this.IsAIEnabled = false;
    this.Myself.isNhanX2EXP = false;
    this.Myself.NhanX2EXPMode = 0;
    this.ResetPacketMsg();
  }

  public void NhiemVuDoiThoiVang()
  {
    if (this.Target.VersionNum != 3)
    {
      GA.ShowBalloon("Tính năng này không có ở phiên bản này\nLiên hệ Admin để biết thêm chi tiết", "", frmLogin.GAuto.CurrentAuto);
      this.IsAIEnabled = false;
      this.Myself.isDoiThoiVang = false;
    }
    else
    {
      bool flag = false;
      if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
        flag = true;
      if (!flag || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 100L)
        return;
      this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
      int posX = 140;
      int posY = 196;
      int mapID = 2;
      int NPCID = 157;
      int menuTypeID = 202;
      int menuIndex = 200;
      if (!this.GoToMyPos(posX, posY, mapID) || this.Myself.QuestStep != 0)
        return;
      this.CallTalkNPC(0, 0, NPCID);
      Thread.Sleep(500);
      this.CallTalkNPC(menuTypeID, menuIndex, NPCID);
      if (this.WaitPacketMsg("TDTC", resetMsg: false))
      {
        this.Myself.QuestStep = 0;
        this.ResetPacketMsg();
      }
      else
      {
        if (!(this.Myself.PacketMsg == "TDTB"))
          return;
        GA.ShowBalloon(frmMain.langComplete + frmMain.langDoiThoiVang, "", frmLogin.GAuto.CurrentAuto);
        this.IsAIEnabled = false;
        this.Myself.isDoiThoiVang = false;
      }
    }
  }

  public void NhiemVuDoiLinhHonToaiPhien(int mode = 0)
  {
    if (this.Target.VersionNum != 3)
    {
      GA.ShowBalloon("Tính năng này không có ở phiên bản này\nLiên hệ Admin để biết thêm chi tiết", "", frmLogin.GAuto.CurrentAuto);
      this.IsAIEnabled = false;
      this.Myself.isDoiLinhHonToaiPhien = false;
    }
    else
    {
      bool flag = false;
      if (this.Myself.HPPercent > 0.0 && this.Myself.ID > 0)
        flag = true;
      if (!flag || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 100L)
        return;
      this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
      int posX = 137;
      int posY = 196;
      int mapID = 2;
      int NPCID = 90;
      int menuTypeID = 169;
      int menuIndex1 = 30;
      int menuIndex2 = 12 + mode;
      if (!this.GoToMyPos(posX, posY, mapID) || this.Myself.QuestStep != 0)
        return;
      this.CallTalkNPC(0, 0, NPCID);
      long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
      while (this.Myself.isQuestFrameShow == 0)
      {
        Thread.Sleep(200);
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds > 2000L)
          break;
      }
      if (this.Myself.isQuestFrameShow == 1)
      {
        this.CallTalkNPC(menuTypeID, menuIndex1, NPCID);
        Thread.Sleep(500);
        this.CallTalkNPC(menuTypeID, menuIndex2, NPCID);
      }
      Thread.Sleep(500);
      if (this.WaitPacketMsg("TDTC", resetMsg: false))
      {
        this.Myself.QuestStep = 0;
        this.ResetPacketMsg();
      }
      else
      {
        if (!(this.Myself.PacketMsg == "TDTB"))
          return;
        GA.ShowBalloon(frmMain.langComplete + frmMain.langDoiLinhHonToaiPhien, "", frmLogin.GAuto.CurrentAuto);
        this.IsAIEnabled = false;
        this.Myself.isDoiLinhHonToaiPhien = false;
      }
    }
  }

  public void NhiemVuDoiPhieuTienVang(int mode = 0)
  {
    if (this.Target.VersionNum != 3)
    {
      GA.ShowBalloon("Tính năng này không có ở phiên bản này\nLiên hệ Admin để biết thêm chi tiết", "", frmLogin.GAuto.CurrentAuto);
      this.IsAIEnabled = false;
      this.Myself.isDoiPhieuTienVang = false;
    }
    else
    {
      this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
      int posX = 157;
      int posY = 169;
      int mapID = 2;
      int NPCID = 143;
      int menuTypeID = 2084;
      int menuIndex1 = 2002;
      switch (mode)
      {
        case 2:
          menuIndex1 = 1001;
          break;
        case 3:
          menuIndex1 = 1004;
          break;
      }
      int menuIndex2 = 2003 + mode;
      if (!this.GoToMyPos(posX, posY, mapID))
        return;
      this.CallTalkNPC(0, 0, NPCID);
      long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
      while (this.Myself.isQuestFrameShow == 0)
      {
        Thread.Sleep(200);
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds > 2000L)
          break;
      }
      if (this.Myself.isQuestFrameShow == 1)
      {
        if (mode == 2)
          Thread.Sleep(1000);
        this.CallTalkNPC(menuTypeID, menuIndex1, NPCID);
        if (mode <= 1)
        {
          Thread.Sleep(500);
          this.CallTalkNPC(menuTypeID, menuIndex2, NPCID);
        }
      }
      if (mode == 3)
        Thread.Sleep(250);
      else
        Thread.Sleep(500);
      if (this.WaitPacketMsg("TDTC", resetMsg: false))
      {
        this.Myself.QuestStep = 0;
        this.ResetPacketMsg();
        if (mode != 2)
          return;
        Thread.Sleep(1000);
      }
      else
      {
        if (!(this.Myself.PacketMsg == "TDTB"))
          return;
        if (mode <= 1)
          GA.ShowBalloon(frmMain.langComplete + frmMain.langDoiPhieuTienVang, "", frmLogin.GAuto.CurrentAuto);
        this.IsAIEnabled = false;
        this.Myself.isDoiPhieuTienVang = false;
      }
    }
  }

  public void NhiemVuPMP()
  {
    if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiPhuBanStamp < 500L)
      return;
    this.Myself.DiPhuBanStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    if (this.NPCNhiemVu.Count == 0)
    {
      this.NPCNhiemVu.Add(new AutoAccount.NPCNhiemVuClass()
      {
        menuID = this.MyFlag.menuPMP + 7,
        menuIndex = 1,
        posX = 124,
        posY = 86,
        name = "Cáp Đại Bá"
      });
      this.NPCNhiemVu.Add(new AutoAccount.NPCNhiemVuClass()
      {
        menuID = this.MyFlag.menuPMP + 8,
        menuIndex = 1,
        posX = 41,
        posY = 105,
        name = "Tang Thổ Công"
      });
      this.NPCNhiemVu.Add(new AutoAccount.NPCNhiemVuClass()
      {
        menuID = this.MyFlag.menuPMP + 9,
        menuIndex = 1,
        posX = 117,
        posY = 49,
        name = "Ô Lão Đại"
      });
      this.NPCNhiemVu.Add(new AutoAccount.NPCNhiemVuClass()
      {
        menuID = this.MyFlag.menuPMP + 10,
        menuIndex = 1,
        posX = 159,
        posY = 54,
        name = "Phù Mẫn Nghi"
      });
      this.NPCNhiemVu.Add(new AutoAccount.NPCNhiemVuClass()
      {
        menuID = this.MyFlag.menuPMP + 12,
        menuIndex = 1,
        posX = 96 /*0x60*/,
        posY = 40,
        name = "Ô Lão Đại"
      });
      this.NPCNhiemVu.Add(new AutoAccount.NPCNhiemVuClass()
      {
        menuID = this.MyFlag.menuPMP + 12,
        menuIndex = 3,
        posX = 96 /*0x60*/,
        posY = 40,
        name = "Ô Lão Đại"
      });
    }
    if (!GA.IsInPhuBan(this.Myself.MapID, this))
    {
      int toX = 193;
      int toY = 224 /*0xE0*/;
      int tomapID = 186;
      int NPCID = 56;
      int menuPmp = this.MyFlag.menuPMP;
      int menuIndex = 1;
      this.Myself.indexPPcalc = false;
      this.Myself.actionFlag = 0;
      this.Myself.actionCounter = 0;
      this.MyFlag.dosomethingCounter = 0;
      this.MyFlag.dosomethingFlag = 0;
      this.MyFlag.phubanFlag = 0;
      if (this.Myself.InMapPathPoints.Count > 0)
      {
        this.Myself.InMapPathPoints.Clear();
        this.Myself.InPathPointIndex = 0;
        this.ResetPacketMsg();
      }
      if (this.TrieuTapToQuestPoint(toX, toY, tomapID))
      {
        if (this.Myself.talkCounter == 0)
        {
          this.CallTalkNPC(0, 0, NPCID);
          Thread.Sleep(500);
          this.CallTalkNPC(menuPmp, menuIndex, NPCID);
          Thread.Sleep(500);
        }
        else
          ++this.Myself.talkCounter;
        if (this.Myself.talkCounter >= 3)
          this.Myself.talkCounter = 0;
        if (this.Myself.PacketMsg == "HLSC")
        {
          this.Myself.isPMP = false;
          this.IsAIEnabled = false;
          this.ResetPacketMsg();
          if (this.MyFlag.menuPMP == 402276)
            GA.WriteUserLog("Hết lượt sơ chiến PMP", this);
          else
            GA.WriteUserLog("Hết lượt khiêu chiến PMP", this);
        }
      }
    }
    if (!GA.IsInPhuBan(this.Myself.MapID, this))
      return;
    int mapID = 1150;
    this.Loadphubanpp(mapID);
    this.CalcNearPoint();
    if (this.Myself.InPathPointIndex <= 7 && this.Myself.actionFlag <= 1)
    {
      string str = "ch lân cương t";
      this.AddNPCNameToArray(str);
      GA.PartyNoAttack(this, 1, str);
      ++this.Myself.actionFlag;
    }
    bool flag1 = false;
    bool flag2 = false;
    if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived)
    {
      flag1 = true;
      if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared)
        flag2 = true;
    }
    if (this.Myself.InPathPointIndex == 2 && flag1)
    {
      this.MyFlag.phubanFlag = 1;
      if (this.killNPCQuest(0))
      {
        GA.PartyDoSomething(this, true, 2, stamp: 60000);
        this.MyFlag.phubanFlag = 0;
      }
    }
    if (this.Myself.InPathPointIndex == 5 && flag1)
    {
      if (this.MyFlag.phubanFlag == 0)
        this.MyFlag.phubanFlag = 1;
      if (!this.killNPCQuest(1))
      {
        if (this.MyFlag.seenTangThoCongStamp == 0L)
          this.MyFlag.seenTangThoCongStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
      }
      else
      {
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.seenTangThoCongStamp > 30000L)
        {
          this.MyFlag.phubanFlag += 4;
          this.MyFlag.seenTangThoCongStamp = 0L;
        }
        QuaiIndividual quaiIndividual = this.SearchNPCByName("Bích lân cương thi");
        if (quaiIndividual != null)
          ++this.MyFlag.phubanFlag;
        if (quaiIndividual == null && this.MyFlag.phubanFlag >= 4)
        {
          this.MyFlag.phubanFlag = 0;
          this.MyFlag.seenTangThoCongStamp = 0L;
        }
      }
    }
    if (this.Myself.InPathPointIndex == 9 && flag1)
    {
      this.MyFlag.phubanFlag = 1;
      if (this.killNPCQuest(2))
        this.MyFlag.phubanFlag = 0;
    }
    if (this.Myself.InPathPointIndex == 10 && flag2)
    {
      this.MyFlag.phubanFlag = 1;
      this.killNPCQuest(3, false);
      if (this.Myself.PacketMsg == "CDBD")
      {
        this.ResetPacketMsg();
        this.MyFlag.phubanFlag = 0;
      }
    }
    if (this.Myself.InPathPointIndex == 11 && flag1)
    {
      if (this.MyFlag.phubanFlag == 0)
        this.MyFlag.phubanFlag = 1;
      if (this.Myself.IsPartyFollowed == (byte) 1)
        this.CallRemovePartyFollow();
      if (this.Settings.cboxDanhQuai)
      {
        this.CallXuongNgua();
        this.AttackQuai();
      }
      QuaiIndividual quaiIndividual = this.SearchNPCByName("Nhậm Bình Sinh");
      bool flag3 = false;
      if (quaiIndividual != null)
      {
        ++this.MyFlag.phubanFlag;
        if ((double) quaiIndividual.HPPercent == 0.0)
          flag3 = true;
      }
      if (quaiIndividual == null && this.MyFlag.phubanFlag >= 3)
        flag3 = true;
      if (flag3)
      {
        this.MyFlag.phubanFlag = -1;
        this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
      }
    }
    if (this.Myself.InPathPointIndex == 12 && flag2)
    {
      this.MyFlag.phubanFlag = 1;
      this.killNPCQuest(4);
      if (this.Myself.PacketMsg == "CDBD")
      {
        this.ResetPacketMsg();
        this.MyFlag.phubanFlag = 0;
      }
    }
    if (this.Myself.PacketMsg == "DLTT")
    {
      this.Myself.InPathPointIndex = 13;
      this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived = false;
      this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = false;
      this.ResetPacketMsg();
    }
    if (this.Myself.InPathPointIndex == 13)
    {
      if (!this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived)
        this.Myself.actionCounter = 0;
      if (flag1)
      {
        if (this.MyFlag.phubanFlag <= 0)
          this.MyFlag.phubanFlag = 1;
        if (this.Myself.IsPartyFollowed == (byte) 1)
          this.CallRemovePartyFollow();
        if (this.Settings.cboxDanhQuai)
        {
          this.CallXuongNgua();
          this.AttackQuai();
        }
        string name = "Lý Thu Thủy";
        if (this.Target.VersionNum == 3)
          name = "Lý Thu Thuỷ";
        QuaiIndividual quaiIndividual = this.SearchNPCByName(name);
        bool flag4 = false;
        if (quaiIndividual != null)
        {
          ++this.MyFlag.phubanFlag;
          if ((double) quaiIndividual.HPPercent == 0.0)
            flag4 = true;
        }
        if (quaiIndividual == null)
        {
          GA.TrieuTapCaNhom(this, true);
          if (this.MyFlag.phubanFlag >= 3 && this.CheckMemberDistance(6.0) && this.SearchNPCByName(name) == null)
            flag4 = true;
        }
        if (this.Myself.PacketMsg == "DXPB")
        {
          this.ResetPacketMsg();
          flag4 = true;
        }
        if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, 124.0, 164.0) < 40.0)
        {
          this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived = false;
          this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = false;
          this.Myself.InPathPointIndex = 12;
          this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived = false;
          this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = false;
          flag4 = false;
          this.MyFlag.phubanFlag = 0;
        }
        if (flag4 && this.MyFlag.phubanFlag >= 2)
        {
          this.NhatBoc();
          if (this.Myself.actionCounter == 0)
          {
            GA.PartyDoSomething(this, true, 13, 1);
            this.MyFlag.dosomethingHoisinhFlag = 0;
            GA.PartyDoSomething(this, true, 22);
            if (this.MyFlag.dosomethingHoisinhFlag == 0)
            {
              Thread.Sleep(1000);
              GA.PartyDoSomething(this, true, 22);
            }
            this.NhatBoc();
            if (this.MyFlag.dosomethingHoisinhFlag == 0)
            {
              Thread.Sleep(1000);
              GA.PartyDoSomething(this, true, 22);
            }
            this.NhatBoc();
            if (this.MyFlag.dosomethingHoisinhFlag == 0)
            {
              Thread.Sleep(1000);
              GA.PartyDoSomething(this, true, 22, 2);
            }
            this.NhatBoc();
            GA.PartyDoSomething(this, true, 2);
            this.Myself.actionFlag += 2;
            ++this.MyFlag.PMPCounter;
            GA.WriteUserLog(frmMain.langCompletedPMP, this, (object) this.MyFlag.PMPCounter);
            ++this.Myself.actionCounter;
          }
          this.NhatBoc();
          Thread.Sleep(1000);
          this.NhatBoc();
          Thread.Sleep(1000);
          this.NhatBoc();
          Thread.Sleep(1000);
          this.NhatBoc();
          Thread.Sleep(1000);
          this.NhatBoc();
          Thread.Sleep(1000);
          this.NhatBoc();
          if (this.Target.VersionNum == 3)
          {
            if (this.MyFlag.dosomethingFlag == 0)
            {
              Thread.Sleep(5000);
              GA.PartyDoSomething(this, mode: 8, param1: 186);
            }
            if (this.MyFlag.dosomethingFlag == 1)
            {
              GA.PartyDoSomething(this, true, 8, 186);
              Thread.Sleep(7000);
            }
          }
          else
          {
            this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared = true;
            this.MyFlag.phubanFlag = 0;
          }
        }
      }
    }
    if (this.Myself.InPathPointIndex == 14 && flag1)
    {
      this.CallPartyFollowMe(30000);
      this.MyFlag.phubanFlag = 1;
      int num = 5;
      this.killNPCQuest(num, false, this.NPCNhiemVu[num].menuID, 4);
    }
    if (this.MyFlag.phubanFlag > 0)
      return;
    this.PhuBanYTO(mapID);
  }

  private bool killNPCQuest(int npcIndex, bool attack = true, int menuID2 = -1, int npcIndex2 = -1)
  {
    int millisecondsTimeout = 700;
    bool flag = false;
    if (attack && this.Myself.IsPartyFollowed == (byte) 1)
      this.CallRemovePartyFollowSafe();
    string name = this.NPCNhiemVu[npcIndex].name;
    QuaiIndividual quaiIndividual = this.SearchNPCByName(name);
    if (quaiIndividual != null && (double) quaiIndividual.HPPercent == 100.0)
    {
      int id = quaiIndividual.ID;
      this.CallTalkNPC(0, 0, id, removeGroup: true);
      Thread.Sleep(millisecondsTimeout);
      this.CallTalkNPC(this.NPCNhiemVu[npcIndex].menuID, this.NPCNhiemVu[npcIndex].menuIndex, id, removeGroup: true);
      Thread.Sleep(millisecondsTimeout + millisecondsTimeout);
      if (npcIndex2 >= 0)
      {
        if (this.NPCNhiemVu[npcIndex].menuID == 402288)
        {
          this.CallTalkNPC(402276, this.NPCNhiemVu[npcIndex].menuIndex, id, removeGroup: true);
          Thread.Sleep(millisecondsTimeout + millisecondsTimeout);
        }
        this.CallTalkNPC(menuID2, npcIndex2, id);
        Thread.Sleep(millisecondsTimeout);
      }
    }
    if (attack)
      this.AttackQuai();
    if (quaiIndividual != null && (double) quaiIndividual.HPPercent == 0.0)
      flag = true;
    if (quaiIndividual == null)
    {
      if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) this.NPCNhiemVu[npcIndex].posX, (double) this.NPCNhiemVu[npcIndex].posY) < 10.0)
      {
        if (attack)
        {
          Thread.Sleep(300);
          this.AttackQuai();
          Thread.Sleep(300);
          this.AttackQuai();
          Thread.Sleep(300);
          this.AttackQuai();
          Thread.Sleep(300);
          this.AttackQuai();
          Thread.Sleep(300);
          this.AttackQuai();
          Thread.Sleep(300);
          this.AttackQuai();
        }
        if (this.SearchNPCByName(name) == null)
          flag = true;
      }
      else
        this.GoToMyPos(this.NPCNhiemVu[npcIndex].posX, this.NPCNhiemVu[npcIndex].posY);
    }
    return flag;
  }

  public void NhiemVuLLTamBao()
  {
    if (!GA.IsInPhuBan(this.Myself.MapID, this))
    {
      int toX = 162;
      int toY = 75;
      int tomapID = 186;
      int NPCID = 70;
      int menuTypeID = 808039;
      int menuIndex1 = 1;
      this.MyFlag.tempStamp = 0L;
      this.MyFlag.dosomethingFlag = 0;
      this.ResetPacketMsg();
      this.MyFlag.phubanActionCounter = 0;
      if (this.TrieuTapToQuestPoint(toX, toY, tomapID))
      {
        if (this.Myself.talkCounter == 0)
        {
          this.CallTalkNPC(0, 0, NPCID);
          this.waitQuestFrameShow();
          if (GA.CheckGameVersion(this.Target.VersionNum) == 356)
          {
            this.CallTalkNPC(menuTypeID, menuIndex1, NPCID);
            Thread.Sleep(1500);
            int menuIndex2 = 11;
            if (this.Settings.cboxLLTBNhanh)
              menuIndex2 = 12;
            this.CallTalkNPC(menuTypeID, menuIndex2, NPCID);
            Thread.Sleep(3000);
          }
          else
          {
            this.CallTalkNPC(menuTypeID, menuIndex1, NPCID);
            Thread.Sleep(500);
          }
        }
        else
          ++this.Myself.talkCounter;
        if (this.Myself.talkCounter >= 3)
          this.Myself.talkCounter = 0;
      }
    }
    if (!GA.IsInPhuBan(this.Myself.MapID, this))
      return;
    if (this.Myself.PacketMsg == "TBXQ")
    {
      if (this.MyFlag.tempStamp == 0L)
        this.MyFlag.tempStamp = frmLogin.GlobalTimer.ElapsedMilliseconds + 5000L;
      if (this.MyFlag.tempStamp >= frmLogin.GlobalTimer.ElapsedMilliseconds)
        return;
      this.MyFlag.tempStamp = 0L;
      GA.TrieuTapToMyPos(this, 61, 78, this.Myself.MapID);
      this.ResetPacketMsg();
    }
    else if (this.Myself.PacketMsg == "TBKT")
    {
      if (this.Target.VersionNum == 3)
        GA.PartyDoSomething(this, true, 2);
      this.ResetPacketMsg();
    }
    else
    {
      QuaiIndividual quaiIndividual = this.TimQuaiXungQuanh();
      if (quaiIndividual == null)
        return;
      if (this.MyFlag.phubanActionCounter <= 1)
      {
        this.CallRemovePartyFollow();
        this.CallXuongNgua();
        GA.PartyDoSomething(this, true, 2);
        this.MyFlag.phubanActionCounter += 5;
      }
      double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quaiIndividual.PosX, (double) quaiIndividual.PosY);
      if (this.Settings.cboxDanhQuai)
      {
        if (distance > 4.0)
          this.CallMoveFlashPos((int) quaiIndividual.PosX, (int) quaiIndividual.PosY);
        else
          this.AttackQuai();
      }
      else
        this.CallMoveFlashPos((int) quaiIndividual.PosX, (int) quaiIndividual.PosY);
      this.Myself.hetquaiStamp = 1L;
    }
  }

  public void NhiemVuThuyLao()
  {
    int num1 = 232000;
    int menuIndex = -1;
    if (!GA.IsInPhuBan(this.Myself.MapID, this))
    {
      if (this.Myself.InMapPathPoints.Count > 0)
      {
        this.Myself.InMapPathPoints.Clear();
        this.Myself.InPathPointIndex = 0;
      }
      if (this.Myself.QuestStep == 0)
      {
        int toX = 342;
        int toY = 311;
        int tomapID = 1;
        int num2 = 121;
        if (this.Target.VersionNum == 3)
        {
          toX = 339;
          toY = 310;
          num2 = 93;
        }
        GA.PartyDoSomething(this, true, 8, 1);
        this.ResetPacketMsg();
        if (this.TrieuTapToQuestPoint(toX, toY, tomapID))
        {
          this.CallRemovePartyFollow();
          if (this.Myself.IsPartyFollowed == (byte) 0)
          {
            if (this.Myself.talkCounter == 0)
            {
              this.CallTalkNPC(0, 0, num2);
              Thread.Sleep(700);
              this.CallTalkNPC(num1, menuIndex, num2);
              Thread.Sleep(700);
              if (this.Myself.PacketMsg == "CNNV")
              {
                this.CallNhanNhiemVu();
                Thread.Sleep(700);
              }
              if (this.Myself.PacketMsg == "DNTL")
              {
                GA.PartyTalkNPC(this, num2, num1, menuIndex, mode: 1);
                this.ResetPacketMsg();
                ++this.Myself.QuestStep;
              }
            }
            else
              ++this.Myself.talkCounter;
            if (this.Myself.talkCounter >= 3)
              this.Myself.talkCounter = 0;
          }
        }
      }
      if (this.Myself.QuestStep == 1)
      {
        GA.PartyDoSomething(this, true, 32 /*0x20*/);
        ++this.Myself.QuestStep;
      }
      if (this.Myself.QuestStep == 2 && !this.Myself.isBanDoChoNPC && GA.checkFlagParty(this, 1))
        ++this.Myself.QuestStep;
      if (this.Myself.QuestStep == 3)
      {
        int toX = 66;
        int toY = 77;
        int tomapID = 4;
        int NPCID = 13;
        int menuTypeID = 232002;
        GA.PartyDoSomething(this, true, 8, param2: 0);
        if (this.TrieuTapToQuestPoint(toX, toY, tomapID))
        {
          if (this.Myself.talkCounter == 0)
          {
            this.CallTalkNPC(0, 0, NPCID);
            Thread.Sleep(700);
            this.CallTalkNPC(menuTypeID, menuIndex, NPCID);
            Thread.Sleep(700);
            this.CallNhanNhiemVu();
            Thread.Sleep(700);
          }
          else
            ++this.Myself.talkCounter;
          if (this.Myself.talkCounter >= 3)
            this.Myself.talkCounter = 0;
        }
      }
    }
    if (!GA.IsInPhuBan(this.Myself.MapID, this))
      return;
    this.Myself.QuestStep = 0;
    int mapID = 1160;
    this.Loadphubanpp(mapID);
    this.CalcNearPoint();
    if (this.Myself.InPathPointIndex >= 36 || this.Myself.PacketMsg == "KTTL")
    {
      int num3 = 232002;
      Thread.Sleep(5000);
      GA.PartyDoSomething(this, true, 31 /*0x1F*/, num3);
      this.Myself.InPathPointIndex = 0;
      this.ResetPacketMsg();
      Thread.Sleep(3000);
    }
    this.PhuBanYTO(mapID);
  }

  public void NhiemVuThuBiChienMinh()
  {
    int num1 = 0;
    if (this.MyFlag.RunQuestStamp >= this.nowStamp())
      return;
    int mapId = this.Myself.MapID;
    int posX = 156;
    int posY = 202;
    int nvPosX = 0;
    int nvPosY = 0;
    int itemCode1 = 38001366;
    int num2 = 44203;
    int num3 = 891487;
    string quaiName1 = "Thủ Sơn Đồng";
    int itemCode2 = 38001372;
    int itemCode3 = 38001373;
    string quaiName2 = "Tây Lương Hà Thủ Ô";
    string quaiName3 = "Thủ Sơn Yêu Tiên";
    int menuTypeID1 = 891489;
    string quaiName4 = "Thủ Sơn Linh Tiên";
    int num4 = 891516;
    int num5 = 128 /*0x80*/;
    int num6 = 258;
    int menuTypeID2 = 891546;
    int num7 = 195;
    int num8 = 218;
    string quaiName5 = "Phụng Liên";
    int menuTypeID3 = 891507;
    int num9 = 891509;
    int itemCodeS = 38001367;
    int itemCodeE = 38001370;
    string quaiName6 = "Khuất Dung";
    int menuTypeID4 = 891512;
    switch (mapId)
    {
      case 575:
        itemCode1 = 38001400;
        num2 = 44327;
        num3 = 891575;
        quaiName1 = "Hoang Mộc Quỳnh Hoa";
        itemCode2 = 38001406;
        itemCode3 = 38001407;
        quaiName2 = "Thương Mộc Tiên Thảo";
        quaiName3 = "Thâu Dược Tiểu Tặc";
        menuTypeID1 = 891579;
        quaiName4 = "Thương Mộc Lão Tiên";
        num4 = 891581;
        menuTypeID2 = 891650;
        itemCodeS = 38001401;
        itemCodeE = 38001405;
        quaiName6 = "Kiến Mộc Tế Đài";
        menuTypeID4 = 891578;
        quaiName5 = "Lăng Cao Hiên";
        menuTypeID3 = 891570;
        num9 = 891572;
        break;
      case 576:
        itemCode1 = 38001410;
        num2 = 44349;
        num3 = 891595;
        quaiName1 = "Xà Lung";
        itemCode2 = 38001416;
        itemCode3 = 38001417;
        quaiName2 = "Nhược Thủy Băng Liên";
        quaiName3 = "Băng Liên Hoa Yêu";
        menuTypeID1 = 891599;
        quaiName4 = "Băng Liên Hoa Tiên";
        num4 = 891601;
        menuTypeID2 = 891651;
        itemCodeS = 38001411;
        itemCodeE = 38001415;
        quaiName6 = "Phá Băng Ngư Đường";
        menuTypeID4 = 891598;
        quaiName5 = "Doanh Cẩm Ly";
        menuTypeID3 = 891590;
        num9 = 891592;
        break;
      case 577:
        itemCode1 = 38001420;
        num2 = 44371;
        num3 = 891615;
        quaiName1 = "Phù Tang Hoa";
        itemCode2 = 38001426;
        itemCode3 = 38001427;
        quaiName2 = "Hỏa Diệm Hoa";
        quaiName3 = "Hỏa Diệm Hoa Yêu";
        menuTypeID1 = 891619;
        quaiName4 = "Hỏa Diệm Hoa Tiên";
        num4 = 891621;
        menuTypeID2 = 891652;
        itemCodeS = 38001421;
        itemCodeE = 38001425;
        quaiName6 = "Đại Thiết Lô";
        menuTypeID4 = 891618;
        quaiName5 = "Khương Tiểu Hoa";
        menuTypeID3 = 891610;
        num9 = 891612;
        break;
      case 578:
        itemCode1 = 38001430;
        num2 = 44393;
        num3 = 891635;
        quaiName1 = "Linh Tê Mộc";
        itemCode2 = 38001436;
        itemCode3 = 38001437;
        quaiName2 = "Ngọc Hoàng Dao Thảo";
        quaiName3 = "Ngọc Hoàng Yêu Tiên";
        menuTypeID1 = 891639;
        quaiName4 = "Ngọc Hoàng Dao Tiên";
        num4 = 891641;
        menuTypeID2 = 891653;
        itemCodeS = 38001432;
        itemCodeE = 38001435;
        quaiName6 = "Chú Kiếm Đài";
        menuTypeID4 = 891638;
        quaiName5 = "Cơ Minh Thần";
        menuTypeID3 = 891630;
        num9 = 891632;
        break;
    }
    if (this.isInDiaPhu())
    {
      this.CallMoveTo(12, 24);
    }
    else
    {
      if (this.Myself.QuestStep == 0)
      {
        if (!GA.isInChienMinh(this.Myself.MapID))
          this.GoToMyPos(posX, posY, 574);
        else if (this.GoToMyPos(posX, posY, mapId))
        {
          this.CallResetNhiemVuData();
          this.ResetEventString();
          this.ResetPacketMsg();
          Thread.Sleep(500);
          ++this.Myself.QuestStep;
        }
      }
      if (this.Myself.QuestStep == 1)
      {
        this.DoSomeThingDLL(6);
        Thread.Sleep(500);
        int num10 = this.InventorySearch(itemCode1, indexE: 30);
        if (num10 >= 0)
        {
          this.CallSetUpNhiemVuData(nvType: 1);
          this.Myself.NhiemVuItemIndex = num10;
        }
        else
        {
          int num11 = this.InventorySearch(itemCode2, indexE: 30);
          if (num11 >= 0)
          {
            this.CallSetUpNhiemVuData(nvType: 2);
            this.Myself.NhiemVuItemIndex = num11;
          }
          else
          {
            int num12 = this.InventorySearch(40005082, indexS: 60);
            if (num12 >= 0)
            {
              this.CallSetUpNhiemVuData(nvType: 3);
              this.Myself.NhiemVuItemIndex = num12;
            }
            else
            {
              int num13 = this.InventorySearchByRange(itemCodeS, itemCodeE, indexE: 30);
              if (num13 >= 0)
              {
                this.CallSetUpNhiemVuData(nvType: 4);
                this.Myself.NhiemVuItemIndex = num13;
              }
            }
          }
        }
        if (this.Myself.PacketMsg == "HQTB")
        {
          this.ResetPacketMsg();
          this.Myself.QuestStep = 0;
          GA.WriteUserLog("Đã hết Nhiệm vụ Thủ Bị Chiến Minh, dừng nhiệm vụ.", this);
          this.Myself.isThuBiChienMinh = false;
          this.IsAIEnabled = false;
        }
        else if (this.Myself.PacketMsg == "DNTB" && this.Myself.NhiemVuType == 0)
        {
          this.CallToggleMission();
          Thread.Sleep(1000);
          this.CallToggleMission();
          Thread.Sleep(1000);
          if (this.Myself.EventString == "VCTB")
            this.CallSetUpNhiemVuData(nvType: 5);
        }
        if (this.Myself.NhiemVuType > 0)
          ++this.Myself.QuestStep;
      }
      if (this.Myself.QuestStep == 2)
      {
        switch (this.Myself.NhiemVuType)
        {
          case 1:
            this.CallUseItem(this.Myself.NhiemVuItemIndex);
            num1 = 1000;
            break;
          case 2:
            if (this.Myself.ActionStatus != (byte) 6 && this.Myself.ActionStatus != (byte) 5)
            {
              this.CallUseItem(this.Myself.NhiemVuItemIndex);
              num1 = 1000;
              break;
            }
            break;
          case 3:
            nvPosX = num5;
            nvPosY = num6;
            break;
          case 4:
            nvPosX = 262;
            nvPosY = (int) byte.MaxValue;
            break;
          case 5:
            nvPosX = num7;
            nvPosY = num8;
            break;
        }
        if (nvPosX > 0 && nvPosY > 0)
          this.CallSetUpNhiemVuData(nvPosX, nvPosY);
        if (this.Myself.NhiemVuPosX > 0 && this.Myself.NhiemVuPosY > 0)
          ++this.Myself.QuestStep;
      }
      if (this.Myself.QuestStep == 3 && this.GoToMyPos(this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY, mapId))
      {
        Thread.Sleep(500);
        ++this.Myself.QuestStep;
      }
      if (this.Myself.QuestStep == 4)
      {
        switch (this.Myself.NhiemVuType)
        {
          case 1:
            if (this.Myself.ActionStatus != (byte) 6 && this.Myself.ActionStatus != (byte) 5)
            {
              this.CallUseItem(this.Myself.NhiemVuItemIndex);
              num1 = 1000;
              if (this.Myself.PacketMsg == "XQTB")
              {
                this.Myself.QuestStep = 10;
                break;
              }
              if (this.Myself.PacketMsg == "XHTGR")
              {
                int menuTypeID5 = num3;
                int menuIndex = 1;
                QuaiIndividual quaiIndividual1 = (QuaiIndividual) null;
                if (this.MyQuai.AllQuai.Count > 0)
                {
                  try
                  {
                    for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
                    {
                      quaiIndividual1 = this.MyQuai.AllQuai[index];
                      if (quaiIndividual1.IsBossValue == num2)
                        break;
                    }
                  }
                  catch (Exception ex)
                  {
                  }
                }
                if (quaiIndividual1 != null)
                {
                  this.CallTalkNPC(0, 0, quaiIndividual1.ID);
                  long num14 = this.nowStamp() + 2000L;
                  while (this.Myself.isQuestFrameShow == 0)
                  {
                    Thread.Sleep(200);
                    if (num14 < this.nowStamp())
                      break;
                  }
                  this.CallTalkNPC(menuTypeID5, menuIndex, quaiIndividual1.ID);
                }
                QuaiIndividual quaiIndividual2 = this.SearchQuaiByInput(quaiName1);
                if (quaiIndividual2 != null && quaiIndividual2.ID > 0)
                {
                  if (this.Myself.ActionStatus != (byte) 5 && this.Myself.ActionStatus != (byte) 6)
                    this.CallAttackTarget(quaiIndividual2.ID, 3, 0, 0);
                  num1 = 1000;
                  break;
                }
                break;
              }
              break;
            }
            break;
          case 2:
            this.CallXuongNgua();
            bool flag = true;
            QuaiIndividual quai1 = this.SearchQuaiByInput(quaiName3);
            if (quai1 != null && quai1.ID > 0)
            {
              if (this.CanAttack(quai1))
              {
                this.MyFlag.tempStamp = this.nowStamp() + 5000L;
                this.CallSelectTarget(quai1.ID);
                this.CallAttackTarget(quai1.ID, this.MySkills.AllSkills[0].ID, 0, 0);
              }
              else
                this.CallTalkNPCByPos(menuTypeID1, 1, this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY);
              flag = false;
            }
            QuaiIndividual quaiIndividual3 = this.SearchQuaiByInput(quaiName4);
            if (flag && quaiIndividual3 != null && quaiIndividual3.ID > 0)
            {
              int menuTypeID6 = num4;
              int menuIndex = 1;
              this.CallSelectTarget(quaiIndividual3.ID);
              this.CallTalkNPC(0, 0, quaiIndividual3.ID);
              long num15 = this.nowStamp() + 2000L;
              while (this.Myself.isQuestFrameShow == 0)
              {
                Thread.Sleep(200);
                if (num15 < this.nowStamp())
                  break;
              }
              this.CallTalkNPC(menuTypeID6, menuIndex, quaiIndividual3.ID);
              Thread.Sleep(2000);
              this.CallTalkNPC(menuTypeID6, 3, quaiIndividual3.ID);
              Thread.Sleep(2000);
              this.CallTalkNPC(menuTypeID6, 6, quaiIndividual3.ID);
              Thread.Sleep(2000);
              flag = false;
            }
            QuaiIndividual quaiIndividual4 = this.SearchQuaiByInput(quaiName2);
            if (flag && quaiIndividual4 != null && quaiIndividual4.ID > 0)
            {
              if (this.Myself.ActionStatus != (byte) 5 && this.Myself.ActionStatus != (byte) 8)
              {
                this.CallAttackTarget(quaiIndividual4.ID, 3, 0, 0);
                if (this.MyFlag.VuotQuaPhamViCount >= 2)
                {
                  Random random = new Random();
                  this.CallMoveTo((int) this.Myself.PosX + random.Next(-2, 2), (int) this.Myself.PosY + random.Next(-2, 2));
                }
              }
              num1 = 1000;
              flag = false;
            }
            if (flag)
            {
              if (this.Myself.PacketMsg == "XQTB")
              {
                this.Myself.QuestStep = 10;
                break;
              }
              if (this.Myself.BocShow == 1)
              {
                this.CallPickAllItems();
                Thread.Sleep(300);
              }
              if (this.Myself.ActionStatus != (byte) 6 && this.Myself.ActionStatus != (byte) 5)
              {
                int itemIndex = this.InventorySearch(itemCode3, indexE: 30);
                if (itemIndex >= 0)
                {
                  this.CallUseItem(itemIndex);
                  break;
                }
                break;
              }
              break;
            }
            break;
          case 3:
            QuaiIndividual quai2 = this.SearchQuaiByInput("Mật Thám", attack: true, exactly: false);
            if (quai2 != null && quai2.ID > 0)
            {
              if (this.CanAttack(quai2))
              {
                this.CallXuongNgua();
                this.MyFlag.tempStamp = this.nowStamp() + 5000L;
                this.CallSelectTarget(quai2.ID);
                this.CallAttackTarget(quai2.ID, this.MySkills.AllSkills[0].ID, 0, 0);
                break;
              }
              break;
            }
            if (this.MyFlag.tempStamp > this.nowStamp())
            {
              this.Myself.QuestStep = 10;
              break;
            }
            this.CallTalkNPCByPos(menuTypeID2, 1, this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY);
            break;
          case 4:
            if (this.Myself.PacketMsg == "XQTB")
            {
              this.Myself.QuestStep = 10;
              break;
            }
            if (this.Myself.PacketMsg == "DDTV")
            {
              int num16 = 243;
              int num17 = 254;
              if (this.GoToMyPos(num16, num17, mapId))
              {
                this.CallTalkNPCByPos(menuTypeID4, 1, num16, num17);
                break;
              }
              break;
            }
            QuaiIndividual quaiIndividual5 = this.SearchQuaiByInput(quaiName6);
            if (quaiIndividual5 != null && quaiIndividual5.ID > 0)
            {
              this.CallXuongNgua();
              if (this.Myself.PacketMsg != "")
              {
                int result = 0;
                int.TryParse(this.Myself.PacketMsg, out result);
                int itemIndex = -1;
                if (result > 0)
                  itemIndex = this.InventorySearch(result, indexE: 30);
                if (itemIndex >= 0)
                  this.CallUseItem(itemIndex, quaiIndividual5.ID);
                else
                  this.CallUseItem(this.Myself.NhiemVuItemIndex, quaiIndividual5.ID);
              }
              if (this.Myself.PacketMsg == "")
                this.CallUseItem(this.Myself.NhiemVuItemIndex, quaiIndividual5.ID);
              num1 = 400;
              break;
            }
            break;
          case 5:
            if (this.Myself.PacketMsg == "XQTB")
              this.Myself.QuestStep = 10;
            if (this.GoToMyPos(this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY, mapId))
            {
              QuaiIndividual quai3 = this.SearchQuaiByInput("Lôi Tuyệt", exactly: false) ?? this.SearchQuaiByInput("Tà Đạo", exactly: false);
              if (quai3 != null && quai3.ID > 0)
              {
                this.CallXuongNgua();
                if (this.CanAttack(quai3))
                {
                  this.MyFlag.tempStamp = this.nowStamp() + 5000L;
                  this.CallSelectTarget(quai3.ID);
                  this.CallAttackTarget(quai3.ID, this.MySkills.AllSkills[0].ID, 0, 0);
                }
                else
                {
                  int menuTypeID7 = num9;
                  int menuIndex = 1;
                  this.CallSelectTarget(quai3.ID);
                  this.CallTalkNPC(0, 0, quai3.ID);
                  long num18 = this.nowStamp() + 2000L;
                  while (this.Myself.isQuestFrameShow == 0)
                  {
                    Thread.Sleep(200);
                    if (num18 < this.nowStamp())
                      break;
                  }
                  this.CallTalkNPC(menuTypeID7, menuIndex, quai3.ID);
                }
              }
              QuaiIndividual quaiIndividual6 = this.SearchQuaiByInput(quaiName5);
              if (quaiIndividual6 != null && quaiIndividual6.ID > 0)
              {
                this.CallXuongNgua();
                this.CallTalkNPCByPos(menuTypeID3, 2, this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY);
                num1 = 1000;
                break;
              }
              break;
            }
            break;
        }
      }
      int questStep = this.Myself.QuestStep;
      if (this.Myself.QuestStep == 10 && this.GoToMyPos(posX, posY, mapId))
      {
        this.DoSomeThingDLL(7);
        if (this.Myself.EventString == "TBTC" || this.CalcTimeOut(5000))
          this.Myself.QuestStep = 0;
      }
      this.MyFlag.RunQuestStamp = this.nowStamp() + (long) num1;
    }
  }

  public void NhiemVuNhanLeBao()
  {
    if (this.MyFlag.RunQuestStamp >= this.nowStamp())
      return;
    this.MyFlag.RunQuestStamp = this.nowStamp() + 1000L;
    int posX = 172;
    int posY = 122;
    int mapID = 2;
    int NPCID = 153;
    int menuTypeID = 889052;
    int menuIndex = 1;
    if (!this.GoToMyPos(posX, posY, mapID))
      return;
    this.CallTalkNPC(0, 0, NPCID);
    Thread.Sleep(1000);
    this.CallTalkNPC(menuTypeID, menuIndex, NPCID);
    Thread.Sleep(2000);
    this.CallTalkNPC(menuTypeID, 2, NPCID);
    Thread.Sleep(2000);
    this.Myself.isNhanLeBao = false;
    this.IsAIEnabled = false;
    this.ResetPacketMsg();
  }

  public void NhiemVuNhanBongCauPhuc()
  {
    if (this.MyFlag.RunQuestStamp >= this.nowStamp())
      return;
    this.MyFlag.RunQuestStamp = this.nowStamp() + 1000L;
    int posX = 182;
    int posY = 197;
    int mapID = 2;
    int NPCID = 178;
    int menuTypeID = 50225;
    if (!this.GoToMyPos(posX, posY, mapID))
      return;
    this.CallTalkNPC(0, 0, NPCID);
    Thread.Sleep(1000);
    this.CallTalkNPC(menuTypeID, 1, NPCID);
    Thread.Sleep(2000);
    this.CallTalkNPC(menuTypeID, 2, NPCID);
    Thread.Sleep(2000);
    this.CallTalkNPC(menuTypeID, 3, NPCID);
    Thread.Sleep(2000);
    this.Myself.isNhanBongCauPhuc = false;
    this.IsAIEnabled = false;
    this.ResetPacketMsg();
  }

  public AutoAccount()
  {
    this.MyFlag = new MyFlagClass(this);
    this.Target = new TargetProcess(this);
    this.InitializeMethods();
  }

  public void InitializeMethods()
  {
    this.Settings.AutoPartyList.OnAdd += new EventHandler(this.AutoPartyList_OnAdd);
    this.Settings.AutoPartyList.OnRemove += new EventHandler(this.AutoPartyList_OnRemove);
    this.Settings.ListItemNhatIgnore.OnAdd += new EventHandler(this.ListItemNhatIgnore_OnAdd);
    this.Settings.ListItemNhatIgnore.OnRemove += new EventHandler(this.ListItemNhatIgnore_OnRemove);
    this.Settings.QuaiNoAttackList.OnAdd += new EventHandler(this.QuaiNoAttackList_OnAdd);
    this.Settings.QuaiNoAttackList.OnRemove += new EventHandler(this.QuaiNoAttackList_OnRemove);
    this.Settings.PTBlacklist.OnAdd += new EventHandler(this.PTBlacklist_OnAdd);
    this.Settings.PTBlacklist.OnRemove += new EventHandler(this.PTBlacklist_OnRemove);
    this.Settings.SkillPlayList.OnAdd += new EventHandler(this.SkillPlayList_OnAdd);
    this.Settings.SkillPlayList.OnRemove += new EventHandler(this.SkillPlayList_OnRemove);
    this.Settings.ListItemToBuy.OnAdd += new EventHandler(this.ListItemToBuy_OnAdd);
    this.Settings.ListItemToBuy.OnRemove += new EventHandler(this.ListItemToBuy_OnRemove);
    this.Settings.ListItemToUse.OnAdd += new EventHandler(this.ListItemToUse_OnAdd);
    this.Settings.ListItemToUse.OnRemove += new EventHandler(this.ListItemToUse_OnRemove);
    this.Settings.SkillPKList.OnAdd += new EventHandler(this.SkillPKList_OnAdd);
    this.Settings.SkillPKList.OnRemove += new EventHandler(this.SkillPKList_OnRemove);
    this.Settings.SkillBuffList.OnAdd += new EventHandler(this.SkillBuffList_OnAdd);
    this.Settings.SkillBuffList.OnRemove += new EventHandler(this.SkillBuffList_OnRemove);
    this.Settings.ListScheduler.OnAdd += new EventHandler(this.ListScheduler_OnAdd);
    this.Settings.ListScheduler.OnRemove += new EventHandler(this.ListScheduler_OnRemove);
    this.Settings.PKPlayerList.OnAdd += new EventHandler(this.PKPlayerList_OnAdd);
    this.Settings.PKPlayerList.OnRemove += new EventHandler(this.PKPlayerList_OnRemove);
    this.Settings.PKBlackList.OnAdd += new EventHandler(this.PKBlackList_OnAdd);
    this.Settings.PKBlackList.OnRemove += new EventHandler(this.PKBlackList_OnRemove);
    this.Settings.PKBangList.OnAdd += new EventHandler(this.PKBangList_OnAdd);
    this.Settings.PKBangList.OnRemove += new EventHandler(this.PKBangList_OnRemove);
    this.GCTimeStamp.Start();
    for (int index = 0; index < 12; ++index)
      this.TNNPCShopInstance.Add(new TNNPCShopItem());
  }

  public bool IsLicensed { get; set; }

  public bool IsAIEnabled
  {
    get => this._isAIEnabled;
    set
    {
      if (this._isAIEnabled == value)
        return;
      this._isAIEnabled = value;
      try
      {
        if (this.AutoProfile != null)
          this.AutoProfile.AIEnabled = value;
      }
      catch (Exception ex)
      {
      }
      this.OnPropertyChanged(nameof (IsAIEnabled));
    }
  }

  public bool IsMainDisplayed { get; set; }

  public string Email { get; set; }

  public string LoginID { get; set; }

  public SecureString Password { get; set; }

  public string SystemID { get; set; }

  public void AIThreadFunction()
  {
    if (this == null)
      return;
    while (this.Settings.AIWhileLoop)
    {
      if (!this.Target.CyberBlacklisted)
      {
        try
        {
          if (this.Target.HasActiveProfile && this.Myself.MaxHP > 0 && this.Myself.Name != "" && !this.Target.GLoginAttached && !this.Target.GLoginAIReady)
            this.Target.GLoginAIReady = true;
          if (!this.Target.GLoginAIReady && !this.Target.HasActiveProfile && this.Myself.MaxHP > 0 && this.Myself.Name != "" && !this.Target.GLoginAttached)
            this.Target.GLoginAIReady = true;
          if (this.IsLicensed)
          {
            if (!this.Target.TempRemoved)
            {
              if (!this.Target.IsReset)
              {
                if (this.Target.CyberStamp > 0L)
                  AutoAccount.CreatePseudo(this);
                // hoint: no need to update Name to "Bouya"
                //if (!(this.Myself.Name == "GAutoPR"))
                //  this.Myself.Name = "Bouya";
                if (this.MyFlag.IsInGame && this.Target.GLoginAIReady)
                {
                  if (this.Myself.StartingStamp == 0L)
                    this.Myself.StartingStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                  if (this.Myself.Name != "")
                  {
                    if ((frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.PMStamp >= 5000L || this.MyFlag.PMStamp == 0L) && GA.isVipMember() && frmLogin.CompilingLanguage == "CN" && this.Settings.cboxVIPPM && (this.Target.VersionNum == 7 || this.Target.VersionNum == 8))
                    {
                      if (!this.MyFlag.IsBlockedChat)
                      {
                        try
                        {
                          if (this.Myself.PlayerAroundList.Count > 0)
                          {
                            for (int index = this.Myself.PlayerAroundList.Count - 1; index >= 0; --index)
                            {
                              if ((this.Myself.PlayerAroundList[index].LastPM == 0L || this.Myself.PlayerAroundList[index].LastPM != 0L) && this.Myself.PlayerAroundList[index].Name != "")
                              {
                                ++this.MyFlag.SpamCount;
                                this.Myself.PlayerAroundList[index].LastPM = frmLogin.GlobalTimer.ElapsedMilliseconds;
                                this.CallSendAdsPM(this.Myself.PlayerAroundList[index].Name, GA.GenerateRandomName(5) + this.Settings.AutoChatContent + GA.GenerateRandomName(5));
                                this.MyFlag.PMStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                                GA.WriteUserLog($"Đã rao {this.MyFlag.SpamCount.ToString()} to {this.Myself.PlayerAroundList[index].Name}", this);
                                break;
                              }
                            }
                          }
                        }
                        catch (Exception ex)
                        {
                        }
                      }
                    }
                    if (GA.isVipMember() && this.IsAIEnabled)
                    {
                      int num = this.Settings.cboxTNRunOnly ? 1 : 0;
                    }
                    if (this.MyFlag.JustNewAccount && !this.firstGame)
                    {
                      GADB.LoadAllSettings(this);
                      this.Settings.AllInformationLoaded = true;
                      this.MyPet.AllInformationLoaded = true;
                      try
                      {
                        this.MyFlag.JustNewAccount = false;
                      }
                      catch (Exception ex)
                      {
                      }
                    }
                  }
                  if (this.Myself.Level >= 10 && this.Myself.Menpai == AllEnums.Menpais.NOMENPAI)
                    this.Myself.Initialized = true;
                  if (!this.Myself.ReadyToAttack && this.Myself.ResetTimeStamp.ElapsedMilliseconds >= 5000L)
                  {
                    this.Myself.ResetTimeStamp.Reset();
                    this.Myself.ResetTimeStamp.Start();
                    this.Myself.ReadyToAttack = true;
                  }
                  if (this.Myself.Level == 0 && this.Myself.TransitioningStamp.ElapsedMilliseconds == 0L)
                    this.Myself.TransitioningStamp.Start();
                  if (this.Myself.prevNotTransitioning == 1 && this.Myself.isSceneTrans <= 0)
                  {
                    Thread.Sleep(2000);
                    this.Myself.prevNotTransitioning = 0;
                  }
                  if (this.Myself.ActionStatus >= (byte) 5 && this.Myself.ActionStatus <= (byte) 8)
                  {
                    this.Myself.LastPostStamp.Reset();
                    this.Myself.LastPostStamp.Start();
                  }
                  if (this.Myself.isSceneTrans == 1)
                  {
                    this.Myself.LastPostStamp.Reset();
                    this.Myself.LastPostStamp.Start();
                    lock (this.Myself.JustWarpedLock)
                    {
                      this.Myself.WarpStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                      this.Myself.JustWarped = true;
                      this.Myself.JustWarpedStamp.Reset();
                      this.Myself.JustWarpedStamp.Start();
                      this.SetJustWarpedFlag(1);
                    }
                  }
                  this.ResetJustWarped();
                  if (this.MyFlag.actionAI == 1)
                  {
                    this.MyFlag.ToaDoTrongHoaList.Clear();
                    this.MyFlag.TrongHoaListMax = (frmLogin.GAuto.Settings.soHangTrongHoa - 1) * 6;
                    this.MyFlag.TrongHoaFirstMove = false;
                    this.MyFlag.actionAI = 0;
                  }
                  if (!this.Myself.JustWarped && this.Myself.MapID != -1 && this.Myself.ID > 0)
                  {
                    if (this.Target.VersionNum == 3 && this.Myself.isMuaDoTrain)
                    {
                      this.BuyListItemKNB();
                      this.Myself.isMuaDoTrain = false;
                    }
                    if (this.Myself.isBanDoChoNPC)
                    {
                      if (!this.IsAIEnabled)
                        this.Myself.isBanDoChoNPC = false;
                      this.BanDoChoNPC();
                    }
                    if (this.Myself.IsPartyFollowed == (byte) 1 && !this.IsPartyKey())
                    {
                      this.Myself.Status = AllEnums.CharStatuses.IDLE;
                      this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
                      this.Myself.MinorStatus2 = AllEnums.CharStatuses.IDLE;
                      this.Myself.MinorStatus = AllEnums.CharStatuses.IDLE;
                      this.Myself.TargetX = 0.0f;
                      this.Myself.TargetY = 0.0f;
                      this.Myself.TargetMapID = -1;
                      this.Myself.MoveLongTrigger = false;
                      this.Myself.SavedPosX = 0.0f;
                      this.Myself.SavedPosY = 0.0f;
                      this.Myself.SavedMapID = -1;
                      this.Myself.LongMoveX = 0;
                      this.Myself.LongMoveY = 0;
                      this.Myself.LongMoveMapID = -1;
                      this.Myself.MoveAcrossMap = false;
                      this.Myself.UseAutoMove = false;
                      this.Myself.MoveFlashPos = false;
                      this.Myself.IsPK = false;
                      this.Myself.IsLongMove = false;
                      this.Myself.CurrentTarget = (QuaiIndividual) null;
                      this.Myself.CurrentTargetID = -1;
                      this.ResetXYnow();
                    }
                    if (this.Myself.PartyKeyLock && this.MyFlag.StartReconnectStamp < this.nowStamp())
                    {
                      if (this.IsPartyKeyInt() == 1)
                        GA.PartyGiveKeyToMe(this);
                      if (this.IsPartyKeyInt() == 2)
                        this.Myself.PartyKeyLock = false;
                    }
                    if (this.Myself.IDLEStamp - frmLogin.GlobalTimer.ElapsedMilliseconds <= 0L)
                    {
                      if (frmLogin.GAuto.Settings.IsPro1)
                      {
                        if (this.MyParty.PartyNumbers == 0 && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.PTInviteStamp >= 300L)
                        {
                          this.Myself.PTInviteStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                          if (this.MyParty.InviterDB != 0 && this.MyParty.Name != "")
                          {
                            bool flag = false;
                            if (frmLogin.GAuto.AllAutoAccounts.Count > 1)
                            {
                              try
                              {
                                for (int index = frmLogin.GAuto.AllAutoAccounts.Count - 1; index >= 0; --index)
                                {
                                  if (frmLogin.GAuto.AllAutoAccounts[index].Myself.Name == this.MyParty.Name)
                                  {
                                    flag = true;
                                    break;
                                  }
                                }
                              }
                              catch (Exception ex)
                              {
                              }
                            }
                            bool blacklist = false;
                            if (this.Settings.PTBlacklist.Contains(this.MyParty.Name))
                            {
                              blacklist = true;
                              this.CallDenyPartyInvite(blacklist);
                            }
                            if (!blacklist)
                            {
                              if (this.Settings.cboxPTLevel && this.MyParty.InviterLevel >= this.Settings.numPTLevel)
                                flag = true;
                              if (!flag && this.Settings.cboxTuVaoPT && this.Settings.AutoPartyList.Count > 0 && this.Settings.AutoPartyList.Contains(this.MyParty.Name))
                                flag = true;
                              if (flag)
                              {
                                GA.WriteUserLog(frmMain.langAcceptPTMsg, this, (object) this.MyParty.Name, (object) this.MyParty.InviterLevel);
                                this.CallAcceptPartyInvite(this.MyParty.InviterDB);
                              }
                              else if (this.Target.VersionNum != 3 && this.Target.VersionNum != 4 && (this.Settings.cboxPTLevel || this.Settings.cboxTuVaoPT || this.Settings.cboxPTChoVao))
                              {
                                GA.WriteUserLog(frmMain.langDenyPTMsg, this, (object) this.MyParty.Name, (object) this.MyParty.InviterLevel);
                                this.CallDenyPartyInvite();
                              }
                            }
                          }
                        }
                        if (this.Myself.CaptchaAlerted)
                        {
                          if (this.Myself.CaptchaAlertStamp.ElapsedMilliseconds >= 10000L)
                            this.Myself.CaptchaGUI = false;
                          if (this.Myself.CaptchaAlertStamp.ElapsedMilliseconds >= 70000L)
                            this.Myself.CaptchaAlerted = false;
                        }
                        if (!this.ProcessCaptcha())
                        {
                          if (this.Myself.PKAlerted && this.Myself.PKAlertStamp.ElapsedMilliseconds >= 10000L)
                            this.Myself.PKAlerted = false;
                          if (this.Myself.IsAttacked == 1 && !this.Myself.PKAlerted)
                          {
                            this.Myself.PKAlertStamp.Reset();
                            this.Myself.PKAlertStamp.Start();
                            this.Myself.PKAlerted = true;
                            this.Myself.IsPK = true;
                            this.Myself.LastPKStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                            if (this.Settings.cboxTNAlertPK)
                            {
                              try
                              {
                                new SoundPlayer("pk.wav").Play();
                              }
                              catch (Exception ex)
                              {
                              }
                            }
                            PlayerIndividual playerIndividual = (PlayerIndividual) null;
                            double num = 999.0;
                            for (int index1 = 0; index1 < 30; ++index1)
                            {
                              int green = this.Myself.GreenList[index1];
                              if (green != -1)
                              {
                                if (this.MyPlayers.AllPlayers.Count > 0)
                                {
                                  try
                                  {
                                    for (int index2 = this.MyPlayers.AllPlayers.Count - 1; index2 >= 0; --index2)
                                    {
                                      PlayerIndividual allPlayer = this.MyPlayers.AllPlayers[index2];
                                      int databaseId = allPlayer.DatabaseID;
                                      if (databaseId == green && databaseId > 0 && (double) allPlayer.HPPercent > 0.0)
                                      {
                                        playerIndividual = allPlayer;
                                        break;
                                      }
                                    }
                                  }
                                  catch (Exception ex)
                                  {
                                  }
                                }
                                if (playerIndividual != null && playerIndividual.MapID == this.Myself.MapID && (double) playerIndividual.PosX != 0.0 && (double) playerIndividual.PosY != 0.0)
                                {
                                  GA.ShowBalloon(playerIndividual.Name + frmMain.langIsAttackingYou, frmMain.langUnderPK, this, 600000);
                                  if (playerIndividual.Name != this.MyFlag.PlayerPKMe)
                                  {
                                    this.MyFlag.PlayerPKMe = playerIndividual.Name;
                                    GA.WriteUserLog(playerIndividual.Name + frmMain.langIsAttackingYou, this);
                                  }
                                  double distance = GA.CalculateDistance((double) playerIndividual.PosX, (double) playerIndividual.PosY, (double) this.Myself.PosX, (double) this.Myself.PosY);
                                  if (distance < num)
                                  {
                                    num = distance;
                                    playerIndividual = (PlayerIndividual) null;
                                  }
                                }
                              }
                            }
                          }
                        }
                        else
                          goto label_1076;
                      }
                      if (this.Myself.CanNhatBocStamp > 0L && !this.Myself.CanNhatBoc && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.CanNhatBocStamp >= (long) (this.Settings.numFullThung * 60000))
                      {
                        this.Myself.CanNhatBoc = true;
                        this.Myself.CanNhatBocStamp = 0L;
                      }
                      if (this.Myself.FlagFullBoc && this.Settings.cboxFullStopNhat)
                      {
                        this.Myself.CanNhatBoc = false;
                        this.Myself.CanNhatBocStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                      }
                      if ((this.Settings.cboxHelpChat || frmLogin.GAuto.Settings.AppMode == AllEnums.AutoModes.Lite) && this.Myself.HPPercent > 0.0 && !this.Myself.JustWarped && this.Myself.Name != "" && !frmLogin.GAuto.Settings.IsPro1 && frmLogin.GAuto.Settings.QuangCaoContent.Count > 0 && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.ChatQuangCaoStamp >= (long) (frmLogin.GAuto.Settings.ChatQuangCaoDelay + this.Myself.ChatQuangCaoDelayDelta))
                      {
                        this.Myself.ChatQuangCaoStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                        this.Myself.AutoChatStamp.Reset();
                        this.Myself.AutoChatStamp.Start();
                        List<int> intList = new List<int>();
                        if (frmLogin.GAuto.Settings.QuangCaoContent.Count > 0)
                        {
                          for (int index = 0; index < frmLogin.GAuto.Settings.QuangCaoContent.Count; ++index)
                          {
                            if (this.Target.VersionNum == frmLogin.GAuto.Settings.QuangCaoContent[index].VersionNum && this.Target.SubVersion == frmLogin.GAuto.Settings.QuangCaoContent[index].SubVersion)
                              intList.Add(index);
                          }
                          if (intList.Count == 0)
                          {
                            for (int index = 0; index < frmLogin.GAuto.Settings.QuangCaoContent.Count; ++index)
                            {
                              if (this.Target.VersionNum == frmLogin.GAuto.Settings.QuangCaoContent[index].VersionNum && frmLogin.GAuto.Settings.QuangCaoContent[index].SubVersion == 0)
                                intList.Add(index);
                            }
                          }
                        }
                        if (intList.Count > 0)
                        {
                          int index = frmLogin.random.Next(0, intList.Count);
                          try
                          {
                            if (intList[index] < frmLogin.GAuto.Settings.QuangCaoContent.Count)
                              this.CallSendMessage(2, GA.ConvertToVISCII(frmLogin.GAuto.Settings.QuangCaoContent[intList[index]].Message, this.Target.VersionNum));
                          }
                          catch (Exception ex)
                          {
                          }
                        }
                      }
                      if (this.Settings.cboxAutoChat && this.Myself.HPPercent > 0.0 && !this.Myself.JustWarped)
                      {
                        bool flag1 = false;
                        if (string.IsNullOrEmpty(this.Settings.AutoChatContent) && !frmLogin.GAuto.Settings.IsPro1 && !this.Settings.cboxChatSavedMsg)
                        {
                          List<int> intList = new List<int>();
                          if (frmLogin.GAuto.Settings.QuangCaoContent.Count > 0)
                          {
                            for (int index = 0; index < frmLogin.GAuto.Settings.QuangCaoContent.Count; ++index)
                            {
                              if (frmLogin.GAuto.Settings.QuangCaoContent[index].VersionNum == 3 && this.Target.VersionNum == 3 && this.Target.SubVersion != 4 && this.Target.SubVersion != 5 || frmLogin.GAuto.Settings.QuangCaoContent[index].VersionNum != 3 && this.Target.VersionNum != 3)
                                intList.Add(index);
                            }
                          }
                          if (intList.Count > 0)
                          {
                            try
                            {
                              int index = frmLogin.random.Next(0, intList.Count);
                              if (intList[index] < frmLogin.GAuto.Settings.QuangCaoContent.Count)
                                this.Settings.AutoChatContent = frmLogin.GAuto.Settings.QuangCaoContent[intList[index]].Message;
                            }
                            catch (Exception ex)
                            {
                            }
                          }
                          this.Settings.cboKenhChat = 2;
                          flag1 = true;
                        }
                        bool flag2 = false;
                        if (this.MyFlag.ChatRecorded && this.Myself.ChatRecordedMessage != "")
                          flag2 = true;
                        if (!string.IsNullOrEmpty(this.Settings.AutoChatContent) || flag2 && this.Settings.cboxChatSavedMsg)
                        {
                          this.Myself.RemainingChatTime = (long) (this.Settings.numAutoChat * 1000) - this.Myself.AutoChatStamp.ElapsedMilliseconds;
                          if (this.Myself.RemainingChatTime <= 0L || this.Myself.ChatTimes == 0)
                          {
                            ++this.Myself.ChatTimes;
                            this.Myself.AutoChatStamp.Reset();
                            this.Myself.AutoChatStamp.Start();
                            bool userSend = frmLogin.GAuto.Settings.AppMode == AllEnums.AutoModes.Lite;
                            if (this.Settings.cboxChatSavedMsg && flag2)
                            {
                              this.CallSendSavedChat();
                            }
                            else
                            {
                              this.CallSendMessage(this.Settings.cboKenhChat, GA.ConvertToVISCII(this.Settings.AutoChatContent, this.Target.VersionNum), userSend);
                              if (flag1)
                                this.Settings.AutoChatContent = "";
                            }
                          }
                        }
                      }
                      for (int index = 1; index < this.MySkills.AllSkills.Count; ++index)
                      {
                        SingleSkill allSkill = this.MySkills.AllSkills[index];
                        if (allSkill.RemainWaitingTime > 0)
                        {
                          allSkill.RemainWaitingTime -= this.Target.ThreadDelay;
                          if (allSkill.RemainWaitingTime < 0)
                            allSkill.RemainWaitingTime = 0;
                        }
                      }
                      if (this.Myself.CheckSkillDelayStamp.ElapsedMilliseconds >= 1500L)
                      {
                        foreach (SkillPlayItem skillPlay in (List<SkillPlayItem>) this.Settings.SkillPlayList)
                        {
                          if (frmLogin.GlobalTimer.ElapsedMilliseconds - skillPlay.LastPlayTimeStamp >= (long) (skillPlay.SkillDelayInSecond * 1000) && skillPlay.Played)
                            skillPlay.Played = false;
                        }
                        foreach (SkillPlayItem skillPk in (List<SkillPlayItem>) this.Settings.SkillPKList)
                        {
                          if (frmLogin.GlobalTimer.ElapsedMilliseconds - skillPk.LastPlayTimeStamp >= (long) (skillPk.SkillDelayInSecond * 1000) && skillPk.Played)
                            skillPk.Played = false;
                        }
                        try
                        {
                          foreach (SkillPlayItem skillBuff in (List<SkillPlayItem>) this.Settings.SkillBuffList)
                          {
                            if (frmLogin.GlobalTimer.ElapsedMilliseconds - skillBuff.LastPlayTimeStamp >= (long) (skillBuff.SkillDelayInSecond * 1000))
                            {
                              skillBuff.Played = false;
                              if (skillBuff.BuffPlayerList.Count > 0)
                              {
                                for (int index = skillBuff.BuffPlayerList.Count - 1; index >= 0; --index)
                                {
                                  BuffedPlayer buffPlayer = skillBuff.BuffPlayerList[index];
                                  if (frmLogin.GlobalTimer.ElapsedMilliseconds - buffPlayer.LastBuffTime >= (long) (skillBuff.WaitingTime * 60000))
                                    skillBuff.BuffPlayerList.RemoveAt(index);
                                }
                              }
                            }
                          }
                        }
                        catch (Exception ex)
                        {
                          GA.WriteUserLog(frmMain.langErrorPlayingSkills, this);
                        }
                        this.Myself.CheckSkillDelayStamp.Reset();
                        this.Myself.CheckSkillDelayStamp.Start();
                      }
                      if (this.Myself.Pass2BoxShow == 1 && frmLogin.GAuto.Settings.IsPro2)
                        this.CallMoPass2();
                      // hoint: update Name = SaveDisplayName
                      this.Myself.Name = this.Myself.SavedDisplayName;
                      if (this.IsAIEnabled && this.Myself.ID > 0)
                      {
                        this.NhanQuaGame();
                        if (this.Myself.isAcceptBox == 1)
                          this.CallSendPortalConfirmationClick();
                        if (this.Myself.isMessageBox_Self == 1 && !this.Myself.IsMuaKNB)
                        {
                          bool flag = false;
                          int ToX = 65;
                          int ToY = 270;
                          if (GA.ClientVersion(this) == 10)
                          {
                            ToX = 32 /*0x20*/;
                            ToY = 162;
                          }
                          if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) ToX, (double) ToY) < 8.0)
                            flag = true;
                          if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, 283.0, 77.0) < 8.0)
                            flag = true;
                          if (GA.IsBangMapID(this.Myself.MapID) && GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, 99.0, 157.0) < 8.0)
                            flag = true;
                          if (flag || this.Settings.cboxTuClickYes2 || this.MyFlag.ClickYesStamp > frmLogin.GlobalTimer.ElapsedMilliseconds)
                          {
                            this.CallStartAutoMoveClick();
                            Thread.Sleep(500);
                          }
                        }
                        if (this.MyFlag.AIAction == 1)
                        {
                          long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
                          int posX = (int) this.Myself.PosX;
                          int posY = (int) this.Myself.PosY;
                          while (this.IsAIEnabled)
                          {
                            Random random = new Random();
                            this.CallMoveTo((int) this.Myself.PosX + random.Next(-2, 2), (int) this.Myself.PosY + random.Next(-2, 2));
                            Thread.Sleep(280);
                            if (posX != (int) this.Myself.PosX || posY != (int) this.Myself.PosY || this.nowStamp() - elapsedMilliseconds > 1200L)
                              break;
                          }
                          this.AIActionSet(0);
                        }
                      }
                      this.PhucHoiSkillNM();
                      if (!this.Myself.IsLuyenKim)
                        this.FuncPetSupport();
                      if (!this.Myself.IsLuyenKim)
                        this.FuncAnHPMP();
                      if (this.Myself.Status != AllEnums.CharStatuses.NMBUFFMAU && this.Myself.ActionStatus != (byte) 5 && this.Myself.ActionStatus != (byte) 6 && this.Myself.IsPartyFollowed == (byte) 0)
                      {
                        this.NhatBoc();
                        if (this.Settings.cboxNhatHop && frmLogin.GAuto.Settings.IsPro1)
                          this.DiTimBauVat(799);
                      }
                      if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.NhatHopBaoRuongStamp > 150000L && this.Settings.cboxNhatHop && !GA.isVipMember())
                      {
                        this.Settings.cboxNhatHop = false;
                        GA.WriteUserLog(frmMain.langTurnOffPickingBoxes, this);
                      }
                      this.FuncHuyItem();
                      if (frmLogin.GAuto.Settings.IsPro2 && !this.Myself.JustWarped)
                      {
                        if (!this.IsInCity() && (this.Myself.Status == AllEnums.CharStatuses.LENLAIBAITRAIN || this.Myself.Status == AllEnums.CharStatuses.SELLING_NPC || this.Myself.Status == AllEnums.CharStatuses.BUYING_NPC) && this.Myself.IsPartyFollowed == (byte) 0)
                        {
                          this.Myself.Status = AllEnums.CharStatuses.IDLE;
                          this.Myself.SavedStatus = AllEnums.CharStatuses.IDLE;
                        }
                        if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.CleanUpInventoryStamp >= 3000L && this.Settings.cboxVutDoKhiFull && !this.Myself.JustWarped && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.StartingStamp >= 5000L && this.Myself.StartingStamp != 0L)
                        {
                          this.Myself.CleanUpInventoryStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                          this.CleanUpInventory();
                        }
                      }
                      if (this.MyParty.PartyNumbers > 0 && frmLogin.GAuto.Settings.IsPro2)
                      {
                        if (this.Myself.FlagPartyFollowRequest == (byte) 1 && this.Myself.IsPartyFollowed == (byte) 0 && this.Settings.cboxTuTheoDoi && this.IsAIEnabled)
                        {
                          if (this.Settings.PartySavedPosX == 0 && this.Settings.PartySavedPosY == 0 && this.Settings.PartySavedMapID == -1)
                          {
                            this.Settings.PartySavedPosX = (int) this.Settings.CenterX;
                            this.Settings.PartySavedPosY = (int) this.Settings.CenterY;
                            this.Settings.PartySavedMapID = this.Settings.MapID;
                          }
                          this.CallAcceptPartyFollowClick();
                          Thread.Sleep(1000);
                        }
                        if (this.Myself.IsPartyFollowed == (byte) 0 && this.Myself.PreviousIsPartyFollowed != (int) this.Myself.IsPartyFollowed && this.MyParty.PartyNumbers > 0)
                        {
                          PartyMember allMember = this.MyParty.AllMembers[0];
                        }
                      }
                      if (this.MyParty.PartyNumbers <= 0 && this.Settings.PartySavedPosX != 0 && this.Settings.PartySavedPosY != 0 && this.Settings.PartySavedMapID > 0)
                      {
                        this.Settings.CenterX = (double) this.Settings.PartySavedPosX;
                        this.Settings.CenterY = (double) this.Settings.PartySavedPosY;
                        this.Settings.MapID = this.Settings.PartySavedMapID;
                        this.Settings.PartySavedPosX = 0;
                        this.Settings.PartySavedPosY = 0;
                        this.Settings.PartySavedMapID = -1;
                      }
                      if (frmLogin.GAuto.Settings.IsPro2 && !this.Settings.cboxKhongResetGio && this.Myself.Status != AllEnums.CharStatuses.VETHANH)
                      {
                        int num = 10740000;
                        if (this.MyFlag.Random_ResetTime == 0)
                          this.MyFlag.Random_ResetTime = GA.random.Next(20, 60) * 10000;
                        if (this.Myself.OnlineTime >= num - this.MyFlag.Random_ResetTime && !this.Myself.JustWarped && this.Myself.IsPartyFollowed == (byte) 0 && this.Target.VersionNum != 3 && (this.MyFlag.ResetStamp == 0L || this.MyFlag.ResetStamp != 0L && frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.ResetStamp >= 7200000L))
                        {
                          bool flag = true;
                          if (GA.IsInPhuBan(this.Myself.MapID, this) && (this.Myself.IsAcTac || this.Myself.IsAcBa || this.Myself.IsTKC || this.Myself.IsLinhThu || this.Myself.IsQ1 || this.Myself.IsQ2 || this.Myself.IsPHLM || this.Myself.isYTO || this.Myself.IsKyCuoc))
                            flag = false;
                          if (flag)
                          {
                            this.MyFlag.ResetStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                            this.ResetTimeAdvanced();
                            goto label_1076;
                          }
                        }
                      }
                      this.ProcessPartyGrouping();
                      if (this.Myself.IsBuffMode && this.Myself.IsPartyFollowed == (byte) 0 && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LastSkillTimeStamp >= 5000L)
                        this.Myself.IsBuffMode = false;
                      if (frmLogin.GAuto.Settings.IsPro1 && this.Myself.IsPartyFollowed == (byte) 0 && this.IsAIEnabled && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LastSkillTimeStamp >= 2000L && this.Settings.SkillBuffList.Count > 0 && this.Myself.HorseType == -1 && this.Myself.MPPercent > 1.0 && this.Myself.IsPartyFollowed == (byte) 0)
                      {
                        if (this.Settings.cboxBuffHoTroOnOff)
                        {
                          try
                          {
                            foreach (SkillPlayItem skillBuff in (List<SkillPlayItem>) this.Settings.SkillBuffList)
                            {
                              if (skillBuff.IsEnabled)
                              {
                                BuffedPlayer buffTarget = (BuffedPlayer) null;
                                double num = 99.0;
                                if (skillBuff.BuffSelf)
                                {
                                  bool flag = false;
                                  foreach (BuffedPlayer buffPlayer in (List<BuffedPlayer>) skillBuff.BuffPlayerList)
                                  {
                                    if (buffPlayer.Name == this.Myself.Name)
                                    {
                                      flag = true;
                                      break;
                                    }
                                  }
                                  if (!flag)
                                  {
                                    buffTarget = new BuffedPlayer();
                                    buffTarget.Name = this.Myself.Name;
                                    buffTarget.DatabaseID = this.Myself.DatabaseID;
                                    buffTarget.GameID = this.Myself.ID;
                                    num = 1.0;
                                  }
                                }
                                if (buffTarget == null && skillBuff.BuffParty && this.MyParty.PartyNumbers > 0 && this.MyParty.PartyNumbers < 6)
                                {
                                  for (int index = 0; index <= this.MyParty.PartyNumbers; ++index)
                                  {
                                    PartyMember allMember = this.MyParty.AllMembers[index];
                                    if (this.BuffHoTro(skillBuff, buffTarget, allMember))
                                    {
                                      buffTarget = new BuffedPlayer();
                                      buffTarget.Name = allMember.Name;
                                      buffTarget.DatabaseID = allMember.DatabaseID;
                                      buffTarget.GameID = allMember.ID;
                                      break;
                                    }
                                  }
                                }
                                if (buffTarget == null && skillBuff.BuffArmy && this.MyArmy.HasQuanDoan && this.Target.VersionNum != 3 && this.Target.VersionNum != 4)
                                {
                                  for (int index = 0; index < 30; ++index)
                                  {
                                    PartyMember allMember = this.MyArmy.AllMembers[index];
                                    if (this.BuffHoTro(skillBuff, buffTarget, allMember))
                                    {
                                      buffTarget = new BuffedPlayer();
                                      buffTarget.Name = allMember.Name;
                                      buffTarget.DatabaseID = allMember.DatabaseID;
                                      buffTarget.GameID = allMember.ID;
                                      break;
                                    }
                                  }
                                }
                                if (buffTarget != null)
                                {
                                  if (skillBuff.SkillItem.DelayIndex != -1)
                                    skillBuff.SkillItem.SkillDelay = this.MySkills.SkillDelays[skillBuff.SkillItem.DelayIndex].SkillDelay;
                                  bool flag = true;
                                  if (this.Myself.Rage < skillBuff.SkillItem.RageRequired && skillBuff.SkillItem.RageRequired > 0)
                                    flag = false;
                                  if (flag)
                                  {
                                    if (num <= 11.0)
                                      this.AdjustShootList(skillBuff.SkillItem.ID, buffTarget.GameID);
                                    else
                                      this.AdjustShootList(skillBuff.SkillItem.ID, buffTarget.GameID, packet: false);
                                    skillBuff.LastPlayTimeStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                                    buffTarget.LastBuffTime = frmLogin.GlobalTimer.ElapsedMilliseconds;
                                    skillBuff.BuffPlayerList.Add(buffTarget);
                                    this.Myself.LastSkillTimeStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                                    this.Myself.IsBuffMode = true;
                                    break;
                                  }
                                }
                                else if (buffTarget == null)
                                  this.Myself.IsBuffMode = false;
                              }
                            }
                          }
                          catch (Exception ex)
                          {
                            GA.WriteUserLog(frmMain.langErrorWhileCheckingSkills, this);
                          }
                        }
                      }
                      if (this.MyInventory.CheckItemBuffer.Count > 0 && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.WarpStamp >= 15000L)
                      {
                        if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.CheckItemStamp >= 400L)
                        {
                          try
                          {
                            this.Myself.CheckItemStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                            if (this.MyInventory.AllItems[this.MyInventory.CheckItemBuffer[0]].ItemID >= 0)
                              this.CallInventoryItemDetail(this.MyInventory.CheckItemBuffer[0]);
                          }
                          catch (Exception ex)
                          {
                            GA.WriteUserLog(frmMain.langErrorCheckInventory + ex.Message, this);
                          }
                          this.MyInventory.CheckItemBuffer.RemoveAt(0);
                        }
                      }
                      if (this.MySkills.SkillBuffer.Count > 0 && this.Myself.ActionStatus != (byte) 5 && this.Myself.ActionStatus != (byte) 6)
                      {
                        bool flag3 = true;
                        if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.MDPPlayDCTD <= 8000L)
                        {
                          if (this.Myself.ActionStatus == (byte) 7)
                            this.CallAttackTarget(-1, 34, 0, 0);
                          flag3 = false;
                        }
                        if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.noAttackStamp <= 5000L)
                          flag3 = false;
                        if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.noPlaySkillStamp <= 7000L)
                          flag3 = false;
                        if (flag3 && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LastSkillSent >= 450L)
                        {
                          this.Myself.LastSkillSent = frmLogin.GlobalTimer.ElapsedMilliseconds;
                          QuaiIndividual quaiById = this.MyQuai.GetQuaiByID(this.MySkills.SkillBuffer[0].TargetID, true);
                          QuaiIndividual quaiIndividual = (QuaiIndividual) null;
                          int targetId = this.MySkills.SkillBuffer[0].TargetID;
                          bool flag4 = false;
                          bool flag5 = false;
                          if (quaiById == null)
                          {
                            quaiIndividual = this.MyPlayers.GetPlayerByIDAsQuai(this.MySkills.SkillBuffer[0].TargetID, true);
                            if (quaiIndividual == null)
                            {
                              if (this.MySkills.SkillBuffer[0].TargetID == this.Myself.ID)
                                flag5 = true;
                              else if (this.MySkills.SkillBuffer[0].TargetID == -1)
                                flag5 = true;
                              else if (this.MyQuai.TargetID >= 0 && (double) this.MyQuai.TargetHPPercent > 0.0)
                              {
                                targetId = this.MyQuai.TargetID;
                                flag4 = true;
                                flag5 = true;
                              }
                            }
                          }
                          if (quaiById != null || quaiIndividual != null)
                            flag5 = true;
                          if (flag5)
                          {
                            if (this.MySkills.SkillBuffer[0].Packet)
                            {
                              if (!flag4)
                                this.CallAttackTargetPacket(this.Myself.ID, this.MySkills.SkillBuffer[0].SkillID, targetId, this.MySkills.SkillBuffer[0].PosX, this.MySkills.SkillBuffer[0].PosY);
                              else if (this.MyQuai.TargetID >= 0)
                                this.CallAttackTargetPacket(this.Myself.ID, this.MySkills.SkillBuffer[0].SkillID, this.MyQuai.TargetID, this.MySkills.SkillBuffer[0].PosX, this.MySkills.SkillBuffer[0].PosY);
                            }
                            else if (!flag4)
                              this.CallAttackTarget(targetId, this.MySkills.SkillBuffer[0].SkillID, this.MySkills.SkillBuffer[0].PosX, this.MySkills.SkillBuffer[0].PosY);
                            else if (this.MyQuai.TargetID >= 0)
                              this.CallAttackTarget(this.MyQuai.TargetID, this.MySkills.SkillBuffer[0].SkillID, this.MySkills.SkillBuffer[0].PosX, this.MySkills.SkillBuffer[0].PosY);
                            this.MySkills.SkillBuffer.RemoveAt(0);
                          }
                        }
                      }
                      if (frmLogin.GAuto.Settings.IsPro2 && !this.Myself.IsLuyenKim && this.Myself.IsPartyFollowed == (byte) 0 && this.IsAIEnabled)
                      {
                        if (this.MyPet != null && this.MyPet.ActivePetID != 0 && this.CanAction() && this.MyPet.ActivePetIndex >= 0 && this.MyPet.ActivePetIndex < this.MyPet.AllPets.Count)
                        {
                          if (!this.MyPet.NoToy)
                          {
                            try
                            {
                              long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
                              while (this.MyPet.AllPets[this.MyPet.ActivePetIndex].Happiness < this.Settings.numPetChoi)
                              {
                                if (this.CallPlayMyPet(this.MyPet.AllPets[this.MyPet.ActivePetIndex].DatabaseID, this.MyPet.AllPets[this.MyPet.ActivePetIndex].PetOwnerDBID))
                                {
                                  Thread.Sleep(300);
                                  if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds >= 5000L)
                                    break;
                                }
                                else
                                  break;
                              }
                            }
                            catch (Exception ex)
                            {
                              GA.WriteUserLog($"{frmMain.langErrorPlayingPet}. Message: {ex.Message}", this);
                            }
                          }
                        }
                        if (this.MyPet != null && this.MyPet.ActivePetIndex >= 0 && this.MyPet.ActivePetIndex < this.MyPet.AllPets.Count)
                        {
                          if (this.MyPet.AlwaysActivePetName == string.Empty)
                          {
                            try
                            {
                              this.MyPet.AlwaysActivePetName = this.MyPet.AllPets[this.MyPet.ActivePetIndex].PetName;
                            }
                            catch (Exception ex)
                            {
                              GA.WriteUserLog(frmMain.langErrorGettingPetName, this);
                            }
                          }
                        }
                        if (this.MyPet.AlwaysActivePetName != "" && this.MyPet.AlwaysActivePetName != frmLogin.GAuto.Settings.NoPetName && this.MyPet.PetAction == AllEnums.PetActions.XuatChien && this.Myself.HPPercent > 0.0 && !this.Myself.IsPK && this.CanAction() && this.MyPet.flagAllowPet && (this.Myself.ActionStatus == (byte) 0 || (double) this.MyQuai.TargetHPPercent == 0.0) && (this.MyPet.ActivePetID == 0 || this.MyPet.ActivePetDBID != this.MyPet.AlwaysActivePetDBID || this.MyPet.ActivePetGuidID != this.MyPet.AlwaysActivePetGuidID))
                        {
                          SinglePetClass petByName = this.MyPet.GetPetByName(this.MyPet.AlwaysActivePetName);
                          if (petByName != null)
                          {
                            bool flag = true;
                            if (petByName.Happiness < 60)
                            {
                              int num = (70 - petByName.Happiness) / 10;
                              for (int index = 0; index < num; ++index)
                                flag = this.CallPlayMyPet(this.MyPet.AlwaysActivePetDBID, this.MyPet.AlwaysActivePetGuidID);
                              if (flag)
                                Thread.Sleep(500);
                              flag = petByName.Happiness >= 60;
                            }
                            if (this.Myself.ActionStatus != (byte) 5 && flag && this.Myself.HorseType == -1)
                              this.CallPetSure(this.MyPet.AlwaysActivePetName);
                          }
                        }
                      }
                      if (frmLogin.GAuto.Settings.AppMode != AllEnums.AutoModes.Lite && this.Settings.TraderMode != AllEnums.TraderModes.SellBuy && !this.Myself.IsPK && frmLogin.GAuto.Settings.IsPro2 && this.Myself.IsPartyFollowed == (byte) 0 && (this.IsAIEnabled || this.Myself.Menpai == AllEnums.Menpais.NGAMI))
                        this.PetCongSinh_HuyetTe();
                      if (this.Myself.Menpai == AllEnums.Menpais.NGAMI && this.Target.VersionNum == 3 && this.Target.SubVersion == 4)
                      {
                        PlayerIndividual playerIndividual1 = (PlayerIndividual) null;
                        PlayerIndividual playerIndividual2 = (PlayerIndividual) null;
                        double num = 999.0;
                        for (int index3 = 0; index3 < 30; ++index3)
                        {
                          int green = this.Myself.GreenList[index3];
                          if (green > 0)
                          {
                            if (this.MyPlayers.AllPlayers.Count > 0)
                            {
                              try
                              {
                                for (int index4 = this.MyPlayers.AllPlayers.Count - 1; index4 >= 0; --index4)
                                {
                                  PlayerIndividual allPlayer = this.MyPlayers.AllPlayers[index4];
                                  int databaseId = allPlayer.DatabaseID;
                                  if (databaseId == green && databaseId > 0 && (double) allPlayer.HPPercent > 0.0)
                                  {
                                    playerIndividual1 = allPlayer;
                                    break;
                                  }
                                }
                              }
                              catch (Exception ex)
                              {
                              }
                            }
                            if (playerIndividual1 != null && playerIndividual1.MapID == this.Myself.MapID && (double) playerIndividual1.PosX != 0.0 && (double) playerIndividual1.PosY != 0.0)
                            {
                              double distance = GA.CalculateDistance((double) playerIndividual1.PosX, (double) playerIndividual1.PosY, (double) this.Myself.PosX, (double) this.Myself.PosY);
                              if (distance < num)
                              {
                                num = distance;
                                playerIndividual2 = playerIndividual1;
                                playerIndividual1 = (PlayerIndividual) null;
                              }
                            }
                          }
                        }
                        if (playerIndividual2 != null && !this.IsInCity() && !GA.IsInPhuBan(this.Myself.MapID, this))
                          this.MyFlag.inPKTinhKiemStamp = this.nowStamp() + 900000L;
                      }
                      if (this.MyFlag.inPKTinhKiemStamp < this.nowStamp() || GA.IsInPhuBan(this.Myself.MapID, this) || this.IsInCity())
                        this.FuncNgaMySupport();
                      else if (this.Myself.Menpai == AllEnums.Menpais.NGAMI)
                      {
                        if (this.CustomSleep(11, 10000))
                          GA.ShowBalloon("Đang ở trạng thái PK, Nga My sẽ không tự bơm máu đồng đội trong vòng 15 phút", "Chú ý", this, 7000);
                        this.NgaMiBuffSelf();
                        this.NgaMiBuffPet();
                      }
                      bool needVeThuHoach = false;
                      if (frmLogin.GAuto.Settings.IsPro2)
                        this.TrongTrot(ref needVeThuHoach);
                      if (this.Myself.IsScheduled && this.Settings.ListScheduler.Count > 0 && this.Settings.ListScheduler.Count > 0)
                      {
                        if (this.Myself.ScheduledStamp != 0L)
                        {
                          if (this.nowStamp() - this.Myself.ScheduledStamp < 600000L)
                            goto label_458;
                        }
                        try
                        {
                          for (int index = 0; index < this.Settings.ListScheduler.Count; ++index)
                          {
                            GEventClass geventClass = this.Settings.ListScheduler[index];
                            TimeSpan timeOfDay = DateTime.Now.TimeOfDay;
                            int hours = timeOfDay.Hours;
                            int minutes = timeOfDay.Minutes;
                            if (geventClass.Hour == hours && (minutes == geventClass.Minute || minutes > geventClass.Minute && minutes <= geventClass.Minute + 6) && !GA.IsInPhuBan(this.Myself.MapID, this) && (geventClass.eventStamp == 0L || frmLogin.GlobalTimer.ElapsedMilliseconds - geventClass.eventStamp >= 600000L))
                            {
                              geventClass.eventStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                              if (this.MyParty.PartyNumbers > 1)
                              {
                                if (this.IsPartyKeyInt() == 1)
                                {
                                  GA.PartyGiveKeyToMe(this);
                                  Thread.Sleep(5000);
                                }
                                GA.PartyDoSomething(this, mode: 25);
                              }
                              switch (geventClass.EventName)
                              {
                                case "Đi train cả party":
                                case "Train level entire party":
                                case "全部培训":
                                  frmMain.DisableNhiemVu(this);
                                  GA.PartyDoSomething(this, true, 24);
                                  break;
                                case "Ác Tặc":
                                case "Rebels":
                                case "贼兵入侵":
                                  if (!this.Myself.IsAcTac)
                                  {
                                    frmMain.frmMainInstance.cboxIsAcTac.Invoke((Delegate) (() =>
                                    {
                                      this.MyFlag.DatLichFlag = true;
                                      frmMain.frmMainInstance.NVAcTac(this);
                                    }));
                                    break;
                                  }
                                  break;
                                case "Tàng Kinh Các":
                                case "藏经阁":
                                  if (!this.Myself.IsTKC)
                                  {
                                    frmMain.frmMainInstance.cboxIsTKC.Invoke((Delegate) (() =>
                                    {
                                      this.MyFlag.DatLichFlag = true;
                                      frmMain.frmMainInstance.NVTangKinhCac(this);
                                    }));
                                    break;
                                  }
                                  break;
                                case "Tụ Bảo Bồn (Cá nhân)":
                                case "秀宝盆（个人）":
                                  if (!this.Myself.IsTBB)
                                  {
                                    frmMain.frmMainInstance.cboxIsTBB.Invoke((Delegate) (() =>
                                    {
                                      this.MyFlag.DatLichFlag = true;
                                      frmMain.frmMainInstance.NVTuBaoBon(this);
                                    }));
                                    break;
                                  }
                                  break;
                                case "Linh Thú":
                                case "野猪暴走":
                                  if (!this.Myself.IsLinhThu)
                                  {
                                    frmMain.frmMainInstance.cboxIsLinhThu.Invoke((Delegate) (() =>
                                    {
                                      this.MyFlag.DatLichFlag = true;
                                      frmMain.frmMainInstance.NVLinhThu(this);
                                    }));
                                    break;
                                  }
                                  break;
                                case "PHLM":
                                case "凤凰陵墓":
                                  if (!this.Myself.IsPHLM)
                                  {
                                    frmMain.frmMainInstance.cboxIsPHLM.Invoke((Delegate) (() =>
                                    {
                                      this.MyFlag.DatLichFlag = true;
                                      frmMain.frmMainInstance.NVPHLM(this);
                                    }));
                                    break;
                                  }
                                  break;
                                case "Kỳ Cuộc":
                                case "Chess":
                                case "棋局":
                                  if (!this.Myself.IsKyCuoc)
                                  {
                                    frmMain.frmMainInstance.cboxKyCuoc.Invoke((Delegate) (() =>
                                    {
                                      this.MyFlag.DatLichFlag = true;
                                      frmMain.frmMainInstance.NVKyCuoc(this);
                                    }));
                                    break;
                                  }
                                  break;
                                case "Phiêu Miễu Phong - Sơ chiến":
                                  if (!this.Myself.isPMP)
                                  {
                                    this.MyFlag.menuPMP = 402276;
                                    frmMain.frmMainInstance.cboxPMP.Invoke((Delegate) (() =>
                                    {
                                      this.MyFlag.DatLichFlag = true;
                                      frmMain.frmMainInstance.NVPMP(this);
                                    }));
                                    break;
                                  }
                                  break;
                                case "Phiêu Miễu Phong - Khiêu chiến":
                                  if (!this.Myself.isPMP)
                                  {
                                    this.MyFlag.menuPMP = 402263;
                                    frmMain.frmMainInstance.cboxPMP.Invoke((Delegate) (() =>
                                    {
                                      this.MyFlag.DatLichFlag = true;
                                      frmMain.frmMainInstance.NVPMP(this);
                                    }));
                                    break;
                                  }
                                  break;
                                case "Lâu Lan Tầm Bảo":
                                  if (!this.Myself.isLLTB)
                                  {
                                    frmMain.frmMainInstance.cboxLLTB.Invoke((Delegate) (() =>
                                    {
                                      this.MyFlag.DatLichFlag = true;
                                      frmMain.frmMainInstance.NVLLTB(this);
                                    }));
                                    break;
                                  }
                                  break;
                                case "Ác Bá (Tự đổi key)":
                                case "Thief Raid (Auto switch team leader)":
                                case "偷袭门派 （自换钥匙)":
                                  if (!this.Myself.IsAcBa)
                                  {
                                    bool flag6 = true;
                                    if (this.Settings.AcBaPhai == "(Môn phái)" || this.Settings.AcBaPhai == "(Class)" || this.Settings.AcBaPhai == "（等级）")
                                    {
                                      geventClass.eventStamp = 0L;
                                      flag6 = false;
                                    }
                                    if (flag6)
                                    {
                                      bool flag7 = false;
                                      switch (this.Settings.AcBaPhai)
                                      {
                                        case "Thiếu Lâm":
                                        case "Shaolin":
                                          if (this.Myself.Menpai != AllEnums.Menpais.THIEULAM)
                                          {
                                            GA.PartyDoSomething(this, true, 23, 0);
                                            flag7 = true;
                                            break;
                                          }
                                          break;
                                        case "Minh Giáo":
                                        case "Pyromancer":
                                          if (this.Myself.Menpai != AllEnums.Menpais.MINHGIAO)
                                          {
                                            GA.PartyDoSomething(this, true, 23, 1);
                                            flag7 = true;
                                            break;
                                          }
                                          break;
                                        case "Cái Bang":
                                        case "Beggars Alliance":
                                          if (this.Myself.Menpai != AllEnums.Menpais.CAIBANG)
                                          {
                                            GA.PartyDoSomething(this, true, 23, 2);
                                            flag7 = true;
                                            break;
                                          }
                                          break;
                                        case "Võ Đang":
                                        case "Taoist":
                                          if (this.Myself.Menpai != AllEnums.Menpais.VODANG)
                                          {
                                            GA.PartyDoSomething(this, true, 23, 3);
                                            flag7 = true;
                                            break;
                                          }
                                          break;
                                        case "Nga Mi":
                                        case "Nga My":
                                        case "Lotus Order":
                                          if (this.Myself.Menpai != AllEnums.Menpais.NGAMI)
                                          {
                                            GA.PartyDoSomething(this, true, 23, 4);
                                            flag7 = true;
                                            break;
                                          }
                                          break;
                                        case "Tinh Túc":
                                        case "Voodoo":
                                          if (this.Myself.Menpai != AllEnums.Menpais.TINHTUC)
                                          {
                                            GA.PartyDoSomething(this, true, 23, 5);
                                            flag7 = true;
                                            break;
                                          }
                                          break;
                                        case "Thiên Long":
                                        case "Royalty":
                                          if (this.Myself.Menpai != AllEnums.Menpais.THIENLONG)
                                          {
                                            GA.PartyDoSomething(this, true, 23, 6);
                                            flag7 = true;
                                            break;
                                          }
                                          break;
                                        case "Thiên Sơn":
                                        case "Assassin":
                                          if (this.Myself.Menpai != AllEnums.Menpais.THIENSON)
                                          {
                                            GA.PartyDoSomething(this, true, 23, 7);
                                            flag7 = true;
                                            break;
                                          }
                                          break;
                                        case "Tiêu Dao":
                                        case "Minstrel":
                                          if (this.Myself.Menpai != AllEnums.Menpais.TIEUDAO)
                                          {
                                            GA.PartyDoSomething(this, true, 23, 8);
                                            flag7 = true;
                                            break;
                                          }
                                          break;
                                        case "Mộ Dung":
                                        case "Sphinx":
                                          if (this.Myself.Menpai != AllEnums.Menpais.MODUNG)
                                          {
                                            GA.PartyDoSomething(this, true, 23, 10);
                                            flag7 = true;
                                            break;
                                          }
                                          break;
                                        case "Đường Môn":
                                          if (this.Myself.Menpai != AllEnums.Menpais.DUONGMON)
                                          {
                                            GA.PartyDoSomething(this, true, 23, 11);
                                            flag7 = true;
                                            break;
                                          }
                                          break;
                                        case "Quỷ Cốc":
                                          if (this.Myself.Menpai != AllEnums.Menpais.QUYCOC)
                                          {
                                            GA.PartyDoSomething(this, true, 23, 12);
                                            flag7 = true;
                                            break;
                                          }
                                          break;
                                      }
                                      if (flag7)
                                      {
                                        if (this.IsPartyKeyInt() == 1)
                                        {
                                          this.Myself.ScheduledStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                                          index += 100;
                                          break;
                                        }
                                        break;
                                      }
                                      if (!flag7)
                                      {
                                        this.Myself.ScheduledStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                                        if (!this.Myself.IsAcBa)
                                        {
                                          frmMain.frmMainInstance.cboxIsAcBa.Invoke((Delegate) (() =>
                                          {
                                            this.MyFlag.DatLichFlag = true;
                                            frmMain.frmMainInstance.NVAcBa(this);
                                          }));
                                          break;
                                        }
                                        break;
                                      }
                                      break;
                                    }
                                    break;
                                  }
                                  break;
                                case "Ác Bá (Không đổi key)":
                                  if (!this.Myself.IsAcBa)
                                  {
                                    this.Myself.ScheduledStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                                    if (!this.Myself.IsAcBa)
                                    {
                                      frmMain.frmMainInstance.cboxIsAcBa.Invoke((Delegate) (() =>
                                      {
                                        this.MyFlag.DatLichFlag = true;
                                        frmMain.frmMainInstance.NVAcBa(this);
                                      }));
                                      break;
                                    }
                                    break;
                                  }
                                  break;
                                case "Q1 Tô Châu":
                                case "Q1 Su Zhou":
                                case "Q1 苏州":
                                  if (!this.Myself.IsQ1)
                                  {
                                    frmMain.frmMainInstance.cboxIsQ1.Invoke((Delegate) (() =>
                                    {
                                      this.MyFlag.DatLichFlag = true;
                                      frmMain.frmMainInstance.NVQ1ToChau(this);
                                    }));
                                    break;
                                  }
                                  break;
                                case "Q2 Tô Châu":
                                case "Q2 Su Zhou":
                                case "Q2 苏州":
                                  if (!this.Myself.IsQ2)
                                  {
                                    frmMain.frmMainInstance.cboxIsQ2.Invoke((Delegate) (() =>
                                    {
                                      this.MyFlag.DatLichFlag = true;
                                      frmMain.frmMainInstance.NVQ2ToChau(this);
                                    }));
                                    break;
                                  }
                                  break;
                                case "Yến Tử Ổ":
                                case "Swallow Deck":
                                case "燕子坞":
                                  if (!this.Myself.isYTO)
                                  {
                                    frmMain.frmMainInstance.cboxIsYTO.Invoke((Delegate) (() =>
                                    {
                                      this.MyFlag.DatLichFlag = true;
                                      frmMain.frmMainInstance.NVYenTuO(this);
                                    }));
                                    break;
                                  }
                                  break;
                                case "Bách Hoa Duyên (Cá nhân)":
                                case "白花缘（个人）":
                                  if (!this.Myself.isBachHoaDuyen)
                                  {
                                    frmMain.frmMainInstance.cboxIsBachHoaDuyen.Invoke((Delegate) (() =>
                                    {
                                      this.MyFlag.DatLichFlag = true;
                                      frmMain.frmMainInstance.NVBachHoaDuyen(this);
                                    }));
                                    break;
                                  }
                                  break;
                                case "Quest Sư Môn (Cá nhân)":
                                case "使命师门（个人）":
                                  if (!this.Myself.isQSM)
                                  {
                                    frmMain.frmMainInstance.cboxIsQSM.Invoke((Delegate) (() =>
                                    {
                                      this.MyFlag.DatLichFlag = true;
                                      frmMain.frmMainInstance.NVQSuMon(this);
                                    }));
                                    break;
                                  }
                                  break;
                                case "Khai khoáng, Hái dược (Cá nhân)":
                                case "Mining + Herbal":
                                case "开矿，摘药（个人）":
                                  if (!this.Myself.IsKhaiKhoang)
                                  {
                                    frmMain.frmMainInstance.cboxIsKhaiKhoang.Invoke((Delegate) (() =>
                                    {
                                      this.MyFlag.DatLichFlag = true;
                                      frmMain.frmMainInstance.NVKhaiKhoangHaiDuoc(this);
                                    }));
                                    break;
                                  }
                                  break;
                                case "Reset giờ cả party":
                                case "复立全部时间":
                                  GA.PartyDoSomething(this, mode: 27);
                                  this.ResetTimeAdvanced();
                                  if (this.MyParty.PartyNumbers >= 1 && this.IsPartyKeyInt() == 1)
                                  {
                                    GA.PartyGiveKeyToMe(this);
                                    Thread.Sleep(1500);
                                    break;
                                  }
                                  break;
                                case "Phù về thành cả party":
                                case "Warping to city entire party":
                                case "全部回城":
                                  this.CallRemovePartyFollow();
                                  GA.PartyDoSomething(this, mode: 30);
                                  Thread.Sleep(500);
                                  GA.PartyDoSomething(this, true, 8, 99);
                                  frmMain.DisableNhiemVu(this);
                                  this.Myself.Status = AllEnums.CharStatuses.IDLE;
                                  this.Myself.MoveAcrossMap = false;
                                  this.Myself.MoveLongTrigger = false;
                                  this.Myself.IsLongMove = false;
                                  break;
                                case "Thoát game (Cá nhân)":
                                case "Exit my game":
                                case "退出游戏（个人）":
                                  this.CallOutGame();
                                  break;
                                case "Thoát game cả party":
                                case "Exit game entire party":
                                case "全部退出游戏":
                                  GA.PartyDoSomething(this, true, 26);
                                  break;
                                case "Tắt máy":
                                case "Shutdown Computer":
                                case "关机":
                                  Process.Start("shutdown", "/s /t 60 /f");
                                  break;
                              }
                              if (geventClass.eventStamp > 0L && (!(geventClass.EventName == "Reset giờ cả party") || this.Myself.OnlineTime >= 1800000))
                              {
                                GA.WriteUserLog(frmMain.langEventActivated + geventClass.EventName, this);
                                goto label_1076;
                              }
                            }
                          }
                        }
                        catch (Exception ex)
                        {
                        }
                      }
label_458:
                      if (this.Myself.IsPK && this.Myself.LastPKStamp != 0L && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LastPKStamp > 5000L)
                      {
                        this.Myself.LastPKStamp = 0L;
                        this.Myself.IsPK = false;
                      }
                      if (frmLogin.GAuto.Settings.IsPro1)
                      {
                        if (this.Myself.TriedHoiSinh && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.HoiSinhStamp >= 7000L)
                          this.Myself.TriedHoiSinh = false;
                        if (this.Myself.MaxHP > 0 && this.Myself.HP == 0 && this.Myself.DiedStamp == 0L)
                          this.Myself.DiedStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                        else if (this.Myself.DiedStamp != 0L && this.Myself.MaxHP > 0 && this.Myself.HP > 0)
                          this.Myself.DiedStamp = 0L;
                        if (this.Myself.ID != 0 && this.Myself.ReadyToAttack && this.IsAIEnabled)
                        {
                          if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.inYTOStamp <= 600000L && this.Myself.HP == 0 && this.Myself.MaxHP > 0 && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.HoiSinhStamp >= 3000L)
                          {
                            this.Myself.HoiSinhStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                            this.CallHoiSinh();
                          }
                          if (this.Settings.AfterDeathSetting == AllEnums.AfterDeathSettings.BackToTrainSpot)
                          {
                            this.Myself.StopTrain = false;
                            if (this.Myself.HP == 0 && this.Myself.MaxHP > 0)
                            {
                              bool flag = false;
                              if (this.Myself.isBachHoaDuyen || this.Myself.isQSM || this.Myself.IsTrungAc || this.Myself.isDaoBTD || this.Myself.IsKhaiKhoang || this.Myself.isTanThu || this.Myself.IsXayDung)
                                flag = true;
                              if (this.Settings.cboxChoHoiSinh || flag)
                              {
                                if (!this.Myself.TriedHoiSinh)
                                {
                                  this.Myself.HoiSinhStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                                  this.Myself.TriedHoiSinh = true;
                                  this.CallHoiSinh();
                                }
                                if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiedStamp >= (long) (this.Settings.numChoHoiSinh * 1000) || flag)
                                {
                                  if (this.Myself.LogLastAction != AllEnums.LogActions.ChetDiaPhu)
                                  {
                                    GA.WriteUserLog(frmMain.langCharDied, this);
                                    this.Myself.LogLastAction = AllEnums.LogActions.ChetDiaPhu;
                                  }
                                  this.CallThoatXac();
                                  Thread.Sleep(4000);
                                }
                              }
                            }
                          }
                          else if (this.Settings.AfterDeathSetting == AllEnums.AfterDeathSettings.ExitGame)
                          {
                            if (Math.Abs(frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.CheckExitGameStamp) >= 3000L)
                            {
                              this.Myself.CheckExitGameStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                              if (this.Myself.HP == 0 && this.Myself.MaxHP > 0)
                              {
                                if (!this.Myself.TriedHoiSinh)
                                {
                                  this.Myself.HoiSinhStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                                  this.Myself.TriedHoiSinh = true;
                                  this.CallHoiSinh();
                                }
                                if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiedStamp >= (long) (this.Settings.numChoHoiSinh * 1000) && this.Settings.cboxChoHoiSinh)
                                {
                                  if (this.Myself.LogLastAction != AllEnums.LogActions.ChetDiaPhu)
                                  {
                                    GA.WriteUserLog(frmMain.langCharDied60s, this);
                                    this.Myself.LogLastAction = AllEnums.LogActions.ChetDiaPhu;
                                  }
                                  this.CallThoatXac();
                                  Thread.Sleep(1500);
                                }
                              }
                            }
                            if (this.isInDiaPhu())
                            {
                              if (this.Myself.ThoatGameStamp == 0L)
                                this.Myself.ThoatGameStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                              if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.ThoatGameStamp >= 60000L)
                                this.CallOutGame();
                            }
                            else if (this.IsInCity())
                              this.Myself.ThoatGameStamp = 0L;
                          }
                          else if (this.Settings.AfterDeathSetting == AllEnums.AfterDeathSettings.HappyTea)
                          {
                            if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.DiedStamp >= (long) (this.Settings.numChoHoiSinh * 1000) && !this.isInDiaPhu() && this.Myself.HPPercent <= 0.0 && this.Myself.MaxHP > 0 && this.Settings.cboxChoHoiSinh)
                            {
                              if (this.Myself.LogLastAction != AllEnums.LogActions.ChetDiaPhu)
                              {
                                GA.WriteUserLog(frmMain.langCharDied2, this);
                                this.Myself.LogLastAction = AllEnums.LogActions.ChetDiaPhu;
                              }
                              this.CallThoatXac();
                              Thread.Sleep(2000);
                            }
                            if (this.isInDiaPhu())
                            {
                              if (this.Target.VersionNum == 3)
                              {
                                this.Myself.StopTrain = true;
                                this.Myself.Status = AllEnums.CharStatuses.VETHANH;
                                this.Myself.SavedStatus = AllEnums.CharStatuses.VETHANH;
                                this.Myself.LongMoveX = 0;
                                this.Myself.LongMoveY = 0;
                                this.Myself.LongMoveMapID = -1;
                                this.Myself.IsLongMove = false;
                                this.Myself.MoveLongTrigger = false;
                              }
                              else
                              {
                                if (this.Settings.AIMode != AllEnums.AIModes.NHIEMVU && this.Settings.AIMode != AllEnums.AIModes.KHAIKHOANG_HAIDUOC)
                                  this.IsAIEnabled = false;
                                this.Myself.StopTrain = true;
                                if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, 15.0, 25.0) > 3.0)
                                {
                                  this.CallMoveFlashPos(15, 25);
                                }
                                else
                                {
                                  this.Myself.MoveAcrossMap = false;
                                  this.Myself.Status = AllEnums.CharStatuses.IDLE;
                                  if (this.Myself.isQuestFrameShow == 0)
                                    this.CallTalkNPC(0, 0, 0);
                                }
                              }
                            }
                          }
                        }
                      }
                      this.AutoAcceptPTInvite();
                      if (this.Myself.IsMoveTest)
                      {
                        int tempX1 = 44;
                        int tempY1 = 60;
                        int tempX2 = 32 /*0x20*/;
                        int tempY2 = 132;
                        if (this.Myself.flagMoveForward)
                          this.CallInMapMove(tempX2, tempY2, true);
                        else if (!this.Myself.flagMoveForward)
                          this.CallInMapMove(tempX1, tempY1, true);
                        if (this.Myself.flagMoveForward)
                        {
                          if ((double) Math.Abs(this.Myself.PosX - (float) tempX2) <= 2.0 && (double) Math.Abs(this.Myself.PosY - (float) tempY2) <= 2.0)
                            this.Myself.flagMoveForward = false;
                        }
                        else if (!this.Myself.flagMoveForward && (double) Math.Abs(this.Myself.PosX - (float) tempX1) <= 2.0 && (double) Math.Abs(this.Myself.PosY - (float) tempY1) <= 2.0)
                          this.Myself.flagMoveForward = true;
                      }
                      if (this.Target.DLLPatchedValue != 6971548U && this.Target.DLLRead && (this.Myself.checkDLLStamp == 0L || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.checkDLLStamp > 5000L))
                        this.Myself.checkDLLStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                      int num1 = 0;
                      if (GA.isVipMember() && this.Myself.MapID > 2 && !this.IsInCity() && !this.IsInPhaiMap() && !GA.IsBangMapID(this.Myself.MapID) && !GA.IsInPhuBan(this.Myself.MapID, this) && num1 == 999 && this.Settings.numPKThoatGame > 1 && this.Myself.HPPercent > 0.0 && this.Myself.HPPercent < (double) this.Settings.numPKThoatGame)
                      {
                        if (this.Myself.MapID == 39)
                          this.CallOutMapMove(277, 295, 0);
                        else if (this.Target.VersionNum == 1 || this.Target.VersionNum == 2)
                        {
                          GA.WriteUserLog($"Úm ba la biến, máu còn {this.Myself.HPPercent.ToString("0.00")}%", this);
                          MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_CALLHVD, (IntPtr) 0, (IntPtr) 0);
                          Thread.Sleep(2000);
                        }
                      }
                      if (this.MyFlag.tuyenChienFlag)
                      {
                        this.MyFlag.tuyenChienFlag = false;
                        if (this.MyQuai != null && this.MyQuai.TargetIDforPK > 0)
                        {
                          this.CallTuyenChien(this.MyQuai.TargetIDforPK);
                          this.AttackPlayer(this.MyQuai.TargetIDforPK);
                        }
                      }
                      if (this.MyFlag.donDameFlag)
                      {
                        this.MyFlag.donDameFlag = false;
                        if (this.MyQuai != null && this.MyQuai.TargetIDforPK > 0)
                        {
                          this.CallTuyenChien(this.MyQuai.TargetIDforPK);
                          this.AttackPlayer(this.MyQuai.TargetIDforPK);
                          GA.PartyDoSomething(this, mode: 28, param1: this.MyQuai.TargetIDforPK);
                        }
                      }
                      if (this.Myself.ID != 0 && this.IsAIEnabled && this.Settings.AIMode == AllEnums.AIModes.NHIEMVU)
                      {
                        if (this.Myself.isYTO && frmLogin.GAuto.Settings.IsPro2)
                          this.NhiemVuYTO();
                        else if (this.Myself.isPMP && frmLogin.GAuto.Settings.IsPro2)
                          this.NhiemVuPMP();
                      }
                      if (this.Myself.ID != 0 && this.Myself.ReadyToAttack && this.IsAIEnabled && this.Myself.HPPercent > 0.0)
                      {
                        if (this.Settings.cboxCanX2 && !this.HasPK() && frmLogin.GAuto.Settings.IsPro2 && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LastReceiveExpStamp <= 30000L && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.X2TimeStamp >= 15000L)
                        {
                          this.Myself.X2TimeStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                          bool flag = false;
                          if (this.Myself.Lastx2UsedStamp == 0L)
                            flag = true;
                          else if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.Lastx2UsedStamp >= 3540000L)
                            flag = true;
                          if (flag)
                          {
                            for (int index = 0; index < 30; ++index)
                            {
                              InventoryItem allItem = this.MyInventory.AllItems[index];
                              if (allItem.ItemName == "thiên linh đan" || allItem.ItemID == 30505214 || allItem.ItemID == 30008002 || allItem.ItemID == 30008027)
                              {
                                this.CallUseItem(index, this.Myself.ID);
                                Thread.Sleep(500);
                                break;
                              }
                            }
                          }
                        }
                        if (this.Settings.cboxCanX4 && !this.HasPK() && frmLogin.GAuto.Settings.IsPro2 && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LastReceiveExpStamp <= 30000L && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.X4TimeStamp >= 15000L)
                        {
                          this.Myself.X4TimeStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                          bool flag = false;
                          if (this.Myself.Lastx4UsedStamp == 0L)
                            flag = true;
                          else if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.Lastx4UsedStamp >= 3540000L)
                            flag = true;
                          if (flag)
                          {
                            for (int index = 0; index < 30; ++index)
                            {
                              InventoryItem allItem = this.MyInventory.AllItems[index];
                              if (allItem.ItemName == "huyền linh đan" || allItem.ItemID == 30008130 || allItem.ItemID == 38000654 || allItem.ItemID == 30008117)
                              {
                                this.CallUseItem(index, this.Myself.ID);
                                Thread.Sleep(500);
                                this.MyFlag.ClickYesStamp = frmLogin.GlobalTimer.ElapsedMilliseconds + 15000L;
                                break;
                              }
                            }
                          }
                        }
                        if (this.Myself.PreviousIsPK && !this.Myself.IsPK && !this.Myself.IsTrader)
                        {
                          bool flag = true;
                          if (this.Myself.Menpai != AllEnums.Menpais.NGAMI && !this.Settings.cboxDanhQuai || !this.Settings.cboxPKTuVe || this.Settings.cboxPKEnable)
                            flag = false;
                          if (this.isInDiaPhu())
                          {
                            this.Myself.Status = AllEnums.CharStatuses.VETHANH;
                            this.Myself.SavedStatus = AllEnums.CharStatuses.VETHANH;
                            flag = false;
                          }
                          if (this.Myself.PKReturnStamp.ElapsedMilliseconds >= 2000L && this.Settings.AIMode == AllEnums.AIModes.DANHQUANHDIEM && flag)
                          {
                            this.Myself.PKReturnStamp.Reset();
                            this.Myself.PKReturnStamp.Start();
                            if (this.Myself.LogLastAction == AllEnums.LogActions.SavePKName)
                              this.Myself.LogLastAction = AllEnums.LogActions.None;
                            float num2 = 0.0f;
                            float num3 = 0.0f;
                            int num4 = 0;
                            if (this.MyParty != null && this.MyParty.PartyNumbers > 0 && this.MyParty.PartyNumbers < 6)
                            {
                              PartyMember allMember = this.MyParty.AllMembers[0];
                              if (allMember.Name != this.Myself.Name && allMember.Name != "")
                              {
                                num2 = allMember.PosX;
                                num3 = allMember.PosY;
                                num4 = allMember.MapID;
                              }
                            }
                            if ((double) num2 == 0.0)
                            {
                              num2 = (float) this.Settings.CenterX;
                              num3 = (float) this.Settings.CenterY;
                              num4 = this.Settings.MapID;
                            }
                            if (num4 >= 0 && (double) num2 != 0.0 && (double) num3 != 0.0)
                            {
                              if (num4 == this.Myself.MapID)
                              {
                                this.Myself.TargetX = num2;
                                this.Myself.TargetY = num3;
                                this.CallMoveTo((int) this.Myself.TargetX, (int) this.Myself.TargetY);
                                this.Myself.MoveFlashPos = true;
                                this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
                                this.Myself.LastTimeMove.Reset();
                                this.Myself.LastTimeMove.Start();
                              }
                              else if (num4 != this.Myself.MapID)
                              {
                                this.Myself.TargetX = num2;
                                this.Myself.TargetY = num3;
                                this.Myself.TargetMapID = num4;
                                this.Settings.SavedPosX = num2;
                                this.Settings.SavedPosY = num3;
                                this.Settings.SavedMapID = num4;
                                this.Myself.MoveFlashPos = true;
                                this.Myself.LongMoveMapID = num4;
                                this.Myself.LongMoveX = (int) num2;
                                this.Myself.LongMoveY = (int) num3;
                                this.Myself.MoveLongTrigger = true;
                              }
                            }
                          }
                        }
                        if (this.Myself.IsHaiDua && this.Myself.MapID == 0 && this.Myself.IsHaiDuaChet)
                        {
                          this.ScriptEngine.IsOn = false;
                          GScriptCommand cmd = new GScriptCommand();
                          this.GoToBang(cmd);
                          if (cmd.Status == AllEnums.ScriptStatuses.FINISHED)
                          {
                            this.ScriptEngine.IsOn = true;
                            this.Myself.IsHaiDuaChet = false;
                            this.ScriptEngine.Index = 17;
                            this.Myself.MoveLongTrigger = false;
                            this.Myself.MoveAcrossMap = false;
                            this.Myself.Status = AllEnums.CharStatuses.IDLE;
                          }
                        }
                        if (frmLogin.GAuto.Settings.IsPro2)
                        {
                          if (this.isInDiaPhu())
                          {
                            this.Myself.LongMoveX = 0;
                            this.Myself.LongMoveY = 0;
                            this.Myself.LongMoveMapID = -1;
                            this.Myself.IsLongMove = false;
                            this.Myself.MoveLongTrigger = false;
                            if (this.Settings.AfterDeathSetting == AllEnums.AfterDeathSettings.BackToTrainSpot || this.Settings.AfterDeathSetting == AllEnums.AfterDeathSettings.HappyTea)
                            {
                              this.Myself.Status = AllEnums.CharStatuses.VETHANH;
                              this.Myself.SavedStatus = AllEnums.CharStatuses.VETHANH;
                              if (-1 >= 0)
                              {
                                this.CallUseItem(0, this.Myself.ID);
                                this.MyFlag.dungphuStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                                Thread.Sleep(5000);
                              }
                              else if (this.Settings.HealMapID == 480)
                                this.CallMoveTo(12, 24);
                              else if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, 15.0, 25.0) > 3.0)
                                this.CallMoveTo(15, 25);
                              else if (this.Myself.isQuestFrameShow == 0)
                              {
                                this.CallTalkNPC(0, 0, 0);
                                Thread.Sleep(500);
                                bool flag = false;
                                if (this.isInDiaPhu())
                                  flag = true;
                                if (flag)
                                {
                                  if (this.Myself.MapID == 463 || this.Myself.MapID == 586)
                                    this.CallTalkNPC(505072, 1, 0);
                                  else if (this.Target.VersionNum == 3 && (this.Target.SubVersion == 4 || this.Target.SubVersion == 12))
                                  {
                                    if (this.Settings.HealMapID == 0)
                                      this.CallTalkNPC(12009, 1, 0);
                                    else if (this.Settings.HealMapID == 1)
                                      this.CallTalkNPC(12009, 3, 0);
                                    else if (this.Settings.HealMapID == 2)
                                      this.CallTalkNPC(12009, 5, 0);
                                    else if (this.Settings.HealMapID == 186)
                                      this.CallTalkNPC(12009, 6, 0);
                                    else if (this.Settings.HealMapID == 420)
                                      this.CallTalkNPC(12009, 7, 0);
                                  }
                                  else if (this.Settings.HealMapID == 0)
                                    this.CallTalkNPC(77001, 0, 0);
                                  else if (this.Settings.HealMapID == 1)
                                    this.CallTalkNPC(77001, 1, 0);
                                  else if (this.Settings.HealMapID == 2)
                                    this.CallTalkNPC(77001, 2, 0);
                                  else if (this.Settings.HealMapID == 186)
                                    this.CallTalkNPC(77001, 5, 0);
                                  else if (this.Settings.HealMapID == 420)
                                    this.CallTalkNPC(77001, 4, 0);
                                  Thread.Sleep(2000);
                                }
                              }
                            }
                          }
                          if (this.Myself.MapID == 151)
                          {
                            this.Myself.LongMoveX = 0;
                            this.Myself.LongMoveY = 0;
                            this.Myself.LongMoveMapID = -1;
                            this.Myself.IsLongMove = false;
                            this.Myself.MoveLongTrigger = false;
                            if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, 44.0, 31.0) > 3.0)
                            {
                              this.CallMoveTo(44, 31 /*0x1F*/);
                            }
                            else
                            {
                              int NPCID = 0;
                              int menuTypeID = 77011;
                              int menuIndex1 = 11;
                              int menuIndex2 = 0;
                              if (this.Myself.isQuestFrameShow == 0)
                              {
                                this.CallTalkNPC(0, 0, NPCID);
                                Thread.Sleep(500);
                                this.CallTalkNPC(menuTypeID, menuIndex1, NPCID);
                                Thread.Sleep(700);
                                this.CallTalkNPC(menuTypeID, menuIndex2, NPCID);
                              }
                            }
                          }
                        }
                        if (frmLogin.GAuto.Settings.IsPro2 && (!this.Settings.cboxNoTheoSau || this.Settings.cboxNoTheoSau && !this.IsInCity()) && this.Settings.cboxTheoSau && !this.Myself.IsPK && !this.IsNhatBoc() && this.Myself.IsPartyFollowed == (byte) 0 && !this.Myself.IsKhaiKhoang && !this.Myself.IsTrungAc && !this.Myself.IsLuyenKim && !this.Myself.IsXayDung && !this.Myself.IsTBB && !this.Myself.isBachHoaDuyen && !this.Myself.IsTuDuongCon && !this.Myself.isQSM && !this.Myself.isCauPhuc && !this.Myself.isCauNguyen && !this.Myself.isDoatBaoRuong && !this.Myself.isBuonDuaHau)
                          this.TheoSauAiDo();
                        if (this.Myself.IsHaiDua && this.Myself.Status == AllEnums.CharStatuses.VETHANH)
                          this.Myself.Status = AllEnums.CharStatuses.IDLE;
                        if (this.Myself.Status != AllEnums.CharStatuses.NMBUFFMAU && this.Myself.Status != AllEnums.CharStatuses.NHATBOC && this.Myself.ActionStatus != (byte) 5 && this.Myself.ActionStatus != (byte) 6 && (this.Myself.SavedStatus != AllEnums.CharStatuses.VETHANH || this.Myself.MinorStatus2 == AllEnums.CharStatuses.TRIEUTAP) && this.Myself.SavedStatus != AllEnums.CharStatuses.BUYING_NPC && this.Myself.SavedStatus != AllEnums.CharStatuses.SELLING_NPC)
                          this.LongMoveTrigger();
                        if (this.IsInCity() && (this.Myself.SavedStatus == AllEnums.CharStatuses.VETHANH || this.Myself.Status == AllEnums.CharStatuses.VETHANH) && this.Myself.IsPartyFollowed == (byte) 0)
                        {
                          if (this.Target.VersionNum != 3)
                            this.Myself.Status = AllEnums.CharStatuses.VETHANH;
                          if (!this.Settings.cboxDuY || this.Myself.isMuaDoTrain || this.ForceHoiMau(true))
                            this.MuaDoDiTrain();
                        }
                        if (this.IsInCity() && this.Myself.Status == AllEnums.CharStatuses.LENLAIBAITRAIN && this.Myself.IsPartyFollowed == (byte) 0)
                          this.BackToTrainSpot();
                        if (this.Myself.IsLongMove)
                          this.AutoIsLongMove();
                        if (!this.IsInCity() && this.Myself.Status != AllEnums.CharStatuses.VETHANH && this.Myself.MinorStatus != AllEnums.CharStatuses.MOVE_LONG_PATH && this.Myself.Status != AllEnums.CharStatuses.NMBUFFMAU && this.Myself.ActionStatus != (byte) 5 && this.Myself.ActionStatus != (byte) 6 && this.Myself.IsPartyFollowed == (byte) 0 && !this.Myself.IsPK && !GA.IsInPhuBan(this.Myself.MapID, this) && (!this.Settings.cboxTheoSau || this.Settings.cboxTheoSau && this.TheoSauAiDo(false) == null) && this.Settings.AIMode == AllEnums.AIModes.DANHQUANHDIEM && this.Settings.cboxBanKinh)
                        {
                          bool flag = this.NotTransitioning();
                          if (this.Myself.Status != AllEnums.CharStatuses.GOGOGO && this.Settings.CenterX != 0.0 && this.Settings.CenterY != 0.0 && this.Settings.MapID == this.Myself.MapID && flag)
                          {
                            double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, this.Settings.CenterX, this.Settings.CenterY);
                            if (distance > this.Settings.MoveRange && !this.IsNhatBoc() && this.Myself.LastTimeMove.ElapsedMilliseconds >= 2000L)
                            {
                              this.Myself.TargetX = (float) this.Settings.CenterX;
                              this.Myself.TargetY = (float) this.Settings.CenterY;
                              if (distance - this.Settings.MoveRange > 4.0)
                              {
                                if (this.Myself.ActionStatus == (byte) 7)
                                {
                                  this.CallAttackTarget(-1, 34, 0, 0);
                                  this.CallAttackTarget(-1, this.GetKhinhCongID(), 0, 0);
                                  Thread.Sleep(200);
                                }
                                this.CallInMapMove((int) this.Myself.TargetX, (int) this.Myself.TargetY, true);
                                this.Myself.IDLEStamp = frmLogin.GlobalTimer.ElapsedMilliseconds + 2000L;
                              }
                              else
                                this.CallInMapMove((int) this.Myself.TargetX, (int) this.Myself.TargetY);
                              this.Myself.LastTimeMove.Reset();
                              this.Myself.LastTimeMove.Start();
                            }
                          }
                        }
                        if (this.Myself.Status != AllEnums.CharStatuses.NMBUFFMAU && this.Myself.ActionStatus != (byte) 5)
                          this.ProcessRegularMove();
                        if (this.Settings.cboxTuUpLevel && frmLogin.GAuto.Settings.IsPro1 && this.Myself.ExpPercent >= 100.0 && this.Myself.Level < this.Settings.numUpLevel)
                        {
                          if (this.Myself.UpLevelStamp == 0L || this.Target.SubVersion != 4 && this.Target.SubVersion != 12)
                          {
                            this.CallUpLevelPacket();
                            Thread.Sleep(100);
                            this.Myself.UpLevelStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                          }
                          else if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.UpLevelStamp >= 12000L)
                            this.Myself.UpLevelStamp = 0L;
                        }
                        bool flag8 = this.NotTransitioning();
                        if (this.Myself.Status != AllEnums.CharStatuses.NMBUFFMAU && flag8 && frmLogin.GAuto.Settings.IsPro1 && !GA.IsInPhuBan(this.Myself.MapID, this) && !GA.IsBangMapID(this.Myself.MapID) && this.Myself.IsPartyFollowed == (byte) 0 && this.Settings.AIMode != AllEnums.AIModes.NHIEMVU)
                          this.WarpingToCity(needVeThuHoach);
                        int partyFollowRequest1 = (int) this.Myself.FlagPartyFollowRequest;
                        bool flag9 = false;
                        if (this.Settings.cboxPKEnable && !this.WantMoveNow() && !this.IsInCity() && !this.isInDiaPhu())
                          flag9 = this.AttackPlayer();
                        if (!flag9 && frmLogin.GAuto.Settings.IsPro2)
                        {
                          if (this.Settings.cboxPKThoatGame && this.Settings.numPKThoatGame > 0 && this.Myself.HPPercent > 0.0 && this.Myself.HPPercent < (double) this.Settings.numPKThoatGame && (!GA.isVipMember() || this.Myself.MapID == 480 || this.Myself.MapID == 186 || this.Myself.MapID == 420 || this.Myself.MapID <= 2 || GA.IsInPhuBan(this.Myself.MapID, this)) && this.Myself.IsPK)
                          {
                            GA.WriteUserLog(string.Format(frmMain.langEmergencyExitPK, (object) this.Myself.HPPercent.ToString("0.00")), this);
                            this.CallOutGame();
                            this.Settings.AIWhileLoop = false;
                            goto label_1076;
                          }
                          if (this.Myself.IsPK && (double) this.MyQuai.TargetHPPercent <= 0.0 && this.Myself.HasTarget && this.Myself.LogLastAction != AllEnums.LogActions.PKKilled)
                          {
                            if (this.MyPlayers.AllPlayers.Count > 0)
                            {
                              try
                              {
                                for (int index = this.MyPlayers.AllPlayers.Count - 1; index >= 0; --index)
                                {
                                  if (this.MyPlayers.AllPlayers[index].ID == this.MyQuai.TargetID)
                                    break;
                                }
                              }
                              catch (Exception ex)
                              {
                              }
                            }
                            this.Myself.LogLastAction = AllEnums.LogActions.PKKilled;
                          }
                          if (this.Settings.cboxPKTuVe && !this.WantMoveNow())
                          {
                            int num5 = this.Myself.IsPK ? 1 : 0;
                            PlayerIndividual playerIndividual3 = (PlayerIndividual) null;
                            PlayerIndividual playerIndividual4 = (PlayerIndividual) null;
                            double num6 = 999.0;
                            for (int index5 = 0; index5 < 30; ++index5)
                            {
                              int green = this.Myself.GreenList[index5];
                              if (green > 0)
                              {
                                if (this.MyPlayers.AllPlayers.Count > 0)
                                {
                                  try
                                  {
                                    for (int index6 = this.MyPlayers.AllPlayers.Count - 1; index6 >= 0; --index6)
                                    {
                                      PlayerIndividual allPlayer = this.MyPlayers.AllPlayers[index6];
                                      int databaseId = allPlayer.DatabaseID;
                                      if (databaseId == green && databaseId > 0 && (double) allPlayer.HPPercent > 0.0)
                                      {
                                        playerIndividual3 = allPlayer;
                                        break;
                                      }
                                    }
                                  }
                                  catch (Exception ex)
                                  {
                                  }
                                }
                                if (playerIndividual3 != null && playerIndividual3.MapID == this.Myself.MapID && (double) playerIndividual3.PosX != 0.0 && (double) playerIndividual3.PosY != 0.0)
                                {
                                  double distance = GA.CalculateDistance((double) playerIndividual3.PosX, (double) playerIndividual3.PosY, (double) this.Myself.PosX, (double) this.Myself.PosY);
                                  if (distance < num6)
                                  {
                                    num6 = distance;
                                    playerIndividual4 = playerIndividual3;
                                    playerIndividual3 = (PlayerIndividual) null;
                                  }
                                }
                              }
                            }
                            if (playerIndividual4 != null)
                            {
                              if (!this.IsInCity())
                              {
                                this.CallXuongNgua();
                                if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LastActionTimeStamp >= (long) frmLogin.GAuto.Settings.ActionDelay)
                                {
                                  this.CallSelectTarget(playerIndividual4.ID);
                                  this.Myself.LastPKStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                                  if (this.Settings.SkillPKList.Count > 0)
                                  {
                                    foreach (SkillPlayItem skillPk in (List<SkillPlayItem>) this.Settings.SkillPKList)
                                    {
                                      if (this.PlayMySkill(skillPk, playerIndividual4.ID))
                                        break;
                                    }
                                  }
                                  this.CallAttackTarget(playerIndividual4.ID, this.MySkills.AllSkills[0].ID, 0, 0, true);
                                  if (!this.Myself.IsPK)
                                  {
                                    this.Myself.IsPK = true;
                                    this.Myself.LastPKStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                                  }
                                }
                              }
                              else if (this.Myself.IsPK)
                                this.Myself.IsPK = false;
                            }
                          }
                          else
                            this.Myself.IsPK = false;
                        }
                        if (this.MyQuai.TargetID >= 0 && !this.Myself.IsPK && !flag9 && this.Myself.ActionStatus == (byte) 0 && this.IsPlayer() && this.Settings.cboxDanhQuai && this.MyQuai.AllQuai.Count > 0 && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.TargetLagStamp >= 30000L)
                        {
                          bool flag10 = false;
                          try
                          {
                            for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
                            {
                              if (this.CanAttack(this.MyQuai.AllQuai[index]))
                              {
                                flag10 = true;
                                break;
                              }
                            }
                          }
                          catch (Exception ex)
                          {
                          }
                          if (flag10)
                            this.CallSelectTarget(-1);
                        }
                        int partyFollowRequest2 = (int) this.Myself.FlagPartyFollowRequest;
                        double targetHpPercent = (double) this.MyQuai.TargetHPPercent;
                        if (!this.IsInCity() && !flag9)
                        {
                          if (this.Settings.AIMode == AllEnums.AIModes.DANHQUANHDIEM || this.Settings.AIMode == AllEnums.AIModes.DANHTUDO)
                            this.AttackQuai();
                          if (this.GCTimeStamp.ElapsedMilliseconds >= 30000L)
                          {
                            GC.Collect();
                            this.GCTimeStamp.Reset();
                            this.GCTimeStamp.Start();
                          }
                        }
                        if (this.Settings.AIMode == AllEnums.AIModes.THUONGNHAN)
                        {
                          if (frmLogin.GAuto.Settings.IsPro1)
                            this.RunningTrade();
                        }
                        else if (this.Settings.AIMode == AllEnums.AIModes.KHAIKHOANG_HAIDUOC)
                        {
                          if (this.Myself.IsKhaiKhoang && frmLogin.GAuto.Settings.IsPro2)
                            this.KhaiKhoangHaiDuoc();
                        }
                        else if (this.Settings.AIMode != AllEnums.AIModes.SCRIPTING && this.Settings.AIMode == AllEnums.AIModes.NHIEMVU)
                        {
                          bool flag11 = false;
                          if (this.Myself.IsTrungAc && frmLogin.GAuto.Settings.IsPro1)
                          {
                            this.NhiemVuTrungAc();
                            flag11 = true;
                          }
                          else if (this.Myself.IsAcTac && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            if (this.Settings.cboATMaps == -1)
                              this.Settings.cboATMaps = 4;
                            if (this.Myself.MapID != this.Settings.cboATMaps && !GA.IsInPhuBan(this.Myself.MapID, this))
                            {
                              int num7 = 0;
                              int num8 = 0;
                              int num9 = 0;
                              if (this.Settings.cboATMaps == 6)
                              {
                                num7 = 45;
                                num8 = 170;
                                num9 = 6;
                              }
                              else if (this.Settings.cboATMaps == 4)
                              {
                                if (this.Myself.MapID == 3)
                                {
                                  num7 = 115;
                                  num8 = 52;
                                  num9 = 4;
                                }
                                else
                                {
                                  num7 = 98;
                                  num8 = 167;
                                  num9 = 11;
                                }
                              }
                              else if (this.Settings.cboATMaps == 3)
                              {
                                num7 = 45;
                                num8 = 50;
                                num9 = 3;
                              }
                              else if (this.Settings.cboATMaps == 8)
                              {
                                num7 = 263;
                                num8 = 147;
                                num9 = 8;
                              }
                              else if (this.Settings.cboATMaps == 7)
                              {
                                num7 = 45;
                                num8 = 274;
                                num9 = 7;
                              }
                              else if (this.Settings.cboATMaps == 5)
                              {
                                num7 = 265;
                                num8 = 44;
                                num9 = 5;
                              }
                              ++this.Myself.actionCounter;
                              if (this.Myself.actionCounter == 1)
                                GA.TrieuTapToMyPos(this, num7, num8, num9);
                              else if (this.Myself.actionCounter >= 4)
                                this.Myself.actionCounter = 0;
                              if (this.Myself.MapID == 11)
                              {
                                if (this.Target.VersionNum == 3 || this.Target.VersionNum == 4)
                                {
                                  this.CallMoveTo(97, 173);
                                  GA.TrieuTapToMyPos(this, 97, 173, this.Myself.MapID);
                                  Thread.Sleep(3000);
                                }
                                else
                                  this.GoToMyPos(279, 226, 4);
                              }
                              else if (this.Myself.MapID == 1)
                              {
                                if (this.Settings.cboATMaps == 4)
                                  this.GoToMyPos(279, 226, 4);
                                else if (this.Settings.cboATMaps == 5)
                                  this.GoToMyPos(num7, num8, num9);
                                else
                                  this.GoToMyPos(num7, num8, num9);
                              }
                              else
                                this.GoToMyPos(num7, num8, num9);
                            }
                            else
                            {
                              if (this.Myself.actionCounter == 0)
                              {
                                ++this.Myself.actionCounter;
                                GA.TrieuTapCaNhom(this, true);
                              }
                              this.PhuBanATAB(this.Settings.cboATMaps, 50013, -1, frmLogin.GAuto.Settings.AcTacNames);
                            }
                          }
                          else if (this.Myself.IsTestNPC)
                            this.PhuBanATAB(16 /*0x10*/, 16035, 0, frmLogin.GAuto.Settings.TestNPCNames);
                          else if (this.Myself.IsAcBa && frmLogin.GAuto.Settings.IsPro1)
                          {
                            flag11 = true;
                            if (this.Settings.cboABMenuID == 0 && this.Settings.cboABMaps == -1 || this.Myself.NhiemVuPosX == 0 && this.Myself.NhiemVuPosY == 0)
                            {
                              if (this.Myself.Menpai == AllEnums.Menpais.MODUNG)
                              {
                                this.Settings.cboABMenuID = 808043;
                                this.Settings.cboABMaps = 195;
                                this.CallSetUpNhiemVuData(29, 137);
                              }
                              else if (this.Myself.Menpai == AllEnums.Menpais.THIEULAM)
                              {
                                this.Settings.cboABMenuID = 808027;
                                this.Settings.cboABMaps = 9;
                                this.CallSetUpNhiemVuData(95, 137);
                              }
                              else if (this.Myself.Menpai == AllEnums.Menpais.TINHTUC)
                              {
                                this.Settings.cboABMenuID = 808028;
                                this.Settings.cboABMaps = 16 /*0x10*/;
                                this.CallSetUpNhiemVuData(96 /*0x60*/, 152);
                              }
                              else if (this.Myself.Menpai == AllEnums.Menpais.VODANG)
                              {
                                this.Settings.cboABMenuID = 808033;
                                this.Settings.cboABMaps = 12;
                                this.CallSetUpNhiemVuData(103, 140);
                              }
                              else if (this.Myself.Menpai == AllEnums.Menpais.THIENSON)
                              {
                                this.Settings.cboABMenuID = 808030;
                                this.Settings.cboABMaps = 17;
                                this.CallSetUpNhiemVuData(95, 120);
                              }
                              else if (this.Myself.Menpai == AllEnums.Menpais.MINHGIAO)
                              {
                                this.Settings.cboABMenuID = 808031;
                                this.Settings.cboABMaps = 11;
                                this.CallSetUpNhiemVuData(98, 167);
                              }
                              else if (this.Myself.Menpai == AllEnums.Menpais.NGAMI)
                              {
                                this.Settings.cboABMenuID = 808034;
                                this.Settings.cboABMaps = 15;
                                this.CallSetUpNhiemVuData(89, 144 /*0x90*/);
                              }
                              else if (this.Myself.Menpai == AllEnums.Menpais.TIEUDAO)
                              {
                                this.Settings.cboABMenuID = 808016;
                                this.Settings.cboABMaps = 14;
                                this.CallSetUpNhiemVuData(68, 144 /*0x90*/);
                              }
                              else if (this.Myself.Menpai == AllEnums.Menpais.THIENLONG)
                              {
                                this.Settings.cboABMenuID = 808029;
                                this.Settings.cboABMaps = 13;
                                this.CallSetUpNhiemVuData(96 /*0x60*/, 120);
                              }
                              else if (this.Myself.Menpai == AllEnums.Menpais.DUONGMON)
                              {
                                this.Settings.cboABMenuID = 808044;
                                this.Settings.cboABMaps = 521;
                                this.CallSetUpNhiemVuData(126, 69);
                              }
                              else if (this.Myself.Menpai == AllEnums.Menpais.CAIBANG)
                              {
                                this.Settings.cboABMenuID = 808032;
                                this.Settings.cboABMaps = 10;
                                this.CallSetUpNhiemVuData(91, 116);
                              }
                            }
                            if (this.Myself.MapID != this.Settings.cboABMaps && !GA.IsInPhuBan(this.Myself.MapID, this))
                            {
                              if (this.Myself.NhiemVuPosX > 0 && this.Myself.NhiemVuPosY > 0)
                              {
                                ++this.Myself.actionCounter;
                                if (this.Myself.actionCounter == 1)
                                  GA.TrieuTapToMyPos(this, this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY, this.Settings.cboABMaps);
                                else if (this.Myself.actionCounter >= 5)
                                  this.Myself.actionCounter = 0;
                                this.GoToMyPos(this.Myself.NhiemVuPosX, this.Myself.NhiemVuPosY, this.Settings.cboABMaps);
                              }
                            }
                            else if (this.Myself.actionCounter == 0)
                            {
                              ++this.Myself.actionCounter;
                              GA.TrieuTapCaNhom(this, true);
                            }
                            if (this.Settings.cboABMaps != -1 && this.Settings.cboABMenuID != 0)
                              this.PhuBanATAB(this.Settings.cboABMaps, this.Settings.cboABMenuID, 0, frmLogin.GAuto.Settings.AcBaNames);
                          }
                          else if (this.Myself.IsLinhThu && frmLogin.GAuto.Settings.IsPro1)
                          {
                            flag11 = true;
                            if (this.Myself.MapID != 158 && !GA.IsInPhuBan(this.Myself.MapID, this))
                            {
                              int num10 = 275;
                              int num11 = 292;
                              int num12 = 0;
                              int NPCID = 148;
                              int menuTypeID = 400963;
                              int menuIndex = 1;
                              ++this.Myself.actionCounter;
                              if (this.Myself.actionCounter == 1)
                                GA.TrieuTapToMyPos(this, num10, num11, num12);
                              else if (this.Myself.actionCounter >= 4)
                                this.Myself.actionCounter = 0;
                              if (this.GoToMyPos(num10, num11, num12))
                              {
                                this.Myself.PhoBanTheoSau = this.ForcePartyFollow();
                                if (!this.Myself.PhoBanTheoSau)
                                {
                                  GA.TrieuTapCaNhom(this, true);
                                  long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                                  long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                                  while (this.IsAIEnabled)
                                  {
                                    bool flag12 = this.CheckMemberDistance(6.0);
                                    if (!flag12)
                                      elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                                    if (flag12)
                                      this.Myself.PhoBanTheoSau = this.ForcePartyFollow();
                                    Thread.Sleep(500);
                                    if (this.Myself.PhoBanTheoSau)
                                    {
                                      Thread.Sleep(1500);
                                      break;
                                    }
                                    if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 > 15000L)
                                    {
                                      this.ForcePartyFollow();
                                      this.Myself.PhoBanTheoSau = true;
                                      break;
                                    }
                                    if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 > 10000L)
                                    {
                                      GA.TrieuTapCaNhom(this, true);
                                      elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                                      string waitForTeamMembers = frmMain.langWaitForTeamMembers;
                                      if (this.Myself.LogString != waitForTeamMembers)
                                      {
                                        GA.WriteUserLog(waitForTeamMembers, this);
                                        this.Myself.LogString = waitForTeamMembers;
                                      }
                                    }
                                  }
                                }
                                if (this.Myself.PhoBanTheoSau)
                                {
                                  this.CallTalkNPC(0, 0, NPCID);
                                  Thread.Sleep(300);
                                  this.CallTalkNPC(menuTypeID, menuIndex, NPCID);
                                  Thread.Sleep(1500);
                                  if (this.Myself.isMessageBox_Self == 1)
                                    this.CallStartAutoMoveClick();
                                }
                              }
                            }
                            else
                            {
                              if (this.Myself.actionCounter == 0)
                              {
                                ++this.Myself.actionCounter;
                                GA.TrieuTapCaNhom(this, true);
                              }
                              this.NhiemVuLinhThu();
                            }
                          }
                          else if (this.Myself.IsLuyenKim && frmLogin.GAuto.Settings.IsPro1)
                          {
                            this.NhiemVuLuyenKim();
                            flag11 = true;
                          }
                          else if (this.Myself.IsMuaKNB && frmLogin.GAuto.Settings.IsPro2)
                          {
                            this.NhiemVuMuaKNB();
                            flag11 = true;
                          }
                          else if (this.Myself.IsXayDung && frmLogin.GAuto.Settings.IsPro1)
                          {
                            this.NhiemVuXayDung();
                            flag11 = true;
                          }
                          else if (this.Myself.IsTBB && frmLogin.GAuto.Settings.IsPro2)
                          {
                            this.NhiemVuTBB();
                            flag11 = true;
                          }
                          else if (this.Myself.IsTuDuongCon && frmLogin.GAuto.Settings.IsPro2)
                          {
                            this.NhiemVuTuDuongCon();
                            flag11 = true;
                          }
                          else if (this.Myself.IsTKC && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            int cboTkcMaps = this.Settings.cboTKCMaps;
                            if (this.Myself.MapID != cboTkcMaps && !GA.IsInPhuBan(this.Myself.MapID, this))
                            {
                              int num13 = 0;
                              int num14 = 0;
                              int num15 = 0;
                              if (cboTkcMaps == 30)
                              {
                                num13 = 42;
                                num14 = 60;
                                num15 = 30;
                              }
                              if (cboTkcMaps == 24)
                              {
                                num13 = 264;
                                num14 = 42;
                                num15 = 24;
                              }
                              if (cboTkcMaps == 18)
                              {
                                num13 = 272;
                                num14 = 273;
                                num15 = 18;
                              }
                              ++this.Myself.actionCounter;
                              if (this.Myself.actionCounter == 1)
                                GA.TrieuTapToMyPos(this, num13, num14, num15);
                              else if (this.Myself.actionCounter >= 4)
                                this.Myself.actionCounter = 0;
                              this.GoToMyPos(num13, num14, num15);
                            }
                            else
                            {
                              if (this.Myself.actionCounter == 0)
                              {
                                ++this.Myself.actionCounter;
                                GA.TrieuTapCaNhom(this, true);
                              }
                              this.NhiemVuTangKinhCac();
                            }
                          }
                          else if (this.Myself.isDaoBTD && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuDaoBTD();
                          }
                          else if (this.Myself.isBachHoaDuyen && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuBachHoaDuyen();
                          }
                          else if (this.Myself.isQSM && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuSuMon();
                          }
                          else if (this.Myself.IsPHLM && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.PhungHoangLangMo();
                          }
                          else if (this.Myself.IsKyCuoc && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuKyCuoc();
                          }
                          else if (this.Myself.isCauPhuc && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuCauPhuc();
                          }
                          else if (this.Myself.isCauNguyen && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuCauNguyen();
                          }
                          else if (this.Myself.isDoatBaoRuong && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuDoatBaoRuong();
                          }
                          else if (this.Myself.IsCheDo)
                          {
                            flag11 = true;
                            this.NhiemVuCheDo_New();
                          }
                          else if (this.Myself.IsQ1 && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuDietGon();
                          }
                          else if (this.Myself.IsQ2 && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuTruHai();
                          }
                          else if (this.Myself.isTrongHoa && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuTrongHoa();
                          }
                          else if (this.Myself.isBonHoa && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuBonHoa();
                          }
                          else if (this.Myself.isThuHoach && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuThuHoachHoa();
                          }
                          else if (this.Myself.isNhatTuyet && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuNhatTuyet();
                          }
                          else if (this.Myself.isYTO && frmLogin.GAuto.Settings.IsPro2)
                            flag11 = true;
                          else if (this.Myself.isPMP && frmLogin.GAuto.Settings.IsPro2)
                            flag11 = true;
                          else if (this.Myself.isTanThu && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuTanThu();
                          }
                          else if (this.Myself.isDoiKimTamTi && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuDoiKimTamTi();
                          }
                          else if (this.Myself.isDoiChiTonCH && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuDoiChiTonCH();
                          }
                          else if (this.Myself.isThuTaiVanMay && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuThuTaiVanMay();
                          }
                          else if (this.Myself.isThienLongTueHong && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuThienLongTueHong();
                          }
                          else if (this.Myself.isNguHanhPhapThiep && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuNguHanhPhapThiep();
                          }
                          else if (this.Myself.isLoLyHoa && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuLoLyHoa();
                          }
                          else if (this.Myself.isDoiKimTinhThach && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuDoiKimTinhThach();
                          }
                          else if (this.Myself.isBuonDuaHau && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuBuonDuaHau();
                          }
                          else if (this.Myself.isHuyItemNhiemVu && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuHuyItemNhiemVu();
                          }
                          else if (this.Myself.isDoiThoiVang && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuDoiThoiVang();
                          }
                          else if (this.Myself.isDoiLinhHonToaiPhien && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuDoiLinhHonToaiPhien(this.Myself.DoiLinhHonToaiPhienMode);
                          }
                          else if (this.Myself.isDoiPhieuTienVang && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuDoiPhieuTienVang(this.Myself.DoiPhieuTienVangMode);
                          }
                          else if (this.Myself.isDoiThanBinhPhu && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuDoiThanBinhPhu();
                          }
                          else if (this.Myself.isNhanX2EXP && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuNhanX2EXP();
                          }
                          else if (this.Myself.isLLTB && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuLLTamBao();
                          }
                          else if (this.Myself.isThuyLao && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuThuyLao();
                          }
                          else if (this.Myself.isThuBiChienMinh && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuThuBiChienMinh();
                          }
                          else if (this.Myself.isNhanLeBao && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuNhanLeBao();
                          }
                          else if (this.Myself.isNhanBongCauPhuc && frmLogin.GAuto.Settings.IsPro2)
                          {
                            flag11 = true;
                            this.NhiemVuNhanBongCauPhuc();
                          }
                          if (GA.isShitMember())
                          {
                            Random random = new Random();
                            if (random.Next(0, 10000) <= 7000)
                            {
                              random.Next(30, 220);
                              this.Myself.EventString = "";
                            }
                          }
                          int num16 = this.Myself.IsHaiDua ? 1 : 0;
                          if (!flag11)
                            this.Settings.AIMode = AllEnums.AIModes.DANHTUDO;
                        }
                        if (this.IsAIEnabled)
                        {
                          if (this.Settings.cboxKhoangDuoc)
                          {
                            try
                            {
                              for (int index = this.MyBoc.AllBocs.Count - 1; index >= 0; --index)
                              {
                                NewBoc allBoc = this.MyBoc.AllBocs[index];
                                if (allBoc.BocID != 0 && (double) allBoc.PosX != 0.0 && (double) allBoc.PosY != 0.0)
                                {
                                  bool flag13 = false;
                                  if (allBoc.BocType >= 1 && allBoc.BocType <= 10 || allBoc.BocType == 809)
                                  {
                                    if (this.Settings.cboxKhaiKhoang)
                                      flag13 = true;
                                  }
                                  else if (allBoc.BocType >= 101 && allBoc.BocType <= 126 && this.Settings.cboxHaiDuoc)
                                    flag13 = true;
                                  if (flag13)
                                  {
                                    KhoangDuocEntry khoangDuocEntry = new KhoangDuocEntry();
                                    khoangDuocEntry.MapID = this.Myself.MapID;
                                    khoangDuocEntry.PosX = (int) allBoc.PosX;
                                    khoangDuocEntry.PosY = (int) allBoc.PosY;
                                    bool flag14 = false;
                                    foreach (KhoangDuocEntry khoangDuoc in this.Myself.KhoangDuocList)
                                    {
                                      if (khoangDuoc.MapID == khoangDuocEntry.MapID && khoangDuoc.PosX == khoangDuocEntry.PosX && khoangDuoc.PosY == khoangDuocEntry.PosY)
                                      {
                                        flag14 = true;
                                        break;
                                      }
                                    }
                                    if (!flag14)
                                    {
                                      AutoAccount.DisPlayClass disPlayClass = new AutoAccount.DisPlayClass();
                                      this.Myself.KhoangDuocList.Add(khoangDuocEntry);
                                      string path = $"{AppDomain.CurrentDomain.BaseDirectory}log\\{frmLogin.GAuto.Settings.AdminKhoangFile}";
                                      AutoAccount.DisPlayClass arg_73AD_0 = disPlayClass;
                                      string format = "{0},{1},{2},{3}";
                                      object[] objArray = new object[4]
                                      {
                                        (object) this.Myself.MapID.ToString(),
                                        (object) allBoc.PosX.ToString("0"),
                                        (object) allBoc.PosY.ToString("0"),
                                        (object) allBoc.BocType.ToString("0")
                                      };
                                      arg_73AD_0.log = string.Format(format, objArray);
                                      StreamWriter streamWriter = File.AppendText(path);
                                      if (streamWriter != null)
                                      {
                                        try
                                        {
                                          frmMain.frmMainInstance.richLog.Invoke((Delegate) (() =>
                                          {
                                            frmMain.frmMainInstance.richLog.AppendText(arg_73AD_0.log + "\r\n");
                                            frmMain.frmMainInstance.richLog.SelectionStart = frmMain.frmMainInstance.richLog.Text.Length;
                                            frmMain.frmMainInstance.richLog.ScrollToCaret();
                                          }));
                                        }
                                        catch (Exception ex)
                                        {
                                        }
                                        streamWriter.WriteLine(arg_73AD_0.log);
                                        streamWriter.Close();
                                      }
                                    }
                                  }
                                }
                              }
                            }
                            catch (Exception ex)
                            {
                            }
                          }
                        }
                        if (this.IsAIEnabled && this.Settings.cboxATAB && this.MyQuai.AllQuai.Count > 0)
                        {
                          for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
                          {
                            QuaiIndividual quaiIndividual = this.MyQuai.AllQuai[index];
                            if ((double) quaiIndividual.PosX != 0.0 && (double) quaiIndividual.PosY != 0.0 && !string.IsNullOrEmpty(quaiIndividual.Name) && (quaiIndividual.Name.ToLower() == "ác tặc tạo phản" || quaiIndividual.Name.ToLower() == "giang hồ tà đạo" || quaiIndividual.Name.ToLower() == "tà đạo lâu la" || quaiIndividual.Name.ToLower() == "ác bá" || quaiIndividual.Name.ToLower() == "lâu la" || quaiIndividual.Name.ToLower() == "niên thú" || quaiIndividual.Name.ToLower() == "kỳ lân" || quaiIndividual.Name.ToLower() == "anh chiêu" || quaiIndividual.Name.ToLower() == "long quy" || quaiIndividual.Name.ToLower() == "hoàng điểu" || quaiIndividual.Name.ToLower() == "mô kim hiệu úy" || quaiIndividual.Name.ToLower() == "shishimai" || quaiIndividual.Name.ToLower() == "kylin" || quaiIndividual.Name.ToLower() == "pegasus" || quaiIndividual.Name.ToLower() == "tarasque" || quaiIndividual.Name.ToLower() == "phoenix"))
                            {
                              KhoangDuocEntry khoangDuocEntry = new KhoangDuocEntry();
                              khoangDuocEntry.MapID = this.Myself.MapID;
                              khoangDuocEntry.PosX = (int) quaiIndividual.PosX;
                              khoangDuocEntry.PosY = (int) quaiIndividual.PosY;
                              khoangDuocEntry.NPCName = quaiIndividual.Name;
                              khoangDuocEntry.NPCID = quaiIndividual.ID;
                              bool flag15 = false;
                              foreach (KhoangDuocEntry khoangDuoc in this.Myself.KhoangDuocList)
                              {
                                if (khoangDuoc.MapID == khoangDuocEntry.MapID && khoangDuoc.PosX == khoangDuocEntry.PosX && khoangDuoc.PosY == khoangDuocEntry.PosY && khoangDuoc.NPCName == khoangDuocEntry.NPCName)
                                {
                                  flag15 = true;
                                  break;
                                }
                                if (khoangDuoc.MapID == khoangDuocEntry.MapID && khoangDuoc.NPCID == khoangDuocEntry.NPCID)
                                {
                                  flag15 = true;
                                  break;
                                }
                              }
                              if (!flag15)
                              {
                                this.Myself.KhoangDuocList.Add(khoangDuocEntry);
                                string str = $"{AppDomain.CurrentDomain.BaseDirectory}log\\{frmLogin.GAuto.Settings.AdminNPCFile}";
                              }
                            }
                          }
                        }
                        bool flag16 = true;
                        if (this.ScriptEngine.IsOn && this.ScriptEngine.Script != null)
                        {
                          List<int> intList1 = new List<int>();
                          List<int> intList2 = new List<int>();
                          if (this.ScriptEngine2 != null)
                          {
                            GScriptEngine gscriptEngine1 = this.ScriptEngine;
                            GScriptEngine gscriptEngine2 = this.ScriptEngine2;
                            if (!this.IsMainScript)
                            {
                              GScriptEngine gscriptEngine3 = gscriptEngine2;
                              gscriptEngine2 = gscriptEngine1;
                              gscriptEngine1 = gscriptEngine3;
                            }
                            for (int index = 1; index < 10; ++index)
                            {
                              object option = gscriptEngine2.Script.GetOption("mapid" + index.ToString());
                              if (option != null)
                              {
                                int num17 = (int) option;
                                intList1.Add(num17);
                              }
                              else
                                break;
                            }
                            for (int index = 1; index < 10; ++index)
                            {
                              object option = gscriptEngine1.Script.GetOption("mapid" + index.ToString());
                              if (option != null)
                              {
                                int num18 = (int) option;
                                intList2.Add(num18);
                              }
                              else
                                break;
                            }
                          }
                          if (this.IsMainScript)
                          {
                            if (intList1.Contains(this.Myself.MapID))
                            {
                              this.Myself.TargetX = 0.0f;
                              this.Myself.TargetY = 0.0f;
                              this.Myself.Status = AllEnums.CharStatuses.IDLE;
                              this.SwapScriptEngine();
                              Thread.Sleep(3000);
                              lock (this.Myself.JustWarpedLock)
                              {
                                this.Myself.JustWarped = true;
                                this.Myself.WarpStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                                this.Myself.JustWarpedStamp.Reset();
                                this.Myself.JustWarpedStamp.Start();
                                this.SetJustWarpedFlag(1);
                                goto label_1076;
                              }
                            }
                            object option = this.ScriptEngine.Script.GetOption("ptfollow");
                            if (option != null)
                            {
                              bool result = false;
                              bool.TryParse(option.ToString(), out result);
                              if (this.MyParty.PartyNumbers > 0 && result)
                                flag16 = this.ForcePartyFollow();
                            }
                          }
                          else if (!this.IsMainScript)
                          {
                            if (intList2.Contains(this.Myself.MapID))
                            {
                              this.ScriptEngine.Reset();
                              this.SwapScriptEngine();
                              Thread.Sleep(3000);
                              lock (this.Myself.JustWarpedLock)
                              {
                                this.Myself.JustWarped = true;
                                this.Myself.WarpStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                                this.Myself.JustWarpedStamp.Reset();
                                this.Myself.JustWarpedStamp.Start();
                                this.SetJustWarpedFlag(1);
                                goto label_1076;
                              }
                            }
                            if (this.Myself.IsPartyFollowed == (byte) 1)
                              this.CallRemovePartyFollow();
                          }
                        }
                        if (this.ScriptEngine.IsOn && this.ScriptEngine.Script != null && flag16 && this.Myself.LastScriptStamp.ElapsedMilliseconds >= 1000L)
                        {
                          this.Myself.LastScriptStamp.Reset();
                          this.Myself.LastScriptStamp.Start();
                          if (this.ScriptEngine.Script.Count > 0 && this.ScriptEngine.CanCallCurrent)
                          {
                            GScriptCommand cmd;
                            if (this.ScriptEngine.SingleCommand != null)
                            {
                              if (this.ScriptEngine.SingleCommand.Status == AllEnums.ScriptStatuses.FINISHED)
                              {
                                this.ScriptEngine.SingleCommand = (GScriptCommand) null;
                                cmd = this.ScriptEngine.GetCurrentCommand();
                              }
                              else
                                cmd = this.ScriptEngine.SingleCommand;
                            }
                            else
                              cmd = this.ScriptEngine.GetCurrentCommand();
                            if (cmd != null && cmd.Status == AllEnums.ScriptStatuses.FINISHED)
                            {
                              if (this.ScriptEngine.CanCallNext)
                              {
                                this.ScriptEngine.IndexInc();
                              }
                              else
                              {
                                int num19 = -1;
                                object option = this.ScriptEngine.Script.GetOption("REPEAT");
                                if (option != null)
                                  num19 = (int) option;
                                if (num19 == -1 || num19 > 0 && this.ScriptEngine.RunTimes < num19)
                                  this.ScriptEngine.Reset();
                              }
                              cmd = this.ScriptEngine.GetCurrentCommand();
                            }
                            bool flag17 = false;
                            if (cmd.Status != AllEnums.ScriptStatuses.FINISHED)
                              flag17 = true;
                            if (!flag17 && this.ScriptEngine.Index == 0 && cmd.Status != AllEnums.ScriptStatuses.FINISHED)
                              flag17 = true;
                            if (!flag17 && this.ScriptEngine.SingleCommand != null && this.ScriptEngine.SingleCommand.Status != AllEnums.ScriptStatuses.FINISHED)
                              flag17 = true;
                            if (flag17)
                            {
                              cmd.Status = AllEnums.ScriptStatuses.RUNNING;
                              this.ScriptEngine.CurrentCommand = cmd;
                              switch (cmd.Command.ToLower())
                              {
                                case "moveto":
                                case "move":
                                case "dichuyen":
                                  this.MoveToScript(cmd);
                                  break;
                                case "gotobang":
                                  this.GoToBang(cmd);
                                  break;
                                case "getthanhbangid":
                                  this.GetThanhBangID(cmd);
                                  break;
                                case "playsound":
                                  string soundLocation = "event.wav";
                                  if (cmd.Params.Count > 0)
                                    soundLocation = "alert.wav";
                                  try
                                  {
                                    new SoundPlayer(soundLocation).Play();
                                  }
                                  catch (Exception ex)
                                  {
                                  }
                                  cmd.Status = AllEnums.ScriptStatuses.FINISHED;
                                  break;
                                case "pickallboc":
                                  this.PickAllBoc(cmd);
                                  break;
                                case "portalconfirm":
                                  if (this.Myself.isAcceptBox == 1)
                                  {
                                    this.CallSendPortalConfirmationClick();
                                    break;
                                  }
                                  Thread.Sleep(500);
                                  cmd.Status = AllEnums.ScriptStatuses.FINISHED;
                                  break;
                                case "unmount":
                                  if (this.Myself.HorseType != -1)
                                    this.CallMounting();
                                  cmd.Status = AllEnums.ScriptStatuses.FINISHED;
                                  break;
                                case "mount":
                                  if (this.Myself.HorseType == -1)
                                    this.CallMounting();
                                  cmd.Status = AllEnums.ScriptStatuses.FINISHED;
                                  break;
                                case "haiduoc":
                                case "khaikhoang":
                                  this.MoveHaiDuocScript(cmd);
                                  break;
                                case "ptfollow":
                                  if (this.ForcePartyFollow())
                                  {
                                    cmd.Status = AllEnums.ScriptStatuses.FINISHED;
                                    break;
                                  }
                                  break;
                                case "removeptfollow":
                                  if (this.Myself.IsPartyFollowed == (byte) 1)
                                    this.CallRemovePartyFollow();
                                  cmd.Status = AllEnums.ScriptStatuses.FINISHED;
                                  break;
                                case "delay":
                                case "sleep":
                                  if (cmd.Params.Count > 0)
                                  {
                                    int result = 0;
                                    int.TryParse(cmd.Params[0].ToString(), out result);
                                    Thread.Sleep(result);
                                  }
                                  cmd.Status = AllEnums.ScriptStatuses.FINISHED;
                                  break;
                                case "wait":
                                  break;
                                case "movetalknpc":
                                  this.MoveTalkNPCScript(cmd);
                                  break;
                                case "nhanquestduahau":
                                  this.NhanQuestDuaHau(cmd, this.Myself.DuaNPCID);
                                  break;
                                case "movetalknpcname":
                                  this.MoveTalkNPCByNameScript(cmd);
                                  break;
                                case "moveattack":
                                  this.MoveAttackScript(cmd);
                                  break;
                                default:
                                  cmd.Status = AllEnums.ScriptStatuses.FINISHED;
                                  break;
                              }
                            }
                          }
                        }
                        if (this.IsAIEnabled && this.Myself.Status == AllEnums.CharStatuses.DUNGPHUDIVE)
                        {
                          if (this.Myself.MapID == this.Myself.dungphudiveMapID)
                          {
                            this.Myself.Status = AllEnums.CharStatuses.IDLE;
                            this.CallMoveFlashPos((int) this.Myself.PosX, (int) this.Myself.PosY);
                            this.Myself.dungphudiveMapID = -1;
                            this.Myself.dungphudivePosX = -1;
                            this.Myself.dungphudivePosY = -1;
                          }
                          else if (!this.DungPhuWithMap(this.Myself.dungphudiveMapID))
                          {
                            if (this.Myself.dungphudivePosX > 0 && this.Myself.dungphudivePosY > 0)
                            {
                              this.Myself.Status = AllEnums.CharStatuses.IDLE;
                              if (GA.IsInPhuBan(this.Myself.MapID, this))
                              {
                                this.CallLenNgua();
                                this.CallMoveFlashPos(this.Myself.dungphudivePosX, this.Myself.dungphudivePosY);
                              }
                              else
                                this.CallOutMapMove(this.Myself.dungphudivePosX, this.Myself.dungphudivePosY, this.Myself.dungphudiveMapID);
                              this.Myself.dungphudiveMapID = -1;
                              this.Myself.dungphudivePosX = -1;
                              this.Myself.dungphudivePosY = -1;
                            }
                          }
                          else
                          {
                            this.Myself.Status = AllEnums.CharStatuses.IDLE;
                            this.Myself.dungphudiveMapID = -1;
                            this.Myself.dungphudivePosX = -1;
                            this.Myself.dungphudivePosY = -1;
                          }
                        }
                        if (this.Settings.ListItemToUse.Count > 0)
                        {
                          try
                          {
                            List<int> intList = new List<int>();
                            for (int index = 0; index < this.Settings.ListItemToUse.Count; ++index)
                            {
                              long lastUseStamp = this.Settings.ListItemToUse[index].LastUseStamp;
                              int delaySeconds = this.Settings.ListItemToUse[index].DelaySeconds;
                              if (frmLogin.GlobalTimer.ElapsedMilliseconds - lastUseStamp >= (long) (delaySeconds * 1000))
                                intList.Add(index);
                            }
                            if (intList.Count > 0)
                            {
                              for (int index7 = 0; index7 < intList.Count; ++index7)
                              {
                                int index8 = intList[index7];
                                string name = this.Settings.ListItemToUse[index8].Name;
                                for (int index9 = 0; index9 < 30; ++index9)
                                {
                                  if (string.Compare(this.MyInventory.AllItems[index9].ItemName, name, true) == 0)
                                  {
                                    this.CallUseItem(index9, this.Myself.ID);
                                    break;
                                  }
                                }
                                this.Settings.ListItemToUse[index8].LastUseStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                              }
                            }
                          }
                          catch (Exception ex)
                          {
                            GA.WriteUserLog(frmMain.langErrorUseItemDelay, this);
                          }
                        }
                      }
                    }
                  }
label_1076:
                  if (this.Myself.IsPKStamp.ElapsedMilliseconds >= 2000L)
                  {
                    this.Myself.IsPKStamp.Reset();
                    this.Myself.IsPKStamp.Start();
                    this.Myself.PreviousIsPK = this.Myself.IsPK;
                  }
                  if (this.Myself.NotTransitioningStamp.ElapsedMilliseconds >= 1000L)
                  {
                    this.Myself.NotTransitioningStamp.Reset();
                    this.Myself.NotTransitioningStamp.Start();
                    if (this.Myself.isSceneTrans == 1)
                      this.Myself.prevNotTransitioning = this.Myself.isSceneTrans;
                  }
                  if (this.Myself.JustWarped)
                    this.Myself.PathHistory.Clear();
                  if (this.Myself.MovingDirectionStamp.ElapsedMilliseconds >= 2000L && !this.Myself.JustWarped)
                  {
                    MovingPoint movingPoint = (MovingPoint) null;
                    if (this.Myself.PathHistory.Count > 0)
                      movingPoint = this.Myself.PathHistory.MovingPoints[this.Myself.PathHistory.Count - 1];
                    double num = 2.0;
                    if (movingPoint != null)
                      num = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) movingPoint.X, (double) movingPoint.Y);
                    if (num >= 1.0)
                      this.Myself.PathHistory.AddPoint(new MovingPoint()
                      {
                        X = this.Myself.PosX,
                        Y = this.Myself.PosY,
                        TimeStamp = frmLogin.GlobalTimer.ElapsedMilliseconds
                      });
                    this.Myself.MovingDirectionStamp.Reset();
                    this.Myself.MovingDirectionStamp.Start();
                  }
                  if (this.Myself.PartyFollowStamp.ElapsedMilliseconds >= 2000L)
                  {
                    this.Myself.PartyFollowStamp.Reset();
                    this.Myself.PartyFollowStamp.Start();
                    this.Myself.PreviousIsPartyFollowed = (int) this.Myself.IsPartyFollowed;
                  }
                }
                if (!this.MyFlag.IsInGame)
                {
                  if (this.MyFlag.NeedAutoLogin)
                  {
                    if ((this.Target.VersionNum != 3 || this.Target.SubVersion != 4 && this.Target.SubVersion != 6 || frmLogin.TKServers.Count <= 0) && (this.Target.VersionNum != 3 || this.Target.SubVersion == 4) && (this.Target.VersionNum != 1 && this.Target.VersionNum != 2 || frmLogin.VNGServers.Count <= 0))
                    {
                      if (this.Target.VersionNum == 4)
                      {
                        if (frmLogin.TLUSServers.Count <= 0)
                          goto label_1105;
                      }
                      else
                        goto label_1105;
                    }
                    this.HandleGLogin();
                  }
                }
              }
            }
          }
        }
        catch (Exception ex)
        {
          if (ex.Message == "Thread was being aborted.")
          {
            if (GA.isVipMember())
              GA.WriteUserLog("Thread abort, không quan tâm", this);
          }
          else
            GA.WriteUserLog($"{frmMain.langAIError}{this.Target.NeedToAbort.ToString()}/{this.Target.NeedToAbort2.ToString()}/{this.Target.NeedToAbort3.ToString()} id: {this.Target.NeedToAbort4.ToString()} Message: {ex.Message}\n{ex.StackTrace}", this);
          this.Myself.Status = AllEnums.CharStatuses.IDLE;
        }
label_1105:
        Thread.Sleep(frmLogin.GAuto.Settings.numDelayTrue + 80 /*0x50*/);
      }
      else
        break;
    }
    this.MyFlag.EndAI = true;
  }

  public static void CreatePseudo(AutoAccount account)
  {
    if (account.Target.CyberPseudoStamp == 0L)
      account.Target.CyberPseudoStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    if (account.Target.CyberRandom == 0L)
      account.Target.CyberRandom = (long) GA.random.Next(170000, 500000);
    if (frmLogin.GlobalTimer.ElapsedMilliseconds - account.Target.CyberPseudoStamp < account.Target.CyberRandom)
      return;
    byte[] buffer = new byte[GA.random.Next(5, 25)];
    GA.random.NextBytes(buffer);
    int lpBaseAddress = GA.random.Next(4214963, 4216788);
    int size = 15;
    MyDLL.WriteProcessMemory(account.Target.ProcessHandle, (IntPtr) lpBaseAddress, buffer, (uint) size, 0);
    account.Target.CyberRandom = (long) GA.random.Next(30000, 60000);
    ++account.Target.CyberPseudoSent;
  }

  private void PhucHoiSkillNM()
  {
    if (this.Myself.Status != AllEnums.CharStatuses.NMBUFFMAU)
      return;
    int num = 1200;
    if (this.Settings.NgaMiSkillBuffID == 407)
      num = 4200;
    if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.NMSkillStamp < (long) num)
      return;
    this.Myself.Status = AllEnums.CharStatuses.IDLE;
  }

  private void ResetJustWarped()
  {
    if (!this.Myself.JustWarped || this.Myself.JustWarpedStamp.ElapsedMilliseconds < 3000L || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.isSceneTransStamp < 3000L || this.Myself.isSceneTrans != 0)
      return;
    this.Myself.JustWarped = false;
    this.Myself.LastPostStamp.Reset();
    this.Myself.LastPostStamp.Start();
    this.SetJustWarpedFlag();
    this.Myself.LastPostStamp.Reset();
    this.Myself.LastPostStamp.Start();
  }

  private void AutoAcceptPTInvite()
  {
    if (!frmLogin.GAuto.Settings.IsPro1 || this.MyParty.PTAskDBAsker == 0 || !(this.MyParty.PTAskName != ""))
      return;
    bool flag1 = false;
    if (this.Settings.PTBlacklist.Contains(this.MyParty.PTAskName))
    {
      flag1 = true;
      this.CallKhongChoVaoPT();
    }
    if (!flag1)
    {
      bool flag2 = false;
      if (this.Settings.cboxPTLevel && this.MyParty.PTAskLevel >= this.Settings.numPTLevel)
        flag2 = true;
      if (this.MyParty.PTAskName != "" && !flag2 && this.Settings.cboxPTChoVao && this.Settings.AutoPartyList.Contains(this.MyParty.PTAskName))
        flag2 = true;
      if (frmLogin.GAuto.AllAutoAccounts.Count > 1)
      {
        try
        {
          for (int index = frmLogin.GAuto.AllAutoAccounts.Count - 1; index >= 0; --index)
          {
            if (this.MyParty.PTAskDBAsker == frmLogin.GAuto.AllAutoAccounts[index].Myself.DatabaseID)
            {
              flag2 = true;
              break;
            }
          }
        }
        catch (Exception ex)
        {
          GA.WriteUserLog(frmMain.langErrorAcceptPT, this);
        }
      }
      if (!flag2)
        this.CallKhongChoVaoPT();
      else if (this.MyParty.PTAskSequence == -1 && this.Target.VersionNum != 3 && this.Target.VersionNum != 4)
      {
        this.CallSendAcceptPTAsk(2, 0);
      }
      else
      {
        GA.WriteUserLog(frmMain.langAcceptPT2, this, (object) this.MyParty.PTAskName, (object) this.MyParty.PTAskLevel);
        this.CallChoVaoPT();
      }
    }
    else
      this.CallKhongChoVaoPT(true);
  }

  public void PhuBanATAB(int mapngoai, int menuid, int menuindex, List<string> tenNPC, int CAt = -1)
  {
    if (this.isInDiaPhu())
    {
      this.CallRemovePartyFollow();
      this.CallMoveTo(12, 24);
    }
    else
    {
      bool flag1 = false;
      if (this.Myself.HPPercent > 0.0)
        flag1 = true;
      if (!flag1 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LuyenKimStamp < 100L)
        return;
      this.Myself.LuyenKimStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
      if (this.Myself.actionCounter == 0)
      {
        ++this.Myself.actionCounter;
        GA.TrieuTapCaNhom(this, true);
      }
      if (this.Myself.MapID == mapngoai)
      {
        GA.PartyDoSomething(this, mode: 11);
        if (this.Myself.OutMapPathPoints.Count == 0)
        {
          int num = 1;
          foreach (KhoangDuocDBElement khoangDuocDbElement in frmLogin.GAuto.KhoangDuocDB)
          {
            if (khoangDuocDbElement.MapID == mapngoai)
              this.Myself.OutMapPathPoints.Add(new InMapPoint()
              {
                Arrived = false,
                Cleared = false,
                MapID = mapngoai,
                PosX = khoangDuocDbElement.PosX,
                PosY = khoangDuocDbElement.PosY,
                STT = num
              });
          }
          this.CalcNearPointForOutMap();
          this.Myself.InMapPathPoints.Clear();
          this.Myself.InPathPointIndex = 0;
        }
        if (this.Myself.MapID == this.Myself.PhoBanSavedMapID && this.Myself.PhoBanVaoMap)
          frmMain.ResetPhoBan(this);
        if (this.Myself.OutMapPathPoints.Count > 0 && !this.Myself.PhoBanVaoMap)
        {
          if (this.Myself.IsPHLM && this.Myself.previousMapID_2 == 420 && this.Myself.OutMapPathPoints.Count > 0)
          {
            double num = 500.0;
            int X = 0;
            int Y = 0;
            for (int index = this.Myself.OutMapPathPoints.Count - 1; index >= 0; --index)
            {
              int posX = this.Myself.OutMapPathPoints[index].PosX;
              int posY = this.Myself.OutMapPathPoints[index].PosY;
              double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) posX, (double) posY);
              if (distance < num)
              {
                X = posX;
                Y = posY;
                num = distance;
              }
            }
            this.CallMoveFlashPos(X, Y);
          }
          QuaiIndividual quaiIndividual1 = (QuaiIndividual) null;
          if (this.Myself.HorseType == -1)
          {
            this.CallRemovePartyFollow();
            Thread.Sleep(500);
            this.CallLenNgua();
          }
          this.Myself.PhoBanTheoSau = this.ForcePartyFollow();
          if (!this.Myself.PhoBanTheoSau)
          {
            this.CallMoveTo((int) this.Myself.PosX, (int) this.Myself.PosY);
            GA.TrieuTapCaNhom(this, true);
            long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
            long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
            long elapsedMilliseconds3 = frmLogin.GlobalTimer.ElapsedMilliseconds;
            while (this.IsAIEnabled)
            {
              GA.PartyDoSomething(this, mode: 11);
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 > 10000L)
              {
                this.CallRemovePartyFollow();
                GA.TrieuTapCaNhom(this, true);
                elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                string waitForTeamMembers = frmMain.langWaitForTeamMembers;
                if (this.Myself.LogString != waitForTeamMembers)
                {
                  GA.WriteUserLog(waitForTeamMembers, this);
                  this.Myself.LogString = waitForTeamMembers;
                }
              }
              Thread.Sleep(500);
              bool flag2 = this.CheckMemberDistance(7.0);
              if (!flag2)
                elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
              if (flag2)
              {
                this.Myself.previousMapID_2 = -1;
                this.Myself.PhoBanTheoSau = this.ForcePartyFollow();
              }
              if (!this.Myself.PhoBanTheoSau)
              {
                if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 > 4000L || frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds3 > 180000L)
                {
                  this.ForcePartyFollow();
                  this.Myself.PhoBanTheoSau = true;
                  break;
                }
                if (this.IsPartyKeyInt() != 2)
                  break;
              }
              else
                break;
            }
          }
          if (this.Myself.HPPercent > 0.0 && !this.Myself.JustWarped)
          {
            if (this.MyQuai.AllQuai.Count > 0)
            {
              try
              {
                double num = 300.0;
                for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
                {
                  QuaiIndividual quaiIndividual2 = this.MyQuai.AllQuai[index];
                  if (quaiIndividual2 != null && quaiIndividual2.Name != "")
                  {
                    bool flag3 = false;
                    foreach (string strB in tenNPC)
                    {
                      if ((string.Compare(quaiIndividual2.Name, strB, true) == 0 || quaiIndividual2.IsBossValue == 549 && this.Myself.IsTKC || quaiIndividual2.IsBossValue == 473 && this.Myself.IsAcTac || quaiIndividual2.IsBossValue == 486) && !quaiIndividual2.Name.Contains("ười chỉ"))
                      {
                        flag3 = true;
                        break;
                      }
                    }
                    bool flag4 = CAt == -1 || (int) quaiIndividual2.CanAttack == CAt;
                    if (flag3 && flag4)
                    {
                      double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quaiIndividual2.PosX, (double) quaiIndividual2.PosY);
                      if (distance < num)
                      {
                        quaiIndividual1 = quaiIndividual2;
                        num = distance;
                      }
                    }
                  }
                }
              }
              catch (Exception ex)
              {
              }
            }
            if (quaiIndividual1 == null && this.Myself.OutMapPathPoints.Count > 0)
            {
              if (this.Myself.IsAcBa)
              {
                if (!this.Settings.cboxABChayTim)
                  goto label_94;
              }
              try
              {
                bool flag5 = true;
                if (this.Settings.cboxChoParty)
                  flag5 = this.CheckMemberDistance(40.0, true);
                if (!flag5)
                {
                  int posX = (int) this.Myself.PosX;
                  int posY = (int) this.Myself.PosY;
                  this.CallMoveTo(posX, posY);
                  Thread.Sleep(1000);
                  this.CallRemovePartyFollow();
                  Thread.Sleep(1000);
                  GA.TrieuTapToMyPos(this, posX, posY, this.Myself.MapID);
                }
                else
                {
                  if (this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Cleared)
                  {
                    ++this.Myself.OutPathPointIndex;
                    if (this.Myself.OutPathPointIndex >= this.Myself.OutMapPathPoints.Count)
                    {
                      for (int index = 0; index < this.Myself.OutMapPathPoints.Count; ++index)
                      {
                        this.Myself.OutMapPathPoints[index].Cleared = false;
                        this.Myself.OutMapPathPoints[index].Arrived = false;
                      }
                      this.Myself.MyLastOutStamp = 0L;
                      this.Myself.OutPathPointIndex = 0;
                    }
                    int posX1 = (int) this.Myself.PosX;
                    int posY1 = (int) this.Myself.PosY;
                    if (this.Myself.OutPathPointIndex >= 0 && this.Myself.OutPathPointIndex < this.Myself.OutMapPathPoints.Count && !this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Arrived)
                    {
                      int posX2 = this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].PosX;
                      int posY2 = this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].PosY;
                      double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) posX2, (double) posY2);
                      if (distance > 8.0)
                      {
                        this.CallInMapMove(posX2, posY2, true);
                        this.Myself.MyLastOutStamp = 0L;
                      }
                      if (distance <= 8.0)
                      {
                        this.Myself.MyLastOutStamp = 0L;
                        this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Arrived = true;
                        this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Cleared = true;
                        this.Myself.MyLastOutStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                        this.Myself.Status = AllEnums.CharStatuses.IDLE;
                      }
                    }
                    if (this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Arrived)
                    {
                      ++this.Myself.OutPathPointIndex;
                      if (this.Myself.OutPathPointIndex >= this.Myself.OutMapPathPoints.Count)
                      {
                        for (int index = 0; index < this.Myself.OutMapPathPoints.Count; ++index)
                        {
                          this.Myself.OutMapPathPoints[index].Cleared = false;
                          this.Myself.OutMapPathPoints[index].Arrived = false;
                        }
                        this.Myself.MyLastOutStamp = 0L;
                        this.Myself.OutPathPointIndex = new Random().Next(0, this.Myself.OutMapPathPoints.Count);
                      }
                    }
                  }
                  if (!this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Cleared)
                  {
                    int posX = this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].PosX;
                    int posY = this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].PosY;
                    double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) posX, (double) posY);
                    if (distance > 8.0 && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LastMoveStamp >= 1000L)
                    {
                      this.Myself.LastMoveStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                      this.CallInMapMove(posX, posY, true);
                      this.Myself.MyLastOutStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                    }
                    if (distance <= 8.0)
                      this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Cleared = true;
                  }
                  if (this.Myself.OutMapPathPoints.Count > 0)
                  {
                    if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.MyLastOutStamp >= 4000L)
                    {
                      if (this.Myself.MyLastOutStamp != 0L)
                      {
                        if (this.Myself.OutPathPointIndex >= 0)
                        {
                          if (this.Myself.OutPathPointIndex < this.Myself.OutMapPathPoints.Count)
                            this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Cleared = true;
                        }
                      }
                    }
                  }
                }
              }
              catch (Exception ex)
              {
                GA.WriteUserLog(frmMain.langErrorFindingPath);
                this.Myself.OutPathPointIndex = 0;
              }
            }
          }
label_94:
          if (this.Myself.PhoBanTheoSau && quaiIndividual1 != null)
          {
            if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quaiIndividual1.PosX, (double) quaiIndividual1.PosY) > 3.0)
            {
              this.CallMoveFlashPos((int) quaiIndividual1.PosX, (int) quaiIndividual1.PosY);
              this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
            }
            if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quaiIndividual1.PosX, (double) quaiIndividual1.PosY) <= 3.0)
            {
              frmMain.ResetPhoBan(this);
              this.Myself.Status = AllEnums.CharStatuses.IDLE;
              this.Myself.PhoBanPoint0 = true;
              this.Myself.actionFlag = 1;
              this.Myself.previousMapID = this.Myself.MapID;
              int id = quaiIndividual1.ID;
              this.Myself.PhoBanSavedMapID = this.Myself.MapID;
              if (this.IsInPhai() || this.Myself.IsAcBa)
              {
                this.Myself.PhuBanAB = true;
                this.Myself.PhoBanSavedMapID = this.Settings.cboABMaps;
              }
              if (this.Myself.MapID == 158)
                this.Myself.PhuBanLinhThu = true;
              this.CallTalkNPCByPos(menuid, menuindex, (int) quaiIndividual1.PosX, (int) quaiIndividual1.PosY);
              Thread.Sleep(1000);
              int num = 0;
              long elapsedMilliseconds4 = frmLogin.GlobalTimer.ElapsedMilliseconds;
              long elapsedMilliseconds5 = frmLogin.GlobalTimer.ElapsedMilliseconds;
              long elapsedMilliseconds6 = frmLogin.GlobalTimer.ElapsedMilliseconds;
              int mapId = this.Myself.MapID;
              while (id >= 0)
              {
                Thread.Sleep(500);
                if (GA.IsInPhuBan(this.Myself.MapID, this) || mapId != this.Myself.MapID && this.Myself.MapID > 0)
                {
                  this.Myself.PhoBanVaoMap = true;
                  break;
                }
                if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds4 < 15000L)
                {
                  if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds6 >= 1000L)
                  {
                    elapsedMilliseconds6 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                    bool flag6 = false;
                    if (this.MyQuai.AllQuai.Count > 0)
                    {
                      try
                      {
                        for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
                        {
                          if (this.MyQuai.AllQuai[index].ID == id)
                          {
                            flag6 = true;
                            break;
                          }
                        }
                      }
                      catch (Exception ex)
                      {
                      }
                    }
                    if (!flag6 && mapId == this.Myself.MapID && this.Myself.ID > 0)
                    {
                      this.MyFlag.tempStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                      break;
                    }
                  }
                  if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds5 >= 4000L)
                  {
                    this.CallTalkNPCByPos(menuid, menuindex, (int) quaiIndividual1.PosX, (int) quaiIndividual1.PosY);
                    elapsedMilliseconds5 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                    ++num;
                  }
                  if (num >= 2)
                    break;
                }
                else
                  break;
              }
            }
          }
        }
      }
      if (this.Myself.MapID >= 36 && this.Myself.MapID != 443 && this.Myself.MapID != 158 && !this.isInDiaPhu() && frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.tempStamp <= 10000L && this.MyFlag.tempStamp > 0L)
        this.Myself.PhoBanVaoMap = true;
      if (this.Myself.JustWarped || this.Myself.isSceneTrans == 1 || this.Myself.ID <= 0 || !this.Myself.PhoBanVaoMap && !GA.IsInPhuBan(this.Myself.MapID, this) || (double) this.Myself.PosX <= 0.0 || (double) this.Myself.PosY <= 0.0)
        return;
      if (this.Myself.IsAcBa)
      {
        if (this.IsInPhai() || this.Myself.IsAcBa)
        {
          this.Myself.PhuBanAB = true;
          this.Myself.PhoBanSavedMapID = this.Settings.cboABMaps;
        }
      }
      else if (this.Myself.IsAcTac)
      {
        this.Myself.PhuBanAB = true;
        this.Myself.PhoBanSavedMapID = this.Settings.cboATMaps;
      }
      if (this.Myself.InMapPathPoints.Count <= 0)
      {
        string mapSection = "";
        int mapID = -1;
        if (this.Myself.IsAcTac)
        {
          mapSection = !frmLogin.GAuto.Settings.cboxATRunPP ? "KHONGCO" : "ACTAC";
          mapID = 48 /*0x30*/;
        }
        if (this.Myself.IsAcBa && this.Myself.Menpai == AllEnums.Menpais.NGAMI)
        {
          mapSection = "AB_NGAMY_NEW";
          mapID = 15;
        }
        else
        {
          if (!this.Myself.IsLinhThu)
          {
            foreach (KhoangDuocDBElement khoangDuocDbElement in frmLogin.GAuto.ATABDB)
            {
              if (khoangDuocDbElement.MapID == this.Myself.PhoBanSavedMapID && this.Myself.PhuBanAB || GA.IsInPhuBan(this.Myself.MapID, this) && this.Myself.IsTKC && khoangDuocDbElement.MapID == 1101 || GA.IsInPhuBan(this.Myself.MapID, this) && this.Myself.IsPHLM && khoangDuocDbElement.MapID == 1110)
              {
                this.Myself.InMapPathPoints.Add(new InMapPoint()
                {
                  Arrived = false,
                  Cleared = false,
                  MapID = mapngoai,
                  PosX = khoangDuocDbElement.PosX,
                  PosY = khoangDuocDbElement.PosY,
                  STT = khoangDuocDbElement.STT,
                  Horse = khoangDuocDbElement.Horse
                });
                this.Myself.InPathPointIndex = 0;
              }
            }
            this.Myself.InMapPathPoints.Sort(new Comparison<InMapPoint>(this.PointComparison));
          }
          if (this.Myself.IsLinhThu)
            this.Myself.InMapPathPoints.Add(new InMapPoint()
            {
              Arrived = false,
              Cleared = false,
              MapID = this.Myself.MapID,
              PosX = 89,
              PosY = 66
            });
        }
        if (mapSection != "")
        {
          this.LoadPathPoint(mapSection: mapSection);
          if (this.Myself.InMapPathPoints.Count == 0)
            this.LoadPathPoint(mapID);
        }
        if (this.Myself.previousMapID == -1)
        {
          int num1 = 0;
          if (this.Myself.InMapPathPoints.Count > 0)
          {
            double num2 = 999.0;
            int num3 = 0;
            foreach (InMapPoint inMapPathPoint in this.Myself.InMapPathPoints)
            {
              double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) inMapPathPoint.PosX, (double) inMapPathPoint.PosY);
              if (distance < num2)
              {
                num2 = distance;
                num1 = num3;
              }
              ++num3;
            }
          }
          this.Myself.InPathPointIndex = num1;
        }
        else
          this.Myself.InPathPointIndex = 0;
      }
      if (this.Myself.InMapPathPoints.Count <= 0)
        return;
      if (this.Myself.IsTKC)
      {
        if (this.Myself.QuestStep != 1)
          return;
        this.DanhQuaiPhuBan(this.Myself.MapID, true);
        this.Myself.PhoBanVaoMap = true;
      }
      else
      {
        bool flag7 = true;
        if (this.Myself.InPathPointIndex == 0)
        {
          if (!this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived && this.MyFlag.phubanActionCounter == 0 && !this.Myself.IsLinhThu)
          {
            ++this.MyFlag.phubanActionCounter;
            this.CallPartyFollowMe(30000);
          }
          if (this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived && this.Target.VersionNum == 3 && this.Myself.IsPartyFollowed == (byte) 0)
            GA.PartyDoSomething(this, true, 2, stamp: 60000);
        }
        int index = this.Myself.InMapPathPoints.Count - 1;
        if (this.Myself.InPathPointIndex == index && this.Myself.InMapPathPoints[index].Cleared && this.Target.VersionNum == 3 && this.MyFlag.phubanActionCounter <= 1)
        {
          this.CallXuongNgua();
          GA.PartyDoSomething(this, true, 2, stamp: 60000);
          this.MyFlag.phubanActionCounter += 5;
        }
        if (this.Myself.IsAcTac && this.Myself.InPathPointIndex == 0 && this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Arrived && this.Myself.InMapPathPoints[this.Myself.InPathPointIndex].Cleared)
        {
          flag7 = false;
          int num4 = 112 /*0x70*/;
          int num5 = 48 /*0x30*/;
          double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num4, (double) num5);
          if (distance > 3.0)
            this.CallMoveFlashPos(num4, num5);
          if (distance <= 3.0)
          {
            Thread.Sleep(1000);
            flag7 = true;
          }
        }
        if (flag7)
          this.PhuBanDacBiet(this.Myself.MapID, this.Myself.InPathPointIndex);
        this.Myself.PhoBanVaoMap = true;
      }
    }
  }

  public void TimQuaiPhuBan(
    int mapngoai,
    int menuid,
    int menuindex,
    List<string> tenNPC,
    int CAt = -1)
  {
    bool flag1 = false;
    if (this.Myself.HPPercent > 0.0)
      flag1 = true;
    if (!flag1 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LuyenKimStamp < 300L)
      return;
    this.Myself.LuyenKimStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    if (this.Myself.MapID != mapngoai)
      return;
    if (this.Myself.OutMapPathPoints.Count == 0)
    {
      int num = 1;
      foreach (KhoangDuocDBElement khoangDuocDbElement in frmLogin.GAuto.KhoangDuocDB)
      {
        if (khoangDuocDbElement.MapID == mapngoai)
          this.Myself.OutMapPathPoints.Add(new InMapPoint()
          {
            Arrived = false,
            Cleared = false,
            MapID = mapngoai,
            PosX = khoangDuocDbElement.PosX,
            PosY = khoangDuocDbElement.PosY,
            STT = num
          });
      }
      this.Myself.OutPathPointIndex = new Random().Next(0, this.Myself.OutMapPathPoints.Count);
      this.Myself.InMapPathPoints.Clear();
      this.Myself.InPathPointIndex = 0;
    }
    if (this.Myself.MapID == this.Myself.PhoBanSavedMapID && this.Myself.PhoBanVaoMap)
      frmMain.ResetPhoBan(this);
    if (this.Myself.OutMapPathPoints.Count <= 0 || this.Myself.PhoBanVaoMap)
      return;
    QuaiIndividual quaiIndividual1 = (QuaiIndividual) null;
    if (this.Myself.HorseType == -1)
    {
      this.CallRemovePartyFollow();
      Thread.Sleep(500);
      this.CallLenNgua();
    }
    this.Myself.PhoBanTheoSau = this.ForcePartyFollow();
    if (!this.Myself.PhoBanTheoSau)
    {
      GA.TrieuTapCaNhom(this, true);
      long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
      long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
      long elapsedMilliseconds3 = frmLogin.GlobalTimer.ElapsedMilliseconds;
      while (this.IsAIEnabled)
      {
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 > 10000L)
        {
          this.CallRemovePartyFollow();
          GA.TrieuTapCaNhom(this, true);
          elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
          string waitForTeamMembers = frmMain.langWaitForTeamMembers;
          if (this.Myself.LogString != waitForTeamMembers)
          {
            GA.WriteUserLog(waitForTeamMembers, this);
            this.Myself.LogString = waitForTeamMembers;
          }
        }
        Thread.Sleep(500);
        bool flag2 = this.CheckMemberDistance(7.0);
        if (!flag2)
          elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        if (flag2)
          this.Myself.PhoBanTheoSau = this.ForcePartyFollow();
        if (!this.Myself.PhoBanTheoSau)
        {
          if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 > 4000L || frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds3 > 180000L)
          {
            this.ForcePartyFollow();
            this.Myself.PhoBanTheoSau = true;
            break;
          }
          if (this.IsPartyKeyInt() != 2)
            break;
        }
        else
          break;
      }
    }
    if (this.Myself.HPPercent > 0.0 && !this.Myself.JustWarped)
    {
      if (this.MyQuai.AllQuai.Count > 0)
      {
        try
        {
          double num = 300.0;
          for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
          {
            QuaiIndividual quaiIndividual2 = this.MyQuai.AllQuai[index];
            if (quaiIndividual2.Name != null)
            {
              bool flag3 = false;
              foreach (string strB in tenNPC)
              {
                if (string.Compare(quaiIndividual2.Name, strB, true) == 0 || quaiIndividual2.IsBossValue == 549 && this.Myself.IsTKC || quaiIndividual2.IsBossValue == 473 && this.Myself.IsAcTac || quaiIndividual2.IsBossValue == 486 || quaiIndividual2.IsBossValue >= 13780 && quaiIndividual2.IsBossValue <= 13789)
                {
                  flag3 = true;
                  break;
                }
              }
              bool flag4 = CAt == -1 || (int) quaiIndividual2.CanAttack == CAt;
              if (flag3 && flag4 && GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quaiIndividual2.PosX, (double) quaiIndividual2.PosY) < num)
              {
                quaiIndividual1 = quaiIndividual2;
                break;
              }
            }
          }
        }
        catch (Exception ex)
        {
        }
      }
      if (quaiIndividual1 == null)
      {
        if (this.Myself.OutMapPathPoints.Count > 0)
        {
          try
          {
            if (this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Cleared)
            {
              ++this.Myself.OutPathPointIndex;
              if (this.Myself.OutPathPointIndex >= this.Myself.OutMapPathPoints.Count)
              {
                for (int index = 0; index < this.Myself.OutMapPathPoints.Count; ++index)
                {
                  this.Myself.OutMapPathPoints[index].Cleared = false;
                  this.Myself.OutMapPathPoints[index].Arrived = false;
                }
                this.Myself.MyLastOutStamp = 0L;
                this.Myself.OutPathPointIndex = 0;
              }
              int posX1 = (int) this.Myself.PosX;
              int posY1 = (int) this.Myself.PosY;
              if (this.Myself.OutPathPointIndex >= 0 && this.Myself.OutPathPointIndex < this.Myself.OutMapPathPoints.Count && !this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Arrived)
              {
                int posX2 = this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].PosX;
                int posY2 = this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].PosY;
                double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) posX2, (double) posY2);
                if (distance > 5.0)
                {
                  this.CallInMapMove(posX2, posY2, true);
                  this.Myself.MyLastOutStamp = 0L;
                }
                if (distance <= 5.0)
                {
                  this.Myself.MyLastOutStamp = 0L;
                  this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Arrived = true;
                  this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Cleared = true;
                  this.Myself.MyLastOutStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                  this.Myself.Status = AllEnums.CharStatuses.IDLE;
                }
              }
              if (this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Arrived)
              {
                ++this.Myself.OutPathPointIndex;
                if (this.Myself.OutPathPointIndex >= this.Myself.OutMapPathPoints.Count)
                {
                  for (int index = 0; index < this.Myself.OutMapPathPoints.Count; ++index)
                  {
                    this.Myself.OutMapPathPoints[index].Cleared = false;
                    this.Myself.OutMapPathPoints[index].Arrived = false;
                  }
                  this.Myself.MyLastOutStamp = 0L;
                  this.Myself.OutPathPointIndex = new Random().Next(0, this.Myself.OutMapPathPoints.Count);
                }
              }
            }
            if (!this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Cleared)
            {
              int posX = this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].PosX;
              int posY = this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].PosY;
              double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) posX, (double) posY);
              if (distance > 3.0 && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.LastMoveStamp >= 1000L)
              {
                this.Myself.LastMoveStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                this.CallInMapMove(posX, posY, true);
                this.Myself.MyLastOutStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
              }
              if (distance <= 3.0)
                this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Cleared = true;
            }
            if (this.Myself.OutMapPathPoints.Count > 0)
            {
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.MyLastOutStamp >= 4000L)
              {
                if (this.Myself.MyLastOutStamp != 0L)
                {
                  if (this.Myself.OutPathPointIndex >= 0)
                  {
                    if (this.Myself.OutPathPointIndex < this.Myself.OutMapPathPoints.Count)
                      this.Myself.OutMapPathPoints[this.Myself.OutPathPointIndex].Cleared = true;
                  }
                }
              }
            }
          }
          catch (Exception ex)
          {
            GA.WriteUserLog(frmMain.langErrorFindingPath);
            this.Myself.OutPathPointIndex = 0;
          }
        }
      }
    }
    if (!this.Myself.PhoBanTheoSau || quaiIndividual1 == null)
      return;
    if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quaiIndividual1.PosX, (double) quaiIndividual1.PosY) > 4.0)
    {
      this.CallMoveFlashPos((int) quaiIndividual1.PosX, (int) quaiIndividual1.PosY);
      this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
    }
    if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quaiIndividual1.PosX, (double) quaiIndividual1.PosY) > 4.0)
      return;
    frmMain.ResetPhoBan(this);
    this.Myself.PhoBanPoint0 = true;
    this.Myself.actionFlag = 1;
    this.Myself.previousMapID = this.Myself.MapID;
    int mapId = this.Myself.MapID;
    int id = quaiIndividual1.ID;
    this.Myself.PhoBanSavedMapID = this.Myself.MapID;
    if (this.IsInPhai() || this.Myself.IsAcBa)
    {
      this.Myself.PhuBanAB = true;
      this.Myself.PhoBanSavedMapID = this.Settings.cboABMaps;
    }
    if (this.Myself.MapID == 158)
      this.Myself.PhuBanLinhThu = true;
    this.CallTalkNPCByPos(menuid, menuindex, (int) quaiIndividual1.PosX, (int) quaiIndividual1.PosY);
    Thread.Sleep(1000);
    int num1 = 0;
    long elapsedMilliseconds4 = frmLogin.GlobalTimer.ElapsedMilliseconds;
    long elapsedMilliseconds5 = frmLogin.GlobalTimer.ElapsedMilliseconds;
    long elapsedMilliseconds6 = frmLogin.GlobalTimer.ElapsedMilliseconds;
    while (id >= 0)
    {
      if (GA.IsInPhuBan(this.Myself.MapID, this))
      {
        this.Myself.PhoBanVaoMap = true;
        break;
      }
      Thread.Sleep(500);
      if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds4 >= 15000L)
        break;
      if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds6 >= 1000L)
      {
        elapsedMilliseconds6 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        bool flag5 = false;
        if (this.MyQuai.AllQuai.Count > 0)
        {
          try
          {
            for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
            {
              if (this.MyQuai.AllQuai[index].ID == id)
              {
                flag5 = true;
                break;
              }
            }
          }
          catch (Exception ex)
          {
          }
        }
        if (!flag5 && mapId == this.Myself.MapID)
          break;
      }
      if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds5 >= 4000L)
      {
        this.CallTalkNPCByPos(menuid, menuindex, (int) quaiIndividual1.PosX, (int) quaiIndividual1.PosY);
        elapsedMilliseconds5 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        ++num1;
      }
      if (num1 >= 2)
        break;
    }
  }

  public bool CheckMemberDistance(double distance, bool follow = false)
  {
    if (this.MyParty != null && this.MyParty.AllMembers.Count > 0 && this.MyParty.PartyNumbers > 0)
    {
      if (this.MyParty.PartyNumbers < 6)
      {
        try
        {
          for (int partyNumbers = this.MyParty.PartyNumbers; partyNumbers >= 0; --partyNumbers)
          {
            PartyMember allMember = this.MyParty.AllMembers[partyNumbers];
            if (allMember.DatabaseID != this.Myself.DatabaseID)
            {
              AutoAccount autoAccount = (AutoAccount) null;
              for (int index = frmLogin.GAuto.AllAutoAccounts.Count - 1; index >= 0; --index)
              {
                AutoAccount allAutoAccount = frmLogin.GAuto.AllAutoAccounts[index];
                if (allAutoAccount.Myself.DatabaseID == allMember.DatabaseID)
                {
                  autoAccount = allAutoAccount;
                  break;
                }
              }
              if (autoAccount == null)
                return true;
              if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) autoAccount.Myself.PosX, (double) autoAccount.Myself.PosY) > distance && (follow || autoAccount.Myself.IsPartyFollowed != (byte) 1))
                return false;
            }
          }
        }
        catch (Exception ex)
        {
          GA.WriteUserLog(frmMain.langErrorCheckingPTPos, this);
        }
        return true;
      }
    }
    return true;
  }

  public double CheckMemberRangeMin()
  {
    double num = 99.0;
    if (this.MyParty != null && this.MyParty.AllMembers.Count > 0 && this.MyParty.PartyNumbers > 0)
    {
      if (this.MyParty.PartyNumbers < 6)
      {
        try
        {
          for (int partyNumbers = this.MyParty.PartyNumbers; partyNumbers >= 0; --partyNumbers)
          {
            PartyMember allMember = this.MyParty.AllMembers[partyNumbers];
            if (allMember.DatabaseID != this.Myself.DatabaseID)
            {
              AutoAccount autoAccount = (AutoAccount) null;
              for (int index = frmLogin.GAuto.AllAutoAccounts.Count - 1; index >= 0; --index)
              {
                AutoAccount allAutoAccount = frmLogin.GAuto.AllAutoAccounts[index];
                if (allAutoAccount.Myself.DatabaseID == allMember.DatabaseID)
                {
                  autoAccount = allAutoAccount;
                  break;
                }
              }
              if (autoAccount != null)
              {
                double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) autoAccount.Myself.PosX, (double) autoAccount.Myself.PosY);
                if (distance < num)
                  num = distance;
              }
              else
              {
                double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) allMember.PosX, (double) allMember.PosY);
                if (distance < num)
                  num = distance;
              }
            }
          }
        }
        catch (Exception ex)
        {
          GA.WriteUserLog(frmMain.langErrorCheckingPTPos, this);
        }
      }
    }
    return num;
  }

  public bool CheckMemberGPS(int distance, int posX, int posY, int mapID, int exceptmapID = -1)
  {
    if (this.MyParty != null && this.MyParty.AllMembers.Count > 0)
    {
      List<int> intList = new List<int>();
      try
      {
        for (int index = frmLogin.GAuto.AllAutoAccounts.Count - 1; index >= 0; --index)
          intList.Add(frmLogin.GAuto.AllAutoAccounts[index].Myself.DatabaseID);
      }
      catch (Exception ex)
      {
        GA.WriteUserLog(frmMain.langErrorCheckingPTPos2, this);
      }
      if (this.MyParty.PartyNumbers > 0 && this.MyParty.PartyNumbers < 6)
      {
        for (int partyNumbers = this.MyParty.PartyNumbers; partyNumbers >= 0; --partyNumbers)
        {
          PartyMember allMember = this.MyParty.AllMembers[partyNumbers];
          if (intList.Contains(allMember.DatabaseID) && allMember.DatabaseID != this.Myself.DatabaseID && allMember.MapID != exceptmapID && (allMember.MapID != mapID || GA.CalculateDistance((double) posX, (double) posY, (double) allMember.PosX, (double) allMember.PosY) > (double) distance))
            return false;
        }
      }
    }
    return true;
  }

  public int PointComparison(InMapPoint a, InMapPoint b)
  {
    if (a.STT < b.STT)
      return -1;
    return a.STT > b.STT ? 1 : 0;
  }

  private void FuncPetSupport()
  {
    if (this.MyPet == null || this.Myself.IsPartyFollowed != (byte) 0)
      return;
    if (this.Myself.IsTBB)
      return;
    try
    {
      if (this.MyPet.ActivePetIndex < 0 || this.MyPet.ActivePetIndex >= this.MyPet.AllPets.Count || this.MyPet.AllPets.Count <= 0 || this.MyPet.AllPets[this.MyPet.ActivePetIndex].HPPercent > (double) this.Settings.numPetHPPercent || this.MyPet.AllPets[this.MyPet.ActivePetIndex].HPPercent <= 0.0 || this.Myself.HPPercent <= 0.0 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.PetFeedStamp < 200L || !this.CanAction())
        return;
      if (!this.Myself.FlagHetThucAn)
      {
        if (this.Myself.HorseType != -1 && this.Myself.ActionStatus != (byte) 2)
          this.CallXuongNgua();
        if (this.Myself.HorseType == -1)
          this.CallFeedMyActivePetLUA(this.MyPet.ActivePetIndex);
      }
      this.PetFeedStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    }
    catch (Exception ex)
    {
      GA.WriteUserLog(frmMain.langErrorFeedingPet, this);
    }
  }

  private void FuncNgaMySupport()
  {
    if (this.Myself.Menpai != AllEnums.Menpais.NGAMI || this.Myself.ActionStatus == (byte) 5 || this.Myself.ActionStatus == (byte) 6 || this.Myself.MinorStatus2 == AllEnums.CharStatuses.TRIEUTAP || !this.Settings.cboxNMBuff || this.Myself.IsPartyFollowed != (byte) 0 || this.Myself.IsPK && (!this.Settings.cboxNMPKBuff || !this.Myself.IsPK) && this.IsAIEnabled || this.Myself.MPPercent < 2.0 || this.WantMoveNow() && this.MyFlag.ngamyMoveStamp - frmLogin.GlobalTimer.ElapsedMilliseconds <= 0L || frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.noBuffStamp <= 10000L && this.MyFlag.noBuffStamp > 0L)
      return;
    if (GA.isShitMember())
      Thread.Sleep(new Random().Next(1000, 3000));
    try
    {
      if (frmLogin.GAuto.Settings.IsPro1 && this.MyParty.PartyNumbers > 0 && this.Settings.usePhatQuangPhoChieu && frmLogin.GlobalTimer.ElapsedMilliseconds - this.MySkills.usePhatQuangStamp >= (long) (this.Settings.numPhatQuangDelay * 1000) && this.MySkills.HasSkill(406) && this.MySkills.GetRemainWaitingTime(406) <= 0)
      {
        if (this.Myself.HorseType != -1 && this.Myself.ActionStatus != (byte) 2)
          this.CallMounting();
        this.CallAttackTargetPacket(this.Myself.ID, 406, -1, 0, 0);
        this.MySkills.SetRemainingTime(406, 3500);
        this.MySkills.usePhatQuangStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
      }
      if (this.Settings.NgaMiSkillBuffID != 424 && this.MySkills.HasSkill(424))
        this.Settings.NgaMiSkillBuffID = 424;
      if (this.Settings.NgaMiSkillBuffID != 424 && !this.MySkills.HasSkill(424))
        this.Settings.NgaMiSkillBuffID = 407;
      if (this.Settings.NgaMiSkillBuffID == 424 && this.MySkills.ThanhTamDelay <= 400 || this.Settings.NgaMiSkillBuffID == 407 && this.MySkills.XungHuDelay <= 400)
      {
        PartyMember chosenMember = (PartyMember) null;
        double shortestDistance = 99.0;
        if (frmLogin.GAuto.Settings.AppMode != AllEnums.AutoModes.Lite && (!this.NMNeedSelfBuff() || this.NMNeedSelfBuff() && !this.Settings.cboxNMUutienself))
        {
          if (this.Settings.cboxNMBuffList && frmLogin.GAuto.Settings.BuffNameList.Count > 0)
          {
            if (this.MyPlayers.AllPlayers.Count > 0)
            {
              try
              {
                for (int index = this.MyPlayers.AllPlayers.Count - 1; index >= 0; --index)
                {
                  PlayerIndividual allPlayer = this.MyPlayers.AllPlayers[index];
                  if (frmLogin.GAuto.Settings.BuffNameList.Contains(allPlayer.Name))
                  {
                    PartyMember tentativeMember = new PartyMember()
                    {
                      MaxHP = 100
                    };
                    tentativeMember.HP = (int) ((double) allPlayer.HPPercent * (double) tentativeMember.MaxHP / 100.0);
                    tentativeMember.ID = allPlayer.ID;
                    tentativeMember.MapID = allPlayer.MapID;
                    tentativeMember.PosX = allPlayer.PosX;
                    tentativeMember.PosY = allPlayer.PosY;
                    tentativeMember.DatabaseID = allPlayer.DatabaseID;
                    tentativeMember.Name = allPlayer.Name;
                    this.PickBuffPerson(ref chosenMember, ref shortestDistance, tentativeMember);
                  }
                }
              }
              catch (Exception ex)
              {
              }
            }
          }
          if (this.MyArmy.HasQuanDoan && this.Settings.cboxNMBuffQuanDoan && this.Target.VersionNum != 3 && this.Target.VersionNum != 4 && this.MyArmy.AllMembers.Count > 1)
          {
            for (int index = 0; index < 30; ++index)
            {
              PartyMember allMember = this.MyArmy.AllMembers[index];
              this.PickBuffPerson(ref chosenMember, ref shortestDistance, allMember);
            }
          }
          if (this.MyParty.PartyNumbers > 0 && this.MyParty.PartyNumbers < 6)
          {
            if (this.Settings.menuTestGame)
              GA.WriteUserLog("PartyCount: {0}-{1}", this, (object) this.MyParty.PartyNumbers, (object) this.Settings.cboxNMBuffParty.ToString());
            if (this.Settings.cboxNMBuffParty)
            {
              for (int index = 0; index <= this.MyParty.PartyNumbers; ++index)
              {
                if (this.Settings.menuTestGame)
                  GA.WriteUserLog("Party: {0}-{1}-{2}-{3}-{4}-{5}-{6}-{7}", this, (object) index, (object) this.MyParty.AllMembers[index].Name, (object) ((int) this.MyParty.AllMembers[index].PosX).ToString(), (object) ((int) this.MyParty.AllMembers[index].PosY).ToString(), (object) this.MyParty.AllMembers[index].HP.ToString(), (object) this.MyParty.AllMembers[index].MaxHP.ToString(), (object) this.MyParty.AllMembers[index].HPPercent.ToString(), (object) this.MyParty.PartyNumbers.ToString());
                PartyMember allMember = this.MyParty.AllMembers[index];
                this.PickBuffPerson(ref chosenMember, ref shortestDistance, allMember);
              }
            }
          }
          if (GA.IsInPhuBan(this.Myself.MapID, this))
          {
            if (this.MyQuai.AllQuai.Count >= 1)
            {
              try
              {
                for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
                {
                  QuaiIndividual quai = this.MyQuai.AllQuai[index];
                  if ((double) quai.PosX != 0.0 && (double) quai.PosY != 0.0 && !string.IsNullOrEmpty(quai.Name) && !this.CanAttack(quai))
                  {
                    bool flag = false;
                    switch (frmLogin.CompilingLanguage)
                    {
                      case "VN":
                        if (quai.Name.ToLower() == "niên thú" || quai.Name.ToLower() == "kỳ lân" || quai.Name.ToLower() == "long quy" || quai.Name.ToLower() == "hoàng điểu" || quai.Name.ToLower() == "hô diên báo")
                        {
                          flag = true;
                          break;
                        }
                        break;
                      case "EN":
                        if (quai.Name.ToLower() == "leopard hu" || quai.Name.ToLower() == "shishimai" || quai.Name.ToLower() == "kylin" || quai.Name.ToLower() == "tarasque" || quai.Name.ToLower() == "phoenix")
                        {
                          flag = true;
                          break;
                        }
                        break;
                      case "CN":
                        if (quai.Name.ToLower() == "年兽" || quai.Name.ToLower() == "麒麟" || quai.Name.ToLower() == "龙龟" || quai.Name.ToLower() == "黄鸟" || quai.Name.ToLower() == "呼延豹")
                        {
                          flag = true;
                          break;
                        }
                        break;
                    }
                    if (flag)
                    {
                      PartyMember tentativeMember = new PartyMember()
                      {
                        MaxHP = 100
                      };
                      tentativeMember.HP = (int) ((double) quai.HPPercent * (double) tentativeMember.MaxHP / 100.0);
                      tentativeMember.ID = quai.ID;
                      tentativeMember.MapID = this.Myself.MapID;
                      tentativeMember.PosX = quai.PosX;
                      tentativeMember.PosY = quai.PosY;
                      tentativeMember.DatabaseID = GA.random.Next();
                      tentativeMember.Name = quai.Name;
                      this.PickBuffPerson(ref chosenMember, ref shortestDistance, tentativeMember);
                    }
                  }
                }
              }
              catch (Exception ex)
              {
              }
            }
          }
        }
        if (chosenMember != null)
        {
          bool flag = false;
          if (this.NMNeedSelfBuff() && !this.Settings.cboxNMUutienself && chosenMember.HPPercent < this.Myself.HPPercent)
            flag = true;
          if (!this.NMNeedSelfBuff())
            flag = true;
          if (flag)
          {
            this.BuffAPerson(chosenMember, shortestDistance);
            return;
          }
          this.NgaMiBuffSelf();
          return;
        }
        if (this.NgaMiBuffSelf())
          return;
      }
      this.NgaMiBuffPet();
    }
    catch (Exception ex)
    {
      GA.WriteUserLog(frmMain.langErrorLotusBuff, this);
    }
  }

  private void NgaMiBuffPet(int inputPercent = 0)
  {
    if (!this.Settings.cboxBuffPet || frmLogin.GAuto.Settings.AppMode == AllEnums.AutoModes.Lite)
      return;
    int num = this.Settings.numBuffPet;
    if (inputPercent > 0)
      num = inputPercent;
    QuaiIndividual quaiIndividual1 = (QuaiIndividual) null;
    if (frmLogin.GAuto.Settings.ListBuffPetID.Count > 0)
    {
      if (this.Settings.cboxPetList)
      {
        try
        {
          foreach (string str in (List<string>) frmLogin.GAuto.Settings.ListBuffPetID)
          {
            if (str != "" && this.MyQuai.AllQuai.Count > 0)
            {
              foreach (QuaiIndividual quaiIndividual2 in this.MyQuai.AllQuai)
              {
                if (quaiIndividual2.Name != "" && quaiIndividual2.MapID == this.Myself.MapID && quaiIndividual2.Name == str)
                {
                  if (GA.CalculateDistance((double) quaiIndividual2.PosX, (double) quaiIndividual2.PosY, (double) this.Myself.PosX, (double) this.Myself.PosY) <= 14.0)
                  {
                    if ((double) quaiIndividual2.HPPercent <= (double) num)
                    {
                      if ((double) quaiIndividual2.HPPercent > 0.0)
                      {
                        if (quaiIndividual1 == null)
                        {
                          quaiIndividual1 = quaiIndividual2;
                          break;
                        }
                        if ((double) quaiIndividual2.HPPercent < (double) quaiIndividual1.HPPercent)
                        {
                          quaiIndividual1 = quaiIndividual2;
                          break;
                        }
                        break;
                      }
                      break;
                    }
                    break;
                  }
                  break;
                }
              }
            }
          }
        }
        catch (Exception ex)
        {
        }
      }
    }
    if (this.MyPet == null && quaiIndividual1 == null || this.Myself.ManaRunOut)
      return;
    int targetID = -1;
    if (quaiIndividual1 != null)
      targetID = quaiIndividual1.ID;
    if (this.MyPet.AllPets.Count > 0 && this.MyPet.ActivePetIndex >= 0)
    {
      if (this.MyPet.ActivePetIndex < this.MyPet.AllPets.Count)
      {
        try
        {
          if (this.MyPet.AllPets[this.MyPet.ActivePetIndex].HPPercent <= (double) num)
          {
            if (this.MyPet.AllPets[this.MyPet.ActivePetIndex].HPPercent > 0.0)
            {
              if (quaiIndividual1 != null)
              {
                if (this.MyPet.AllPets[this.MyPet.ActivePetIndex].HPPercent <= (double) quaiIndividual1.HPPercent)
                  targetID = this.MyPet.AllPets[this.MyPet.ActivePetIndex].ID;
              }
              else
                targetID = this.MyPet.AllPets[this.MyPet.ActivePetIndex].ID;
            }
          }
        }
        catch (Exception ex)
        {
        }
      }
    }
    if (targetID == -1 || !this.MySkills.HasSkill(this.Settings.NgaMiSkillBuffID) || (this.Settings.NgaMiSkillBuffID != 407 || this.MySkills.XungHuDelay > 400) && (this.Settings.NgaMiSkillBuffID != 424 || this.MySkills.ThanhTamDelay > 400))
      return;
    this.CallAttackTarget(targetID, this.Settings.NgaMiSkillBuffID, 0, 0);
  }

  public bool NgaMiBuffSelf()
  {
    if (!this.NMNeedSelfBuff() || this.Myself.ManaRunOut)
      return false;
    if (this.Myself.HorseType != -1)
      this.CallMounting();
    this.CallAttackTargetPacket(this.Myself.ID, this.Settings.NgaMiSkillBuffID, this.Myself.ID, 0, 0);
    if (frmLogin.GAuto.Settings.cboxNMBuffSelectTarget)
      this.CallSelectTarget(this.Myself.ID);
    this.Myself.NMSkillStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    this.Myself.Status = AllEnums.CharStatuses.NMBUFFMAU;
    return true;
  }

  private bool NMNeedSelfBuff()
  {
    return this.Myself.HPPercent <= (double) this.Settings.numNgaMyBuff && this.Settings.numNgaMyBuff > 0 && this.Myself.HPPercent > 0.0 && this.Settings.cboxNMBuffSelf;
  }

  private void FuncAnHPMP()
  {
    if ((this.Myself.MPPercent <= (double) this.Settings.numMPPercent && !this.Settings.cboxHuyetTe || this.Myself.MPPercent <= (double) (this.Settings.numMPPercent - 10) && this.Settings.cboxHuyetTe) && this.Myself.HPPercent > 0.0 && frmLogin.GlobalTimer.ElapsedMilliseconds - this.eatMPStamp >= 1000L && this.CanAction() && this.Myself.IsPartyFollowed == (byte) 0 && !this.Myself.IsTBB)
    {
      InventoryItem inventoryItem = (InventoryItem) null;
      int itemIndex = 0;
      try
      {
        for (int index = 0; index < 30; ++index)
        {
          if (this.MyInventory.AllItems[index].ItemID >= 30002001 && this.MyInventory.AllItems[index].ItemID <= 30002029 || this.MyInventory.AllItems[index].ItemID == 31000007 || this.MyInventory.AllItems[index].ItemID == 31000002 || this.MyInventory.AllItems[index].ItemID == 31000003 || this.MyInventory.AllItems[index].ItemID == 31000008)
          {
            inventoryItem = this.MyInventory.AllItems[index];
            itemIndex = index;
            break;
          }
        }
      }
      catch (Exception ex)
      {
        GA.WriteUserLog(frmMain.langErrorEatingMP, this);
      }
      if (inventoryItem != null)
      {
        this.MyInventory.HPItemAte = frmMain.langUsedItem + inventoryItem.ItemName;
        this.CallUseItem(itemIndex, this.Myself.ID);
        this.eatMPStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
      }
      else
        this.MyInventory.HPItemAte = frmMain.langCannotReadInventory;
    }
    if ((this.Myself.HPPercent > (double) this.Settings.numHPPercent || this.Settings.cboxCongSinh) && (this.Myself.HPPercent > (double) (this.Settings.numHPPercent - 10) || !this.Settings.cboxCongSinh) || this.Myself.HPPercent <= 0.0 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.eatHPStamp < 1000L || this.Myself.ActionStatus == (byte) 5 || this.Myself.ActionStatus == (byte) 6 || !this.CanAction() || this.Myself.IsPartyFollowed != (byte) 0)
      return;
    InventoryItem inventoryItem1 = (InventoryItem) null;
    int itemIndex1 = 0;
    try
    {
      for (int index = 0; index < 30; ++index)
      {
        if (this.MyInventory.AllItems[index].ItemID >= 30001001 && this.MyInventory.AllItems[index].ItemID <= 30001030 || this.MyInventory.AllItems[index].ItemID == 31000000 || this.MyInventory.AllItems[index].ItemID == 31000001 || this.MyInventory.AllItems[index].ItemID == 31000005 || this.MyInventory.AllItems[index].ItemID == 31000006)
        {
          inventoryItem1 = this.MyInventory.AllItems[index];
          itemIndex1 = index;
          break;
        }
      }
    }
    catch (Exception ex)
    {
      GA.WriteUserLog(frmMain.langErrorEatingHP, this);
    }
    if (inventoryItem1 != null)
    {
      this.MyInventory.HPItemAte = frmMain.langUsedItem + inventoryItem1.ItemName;
      this.CallUseItem(itemIndex1, this.Myself.ID);
      this.eatHPStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    }
    else
      this.MyInventory.HPItemAte = frmMain.langCannotReadInventory;
  }

  public bool RunningQuest()
  {
    return this.Myself.IsTrader || this.Myself.IsTrungAc || this.Myself.IsLuyenKim || this.Myself.IsMuaKNB || this.Myself.IsXayDung || this.Myself.IsTBB;
  }

  public void CallPartyFollowMe(int waitTimeOut = 5000)
  {
    if (!this.IsPartyKey())
      return;
    if (this.Myself.HorseType == -1)
      this.CallLenNgua();
    bool flag1 = this.ForcePartyFollow();
    if (flag1)
      return;
    GA.TrieuTapCaNhom(this, true);
    long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
    long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
    while (this.IsAIEnabled)
    {
      bool flag2 = this.CheckMemberDistance(7.0);
      if (!flag2 && frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 <= 7000L)
        elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
      if (flag2 && GA.CheckStatusParty(this))
        flag1 = this.ForcePartyFollow();
      Thread.Sleep(300);
      if (flag1)
        break;
      if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds1 > (long) waitTimeOut)
      {
        this.ForcePartyFollow();
        break;
      }
    }
  }

  public bool ForcePartyFollow()
  {
    if (this.MyParty != null && this.Myself != null)
    {
      long num = 0;
      long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
      if (this.Myself.IsPartyFollowed == (byte) 0)
      {
        this.CallRequestPartyFollow();
        Thread.Sleep(1000);
      }
      while (this.IsAIEnabled)
      {
        bool flag1 = false;
        if (this.MyParty.PartyNumbers <= 0)
          return true;
        List<string> stringList = new List<string>();
        try
        {
          if (this.MyParty.PartyNumbers <= 0 || this.MyParty.PartyNumbers >= 6)
            return true;
          for (int index1 = 0; index1 <= this.MyParty.PartyNumbers; ++index1)
          {
            PartyMember allMember = this.MyParty.AllMembers[index1];
            for (int index2 = frmLogin.GAuto.AllAutoAccounts.Count - 1; index2 >= 0; --index2)
            {
              AutoAccount allAutoAccount = frmLogin.GAuto.AllAutoAccounts[index2];
              if (allAutoAccount.Myself == null || allAutoAccount.MyParty == null)
                return false;
              if (allAutoAccount.Myself.DatabaseID == allMember.DatabaseID)
              {
                bool flag2 = true;
                if (allAutoAccount.Myself.DatabaseID == this.Myself.DatabaseID)
                  flag2 = false;
                if (flag2)
                {
                  stringList.Add(allAutoAccount.Myself.Name);
                  if (allAutoAccount.Myself.IsPartyFollowed == (byte) 0)
                  {
                    flag1 = true;
                    if (frmLogin.GlobalTimer.ElapsedMilliseconds - num >= 2000L)
                    {
                      num = frmLogin.GlobalTimer.ElapsedMilliseconds;
                      this.CallRequestPartyFollow();
                      Thread.Sleep(200);
                    }
                    return false;
                  }
                }
              }
            }
            if (!allMember.flagPartyFollowed && allMember.DatabaseID != this.Myself.DatabaseID && !stringList.Contains(allMember.Name))
            {
              flag1 = true;
              if (frmLogin.GlobalTimer.ElapsedMilliseconds - num >= 2000L)
              {
                num = frmLogin.GlobalTimer.ElapsedMilliseconds;
                this.CallRequestPartyFollow();
                Thread.Sleep(200);
              }
              return false;
            }
          }
        }
        catch (Exception ex)
        {
        }
        if (!flag1)
          return true;
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds >= 30000L)
          return false;
        Thread.Sleep(500);
      }
    }
    return false;
  }

  private void PickBuffPerson(
    ref PartyMember chosenMember,
    ref double shortestDistance,
    PartyMember tentativeMember)
  {
    if (tentativeMember.MapID != this.Myself.MapID)
      return;
    double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) tentativeMember.PosX, (double) tentativeMember.PosY);
    if (chosenMember != null)
    {
      if (tentativeMember.HPPercent > (double) this.Settings.numBuffPartyXH || tentativeMember.HPPercent > chosenMember.HPPercent || chosenMember.DatabaseID == tentativeMember.DatabaseID || tentativeMember.HPPercent <= 0.0 || tentativeMember.ID == this.Myself.ID || distance > (double) this.Settings.numBuffPhamVi)
        return;
      chosenMember = tentativeMember;
      shortestDistance = distance;
    }
    else
    {
      if (distance > (double) this.Settings.numBuffPhamVi || chosenMember != null || tentativeMember.HPPercent <= 0.0 || tentativeMember.HPPercent > (double) this.Settings.numBuffPartyXH || tentativeMember.ID == this.Myself.ID)
        return;
      chosenMember = tentativeMember;
      shortestDistance = distance;
    }
  }

  private void BuffAPerson(PartyMember partyMember, double partyDistance)
  {
    if (partyMember == null || this.Myself.ManaRunOut)
      return;
    if (this.Myself.HorseType != -1)
      this.CallMounting();
    bool flag1 = true;
    if (partyDistance <= 10.0)
    {
      this.CallAttackTargetPacket(this.Myself.ID, this.Settings.NgaMiSkillBuffID, partyMember.ID, 0, 0);
      flag1 = false;
    }
    if (flag1 && partyDistance <= (double) this.Settings.numBuffPhamVi)
    {
      if (partyDistance <= 15.0)
      {
        this.CallAttackTarget(partyMember.ID, this.Settings.NgaMiSkillBuffID, 0, 0);
        if (this.Myself.ActionStatus == (byte) 0)
        {
          double num = (double) (frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.ngamyBuffXaStamp);
          if (this.MyFlag.ngamyBuffXaStamp == 0L)
            this.MyFlag.ngamyBuffXaStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
          else if (num > 2000.0)
            this.MyFlag.ngamyBuffXaStamp = 0L;
          else if (num > 1000.0)
          {
            this.MyFlag.ngamyBuffXaStamp = 0L;
            bool flag2 = false;
            if (this.MyPlayers.AllPlayers.Count > 0)
            {
              try
              {
                for (int index = this.MyPlayers.AllPlayers.Count - 1; index >= 0; --index)
                {
                  if (this.MyPlayers.AllPlayers[index].ID == partyMember.ID)
                  {
                    flag2 = true;
                    break;
                  }
                }
              }
              catch (Exception ex)
              {
              }
            }
            if (!flag2)
            {
              this.CallMoveFlashPos((int) partyMember.PosX, (int) partyMember.PosY);
              this.MyFlag.ngamyBuffXaStamp = 0L;
              this.MyFlag.ngamyMoveStamp = frmLogin.GlobalTimer.ElapsedMilliseconds + 3000L;
            }
          }
        }
        else
          this.MyFlag.ngamyBuffXaStamp = 0L;
      }
      else if (partyDistance <= (double) this.Settings.numBuffPhamVi)
      {
        this.CallMoveFlashPos((int) partyMember.PosX, (int) partyMember.PosY);
        this.MyFlag.ngamyMoveStamp = frmLogin.GlobalTimer.ElapsedMilliseconds + 6000L;
      }
    }
    if (partyDistance > (double) this.Settings.numBuffPhamVi)
      return;
    if (frmLogin.GAuto.Settings.cboxNMBuffSelectTarget)
      this.CallSelectTarget(partyMember.ID);
    this.Myself.NMSkillStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    this.Myself.Status = AllEnums.CharStatuses.NMBUFFMAU;
  }

  private void BuffNPC(QuaiIndividual quai, double distance)
  {
    if (quai == null)
      return;
    if (this.Myself.HorseType != -1)
      this.CallMounting();
    if (distance <= 11.0)
      this.CallAttackTargetPacket(this.Myself.ID, this.Settings.NgaMiSkillBuffID, quai.ID, 0, 0);
    else if (distance <= 25.0)
      this.CallAttackTarget(quai.ID, this.Settings.NgaMiSkillBuffID, 0, 0);
    if (distance > 25.0)
      return;
    this.Myself.NMSkillStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    this.Myself.Status = AllEnums.CharStatuses.NMBUFFMAU;
  }

  private PartyMember TheoSauAiDo(bool realFollow = true)
  {
    if (this.Myself.IsTBB)
      return (PartyMember) null;
    bool flag1 = false;
    bool flag2 = false;
    bool flag3 = false;
    if (this.MyParty.PartyNumbers > 0)
      flag1 = true;
    if (!flag1)
      flag2 = this.MyArmy.HasQuanDoan;
    if (this.Settings.txtTheoSauName != "" && this.Settings.PTTheoSauMode == 1)
      flag3 = true;
    PartyMember partyMember = (PartyMember) null;
    if (flag1 || flag2 || frmLogin.GAuto.AllAutoAccounts.Count > 1 || flag3)
    {
      if (this.Settings.PTTheoSauMode == 0 && flag1 && this.Myself.Status != AllEnums.CharStatuses.NHATBOC)
        partyMember = this.MyParty.AllMembers[0];
      else if (this.Settings.PTTheoSauMode == 1 && this.Settings.txtTheoSauName != "" && this.Myself.Status != AllEnums.CharStatuses.NHATBOC)
      {
        if (frmLogin.GAuto.AllAutoAccounts.Count > 1)
        {
          try
          {
            for (int index = frmLogin.GAuto.AllAutoAccounts.Count - 1; index >= 0; --index)
            {
              AutoAccount allAutoAccount = frmLogin.GAuto.AllAutoAccounts[index];
              if (allAutoAccount.Myself != null && allAutoAccount.Myself.DatabaseID != this.Myself.DatabaseID && allAutoAccount.Myself.Name == this.Settings.txtTheoSauName)
              {
                partyMember = new PartyMember();
                partyMember.DatabaseID = allAutoAccount.Myself.DatabaseID;
                partyMember.MapID = allAutoAccount.Myself.MapID;
                partyMember.PosX = allAutoAccount.Myself.PosX;
                partyMember.PosY = allAutoAccount.Myself.PosY;
                break;
              }
            }
          }
          catch (Exception ex)
          {
          }
        }
        if (this.MyPlayers.AllPlayers.Count > 0)
        {
          try
          {
            for (int index = this.MyPlayers.AllPlayers.Count - 1; index >= 0; --index)
            {
              PlayerIndividual allPlayer = this.MyPlayers.AllPlayers[index];
              if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) allPlayer.PosX, (double) allPlayer.PosY) <= 25.0 && allPlayer.Name == this.Settings.txtTheoSauName)
              {
                partyMember = new PartyMember();
                partyMember.MapID = allPlayer.MapID;
                partyMember.DatabaseID = allPlayer.DatabaseID;
                partyMember.PosX = allPlayer.PosX;
                partyMember.PosY = allPlayer.PosY;
                partyMember.Level = allPlayer.Level;
                partyMember.Name = allPlayer.Name;
                partyMember.HP = (int) allPlayer.HPPercent;
              }
            }
          }
          catch (Exception ex)
          {
          }
        }
        if (partyMember == null && flag1 && this.MyParty.PartyNumbers < 6)
        {
          for (int index = 0; index < this.MyParty.PartyNumbers; ++index)
          {
            if (this.MyParty.AllMembers[index].Name == this.Settings.txtTheoSauName)
            {
              partyMember = this.MyParty.AllMembers[index];
              break;
            }
          }
        }
        if (partyMember == null && flag2 && this.Target.VersionNum != 3 && this.Target.VersionNum != 4)
        {
          for (int index = 0; index < 30; ++index)
          {
            if (this.MyArmy.AllMembers[index].Name == this.Settings.txtTheoSauName)
            {
              partyMember = this.MyArmy.AllMembers[index];
              break;
            }
          }
        }
      }
      if (partyMember != null && realFollow)
      {
        for (int index = frmLogin.GAuto.AllAutoAccounts.Count - 1; index >= 0; --index)
        {
          AutoAccount allAutoAccount = frmLogin.GAuto.AllAutoAccounts[index];
          if (allAutoAccount.Myself != null && allAutoAccount.Myself.DatabaseID == partyMember.DatabaseID)
          {
            partyMember = new PartyMember();
            partyMember.DatabaseID = allAutoAccount.Myself.DatabaseID;
            partyMember.MapID = allAutoAccount.Myself.MapID;
            partyMember.PosX = allAutoAccount.Myself.PosX;
            partyMember.PosY = allAutoAccount.Myself.PosY;
            break;
          }
        }
        if ((double) partyMember.PosX != 0.0 && (double) partyMember.PosY != 0.0 && partyMember.DatabaseID != this.Myself.DatabaseID && (partyMember.MapID == this.Myself.MapID || GA.IsInPhuBan(this.Myself.MapID, this) && GA.IsInPhuBan(partyMember.MapID, this)))
        {
          double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) partyMember.PosX, (double) partyMember.PosY);
          bool flag4 = this.NotTransitioning();
          if (distance > (double) this.Settings.numTheoSau && flag4)
          {
            if (this.Myself.LastTimeMove.ElapsedMilliseconds >= 1000L && this.Myself.Status != AllEnums.CharStatuses.NHATBOC)
            {
              this.Myself.TargetX = partyMember.PosX;
              this.Myself.TargetY = partyMember.PosY;
              if (this.Myself.ActionStatus == (byte) 2)
                this.CallMoveFlashPos((int) this.Myself.TargetX, (int) this.Myself.TargetY);
              else
                this.CallInMapMove((int) this.Myself.TargetX, (int) this.Myself.TargetY);
              this.Myself.MoveFlashPos = true;
              this.Myself.Status = GA.IsInPhuBan(this.Myself.MapID, this) ? AllEnums.CharStatuses.IDLE : AllEnums.CharStatuses.GOGOGO;
              this.Myself.LastTimeMove.Reset();
              this.Myself.LastTimeMove.Start();
            }
          }
          else
            this.Myself.MoveFlashPos = false;
        }
      }
    }
    if (partyMember != null && partyMember.DatabaseID == this.Myself.DatabaseID)
      partyMember = (PartyMember) null;
    return partyMember;
  }

  private bool CanAction()
  {
    if (this.Myself.HorseType != -1 || this.Myself.IsPartyFollowed != (byte) 0 || this.Myself.JustWarped)
      return false;
    if (!this.Myself.IsLuyenKim)
      return true;
    return this.Myself.IsLuyenKim && this.Myself.LuyenKimVanChuyen;
  }

  private bool BuffHoTro(SkillPlayItem skill, BuffedPlayer buffTarget, PartyMember ptMember)
  {
    if (ptMember.Name != this.Myself.Name && ptMember.MapID == this.Myself.MapID)
    {
      bool flag = false;
      foreach (BuffedPlayer buffPlayer in (List<BuffedPlayer>) skill.BuffPlayerList)
      {
        if (buffPlayer.Name == ptMember.Name)
        {
          flag = true;
          break;
        }
      }
      if (!flag && GA.CalculateDistance((double) ptMember.PosX, (double) ptMember.PosY, (double) this.Myself.PosX, (double) this.Myself.PosY) <= 11.0)
      {
        buffTarget = new BuffedPlayer();
        buffTarget.Name = ptMember.Name;
        buffTarget.DatabaseID = ptMember.DatabaseID;
        buffTarget.GameID = ptMember.ID;
        return true;
      }
    }
    return false;
  }

  private bool ProcessCaptcha()
  {
    if (this.Myself.CaptchaRemaining > 0 && this.Myself.CaptchaAlerted && this.Settings.cboxCaptchaReset && !this.Myself.CaptchaSendDisconnected && (this.Myself.CaptchaRemaining <= 16 /*0x10*/ || this.Myself.CaptchaRemaining <= 16 /*0x10*/ && this.Myself.IsTrungAc))
    {
      this.Myself.CaptchaAlertStamp.Reset();
      this.Myself.CaptchaAlertStamp.Start();
      if (this.Target.VersionNum == 3 || this.Target.VersionNum == 4 || this.Target.VersionNum == 5 || this.Target.VersionNum == 6 || this.Target.VersionNum == 7 || this.Target.VersionNum == 8)
        this.CallOutGame();
      else
        this.CallEnterReconnect();
      this.Myself.CaptchaAlerted = false;
      this.Myself.CaptchaSendDisconnected = true;
      if (this.Myself.LogLastAction != AllEnums.LogActions.NgatKetNoi)
        GA.WriteUserLog(frmMain.langDisconnectCaptcha, this);
      this.Myself.LogLastAction = AllEnums.LogActions.NgatKetNoi;
      return true;
    }
    bool flag = false;
    if (this.Myself.CaptchaTKStamp > frmLogin.GlobalTimer.ElapsedMilliseconds)
      flag = true;
    if ((this.Myself.CaptchaRemaining > 0 || flag) && !this.Myself.CaptchaSendDisconnected)
    {
      if (this.Myself.CaptchaRemaining > 0)
        GA.ShowBalloon(frmMain.langDisconnect50sec, frmMain.langCaptchaAlert, this, 7000);
      else if (flag)
        GA.ShowBalloon(frmMain.langCaptchaTK, frmMain.langCaptchaAlert, this, 7000);
      if (this.Myself.CaptchaAlerted)
      {
        if (this.Settings.cboxTNAlert && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.CaptchaAlertAudioStamp >= 2500L)
          this.PlayCaptchaSound();
      }
      else
      {
        this.Myself.CaptchaAlertStamp.Reset();
        this.Myself.CaptchaAlertStamp.Start();
        this.Myself.CaptchaAlerted = true;
        this.Myself.CaptchaGUI = true;
        if (this.Settings.cboxTNAlert)
        {
          frmMain.frmMainInstance.NVHienGame(this);
          this.PlayCaptchaSound();
        }
      }
    }
    return false;
  }

  public bool HasPK()
  {
    for (int index = 0; index < 30; ++index)
    {
      if (this.Myself.GreenList[index] > 0)
        return true;
    }
    return false;
  }

  public bool IsPartyKey()
  {
    if (this.MyParty != null && this.MyParty.PartyNumbers > 0 && this.MyParty.PartyNumbers < 6)
    {
      PartyMember allMember = this.MyParty.AllMembers[0];
      if (allMember.Name == this.Myself.Name && allMember.Name != "")
        return true;
    }
    return false;
  }

  public bool IsPartyKeyAlone()
  {
    return this.MyParty != null && this.MyParty.PartyNumbers >= 0 && this.MyParty.PartyNumbers < 6 && this.MyParty.AllMembers[0].Name == this.Myself.Name;
  }

  public int IsPartyKeyInt()
  {
    if (this.MyParty == null || this.MyParty.PartyNumbers < 1 || this.MyParty.PartyNumbers >= 6)
      return 0;
    return this.MyParty.AllMembers[0].Name == this.Myself.Name ? 2 : 1;
  }

  public bool IsPet(QuaiIndividual quai = null)
  {
    return quai != null ? quai.CanAttack == byte.MaxValue : this.MyQuai.CanAttackInt == (int) byte.MaxValue;
  }

  public bool IsPlayer(QuaiIndividual quai = null)
  {
    bool flag1 = this.IsNPC();
    bool flag2 = this.IsPet();
    bool flag3 = this.CanAttack(quai);
    return !flag1 && !flag2 && !flag3;
  }

  public bool isPlayerChinhXac()
  {
    bool flag = false;
    if (this.MyPlayers.AllPlayers.Count > 0)
    {
      try
      {
        for (int index = this.MyPlayers.AllPlayers.Count - 1; index >= 0; --index)
        {
          if (this.MyPlayers.AllPlayers[index].ID == this.MyQuai.TargetID)
          {
            flag = true;
            break;
          }
        }
      }
      catch (Exception ex)
      {
      }
    }
    return flag;
  }

  public bool IsNPC(QuaiIndividual quai = null)
  {
    return quai != null ? quai.CanAttack == (byte) 12 || quai.CanAttack == (byte) 10 || quai.CanAttack == (byte) 19 || quai.CanAttack == (byte) 9 || quai.CanAttack == (byte) 11 || quai.CanAttack == (byte) 2 || quai.CanAttack == (byte) 16 /*0x10*/ || quai.CanAttack == (byte) 17 || quai.CanAttack == (byte) 52 : this.MyQuai.CanAttackInt == 12 || this.MyQuai.CanAttackInt == 10 || this.MyQuai.CanAttackInt == 19 || this.MyQuai.CanAttackInt == 9 || this.MyQuai.CanAttackInt == 11 || this.MyQuai.CanAttackInt == 2 || this.MyQuai.CanAttackInt == 16 /*0x10*/ || this.MyQuai.CanAttackInt == 52;
  }

  public bool IsNPC2(QuaiIndividual quai = null)
  {
    return quai != null ? quai.CanAttack != (byte) 27 && quai.CanAttack != (byte) 28 && quai.CanAttack != (byte) 29 && quai.CanAttack != (byte) 18 && quai.CanAttack != (byte) 23 && quai.CanAttack != (byte) 30 && quai.CanAttack != byte.MaxValue && quai.CanAttack != (byte) 52 : this.MyQuai.CanAttackInt != 27 && this.MyQuai.CanAttackInt != 28 && this.MyQuai.CanAttackInt != 16 /*0x10*/ && this.MyQuai.CanAttackInt != 29 && this.MyQuai.CanAttackInt != 18 && this.MyQuai.CanAttackInt != 23 && this.MyQuai.CanAttackInt != 30 && this.MyQuai.CanAttackInt != (int) byte.MaxValue && this.MyQuai.CanAttackInt != 52;
  }

  private void PlayCaptchaSound()
  {
    if (frmLogin.GAuto.Settings.PlayCaptchaSoundStamp >= frmLogin.GlobalTimer.ElapsedMilliseconds)
      return;
    try
    {
      new SoundPlayer("alert.wav").Play();
      this.Myself.CaptchaAlertAudioStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    }
    catch (Exception ex)
    {
    }
  }

  private void DisconnectGame() => this.CallSendDisconnect();

  public void ResetTimeAdvanced()
  {
    if (this.Target.VersionNum == 3 || this.Target.VersionNum == 4 || this.Target.VersionNum == 5 || this.Target.VersionNum == 6 || this.Target.VersionNum == 7 || this.Target.VersionNum == 8 || this.Myself.OnlineTime < 1800000)
      return;
    if (this.IsPartyKeyInt() == 2 && !this.Myself.PartyKeyLock && !GA.CheckPartyKeyLock(this))
    {
      this.MyFlag.StartReconnectStamp = this.nowStamp() + 10000L;
      this.Myself.PartyKeyLock = true;
    }
    this.Myself.CurrentTarget = (QuaiIndividual) null;
    this.Myself.CurrentTargetID = -1;
    this.CallRemovePartyFollow();
    Thread.Sleep(1000);
    this.CallEnterReconnect();
    if (this.Target.VersionNum < 3)
      GA.WriteUserLog("Reset giờ chơi", this);
    Thread.Sleep(3000);
    this.Myself.ReadyToAttack = false;
    this.Myself.ResetTimeStamp.Reset();
    this.Myself.ResetTimeStamp.Start();
    this.Myself.tempResetFlag = false;
    this.Myself.Status = AllEnums.CharStatuses.IDLE;
    this.CallResetInformation();
    Thread.Sleep(2000);
    try
    {
      this.Target.PacketStamp = 0L;
    }
    catch (Exception ex)
    {
    }
  }

  private void PickupItems()
  {
    if (this.Myself.Status == AllEnums.CharStatuses.NHATBOC)
    {
      if (this.MyBoc.nhatBocTimeStamp.ElapsedMilliseconds >= 7000L)
      {
        this.Myself.Status = AllEnums.CharStatuses.IDLE;
        this.MyBoc.nhatBocTimeStamp.Reset();
        this.MyBoc.nhatBocTimeStamp.Start();
      }
      if (this.Myself.NhatBocStamp.ElapsedMilliseconds >= 200L)
      {
        this.Myself.Status = AllEnums.CharStatuses.IDLE;
        this.Myself.NhatBocStamp.Reset();
        this.Myself.NhatBocStamp.Start();
      }
    }
    if (this.Settings.cboxTuNhatVatPham && this.Myself.Status != AllEnums.CharStatuses.VETHANH && this.Myself.Status != AllEnums.CharStatuses.EATING && this.Myself.Status != AllEnums.CharStatuses.NMBUFFMAU && this.Myself.CanNhatBoc && !this.Myself.IsHaiDuaCarrying && !this.Myself.IsTrungAc)
    {
      if ((this.Myself.Status < AllEnums.CharStatuses.GOGOGO || this.Myself.Status == AllEnums.CharStatuses.NHATBOC) && !this.Myself.IsPK)
      {
        if (this.Myself.BocShowID == 0)
        {
          this.MyBoc.PosX = 0.0f;
          this.MyBoc.PosY = 0.0f;
          NewBoc newBoc = (NewBoc) null;
          double num = 99.0;
          if (this.MyBoc.AllBocs.Count > 0)
          {
            try
            {
              for (int index = this.MyBoc.AllBocs.Count - 1; index >= 0; --index)
              {
                NewBoc allBoc = this.MyBoc.AllBocs[index];
                if (allBoc.BocID != 0 && (allBoc.BocType == 5000 || allBoc.BocType == 808))
                {
                  double distance = GA.CalculateDistance((double) allBoc.PosX, (double) allBoc.PosY, (double) this.Myself.PosX, (double) this.Myself.PosY);
                  if (distance < num)
                  {
                    newBoc = allBoc;
                    num = distance;
                  }
                }
              }
            }
            catch (Exception ex)
            {
            }
          }
          if (newBoc != null)
          {
            int bocType = newBoc.BocType;
            if (num >= 1.0)
            {
              this.CallMoveTo((int) newBoc.PosX, (int) newBoc.PosY);
              this.Myself.TargetX = newBoc.PosX;
              this.Myself.TargetY = newBoc.PosY;
              this.Myself.TargetBocID = newBoc.BocID;
              this.Myself.MoveAcrossMap = false;
              this.Myself.UseAutoMove = false;
            }
            this.CallThocBocFunc(newBoc.BocID);
            this.MyBoc.LastActiveBocStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
            if (newBoc.BocType == 808)
              Thread.Sleep(7000);
            this.MyBoc.PosX = newBoc.PosX;
            this.MyBoc.PosY = newBoc.PosY;
            if (!this.Myself.FlagFullBoc)
              this.CallPickAllItems();
            else if (this.Myself.FlagFullBoc)
              this.CallClearBoc(this.Myself.BocShowID);
            if (newBoc.BocType == 808)
              Thread.Sleep(1000);
            else
              Thread.Sleep(100);
          }
          else
            this.Myself.Status = AllEnums.CharStatuses.IDLE;
        }
        if (this.Myself.BocShowID != 0 && this.Myself.BocShow == 1)
        {
          this.MyBoc.LastActiveBocStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
          if ((double) this.MyBoc.PosX != 0.0 && (double) this.MyBoc.PosY != 0.0)
            this.CallMoveTo((int) this.MyBoc.PosX, (int) this.MyBoc.PosY);
          this.CallPickAllItems();
          Thread.Sleep(100);
          this.CallClearBoc(this.Myself.BocShowID);
        }
        if (this.Myself.BocShowID != 0 && this.Myself.BocShow == 0 && frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyBoc.LastActiveBocStamp >= 10000L)
        {
          this.MyBoc.LastActiveBocStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
          this.CallPickAllItems();
          this.CallClearBoc(this.Myself.BocShowID);
          Thread.Sleep(100);
        }
      }
      this.FuncHuyItem();
    }
    else
    {
      if (this.Myself.CanNhatBoc || this.Myself.Status != AllEnums.CharStatuses.NHATBOC)
        return;
      this.Myself.Status = AllEnums.CharStatuses.IDLE;
    }
  }

  public void FuncHuyItem(bool checkCity = true)
  {
    if (this.Myself.ID <= 0 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.RemoveItemStamp < 3000L)
      return;
    if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.VutDoStamp > 10000L)
      this.Myself.VutDoStamp = 0L;
    this.Myself.RemoveItemStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    if ((this.IsInCity() || !checkCity) && checkCity && !this.Myself.isCauPhuc && !this.Myself.isNhatTuyet && !this.Myself.IsCheDo && !this.Myself.isDoiPhieuTienVang || this.Myself.VutDoStamp != 0L || !this.Settings.cboItemTuHuy || !frmLogin.GAuto.Settings.IsPro1)
      return;
    for (int index1 = 0; index1 < 60; ++index1)
    {
      InventoryItem allItem = this.MyInventory.AllItems[index1];
      string itemName = "";
      string itemType = "";
      if (this.Target.VersionNum == 3 && allItem.ItemID == 20309019)
      {
        itemName = "Chìa khóa Đồng Bảo Sương";
        itemType = "Chìa Khóa";
      }
      else
        GA.GetItemNameTypeFromID(allItem.ItemID, out itemName, out itemType);
      if (frmLogin.GAuto.Settings.ItemTuHuyList.Count > 0 && itemName != "chưa dùng" && itemName != "huyết trích tử")
      {
        if (itemName != "mão thử biến hình")
        {
          try
          {
            for (int index2 = frmLogin.GAuto.Settings.ItemTuHuyList.Count - 1; index2 >= 0; --index2)
            {
              string itemTuHuy = frmLogin.GAuto.Settings.ItemTuHuyList[index2];
              if (!string.IsNullOrEmpty(itemTuHuy) && (allItem.LastTimeSeen == 0L || allItem.LastTimeSeen != 0L && frmLogin.GlobalTimer.ElapsedMilliseconds - allItem.LastTimeSeen >= 3500L))
              {
                bool flag = false;
                if (itemName.Contains(itemTuHuy.ToLower()))
                  flag = true;
                if (itemType.Contains(itemTuHuy.ToLower()) && (!(itemType == "thực phẩm") || !(itemName == "ba kê")))
                  flag = true;
                if (flag)
                  this.CallRemoveInventoryItem(index1);
              }
              int result = 0;
              int.TryParse(itemTuHuy, out result);
              if (result > 0 && result == allItem.ItemID)
                this.CallRemoveInventoryItem(index1);
            }
          }
          catch (Exception ex)
          {
            if (GA.isVipMember())
              GA.WriteUserLog(frmMain.langErrorWhileDestroyingItems, this);
          }
        }
      }
    }
  }

  private QuaiIndividual TimQuaiTheoID(int ID)
  {
    if (this.MyQuai != null)
    {
      if (this.MyQuai.AllQuai.Count > 0)
      {
        try
        {
          for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
          {
            QuaiIndividual quaiIndividual = this.MyQuai.AllQuai[index];
            if (quaiIndividual.ID == ID)
              return quaiIndividual;
          }
        }
        catch (Exception ex)
        {
        }
      }
    }
    return (QuaiIndividual) null;
  }

  public bool CanAttackCheckValue(int attackByte)
  {
    return (attackByte == 27 || attackByte == 28 || attackByte == 29 || attackByte == 18 || attackByte == 34 || attackByte == 23 || attackByte == 16 /*0x10*/ || attackByte == 17 || attackByte == 52 || attackByte == 30) && attackByte != (int) byte.MaxValue;
  }

  public bool CanAttack(QuaiIndividual quai = null)
  {
    bool flag1;
    if (quai == null)
    {
      QuaiIndividual quaiById = this.MyQuai.GetQuaiByID(this.MyQuai.TargetID);
      if (quaiById != null)
      {
        if ((double) quaiById.HPPercent == 0.0)
          return false;
        if (frmLogin.GAuto.Settings.CompilingLanguage == "VN")
        {
          if (quaiById.Name == "Tháp phòng ngự" || quaiById.Name == "Trị Liệu Tháp" || quaiById.Name == "SauTháp liên nỗ" || quaiById.Name == "TrướcTháp liên nỗ" || quaiById.Name == "Tiêu Lăng" || quaiById.Name.Contains("Thanh Vân Đạo Tr") || quaiById.Name == "Cổ Điêu" || quaiById.Name == "Niên Thú" && !GA.IsBangMapID(this.Myself.MapID) || quaiById.Name == "Thực Phẩm Hỏng" || quaiById.Name == "Shishimai")
            return false;
        }
        else if (frmLogin.GAuto.Settings.CompilingLanguage == "EN")
        {
          if (quaiById.Name == "Shishimai" || quaiById.Name == "Defense Tower" || quaiById.Name == "Healing Tower" || quaiById.Name == "Corner Tower" || quaiById.Name == "Taoist")
            return false;
        }
        else if (frmLogin.GAuto.Settings.CompilingLanguage == "CN" && (quaiById.Name == "守御塔" || quaiById.Name == "治疗塔" || quaiById.Name == "连弩塔" || quaiById.Name == "萧陵" || quaiById.Name == "青云道长" || quaiById.Name == "蛊雕" || quaiById.Name == "腐烂的食物"))
          return false;
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - quaiById.noAttackStamp <= 1000L)
          return false;
        if (this.MyQuai.FirstAttackArray.Count > 0)
        {
          bool flag2 = false;
          for (int index = 0; index < this.MyQuai.FirstAttackArray.Count; ++index)
          {
            if (quaiById.Name.ToLower().Contains(this.MyQuai.FirstAttackArray[index].ToLower()))
            {
              flag2 = true;
              break;
            }
          }
          return flag2;
        }
        if (this.MyQuai.noAttackArray.Count > 0)
        {
          for (int index = 0; index < this.MyQuai.noAttackArray.Count; ++index)
          {
            if (quaiById.Name.ToLower().Contains(this.MyQuai.noAttackArray[index].ToLower()))
              return false;
          }
        }
        if (this.Settings.QuaiNoAttackList.Count > 0)
        {
          for (int index = 0; index < this.Settings.QuaiNoAttackList.Count; ++index)
          {
            if (string.Compare(quaiById.Name, this.Settings.QuaiNoAttackList[index], true) == 0)
              return false;
          }
        }
        if (this.MyQuai.IgnoredQuaiID.Count > 0 && this.MyQuai.IgnoredQuaiID.Contains(quaiById.ID))
          return false;
        flag1 = this.CanAttackCheckValue((int) quaiById.CanAttack);
        if (GA.IsBangMapID(this.Myself.MapID) && quaiById.Name == "Niên Thú" && this.CustomSleep(7, 3000))
        {
          int itemIndex = -1;
          for (int index = 0; index < 30; ++index)
          {
            if (this.MyInventory.AllItems[index].ItemID == 38001555)
            {
              itemIndex = index;
              break;
            }
          }
          if (itemIndex >= 0)
          {
            this.CallSelectTarget(quaiById.ID);
            Thread.Sleep(300);
            this.CallUseItem(itemIndex, quaiById.ID);
          }
        }
      }
      else
        flag1 = this.CanAttackCheckValue(this.MyQuai.CanAttackInt);
      if (this.MyQuai.CanAttackInt != 0)
        ;
    }
    else
    {
      if ((double) quai.HPPercent == 0.0)
        return false;
      if (frmLogin.GAuto.Settings.CompilingLanguage == "VN")
      {
        if (quai.Name == "Tháp phòng ngự" || quai.Name == "Trị Liệu Tháp" || quai.Name == "SauTháp liên nỗ" || quai.Name == "TrướcTháp liên nỗ" || quai.Name == "Tiêu Lăng" || quai.Name.Contains("Thanh Vân Đạo Tr") || quai.Name == "Cổ Điêu" || quai.Name == "Niên Thú" && !GA.IsBangMapID(this.Myself.MapID) || quai.Name == "Thực Phẩm Hỏng" || quai.Name == "Shishimai")
          return false;
      }
      else if (frmLogin.GAuto.Settings.CompilingLanguage == "EN")
      {
        if (quai.Name == "Shishimai" || quai.Name == "Defense Tower" || quai.Name == "Healing Tower" || quai.Name == "Corner Tower" || quai.Name == "Taoist" || quai.Name == "Shishimai")
          return false;
      }
      else if (frmLogin.GAuto.Settings.CompilingLanguage == "CN" && (quai.Name == "守御塔" || quai.Name == "治疗塔" || quai.Name == "连弩塔" || quai.Name == "萧陵" || quai.Name == "青云道长" || quai.Name == "蛊雕" || quai.Name == "腐烂的食物"))
        return false;
      if (frmLogin.GlobalTimer.ElapsedMilliseconds - quai.noAttackStamp <= 1000L)
        return false;
      if (this.MyQuai.FirstAttackArray.Count > 0)
      {
        bool flag3 = false;
        for (int index = 0; index < this.MyQuai.FirstAttackArray.Count; ++index)
        {
          if (quai.Name.Contains(this.MyQuai.FirstAttackArray[index]))
          {
            flag3 = true;
            break;
          }
        }
        return flag3;
      }
      if (this.MyQuai.noAttackArray.Count > 0)
      {
        for (int index = 0; index < this.MyQuai.noAttackArray.Count; ++index)
        {
          if (quai.Name.ToLower().Contains(this.MyQuai.noAttackArray[index].ToLower()))
            return false;
        }
      }
      if (this.Settings.QuaiNoAttackList.Count > 0)
      {
        for (int index = 0; index < this.Settings.QuaiNoAttackList.Count; ++index)
        {
          if (string.Compare(quai.Name, this.Settings.QuaiNoAttackList[index], true) == 0)
            return false;
        }
      }
      if (this.MyQuai.IgnoredQuaiID.Count > 0 && this.MyQuai.IgnoredQuaiID.Contains(quai.ID))
        return false;
      flag1 = this.CanAttackCheckValue((int) quai.CanAttack);
      if (GA.IsBangMapID(this.Myself.MapID) && quai.Name == "Niên Thú" && this.CustomSleep(7, 3000))
      {
        int itemIndex = -1;
        for (int index = 0; index < 30; ++index)
        {
          if (this.MyInventory.AllItems[index].ItemID == 38001555)
          {
            itemIndex = index;
            break;
          }
        }
        if (itemIndex >= 0)
        {
          this.CallSelectTarget(quai.ID);
          Thread.Sleep(300);
          this.CallUseItem(itemIndex, quai.ID);
        }
      }
    }
    return flag1;
  }

  public bool IsInCity()
  {
    return this.Myself.MapID == 0 || this.Myself.MapID == 1 || this.Myself.MapID == 2 || this.Myself.MapID == 186 || this.Myself.MapID == 480 || this.Myself.MapID == 181;
  }

  private void CallRunSkill(int myType = 1)
  {
    int posX = 0;
    int posY = 0;
    if (this.Myself.Menpai == AllEnums.Menpais.DUONGMON || this.Myself.Menpai == AllEnums.Menpais.VODANG || this.Myself.Menpai == AllEnums.Menpais.TIEUDAO || this.Myself.Menpai == AllEnums.Menpais.THIENSON || this.Myself.Menpai == AllEnums.Menpais.QUYCOC)
    {
      posX = 999;
      posY = 999;
      MovingPoint movingPoint = this.Myself.PathHistory.NextPoint(20.0);
      if (movingPoint != null)
      {
        posX = (int) movingPoint.X;
        posY = (int) movingPoint.Y;
      }
    }
    switch (myType)
    {
      case 1:
        if (posX <= 0 || posY <= 0)
        {
          this.CallAttackTargetPacket(this.Myself.ID, this.Myself.MenpaiRunSkill, 0, 0, 0);
          break;
        }
        if (posX != 999 && posY != 999)
        {
          this.CallAttackTarget(-1, this.Myself.MenpaiRunSkill, posX, posY);
          break;
        }
        break;
      case 2:
        if (this.Myself.Menpai == AllEnums.Menpais.THIENSON)
        {
          this.CallAttackTarget(-1, 503, posX, posY);
          break;
        }
        if (this.Myself.Menpai == AllEnums.Menpais.THIENSON)
        {
          this.CallAttackTarget(-1, 1872, posX, posY);
          break;
        }
        break;
    }
    if ((double) this.Myself.TargetX <= 0.0 || (double) this.Myself.TargetY <= 0.0)
      return;
    Thread.Sleep(200);
    this.CallMoveFlashPos((int) this.Myself.TargetX, (int) this.Myself.TargetY);
  }

  public void CallAcceptPartyInvite(int inviterDBID)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ACCEPTPTINVITE, (IntPtr) inviterDBID, (IntPtr) 0);
    this.CallClearInvite();
  }

  public void CallSelectTargetOfTarget()
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_SELECTTARGETOF, (IntPtr) 0, (IntPtr) 0);
  }

  public void CallGetTargetID()
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_GETQUAIID, (IntPtr) 0, (IntPtr) 0);
  }

  public void CallTuyenChien(int gameID)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_TUYENCHIEN, (IntPtr) gameID, (IntPtr) 0);
  }

  public void CallRemovePartyFollow()
  {
    if (this.Myself.JustWarped || this.Myself.isSceneTrans == 1 || this.Myself.ID <= 0 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.talkNPCStamp < 4000L && this.MyFlag.talkNPCStamp > 0L)
      return;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_REMOVEPARTYFOLLOW, (IntPtr) 0, (IntPtr) 0);
  }

  public void CallRemovePartyFollowSafe()
  {
    if (this.MyParty.PartyNumbers <= 0 || this.Myself.IsPartyFollowed != (byte) 1)
      return;
    bool flag = this.CheckMemberDistance(8.0, true);
    long num = frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.removePartyFollowStamp;
    if (this.MyFlag.removePartyFollowStamp == 0L || num > 15000L)
    {
      this.MyFlag.removePartyFollowStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
      num = frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.removePartyFollowStamp;
    }
    if (!flag && num <= 5000L)
      return;
    this.MyFlag.removePartyFollowStamp = 0L;
    this.CallRemovePartyFollow();
    Thread.Sleep(350);
    GA.PartyDoSomething(this, mode: 30);
  }

  public void CallDenyPartyInvite(bool blacklist = false)
  {
    if (this.Target.VersionNum != 3 && this.Target.VersionNum != 4 && (this.Settings.cboxTuVaoPT || this.Settings.cboxPTLevel || blacklist))
      MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_DENYPTINVITE, (IntPtr) 0, (IntPtr) 0);
    this.CallClearInvite();
  }

  public void CallClearInvite()
  {
    this.WriteFuncParams(new MessageFunc()
    {
      Message = 2003
    });
  }

  public void CallSendAcceptPTAsk(int accept, int askerDB)
  {
    if (this.Target.VersionNum == 3)
      return;
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ALLOWPTJOIN, (IntPtr) accept, (IntPtr) askerDB);
    this.WriteFuncParams(new MessageFunc()
    {
      Message = 2004
    });
  }

  public void SetJustWarpedFlag(int istrue = 0)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_JUSTWARPED, (IntPtr) istrue, (IntPtr) 0);
  }

  public void CallChoVaoPT()
  {
    if (this.Target.VersionNum == 3 || this.Target.VersionNum == 4)
      MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ALLOWPTJOINTK, (IntPtr) this.MyParty.PTAskDBAsker, (IntPtr) 0);
    else
      MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ALLOWPTJOIN, (IntPtr) 1, (IntPtr) 1);
    this.WriteFuncParams(new MessageFunc()
    {
      Message = 2004
    });
  }

  public void CallKhongChoVaoPT(bool blacklist = false)
  {
    if (this.Target.VersionNum == 3 || this.Target.VersionNum == 4)
      return;
    if ((this.Settings.cboxPTChoVao || this.Settings.cboxPTLevel || blacklist) && this.Target.VersionNum != 3)
    {
      GA.WriteUserLog(frmMain.langDenyPTMsg2, this, (object) this.MyParty.PTAskName, (object) this.MyParty.PTAskLevel);
      MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_ALLOWPTJOIN, (IntPtr) 1, (IntPtr) 2);
    }
    this.WriteFuncParams(new MessageFunc()
    {
      Message = 2004
    });
  }

  private void CallSendPass2()
  {
    this.Target.SendControlMessage(frmLogin.GAuto.Settings.WM_PASSCAP2, new MyControlClass()
    {
      string1 = this.Settings.txtPassCap2
    }, ref this.Target.ControlSignalAlloc);
  }

  public void CallLenNgua()
  {
    if (this.Myself.HorseType != -1 || this.Myself.IsPartyFollowed != (byte) 0)
      return;
    this.CallMounting();
  }

  public void CallXuongNgua()
  {
    if (this.Myself.IsPartyFollowed != (byte) 0)
      return;
    if (this.Myself.HorseType != -1)
      this.CallMounting();
    if (this.Myself.HorseType > 0)
    {
      this.Myself.LenNguaStamp = 0L;
      this.CallMounting();
      if (this.Myself.HorseType > 0)
      {
        this.Myself.LenNguaStamp = 0L;
        this.CallMounting();
      }
    }
    this.Myself.NoTargetStamp = 0L;
    this.Myself.hetquaiStamp = 0L;
    this.Myself.MyLastStamp = 0L;
  }

  public void CallMounting()
  {
    bool flag1 = true;
    if (this.Myself.LenNguaStamp > frmLogin.GlobalTimer.ElapsedMilliseconds)
      flag1 = false;
    if (!flag1)
      return;
    int millisecondsTimeout = 700;
    if (this.Myself.HorseType == -1)
    {
      if (this.Myself.isBuonDuaHau && this.Myself.QuestStep >= 3 && this.Myself.QuestStep <= 6 || frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.IsAttackedTimeStamp <= 10000L && this.Myself.IsAttackedTimeStamp > 0L && !this.IsInCity() || frmLogin.GAuto.Settings.optKhongDungNgua || !this.Settings.DungNgua)
        return;
      millisecondsTimeout = 1000;
    }
    this.CallAttackTargetPacket(this.Myself.ID, 21, 0, 0, 0);
    switch (millisecondsTimeout)
    {
      case 700:
        for (int index = 0; index <= 5 && this.Myself.HorseType != -1; ++index)
          Thread.Sleep(300);
        return;
      case 1000:
        Thread.Sleep(millisecondsTimeout);
        if (this.Myself.ActionStatus != (byte) 5)
        {
          this.CallAttackTargetPacket(this.Myself.ID, 21, 0, 0, 0);
          Thread.Sleep(millisecondsTimeout);
          break;
        }
        break;
    }
    if (this.Myself.ActionStatus != (byte) 5)
      return;
    bool flag2 = false;
    bool flag3 = false;
    long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
    while (!flag2 && !flag3 && this.Myself.HorseType == -1 && frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds < 8500L)
      Thread.Sleep(300);
    this.Myself.LenNguaStamp = frmLogin.GlobalTimer.ElapsedMilliseconds + 2000L;
    this.Myself.LastPostStamp.Reset();
    this.Myself.LastPostStamp.Start();
  }

  public void WaitForConditionInt(ref int param1, int param2, int timeout)
  {
    bool flag1 = false;
    bool flag2 = false;
    long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
    while (!flag1 && !flag2)
    {
      if (param1 != param2)
        flag1 = true;
      else if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds >= (long) timeout)
        flag2 = true;
      else
        Thread.Sleep(200);
    }
  }

  public void CallTangHinh()
  {
    if (!this.MySkills.HasSkill(248) || this.MySkills.SkillDelays[24].SkillDelay > 0)
      return;
    this.CallAttackTargetPacket(this.Myself.ID, 248, 0, 0, 0);
  }

  public void AddNPCNameToArray(string npcName, int mode = 1)
  {
    if (!(npcName != ""))
      return;
    try
    {
      bool flag = false;
      if (mode == 1)
      {
        if (this.MyQuai.noAttackArray.Count > 0)
        {
          for (int index = 0; index < this.MyQuai.noAttackArray.Count; ++index)
          {
            if (npcName == this.MyQuai.noAttackArray[index])
              flag = true;
          }
        }
        if (!flag)
          this.MyQuai.noAttackArray.Add(npcName);
      }
      if (mode != 2)
        return;
      List<string> stringList = new List<string>();
      if (npcName == "ytonpc")
      {
        switch (frmLogin.CompilingLanguage)
        {
          case "VN":
            stringList = new List<string>()
            {
              "c Lão Ta",
              "ân Trung H",
              "ệp Nhị Nư",
              "iên Khá"
            };
            break;
          case "EN":
            stringList = new List<string>()
            {
              "aosan Yu",
              "Brute",
              "razy Moth",
              "ruel Tua"
            };
            break;
          case "CN":
            stringList = new List<string>()
            {
              "岳老三",
              "云中鹤",
              "叶二娘",
              "段延庆"
            };
            break;
        }
      }
      for (int index1 = 0; index1 < stringList.Count; ++index1)
      {
        if (stringList.Count > 0)
        {
          string str = stringList[index1];
          if (str != "")
            npcName = str;
        }
        if (this.MyQuai.FirstAttackArray.Count > 0)
        {
          for (int index2 = 0; index2 < this.MyQuai.FirstAttackArray.Count; ++index2)
          {
            if (npcName == this.MyQuai.FirstAttackArray[index2])
              flag = true;
          }
        }
        if (!flag)
          this.MyQuai.FirstAttackArray.Add(npcName);
      }
    }
    catch (Exception ex)
    {
      if (!GA.isVipMember())
        return;
      GA.WriteUserLog(frmMain.langErrorAddingName, this);
    }
  }

  public bool WaitPartyFull(int songuoi = 1, int level = 1)
  {
    bool flag1 = false;
    if (this.IsPartyKeyAlone())
    {
      if (this.MyParty.PartyNumbers < songuoi)
      {
        if (!this.Settings.cboxPTLevel)
          return false;
        flag1 = true;
        if (this.MyParty.PartyNumbers <= 0 && (this.MyFlag.xongQstamp <= 0L || frmLogin.GlobalTimer.ElapsedMilliseconds - this.MyFlag.xongQstamp > 120000L))
        {
          this.CallLeavePT();
          return false;
        }
      }
    }
    else
    {
      if (this.MyParty.PartyNumbers > 0)
        return true;
      if (this.Settings.cboxPTLevel)
        flag1 = true;
    }
    if (!flag1)
      return true;
    if (this.MyPlayers.AllPlayers.Count <= 0)
      return false;
    try
    {
      for (int index1 = this.MyPlayers.AllPlayers.Count - 1; index1 >= 0; --index1)
      {
        string str = "";
        if (this.MyPlayers.AllPlayers[index1].Level >= level)
          str = this.MyPlayers.AllPlayers[index1].Name;
        if (str != "")
        {
          bool flag2 = true;
          if (this.MyFlag.NamePartyArray.Count > 0)
          {
            for (int index2 = this.MyFlag.NamePartyArray.Count - 1; index2 >= 0; --index2)
            {
              if (str == this.MyFlag.NamePartyArray[index2])
                flag2 = false;
            }
          }
          if (flag2)
          {
            if (this.IsPartyKey())
              this.CallInviteParty(str);
            else
              this.CallXinVaoParty(str);
            this.MyFlag.NamePartyArray.Add(str);
          }
        }
      }
      return false;
    }
    catch (Exception ex)
    {
      GA.WriteUserLog(frmMain.langWhileLookingforPT, this);
      return false;
    }
  }

  public void SearchQuai(ref int count, string name = "", bool canAttack = false)
  {
    name = name.ToLower();
    if (this.MyQuai.AllQuai.Count <= 0)
      return;
    try
    {
      for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
      {
        QuaiIndividual quai = this.MyQuai.AllQuai[index];
        bool flag1 = true;
        if (this.HasActivePet())
        {
          if (quai.ID != this.MyPet.AllPets[this.MyPet.ActivePetIndex].ID)
            flag1 = false;
        }
        else
          flag1 = false;
        bool flag2 = true;
        if (canAttack && !this.CanAttack(quai))
          flag2 = false;
        if (quai.ID >= 0 && (double) quai.HPPercent > 0.0 && quai.ID != this.Myself.ID && !flag1 && flag2 && quai.Name.ToLower().Contains(name))
        {
          this.CallSetUpNhiemVuData((int) quai.PosX, (int) quai.PosY);
          this.MyFlag.tempInt = (int) quai.HPPercent;
          ++count;
        }
      }
    }
    catch (Exception ex)
    {
      if (!GA.isVipMember())
        return;
      GA.WriteUserLog(frmMain.langErrorQ2MissingMobs, this);
    }
  }

  public void BGHandler()
  {
    if (this == null)
      return;
    while (this.Target.BGRunner)
    {
      if (this != null)
      {
        try
        {
          if (frmLogin.GAuto.Settings.optGCafe && !this.MyFlag.OKToInject)
          {
            int tempLevel = 0;
            int tempMaxHP = 0;
            int tempMenpai = -1;
            int tempRage = -1;
            if (frmLogin.GAuto.Settings.AllowReadMem)
            {
              SmartClass.ReadBriefInfo(this.Target.ProcessHandle, this.Target.MyBase, ref tempLevel, ref tempMaxHP, ref tempMenpai, ref tempRage, this);
              if (tempMaxHP > 0 && tempLevel > 0 && tempLevel <= 150 && tempMenpai >= 0 && tempMenpai <= 12 && tempRage >= 0 && tempRage <= 1000)
                this.MyFlag.OKToInject = true;
            }
          }
          if (!this.MyFlag.OKToInject || !frmLogin.GAuto.Settings.optGCafe)
          {
            if (frmLogin.GAuto.Settings.optGCafe)
              goto label_20;
          }
          if (!this.Target.IsHooked && !this.Target.IsInjected)
          {
            lock (frmLogin.dlllock)
            {
              if (!this.Target.HasActiveProfile)
                SmartClass.InjectDll(this);
              else
                SmartClass.InjectDll(this, true);
            }
          }
          if (!this.Target.AICreated)
          {
            if (!this.Target.TempRemoved)
            {
              if (!frmLogin.AutoInfoOK || !(frmLogin.CompilingLanguage == "VN"))
              {
                if (!(frmLogin.CompilingLanguage != "VN"))
                  goto label_20;
              }
              int loginAction = this.MyFlag.LoginAction;
              frmMain.HookToProcess(this, (uint) this.Target.ProcessID);
              this.MyFlag.LoginAction = loginAction;
            }
          }
        }
        catch (Exception ex)
        {
          GA.WriteUserLog(frmMain.langBaoHook + ex.Message, this);
        }
label_20:
        try
        {
          if (!this.Target.TempRemoved)
          {
            int num1 = 3000;
            int num2 = 1000;
            if (!frmLogin.GAuto.Settings.LamNheAuto)
            {
              this.MyFlag.Slow3000Read = true;
              this.MyFlag.Slow1000Read = true;
              this.MyFlag.Slow1MinRead = true;
            }
            else
            {
              this.MyFlag.Slow3000Read = false;
              this.MyFlag.Slow1000Read = false;
              if (this.MyFlag.Slow3000ReadStamp < this.nowStamp())
              {
                this.MyFlag.Slow3000ReadStamp = this.nowStamp() + (long) num1;
                this.MyFlag.Slow3000Read = true;
              }
              if (this.MyFlag.Slow1000ReadStamp < this.nowStamp())
              {
                this.MyFlag.Slow1000ReadStamp = this.nowStamp() + (long) num2;
                this.MyFlag.Slow1000Read = true;
              }
              if (this.MyFlag.Slow1MinReadStamp < this.nowStamp())
              {
                this.MyFlag.Slow1MinReadStamp = this.nowStamp() + 60000L;
                this.MyFlag.Slow1MinRead = true;
              }
            }
            SmartClass.ReadMemory(this);
            SmartClass.ProcessBocRing(this);
            SmartClass.ProcessMsgRing(this);
            SmartClass.ProcessNguoiRing(this);
            SmartClass.ProcessQuaiRing(this);
            SmartClass.ProcessPackets(this);
            SmartClass.ProcessVariables(this);
            SmartClass.ProcessAIMsg(this);
          }
        }
        catch (Exception ex)
        {
          if (ex.Message == "Thread was being aborted.")
          {
            if (GA.isVipMember())
              GA.WriteUserLog("BG Thread báo thread abort, không quan tâm", this);
          }
          else
          {
            if (!this.Target.HasException)
              GA.WriteUserLog($"{frmMain.langReportBGT}{ex.Message} Stack: {ex.StackTrace.ToString()}", this);
            this.Target.HasException = true;
          }
        }
        if (this.Myself != null)
        {
          if (!this.Myself.SetHotKey)
          {
            try
            {
              this.Myself.SetHotKey = true;
              for (int index = 0; index < GA.ActiveHotKeys.Count; ++index)
              {
                if (GA.ActiveHotKeys[index].KeyMessage == GA.DefaultHotKeys[index].KeyMessage && (GA.ActiveHotKeys[index].KeyValue != GA.DefaultHotKeys[index].KeyValue || GA.ActiveHotKeys[index].Changed))
                {
                  this.CallUpdateHotKey(index, GA.ActiveHotKeys[index].KeyValue);
                  GA.ActiveHotKeys[index].Changed = false;
                }
              }
            }
            catch (Exception ex)
            {
              GA.WriteUserLog(frmMain.langBaoHook2 + ex.Message, this);
            }
          }
        }
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Target.BGThreadStamp >= 2000L)
        {
          this.Target.BGThreadStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
          this.Target.BGRandom = frmLogin.GlobalTimer.ElapsedMilliseconds;
        }
        if (frmLogin.GlobalTimer.ElapsedMilliseconds - this.Target.sequenceStamp > 2000L)
        {
          this.Target.sequenceStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
          try
          {
            if (!this.Target.DLLRead && frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.StartingStamp >= 5000L)
            {
              SmartClass.ReadMyValueUInt(this, ref this.Target.DLLPatchedValue, this.Target.DLLChecking + this.Target.ExeBase + 4096 /*0x1000*/);
              if (this.Target.DLLPatchedValue == 6971548U)
                this.Target.DLLRead = true;
            }
            if (this.Target.DLLRead)
            {
              if (!this.Target.ThreadDied)
              {
                SmartClass.ReadMyValueUInt(this, ref this.Target.DLLPatchedValue, this.Target.DLLChecking + this.Target.ExeBase + 4096 /*0x1000*/);
                if (this.Target.DLLPatchedValue != 6971548U)
                {
                  if (this.Target.DLLPatchedValue != 0U)
                  {
                    if (!this.Target.DLLExit)
                    {
                      this.Target.ThreadDied = true;
                      this.Target.DLLRead = false;
                      this.Target.ThreadDiedStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                      this.CallBringWindowUp(this.Target.MainWindowHandle);
                    }
                  }
                }
              }
            }
          }
          catch (Exception ex)
          {
            GA.WriteUserLog(frmMain.langBaoThread, this);
          }
        }
        if (frmLogin.BlockChatStamp == 0L || frmLogin.BlockChatStamp > 0L && frmLogin.GlobalTimer.ElapsedMilliseconds - frmLogin.BlockChatStamp >= 900000L)
        {
          frmLogin.BlockChatStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
          if (!frmLogin.GAuto.Settings.BlockChat)
            MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_BLOCKCHAT, IntPtr.Zero, IntPtr.Zero);
          else
            MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_BLOCKCHAT, (IntPtr) 1, IntPtr.Zero);
        }
        if (this.Myself.ID <= 0)
        {
          try
          {
            if (this.Target.PacketStamp != 0L)
              this.Target.PacketStamp = 0L;
            if (this.Target.DLLCounter != 0L)
              this.Target.DLLCounter = 0L;
          }
          catch (Exception ex)
          {
          }
        }
        if (this.Target.TempRemoved)
        {
          try
          {
            if (this.Target.PacketStamp != 0L)
              this.Target.PacketStamp = 0L;
            if (this.Target.DLLCounter != 0L)
              this.Target.DLLCounter = 0L;
          }
          catch (Exception ex)
          {
          }
        }
        try
        {
          if (this.Target.PacketStamp > 0L)
          {
            if (this.Target.DLLCounter > 0L)
            {
              if (this.Target.DLLCounter - this.Target.PacketStamp >= 180000L)
              {
                if (frmLogin.GAuto.Settings.TuThoatGameDis)
                {
                  GA.WriteUserLog(frmMain.langOutGameDisc, this, (object) (this.Target.DLLCounter - this.Target.PacketStamp).ToString(), (object) this.Target.DLLCounter.ToString(), (object) this.Target.PacketStamp.ToString());
                  this.Target.PacketStamp = 0L;
                  this.CallOutGame();
                  try
                  {
                    new SoundPlayer("disconnect.wav").Play();
                  }
                  catch (Exception ex)
                  {
                  }
                }
              }
            }
          }
        }
        catch (Exception ex)
        {
        }
      }
      if (frmLogin.LastGLoginThread.Contains(this.BGThread.ManagedThreadId) && frmLogin.GAuto.AllAutoAccounts.Count == 0)
      {
        if (this.AIThread == null)
        {
          try
          {
            frmLogin.LastGLoginThread.Clear();
            this.Target.BGRunner = false;
          }
          catch (Exception ex)
          {
          }
        }
      }
      Thread.Sleep(frmLogin.GAuto.Settings.numDelayTrue);
    }
    this.MyFlag.EndBG = true;
  }

  public static unsafe void SendPatchInfoPattern(AutoAccount account)
  {
    Stopwatch stopwatch = new Stopwatch();
    stopwatch.Start();
    account.MyFlag.HookStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
    if (frmLogin.HashDB.Count > 0)
    {
      foreach (HashDBElement hashDbElement in frmLogin.HashDB)
      {
        if (hashDbElement.NewHash == account.Target.TargetHash)
        {
          string matchingHash = hashDbElement.MatchingHash;
          account.Target.TargetHash = matchingHash;
        }
      }
    }
    string str1 = "1,rmin,";
    int num1 = 0;
    bool flag1 = true;
    if (account.Target.ClientPattern != null && account.Target.ClientPattern.Readmems.Count > 0)
    {
      foreach (GReadMem readmem1 in account.Target.ClientPattern.Readmems)
      {
        if (!readmem1.HasFinalOffset)
        {
          for (int index1 = readmem1.DataString.Count - 1; index1 >= 0; --index1)
          {
            string str2 = readmem1.DataString[index1];
            if (str2.StartsWith("rm") && account.Target.ClientPattern.Readmems.Count > 0)
            {
              foreach (GReadMem readmem2 in account.Target.ClientPattern.Readmems)
              {
                if (readmem2.Name == str2)
                {
                  List<string> stringList = new List<string>();
                  if (readmem2.DataString.Count > 0)
                  {
                    readmem1.DataString.RemoveAt(index1);
                    for (int index2 = readmem2.DataString.Count - 1; index2 >= 0; --index2)
                      readmem1.DataString.Insert(index1, readmem2.DataString[index2]);
                    break;
                  }
                  break;
                }
              }
            }
          }
          if (num1 > 0)
          {
            bool flag2 = true;
            if (readmem1.DataString.Count > 0)
            {
              foreach (string str3 in readmem1.DataString)
              {
                if (str3.Contains("rm"))
                {
                  flag2 = false;
                  break;
                }
              }
            }
            if (flag2)
              str1 = $"{str1},{readmem1.Name.ToLower()},{readmem1.DataType},{readmem1.DataString.Count.ToString()}";
          }
          else
            str1 = $"{str1}{readmem1.Name.ToLower()},{readmem1.DataType},{readmem1.DataString.Count.ToString()}";
          if (readmem1.DataString.Count > 0)
          {
            for (int index = 0; index < readmem1.DataString.Count; ++index)
            {
              string str4 = readmem1.DataString[index];
              if ((str4.Contains("_") || str4.Contains("rm")) && str4.StartsWith("bs_") && account.Target.ClientPattern.Membases.Count > 0)
              {
                foreach (GMemBase membase in account.Target.ClientPattern.Membases)
                {
                  if (membase.Name == str4)
                  {
                    string[] strArray = str4.Split('_');
                    int num2 = 4194304 /*0x400000*/;
                    if (strArray.Length == 3)
                      num2 = 0;
                    str4 = (membase.Value - num2).ToString("X2");
                    readmem1.DataString[index] = (membase.Value - num2).ToString("X2");
                    break;
                  }
                }
              }
              str1 = !flag1 ? str1 + str4 : $"{str1},0x{Convert.ToInt32(str4, 16 /*0x10*/).ToString("X2")}";
              ++num1;
              flag1 = true;
            }
          }
        }
      }
    }
    int num3 = 0;
    bool flag3 = true;
    string str5 = str1 + ",|1,oppa,";
    if (account.Target.ClientPattern != null && account.Target.ClientPattern.Opcodes.Count > 0)
    {
      foreach (GOpcode opcode in account.Target.ClientPattern.Opcodes)
      {
        if (opcode.MyBase != null)
        {
          if (opcode.MyBase.Name != "")
          {
            foreach (GMemBase membase in account.Target.ClientPattern.Membases)
            {
              if (membase.Name == opcode.MyBase.Name)
              {
                opcode.MyBase = membase;
                break;
              }
            }
          }
          if (num3 > 0)
            str5 = $"{str5},0x{(opcode.MyBase.Value - 4198400 /*0x401000*/).ToString("X2")},{opcode.Index.ToString()},{opcode.NOPFills.ToString()}";
          else
            str5 = $"{str5}0x{(opcode.MyBase.Value - 4198400 /*0x401000*/).ToString("X2")},{opcode.Index.ToString()},{opcode.NOPFills.ToString()}";
          ++num3;
        }
      }
    }
    int num4 = 0;
    flag3 = true;
    string str6 = str5 + ",|1,rb,";
    if (account.Target.ClientPattern != null && account.Target.ClientPattern.Membases.Count > 0)
    {
      foreach (GMemBase membase in account.Target.ClientPattern.Membases)
      {
        if (membase != null && membase.Name.StartsWith("bs") && !membase.Name.Contains("_"))
        {
          if (num4 > 0)
            str6 = $"{str6},{membase.Name},0x{membase.Value.ToString("X2")}";
          else
            str6 = $"{str6}{membase.Name},0x{membase.Value.ToString("X2")}";
          ++num4;
          if (membase.Name == "bs31")
            str6 = $"{str6},bs32,{account.Target.VersionNum.ToString("0")}";
        }
      }
    }
    stopwatch.Stop();
    if (!str6.EndsWith(","))
      str6 += ",";
    string[] strArray1 = str6.Split('|');
    if (strArray1.Length >= 3)
    {
      MyControlClass msgParams = new MyControlClass();
      msgParams.string1 = strArray1[0];
      AutoAccount.MyMemReadParseCN(strArray1[0], account);
      msgParams.string2 = strArray1[1];
      if (msgParams.string2.Contains(","))
      {
        string midString = GA.GetMidString(msgParams.string2, ",", ",", 2);
        try
        {
          account.Target.DLLChecking = Convert.ToInt32(midString, 16 /*0x10*/);
        }
        catch (Exception ex)
        {
          account.Target.DLLChecking = 16517;
        }
        account.Target.DLLRead = false;
      }
      msgParams.string3 = strArray1[2];
      msgParams.string4 = $"1,MainHandle,{account.Target.MainWindowHandle.ToString()},";
      account.Target.SendControlMessage(frmLogin.GAuto.Settings.WM_CONTROLMSG, msgParams, ref account.Target.ControlSignalAlloc);
    }
    account.Target._PlayerRef = (byte*) (void*) account.Target.PlayerpView;
    account.Target._RingRef = (byte*) (void*) account.Target.RingPacketpView;
    account.Target._RingQuaiRef = (byte*) (void*) account.Target.RingQuaipView;
    account.Target._RingNguoiRef = (byte*) (void*) account.Target.RingNguoipView;
    account.Target._RingBocRef = (byte*) (void*) account.Target.RingBocpView;
    account.Target._RingMsgRef = (byte*) (void*) account.Target.RingMsgpView;
    account.Target._RingHKRef = (byte*) (void*) account.Target.RingHKpView;
  }

  public static void MyMemReadParseCN(string rmstring, AutoAccount account)
  {
    if (account == null || account.Target == null)
      return;
    List<string> stringList = new List<string>((IEnumerable<string>) rmstring.Split(','));
    if (stringList.Count < 6)
      return;
    int index1 = 2;
    bool flag1 = false;
    while (!flag1)
    {
      ReadMemEntry readMemEntry = new ReadMemEntry();
      for (int index2 = 0; index2 < 10; ++index2)
        readMemEntry.OffsetToRead[index2] = -1;
      bool flag2 = false;
      int num = 0;
      if (!flag2)
      {
        readMemEntry.Identifier = stringList[index1];
        readMemEntry.MemType = stringList[index1 + 1];
        byte result = 0;
        byte.TryParse(stringList[index1 + 2], out result);
        readMemEntry.Count = result;
        num = (int) readMemEntry.Count;
        for (int index3 = index1 + 3; index3 < index1 + (int) readMemEntry.Count + 3; ++index3)
          readMemEntry.OffsetToRead[index3 - index1 - 3] = Convert.ToInt32(stringList[index3], 16 /*0x10*/);
        account.Target.ReadmemContainer.Add(readMemEntry);
      }
      index1 += num + 3;
      if (index1 >= stringList.Count - 1)
        flag1 = true;
    }
  }

  public void PickAllBoc(GScriptCommand cmd)
  {
    try
    {
      if (cmd != null)
      {
        if (cmd.Count > 0)
        {
          int result = 808;
          int.TryParse(cmd.Params[0].ToString(), out result);
          NewBoc newBoc = (NewBoc) null;
          double num = 9999.0;
          for (int index = this.MyBoc.AllBocs.Count - 1; index >= 0; --index)
          {
            NewBoc allBoc = this.MyBoc.AllBocs[index];
            if (allBoc.BocType == result)
            {
              double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) allBoc.PosX, (double) allBoc.PosY);
              if (distance < num)
              {
                newBoc = allBoc;
                num = distance;
              }
            }
          }
          bool flag = false;
          if (newBoc != null && newBoc.BocID != 0)
            flag = true;
          if (flag)
          {
            double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) newBoc.PosX, (double) newBoc.PosY);
            if (distance > 2.0)
            {
              this.Myself.TargetX = newBoc.PosX;
              this.Myself.TargetY = newBoc.PosY;
              this.CallMoveFlashPos((int) newBoc.PosX, (int) newBoc.PosY);
              this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
            }
            else
            {
              if (distance > 2.0)
                return;
              this.CallThocBocFunc(newBoc.BocID);
              Thread.Sleep(7000);
              this.CallPickAllItems();
              Thread.Sleep(1000);
            }
          }
          else
            cmd.Status = AllEnums.ScriptStatuses.FINISHED;
        }
        else
          cmd.Status = AllEnums.ScriptStatuses.FINISHED;
      }
      else
        cmd.Status = AllEnums.ScriptStatuses.FINISHED;
    }
    catch (Exception ex)
    {
      int num = (int) MessageBox.Show("Lỗi function MoveTalkNPCScript", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Hand);
      if (cmd == null)
        return;
      cmd.Status = AllEnums.ScriptStatuses.FINISHED;
    }
  }

  public void MoveToScript(GScriptCommand cmd)
  {
    try
    {
      if (cmd.Count >= 2)
      {
        if (cmd.Count == 2)
        {
          int result1 = 0;
          int.TryParse(cmd.Params[0].ToString(), out result1);
          int result2 = 0;
          int.TryParse(cmd.Params[1].ToString(), out result2);
          if (result1 == 0 || result2 == 0)
            return;
          this.Myself.TargetX = (float) result1;
          this.Myself.TargetY = (float) result2;
          this.Myself.MoveAcrossMap = false;
          this.CallMoveFlashPos(result1, result2);
          this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
        }
        else
        {
          if (cmd.Count != 3)
            return;
          int result3 = 0;
          int.TryParse(cmd.Params[0].ToString(), out result3);
          int result4 = 0;
          int.TryParse(cmd.Params[1].ToString(), out result4);
          int result5 = -1;
          int.TryParse(cmd.Params[2].ToString(), out result5);
          if (result3 != 0 && result4 != 0 && result5 != -1 && result5 != this.Myself.MapID)
          {
            this.Myself.TargetX = (float) result3;
            this.Myself.TargetY = (float) result4;
            this.Myself.TargetMapID = result5;
            this.Settings.SavedPosX = (float) result3;
            this.Settings.SavedPosY = (float) result4;
            this.Settings.SavedMapID = result5;
            this.Myself.MoveFlashPos = true;
            this.Myself.LongMoveMapID = result5;
            this.Myself.LongMoveX = result3;
            this.Myself.LongMoveY = result4;
            this.Myself.MoveLongTrigger = true;
          }
          else
          {
            if (result5 != this.Myself.MapID)
              return;
            this.Myself.TargetX = (float) result3;
            this.Myself.TargetY = (float) result4;
            this.Myself.MoveAcrossMap = false;
            this.CallMoveFlashPos(result3, result4);
            this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
          }
        }
      }
      else
        cmd.Status = AllEnums.ScriptStatuses.FINISHED;
    }
    catch (Exception ex)
    {
      int num = (int) MessageBox.Show("Lỗi function MoveToScript", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Hand);
      if (cmd == null)
        return;
      cmd.Status = AllEnums.ScriptStatuses.FINISHED;
    }
  }

  public void NhanQuestDuaHau(GScriptCommand cmd, int npcid)
  {
    try
    {
      if (cmd != null && cmd.Count > 0)
      {
        int result = 0;
        int.TryParse(cmd.Params[0].ToString(), out result);
        switch (result)
        {
          case 0:
            this.CallNhanNhiemVu();
            Thread.Sleep(500);
            this.CallTraNhiemVu();
            this.Myself.IsHaiDuaCarrying = true;
            break;
          case 1:
            this.CallTraNhiemVu();
            Thread.Sleep(500);
            this.CallTraNhiemVu();
            this.Myself.IsHaiDuaCarrying = false;
            break;
        }
      }
      cmd.Status = AllEnums.ScriptStatuses.FINISHED;
    }
    catch (Exception ex)
    {
      int num = (int) MessageBox.Show("Lỗi function NhanQuestDuaHau", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Hand);
      if (cmd == null)
        return;
      cmd.Status = AllEnums.ScriptStatuses.FINISHED;
    }
  }

  private void CallDuaHauConfirm(int param1, int npcid)
  {
    MyDLL.PostMessage(this.Target.MainWindowHandle, frmLogin.GAuto.Settings.WM_DUAHAUCONFIRM, (IntPtr) param1, (IntPtr) npcid);
  }

  public void SendPacket(GScriptCommand cmd)
  {
    if (cmd == null || !(cmd.Command.ToLower() == "sendcustompacket") || cmd.Count <= 0)
      return;
    string.IsNullOrEmpty(cmd.Params[0].ToString());
  }

  public bool IsThanhBangID(int mapID)
  {
    if (mapID >= 205 && mapID <= 312)
      return true;
    return mapID >= 597 && mapID <= 704;
  }

  public void GetThanhBangID(GScriptCommand cmd)
  {
    try
    {
      if (cmd != null)
        cmd.Status = AllEnums.ScriptStatuses.FINISHED;
      if (!this.IsThanhBangID(this.Myself.MapID))
        return;
      this.Settings.txtDHBangID = this.Myself.MapID;
    }
    catch (Exception ex)
    {
      int num = (int) MessageBox.Show("Lỗi function GetThanhBangID", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Hand);
      if (cmd == null)
        return;
      cmd.Status = AllEnums.ScriptStatuses.FINISHED;
    }
  }

  public void GoToBang(GScriptCommand cmd)
  {
    try
    {
      if (cmd == null)
        return;
      int num1 = 238;
      int num2 = 235;
      if (this.Myself.MapID == 0)
      {
        double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) num1, (double) num2);
        if (distance > 3.0)
        {
          this.Myself.TargetX = (float) num1;
          this.Myself.TargetY = (float) num2;
          this.CallMoveFlashPos(num1, num2);
          this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
        }
        else
        {
          if (distance > 3.0)
            return;
          this.CallTalkNPC(0, 0, 177);
          this.CallTalkNPC(30, 6, 177);
          Thread.Sleep(3000);
          cmd.Status = AllEnums.ScriptStatuses.FINISHED;
        }
      }
      else
      {
        if (this.IsThanhBangID(this.Myself.MapID))
          this.Settings.txtDHBangID = this.Myself.MapID;
        if (this.Myself.MapID > 0 && this.Myself.MapID != this.Settings.txtDHBangID)
        {
          this.Myself.TargetX = (float) num1;
          this.Myself.TargetY = (float) num2;
          this.Myself.TargetMapID = 0;
          this.Settings.SavedPosX = (float) num1;
          this.Settings.SavedPosY = (float) num2;
          this.Settings.SavedMapID = 0;
          this.Myself.LongMoveMapID = 0;
          this.Myself.LongMoveX = num1;
          this.Myself.LongMoveY = num2;
          this.Myself.MoveLongTrigger = true;
        }
        else
        {
          if (this.Myself.MapID != this.Settings.txtDHBangID)
            return;
          cmd.Status = AllEnums.ScriptStatuses.FINISHED;
        }
      }
    }
    catch (Exception ex)
    {
      int num = (int) MessageBox.Show("Lỗi function GoToBang", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Hand);
      if (cmd == null)
        return;
      cmd.Status = AllEnums.ScriptStatuses.FINISHED;
    }
  }

  public void MoveAttackScript(GScriptCommand cmd)
  {
    try
    {
      if (cmd == null)
        return;
      string lower = cmd.Command.ToLower();
      int result1 = 0;
      int result2 = 0;
      bool result3 = false;
      int result4 = 2000;
      if (lower == "moveattack")
      {
        if (cmd.Count < 4)
          return;
        int.TryParse(cmd.Params[0].ToString(), out result1);
        int.TryParse(cmd.Params[1].ToString(), out result2);
        bool.TryParse(cmd.Params[2].ToString(), out result3);
        int.TryParse(cmd.Params[3].ToString(), out result4);
        if (result1 == 0 || result2 == 0)
          return;
        double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) result1, (double) result2);
        if (distance > 2.0 && cmd.MinorStatus != AllEnums.ScriptStatuses.FINISHED)
        {
          this.Myself.TargetX = (float) result1;
          this.Myself.TargetY = (float) result2;
          this.CallMoveFlashPos(result1, result2);
          this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
          this.Myself.LastNullTargetStamp = 0L;
        }
        else
        {
          if (distance > 2.0 && cmd.MinorStatus != AllEnums.ScriptStatuses.FINISHED)
            return;
          if (this.Myself.IsPartyFollowed == (byte) 1)
            this.CallRemovePartyFollow();
          this.AttackQuai(result4);
        }
      }
      else
        cmd.Status = AllEnums.ScriptStatuses.FINISHED;
    }
    catch (Exception ex)
    {
      int num = (int) MessageBox.Show("Lỗi function MoveAttackScript", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Hand);
      if (cmd == null)
        return;
      cmd.Status = AllEnums.ScriptStatuses.FINISHED;
    }
  }

  public void MoveTalkNPCByNameScript(GScriptCommand cmd)
  {
    try
    {
      if (cmd == null)
        return;
      string lower = cmd.Command.ToLower();
      int result1 = 0;
      int result2 = 0;
      int result3 = 0;
      int result4 = 0;
      int result5 = -1;
      int result6 = -1;
      bool flag1 = false;
      if (!(lower == "movetalknpcname") || cmd.Count < 7)
        return;
      int.TryParse(cmd.Params[0].ToString(), out result1);
      int.TryParse(cmd.Params[1].ToString(), out result2);
      string strB = cmd.Params[2].ToString();
      int.TryParse(cmd.Params[3].ToString(), out result5);
      int.TryParse(cmd.Params[4].ToString(), out result3);
      int.TryParse(cmd.Params[5].ToString(), out result4);
      int.TryParse(cmd.Params[6].ToString(), out result6);
      if (result1 == 0 || result2 == 0)
        return;
      bool flag2 = false;
      QuaiIndividual quaiIndividual = (QuaiIndividual) null;
      if (result5 == -1 && strB != "")
      {
        double num = 9999.0;
        for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
        {
          QuaiIndividual quai = this.MyQuai.AllQuai[index];
          double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) quai.PosX, (double) quai.PosY);
          int id = quai.ID;
          if (distance <= 25.0 && this.IsNPC(quai))
          {
            if (result5 != -1 && quai.ID == result5)
            {
              quaiIndividual = quai;
              break;
            }
            if (string.Compare(quai.Name, strB, true) == 0 && (result6 == -1 || result6 == quai.Level) && distance < num)
            {
              num = distance;
              quaiIndividual = quai;
            }
          }
        }
        if (quaiIndividual != null)
          result5 = quaiIndividual.ID;
      }
      if (quaiIndividual != null)
      {
        flag2 = true;
        GScriptCommand cmd1 = new GScriptCommand();
        GScriptEngine.ScriptMe(string.Format("movetalknpc,{0},{1},{2},{3},{4},true", (object) quaiIndividual.PosX.ToString("0"), (object) quaiIndividual.PosY.ToString("0"), (object) result3.ToString(), (object) result4.ToString(), (object) quaiIndividual.ID.ToString(), (object) flag1.ToString()), cmd1);
        this.ScriptEngine.SingleCommand = cmd1;
      }
      double distance1 = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) result1, (double) result2);
      if (flag2 || distance1 <= 3.0)
        return;
      this.Myself.TargetX = (float) result1;
      this.Myself.TargetY = (float) result2;
      this.CallMoveFlashPos(result1, result2);
      this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
    }
    catch (Exception ex)
    {
      int num = (int) MessageBox.Show("Lỗi function MoveTalkNPCByNameScript", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Hand);
      if (cmd == null)
        return;
      cmd.Status = AllEnums.ScriptStatuses.FINISHED;
    }
  }

  public void MoveTalkNPCScript(GScriptCommand cmd)
  {
    try
    {
      if (cmd == null)
        return;
      string lower = cmd.Command.ToLower();
      int result1 = 0;
      int result2 = 0;
      int result3 = 0;
      int result4 = 0;
      int result5 = -1;
      bool result6 = false;
      if (!(lower == "movetalknpc") || cmd.Count < 6)
        return;
      int.TryParse(cmd.Params[0].ToString(), out result1);
      int.TryParse(cmd.Params[1].ToString(), out result2);
      int.TryParse(cmd.Params[2].ToString(), out result3);
      int.TryParse(cmd.Params[3].ToString(), out result4);
      int.TryParse(cmd.Params[4].ToString(), out result5);
      bool.TryParse(cmd.Params[5].ToString(), out result6);
      if (result1 == 0 || result2 == 0)
        return;
      double distance1 = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) result1, (double) result2);
      if (distance1 > 4.0)
      {
        this.Myself.TargetX = (float) result1;
        this.Myself.TargetY = (float) result2;
        this.CallMoveFlashPos(result1, result2);
        this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
      }
      if (distance1 > 10.0)
        return;
      double num = 9999.0;
      if (result5 == -1)
      {
        QuaiIndividual quaiIndividual = (QuaiIndividual) null;
        for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
        {
          QuaiIndividual quai = this.MyQuai.AllQuai[index];
          double distance2 = GA.CalculateDistance((double) result1, (double) result2, (double) quai.PosX, (double) quai.PosY);
          if (distance2 <= 10.0 && distance2 < num)
          {
            num = distance2;
            if (this.IsNPC(quai))
              quaiIndividual = quai;
          }
        }
        if (quaiIndividual != null)
          result5 = quaiIndividual.ID;
      }
      if (result5 != -1 && num <= 4.0)
      {
        if (result6)
        {
          this.CallTalkNPC(0, 0, result5);
          Thread.Sleep(500);
        }
        this.CallTalkNPC(result3, result4, result5);
        if (result3 == 808150)
          this.Myself.DuaNPCID = result5;
        Thread.Sleep(1000);
        cmd.Status = AllEnums.ScriptStatuses.FINISHED;
      }
      else
      {
        if (result5 != -1)
          return;
        cmd.Status = AllEnums.ScriptStatuses.FINISHED;
      }
    }
    catch (Exception ex)
    {
      int num = (int) MessageBox.Show("Lỗi function MoveTalkNPCScript", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Hand);
      if (cmd == null)
        return;
      cmd.Status = AllEnums.ScriptStatuses.FINISHED;
    }
  }

  public void MoveHaiDuocScript(GScriptCommand cmd)
  {
    int num1 = 0;
    if (cmd == null)
      return;
    string lower = cmd.Command.ToLower();
    int result1 = 0;
    int result2 = 0;
    if (!(lower == "haiduoc") && !(lower == "khaikhoang") || cmd.Count < 2)
      return;
    int.TryParse(cmd.Params[0].ToString(), out result1);
    int.TryParse(cmd.Params[1].ToString(), out result2);
    long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
    NewBoc newBoc = (NewBoc) null;
    double num2 = 9999.0;
    for (int index1 = this.MyBoc.AllBocs.Count - 1; index1 >= 0; --index1)
    {
      bool flag1 = false;
      NewBoc allBoc = this.MyBoc.AllBocs[index1];
      for (int index2 = 0; index2 < this.MyBoc.PickedBocList.Count; ++index2)
      {
        NewBoc pickedBoc = this.MyBoc.PickedBocList[index2];
        if (pickedBoc.BocID != 0 && pickedBoc.BocID == allBoc.BocID && (double) Math.Abs(pickedBoc.PosX - allBoc.PosX) <= 0.5 && (double) Math.Abs(pickedBoc.PosY - allBoc.PosY) <= 0.5)
        {
          flag1 = true;
          break;
        }
      }
      if (!flag1 && allBoc.BocID != 0 && (double) allBoc.PosX != 0.0 && (double) allBoc.PosY != 0.0)
      {
        bool flag2 = false;
        if (allBoc.BocType >= 1 && allBoc.BocType <= 10)
        {
          if (this.Settings.cboxKhaiKhoang)
            flag2 = true;
        }
        else if (allBoc.BocType >= 101 && allBoc.BocType <= 126 && this.Settings.cboxHaiDuoc)
          flag2 = true;
        if (flag2)
        {
          double distance = GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) allBoc.PosX, (double) allBoc.PosY);
          bool flag3 = this.CheckIgnoredArea(allBoc.PosX, allBoc.PosY);
          if (this.Settings.cboxKhoangDuoc || this.Settings.cboxATAB)
            flag3 = true;
          if (distance < num2 && !flag3)
          {
            num2 = distance;
            newBoc = allBoc;
          }
        }
      }
    }
    if (newBoc != null)
    {
      if (GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, (double) newBoc.PosX, (double) newBoc.PosY) > 7.0)
      {
        if (this.IsMoveStuck())
          return;
        this.CallMoveFlashPos((int) newBoc.PosX, (int) newBoc.PosY);
      }
      else
      {
        this.Myself.LastPostStamp.Reset();
        this.Myself.LastPostStamp.Start();
        if (this.Myself.HorseType != -1 && !this.Settings.cboxKhoangDuoc)
          this.CallMounting();
        if (this.Myself.ActionStatus != (byte) 5)
        {
          this.CallThocBocFunc(newBoc.BocID);
          Thread.Sleep(1000);
        }
        if (this.Myself.EventString == "KDCD")
        {
          if (newBoc.BocID > 0)
          {
            this.MyBoc.PickedBocList[this.MyBoc.CurrentPickedIndex].BocID = newBoc.BocID;
            this.MyBoc.PickedBocList[this.MyBoc.CurrentPickedIndex].PosX = newBoc.PosX;
            this.MyBoc.PickedBocList[this.MyBoc.CurrentPickedIndex].PosY = newBoc.PosY;
            ++this.MyBoc.CurrentPickedIndex;
            if (this.MyBoc.CurrentPickedIndex >= this.MyBoc.PickedBocList.Count)
              this.MyBoc.CurrentPickedIndex = 0;
          }
          this.ResetBocPre(newBoc.BocID);
          this.Myself.Status = AllEnums.CharStatuses.IDLE;
          this.ResetEventString();
        }
        while (this.Myself.ActionStatus == (byte) 8)
        {
          Thread.Sleep(300);
          if (this.Myself.BocShow == 1)
          {
            this.CallPickAllItems();
            Thread.Sleep(300);
            break;
          }
        }
        if (num1 > 0 && frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds > (long) num1)
          return;
        this.Myself.Status = AllEnums.CharStatuses.GOGOGO;
      }
    }
    else
    {
      if (newBoc != null)
        return;
      this.Myself.TargetX = (float) result1;
      this.Myself.TargetY = (float) result2;
      this.CallInMapMove(result1, result2, true);
    }
  }

  public bool CheckIgnoredArea(float X, float Y)
  {
    foreach (IgnoredAreaDBElement ignoredAreaDbElement in frmLogin.GAuto.IgnoredAreaDB)
    {
      if (ignoredAreaDbElement.MapID == this.Myself.MapID && (double) X > (double) ignoredAreaDbElement.X1 && (double) X < (double) ignoredAreaDbElement.X2 && (double) Y > (double) ignoredAreaDbElement.Y1 && (double) Y < (double) ignoredAreaDbElement.Y2)
        return true;
    }
    return false;
  }

  private void NhatBoc(int LoaiBoc = 5000)
  {
    if (this.Settings.cboxTuNhatVatPham || LoaiBoc != 5000)
    {
      if (this.Myself.IDLEStamp - frmLogin.GlobalTimer.ElapsedMilliseconds > 0L)
        return;
      int num1 = 0;
      float num2 = 0.0f;
      float num3 = 0.0f;
      bool flag1 = false;
      bool flag2 = this.Myself.BocShow != 0;
      if (this.MyBoc == null)
      {
        if (this.Myself.Status == AllEnums.CharStatuses.NHATBOC)
          this.Myself.Status = AllEnums.CharStatuses.IDLE;
        this.Myself.nhatbocCounter = 0;
        this.Myself.thocbocCounter = 0;
      }
      else
      {
        long elapsedMilliseconds1 = frmLogin.GlobalTimer.ElapsedMilliseconds;
        if (this.MyBoc.AllBocs.Count <= 0)
        {
          if (this.Myself.Status == AllEnums.CharStatuses.NHATBOC)
            this.Myself.Status = AllEnums.CharStatuses.IDLE;
          this.Myself.nhatbocCounter = 0;
          this.Myself.thocbocCounter = 0;
        }
        else
        {
          if (this.Myself.ActionStatus != (byte) 5)
          {
            NewBoc newBoc1 = (NewBoc) null;
            NewBoc newBoc2 = (NewBoc) null;
            double num4 = 50.0;
            double num5 = 90.0;
            long num6 = 0;
            bool flag3 = false;
            try
            {
              for (int index1 = this.MyBoc.AllBocs.Count - 1; index1 >= 0; --index1)
              {
                NewBoc allBoc = this.MyBoc.AllBocs[index1];
                if ((double) allBoc.PosX != 0.0 && (double) allBoc.PosY != 0.0)
                {
                  num5 = GA.CalculateDistance((double) allBoc.PosX, (double) allBoc.PosY, (double) this.Myself.PosX, (double) this.Myself.PosY);
                  if (num5 > (double) this.Settings.numBanKinhNhat)
                    continue;
                }
                if (LoaiBoc != 808 && LoaiBoc != 807 || this.MyBoc.AllBocs.Count < 3 || frmLogin.GAuto.Settings.preBocID != allBoc.BocID || this.Myself.MyPreBocID == allBoc.BocID)
                {
                  for (int index2 = 0; index2 < this.MyBoc.PickedBocList.Count; ++index2)
                  {
                    NewBoc pickedBoc = this.MyBoc.PickedBocList[index2];
                    if (pickedBoc.BocID != 0 && pickedBoc.BocID == allBoc.BocID && (double) Math.Abs(pickedBoc.PosX - allBoc.PosX) <= 0.5 && (double) Math.Abs(pickedBoc.PosY - allBoc.PosY) <= 0.5)
                    {
                      flag3 = true;
                      break;
                    }
                  }
                  if (flag3)
                    flag3 = false;
                  else if (!allBoc.Picked && (!allBoc.IsQuaXa || allBoc.IsQuaXa && frmLogin.GlobalTimer.ElapsedMilliseconds - allBoc.QuaXaStamp >= 5000L) && allBoc.BocType == LoaiBoc)
                  {
                    long num7 = frmLogin.GlobalTimer.ElapsedMilliseconds - allBoc.LastTimeSeen;
                    if (LoaiBoc == 5000 && num7 > num6 && num7 > 30000L)
                    {
                      num6 = num7;
                      newBoc2 = allBoc;
                    }
                    if ((double) allBoc.PosX != 0.0 && (double) allBoc.PosY != 0.0)
                      num5 = GA.CalculateDistance((double) allBoc.PosX, (double) allBoc.PosY, (double) this.Myself.PosX, (double) this.Myself.PosY);
                    if (num5 < num4)
                    {
                      newBoc1 = allBoc;
                      num4 = num5;
                    }
                    if (Math.Abs(num5 - num4) <= 1.5 && allBoc.LastTimeSeen < newBoc1.LastTimeSeen)
                    {
                      newBoc1 = allBoc;
                      num4 = num5;
                    }
                  }
                }
              }
            }
            catch (Exception ex)
            {
              if (GA.isVipMember())
                GA.WriteUserLog(frmMain.langErrorLookingBag, this);
            }
            if (num4 > 2.0 && newBoc2 != null)
              newBoc1 = newBoc2;
            if (newBoc1 != null)
            {
              if (LoaiBoc == 808 || LoaiBoc == 807)
              {
                frmLogin.GAuto.Settings.preBocID = newBoc1.BocID;
                this.Myself.MyPreBocID = newBoc1.BocID;
              }
              double num8 = 10.0;
              int num9 = 0;
              int num10 = 25;
              if (this.Myself.IsMinimized)
              {
                num8 = 3.0;
                num9 = 2500;
                num10 = 70;
              }
              this.Myself.Status = AllEnums.CharStatuses.NHATBOC;
              long elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
              bool flag4 = false;
              double distance1 = GA.CalculateDistance((double) newBoc1.PosX, (double) newBoc1.PosY, (double) this.Myself.PosX, (double) this.Myself.PosY);
              if (LoaiBoc == 5000)
              {
                int num11;
                if (distance1 > num8)
                {
                  int num12 = 700 * (int) distance1 + num9;
                  while (distance1 > 3.0)
                  {
                    if (this.Myself.ActionStatus == (byte) 7 || this.Myself.ActionStatus == (byte) 5)
                      elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                    distance1 = GA.CalculateDistance((double) newBoc1.PosX, (double) newBoc1.PosY, (double) this.Myself.PosX, (double) this.Myself.PosY);
                    if (GA.isVipMember() && this.Settings.cboxTNRunOnly)
                      GA.WriteUserLog("Move To: {0} - x:{1} - y:{2} - d:{3}", this, (object) newBoc1.BocID, (object) (int) newBoc1.PosX, (object) (int) newBoc1.PosY, (object) (int) distance1);
                    if (distance1 <= (double) this.Settings.numBanKinhNhat)
                    {
                      this.CallMoveFlashPos((int) newBoc1.PosX, (int) newBoc1.PosY);
                      if (this.Myself.ActionStatus != (byte) 2)
                        this.CallThocBocFunc(newBoc1.BocID);
                      Thread.Sleep(200);
                      if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 >= (long) num12)
                        break;
                    }
                    else
                      break;
                  }
                  num11 = 2500 + num9;
                  elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                }
                else
                  num11 = distance1 > 3.0 ? (distance1 > 6.0 ? 700 * (int) distance1 + num9 : 5000 + num9) : 2500 + num9;
                while (!flag4 && distance1 <= num8)
                {
                  this.Myself.NhatBocStatusStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                  distance1 = GA.CalculateDistance((double) newBoc1.PosX, (double) newBoc1.PosY, (double) this.Myself.PosX, (double) this.Myself.PosY);
                  if (distance1 <= (double) this.Settings.numBanKinhNhat)
                  {
                    if (this.Myself.ActionStatus != (byte) 5 && this.Myself.thocbocCounter <= 1)
                    {
                      if (this.Myself.BocShow == 0)
                      {
                        if (distance1 <= 2.0)
                        {
                          if (this.thocbocFlag == 0)
                          {
                            this.CallThocBocPacketNow(newBoc1.BocID);
                            this.thocbocFlag = 1;
                            if (GA.isVipMember() && this.Settings.cboxTNRunOnly)
                              GA.WriteUserLog("Bọc 2 packet: {0} - x:{1} - y:{2}", this, (object) newBoc1.BocID, (object) (int) newBoc1.PosX, (object) (int) newBoc1.PosY);
                          }
                          else
                          {
                            this.CallThocBocFunc(newBoc1.BocID);
                            this.thocbocFlag = 0;
                            if (GA.isVipMember() && this.Settings.cboxTNRunOnly)
                              GA.WriteUserLog("Bọc 3 packet: {0} - x:{1} - y:{2}", this, (object) newBoc1.BocID, (object) (int) newBoc1.PosX, (object) (int) newBoc1.PosY);
                          }
                        }
                        else
                        {
                          if (this.Myself.ActionStatus == (byte) 7 || this.Myself.ActionStatus == (byte) 5)
                            elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                          if (GA.isVipMember() && this.Settings.cboxTNRunOnly)
                            GA.WriteUserLog("Bọc 0 func: {0} - x:{1} - y:{2} - d:{3}", this, (object) newBoc1.BocID, (object) (int) newBoc1.PosX, (object) (int) newBoc1.PosY, (object) (int) distance1);
                          this.CallThocBocFunc(newBoc1.BocID);
                        }
                        this.Myself.thocbocCounter = 1;
                        this.Myself.nhatbocCounter = 0;
                        flag2 = false;
                      }
                      else
                      {
                        if (this.Myself.BocShowID != newBoc1.BocID)
                        {
                          if (distance1 <= 2.0)
                          {
                            if (this.thocbocFlag == 0)
                            {
                              this.CallThocBocPacketNow(newBoc1.BocID);
                              this.thocbocFlag = 1;
                            }
                            else
                            {
                              this.CallThocBocFunc(newBoc1.BocID);
                              this.thocbocFlag = 0;
                            }
                            if (GA.isVipMember() && this.Settings.cboxTNRunOnly)
                              GA.WriteUserLog("Bọc 1 packet: {0} - x:{1} - y:{2}", this, (object) newBoc1.BocID, (object) (int) newBoc1.PosX, (object) (int) newBoc1.PosY);
                          }
                          else
                          {
                            if (this.Myself.ActionStatus == (byte) 7 || this.Myself.ActionStatus == (byte) 5)
                              elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                            if (GA.isVipMember() && this.Settings.cboxTNRunOnly)
                              GA.WriteUserLog("Bọc 1 func: {0} - x:{1} - y:{2}", this, (object) newBoc1.BocID, (object) (int) newBoc1.PosX, (object) (int) newBoc1.PosY);
                            this.CallThocBocFunc(newBoc1.BocID);
                          }
                          this.Myself.thocbocCounter = 1;
                          this.Myself.nhatbocCounter = 0;
                        }
                        flag2 = true;
                      }
                    }
                    if (this.Myself.ActionStatus == (byte) 2 && GA.isVipMember() && this.Settings.cboxTNRunOnly)
                      GA.WriteUserLog("Going To: {0} - x:{1} - y:{2} - d:{3}", this, (object) newBoc1.BocID, (object) (int) newBoc1.PosX, (object) (int) newBoc1.PosY, (object) (int) distance1);
                    if (this.Myself.ActionStatus == (byte) 2 && this.Myself.thocbocCounter == 1)
                      this.Myself.thocbocCounter = 2;
                    if (this.Myself.thocbocCounter >= 2 && distance1 < 2.5)
                      this.Myself.thocbocCounter = 1;
                    if (!newBoc1.IsQuaXa || newBoc1.QuaXaStamp == 0L)
                    {
                      Thread.Sleep(200);
                      bool flag5 = true;
                      if (this.Settings.AIMode == AllEnums.AIModes.DANHQUANHDIEM && this.Settings.cboxBanKinh && GA.CalculateDistance((double) this.Myself.PosX, (double) this.Myself.PosY, this.Settings.CenterX, this.Settings.CenterY) > this.Settings.MoveRange + 3.0)
                        flag5 = false;
                      double num13 = GA.IsInPhuBan(this.Myself.MapID, this) ? 2.5 : 3.0;
                      if (distance1 <= num13 && !this.Myself.IsXayDung && !this.Myself.IsTrungAc && !this.Myself.IsLuyenKim && flag5)
                      {
                        if (GA.isShitMember())
                          Thread.Sleep(new Random().Next(1000, 2000));
                        if (this.Myself.ThocBocDanhQuaiStamp == 0L)
                          this.Myself.ThocBocDanhQuaiStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                        long num14 = frmLogin.GlobalTimer.ElapsedMilliseconds - this.Myself.ThocBocDanhQuaiStamp;
                        if (this.IsAIEnabled && this.Settings.cboxDanhQuai && num14 <= 7000L && (this.Settings.AIMode == AllEnums.AIModes.DANHQUANHDIEM || this.Settings.AIMode == AllEnums.AIModes.DANHTUDO || this.Settings.AIMode == AllEnums.AIModes.NHIEMVU))
                        {
                          QuaiIndividual quaiIndividual1 = (QuaiIndividual) null;
                          if (this.MyQuai.TargetID != -1 && (double) this.MyQuai.TargetHPPercent > 0.0)
                          {
                            QuaiIndividual quaiIndividual2 = this.TimQuaiTheoID(this.MyQuai.TargetID);
                            if (quaiIndividual2 != null && (double) quaiIndividual2.HPPercent > 0.0)
                            {
                              double distance2 = GA.CalculateDistance((double) quaiIndividual2.PosX, (double) quaiIndividual2.PosY, (double) this.Myself.PosX, (double) this.Myself.PosY);
                              if (distance2 < 12.0 && this.Myself.CharType == AllEnums.CharTypes.NUKER || distance2 < 2.0 && this.Myself.CharType == AllEnums.CharTypes.TANKER)
                                quaiIndividual1 = quaiIndividual2;
                            }
                          }
                          if (this.MyQuai.AllQuai.Count > 0 && quaiIndividual1 == null)
                          {
                            double num15 = 99.0;
                            try
                            {
                              for (int index = this.MyQuai.AllQuai.Count - 1; index >= 0; --index)
                              {
                                QuaiIndividual quai = this.MyQuai.AllQuai[index];
                                double distance3 = GA.CalculateDistance((double) quai.PosX, (double) quai.PosY, (double) this.Myself.PosX, (double) this.Myself.PosY);
                                if ((distance3 < 12.0 && this.Myself.CharType == AllEnums.CharTypes.NUKER || distance3 < 2.0 && this.Myself.CharType == AllEnums.CharTypes.TANKER) && distance3 < num15 && (double) quai.HPPercent > 0.0 && this.CanAttack(quai))
                                {
                                  quaiIndividual1 = quai;
                                  num15 = distance3;
                                  if (this.Myself.CharType == AllEnums.CharTypes.TANKER)
                                    break;
                                }
                              }
                            }
                            catch (Exception ex)
                            {
                            }
                          }
                          if (quaiIndividual1 != null && quaiIndividual1.ID >= 0 && (!this.Settings.cboxDanhTheoKey || this.MyParty.PartyNumbers == 0 || this.IsPartyKey()) && !this.Settings.cboxDanhTheoAi)
                          {
                            if (this.Settings.cboxOnlyPet && this.HasActivePet())
                              this.CallAttackTargetPacket(this.Myself.ID, -1, quaiIndividual1.ID, 0, 0);
                            else
                              this.CallAttackTargetPacket(this.Myself.ID, this.MySkills.AllSkills[0].ID, quaiIndividual1.ID, 0, 0);
                            if (this.MyQuai.TargetID != quaiIndividual1.ID)
                              this.CallSelectTarget(quaiIndividual1.ID);
                          }
                        }
                      }
                      if ((this.Myself.BocShow == 1 || this.Myself.BocShowID == newBoc1.BocID) && (!flag2 || this.Myself.BocShowID == newBoc1.BocID))
                        flag4 = true;
                      if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 >= (long) num11 && elapsedMilliseconds2 != 0L)
                      {
                        long elapsedMilliseconds3 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                        int num16 = distance1 > 3.0 ? (distance1 > 6.0 ? 700 * (int) distance1 + num9 * 3 : 5000 + num9 * 3) : 2500 + num9 * 3;
                        int num17 = 0;
                        while (true)
                        {
                          if (this.Myself.ActionStatus == (byte) 7 || this.Myself.ActionStatus == (byte) 5)
                          {
                            elapsedMilliseconds2 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                            elapsedMilliseconds3 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                          }
                          this.Myself.thocbocCounter = 0;
                          distance1 = GA.CalculateDistance((double) newBoc1.PosX, (double) newBoc1.PosY, (double) this.Myself.PosX, (double) this.Myself.PosY);
                          if (distance1 > 2.0)
                          {
                            this.CallMoveFlashPos((int) newBoc1.PosX, (int) newBoc1.PosY);
                          }
                          else
                          {
                            this.CallThocBocPacketNow(newBoc1.BocID);
                            ++num17;
                            if (this.Myself.BocShow != 1 && this.Myself.BocShowID != newBoc1.BocID || flag2 && this.Myself.BocShowID != newBoc1.BocID)
                            {
                              if (GA.isVipMember() && this.Settings.cboxTNRunOnly)
                                GA.WriteUserLog("Count: {0}-{1}", this, (object) newBoc1.BocID, (object) num17);
                              this.CallMoveFlashPos((int) newBoc1.PosX, (int) newBoc1.PosY);
                              this.CallThocBocFunc(newBoc1.BocID);
                              if (num17 >= num10)
                                goto label_135;
                            }
                            else
                              break;
                          }
                          if (this.nowStamp() - elapsedMilliseconds3 < (long) num16)
                            Thread.Sleep(200);
                          else
                            goto label_140;
                        }
                        flag4 = true;
                        goto label_143;
label_135:
                        if (GA.isVipMember())
                          GA.WriteUserLog("Xóa bọc khó timeout: {0}-{1}", this, (object) newBoc1.BocID, (object) num16);
                        this.ResetBocPre(newBoc1.BocID);
                        if (this.Myself.Status == AllEnums.CharStatuses.NHATBOC)
                          this.Myself.Status = AllEnums.CharStatuses.IDLE;
                        flag4 = true;
                        goto label_143;
label_140:
                        if (GA.isVipMember())
                          GA.WriteUserLog("Miss bọc khó timeout: {0}-{1}", this, (object) newBoc1.BocID, (object) num16);
                        this.ResetBoc(newBoc1.BocID);
                        flag4 = true;
                      }
label_143:
                      if (flag4)
                      {
                        this.tempBocShowID = this.Myself.BocShowID;
                        num1 = newBoc1.BocID;
                        num2 = newBoc1.PosX;
                        num3 = newBoc1.PosY;
                        flag1 = true;
                        this.Myself.ThocBocDanhQuaiStamp = 0L;
                        this.thocbocFlag = 0;
                        break;
                      }
                    }
                    else
                      break;
                  }
                  else
                    break;
                }
              }
              else
              {
                long num18 = 0;
                int num19 = 12000;
                this.CallThocBocFunc(newBoc1.BocID);
                double distance4 = GA.CalculateDistance((double) newBoc1.PosX, (double) newBoc1.PosY, (double) this.Myself.PosX, (double) this.Myself.PosY);
                while (!flag4)
                {
                  Thread.Sleep(400);
                  if ((int) newBoc1.PosX == 50 || (int) newBoc1.PosX == 51)
                    this.CallMoveTo((int) newBoc1.PosX - 1, (int) newBoc1.PosY);
                  if (frmLogin.GlobalTimer.ElapsedMilliseconds - elapsedMilliseconds2 >= (long) num19 && elapsedMilliseconds2 > 0L)
                  {
                    flag4 = true;
                    break;
                  }
                  if (this.Myself.ActionStatus == (byte) 0 && (num18 == 0L || frmLogin.GlobalTimer.ElapsedMilliseconds - num18 >= 2000L))
                  {
                    if (this.Myself.BocShow == 0)
                    {
                      if (distance4 <= 1.0)
                      {
                        if (this.thocbocFlag == 0)
                        {
                          this.CallThocBocPacketNow(newBoc1.BocID);
                          this.thocbocFlag = 1;
                        }
                        else
                        {
                          this.CallThocBocFunc(newBoc1.BocID);
                          this.thocbocFlag = 0;
                        }
                      }
                      else
                        this.CallThocBocFunc(newBoc1.BocID);
                      this.Myself.thocbocCounter = 1;
                      this.Myself.nhatbocCounter = 0;
                      flag2 = false;
                    }
                    else
                    {
                      if (this.Myself.BocShowID != newBoc1.BocID)
                      {
                        if (distance4 <= 2.0)
                        {
                          if (this.thocbocFlag == 0)
                          {
                            this.CallThocBocPacketNow(newBoc1.BocID);
                            this.thocbocFlag = 1;
                          }
                          else
                          {
                            this.CallThocBocFunc(newBoc1.BocID);
                            this.thocbocFlag = 0;
                          }
                        }
                        else
                          this.CallThocBocFunc(newBoc1.BocID);
                        this.Myself.thocbocCounter = 1;
                        this.Myself.nhatbocCounter = 0;
                      }
                      flag2 = true;
                    }
                  }
                  if ((this.Myself.BocShow == 1 || this.Myself.BocShowID == newBoc1.BocID) && (!flag2 || this.Myself.BocShowID == newBoc1.BocID))
                  {
                    flag4 = true;
                    break;
                  }
                  if (this.Myself.ActionStatus == (byte) 8 || this.Myself.ActionStatus == (byte) 0)
                  {
                    if (this.MyBoc.AllBocs.Count > 0)
                    {
                      try
                      {
                        bool flag6 = false;
                        for (int index = this.MyBoc.AllBocs.Count - 1; index >= 0; --index)
                        {
                          NewBoc allBoc = this.MyBoc.AllBocs[index];
                          if (newBoc1.BocID == allBoc.BocID)
                          {
                            flag6 = true;
                            break;
                          }
                        }
                        if (!flag6)
                        {
                          Random random = new Random();
                          this.CallMoveTo((int) this.Myself.PosX + random.Next(-1, 1), (int) this.Myself.PosY + random.Next(-1, 1));
                          flag4 = true;
                          break;
                        }
                      }
                      catch (Exception ex)
                      {
                        GA.WriteUserLog("Lỗi tìm hộp quà, vui lòng báo Admin", this);
                      }
                    }
                    else
                    {
                      flag4 = true;
                      break;
                    }
                  }
                  if (this.Myself.ActionStatus == (byte) 8)
                    num18 = frmLogin.GlobalTimer.ElapsedMilliseconds;
                }
                if (flag4)
                {
                  if (GA.isVipMember())
                    GA.WriteUserLog("Bọc: " + (object) newBoc1.BocID, this);
                  this.tempBocShowID = this.Myself.BocShowID;
                  num1 = newBoc1.BocID;
                  num2 = newBoc1.PosX;
                  num3 = newBoc1.PosY;
                  flag1 = true;
                  this.thocbocFlag = 0;
                }
              }
            }
            else
            {
              if (this.Myself.Status == AllEnums.CharStatuses.NHATBOC)
                this.Myself.Status = AllEnums.CharStatuses.IDLE;
              this.Myself.nhatbocCounter = 0;
              this.Myself.thocbocCounter = 0;
            }
          }
          if (this.Myself.BocShow == 1 && flag1)
          {
            this.Myself.TrungAcFoundBoc = true;
            this.Myself.LuyenKimFoundBoc = true;
            if (GA.isShitMember())
              Thread.Sleep(new Random().Next(1000, 2000));
            if (this.Settings.NhatItemMode == AllEnums.NhatItemModes.NHATHET)
            {
              this.Myself.thocbocCounter = 0;
              for (int index = 0; index <= 20; ++index)
              {
                this.Myself.NhatBocStatusStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                this.CallPickAllItemsList(this.Myself.BocShowID);
                Thread.Sleep(220);
                if (!this.Myself.FlagFullBoc && this.Myself.BocShow != 0)
                {
                  if (index >= 6)
                    this.CallPickAllItems();
                  if (index == 20 && GA.isVipMember())
                    GA.WriteUserLog(frmMain.langErrorSotBoc, this);
                }
                else
                  break;
              }
              this.tempBocShowID = 0;
              if (this.Myself.Status == AllEnums.CharStatuses.NHATBOC)
                this.Myself.Status = AllEnums.CharStatuses.IDLE;
            }
            else if (this.MyBoc.AllItems.Count > 0)
            {
              try
              {
                for (int index3 = this.MyBoc.AllItems.Count - 1; index3 >= 0; --index3)
                {
                  ItemTrongBoc allItem = this.MyBoc.AllItems[index3];
                  string itemName = "";
                  string itemType = "";
                  GA.GetItemNameTypeFromID(allItem.ItemID, out itemName, out itemType);
                  bool flag7 = false;
                  if (this.Settings.NhatItemMode == AllEnums.NhatItemModes.NHATLIST)
                  {
                    if (frmLogin.GAuto.Settings.ListItemNhat.Count > 0)
                    {
                      try
                      {
                        for (int index4 = frmLogin.GAuto.Settings.ListItemNhat.Count - 1; index4 >= 0; --index4)
                        {
                          string s = frmLogin.GAuto.Settings.ListItemNhat[index4];
                          if (!string.IsNullOrEmpty(itemName) && (itemName.Contains(s.ToLower()) || itemType.Contains(s.ToLower()) || allItem.ItemID >= 60000000 && allItem.ItemID <= 60308010))
                          {
                            flag7 = true;
                            break;
                          }
                          int result = 0;
                          int.TryParse(s, out result);
                          if (result > 0 && result == allItem.ItemID)
                          {
                            flag7 = true;
                            break;
                          }
                        }
                      }
                      catch (Exception ex)
                      {
                        if (GA.isVipMember())
                          GA.WriteUserLog("Lỗi đọc item trong list nhặt, báo ngay cho GATeam", this);
                      }
                    }
                  }
                  else
                    goto label_223;
label_217:
                  if (flag7)
                  {
                    this.CallPickItemPacket(this.Myself.BocShowID, allItem.itemGUID1, allItem.itemGUID2);
                    if (this.Myself.BocShowID == 0)
                    {
                      if (GA.isVipMember())
                        GA.WriteUserLog(frmMain.langLootingError + (object) num1, this);
                      this.CallPickAllItems();
                      continue;
                    }
                    continue;
                  }
                  continue;
label_223:
                  if (this.Settings.NhatItemMode == AllEnums.NhatItemModes.NHATLOAITRU)
                  {
                    flag7 = true;
                    try
                    {
                      for (int index5 = this.Settings.ListItemNhatIgnore.Count - 1; index5 >= 0; --index5)
                      {
                        string s = this.Settings.ListItemNhatIgnore[index5];
                        if (!string.IsNullOrEmpty(itemName))
                        {
                          if (itemName.Contains(s.ToLower()) || itemType.Contains(s.ToLower()))
                          {
                            flag7 = false;
                            break;
                          }
                          int result = 0;
                          int.TryParse(s, out result);
                          if (result > 0 && result == allItem.ItemID)
                          {
                            flag7 = false;
                            break;
                          }
                        }
                      }
                      goto label_217;
                    }
                    catch (Exception ex)
                    {
                      if (GA.isVipMember())
                      {
                        GA.WriteUserLog("Lỗi đọc item trong list ko nhặt, báo ngay cho GATeam", this);
                        goto label_217;
                      }
                      goto label_217;
                    }
                  }
                  else
                    goto label_217;
                }
                this.Myself.NhatBocStatusStamp = frmLogin.GlobalTimer.ElapsedMilliseconds;
                if (num1 > 0)
                {
                  this.MyBoc.PickedBocList[this.MyBoc.CurrentPickedIndex].BocID = num1;
                  this.MyBoc.PickedBocList[this.MyBoc.CurrentPickedIndex].PosX = num2;
                  this.MyBoc.PickedBocList[this.MyBoc.CurrentPickedIndex].PosY = num3;
                  ++this.MyBoc.CurrentPickedIndex;
                  if (this.MyBoc.CurrentPickedIndex >= this.MyBoc.PickedBocList.Count)
                    this.MyBoc.CurrentPickedIndex = 0;
                }
                this.ResetBocPre(this.Myself.BocShowID);
                if (this.Myself.Status == AllEnums.CharStatuses.NHATBOC)
                  this.Myself.Status = AllEnums.CharStatuses.IDLE;
              }
              catch (Exception ex)
              {
                GA.WriteUserLog(frmMain.langLootMissing, this);
              }
            }
          }
          if (!this.Myself.FlagFullBoc || num1 <= 0)
            return;
          this.MyBoc.PickedBocList[this.MyBoc.CurrentPickedIndex].BocID = num1;
          this.MyBoc.PickedBocList[this.MyBoc.CurrentPickedIndex].PosX = num2;
          this.MyBoc.PickedBocList[this.MyBoc.CurrentPickedIndex].PosY = num3;
          ++this.MyBoc.CurrentPickedIndex;
          if (this.MyBoc.CurrentPickedIndex >= this.MyBoc.PickedBocList.Count)
            this.MyBoc.CurrentPickedIndex = 0;
          this.Myself.nhatbocCounter = 0;
          if (this.tempBocShowID != 0)
          {
            this.Myself.Status = AllEnums.CharStatuses.IDLE;
            this.ResetBocPre(this.tempBocShowID);
            this.tempBocShowID = 0;
          }
          this.Myself.FullThungRoi = true;
        }
      }
    }
    else
    {
      if (this.Settings.cboxTuNhatVatPham || this.Myself.Status != AllEnums.CharStatuses.NHATBOC)
        return;
      this.Myself.Status = AllEnums.CharStatuses.IDLE;
    }
  }

  private void ResetBocPre(int mytempID)
  {
    this.Myself.Status = AllEnums.CharStatuses.IDLE;
    long elapsedMilliseconds = frmLogin.GlobalTimer.ElapsedMilliseconds;
    if (GA.isVipMember() && this.Settings.cboxTNRunOnly)
      GA.WriteUserLog("ResetBoc: " + (object) mytempID, this);
    this.ResetBoc(mytempID);
  }

  private void ResetBoc(int mytempID)
  {
    this.WriteFuncParams(new MessageFunc()
    {
      Message = 2009,
      int1 = mytempID
    });
  }

  public class DisPlayClass
  {
    public string log;
  }

  public class NPCNhiemVuClass
  {
    public int menuID;
    public int menuIndex;
    public int posX;
    public int posY;
    public string name = "";
  }
}
